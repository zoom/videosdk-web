!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.VB=e():t.VB=e()}(window,(function(){return function(t){var e={};function r(i){if(e[i])return e[i].exports;var n=e[i]={i:i,l:!1,exports:{}};return t[i].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=t,r.c=e,r.d=function(t,e,i){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)r.d(i,n,function(e){return t[e]}.bind(null,n));return i},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=8)}([function(t,e,r){"use strict";r.r(e),r.d(e,"Audio_Dec_WASM_OK",(function(){return i})),r.d(e,"Audio_Dec_Handle_OK",(function(){return n})),r.d(e,"Audio_Dec_WebSocket_OK",(function(){return o})),r.d(e,"Audio_Enc_WASM_OK",(function(){return a})),r.d(e,"Audio_Enc_Handle_OK",(function(){return s})),r.d(e,"Video_Dec_WASM_OK",(function(){return u})),r.d(e,"Video_Dec_Handle_OK",(function(){return c})),r.d(e,"Video_Dec_WebSocket_OK",(function(){return h})),r.d(e,"Video_Enc_WASM_OK",(function(){return f})),r.d(e,"Video_Enc_Handle_OK",(function(){return d})),r.d(e,"Sharing_Dec_WASM_OK",(function(){return E})),r.d(e,"Sharing_Dec_PICTURE",(function(){return _})),r.d(e,"AUDIO_DELAY",(function(){return l})),r.d(e,"Sharing_Dec_WebSocket_OK",(function(){return T})),r.d(e,"Sharing_Handle_OK",(function(){return R})),r.d(e,"Sharing_Data",(function(){return p})),r.d(e,"DECODE_MESSAGE",(function(){return m})),r.d(e,"Video_Capture_Tick",(function(){return x})),r.d(e,"MONITOR_MESSAGE",(function(){return v})),r.d(e,"SHARING_DECODE_MONITOR_MESSAGE",(function(){return g})),r.d(e,"WORKER_MAIN_VIDEO_ENCODE_RINGBUFFER_TICK",(function(){return I})),r.d(e,"WORKER_MAIN_AUDIO_ENCODE_RINGBUFFER_TICK",(function(){return A})),r.d(e,"WORKER_MAIN_VIDEO_DECODE_RINGBUFFER_TICK",(function(){return O})),r.d(e,"Audio_Encode_Preview_OK",(function(){return D})),r.d(e,"Video_Encode_Preview_OK",(function(){return y})),r.d(e,"QOS_MONITORING",(function(){return N})),r.d(e,"QOS_DEFAULT_POLLING_INTERVAL",(function(){return S})),r.d(e,"VIDEO_MONITOR_LOG_SECOENDS",(function(){return C})),r.d(e,"DOWNLOAD_WASM_FROM_MAIN_THREAD",(function(){return L})),r.d(e,"APP_TROUBLESHOOTING_INFO",(function(){return U})),r.d(e,"DELTA_D",(function(){return M})),r.d(e,"DELTA_C",(function(){return b})),r.d(e,"DELTA_S",(function(){return w})),r.d(e,"WCL_TROUBLESHOOTING_INFO",(function(){return P})),r.d(e,"SHARING_DATA_VIDEO_MODE",(function(){return V})),r.d(e,"MOUSE_DATA_VIDEO_MODE",(function(){return B})),r.d(e,"SHARING_DECODE_MESSAGE",(function(){return G})),r.d(e,"VIDEO_ENCODED_DATA",(function(){return F})),r.d(e,"VIDEO_DROP_RATIO_FROM_WCL",(function(){return k})),r.d(e,"VIDEO_DATA_DROP_RATIO",(function(){return W})),r.d(e,"AUDIO_ENCODED_DATA",(function(){return H})),r.d(e,"THREAD_STATE_IDLE",(function(){return X})),r.d(e,"THREAD_STATE_CREATING",(function(){return Y})),r.d(e,"THREAD_STATE_CREATED",(function(){return K})),r.d(e,"THREAD_ENCODE_BUFFER",(function(){return j})),r.d(e,"WASMPTR",(function(){return z})),r.d(e,"AUDIO_MONITOR_LOG",(function(){return Q})),r.d(e,"WhiteBoard_Video_Capture_Tick",(function(){return Z})),r.d(e,"GLOBAL_TRACING_LOG",(function(){return q})),r.d(e,"Audio_Dec_WASM_FAILED",(function(){return J})),r.d(e,"Audio_Dec_Handle_FAILED",(function(){return $})),r.d(e,"Audio_Dec_WebSocket_FAILED",(function(){return tt})),r.d(e,"Audio_Enc_WASM_FAILED",(function(){return et})),r.d(e,"Audio_Enc_Handle_FAILED",(function(){return rt})),r.d(e,"Video_Dec_WASM_FAILED",(function(){return it})),r.d(e,"Video_Dec_Handle_FAILED",(function(){return nt})),r.d(e,"Video_Dec_WebSocket_FAILED",(function(){return ot})),r.d(e,"Video_Enc_WASM_FAILED",(function(){return at})),r.d(e,"Video_Enc_Handle_FAILED",(function(){return st})),r.d(e,"Sharing_Dec_WASM_FAILED",(function(){return ut})),r.d(e,"Audio_Mute",(function(){return ct})),r.d(e,"Sharing_Handle_FAILED",(function(){return ht})),r.d(e,"Sharing_Dec_WebSocket_FAILED",(function(){return ft})),r.d(e,"AUDIO_CLIPPING",(function(){return dt})),r.d(e,"MULTIVIEW_WEBGL_CONTEXT_LOST",(function(){return Et})),r.d(e,"WEBGL_CONTEXT_CREATE_FAILED",(function(){return _t})),r.d(e,"MEDIA_VIDEO_REPORT_DROP_RATIO",(function(){return lt})),r.d(e,"MEDIA_S2C_KEEPALIVE",(function(){return Tt})),r.d(e,"MEDIA_AUDIO_DATA",(function(){return Rt})),r.d(e,"MEDIA_AUDIO_RTCP",(function(){return pt})),r.d(e,"MEDIA_VIDEO_DATA",(function(){return mt})),r.d(e,"MEDIA_VIDEO_RTCP",(function(){return xt})),r.d(e,"MEDIA_NTP_UPDATE",(function(){return vt})),r.d(e,"VIDEO_CAPTURER_RESOLUTION_360P",(function(){return gt})),r.d(e,"VIDEO_CAPTURER_RESOLUTION_720P",(function(){return It})),r.d(e,"VIDEO_CAPTURER_RESOLUTION_1080P",(function(){return At})),r.d(e,"CURRENT_VIDEO_RESOLUTION",(function(){return Ot})),r.d(e,"VIDEO_RENDER_MONITOR_LOG",(function(){return Dt})),r.d(e,"Sharing_Width_And_Height_Info",(function(){return yt})),r.d(e,"SHARING_RENDER_MONITOR_LOG",(function(){return Nt})),r.d(e,"SHARING_GET_IMAGE_DATA_WRONG",(function(){return St})),r.d(e,"AES_GCM_IV_TO_WASM",(function(){return Ct})),r.d(e,"AES_GCM_IV_CALLBACK_FROM_WASM",(function(){return Lt})),r.d(e,"CURRENT_SSRC_TIME",(function(){return Ut})),r.d(e,"CURRENT_DECODE_VIDEO_QUALITY",(function(){return Mt})),r.d(e,"CURRENT_DECODE_VIDEO_FPS",(function(){return bt})),r.d(e,"CURRENT_CAPTURE_VIDEO_WIDTH_HEIGHT",(function(){return wt})),r.d(e,"CURRENT_DESKTOP_SHARING_WIDTH_HEIGHT",(function(){return Pt})),r.d(e,"SHARING_FIRST_DECODE_FRAME_RECEIVED",(function(){return Vt})),r.d(e,"VIDEO_CAPTURER_RESOLUTION_CHANGE",(function(){return Bt})),r.d(e,"VIDEO_CAPTURE_FRAME_COUNT_STATISTIC",(function(){return Gt})),r.d(e,"SHARING_CAPTURE_FRAME_COUNT_STATISTIC",(function(){return Ft})),r.d(e,"UNSUPPORTED_SHARING_FORMAT",(function(){return kt})),r.d(e,"UNSUPPORTED_VIDEO_FORMAT",(function(){return Wt})),r.d(e,"FIRST_SHARING_FRAME_FOR_MOBILE",(function(){return Ht})),r.d(e,"VB_PTHREAD_MODEL_ALL_READY",(function(){return Xt})),r.d(e,"UPDATE_ENCRYPTION_GCM_MODEL_KEY",(function(){return Yt})),r.d(e,"CONNECT_WEBTRANSPORT_OK",(function(){return Kt})),r.d(e,"CONNECT_WEBTRANSPORT_CLOSE",(function(){return jt})),r.d(e,"CURRENT_MEDIA_DATA_TRANSPORT_TYPE",(function(){return zt})),r.d(e,"CONNECT_WEBSOCKET_CLOSE",(function(){return Qt})),r.d(e,"CURRENT_ENCODED_TYPE",(function(){return Zt})),r.d(e,"WHITEBOARD_WORKER_MESSAGE",(function(){return qt})),r.d(e,"INTERPRETATION_ENABLE",(function(){return Jt})),r.d(e,"INTERPRETATION_SET_LANG",(function(){return $t})),r.d(e,"INTERPRETATION_MUTE",(function(){return te})),r.d(e,"INTERPRETATION_SET_INTERPRETER",(function(){return ee})),r.d(e,"serverHeartbeatMaxTimeoutSeconds",(function(){return re})),r.d(e,"RQUEST_ANIMATION_MODE",(function(){return ie})),r.d(e,"SET_INTERVAL_MODE",(function(){return ne})),r.d(e,"VIDEO_INVALID",(function(){return oe})),r.d(e,"VIDEO_RGBA",(function(){return ae})),r.d(e,"VIDEO_I420",(function(){return se})),r.d(e,"VIDEO_NV12",(function(){return ue})),r.d(e,"VIDEO_BGRA",(function(){return ce})),r.d(e,"EVENT_ROLLBACK_BUFFER",(function(){return he})),r.d(e,"EVENT_NEEDMORE_DATA",(function(){return fe})),r.d(e,"EVENT_CAPTURE_DATA",(function(){return de})),r.d(e,"EVENT_CACHE_SIZE",(function(){return Ee})),r.d(e,"WEBCODEC_ENCODE_OPEN_FLAG",(function(){return _e})),r.d(e,"VB_SIGNAL_TYPE_SET_BG",(function(){return le})),r.d(e,"VB_SIGNAL_TYPE_SET_BLUR",(function(){return Te})),r.d(e,"QosSession",(function(){return Re})),r.d(e,"QosConnectType",(function(){return pe})),r.d(e,"MAX_VIDEO_CAPTURE_FPS",(function(){return me})),r.d(e,"MIN_VIDEO_CAPTURE_FPS",(function(){return xe})),r.d(e,"VIDEO_CAPTURE_FPS",(function(){return ve})),r.d(e,"VIDEO_CAPTURE_20FPS",(function(){return ge})),r.d(e,"DOWN_VIDEO_CAPTURE_FPS",(function(){return Ie})),r.d(e,"LOWER_VIDEO_CAPTURE_FPS",(function(){return Ae})),r.d(e,"VIDEO_DATA_MAX_SIZE",(function(){return Oe})),r.d(e,"SHARING_NULL",(function(){return De})),r.d(e,"SHARING_NORMAL",(function(){return ye})),r.d(e,"SHARING_VIDEO_MODE",(function(){return Ne})),r.d(e,"SHARING_VIDEO_MODE_CAPTURED_FPS",(function(){return Se})),r.d(e,"SHARING_NORMAL_MODE_CAPTURED_FPS",(function(){return Ce})),r.d(e,"VIDEO_RINGBUF_PKG_NUM",(function(){return Le})),r.d(e,"NETWORK_QUALITY_CHANGE",(function(){return Ue})),r.d(e,"NETWORK_QUALITY_CHANGE_AUDIO",(function(){return Me})),r.d(e,"ADDITIONNAL_MULTITHREAD_NUMBER_ENCODE_FOR_360P",(function(){return be})),r.d(e,"ADDITIONNAL_MULTITHREAD_NUMBER_ENCODE_FOR_720P",(function(){return we})),r.d(e,"ADDITIONNAL_MULTITHREAD_NUMBER_ENCODE_FOR_1080p",(function(){return Pe})),r.d(e,"WCL_PLATFORM_TYPE",(function(){return Ve})),r.d(e,"AS_CAPTURE_SOURCE",(function(){return Be})),r.d(e,"MEDIA_COMMAND",(function(){return Ge})),r.d(e,"RENDER_MODE_RAF",(function(){return Fe})),r.d(e,"RENDER_MODE_INTERVAL",(function(){return ke})),r.d(e,"RENDER_UNSET",(function(){return We})),r.d(e,"RENDER_IN_WORKER",(function(){return He})),r.d(e,"RENDER_IN_MAIN",(function(){return Xe})),r.d(e,"WEBRTC_NO_AUDIO_MODE",(function(){return Ye})),r.d(e,"WEBRTC_COMMPUTER_AUDIO_MODE",(function(){return Ke})),r.d(e,"WEBRTC_SHARE_AUDIO_MODE",(function(){return je})),r.d(e,"WEBRTC_MULTI_AUDIO_MODE",(function(){return ze})),r.d(e,"VIDEO_FRAME",(function(){return Qe})),r.d(e,"SHARING_FRAME",(function(){return Ze})),r.d(e,"MAX_RENDER_WITHOUT_SAB",(function(){return qe})),r.d(e,"ACTIVE_SPEAKER_SSRC",(function(){return Je})),r.d(e,"FACE_MODE_UNKNOW",(function(){return $e})),r.d(e,"FACE_MODE_USER",(function(){return tr})),r.d(e,"FACE_MODE_ENVIRONMENT",(function(){return er})),r.d(e,"ORIGINAL_SOUND_OFF",(function(){return rr})),r.d(e,"ORIGINAL_SOUND_ON",(function(){return ir})),r.d(e,"ORIGINAL_SOUND_STEREO",(function(){return nr})),r.d(e,"ORIGINAL_SOUND_HIGHFIDELITY",(function(){return or})),r.d(e,"ORIGINAL_SOUND_HIGHFIDELITY_STEREO",(function(){return ar})),r.d(e,"SHARE_AUDIO",(function(){return sr})),r.d(e,"ORIGINAL_SOUND_OFF_HIGH_BITRATE",(function(){return ur})),r.d(e,"PUBLISHER_ICEConnectionState_Failed",(function(){return cr})),r.d(e,"SUBSCRIBER_ICEConnectionState_Failed",(function(){return hr})),r.d(e,"NO_MESSAGE_FAILOVER",(function(){return fr})),r.d(e,"WS_ERROR_FAILOVER",(function(){return dr})),r.d(e,"WS_CLOSE_FAILOVER",(function(){return Er}));var i=1,n=2,o=3,a=4,s=5,u=7,c=8,h=9,f=10,d=11,E=12,_=13,l=14,T=15,R=16,p=17,m=18,x=20,v=21,g=3021,I=22,A=23,O=24,D=26,y=27,N="QosMonitoring",S=1e3,C=5,L=30,U=31,M=32,b=33,w=34,P=35,V=36,B=37,G=38,F=39,k=40,W=41,H=42,X=43,Y=44,K=45,j=46,z=47,Q=48,Z=60,q=61,J=-1,$=-2,tt=-3,et=-4,rt=-5,it=-7,nt=-8,ot=-9,at=-10,st=-11,ut=-12,ct=-13,ht=-14,ft=-15,dt=-23,Et=-26,_t=-27,lt=100,Tt=0,Rt=1,pt=6,mt=2,xt=7,vt=9,gt=10,It=11,At=12,Ot=50,Dt=51,yt=52,Nt=53,St=54,Ct=55,Lt=56,Ut=57,Mt=66.5,bt=66.6,wt=67,Pt=68,Vt=69,Bt=71,Gt=72,Ft=73,kt=75,Wt=76,Ht=78,Xt=95,Yt=102,Kt=105,jt=106,zt=107,Qt=108,Zt=109,qt=120,Jt=0,$t=1,te=2,ee=3,re=65,ie=0,ne=1,oe=-1,ae=0,se=1,ue=2,ce=3,he=0,fe=1,de=2,Ee=3,_e=!0,le=0,Te=1,Re={SESSION_TYPE_CONF:0,SESSION_TYPE_AUDIO:1,SESSION_TYPE_DESKSHARE:2,SESSION_TYPE_VIDEO:3,SESSION_TYPE_CHAT:4,SESSION_TYPE_TELEPHONE:5,SESSION_TYPE_ZC_PING:6,SESSION_TYPE_TOTAL_CNT:7},pe={CONNECT_TYPE_UDP:0,CONNECT_TYPE_TCP:1},me=30,xe=1,ve=24,ge=20,Ie=15,Ae=10,Oe=8294400,De=0,ye=1,Ne=2,Se=15,Ce=5,Le=400,Ue="NETWORK_QUALITY_CHANGE",Me="NETWORK_QUALITY_CHANGE_AUDIO",be=3,we=7,Pe=8,Ve={DESKTOP:0,MOBILE:1,ANDROID:2,IPHONE:3},Be={DESKTOP_SOURCE:0,UAC_SOURCE:1},Ge={SHARE_REMOTE_CONTROL_UAC_MOUSE:144,SHARE_REMOTE_CONTROL_UAC_JPEG_FRAME:145},Fe=0,ke=1,We=-1,He=0,Xe=1,Ye=0,Ke=1,je=2,ze=Ke+je,Qe=0,Ze=1,qe=25,Je=1,$e=-1,tr=0,er=1,rr=0,ir=1,nr=2|ir,or=4|ir,ar=nr|or,sr=8,ur=16,cr=3,hr=107,fr="100",dr="101",Er="102"},function(t,e,r){var i=r(15)();t.exports=i;try{regeneratorRuntime=i}catch(t){"object"==typeof globalThis?globalThis.regeneratorRuntime=i:Function("r","regeneratorRuntime = r")(i)}},function(t,e){function r(t,e,r,i,n,o,a){try{var s=t[o](a),u=s.value}catch(t){return void r(t)}s.done?e(u):Promise.resolve(u).then(i,n)}t.exports=function(t){return function(){var e=this,i=arguments;return new Promise((function(n,o){var a=t.apply(e,i);function s(t){r(a,n,o,s,u,"next",t)}function u(t){r(a,n,o,s,u,"throw",t)}s(void 0)}))}},t.exports.__esModule=!0,t.exports.default=t.exports},function(t,e){t.exports=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},t.exports.__esModule=!0,t.exports.default=t.exports},function(t,e,r){var i=r(13);function n(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,i(n.key),n)}}t.exports=function(t,e,r){return e&&n(t.prototype,e),r&&n(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t},t.exports.__esModule=!0,t.exports.default=t.exports},function(t,e){function r(e){return t.exports=r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t.exports.__esModule=!0,t.exports.default=t.exports,r(e)}t.exports=r,t.exports.__esModule=!0,t.exports.default=t.exports},function(t,e,r){var i=r(9),n=r(10),o=r(11),a=r(12);t.exports=function(t){return i(t)||n(t)||o(t)||a()},t.exports.__esModule=!0,t.exports.default=t.exports},function(t,e){t.exports=function(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,i=new Array(e);r<e;r++)i[r]=t[r];return i},t.exports.__esModule=!0,t.exports.default=t.exports},function(t,e,r){"use strict";var i=this&&this.__awaiter||function(t,e,r,i){return new(r||(r=Promise))((function(n,o){function a(t){try{u(i.next(t))}catch(t){o(t)}}function s(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){var e;t.done?n(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(a,s)}u((i=i.apply(t,e||[])).next())}))},n=this&&this.__rest||function(t,e){var r={};for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.indexOf(i)<0&&(r[i]=t[i]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(i=Object.getOwnPropertySymbols(t);n<i.length;n++)e.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(t,i[n])&&(r[i[n]]=t[i[n]])}return r};Object.defineProperty(e,"__esModule",{value:!0});const o=r(18),a=r(0),s=r(16),u=r(17);class c{constructor(t){this.isMirror=!1,this.isVBReady=!1,this.timer=0,this.manualFreeMemory=!1,this.isVBInitializing=!1;const{canvas:e,canvasID:r,bgImage:i,manualFreeMemory:s,cdnPath:u}=t,h=n(t,["canvas","canvasID","bgImage","manualFreeMemory","cdnPath"]);if(this.cdnPath=u||c.cdnPath,!this.cdnPath)throw new Error("VB module: cdnPath is not provided");if(this.vbWorkerUrl=this.cdnPath+"/vb_worker.min.js",this.initParam=h,e){let t;t="string"==typeof e?document.querySelector("#"+e):e,t&&(this.display=new o.default(t,r,0,void 0,{preserveDrawingBuffer:!1},void 0,!1),this.display.setVideoMode(a.VIDEO_I420))}i&&(this.bgImage=i),s&&(this.manualFreeMemory=s),this.handle_message_from_vb_worker=this.handle_message_from_vb_worker.bind(this)}static isSupportVB(){return i(this,void 0,void 0,(function*(){try{const t=yield u.default.simd();return navigator.hardwareConcurrency&&navigator.hardwareConcurrency>2&&t&&"function"==typeof OffscreenCanvas}catch(t){return!1}}))}initialize(){return this.isVBReady?Promise.resolve():(this.isVBInitializing||(this.isVBInitializing=!0,this.initPromise=new Promise((t,e)=>i(this,void 0,void 0,(function*(){this.initReject=e,this.initResolve=t;try{const t=yield fetch(this.vbWorkerUrl);if(t.ok){const e=yield t.arrayBuffer(),r=window.URL.createObjectURL(new Blob([e]));this.worker=new Worker(r,{name:c.VB_WORKER_NAME}),this.worker.addEventListener("message",this.handle_message_from_vb_worker),this.worker.postMessage({cmd:s.VB_EVENT_TYPE.VB_WORKER_INIT,payload:Object.assign(Object.assign({},this.initParam),{cdnPath:this.cdnPath})}),window.URL.revokeObjectURL(r)}else{const{url:r,status:i}=t;this.isVBInitializing=!1,e(`Fetch worker file failed. url: ${r}, status: ${i}`)}}catch(t){this.isVBInitializing=!1,e(t)}})))),this.initPromise)}send_video_frame(t){this.isVBReady&&this.worker.postMessage({cmd:s.VB_EVENT_TYPE.VB_RECEIVE_VIDEOFRAME,payload:t},[t])}send_rgb_frame(t){this.isVBReady&&this.worker.postMessage({cmd:s.VB_EVENT_TYPE.VB_RECEIVE_IMAGEDATA,payload:t},[t.data.buffer])}Crop_Mask_Bg_16V9(){let t,e,r,i=0,n=this.bgImage.width,o=this.bgImage.height;return 16/9*o>=n?(r=n,i=n/(16/9),t=0,e=(o-i)/2):(r=o*(16/9),i=o,t=(n-r)/2,e=0),{sx:t,sy:e,sw:r,sh:i}}set_background_image(t){if(this.bgImage=t,!this.isVBReady)return!1;const e=this.Crop_Mask_Bg_16V9();let r,i,n,o,a,u;r=e.sx,i=e.sy,n=e.sw,o=e.sh,n>1920?(a=1920,u=1080):(a=n,u=o),this.bgConvertCanvas||(this.bgConvertCanvas=new OffscreenCanvas(a,u)),this.bgConvertCanvas.width=a,this.bgConvertCanvas.height=u;let c=this.bgConvertCanvas.getContext("2d");if(!c)return!1;c.drawImage(t,r,i,n,o,0,0,this.bgConvertCanvas.width,this.bgConvertCanvas.height);let h=c.getImageData(0,0,this.bgConvertCanvas.width,this.bgConvertCanvas.height);return this.worker.postMessage({cmd:s.VB_EVENT_TYPE.VB_UPDATE_BG,payload:h}),"close"in t&&t.close(),!0}set_background_blur(){this.isVBReady&&this.worker.postMessage({cmd:s.VB_EVENT_TYPE.VB_UPDATE_BG,payload:"blur"})}render_vb_frame(t,e,r,i){if(this.display){let n={x:0,y:0,width:this.display.canvasElement.width,height:this.display.canvasElement.height};this.display.updateRemoteVideoTextures(t,e,i,r,0,!0,n,!1),this.display.drawRemoteVideo(n,this.isMirror)}}handle_message_from_vb_worker(t){const{cmd:e,payload:r}=t.data;switch(c.EXTERNAL_EVENTS.has(e)&&this.callback&&this.callback(t.data),e){case s.VB_EVENT_TYPE.VB_INIT_FAILED:this.isVBInitializing=!1,this.initReject(r);break;case s.VB_EVENT_TYPE.VB_INIT_SUCCESS:this.isVBReady=!0,this.isVBInitializing=!1,this.bgImage&&this.set_background_image(this.bgImage),this.initResolve();break;case s.VB_EVENT_TYPE.VB_GENERATED_FRAME:{const e=t.data.payload,{data_ptr:r}=e;if(this.display){const e=t.data.payload,{data:r,format_width:i,format_height:n,valid_x:o,valid_y:a,valid_width:s,valid_height:u}=e;let c;c=r;let h={top:a,left:o,width:s,height:u};this.render_vb_frame(i,n,c,h)}r&&!this.manualFreeMemory&&this.worker.postMessage({cmd:s.VB_EVENT_TYPE.VB_FREE_MEMORY,payload:{pointer:r}})}}}onMessage(t){this.callback=t}captureVideo(t){return i(this,void 0,void 0,(function*(){this.isVBReady||this.isVBInitializing?this.isVBInitializing&&(yield this.initPromise):yield this.initialize();let e,r=24;const i=yield navigator.mediaDevices.getUserMedia(Object.assign(Object.assign({},t),{audio:!1}));if(this.videoStream=i,e=this.videoStream.getVideoTracks()[0]){r=e.getSettings().frameRate||r,r>24&&(r=24)}let n,o,a,s,u,h=document.querySelector("#"+c.VB_CAPTURE_VIDEO),f=!1;const d=()=>{h&&(s=h.videoWidth,u=h.videoHeight,o.width=s,o.height=u,f=!0,h.removeEventListener("loadedmetadata",d))};if(window.MediaStreamTrackProcessor){const t=i.getVideoTracks()[0],e=new window.MediaStreamTrackProcessor({track:t});n=e.readable.getReader()}else o=document.createElement("canvas"),a=o.getContext("2d"),h||(h=document.createElement("video"),h.autoplay=!0,h.playsInline=!0,h.id=c.VB_CAPTURE_VIDEO,h.style.position="fixed",h.style.width="1px",h.style.height="1px",h.style.bottom="0px",h.style.right="0px",document.body.appendChild(h)),h.addEventListener("loadedmetadata",d),h.srcObject=i;this.timer=setInterval(()=>{if(this.isVBReady)if(n)n.read().then(({value:t,done:e})=>{e?clearInterval(this.timer):this.send_video_frame(t)});else if(a&&h&&f){a.drawImage(h,0,0);const t=a.getImageData(0,0,s,u);this.send_rgb_frame(t)}},1e3/r)}))}stopCapture(){this.timer&&clearInterval(this.timer),this.videoStream&&this.videoStream.getTracks().forEach(t=>{t.stop()})}setMirror(t){this.isMirror=t}freeMemory(t){this.isVBReady&&this.worker.postMessage({cmd:s.VB_EVENT_TYPE.VB_FREE_MEMORY,payload:{pointer:t}})}}if(c.VB_WORKER_NAME="vb_worker",c.VB_CAPTURE_VIDEO="VB_CAPTURE_VIDEO",c.EXTERNAL_EVENTS=new Set([s.VB_EVENT_TYPE.VB_GENERATED_FRAME,s.VB_EVENT_TYPE.VB_INIT_FAILED,s.VB_EVENT_TYPE.VB_INIT_SUCCESS,s.VB_EVENT_TYPE.VB_MODEL_READY,s.VB_EVENT_TYPE.VB_PREDICT_DONE,s.VB_EVENT_TYPE.VB_VIDEO_FORMAT_UNSUPPORTED,s.VB_EVENT_TYPE.VB_WORKER_ERROR]),e.default=c,document){const t=document.currentScript;if(t){const e=t.src;if(e){let t=e.indexOf("/vb.min.js");-1!==t&&(c.cdnPath=e.substring(0,t))}}}},function(t,e,r){var i=r(7);t.exports=function(t){if(Array.isArray(t))return i(t)},t.exports.__esModule=!0,t.exports.default=t.exports},function(t,e){t.exports=function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)},t.exports.__esModule=!0,t.exports.default=t.exports},function(t,e,r){var i=r(7);t.exports=function(t,e){if(t){if("string"==typeof t)return i(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?i(t,e):void 0}},t.exports.__esModule=!0,t.exports.default=t.exports},function(t,e){t.exports=function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")},t.exports.__esModule=!0,t.exports.default=t.exports},function(t,e,r){var i=r(5).default,n=r(14);t.exports=function(t){var e=n(t,"string");return"symbol"===i(e)?e:String(e)},t.exports.__esModule=!0,t.exports.default=t.exports},function(t,e,r){var i=r(5).default;t.exports=function(t,e){if("object"!==i(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,e||"default");if("object"!==i(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)},t.exports.__esModule=!0,t.exports.default=t.exports},function(t,e,r){var i=r(5).default;function n(){"use strict";/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */t.exports=n=function(){return e},t.exports.__esModule=!0,t.exports.default=t.exports;var e={},r=Object.prototype,o=r.hasOwnProperty,a=Object.defineProperty||function(t,e,r){t[e]=r.value},s="function"==typeof Symbol?Symbol:{},u=s.iterator||"@@iterator",c=s.asyncIterator||"@@asyncIterator",h=s.toStringTag||"@@toStringTag";function f(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{f({},"")}catch(t){f=function(t,e,r){return t[e]=r}}function d(t,e,r,i){var n=e&&e.prototype instanceof l?e:l,o=Object.create(n.prototype),s=new N(i||[]);return a(o,"_invoke",{value:A(t,r,s)}),o}function E(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=d;var _={};function l(){}function T(){}function R(){}var p={};f(p,u,(function(){return this}));var m=Object.getPrototypeOf,x=m&&m(m(S([])));x&&x!==r&&o.call(x,u)&&(p=x);var v=R.prototype=l.prototype=Object.create(p);function g(t){["next","throw","return"].forEach((function(e){f(t,e,(function(t){return this._invoke(e,t)}))}))}function I(t,e){var r;a(this,"_invoke",{value:function(n,a){function s(){return new e((function(r,s){!function r(n,a,s,u){var c=E(t[n],t,a);if("throw"!==c.type){var h=c.arg,f=h.value;return f&&"object"==i(f)&&o.call(f,"__await")?e.resolve(f.__await).then((function(t){r("next",t,s,u)}),(function(t){r("throw",t,s,u)})):e.resolve(f).then((function(t){h.value=t,s(h)}),(function(t){return r("throw",t,s,u)}))}u(c.arg)}(n,a,r,s)}))}return r=r?r.then(s,s):s()}})}function A(t,e,r){var i="suspendedStart";return function(n,o){if("executing"===i)throw new Error("Generator is already running");if("completed"===i){if("throw"===n)throw o;return C()}for(r.method=n,r.arg=o;;){var a=r.delegate;if(a){var s=O(a,r);if(s){if(s===_)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===i)throw i="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);i="executing";var u=E(t,e,r);if("normal"===u.type){if(i=r.done?"completed":"suspendedYield",u.arg===_)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(i="completed",r.method="throw",r.arg=u.arg)}}}function O(t,e){var r=e.method,i=t.iterator[r];if(void 0===i)return e.delegate=null,"throw"===r&&t.iterator.return&&(e.method="return",e.arg=void 0,O(t,e),"throw"===e.method)||"return"!==r&&(e.method="throw",e.arg=new TypeError("The iterator does not provide a '"+r+"' method")),_;var n=E(i,t.iterator,e.arg);if("throw"===n.type)return e.method="throw",e.arg=n.arg,e.delegate=null,_;var o=n.arg;return o?o.done?(e[t.resultName]=o.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=void 0),e.delegate=null,_):o:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,_)}function D(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function y(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function N(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(D,this),this.reset(!0)}function S(t){if(t){var e=t[u];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,i=function e(){for(;++r<t.length;)if(o.call(t,r))return e.value=t[r],e.done=!1,e;return e.value=void 0,e.done=!0,e};return i.next=i}}return{next:C}}function C(){return{value:void 0,done:!0}}return T.prototype=R,a(v,"constructor",{value:R,configurable:!0}),a(R,"constructor",{value:T,configurable:!0}),T.displayName=f(R,h,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===T||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,R):(t.__proto__=R,f(t,h,"GeneratorFunction")),t.prototype=Object.create(v),t},e.awrap=function(t){return{__await:t}},g(I.prototype),f(I.prototype,c,(function(){return this})),e.AsyncIterator=I,e.async=function(t,r,i,n,o){void 0===o&&(o=Promise);var a=new I(d(t,r,i,n),o);return e.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},g(v),f(v,h,"Generator"),f(v,u,(function(){return this})),f(v,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var i in e)r.push(i);return r.reverse(),function t(){for(;r.length;){var i=r.pop();if(i in e)return t.value=i,t.done=!1,t}return t.done=!0,t}},e.values=S,N.prototype={constructor:N,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(y),!t)for(var e in this)"t"===e.charAt(0)&&o.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=void 0)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var e=this;function r(r,i){return a.type="throw",a.arg=t,e.next=r,i&&(e.method="next",e.arg=void 0),!!i}for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i],a=n.completion;if("root"===n.tryLoc)return r("end");if(n.tryLoc<=this.prev){var s=o.call(n,"catchLoc"),u=o.call(n,"finallyLoc");if(s&&u){if(this.prev<n.catchLoc)return r(n.catchLoc,!0);if(this.prev<n.finallyLoc)return r(n.finallyLoc)}else if(s){if(this.prev<n.catchLoc)return r(n.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<n.finallyLoc)return r(n.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r];if(i.tryLoc<=this.prev&&o.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var n=i;break}}n&&("break"===t||"continue"===t)&&n.tryLoc<=e&&e<=n.finallyLoc&&(n=null);var a=n?n.completion:{};return a.type=t,a.arg=e,n?(this.method="next",this.next=n.finallyLoc,_):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),_},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),y(r),_}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var i=r.completion;if("throw"===i.type){var n=i.arg;y(r)}return n}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,r){return this.delegate={iterator:S(t),resultName:e,nextLoc:r},"next"===this.method&&(this.arg=void 0),_}},e}t.exports=n,t.exports.__esModule=!0,t.exports.default=t.exports},function(t,e,r){"use strict";var i;Object.defineProperty(e,"__esModule",{value:!0}),e.VB_EVENT_TYPE=void 0,function(t){t.VB_INIT_SUCCESS="VB_INIT_SUCCESS",t.VB_INIT_FAILED="VB_INIT_FAILED",t.VB_GENERATED_FRAME="VB_GENERATED_FRAME",t.VB_RECEIVE_VIDEOFRAME="VB_RECEIVE_VIDEOFRAME",t.VB_RECEIVE_IMAGEDATA="VB_RECEIVE_IMAGEDATA",t.VB_UPDATE_BG="VB_UPDATE_BG",t.VB_PREDICT_DONE="vbPredictDone",t.VB_MODEL_READY="modelReady",t.VB_FREE_MEMORY="VB_FREE_MEMORY",t.VB_VIDEO_FORMAT_UNSUPPORTED="VB_VIDEO_FORMAT_UNSUPPORTED",t.VB_WORKER_INIT="VB_WORKER_INIT",t.VB_WORKER_ERROR="VB_WORKER_ERROR"}(i||(e.VB_EVENT_TYPE=i={}))},function(t,e,r){"use strict";r.r(e);var i,n,o=r(2),a=r.n(o),s=r(1),u=r.n(s),c=function(){};c.prototype={threads:(n=a()(u.a.mark((function t(){return u.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",function(){var t=a()(u.a.mark((function t(e){return u.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(WebAssembly.validate(e)){t.next=2;break}return t.abrupt("return",!1);case 2:return t.prev=2,t.abrupt("return",((new MessageChannel).port1.postMessage(new SharedArrayBuffer(1)),!0));case 6:return t.prev=6,t.t0=t.catch(2),t.abrupt("return",!1);case 9:case"end":return t.stop()}}),t,null,[[2,6]])})));return function(e){return t.apply(this,arguments)}}()(new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,2,1,0,5,4,1,3,1,1,10,11,1,9,0,65,0,254,16,2,0,26,11])));case 1:case"end":return t.stop()}}),t)}))),function(){return n.apply(this,arguments)}),simd:(i=a()(u.a.mark((function t(){return u.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,2,1,0,10,9,1,7,0,65,0,253,15,26,11])));case 1:case"end":return t.stop()}}),t)}))),function(){return i.apply(this,arguments)})},e.default=new c},function(t,e,r){"use strict";r.r(e);var i=r(6),n=r.n(i),o=r(0),a=r(3),s=r.n(a),u=r(4),c=r.n(u);r(2),r(1);function h(t){var e,r,i,n,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;(a instanceof Error||a instanceof ErrorEvent)&&(t+="Message: "+(null===(e=a)||void 0===e?void 0:e.message)+" Stack: "+(null!==(r=null===(i=a)||void 0===i||null===(i=i.error)||void 0===i?void 0:i.stack)&&void 0!==r?r:null===(n=a)||void 0===n?void 0:n.stack),a=null);postMessage({status:o.GLOBAL_TRACING_LOG,errorMessage:t,errorEvent:a})}var f=["","MOZ_","OP_","WEBKIT_"];function d(t,e){for(var r=0;r<f.length;++r){var i=f[r]+e,n=t.getExtension(i);if(n)return n}}var E=function(){function t(){s()(this,t),this.ssrcInfoMap=new Map,this.timer=null}return c()(t,[{key:"updateSSRCInfo",value:function(t,e){this.ssrcInfoMap.has(t)||this.ssrcInfoMap.set(t,{firstTime:0,lastTime:0,frames:0,fps:0}),this._calculateFPS(t,e),this._removeZeroFPS()}},{key:"_calculateFPS",value:function(t,e){var r=this.ssrcInfoMap.get(t);if(0===r.frames?r.firstTime=e:r.lastTime=e,r.frames+=1,r.frames>2&&r.frames%5==0&&r.lastTime-r.firstTime>=1e3){var i=Math.floor(1e3/((r.lastTime-r.firstTime)/(r.frames-1)));r.fps!==i&&(this._notifyFPS(t,i),r.fps=i),r.firstTime=r.lastTime,r.frames=1}}},{key:"_removeZeroFPS",value:function(){var t=this,e=Date.now();this.ssrcInfoMap.forEach((function(r,i){var n=t.ssrcInfoMap.get(i);n&&e-n.lastTime>2e3&&(t.ssrcInfoMap.delete(i),t._notifyFPS(i,0))}))}},{key:"_notifyFPS",value:function(t,e){postMessage({status:o.CURRENT_DECODE_VIDEO_FPS,data:{ssrc:t,fps:e}})}},{key:"_checkIfNewFrameComing",value:function(){var t=this;this.timer&&(clearTimeout(this.timer),this.timer=null),this.timer=setTimeout((function(){t._removeZeroFPS(),t.timer=null}),2500)}}]),t}();new Map,new E;function _(t,e){var r=Math.pow(10,e);return Math.floor(t*r)/r}function l(t,e){var r=Math.pow(10,e);return Math.ceil(t*r)/r}var T=new Map,R=[];function p(t,e,r,i,n,a,s){if(this.canvasElement=t,this.canvasID=e,this.contextOptions=n,this.glInitSucceed=0,this.textureindex=r||0,this.texturestride=this.textureindex?3:s?4:6,this.initmask=s||!1,this.reuse=!1,p.prototype.ROTATION_CLOCK0=0,p.prototype.ROTATION_CLOCK90=1,p.prototype.ROTATION_CLOCK180=2,p.prototype.ROTATION_CLOCK270=3,a?this.contextGL=a.contextgl:(this.initContextGL(),this.contextGL&&this.webGLContextLostProtect()),this.contextGL){a?(this.shaderProgram=a.program,this.waterMarkTextureRef=a.waterMarkTextureRef,this.repeatedWaterMarkTextureRef=a.repeatedWaterMarkTextureRef,this.initTextures(!1),this.vertexPosBuffer=a.vBuffer,this.texturePosBuffer=a.tBuffer):(this.initProgram(),this.initmask?this.initTextures(!1):this.initTextures(!0),this.initBuffers());var u=new ArrayBuffer(4);this.dummpyCursor=new Uint8Array(u),this.dummpyWaterMark=new Uint8Array(u);var c=this.contextGL.getError();this.glInitSucceed=c!=this.contextGL.NO_ERROR&&c!=this.contextGL.CONTEXT_LOST_WEBGL?0:1,this.cursorWidth=0,this.cursorHeight=0,this.hasCursor=0,this.hasWaterMark=0,this.watermarkOpacity=.15,this.watermarkData=null,this.watermarkWidth=0,this.watermarkHeight=0,this.isMultiView=!1,this.hasWholeFrame=0,this.croppingParams={},this.croppingParams.top=0,this.croppingParams.left=0,this.croppingParams.width=0,this.croppingParams.height=0,this.textureWidth=0,this.textureHeight=0,this.canvasWidth=0,this.canvasHeight=0,this.picRotation=-1,this.bgColor=[0,0,0],this.cx=0,this.cy=0,this.cw=0,this.ch=0,this.colorRange=-1,this.videoMode=o.VIDEO_INVALID,this.rotation=this.ROTATION_CLOCK0,this.fillMode=0,this.fillModeForResolution=0}}function m(t,e,r,i){var n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,o=t.contextGL,a=o.canvas.width,s=o.canvas.height;n&&(a=n.width,s=n.height);var u,c,h,f,d=i==t.ROTATION_CLOCK90||i==t.ROTATION_CLOCK270?r:e,E=i==t.ROTATION_CLOCK90||i==t.ROTATION_CLOCK270?e:r,_=d/E*s,l=E/d*a;_>a?(u=0,h=1,f=1-(c=(s-l)/2/s)):(c=0,f=1,h=1-(u=(a-_)/2/a)),u=2*u-1,h=2*h-1,c=1-2*c,f=1-2*f;var T=new Float32Array([h,c,u,c,h,f,u,f,h,c,u,c,h,f,u,f]);o.bindBuffer(o.ARRAY_BUFFER,t.vertexPosBuffer),o.bufferData(o.ARRAY_BUFFER,T,o.DYNAMIC_DRAW)}function x(t,e,r,i,o){var a=t.contextGL,s=i.top/r,u=i.left/e,c=s+(i.height-1)/r,h=u+i.width/e,f=[u,s,h,s,h,c,u,c];o==t.ROTATION_CLOCK90&&(f.unshift(f[6],f[7]),f=f.slice(0,8)),o==t.ROTATION_CLOCK180&&(f.unshift(f[4],f[5],f[6],f[7]),f=f.slice(0,8)),o==t.ROTATION_CLOCK270&&(f.push(f[0],f[1]),f=f.slice(2));var d=f[0],E=f[1];f[0]=f[2],f[1]=f[3],f[2]=d,f[3]=E;var _=new Float32Array([].concat(n()(f),[1,0,0,0,1,1,0,1]));a.bindBuffer(a.ARRAY_BUFFER,t.texturePosBuffer),a.bufferData(a.ARRAY_BUFFER,_,a.DYNAMIC_DRAW)}p.prototype.webGLContextLostSimulate=function(){var t="undefined"==typeof window?self:window;t.webGLEXTSimulate=t.webGLEXTSimulate||[],t.webGLEXTSimulate.push(d(this.contextGL,"WEBGL_lose_context")),console.log("\n    webGLEXTSimulate[0].loseContext()\n    webGLEXTSimulate[0].restoreContext()\n    ")},p.prototype.loseContext=function(){if(this.contextGL){try{this.loseContextExtension&&this.loseContextExtension.loseContext()}catch(t){h("loseContext exception: ".concat(JSON.stringify(t)))}this.contextGL=null}},p.prototype.restoreContext=function(){if(this.contextGL)try{this.loseContextExtension&&this.loseContextExtension.restoreContext()}catch(t){h("restoreContext exception: ".concat(JSON.stringify(t)))}},p.prototype.webgGLContextLostCallback=function(t){h("webglcontextlost event from canvas id: ".concat(this.canvasID)),t.preventDefault(),this.contextOptions&&this.contextOptions.webglcontextlostCallback&&this.contextOptions.webglcontextlostCallback(t,this.contextOptions.params),setTimeout(function(){this.restoreContext()}.bind(this),0)},p.prototype.removeEventListener=function(t,e){if(t&&e){0,t.removeEventListener("webglcontextlost",e.contextLostHandler),t.removeEventListener("webglcontextrestored",e.contextRestoredHandler);var r=R.indexOf(this.canvasID);R.splice(r,1),T.delete(t)}},p.prototype.webGLContextRestoredCallback=function(t){h("webglcontextrestored event from canvas id: ".concat(this.canvasID)),this.contextOptions&&this.contextOptions.webglcontextrestoredCallback&&this.contextOptions.webglcontextrestoredCallback(t,this.contextOptions.params)},p.prototype.webGLContextLostProtect=function(){this.loseContextExtension||(this.loseContextExtension=d(this.contextGL,"WEBGL_lose_context"));var t=this.canvasElement,e=T.get(t);e&&this.removeEventListener(t,e),T.set(t,this),this.contextLostHandler=this.webgGLContextLostCallback.bind(this),this.contextRestoredHandler=this.webGLContextRestoredCallback.bind(this),t.addEventListener("webglcontextlost",this.contextLostHandler,{capture:!1,once:!0}),t.addEventListener("webglcontextrestored",this.contextRestoredHandler,{capture:!1,once:!0}),R.push(this.canvasID),R.length>4&&h("listener size=".concat(R.length,", ids:").concat(R.join()))},p.prototype.isWebGL=function(){return this.contextGL},p.prototype.isAvaiable=function(){return this.contextGL&&!this.contextGL.isContextLost()},p.prototype.initContextGL=function(){for(var t,e=this.canvasElement,r=null,i=["webgl","experimental-webgl","moz-webgl","webkit-3d"],n=0;!r&&n<i.length;){var o=i[n];try{r=this.contextOptions?e.getContext(o,this.contextOptions):e.getContext(o)}catch(t){h("Error when trying to getContext on canvas",t),r=null}r&&"function"==typeof r.getParameter||(r=null),++n}(this.contextGL=r,!r||r.isContextLost())&&(h("webglcontext create error, gl=".concat(r,", context lost=").concat(null===(t=r)||void 0===t?void 0:t.isContextLost(),"!")),this.contextGL=null)},p.prototype.initProgram=function(){var t=this.contextGL,e=["attribute vec4 vertexPos;","attribute vec4 texturePos;","attribute vec4 masktexturePos;","varying vec2 textureCoord;","varying vec2 masktextureCoord;","void main()","{","gl_Position = vertexPos;","textureCoord = texturePos.xy;","masktextureCoord = masktexturePos.xy;","}"].join("\n"),r=["precision highp float;","varying highp vec2 textureCoord;","varying highp vec2 masktextureCoord;","uniform sampler2D ySampler;","uniform sampler2D uSampler;","uniform sampler2D vSampler;","uniform sampler2D cursorSampler;","uniform sampler2D waterMarkSampler;","uniform sampler2D  previewVideoSampler;","uniform sampler2D maskSampler;","uniform vec4 cursorInfo;","uniform int onlyRGBA;","uniform int bgraMode;","uniform int colorRange;","uniform int waterMarkFlag;","uniform int cursorFlag;","uniform int maskFlag;","uniform int yuvmode;","const mat4 YUV2RGB_L = mat4","(","1.1643828125, 0, 1.59602734375, -.87078515625,","1.1643828125, -.39176171875, -.81296875, .52959375,","1.1643828125, 2.017234375, 0, -1.081390625,","0, 0, 0, 1",");","const mat4 YUV2RGB_F = mat4","(","1.0, 0, 1.402, -.701,","1.0, -.34413, -.71414, .529135,","1.0, 1.772, 0, -.886,","0, 0, 0, 1",");","void main(void) {","vec4 c;","if(waterMarkFlag!=1) {","if(onlyRGBA==0){","highp float y = texture2D(ySampler,  textureCoord).r;","highp float u;","highp float v;","if(yuvmode==1){","u = texture2D(uSampler,  textureCoord).r;","v = texture2D(vSampler,  textureCoord).r;","}","else{","u = texture2D(uSampler,  textureCoord).r;","v = texture2D(uSampler,  textureCoord).a;","}","if (colorRange == 0)","{","  c = vec4(y, u, v, 1) * YUV2RGB_L;","} else {","  c = vec4(y, u, v, 1) * YUV2RGB_F;","}","if(cursorFlag==1)","{","if (cursorInfo.z > 0.0 && textureCoord.x >= cursorInfo.x && textureCoord.y >= cursorInfo.y && ","    textureCoord.x < cursorInfo.x+cursorInfo.z && textureCoord.y < cursorInfo.y+cursorInfo.w ){"," vec2 cursorCoord = textureCoord - cursorInfo.xy;"," cursorCoord /= cursorInfo.zw;"," vec4 cursor = texture2D(cursorSampler, cursorCoord);"," c = c*(1.0-cursor.a) + cursor*cursor.a;","}","}","}","else{"," c = texture2D(previewVideoSampler, textureCoord);","if(bgraMode==1)","{"," c = vec4(c.b, c.g, c.r, c.a);","}","}","}","if(waterMarkFlag==1)","{"," c = texture2D(waterMarkSampler, textureCoord);","if(c.r == 0.0 && c.g == 0.0 && c.b == 0.0){"," c.a = 0.0;","}","}","if(maskFlag==1 && waterMarkFlag!=1)","{","vec4 mask = texture2D(maskSampler, masktextureCoord);","if(mask.r != 0.0 || mask.g != 0.0 || mask.b != 0.0){","c = mask* mask.a+ c*(1.0-mask.a);","}","}","if (waterMarkFlag!=1){","c.a = 1.0;","}","gl_FragColor = c;","}"].join("\n"),i=t.createShader(t.VERTEX_SHADER);t.shaderSource(i,e),t.compileShader(i),t.getShaderParameter(i,t.COMPILE_STATUS)||t.isContextLost()||console.log("Vertex shader failed to compile: "+t.getShaderInfoLog(i));var n=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(n,r),t.compileShader(n),t.getShaderParameter(n,t.COMPILE_STATUS)||t.isContextLost()||console.log("Fragment shader failed to compile: "+t.getShaderInfoLog(n));var o=t.createProgram();t.attachShader(o,i),t.attachShader(o,n),t.linkProgram(o),t.getProgramParameter(o,t.LINK_STATUS)||t.isContextLost()||console.log("Program failed to compile: "+t.getProgramInfoLog(o)),t.useProgram(o),this.shaderProgram=o},p.prototype.initBuffers=function(){var t=this.contextGL,e=this.shaderProgram,r=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,new Float32Array([1,1,-1,1,1,-1,-1,-1,1,1,-1,1,1,-1,-1,-1]),t.STATIC_DRAW);var i=t.getAttribLocation(e,"vertexPos");t.enableVertexAttribArray(i),t.vertexAttribPointer(i,2,t.FLOAT,!1,0,0),this.vertexPosBuffer=r;var n=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,n),t.bufferData(t.ARRAY_BUFFER,new Float32Array([1,0,0,0,1,1,0,1,1,0,0,0,1,1,0,1]),t.STATIC_DRAW);var o=t.getAttribLocation(e,"texturePos");if(t.enableVertexAttribArray(o),t.vertexAttribPointer(o,2,t.FLOAT,!1,0,0),this.initmask&&!this.masktexturePosBuffer){var a=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,a),t.bufferData(t.ARRAY_BUFFER,new Float32Array([1,0,0,0,1,1,0,1]),t.STATIC_DRAW);var s=t.getAttribLocation(e,"masktexturePos");t.enableVertexAttribArray(s),t.vertexAttribPointer(s,2,t.FLOAT,!1,0,0),this.masktexturePosBuffer=a}this.texturePosBuffer=n},p.prototype.initTextures=function(t){var e=this.contextGL,r=this.shaderProgram;e.pixelStorei(e.UNPACK_ALIGNMENT,1);var i=this.initTexture();this.yTextureRef=i,this.oyTextureRef=i;var n=this.initTexture();this.uTextureRef=n,this.ouTextureRef=n;var a=this.initTexture();if(this.vTextureRef=a,this.ovTextureRef=a,t){this.BindTextures(o.VIDEO_I420);var s=this.initTexture(),u=e.getUniformLocation(r,"cursorSampler");e.uniform1i(u,this.textureindex*this.texturestride+3),this.cursorTextureRef=s;var c=this.initTexture(),h=e.getUniformLocation(r,"waterMarkSampler");e.uniform1i(h,4),this.waterMarkTextureRef=c;var f=this.initTexture();this.repeatedWaterMarkTextureRef=f;var d=this.initTexture(),E=e.getUniformLocation(r,"previewVideoSampler");e.uniform1i(E,this.textureindex*this.texturestride+5),this.previewVideoTextureRef=d;var _=e.getUniformLocation(r,"cursorInfo");this.cursorInfoRef=_}if(this.initmask){e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,1);var l=this.initTexture(),T=e.getUniformLocation(r,"maskSampler");e.uniform1i(T,this.textureindex*this.texturestride+6),this.maskTextureRef=l}var R=e.getUniformLocation(r,"colorRange");this.colorRangeRef=R,this.onlyRGBARef=e.getUniformLocation(r,"onlyRGBA"),this.bgraModeRef=e.getUniformLocation(r,"bgraMode"),this.waterMarkFlagRef=e.getUniformLocation(r,"waterMarkFlag"),this.maskFlagRef=e.getUniformLocation(r,"maskFlag"),this.cursorFlagRef=e.getUniformLocation(r,"cursorFlag"),this.yuvmodeRef=e.getUniformLocation(r,"yuvmode")},p.prototype.BindTextures=function(t){var e=this.contextGL,r=this.shaderProgram;if(e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.activeTexture(e.TEXTURE0+0),e.bindTexture(e.TEXTURE_2D,this.yTextureRef),e.activeTexture(e.TEXTURE0+1),e.bindTexture(e.TEXTURE_2D,this.uTextureRef),e.activeTexture(e.TEXTURE0+2),e.bindTexture(e.TEXTURE_2D,this.vTextureRef),t==o.VIDEO_I420){var i=e.getUniformLocation(r,"ySampler");e.uniform1i(i,0);var n=e.getUniformLocation(r,"uSampler");e.uniform1i(n,1);var a=e.getUniformLocation(r,"vSampler");e.uniform1i(a,2)}else if(this.isRGBAMode(t)){var s=e.getUniformLocation(r,"previewVideoSampler");e.uniform1i(s,0);var u=e.getUniformLocation(r,"ySampler");e.uniform1i(u,0);var c=e.getUniformLocation(r,"uSampler");e.uniform1i(c,0);var h=e.getUniformLocation(r,"vSampler");e.uniform1i(h,0)}else if(t==o.VIDEO_NV12){var f=e.getUniformLocation(r,"ySampler");e.uniform1i(f,0);var d=e.getUniformLocation(r,"uSampler");e.uniform1i(d,1);var E=e.getUniformLocation(r,"vSampler");e.uniform1i(E,0)}var _=e.getUniformLocation(r,"previewVideoSampler");e.uniform1i(_,0);var l=e.getUniformLocation(r,"maskSampler");this.initmask?(e.activeTexture(e.TEXTURE0+6),e.bindTexture(e.TEXTURE_2D,this.maskTextureRef),e.uniform1i(l,6)):e.uniform1i(l,0);var T=e.getUniformLocation(r,"cursorSampler");e.uniform1i(T,0);var R=e.getUniformLocation(this.shaderProgram,"waterMarkSampler");e.uniform1i(R,0)},p.prototype.initTexture=function(){var t=this.contextGL,e=t.createTexture();return t.bindTexture(t.TEXTURE_2D,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.bindTexture(t.TEXTURE_2D,null),e},p.prototype.clearDisplay=function(){var t=this.contextGL;t&&(t.enable(t.BLEND),t.blendFunc(t.ZERO,t.ZERO)),this.render()},p.prototype.cleanup=function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];var r=this.canvasElement,i=T.get(r);i&&this.removeEventListener(r,i);var n=this.contextGL;n&&this.glInitSucceed&&(n.deleteProgram(this.program),n.activeTexture(n.TEXTURE0+this.textureindex*this.texturestride),n.bindTexture(n.TEXTURE_2D,null),n.activeTexture(n.TEXTURE1+this.textureindex*this.texturestride),n.bindTexture(n.TEXTURE_2D,null),n.activeTexture(n.TEXTURE2+this.textureindex*this.texturestride),n.bindTexture(n.TEXTURE_2D,null),this.textureindex||this.initmask||(n.activeTexture(n.TEXTURE3+this.textureindex*this.texturestride),n.bindTexture(n.TEXTURE_2D,null),n.activeTexture(n.TEXTURE4+this.textureindex*this.texturestride),n.bindTexture(n.TEXTURE_2D,null),n.activeTexture(this.getRepeatedWatermarkTextureValue(n)),n.bindTexture(n.TEXTURE_2D,null),n.activeTexture(n.TEXTURE5+this.textureindex*this.texturestride),n.bindTexture(n.TEXTURE_2D,null)),n.bindBuffer(n.ARRAY_BUFFER,null),n.deleteTexture(this.yTextureRef),n.deleteTexture(this.uTextureRef),n.deleteTexture(this.vTextureRef),this.textureindex||this.initmask||(n.deleteTexture(this.cursorTextureRef),n.deleteTexture(this.waterMarkTextureRef),n.deleteTexture(this.repeatedWaterMarkTextureRef),n.deleteTexture(this.previewVideoTextureRef),n.deleteBuffer(this.vertexPosBuffer),n.deleteBuffer(this.texturePosBuffer)),this.maskTextureRef&&n.deleteTexture(this.maskTextureRef),this.masktexturePosBuffer&&n.deleteBuffer(this.masktexturePosBuffer),this.glInitSucceed=0,e?this.loseContext():this.contextGL=null,n=null)},p.prototype.drawNextOutputPicture=function(t,e,r,i){var n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=this.contextGL;o?this.drawNextOutputPictureFrame(t,e,r,i,n):this.drawNextOuptutPictureRGBA(t,e,r,i)},p.prototype.updateVertexInfoForMultiView=function(t,e,r,i,n){var o,a,s,u,c=this.contextGL;if(this.isUseFillMode({width:r,height:i,rotation:n}))o=0,a=0,s=1,u=1;else{var h=n==this.ROTATION_CLOCK90||n==this.ROTATION_CLOCK270?i:r,f=n==this.ROTATION_CLOCK90||n==this.ROTATION_CLOCK270?r:i,d=h/f*e;d>t?(o=0,s=1,u=1-(a=(e-f/h*t)/2/e)):(a=0,u=1,s=1-(o=(t-d)/2/t))}o=2*o-1,s=2*s-1,a=1-2*a,u=1-2*u;var E=new Float32Array([s,a,o,a,s,u,o,u,1,1,-1,1,1,-1,-1,-1]);c.bindBuffer(c.ARRAY_BUFFER,this.vertexPosBuffer),c.bufferData(c.ARRAY_BUFFER,E,c.DYNAMIC_DRAW)},p.prototype.updateTextureInfoForMultiView=function(t,e,r,i,o,a,s){var u,c,h,f,d=this.contextGL;if(this.isUseFillMode({width:r.width,height:r.height,rotation:i})){var E=i==this.ROTATION_CLOCK90||i==this.ROTATION_CLOCK270?s/a:a/s,T=r.left||0,R=r.top||0;if(r.width/r.height>E){var p=r.height*E;u=R/e,c=(Math.round((r.width-p)/2)+T)/t,h=u+(r.height-1)/e,f=c+p/t}else{var m=r.width/E;h=(u=(Math.round((r.height-m)/2)+R)/e)+(m-1)/e,f=(c=T/t)+r.width/t}}else u=l(r.top/e,2),c=l(r.left/t,2),h=_((r.top+r.height-1)/e,2),f=_((r.width-1+r.left)/t,2);var x=[c,u,f,u,f,h,c,h];i==this.ROTATION_CLOCK90&&(x.unshift(x[6],x[7]),x=x.slice(0,8)),i==this.ROTATION_CLOCK180&&(x.unshift(x[4],x[5],x[6],x[7]),x=x.slice(0,8)),i==this.ROTATION_CLOCK270&&(x.unshift(x[6],x[7]),(x=x.slice(0,8))[0]=1-x[0],x[2]=1-x[2],x[4]=1-x[4],x[6]=1-x[6]);var v=x[0],g=x[1];x[0]=x[2],x[1]=x[3],x[2]=v,x[3]=g,o&&(x[0]=1-x[0],x[2]=1-x[2],x[4]=1-x[4],x[6]=1-x[6]);var I=new Float32Array([].concat(n()(x),[1,0,0,0,1,1,0,1]));d.bindBuffer(d.ARRAY_BUFFER,this.texturePosBuffer),d.bufferData(d.ARRAY_BUFFER,I,d.DYNAMIC_DRAW)},p.prototype.drawNextOutputPictureFrame=function(t,e,r,i,n){var a=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,u=this.contextGL;if(u&&this.glInitSucceed){this.texturePosBuffer;var c=this.yTextureRef,h=this.uTextureRef,f=this.vTextureRef;u.enable(u.BLEND),u.blendFunc(u.SRC_ALPHA,u.ONE_MINUS_SRC_ALPHA),n=n||this.ROTATION_CLOCK0;var d=(r=r||{top:0,left:0,width:t,height:e}).width!=this.croppingParams.width||r.height!=this.croppingParams.height,E=r.top!=this.croppingParams.top||r.left!=this.croppingParams.left,_=u.canvas.width!=this.canvasWidth||u.canvas.height!=this.canvasHeight,l=t!=this.textureWidth||e!=this.textureHeight,T=n!=this.picRotation;(d||_||T)&&m(this,r.width,r.height,n,s),(d||E||l||T)&&x(this,t,e,r,n);var R=a?0:1;R!=this.colorRange&&(u.uniform1i(this.colorRangeRef,R),this.colorRange=R),s?u.viewport(s.x,s.y,s.width,s.height):u.viewport(0,0,u.canvas.width,u.canvas.height),u.uniform1i(this.onlyRGBARef,0),u.uniform1i(this.yuvmodeRef,o.VIDEO_I420),Object.assign(this.croppingParams,r),this.textureWidth=t,this.textureHeight=e,this.picRotation=n,this.canvasWidth=u.canvas.width,this.canvasHeight=u.canvas.height,u.clearColor(this.bgColor[0],this.bgColor[1],this.bgColor[2],255),u.clear(u.COLOR_BUFFER_BIT);var p=i,v=t*e,g=p.subarray(0,v);u.activeTexture(u.TEXTURE0),u.bindTexture(u.TEXTURE_2D,c),u.texImage2D(u.TEXTURE_2D,0,u.LUMINANCE,t,e,0,u.LUMINANCE,u.UNSIGNED_BYTE,g);var I=t/2*e/2,A=p.subarray(v,v+I);u.activeTexture(u.TEXTURE1),u.bindTexture(u.TEXTURE_2D,h),u.texImage2D(u.TEXTURE_2D,0,u.LUMINANCE,t/2,e/2,0,u.LUMINANCE,u.UNSIGNED_BYTE,A);var O=I,D=p.subarray(v+I,v+I+O);u.activeTexture(u.TEXTURE2),u.bindTexture(u.TEXTURE_2D,f),u.texImage2D(u.TEXTURE_2D,0,u.LUMINANCE,t/2,e/2,0,u.LUMINANCE,u.UNSIGNED_BYTE,D),u.activeTexture(u.TEXTURE3),u.bindTexture(u.TEXTURE_2D,this.cursorTextureRef),this.hasCursor?u.uniform1i(this.cursorFlagRef,1):u.texImage2D(u.TEXTURE_2D,0,u.RGBA,1,1,0,u.RGBA,u.UNSIGNED_BYTE,this.dummpyCursor),u.uniform4f(this.cursorInfoRef,this.cx,this.cy,this.cw,this.ch),u.activeTexture(u.TEXTURE5),u.bindTexture(u.TEXTURE_2D,this.previewVideoTextureRef),u.texImage2D(u.TEXTURE_2D,0,u.RGBA,1,1,0,u.RGBA,u.UNSIGNED_BYTE,this.dummpyWaterMark);var y=u.getUniformLocation(this.shaderProgram,"maskSampler");u.uniform1i(y,5),this.render(),this.hasWholeFrame=1}},p.prototype.updateTextureBlock=function(t,e,r,i,n){var o=this.contextGL;if(o&&this.glInitSucceed){var a=n;if(!(!this.hasWholeFrame||t<=0||e<=0||r<0||i<0||r+t>this.textureWidth||i+e>this.textureHeight)&&n&&n.length==t*e*3/2){var s=this.yTextureRef,u=this.uTextureRef,c=this.vTextureRef,h=t*e,f=a.subarray(0,h);o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,s),o.texSubImage2D(o.TEXTURE_2D,0,r,i,t,e,o.LUMINANCE,o.UNSIGNED_BYTE,f);var d=t/2*e/2,E=a.subarray(h,h+d);o.activeTexture(o.TEXTURE1),o.bindTexture(o.TEXTURE_2D,u),o.texSubImage2D(o.TEXTURE_2D,0,r/2,i/2,t/2,e/2,o.LUMINANCE,o.UNSIGNED_BYTE,E);var _=d,l=a.subarray(h+d,h+d+_);o.activeTexture(o.TEXTURE2),o.bindTexture(o.TEXTURE_2D,c),o.texSubImage2D(o.TEXTURE_2D,0,r/2,i/2,t/2,e/2,o.LUMINANCE,o.UNSIGNED_BYTE,l)}}},p.prototype.updateCursor=function(t,e,r){var i=this.contextGL;i&&this.glInitSucceed&&(t<=0||e<=0||!r||r.length!=t*e*4||(i.activeTexture(i.TEXTURE3),i.bindTexture(i.TEXTURE_2D,this.cursorTextureRef),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,t,e,0,i.RGBA,i.UNSIGNED_BYTE,r),this.cursorWidth=t,this.cursorHeight=e,this.hasCursor=1))},p.prototype.updateWatermark=function(t,e,r){this.contextGL&&this.glInitSucceed&&(t<=0||e<=0||!r||r.length!=t*e*4||(this.watermarkData=r,this.watermarkWidth=t,this.watermarkHeight=e,this.hasWaterMark=1))},p.prototype.drawWatermark=function(){var t=this.contextGL;if(this.isSetWatermark()&&this.watermarkData&&this.watermarkWidth&&this.watermarkHeight){t.uniform1i(this.waterMarkFlagRef,1),this.isWatermarkRepeated()?(t.activeTexture(this.getRepeatedWatermarkTextureValue(t)),t.bindTexture(t.TEXTURE_2D,this.repeatedWaterMarkTextureRef)):(t.activeTexture(t.TEXTURE4),t.bindTexture(t.TEXTURE_2D,this.waterMarkTextureRef)),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.watermarkWidth,this.watermarkHeight,0,t.RGBA,t.UNSIGNED_BYTE,this.watermarkData);var e=t.getUniformLocation(this.shaderProgram,"waterMarkSampler");t.uniform1i(e,this.isWatermarkRepeated()?this.getRepeatedWatermarkUniformValue():4),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.drawArrays(t.TRIANGLE_STRIP,4,4)}},p.prototype.render=function(){var t=this.contextGL;t&&this.glInitSucceed&&(t.uniform1i(this.waterMarkFlagRef,0),t.drawArrays(t.TRIANGLE_STRIP,0,4),this.drawWatermark())},p.prototype.drawCursor=function(t,e,r,i,n){var o=this.contextGL;if(o&&this.glInitSucceed&&!(!this.hasWholeFrame||t&&(i<0||n<0))){o.viewport(0,0,o.canvas.width,o.canvas.height);var a=this.yTextureRef,s=this.uTextureRef,u=this.vTextureRef,c=this.cursorTextureRef;if(o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,a),o.activeTexture(o.TEXTURE1),o.bindTexture(o.TEXTURE_2D,s),o.activeTexture(o.TEXTURE2),o.bindTexture(o.TEXTURE_2D,u),o.activeTexture(o.TEXTURE3),o.bindTexture(o.TEXTURE_2D,c),t&&this.hasCursor){var h=e/this.croppingParams.width,f=r/this.croppingParams.height,d=i/this.croppingParams.width,E=n/this.croppingParams.height;this.cx=h,this.cy=f,this.cw=d,this.ch=E,o.uniform4f(this.cursorInfoRef,h,f,d,E)}else o.uniform4f(this.cursorInfoRef,0,0,0,0);this.render()}},p.prototype.clear=function(){this.hasWholeFrame=0,this.hasCursor=0},p.prototype.clearCanvas=function(t){var e=this.contextGL;e&&this.glInitSucceed&&(t?e.clearColor(t.R,t.G,t.B,t.A):e.clearColor(this.bgColor[0],this.bgColor[1],this.bgColor[2],255),e.clear(e.COLOR_BUFFER_BIT))},p.prototype.drawNextOuptutPictureRGBA=function(t,e,r,i){var n=i,o=this.canvasElement.getContext("2d"),a=o.getImageData(0,0,t,e);a.data.set(n),o.putImageData(a,0,0)},p.prototype.isRGBAMode=function(t){return-1!==[o.VIDEO_RGBA,o.VIDEO_BGRA].indexOf(t)},p.prototype.updateRemoteVideoTextures=function(t,e,r,i,n){var a=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],s=!(arguments.length>8&&void 0!==arguments[8])||arguments[8],u=this.contextGL;if(u&&this.glInitSucceed){var c=this.yTextureRef,h=this.uTextureRef,f=this.vTextureRef;u.enable(u.BLEND),u.blendFunc(u.SRC_ALPHA,u.ONE_MINUS_SRC_ALPHA);var d=this.isRGBAMode(this.videoMode);if(t<=0||e<=0||!i||!i.length||i.length!=t*e*3/2&&!d||r&&(r.top<0||r.left<0||r.left+r.width>t||r.top+r.height>e))return!1;var E=a?0:1;if(this.colorRange=E,this.rotation=n,Object.assign(this.croppingParams,r),this.textureWidth=t,this.textureHeight=e,this.canvasWidth=u.canvas.width,this.canvasHeight=u.canvas.height,s){if(u.bindTexture(u.TEXTURE_2D,c),!d){var _=i,l=t*e,T=_.subarray(0,l);u.texImage2D(u.TEXTURE_2D,0,u.LUMINANCE,t,e,0,u.LUMINANCE,u.UNSIGNED_BYTE,T);var R=0,p=0;this.videoMode==o.VIDEO_I420?p=R=t/2*e/2:this.videoMode==o.VIDEO_NV12&&(R=t*e/2,p=0);var m=_.subarray(l,l+R);if(u.bindTexture(u.TEXTURE_2D,h),p){u.texImage2D(u.TEXTURE_2D,0,u.LUMINANCE,t/2,e/2,0,u.LUMINANCE,u.UNSIGNED_BYTE,m);var x=_.subarray(l+R,l+R+p);u.bindTexture(u.TEXTURE_2D,f),u.texImage2D(u.TEXTURE_2D,0,u.LUMINANCE,t/2,e/2,0,u.LUMINANCE,u.UNSIGNED_BYTE,x)}else u.texImage2D(u.TEXTURE_2D,0,u.LUMINANCE_ALPHA,t/2,e/2,0,u.LUMINANCE_ALPHA,u.UNSIGNED_BYTE,m);return!0}u.texImage2D(u.TEXTURE_2D,0,u.RGBA,t,e,0,u.RGBA,u.UNSIGNED_BYTE,i)}}},p.prototype.updateRemoteVideoTexturesImageBitmap=function(t,e,r,i,n){var o=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],a=this.contextGL;if(a&&this.glInitSucceed){if(t<=0||e<=0||!r)return;if(this.textureWidth=t,this.textureHeight=e,Number.isNaN(n)||(this.rotation=n),Object.assign(this.croppingParams,i),!o)return;a.bindTexture(a.TEXTURE_2D,this.yTextureRef);var s=0,u=a.RGBA,c=a.RGBA,h=a.UNSIGNED_BYTE;a.texImage2D(a.TEXTURE_2D,s,u,c,h,r)}},p.prototype.updateSelfMaskImage=function(t,e,r){var i=this.contextGL;i&&this.glInitSucceed&&(t<=0||e<=0||!r||r.length!=t*e*4||(i.bindTexture(i.TEXTURE_2D,this.maskTextureRef),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,t,e,0,i.RGBA,i.UNSIGNED_BYTE,r)))},p.prototype.VideoFlip=function(){var t=this.contextGL;t&&this.glInitSucceed&&t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,1)},p.prototype.drawRemoteVideo=function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=this.contextGL;if(r&&this.glInitSucceed){var i=this.isRGBAMode(this.videoMode)?1:0;r.uniform1i(this.colorRangeRef,this.colorRange),this.setUniformFlag(i,this.hasCursor,this.videoMode),this.initmask&&r.uniform1i(this.maskFlagRef,1),this.updateTextureInfoForMultiView(this.textureWidth,this.textureHeight,this.croppingParams,this.rotation,e,t.width,t.height),r.viewport(t.x,t.y,t.width,t.height),this.updateVertexInfoForMultiView(t.width,t.height,this.croppingParams.width,this.croppingParams.height,this.rotation),this.BindTextures(this.videoMode),r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),this.render()}},p.prototype.readPixelsSyncRequest=function(t,e,r,i){var n,o=this.contextGL;return this.destination&&this.destination.length==r*i*4||(this.destination=new Uint8Array(r*i*4)),n=this.destination,o.flush(),o.readPixels(t,e,r,i,o.RGBA,o.UNSIGNED_BYTE,n),n},p.prototype.updateSelfVideoTextures=function(t,e,r,i){var n=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],o=this.contextGL;o&&this.glInitSucceed&&(t<=0||e<=0||!r||r.length%4!=0||(this.textureWidth=t,this.textureHeight=e,this.rotation=this.ROTATION_CLOCK0,Object.assign(this.croppingParams,i),n&&(o.bindTexture(o.TEXTURE_2D,this.yTextureRef),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,t,e,0,o.RGBA,o.UNSIGNED_BYTE,r))))},p.prototype.drawSelfVideo=function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=this.contextGL;i&&this.glInitSucceed&&(this.setUniformFlag(1,this.hasCursor,this.videoMode),this.updateTextureInfoForMultiView(this.textureWidth,this.textureHeight,this.croppingParams,this.rotation,r,t.width,t.height),i.viewport(t.x,t.y,t.width,t.height),e?(i.enable(i.BLEND),i.blendFunc(i.ZERO,i.ZERO),this.updateVertexInfoForMultiView(t.width,t.height,t.width,t.height,this.ROTATION_CLOCK0)):(i.enable(i.BLEND),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),this.updateVertexInfoForMultiView(t.width,t.height,this.croppingParams.width,this.croppingParams.height,this.rotation)),this.BindTextures(o.VIDEO_RGBA),this.render())},p.prototype.isSetWatermark=function(){return this.hasWaterMark},p.prototype.recoverTextures=function(){this.yTextureRef=this.oyTextureRef,this.uTextureRef=this.ouTextureRef,this.vTextureRef=this.ovTextureRef,this.videoMode=o.VIDEO_INVALID,this.reuse=!1},p.prototype.setWatermarkFlag=function(t){this.hasWaterMark=t,t||(this.setWatermarkRepeated(!1),this.setWatermarkOpacity(),this.setWatermarkPosition(16))},p.prototype.setUniformFlag=function(t,e,r){var i=this.contextGL;i&&(i.uniform1i(this.onlyRGBARef,t),i.uniform1i(this.bgraModeRef,t&&r===o.VIDEO_BGRA?1:0),i.uniform1i(this.cursorFlagRef,e),t||i.uniform1i(this.yuvmodeRef,r))},p.prototype.setVideoMode=function(t){this.videoMode=t},p.prototype.getVideoMode=function(t){return this.videoMode},p.prototype.setWatermarkRepeated=function(t){this.watermarkRepeated=t},p.prototype.isWatermarkRepeated=function(){return!!this.watermarkRepeated},p.prototype.setWatermarkOpacity=function(t){this.watermarkOpacity=t||.15},p.prototype.getWatermarkOpacity=function(){return this.watermarkOpacity},p.prototype.setWatermarkPosition=function(t){this.watermarkPosition=t||16},p.prototype.getWatermarkPosition=function(){return this.watermarkPosition},p.prototype.setMultiView=function(t){return this.isMultiView=t},p.prototype.getRepeatedWatermarkUniformValue=function(){return this.isMultiView?30:7},p.prototype.getRepeatedWatermarkTextureValue=function(t){return this.isMultiView?t.TEXTURE30:t.TEXTURE7},p.prototype.setFillMode=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.fillMode=t,this.fillModeForResolution=e},p.prototype.getFillMode=function(){return this.fillMode},p.prototype.getFillModeForResolution=function(){return this.fillModeForResolution},p.prototype.getTextureIndex=function(){return this.textureindex},p.prototype.getIndex=function(){return this.textureindex},p.prototype.getWatermarkWidth=function(){return this.watermarkWidth},p.prototype.getWatermarkHeight=function(){return this.watermarkHeight},p.prototype.getWatermarkOpacity=function(){return this.watermarkOpacity},p.prototype.getAttachedCanvas=function(){return this.canvasElement},p.prototype.resizeCanvasTo=function(t,e){this.contextGL.canvas.width=t,this.contextGL.canvas.height=e},p.prototype.isUseFillMode=function(t){var e=t.width,r=t.height,i=t.rotation;if(!this.fillMode)return!1;if(!this.fillModeForResolution)return!0;if(!e||!r)return!1;var n=i===this.ROTATION_CLOCK90||i==this.ROTATION_CLOCK270?r/e:e/r;return(Array.isArray(this.fillModeForResolution)?this.fillModeForResolution:[this.fillModeForResolution]).some((function(t){return Math.abs(n-t)<.01}))};e.default=p}]).default}));
//# sourceMappingURL=https://d1cdksi819e9z7.cloudfront.net/sourcemap/vb.min.js-abe035e29480a1f0d680.map