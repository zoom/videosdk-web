!function(e){var t={};function r(i){if(t[i])return t[i].exports;var a=t[i]={i:i,l:!1,exports:{}};return e[i].call(a.exports,a,a.exports,r),a.l=!0,a.exports}r.m=e,r.c=t,r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(i,a,function(t){return e[t]}.bind(null,a));return i},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=4)}([function(e,t,r){"use strict";const i=e=>0==(e&e-1);var a=new class{constructor(){this._highFrequencyLogs={}}setInstance(e){this._instance=e}getMessageFromErrorOrEvent(e,t){let r=e;return t instanceof ErrorEvent?(t.filename&&(r+=" File: ".concat(t.filename)),(t.lineno||t.colno)&&(r+=" Line: ".concat(t.lineno,":").concat(t.colno)),t.message&&(r+=" Message: ".concat(t.message)),t.error&&(r+="\nStack: ".concat(t.error.stack))):t instanceof Error?(t.fileName&&(r+=" File: ".concat(t.fileName)),(t.lineNumber||t.columnNumber)&&(r+=" Line: ".concat(t.lineNumber,":").concat(t.columnNumber)),t.message&&(r+=" Message: ".concat(t.message)),t.stack&&(r+=" Stack: ".concat(t.stack)),t.name&&(r+=" Name: ".concat(t.name)),t.constraint&&(r+=" Constraint: ".concat(t.constraint))):t instanceof CloseEvent?(t.code&&(r+=" Code: ".concat(t.code)),t.reason&&(r+=" Reason: ".concat(t.reason)),r+=" wasClean: ".concat(t.wasClean)):t instanceof DOMException?(t.message&&(r+=" Message: ".concat(t.message)),t.name&&(r+=" Name: ".concat(t.name))):r+=t?t.toString():"",r}error(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;e=this.getMessageFromErrorOrEvent(e,t),this._highFrequencyLogs[e]?this._highFrequencyLogs[e]+=1:this._highFrequencyLogs[e]=1;const r=i(this._highFrequencyLogs[e]);this._instance&&r&&this._instance.error(e)}severityerror(e,t){this._instance&&this._instance.error(JSON.stringify(e),t)}directReport(e,t){var r,i;this._instance&&(t||(t=["MEDIASDK_INFO"]),null===(r=(i=this._instance).directReport)||void 0===r||r.call(i,{msg:e},t))}warn(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;e=this.getMessageFromErrorOrEvent(e,t),this._instance&&this._instance.warn(e)}log(e){this._instance&&this._instance.log(e)}clearHighFrequencyLogs(){this._highFrequencyLogs={}}};function s(){return self.GROWABLE_HEAP_I8?self.GROWABLE_HEAP_I8():Module.HEAP8}r.d(t,"a",(function(){return s})),r.d(t,"b",(function(){return o})),r.d(t,"e",(function(){return h})),r.d(t,"c",(function(){return c})),r.d(t,"d",(function(){return d}));const n="undefined"!=typeof window;function o(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;n?a.error(e,t):u(e,t)}function u(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;var r,i,a,s;(t instanceof Error||t instanceof ErrorEvent)&&(e+=" Message: "+(null===(r=t)||void 0===r?void 0:r.message)+" Stack: "+(null!==(i=null===(a=t)||void 0===a||null===(a=a.error)||void 0===a?void 0:a.stack)&&void 0!==i?i:null===(s=t)||void 0===s?void 0:s.stack),t=null);postMessage({status:61,errorMessage:e,errorEvent:t})}function h(e){postMessage({status:61,errorMessage:e,level:"low"})}function c(e){postMessage({status:35,data:e})}const l=["","MOZ_","OP_","WEBKIT_"];function d(e,t){for(var r=0;r<l.length;++r){var i=l[r]+t,a=e.getExtension(i);if(a)return a}}new Map,new class{constructor(){this.ssrcInfoMap=new Map,this.timer=null}updateSSRCInfo(e,t){this.ssrcInfoMap.has(e)||this.ssrcInfoMap.set(e,{firstTime:0,lastTime:0,frames:0,fps:0}),this._calculateFPS(e,t),this._removeZeroFPS()}_calculateFPS(e,t){const r=this.ssrcInfoMap.get(e);if(0===r.frames?r.firstTime=t:r.lastTime=t,r.frames+=1,r.frames>2&&r.frames%5==0&&r.lastTime-r.firstTime>=1e3){const t=Math.floor(1e3/((r.lastTime-r.firstTime)/(r.frames-1)));r.fps!==t&&(this._notifyFPS(e,t),r.fps=t),r.firstTime=r.lastTime,r.frames=1}}_removeZeroFPS(){let e=Date.now();this.ssrcInfoMap.forEach((t,r)=>{const i=this.ssrcInfoMap.get(r);i&&e-i.lastTime>2e3&&(this.ssrcInfoMap.delete(r),this._notifyFPS(r,0))})}_notifyFPS(e,t){postMessage({status:66.6,data:{ssrc:e,fps:t}})}_checkIfNewFrameComing(){this.timer&&(clearTimeout(this.timer),this.timer=null),this.timer=setTimeout(()=>{this._removeZeroFPS(),this.timer=null},2500)}}},function(e,t,r){"use strict";r.r(t),r.d(t,"QOS_DEFAULT_POLLING_INTERVAL",(function(){return i})),r.d(t,"VIDEO_MONITOR_LOG_SECOENDS",(function(){return a})),r.d(t,"THREAD_STATE_IDLE",(function(){return s})),r.d(t,"THREAD_STATE_CREATING",(function(){return n})),r.d(t,"THREAD_STATE_CREATED",(function(){return o})),r.d(t,"MEDIA_S2C_KEEPALIVE",(function(){return u})),r.d(t,"MEDIA_AUDIO_DATA",(function(){return h})),r.d(t,"MEDIA_AUDIO_RTCP",(function(){return c})),r.d(t,"MEDIA_AUDIO_FEATURE",(function(){return l})),r.d(t,"MEDIA_VIDEO_DATA",(function(){return d})),r.d(t,"MEDIA_VIDEO_RTCP",(function(){return f})),r.d(t,"MEDIA_NTP_UPDATE",(function(){return E})),r.d(t,"VIDEO_CAPTURER_RESOLUTION_360P",(function(){return _})),r.d(t,"VIDEO_CAPTURER_RESOLUTION_720P",(function(){return m})),r.d(t,"VIDEO_CAPTURER_RESOLUTION_1080P",(function(){return T})),r.d(t,"UPDATE_ENCRYPTION_GCM_MODEL_KEY",(function(){return p})),r.d(t,"MEDIA_AUDIO_QOS_SESS_DATA",(function(){return R})),r.d(t,"INTERPRETATION_ENABLE",(function(){return v})),r.d(t,"INTERPRETATION_SET_LANG",(function(){return g})),r.d(t,"INTERPRETATION_MUTE",(function(){return A})),r.d(t,"INTERPRETATION_SET_INTERPRETER",(function(){return x})),r.d(t,"serverHeartbeatMaxTimeoutSeconds",(function(){return b})),r.d(t,"RQUEST_ANIMATION_MODE",(function(){return O})),r.d(t,"SET_INTERVAL_MODE",(function(){return y})),r.d(t,"VIDEO_INVALID",(function(){return D})),r.d(t,"VIDEO_RGBA",(function(){return I})),r.d(t,"VIDEO_I420",(function(){return M})),r.d(t,"VIDEO_NV12",(function(){return L})),r.d(t,"VIDEO_BGRA",(function(){return w})),r.d(t,"EVENT_ROLLBACK_BUFFER",(function(){return N})),r.d(t,"EVENT_NEEDMORE_DATA",(function(){return S})),r.d(t,"EVENT_CAPTURE_DATA",(function(){return C})),r.d(t,"EVENT_CACHE_SIZE",(function(){return U})),r.d(t,"WEBCODEC_ENCODE_OFF",(function(){return B})),r.d(t,"WEBCODEC_DECODE_OFF",(function(){return F})),r.d(t,"QosSession",(function(){return P})),r.d(t,"QosConnectType",(function(){return V})),r.d(t,"MAX_VIDEO_CAPTURE_FPS",(function(){return G})),r.d(t,"MIN_VIDEO_CAPTURE_FPS",(function(){return k})),r.d(t,"VIDEO_CAPTURE_FPS",(function(){return W})),r.d(t,"VIDEO_CAPTURE_20FPS",(function(){return H})),r.d(t,"DOWN_VIDEO_CAPTURE_FPS",(function(){return X})),r.d(t,"LOWER_VIDEO_CAPTURE_FPS",(function(){return Y})),r.d(t,"VIDEO_DATA_MAX_SIZE",(function(){return K})),r.d(t,"VIDEO_FRAME_BUFFER_SIZE",(function(){return j})),r.d(t,"SHARING_NULL",(function(){return q})),r.d(t,"SHARING_NORMAL",(function(){return z})),r.d(t,"SHARING_VIDEO_MODE",(function(){return Z})),r.d(t,"SHARING_VIDEO_MODE_CAPTURED_FPS",(function(){return Q})),r.d(t,"SHARING_NORMAL_MODE_CAPTURED_FPS",(function(){return J})),r.d(t,"VIDEO_RINGBUF_PKG_NUM",(function(){return $})),r.d(t,"ADDITIONNAL_MULTITHREAD_NUMBER_ENCODE_FOR_360P",(function(){return ee})),r.d(t,"ADDITIONNAL_MULTITHREAD_NUMBER_ENCODE_FOR_720P",(function(){return te})),r.d(t,"ADDITIONNAL_MULTITHREAD_NUMBER_ENCODE_FOR_1080p",(function(){return re})),r.d(t,"WCL_PLATFORM_TYPE",(function(){return ie})),r.d(t,"AS_CAPTURE_SOURCE",(function(){return ae})),r.d(t,"MEDIA_COMMAND",(function(){return se})),r.d(t,"RENDER_UNSET",(function(){return ne})),r.d(t,"RENDER_IN_WORKER",(function(){return oe})),r.d(t,"RENDER_IN_MAIN",(function(){return ue})),r.d(t,"WEBRTC_NO_AUDIO_MODE",(function(){return he})),r.d(t,"WEBRTC_COMMPUTER_AUDIO_MODE",(function(){return ce})),r.d(t,"WEBRTC_SHARE_AUDIO_MODE",(function(){return le})),r.d(t,"WEBRTC_MULTI_AUDIO_MODE",(function(){return de})),r.d(t,"VIDEO_FRAME",(function(){return fe})),r.d(t,"SHARING_FRAME",(function(){return Ee})),r.d(t,"MAX_RENDER_WITHOUT_SAB",(function(){return _e})),r.d(t,"ACTIVE_SPEAKER_SSRC",(function(){return me})),r.d(t,"FACE_MODE_UNKNOW",(function(){return Te})),r.d(t,"FACE_MODE_USER",(function(){return pe})),r.d(t,"FACE_MODE_ENVIRONMENT",(function(){return Re})),r.d(t,"ORIGINAL_SOUND_OFF",(function(){return ve})),r.d(t,"ORIGINAL_SOUND_ON",(function(){return ge})),r.d(t,"ORIGINAL_SOUND_STEREO",(function(){return Ae})),r.d(t,"ORIGINAL_SOUND_HIGHFIDELITY",(function(){return xe})),r.d(t,"ORIGINAL_SOUND_HIGHFIDELITY_STEREO",(function(){return be})),r.d(t,"SHARE_AUDIO",(function(){return Oe})),r.d(t,"ORIGINAL_SOUND_OFF_HIGH_BITRATE",(function(){return ye})),r.d(t,"PUBLISHER_ICEConnectionState_Failed",(function(){return De})),r.d(t,"SUBSCRIBER_ICEConnectionState_Failed",(function(){return Ie})),r.d(t,"NO_MESSAGE_FAILOVER",(function(){return Me})),r.d(t,"WS_ERROR_FAILOVER",(function(){return Le})),r.d(t,"WS_CLOSE_FAILOVER",(function(){return we})),r.d(t,"VB_CONSTANT",(function(){return Ne})),r.d(t,"AUDIO_ENCODE_WORKER",(function(){return Se})),r.d(t,"AUDIO_DECODE_WORKER",(function(){return Ce})),r.d(t,"AUDIO_WASM_WORKLET",(function(){return Ue})),r.d(t,"AUDIO_WEBRTC_WORKLET",(function(){return Be})),r.d(t,"DATACHANNEL_MONITOR_SEPARATOR",(function(){return Fe})),r.d(t,"LOADEDMETADATAT_IMEOUT",(function(){return Pe})),r.d(t,"MEDIA_SOLUTION_WEBRTC",(function(){return Ve})),r.d(t,"MEDIA_SOLUTION_WASM",(function(){return Ge})),r.d(t,"AudioProfile",(function(){return ke}));const i=1e3,a=5,s=43,n=44,o=45,u=0,h=1,c=6,l=146,d=2,f=7,E=9,_=10,m=11,T=12,p=102,R=107,v=0,g=1,A=2,x=3,b=65,O=0,y=1,D=-1,I=0,M=1,L=2,w=3,N=0,S=1,C=2,U=3,B=1,F=2,P={SESSION_TYPE_CONF:0,SESSION_TYPE_AUDIO:1,SESSION_TYPE_DESKSHARE:2,SESSION_TYPE_VIDEO:3,SESSION_TYPE_CHAT:4,SESSION_TYPE_TELEPHONE:5,SESSION_TYPE_ZC_PING:6,SESSION_TYPE_TOTAL_CNT:7},V={CONNECT_TYPE_UDP:0,CONNECT_TYPE_TCP:1},G=30,k=1,W=24,H=20,X=15,Y=10,K=8294400,j=5,q=0,z=1,Z=2,Q=15,J=5,$=400,ee=3,te=7,re=8,ie={DESKTOP:0,MOBILE:1,ANDROID:2,IPHONE:3},ae={DESKTOP_SOURCE:0,UAC_SOURCE:1},se={SHARE_REMOTE_CONTROL_UAC_MOUSE:144,SHARE_REMOTE_CONTROL_UAC_JPEG_FRAME:145},ne=-1,oe=0,ue=1,he=0,ce=1,le=2,de=ce+le,fe=0,Ee=1,_e=25,me=1,Te=-1,pe=0,Re=1,ve=0,ge=1,Ae=2|ge,xe=4|ge,be=Ae|xe,Oe=8,ye=16,De=3,Ie=107,Me="100",Le="101",we="102",Ne="WCL_M,isWebEnabled:1, isLocalEnabled:1, isSmartBkgnd:1, bkgType:2",Se=0,Ce=1,Ue=2,Be=3,Fe="{[WLCCONT]}",Pe=1e4,Ve=1,Ge=2,ke={[ve]:new Map([["useinbandfec",{value:1,operater:"add"}],["maxaveragebitrate",{value:48e3,operater:"add"}],["maxplaybackrate",{value:24e3,operater:"add"}],["sprop-maxcapturerate",{value:24e3,operater:"add"}],["sprop-stereo",{value:1,operater:"sub"}],["stereo",{value:1,operater:"sub"}]]),[ge]:new Map([["useinbandfec",{value:1,operater:"sub"}],["maxaveragebitrate",{value:96e3,operater:"add"}],["maxplaybackrate",{value:48e3,operater:"add"}],["sprop-maxcapturerate",{value:48e3,operater:"add"}],["sprop-stereo",{value:1,operater:"add"}],["stereo",{value:1,operater:"add"}]]),[Ae]:new Map([["useinbandfec",{value:1,operater:"sub"}],["maxaveragebitrate",{value:96e3,operater:"add"}],["maxplaybackrate",{value:48e3,operater:"add"}],["sprop-maxcapturerate",{value:48e3,operater:"add"}],["sprop-stereo",{value:1,operater:"add"}],["stereo",{value:1,operater:"add"}]]),[xe]:new Map([["useinbandfec",{value:1,operater:"sub"}],["maxaveragebitrate",{value:128e3,operater:"add"}],["maxplaybackrate",{value:48e3,operater:"add"}],["sprop-maxcapturerate",{value:48e3,operater:"add"}],["sprop-stereo",{value:1,operater:"add"}],["stereo",{value:1,operater:"add"}]]),[be]:new Map([["useinbandfec",{value:1,operater:"sub"}],["maxaveragebitrate",{value:128e3,operater:"add"}],["maxplaybackrate",{value:48e3,operater:"add"}],["sprop-maxcapturerate",{value:48e3,operater:"add"}],["sprop-stereo",{value:1,operater:"add"}],["stereo",{value:1,operater:"add"}]]),[Oe]:new Map([["useinbandfec",{value:1,operater:"sub"}],["maxaveragebitrate",{value:"96000",operater:"add"}],["maxplaybackrate",{value:"48000",operater:"add"}],["sprop-maxcapturerate",{value:"48000",operater:"add"}]]),[ye]:new Map([["useinbandfec",{value:1,operater:"add"}],["maxaveragebitrate",{value:64e3,operater:"add"}],["maxplaybackrate",{value:24e3,operater:"add"}],["sprop-maxcapturerate",{value:24e3,operater:"add"}],["sprop-stereo",{value:1,operater:"sub"}],["stereo",{value:1,operater:"sub"}]])}},function(e,t){function r(t){return e.exports=r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e.exports.__esModule=!0,e.exports.default=e.exports,r(t)}e.exports=r,e.exports.__esModule=!0,e.exports.default=e.exports},function(e,t,r){var i=r(7);e.exports=function(e,t,r){return(t=i(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e},e.exports.__esModule=!0,e.exports.default=e.exports},function(e,t,r){"use strict";var i=this&&this.__awaiter||function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function n(e){try{u(i.next(e))}catch(e){s(e)}}function o(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(n,o)}u((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=r(5),n=a(r(6)),o=a(r(9));function u(e){self.postMessage({cmd:s.VB_EVENT_TYPE.VB_WORKER_ERROR,payload:e.error||e.reason})}self.addEventListener("error",u),self.addEventListener("unhandledrejection",u);const h=new class{constructor(){this.vbRender=null,this.frameRate=24,this.frameReader=null,this.videoStream=null,this.requestTimer=null,this.isVBEnabled=!0,this.isStreamEnabled=!1,this.vbWritableStream=null,this.vbFrameWriter=null,this.streamRender=null,this.manualFreeMemory=!1,this.isWaitingFirstFrame=!1,this.fps=0,this.prevFps=0,this.fpsTimer=null,this.handleMessage=this.handleMessage.bind(this),this.requestFrame=this.requestFrame.bind(this),this.updateFps=this.updateFps.bind(this),this.handleUnsupportedFrame=this.handleUnsupportedFrame.bind(this)}updateFps(){this.prevFps!==this.fps&&(this.postMessage({cmd:s.VB_EVENT_TYPE.VB_UPDATE_FPS,payload:this.fps}),this.prevFps=this.fps),this.fps=0}postMessage(e){self.postMessage(e)}start(){this.fpsTimer&&(clearInterval(this.fpsTimer),this.fps=0),this.requestTimer&&(this.videoStream?clearTimeout(this.requestTimer):clearInterval(this.requestTimer)),this.videoStream&&!this.frameReader&&(this.frameReader=this.videoStream.getReader()),this.requestFrame(),this.fpsTimer=setInterval(this.updateFps,1e3)}stop(e){clearInterval(this.fpsTimer),this.fps=0,this.updateFps(),this.prevFps=0,this.frameReader?(this.frameReader.releaseLock(),this.frameReader=null,clearTimeout(this.requestTimer)):(clearInterval(this.requestTimer),this.requestTimer=null),e&&this.videoStream&&(this.videoStream.cancel(),this.videoStream=null)}requestFrame(){this.frameReader?this.frameReader.read().then(({value:e,done:t})=>{if(t)clearTimeout(this.requestTimer),this.requestTimer=null;else{const{timestamp:t,displayWidth:r,displayHeight:i}=e;this.frameTimestamp=t,this.frameDisplayHeight=i,this.frameDisplayWidth=r,this.sendFrame(e),this.requestTimer=setTimeout(this.requestFrame,1e3/this.frameRate-4)}}).catch(()=>{clearTimeout(this.requestTimer),this.requestTimer=null}):this.requestTimer=setInterval(()=>{this.postMessage({cmd:s.VB_EVENT_TYPE.VB_REQUEST_FRAME})},1e3/this.frameRate-4)}handleUnsupportedFrame(e=""){this.postMessage({cmd:s.VB_EVENT_TYPE.VB_VIDEO_FORMAT_UNSUPPORTED,payload:e})}sendFrame(e){var t;this.isVBEnabled?this.vb.generateVBFrame(e):(null===(t=this.vbRender)||void 0===t||t.render(e),this.writeVBFrameToStream(e))}writeVBFrameToStream(e){if(this.isStreamEnabled)if(this.vbFrameWriter){let t;if("format"in e)t=e;else if("data_ptr"in e){const{format_width:r,format_height:i,valid_x:a,valid_y:s,valid_width:n,valid_height:o,data:u}=e;t=new VideoFrame(u,{format:"I420",timestamp:this.frameTimestamp,codedWidth:r,codedHeight:i,visibleRect:{x:a,y:s,width:n,height:o},displayHeight:this.frameDisplayHeight,displayWidth:this.frameDisplayWidth})}t&&(this.vbFrameWriter.write(t),t.close())}else this.streamRender&&this.streamRender.render(e)}handleMessage(e){var t,r,a;return i(this,void 0,void 0,(function*(){const{cmd:i}=e.data;switch(i){case s.VB_EVENT_TYPE.VB_SEND_FRAME:{const t=e.data.payload;this.sendFrame(t);break}case s.VB_EVENT_TYPE.VB_UPDATE_BG:{const t=e.data.payload;"blur"===t?this.vb.blur():this.vb.setBackgroundImage(t);break}case s.VB_EVENT_TYPE.VB_FREE_MEMORY:this.vb.free(e.data.payload);break;case s.VB_EVENT_TYPE.VB_WORKER_INIT:{const t=e.data.payload;this.manualFreeMemory=t.needFrame||!1,this.vb=new n.default,this.vb.onModelReady=()=>{this.postMessage({cmd:s.VB_EVENT_TYPE.VB_MODEL_READY})},this.vb.onPredictDone=()=>{this.postMessage({cmd:s.VB_EVENT_TYPE.VB_PREDICT_DONE,payload:this.vb.backend})},this.vb.onUnsupportedFrame=this.handleUnsupportedFrame,this.vb.onVBFrame=e=>{this.fps++,this.writeVBFrameToStream(e),this.vbRender&&this.vbRender.render(e),this.vb.manualFreeMemory&&this.postMessage({cmd:s.VB_EVENT_TYPE.VB_GENERATED_FRAME,payload:e}),this.isWaitingFirstFrame&&(this.isWaitingFirstFrame=!1,this.postMessage({cmd:s.VB_EVENT_TYPE.VB_GENERATE_FIRST_FRAME}))},this.vb.manualFreeMemory=this.manualFreeMemory;try{yield this.vb.initialize(t),self.postMessage({cmd:s.VB_EVENT_TYPE.VB_INIT_SUCCESS})}catch(e){this.postMessage({cmd:s.VB_EVENT_TYPE.VB_INIT_FAILED,payload:e})}break}case s.VB_EVENT_TYPE.VB_RENDER_CANVAS:{const t=e.data.payload;this.vbRender=new o.default(t,"VB_MODULE_CANVAS"),this.vbRender.onUnsupportedFrame=this.handleUnsupportedFrame;break}case s.VB_EVENT_TYPE.VB_RENDER_FRAME:{const r=e.data.payload;null===(t=this.vbRender)||void 0===t||t.render(r);break}case s.VB_EVENT_TYPE.VB_START:{const{videoStream:t,frameRate:r}=e.data.payload||{};this.frameRate=r||this.frameRate,t&&(this.videoStream=t),this.start(),this.isWaitingFirstFrame=!0;break}case s.VB_EVENT_TYPE.VB_TOGGLE_VB:this.isVBEnabled=e.data.payload;break;case s.VB_EVENT_TYPE.VB_STOP:this.stop(e.data.payload),this.isWaitingFirstFrame=!1;break;case s.VB_EVENT_TYPE.VB_MIRROR:null===(r=this.vbRender)||void 0===r||r.setMirror(e.data.payload);break;case s.VB_EVENT_TYPE.VB_GENERATE_STREAM:{const t=e.data.payload;t?"getWriter"in t?(this.vbWritableStream=t,this.vbFrameWriter=this.vbWritableStream.getWriter()):this.streamRender=new o.default(t,"VB_STREAM_CANVAS_IN_WORKER"):this.vb.manualFreeMemory=!0,this.isStreamEnabled=!0;break}case s.VB_EVENT_TYPE.VB_CHANGE_STREAM_CANVAS_SIZE:{const{width:t,height:r}=e.data.payload;null===(a=this.streamRender)||void 0===a||a.updateSize(t,r);break}case s.VB_EVENT_TYPE.VB_STOP_STREAM:this.isStreamEnabled=!1,this.manualFreeMemory||(this.vb.manualFreeMemory=!1);break;case s.VB_EVENT_TYPE.VB_UPDATE_NEED_FRAME:{const{payload:t}=e.data;this.manualFreeMemory=t,(t||!this.isStreamEnabled||this.vbWritableStream||this.streamRender)&&(this.vb.manualFreeMemory=t);break}case s.VB_EVENT_TYPE.VB_UPDATE_FRAME_RATE:this.frameRate=e.data.payload,this.start();break;default:console.warn("unrecognize")}}))}};self.addEventListener("message",h.handleMessage)},function(e,t,r){"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.VB_EVENT_TYPE=void 0,function(e){e.VB_INIT_SUCCESS="VB_INIT_SUCCESS",e.VB_INIT_FAILED="VB_INIT_FAILED",e.VB_GENERATED_FRAME="VB_GENERATED_FRAME",e.VB_SEND_FRAME="VB_SEND_FRAME",e.VB_UPDATE_BG="VB_UPDATE_BG",e.VB_PREDICT_DONE="VB_PREDICT_DONE",e.VB_MODEL_READY="VB_MODEL_READY",e.VB_FREE_MEMORY="VB_FREE_MEMORY",e.VB_VIDEO_FORMAT_UNSUPPORTED="VB_VIDEO_FORMAT_UNSUPPORTED",e.VB_WORKER_INIT="VB_WORKER_INIT",e.VB_WORKER_ERROR="VB_WORKER_ERROR",e.VB_RENDER_CANVAS="VB_RENDER_CANVAS",e.VB_RENDER_FRAME="VB_RENDER_FRAME",e.VB_START="VB_START",e.VB_REQUEST_FRAME="VB_REQUEST_FRAME",e.VB_TOGGLE_VB="VB_TOGGLE_VB",e.VB_STOP="VB_STOP",e.VB_MIRROR="VB_MIRROR",e.VB_GENERATE_STREAM="VB_GENERATE_STREAM",e.VB_STOP_STREAM="VB_STOP_STREAM",e.VB_CHANGE_STREAM_CANVAS_SIZE="VB_CHANGE_STREAM_CANVAS_SIZE",e.VB_GENERATE_FIRST_FRAME="VB_GENERATE_FIRST_FRAME",e.VB_UPDATE_FPS="VB_UPDATE_FPS",e.VB_UPDATE_NEED_FRAME="VB_UPDATE_NEED_FRAME",e.VB_UPDATE_FRAME_RATE="VB_UPDATE_FRAME_RATE"}(i||(t.VB_EVENT_TYPE=i={}))},function(e,t,r){"use strict";var i=this&&this.__awaiter||function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function n(e){try{u(i.next(e))}catch(e){s(e)}}function o(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(n,o)}u((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});r(11);self.LimitWebCodecsEncoderTo360_js=()=>!1,self.LimitWebCodecsDecoderTo360_js=()=>!1,self.hardcodecpunumber=()=>navigator.hardwareConcurrency||1,self.IsSupportMultiThread=()=>0,self.js_info_from_wcl_video_data=(e,t,r,i,a,s)=>{Module._free(t)},self.GetLogLevel_js=()=>0;t.default=class{constructor(){this.isSABEnable=!!self.SharedArrayBuffer,this.afnModelArtifacts={},this.afnIOHandle={},this.baseModelArtifacts={},this.baseIOHandle={},this.modelLoadedCount=0,this.manualFreeMemory=!1,this.backend="",this.afnIOHandle.load=()=>this.afnModelArtifacts,this.afnIOHandle.save=()=>{},this.baseIOHandle.load=()=>this.baseModelArtifacts,this.baseIOHandle.save=()=>{},this.vbFrameCallback=this.vbFrameCallback.bind(this),this.executeBase=this.executeBase.bind(this),this.executeAfn=this.executeAfn.bind(this)}GET_HEAP_U8(){return self.GROWABLE_HEAP_U8?self.GROWABLE_HEAP_U8():Module.HEAPU8}GET_HEAD_F32(){return self.GROWABLE_HEAP_F32?self.GROWABLE_HEAP_F32():Module.HEAPF32}vbFrameCallback(e,t,r,i,a,s,n,o,u,h){const c={data:this.GET_HEAP_U8().subarray(t+0,t+r),data_ptr:this.isSABEnable?t:null,len_of_data:r,format_width:i,format_height:a,valid_x:s,valid_y:n,valid_width:o,valid_height:u,yuv_limited:h};this.onVBFrame&&this.onVBFrame(c),this.isSABEnable&&this.manualFreeMemory||Module._free(t)}executeBase(e,t,r,i){return tf.tidy(()=>{var a=new Float32Array(wasmMemory.buffer,e,t),s=tf.tensor4d(a,[1,144,256,3],"float32"),n=this.baseModel.predict(s);1==n[1].size?(this.mask=Float32Array.from(n[0].as1D(36864).arraySync()),this.prob=Float32Array.from(n[1].as1D(1).arraySync())):(this.mask=Float32Array.from(n[1].as1D(36864).arraySync()),this.prob=Float32Array.from(n[0].as1D(1).arraySync()));let o=new Float32Array(wasmMemory.buffer);o.set(this.mask,r>>2),o.set(this.prob,i>>2)}),0}executeAfn(e,t,r,i,a){return tf.tidy(()=>{var s=new Float32Array(wasmMemory.buffer,e,i),n=new Float32Array(wasmMemory.buffer,t,i),o=new Float32Array(wasmMemory.buffer,r,i/3),u=tf.tensor4d(s,[1,144,256,3],"float32"),h=tf.tensor4d(n,[1,144,256,3],"float32"),c=tf.tensor4d(o,[1,144,256,1],"float32"),l=this.afnModel.predict([u,h,c]);this.mask=Float32Array.from(l.as1D(36864).arraySync()),this.GET_HEAD_F32().set(this.mask,a>>2)}),0}getResourceUrl(e){return{tfJsUrl:e+"/vb-resource/tf.min.js",modelUrl:e+"/vb-resource/dualModel.bin",wasmGlueCodeUrl:this.isSABEnable?e+"/video.mtsimd.js":e+"/video.simd.js",wasmUrl:this.isSABEnable?e+"/video.mtsimd.wasm":e+"/video.simd.wasm",wasmBackendUrl:e+"/vb-resource/tf-backend-wasm.min.js"}}decryptData(e,t,r){return self.crypto.subtle.decrypt({name:"AES-GCM",iv:r},t,e)}modelLoadReady(){this.modelLoadedCount++,2===this.modelLoadedCount&&this.onModelReady&&this.onModelReady()}loadWasm(e,t){return self.Module={locateFile:()=>t},importScripts(e),new Promise((e,t)=>{Module.onRuntimeInitialized=()=>{this.create_vb_no_sab_thread=Module.cwrap("_create_vb_no_sab_thread","number",[]),this.signal_vb_thread_bg=Module.cwrap("_signal_vb_thread_bg","number",["number","number","number","number"]),this.signal_vb_thread_blur=Module.cwrap("_signal_vb_thread_blur","number",["number","number"]),this.signal_vb_thread_video_yuv=Module.cwrap("_signal_vb_thread_video_yuv","number",["number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number"]),this.signal_vb_thread_video_rgba=Module.cwrap("_signal_vb_thread_video_rgba","number",["number","number","number","number","number","number","number","number"]),e()},Module.onAbort=()=>{t("wasm initialize failed")}})}initTF(e,t,r,a,s){return i(this,void 0,void 0,(function*(){let i=!1,n=!1,o=null;importScripts(e);try{i=yield tf.setBackend("webgl")}catch(e){o=e}if(!i&&r){if(!a||!s)return Promise.reject("No webAssembly backend resource provided");importScripts(a),tf.wasm.setWasmPaths(s+"/vb-resource/");try{n=yield tf.setBackend("wasm")}catch(e){o=e}}return i||n?(this.backend=tf.getBackend(),this.initializeAiModel(t)):Promise.reject(o)}))}initializeAiModel(e){return i(this,void 0,void 0,(function*(){if("string"==typeof e){const t=yield fetch(e);if(!t.ok){const{url:e,status:r}=t;throw new Error(`Fetch model file failed. url: ${e}, status: ${r}`)}e=yield t.arrayBuffer()}yield this.DecryptDualModel(e),this.onPredictDone&&this.onPredictDone()}))}initializeAfnModel(e,t){return i(this,void 0,void 0,(function*(){var r=JSON.parse(t);if(this.afnModelArtifacts.modelTopology=r.modelTopology,this.afnModelArtifacts.format=r.format,this.afnModelArtifacts.generatedBy=r.generatedBy,this.afnModelArtifacts.convertedBy=r.convertedBy,r.weightsManifest)for(var i=0;i<r.weightsManifest.length;i++)this.afnModelArtifacts.weightSpecs=r.weightsManifest[i].weights;r.trainingConfig&&(this.afnModelArtifacts.trainingConfig=r.trainingConfig),r.userDefinedMetadata&&(this.afnModelArtifacts.userDefinedMetadata=r.userDefinedMetadata),this.afnModelArtifacts.weightData=e,this.afnModel=yield tf.loadGraphModel(this.afnIOHandle),this.modelLoadReady();var a=new Float32Array(110592),s=new Float32Array(110592),n=new Float32Array(36864),o=tf.tensor4d(a,[1,144,256,3],"float32"),u=tf.tensor4d(s,[1,144,256,3],"float32"),h=tf.tensor4d(n,[1,144,256,1],"float32");this.afnModel.predict([o,u,h])}))}initializeBaseModel(e,t){return i(this,void 0,void 0,(function*(){var r=JSON.parse(t);if(this.baseModelArtifacts.modelTopology=r.modelTopology,this.baseModelArtifacts.format=r.format,this.baseModelArtifacts.generatedBy=r.generatedBy,this.baseModelArtifacts.convertedBy=r.convertedBy,r.weightsManifest)for(var i=0;i<r.weightsManifest.length;i++)this.baseModelArtifacts.weightSpecs=r.weightsManifest[i].weights;r.trainingConfig&&(this.baseModelArtifacts.trainingConfig=r.trainingConfig),r.userDefinedMetadata&&(this.baseModelArtifacts.userDefinedMetadata=r.userDefinedMetadata),this.baseModelArtifacts.weightData=e,this.baseModel=yield tf.loadGraphModel(this.baseIOHandle),this.modelLoadReady();var a=new Float32Array(110592),s=tf.tensor4d(a,[1,144,256,3],"float32");this.baseModel.predict(s)}))}DecryptDualModel(e){return i(this,void 0,void 0,(function*(){let t=new Uint8Array(e,0,12),r=new Uint8Array(e,12,32);const a=yield self.crypto.subtle.importKey("raw",r,"AES-GCM",!0,["encrypt","decrypt"]);let s=t.length+r.length,n=new Uint32Array(e.slice(s,s+4))[0];s+=4;let o=e.slice(s,s+n);s+=n,n=new Uint32Array(e.slice(s,s+4))[0],s+=4;let u=new Uint8Array(e,s,n);s+=n,n=new Uint32Array(e.slice(s,s+4))[0],s+=4;let h=e.slice(s,s+n);s+=n,n=new Uint32Array(e.slice(s,s+4))[0],s+=4;let c=new Uint8Array(e,s,n);yield Promise.all([(()=>i(this,void 0,void 0,(function*(){const e=yield this.decryptData(c,a,t),r=(new TextDecoder).decode(e);yield this.initializeAfnModel(h,r)})))(),(()=>i(this,void 0,void 0,(function*(){const e=yield this.decryptData(u,a,t),r=(new TextDecoder).decode(e);yield this.initializeBaseModel(o,r)})))()])}))}initialize(e){return i(this,void 0,void 0,(function*(){const{cdnPath:t,enableWasm:r=!1,needFrame:i=!1}=e;let a=null;t&&(a=this.getResourceUrl(t));const{tfJsUrl:s=(null==a?void 0:a.tfJsUrl),wasmGlueCodeUrl:n=(null==a?void 0:a.wasmGlueCodeUrl),wasmUrl:o=(null==a?void 0:a.wasmUrl),model:u=(null==a?void 0:a.modelUrl)}=e;if(!(s&&n&&o&&u))return Promise.reject("Wrong parameter");this.manualFreeMemory=i,yield Promise.all([this.initTF(s,u,r,null==a?void 0:a.wasmBackendUrl,t),this.loadWasm(n,o)]),this.create_vb_no_sab_thread(),this.signal_vb_thread_blur(0,0),self.execute_base=this.executeBase,self.execute_afn=this.executeAfn,self.processed_capture_data_callback=this.vbFrameCallback}))}generateVBFrame(e){return i(this,void 0,void 0,(function*(){if("format"in e){const{format:t}=e,{width:r,height:i}=e.visibleRect;let a,s,n,o,u,h,c,l,d,f,E,_,m,T;if(s=r,n=i,f=e.allocationSize(),"NV12"===t||"BGRA"===t||"I420"===t||"I420A"===t){E=Module._malloc(f);const p=this.GET_HEAP_U8().subarray(E,E+f);try{yield e.copyTo(p),"NV12"===t?(o=r*i,u=r*i/2,h=r,c=h,l=0,d=0,this.signal_vb_thread_video_yuv(E,0,s,n,E,o,E+o,u,E+o,u,h,c,c,l,d,3)):"BGRA"===t?(h=r,_=i,l=0,d=0,a=4,this.signal_vb_thread_video_rgba(E,f,s,n,4*s,0,0,a)):"I420"!==t&&"I420A"!==t||(h=r,_=i,c=h/2,m=h/2,o=r*i,u=r*i/4,T=r*i/4,l=0,d=0,a=2,this.signal_vb_thread_video_yuv(E,0,s,n,E,o,E+o,u,E+o+u,u,h,c,c,l,d,a))}catch(e){Module._free(E)}}else this.onUnsupportedFrame&&this.onUnsupportedFrame(t||"");e.close()}else{const{width:t,height:r,data:i}=e,a=Module._malloc(t*r*4);let s=this.GET_HEAP_U8().subarray(a,a+i.length);const n=i.length;s.set(i,0),this.signal_vb_thread_video_rgba(a,n,t,r,4*t,0,0,1)}}))}free(e){Module._free(e)}setBackgroundImage(e){const{data:t,width:r,height:i}=e,a=Module._malloc(t.length);let s=new Uint8Array(t);this.GET_HEAP_U8().subarray(a,a+t.length).set(s,0),this.signal_vb_thread_bg(a,s.length,r,i)}blur(){this.signal_vb_thread_blur(0,0)}}},function(e,t,r){var i=r(2).default,a=r(8);e.exports=function(e){var t=a(e,"string");return"symbol"===i(t)?t:String(t)},e.exports.__esModule=!0,e.exports.default=e.exports},function(e,t,r){var i=r(2).default;e.exports=function(e,t){if("object"!==i(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var a=r.call(e,t||"default");if("object"!==i(a))return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)},e.exports.__esModule=!0,e.exports.default=e.exports},function(e,t,r){"use strict";var i=this&&this.__awaiter||function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function n(e){try{u(i.next(e))}catch(e){s(e)}}function o(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(n,o)}u((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=a(r(10)),n=r(1);t.default=class{constructor(e,t){this.isMirror=!1,this.display=new s.default(e,t,0,void 0,{preserveDrawingBuffer:!1},void 0,!1,!1)}renderFrame(e,t,r,i){if(this.display){let a={x:0,y:0,width:this.display.canvasElement.width,height:this.display.canvasElement.height};this.display.updateRemoteVideoTextures(e,t,i,r,0,!0,a,!1),this.display.drawRemoteVideo(a,this.isMirror)}}render(e){return i(this,void 0,void 0,(function*(){let t=n.VIDEO_RGBA;if("data_ptr"in e){const{data:t,format_width:r,format_height:i,valid_x:a,valid_y:s,valid_width:o,valid_height:u}=e;let h={top:s,left:a,width:o,height:u};this.display.setVideoMode(n.VIDEO_I420),this.renderFrame(r,i,t,h)}else if(self.VideoFrame&&e instanceof VideoFrame){const{format:r,visibleRect:i}=e;if(r&&i){if("I420"===r||"I420A"===r)t=n.VIDEO_I420;else if("NV12"===r)t=n.VIDEO_NV12;else{if("BGRA"!==r)return void(this.onUnsupportedFrame&&this.onUnsupportedFrame(r));t=n.VIDEO_BGRA}const{width:a,height:s}=i,o=new Uint8Array(e.allocationSize()),u={top:0,left:0,width:a,height:s};this.display.setVideoMode(t);try{yield e.copyTo(o),this.renderFrame(a,s,o,u)}catch(e){}e.close()}}else if(e instanceof ImageData){const{width:t,height:r}=e,i={top:0,left:0,width:t,height:r};this.display.setVideoMode(n.VIDEO_RGBA),this.renderFrame(t,r,e.data,i)}}))}updateSize(e,t){this.display.canvasElement.width=e,this.display.canvasElement.height=t}setMirror(e){this.isMirror=e}}},function(e,t,r){"use strict";r.r(t);var i=r(1),a=r(0);function s(e,t){const r=Math.pow(10,t);return Math.floor(e*r)/r}function n(e,t){const r=Math.pow(10,t);return Math.ceil(e*r)/r}function o(e,t,r,i){return h(e,t),u(r,"set"),function(e,t,r){if(t.set)t.set.call(e,r);else{if(!t.writable)throw new TypeError("attempted to set read only private field");t.value=r}}(e,r,i),i}function u(e,t){if(void 0===e)throw new TypeError("attempted to "+t+" private static field before its declaration")}function h(e,t){if(e!==t)throw new TypeError("Private static access of wrong provenance")}class c{static isEnableCanvasCtxOptionsOpt(){return t=l,h(e=c,c),u(t,"get"),function(e,t){return t.get?t.get.call(e):t.value}(e,t);var e,t}static setIsEnableCanvasCtxOptionsOpt(e){o(c,c,l,e)}}var l={writable:!0,value:!1},d=c;let f=new Map,E=[];function _(e){e.preventDefault()}function m(e,t,r,a,s,n,o){let u=arguments.length>7&&void 0!==arguments[7]&&arguments[7];this.canvasElement=e,this.canvasID=t,this.contextOptions=s,this.textureindex=r||0,this.texturestride=this.textureindex?3:o?4:6,this.initmask=o||!1,this.reuse=!1,this.isEnableCanvasAlphaChannel=u,m.prototype.ROTATION_CLOCK0=0,m.prototype.ROTATION_CLOCK90=1,m.prototype.ROTATION_CLOCK180=2,m.prototype.ROTATION_CLOCK270=3,this.webGLResources=n,n||(this.initContextGL(),this.contextGL&&(this.webGLContextLostProtect(),this.contextGL.isContextLost()&&this.restoreContext())),this.reinit(n);var h=new ArrayBuffer(4);this.dummpyCursor=new Uint8Array(h),this.dummpyWaterMark=new Uint8Array(h),this.cursorWidth=0,this.cursorHeight=0,this.hasCursor=0,this.hasWaterMark=0,this.watermarkOpacity=.15,this.watermarkData=null,this.watermarkWidth=0,this.watermarkHeight=0,this.isMultiView=!1,this.hasWholeFrame=0,this.croppingParams={},this.croppingParams.top=0,this.croppingParams.left=0,this.croppingParams.width=0,this.croppingParams.height=0,this.textureWidth=0,this.textureHeight=0,this.canvasWidth=0,this.canvasHeight=0,this.picRotation=-1,this.bgColor=[0,0,0],this.cx=0,this.cy=0,this.cw=0,this.ch=0,this.colorRange=-1,this.videoMode=i.VIDEO_INVALID,this.rotation=this.ROTATION_CLOCK0,this.fillMode=0,this.fillModeForResolution=0}function T(e,t,r,i){let a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;var s=e.contextGL;let n=s.canvas.width,o=s.canvas.height;a&&(n=a.width,o=a.height);var u,h,c,l,d=i==e.ROTATION_CLOCK90||i==e.ROTATION_CLOCK270?r:t,f=i==e.ROTATION_CLOCK90||i==e.ROTATION_CLOCK270?t:r,E=d/f*o,_=f/d*n;E>n?(u=0,c=1,l=1-(h=(o-_)/2/o)):(h=0,l=1,c=1-(u=(n-E)/2/n)),u=2*u-1,c=2*c-1,h=1-2*h,l=1-2*l;var m=new Float32Array([c,h,u,h,c,l,u,l,c,h,u,h,c,l,u,l]);s.bindBuffer(s.ARRAY_BUFFER,e.vertexPosBuffer),s.bufferData(s.ARRAY_BUFFER,m,s.DYNAMIC_DRAW)}function p(e,t,r,i,a){var s=e.contextGL,n=i.top/r,o=i.left/t,u=n+(i.height-1)/r,h=o+i.width/t,c=[o,n,h,n,h,u,o,u];a==e.ROTATION_CLOCK90&&(c.unshift(c[6],c[7]),c=c.slice(0,8)),a==e.ROTATION_CLOCK180&&(c.unshift(c[4],c[5],c[6],c[7]),c=c.slice(0,8)),a==e.ROTATION_CLOCK270&&(c.push(c[0],c[1]),c=c.slice(2));var l=c[0],d=c[1];c[0]=c[2],c[1]=c[3],c[2]=l,c[3]=d;var f=new Float32Array([...c,1,0,0,0,1,1,0,1]);s.bindBuffer(s.ARRAY_BUFFER,e.texturePosBuffer),s.bufferData(s.ARRAY_BUFFER,f,s.DYNAMIC_DRAW)}m.prototype.reinit=function(e){if(this.webGLResources=e,!this.contextGL||this.contextGL.isContextLost()||this.contextGL.glInitSucceed||this.webGLResources){if(this.webGLResources&&this.webGLResources.contextgl&&!this.webGLResources.contextgl.isContextLost()){this.contextGL=this.webGLResources.contextgl,this.shaderProgram=this.webGLResources.program,this.waterMarkTextureRef=this.webGLResources.waterMarkTextureRef,this.repeatedWaterMarkTextureRef=this.webGLResources.repeatedWaterMarkTextureRef,this.initTextures(!1),this.vertexPosBuffer=this.webGLResources.vBuffer,this.texturePosBuffer=this.webGLResources.tBuffer;let e=this.contextGL.getError();this.contextGL.glInitSucceed=e!=this.contextGL.NO_ERROR&&e!=this.contextGL.CONTEXT_LOST_WEBGL?0:1}}else{this.initProgram(),this.initmask?this.initTextures(!1):this.initTextures(!0),this.initBuffers();let e=this.contextGL.getError();this.contextGL.glInitSucceed=e!=this.contextGL.NO_ERROR&&e!=this.contextGL.CONTEXT_LOST_WEBGL?0:1}},m.prototype.webGLContextLostSimulate=function(){let e="undefined"==typeof window?self:window;e.webGLEXTSimulate=e.webGLEXTSimulate||[],e.webGLEXTSimulate.push(Object(a.d)(this.contextGL,"WEBGL_lose_context"))},m.prototype.restoreContext=function(){if(this.contextGL)try{var e,t;if(null!==(e=this.canvasElement)&&void 0!==e&&e.loseContextExtension&&this.contextGL.isContextLost())null===(t=this.canvasElement)||void 0===t||t.loseContextExtension.restoreContext()}catch(e){Object(a.b)("webgl restoreContext exception",e)}},m.prototype.webgGLContextLostCallback=function(e){Object(a.e)("webglcontextlost event: canvas listener size=".concat(E.length,",  canvas id: ").concat(this.canvasID,", , ids:").concat(E.join())),e.preventDefault(),this.contextGL.glInitSucceed=0,this.contextOptions&&this.contextOptions.webglcontextlostCallback&&this.contextOptions.webglcontextlostCallback(e,this.contextOptions.params)},m.prototype.removeEventListener=function(e,t){if(e&&t){0,e.removeEventListener("webglcontextlost",t.contextLostHandler),e.removeEventListener("webglcontextrestored",t.contextRestoredHandler);const r=E.indexOf(this.canvasID);E.splice(r,1),f.delete(e)}},m.prototype.webGLContextRestoredCallback=function(e){Object(a.e)("webglcontextrestored event from canvas id: ".concat(this.canvasID)),this.reinit(),this.contextOptions&&this.contextOptions.webglcontextrestoredCallback&&this.contextOptions.webglcontextrestoredCallback(e,this.contextOptions.params)},m.prototype.webGLContextLostProtect=function(){this.canvasElement&&!this.canvasElement.loseContextExtension&&(this.canvasElement.loseContextExtension=Object(a.d)(this.contextGL,"WEBGL_lose_context"));let e=this.canvasElement,t=f.get(e);t&&this.removeEventListener(e,t),f.set(e,this),this.contextLostHandler=this.webgGLContextLostCallback.bind(this),this.contextRestoredHandler=this.webGLContextRestoredCallback.bind(this),e.addEventListener("webglcontextlost",this.contextLostHandler,{capture:!1}),e.addEventListener("webglcontextrestored",this.contextRestoredHandler,{capture:!1}),-1===E.indexOf(this.canvasID)&&(E.push(this.canvasID),E.length>4&&Object(a.e)("webglcanvas listener size=".concat(E.length,", ids:").concat(E.join())))},m.prototype.isWebGL=function(){return this.contextGL},m.prototype.isAvaiable=function(){return this.contextGL&&!this.contextGL.isContextLost()&&this.contextGL.glInitSucceed},m.prototype.initContextGL=function(){for(var e,t,r=this.canvasElement,i=null,s=["webgl","experimental-webgl","moz-webgl","webkit-3d"],n=0;!i&&n<s.length;){var o=s[n];try{if(d.isEnableCanvasCtxOptionsOpt()){let e={depth:!1,stencil:!1,antialias:!1,alpha:this.isEnableCanvasAlphaChannel};if(this.contextOptions){let t={...this.contextOptions,...e};i=r.getContext(o,t)}else i=r.getContext(o,e)}else i=this.contextOptions?r.getContext(o,this.contextOptions):r.getContext(o)}catch(e){i=null}i&&"function"==typeof i.getParameter||(i=null),++n}(this.contextGL=i,i)?i.glInitSucceed=0:Object(a.b)("Failed when trying to get WebGLContext on canvas(".concat(null===(e=this.canvasElement)||void 0===e?void 0:e.width,",").concat(null===(t=this.canvasElement)||void 0===t?void 0:t.height,")"))},m.prototype.initProgram=function(){var e=this.contextGL,t=["attribute vec4 vertexPos;","attribute vec4 texturePos;","attribute vec4 masktexturePos;","varying vec2 textureCoord;","varying vec2 masktextureCoord;","void main()","{","gl_Position = vertexPos;","textureCoord = texturePos.xy;","masktextureCoord = masktexturePos.xy;","}"].join("\n"),r=["precision highp float;","varying highp vec2 textureCoord;","varying highp vec2 masktextureCoord;","uniform sampler2D ySampler;","uniform sampler2D uSampler;","uniform sampler2D vSampler;","uniform sampler2D cursorSampler;","uniform sampler2D waterMarkSampler;","uniform sampler2D  previewVideoSampler;","uniform sampler2D maskSampler;","uniform vec4 cursorInfo;","uniform int onlyRGBA;","uniform int bgraMode;","uniform int colorRange;","uniform int waterMarkFlag;","uniform int cursorFlag;","uniform int maskFlag;","uniform int yuvmode;","const mat4 YUV2RGB_L = mat4","(","1.1643828125, 0, 1.59602734375, -.87078515625,","1.1643828125, -.39176171875, -.81296875, .52959375,","1.1643828125, 2.017234375, 0, -1.081390625,","0, 0, 0, 1",");","const mat4 YUV2RGB_F = mat4","(","1.0, 0, 1.402, -.701,","1.0, -.34413, -.71414, .529135,","1.0, 1.772, 0, -.886,","0, 0, 0, 1",");","void main(void) {","vec4 c;","if(waterMarkFlag!=1) {","if(onlyRGBA==0){","highp float y = texture2D(ySampler,  textureCoord).r;","highp float u;","highp float v;","if(yuvmode==1){","u = texture2D(uSampler,  textureCoord).r;","v = texture2D(vSampler,  textureCoord).r;","}","else{","u = texture2D(uSampler,  textureCoord).r;","v = texture2D(uSampler,  textureCoord).a;","}","if (colorRange == 0)","{","  c = vec4(y, u, v, 1) * YUV2RGB_L;","} else {","  c = vec4(y, u, v, 1) * YUV2RGB_F;","}","if(cursorFlag==1)","{","if (cursorInfo.z > 0.0 && textureCoord.x >= cursorInfo.x && textureCoord.y >= cursorInfo.y && ","    textureCoord.x < cursorInfo.x+cursorInfo.z && textureCoord.y < cursorInfo.y+cursorInfo.w ){"," vec2 cursorCoord = textureCoord - cursorInfo.xy;"," cursorCoord /= cursorInfo.zw;"," vec4 cursor = texture2D(cursorSampler, cursorCoord);"," c = c*(1.0-cursor.a) + cursor*cursor.a;","}","}","}","else{"," c = texture2D(previewVideoSampler, textureCoord);","if(bgraMode==1)","{"," c = vec4(c.b, c.g, c.r, c.a);","}","}","}","if(waterMarkFlag==1)","{"," c = texture2D(waterMarkSampler, textureCoord);","if(c.r == 0.0 && c.g == 0.0 && c.b == 0.0){"," c.a = 0.0;","}","}","if(maskFlag==1 && waterMarkFlag!=1)","{","vec4 mask = texture2D(maskSampler, masktextureCoord);","if(mask.r != 0.0 || mask.g != 0.0 || mask.b != 0.0){","c = mask* mask.a+ c*(1.0-mask.a);","}","}","if (waterMarkFlag!=1){","c.a = 1.0;","}","gl_FragColor = c;","}"].join("\n"),i=e.createShader(e.VERTEX_SHADER);e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||e.isContextLost()||Object(a.e)("webgl Vertex shader failed to compile: "+e.getShaderInfoLog(i));var s=e.createShader(e.FRAGMENT_SHADER);e.shaderSource(s,r),e.compileShader(s),e.getShaderParameter(s,e.COMPILE_STATUS)||e.isContextLost()||Object(a.e)("webgl Fragment shader failed to compile: "+e.getShaderInfoLog(s));var n=e.createProgram();e.attachShader(n,i),e.attachShader(n,s),e.linkProgram(n),e.getProgramParameter(n,e.LINK_STATUS)||e.isContextLost()||Object(a.e)("webgl Program failed to compile: "+e.getProgramInfoLog(n)),e.useProgram(n),this.shaderProgram=n},m.prototype.initBuffers=function(){var e=this.contextGL,t=this.shaderProgram,r=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,r),e.bufferData(e.ARRAY_BUFFER,new Float32Array([1,1,-1,1,1,-1,-1,-1,1,1,-1,1,1,-1,-1,-1]),e.STATIC_DRAW);var i=e.getAttribLocation(t,"vertexPos");e.enableVertexAttribArray(i),e.vertexAttribPointer(i,2,e.FLOAT,!1,0,0),this.vertexPosBuffer=r;var a=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferData(e.ARRAY_BUFFER,new Float32Array([1,0,0,0,1,1,0,1,1,0,0,0,1,1,0,1]),e.STATIC_DRAW);var s=e.getAttribLocation(t,"texturePos");if(e.enableVertexAttribArray(s),e.vertexAttribPointer(s,2,e.FLOAT,!1,0,0),this.initmask&&!this.masktexturePosBuffer){var n=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,n),e.bufferData(e.ARRAY_BUFFER,new Float32Array([1,0,0,0,1,1,0,1]),e.STATIC_DRAW);var o=e.getAttribLocation(t,"masktexturePos");e.enableVertexAttribArray(o),e.vertexAttribPointer(o,2,e.FLOAT,!1,0,0),this.masktexturePosBuffer=n}this.texturePosBuffer=a},m.prototype.initTextures=function(e){var t=this.contextGL,r=this.shaderProgram;t.pixelStorei(t.UNPACK_ALIGNMENT,1);var a=this.initTexture();this.yTextureRef=a,this.oyTextureRef=a;var s=this.initTexture();this.uTextureRef=s,this.ouTextureRef=s;var n=this.initTexture();if(this.vTextureRef=n,this.ovTextureRef=n,e){this.BindTextures(i.VIDEO_I420);var o=this.initTexture(),u=t.getUniformLocation(r,"cursorSampler");t.uniform1i(u,this.textureindex*this.texturestride+3),this.cursorTextureRef=o;var h=this.initTexture(),c=t.getUniformLocation(r,"waterMarkSampler");t.uniform1i(c,4),this.waterMarkTextureRef=h;var l=this.initTexture();this.repeatedWaterMarkTextureRef=l;var d=this.initTexture(),f=t.getUniformLocation(r,"previewVideoSampler");t.uniform1i(f,this.textureindex*this.texturestride+5),this.previewVideoTextureRef=d;var E=t.getUniformLocation(r,"cursorInfo");this.cursorInfoRef=E}if(this.initmask){t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,1);var _=this.initTexture(),m=t.getUniformLocation(r,"maskSampler");t.uniform1i(m,this.textureindex*this.texturestride+6),this.maskTextureRef=_}var T=t.getUniformLocation(r,"colorRange");this.colorRangeRef=T,this.onlyRGBARef=t.getUniformLocation(r,"onlyRGBA"),this.bgraModeRef=t.getUniformLocation(r,"bgraMode"),this.waterMarkFlagRef=t.getUniformLocation(r,"waterMarkFlag"),this.maskFlagRef=t.getUniformLocation(r,"maskFlag"),this.cursorFlagRef=t.getUniformLocation(r,"cursorFlag"),this.yuvmodeRef=t.getUniformLocation(r,"yuvmode")},m.prototype.BindTextures=function(e){var t=this.contextGL,r=this.shaderProgram;if(t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.activeTexture(t.TEXTURE0+0),t.bindTexture(t.TEXTURE_2D,this.yTextureRef),t.activeTexture(t.TEXTURE0+1),t.bindTexture(t.TEXTURE_2D,this.uTextureRef),t.activeTexture(t.TEXTURE0+2),t.bindTexture(t.TEXTURE_2D,this.vTextureRef),e==i.VIDEO_I420){let e=t.getUniformLocation(r,"ySampler");t.uniform1i(e,0);let i=t.getUniformLocation(r,"uSampler");t.uniform1i(i,1);let a=t.getUniformLocation(r,"vSampler");t.uniform1i(a,2)}else if(this.isRGBAMode(e)){let e=t.getUniformLocation(r,"previewVideoSampler");t.uniform1i(e,0);let i=t.getUniformLocation(r,"ySampler");t.uniform1i(i,0);let a=t.getUniformLocation(r,"uSampler");t.uniform1i(a,0);let s=t.getUniformLocation(r,"vSampler");t.uniform1i(s,0)}else if(e==i.VIDEO_NV12){let e=t.getUniformLocation(r,"ySampler");t.uniform1i(e,0);let i=t.getUniformLocation(r,"uSampler");t.uniform1i(i,1);let a=t.getUniformLocation(r,"vSampler");t.uniform1i(a,0)}let a=t.getUniformLocation(r,"previewVideoSampler");t.uniform1i(a,0);let s=t.getUniformLocation(r,"maskSampler");this.initmask?(t.activeTexture(t.TEXTURE0+6),t.bindTexture(t.TEXTURE_2D,this.maskTextureRef),t.uniform1i(s,6)):t.uniform1i(s,0);let n=t.getUniformLocation(r,"cursorSampler");t.uniform1i(n,0);let o=t.getUniformLocation(this.shaderProgram,"waterMarkSampler");t.uniform1i(o,0)},m.prototype.initTexture=function(){var e=this.contextGL,t=e.createTexture();return e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),t},m.prototype.clearDisplay=function(){var e=this.contextGL;e&&(e.enable(e.BLEND),e.blendFunc(e.ZERO,e.ZERO)),this.render()},m.prototype.cleanup=function(){let e=this.canvasElement,t=f.get(e);if(t&&this.removeEventListener(e,t),e.defaultContextLostHandler||(e.defaultContextLostHandler=_,e.addEventListener("webglcontextlost",_,{capture:!1})),this.isAvaiable()){var r=this.contextGL;r.deleteProgram(this.program),r.activeTexture(r.TEXTURE0+this.textureindex*this.texturestride),r.bindTexture(r.TEXTURE_2D,null),r.activeTexture(r.TEXTURE1+this.textureindex*this.texturestride),r.bindTexture(r.TEXTURE_2D,null),r.activeTexture(r.TEXTURE2+this.textureindex*this.texturestride),r.bindTexture(r.TEXTURE_2D,null),this.textureindex||this.initmask||(r.activeTexture(r.TEXTURE3+this.textureindex*this.texturestride),r.bindTexture(r.TEXTURE_2D,null),r.activeTexture(r.TEXTURE4+this.textureindex*this.texturestride),r.bindTexture(r.TEXTURE_2D,null),r.activeTexture(this.getRepeatedWatermarkTextureValue(r)),r.bindTexture(r.TEXTURE_2D,null),r.activeTexture(r.TEXTURE5+this.textureindex*this.texturestride),r.bindTexture(r.TEXTURE_2D,null)),r.bindBuffer(r.ARRAY_BUFFER,null),r.deleteTexture(this.yTextureRef),r.deleteTexture(this.uTextureRef),r.deleteTexture(this.vTextureRef),this.textureindex||this.initmask||(r.deleteTexture(this.cursorTextureRef),r.deleteTexture(this.waterMarkTextureRef),r.deleteTexture(this.repeatedWaterMarkTextureRef),r.deleteTexture(this.previewVideoTextureRef),r.deleteBuffer(this.vertexPosBuffer),r.deleteBuffer(this.texturePosBuffer)),this.maskTextureRef&&r.deleteTexture(this.maskTextureRef),this.masktexturePosBuffer&&r.deleteBuffer(this.masktexturePosBuffer),r.glInitSucceed=0}},m.prototype.drawNextOutputPicture=function(e,t,r,i){let a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;var s=this.contextGL;s?this.drawNextOutputPictureFrame(e,t,r,i,a):this.drawNextOuptutPictureRGBA(e,t,r,i)},m.prototype.updateVertexInfoForMultiView=function(e,t,r,i,a){var s,n,o,u,h=this.contextGL;if(this.isUseFillMode({width:r,height:i,rotation:a}))s=0,n=0,o=1,u=1;else{var c=a==this.ROTATION_CLOCK90||a==this.ROTATION_CLOCK270?i:r,l=a==this.ROTATION_CLOCK90||a==this.ROTATION_CLOCK270?r:i,d=c/l*t;d>e?(s=0,o=1,u=1-(n=(t-l/c*e)/2/t)):(n=0,u=1,o=1-(s=(e-d)/2/e))}s=2*s-1,o=2*o-1,n=1-2*n,u=1-2*u;var f=new Float32Array([o,n,s,n,o,u,s,u,1,1,-1,1,1,-1,-1,-1]);h.bindBuffer(h.ARRAY_BUFFER,this.vertexPosBuffer),h.bufferData(h.ARRAY_BUFFER,f,h.DYNAMIC_DRAW)},m.prototype.updateTextureInfoForMultiView=function(e,t,r,i,a,o,u){var h,c,l,d,f=this.contextGL;if(this.isUseFillMode({width:r.width,height:r.height,rotation:i})){const a=i==this.ROTATION_CLOCK90||i==this.ROTATION_CLOCK270?u/o:o/u,s=r.left||0,n=r.top||0;if(r.width/r.height>a){const i=r.height*a;h=n/t,c=(Math.round((r.width-i)/2)+s)/e,l=h+(r.height-1)/t,d=c+i/e}else{const i=r.width/a;l=(h=(Math.round((r.height-i)/2)+n)/t)+(i-1)/t,d=(c=s/e)+r.width/e}}else h=n(r.top/t,2),c=n(r.left/e,2),l=s((r.top+r.height-1)/t,2),d=s((r.width-1+r.left)/e,2);var E=[c,h,d,h,d,l,c,l];i==this.ROTATION_CLOCK90&&(E.unshift(E[6],E[7]),E=E.slice(0,8)),i==this.ROTATION_CLOCK180&&(E.unshift(E[4],E[5],E[6],E[7]),E=E.slice(0,8)),i==this.ROTATION_CLOCK270&&(E.unshift(E[6],E[7]),(E=E.slice(0,8))[0]=1-E[0],E[2]=1-E[2],E[4]=1-E[4],E[6]=1-E[6]);var _=E[0],m=E[1];if(E[0]=E[2],E[1]=E[3],E[2]=_,E[3]=m,a)if(i==this.ROTATION_CLOCK90||i==this.ROTATION_CLOCK270){let e=E[1];E[1]=E[3],E[3]=e,e=E[5],E[5]=E[7],E[7]=e}else E[0]=1-E[0],E[2]=1-E[2],E[4]=1-E[4],E[6]=1-E[6];var T=new Float32Array([...E,1,0,0,0,1,1,0,1]);f.bindBuffer(f.ARRAY_BUFFER,this.texturePosBuffer),f.bufferData(f.ARRAY_BUFFER,T,f.DYNAMIC_DRAW)},m.prototype.drawNextOutputPictureFrame=function(e,t,r,a,s){let n=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,u=!(arguments.length>7&&void 0!==arguments[7])||arguments[7];if(!this.isAvaiable())return;var h=this.contextGL,c=(this.texturePosBuffer,this.yTextureRef),l=this.uTextureRef,d=this.vTextureRef;h.enable(h.BLEND),h.blendFunc(h.SRC_ALPHA,h.ONE_MINUS_SRC_ALPHA),s=s||this.ROTATION_CLOCK0;var f=(r=r||{top:0,left:0,width:e,height:t}).width!=this.croppingParams.width||r.height!=this.croppingParams.height,E=r.top!=this.croppingParams.top||r.left!=this.croppingParams.left,_=h.canvas.width!=this.canvasWidth||h.canvas.height!=this.canvasHeight,m=e!=this.textureWidth||t!=this.textureHeight,R=s!=this.picRotation;(f||_||R)&&T(this,r.width,r.height,s,o),(f||E||m||R)&&p(this,e,t,r,s);let v=n?0:1;v!=this.colorRange&&(h.uniform1i(this.colorRangeRef,v),this.colorRange=v),o?h.viewport(o.x,o.y,o.width,o.height):h.viewport(0,0,h.canvas.width,h.canvas.height),h.uniform1i(this.onlyRGBARef,0),h.uniform1i(this.yuvmodeRef,i.VIDEO_I420),Object.assign(this.croppingParams,r),this.textureWidth=e,this.textureHeight=t,this.picRotation=s,this.canvasWidth=h.canvas.width,this.canvasHeight=h.canvas.height,h.clearColor(this.bgColor[0],this.bgColor[1],this.bgColor[2],255),h.clear(h.COLOR_BUFFER_BIT);var g=a,A=e*t;if(h.activeTexture(h.TEXTURE0),h.bindTexture(h.TEXTURE_2D,c),u){var x=g.subarray(0,A);h.texImage2D(h.TEXTURE_2D,0,h.LUMINANCE,e,t,0,h.LUMINANCE,h.UNSIGNED_BYTE,x)}var b=e/2*t/2;if(h.activeTexture(h.TEXTURE1),h.bindTexture(h.TEXTURE_2D,l),u){var O=g.subarray(A,A+b);h.texImage2D(h.TEXTURE_2D,0,h.LUMINANCE,e/2,t/2,0,h.LUMINANCE,h.UNSIGNED_BYTE,O)}var y=b;if(h.activeTexture(h.TEXTURE2),h.bindTexture(h.TEXTURE_2D,d),u){var D=g.subarray(A+b,A+b+y);h.texImage2D(h.TEXTURE_2D,0,h.LUMINANCE,e/2,t/2,0,h.LUMINANCE,h.UNSIGNED_BYTE,D)}h.activeTexture(h.TEXTURE3),h.bindTexture(h.TEXTURE_2D,this.cursorTextureRef),this.hasCursor?h.uniform1i(this.cursorFlagRef,1):u&&h.texImage2D(h.TEXTURE_2D,0,h.RGBA,1,1,0,h.RGBA,h.UNSIGNED_BYTE,this.dummpyCursor),h.uniform4f(this.cursorInfoRef,this.cx,this.cy,this.cw,this.ch),h.activeTexture(h.TEXTURE5),h.bindTexture(h.TEXTURE_2D,this.previewVideoTextureRef),h.texImage2D(h.TEXTURE_2D,0,h.RGBA,1,1,0,h.RGBA,h.UNSIGNED_BYTE,this.dummpyWaterMark);var I=h.getUniformLocation(this.shaderProgram,"maskSampler");h.uniform1i(I,5),this.render(),this.hasWholeFrame=1},m.prototype.updateTextureBlock=function(e,t,r,i,a){if(this.isAvaiable()){var s=this.contextGL,n=a;if(!(!this.hasWholeFrame||e<=0||t<=0||r<0||i<0||r+e>this.textureWidth||i+t>this.textureHeight)&&a&&a.length==e*t*3/2){var o=this.yTextureRef,u=this.uTextureRef,h=this.vTextureRef,c=e*t,l=n.subarray(0,c);s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,o),s.texSubImage2D(s.TEXTURE_2D,0,r,i,e,t,s.LUMINANCE,s.UNSIGNED_BYTE,l);var d=e/2*t/2,f=n.subarray(c,c+d);s.activeTexture(s.TEXTURE1),s.bindTexture(s.TEXTURE_2D,u),s.texSubImage2D(s.TEXTURE_2D,0,r/2,i/2,e/2,t/2,s.LUMINANCE,s.UNSIGNED_BYTE,f);var E=d,_=n.subarray(c+d,c+d+E);s.activeTexture(s.TEXTURE2),s.bindTexture(s.TEXTURE_2D,h),s.texSubImage2D(s.TEXTURE_2D,0,r/2,i/2,e/2,t/2,s.LUMINANCE,s.UNSIGNED_BYTE,_)}}},m.prototype.updateCursor=function(e,t,r){if(this.isAvaiable()){var i=this.contextGL;e<=0||t<=0||!r||r.length!=e*t*4||(i.activeTexture(i.TEXTURE3),i.bindTexture(i.TEXTURE_2D,this.cursorTextureRef),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,e,t,0,i.RGBA,i.UNSIGNED_BYTE,r),this.cursorWidth=e,this.cursorHeight=t,this.hasCursor=1)}},m.prototype.updateWatermark=function(e,t,r){if(this.isAvaiable()){this.contextGL;e<=0||t<=0||!r||r.length!=e*t*4||(this.watermarkData=r,this.watermarkWidth=e,this.watermarkHeight=t,this.hasWaterMark=1)}},m.prototype.drawWatermark=function(){if(this.isAvaiable()){var e=this.contextGL;if(this.isSetWatermark()&&this.watermarkData&&this.watermarkWidth&&this.watermarkHeight){e.uniform1i(this.waterMarkFlagRef,1),this.isWatermarkRepeated()?(e.activeTexture(this.getRepeatedWatermarkTextureValue(e)),e.bindTexture(e.TEXTURE_2D,this.repeatedWaterMarkTextureRef)):(e.activeTexture(e.TEXTURE4),e.bindTexture(e.TEXTURE_2D,this.waterMarkTextureRef)),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.watermarkWidth,this.watermarkHeight,0,e.RGBA,e.UNSIGNED_BYTE,this.watermarkData);let t=e.getUniformLocation(this.shaderProgram,"waterMarkSampler");e.uniform1i(t,this.isWatermarkRepeated()?this.getRepeatedWatermarkUniformValue():4),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.drawArrays(e.TRIANGLE_STRIP,4,4)}}},m.prototype.render=function(){if(this.isAvaiable()){var e=this.contextGL;e.uniform1i(this.waterMarkFlagRef,0),e.drawArrays(e.TRIANGLE_STRIP,0,4),this.drawWatermark()}},m.prototype.drawCursor=function(e,t,r,i,a){if(this.isAvaiable()){var s=this.contextGL;if(!(!this.hasWholeFrame||e&&(i<0||a<0))){s.viewport(0,0,s.canvas.width,s.canvas.height);var n=this.yTextureRef,o=this.uTextureRef,u=this.vTextureRef,h=this.cursorTextureRef;if(s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,n),s.activeTexture(s.TEXTURE1),s.bindTexture(s.TEXTURE_2D,o),s.activeTexture(s.TEXTURE2),s.bindTexture(s.TEXTURE_2D,u),s.activeTexture(s.TEXTURE3),s.bindTexture(s.TEXTURE_2D,h),e&&this.hasCursor){let e=t/this.croppingParams.width,n=r/this.croppingParams.height,o=i/this.croppingParams.width,u=a/this.croppingParams.height;this.cx=e,this.cy=n,this.cw=o,this.ch=u,s.uniform4f(this.cursorInfoRef,e,n,o,u)}else s.uniform4f(this.cursorInfoRef,0,0,0,0);this.render()}}},m.prototype.clear=function(){this.hasWholeFrame=0,this.hasCursor=0},m.prototype.clearCanvas=function(e){if(this.isAvaiable()){var t=this.contextGL;e?t.clearColor(e.R,e.G,e.B,e.A):t.clearColor(this.bgColor[0],this.bgColor[1],this.bgColor[2],255),t.clear(t.COLOR_BUFFER_BIT)}},m.prototype.drawNextOuptutPictureRGBA=function(e,t,r,i){if(this.isAvaiable()){var a=i,s=this.canvasElement.getContext("2d"),n=s.getImageData(0,0,e,t);n.data.set(a),s.putImageData(n,0,0)}},m.prototype.isRGBAMode=function(e){return-1!==[i.VIDEO_RGBA,i.VIDEO_BGRA].indexOf(e)},m.prototype.updateRemoteVideoTextures=function(e,t,r,a,s){let n=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],o=!(arguments.length>8&&void 0!==arguments[8])||arguments[8];if(!this.isAvaiable())return;var u=this.contextGL,h=this.yTextureRef,c=this.uTextureRef,l=this.vTextureRef;u.enable(u.BLEND),u.blendFunc(u.SRC_ALPHA,u.ONE_MINUS_SRC_ALPHA);const d=this.isRGBAMode(this.videoMode);if(e<=0||t<=0||!a||!a.length||a.length!=e*t*3/2&&!d||r&&(r.top<0||r.left<0||r.left+r.width>e||r.top+r.height>t))return!1;let f=n?0:1;if(this.colorRange=f,this.rotation=s,Object.assign(this.croppingParams,r),this.textureWidth=e,this.textureHeight=t,this.canvasWidth=u.canvas.width,this.canvasHeight=u.canvas.height,!o)return;if(u.bindTexture(u.TEXTURE_2D,h),d)return void u.texImage2D(u.TEXTURE_2D,0,u.RGBA,e,t,0,u.RGBA,u.UNSIGNED_BYTE,a);var E=a,_=e*t,m=E.subarray(0,_);u.texImage2D(u.TEXTURE_2D,0,u.LUMINANCE,e,t,0,u.LUMINANCE,u.UNSIGNED_BYTE,m);let T=0,p=0;this.videoMode==i.VIDEO_I420?(T=e/2*t/2,p=T):this.videoMode==i.VIDEO_NV12&&(T=e*t/2,p=0);var R=E.subarray(_,_+T);if(u.bindTexture(u.TEXTURE_2D,c),p){u.texImage2D(u.TEXTURE_2D,0,u.LUMINANCE,e/2,t/2,0,u.LUMINANCE,u.UNSIGNED_BYTE,R);var v=E.subarray(_+T,_+T+p);u.bindTexture(u.TEXTURE_2D,l),u.texImage2D(u.TEXTURE_2D,0,u.LUMINANCE,e/2,t/2,0,u.LUMINANCE,u.UNSIGNED_BYTE,v)}else u.texImage2D(u.TEXTURE_2D,0,u.LUMINANCE_ALPHA,e/2,t/2,0,u.LUMINANCE_ALPHA,u.UNSIGNED_BYTE,R);return!0},m.prototype.updateRemoteVideoTexturesImageBitmap=function(e,t,r,i,a){let s=!(arguments.length>5&&void 0!==arguments[5])||arguments[5];if(e<=0||t<=0||!r)return;if(!this.isAvaiable())return;var n=this.contextGL;if(this.textureWidth=e,this.textureHeight=t,Number.isNaN(a)||(this.rotation=a),Object.assign(this.croppingParams,i),!s)return;n.bindTexture(n.TEXTURE_2D,this.yTextureRef);const o=0,u=n.RGBA,h=n.RGBA,c=n.UNSIGNED_BYTE;n.texImage2D(n.TEXTURE_2D,o,u,h,c,r)},m.prototype.updateSelfMaskImage=function(e,t,r){if(!(e<=0||t<=0)&&r&&r.length==e*t*4&&this.isAvaiable()){var i=this.contextGL;i.bindTexture(i.TEXTURE_2D,this.maskTextureRef),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,e,t,0,i.RGBA,i.UNSIGNED_BYTE,r)}},m.prototype.VideoFlip=function(){if(this.isAvaiable()){var e=this.contextGL;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,1)}},m.prototype.drawRemoteVideo=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!this.isAvaiable())return;var r=this.contextGL;let i=this.isRGBAMode(this.videoMode)?1:0;r.uniform1i(this.colorRangeRef,this.colorRange),this.setUniformFlag(i,this.hasCursor,this.videoMode),this.initmask&&r.uniform1i(this.maskFlagRef,1),this.updateTextureInfoForMultiView(this.textureWidth,this.textureHeight,this.croppingParams,this.rotation,t,e.width,e.height),r.viewport(e.x,e.y,e.width,e.height),this.updateVertexInfoForMultiView(e.width,e.height,this.croppingParams.width,this.croppingParams.height,this.rotation),this.BindTextures(this.videoMode),r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),this.render()},m.prototype.readPixelsSyncRequest=function(e,t,r,i){if(this.isAvaiable()){var a,s=this.contextGL;return this.destination&&this.destination.length==r*i*4||(this.destination=new Uint8Array(r*i*4)),a=this.destination,s.flush(),s.readPixels(e,t,r,i,s.RGBA,s.UNSIGNED_BYTE,a),a}},m.prototype.updateSelfVideoTextures=function(e,t,r,i){let a=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;if(!(e<=0||t<=0)&&r&&r.length%4==0&&this.isAvaiable()){var n=this.contextGL;this.textureWidth=e,this.textureHeight=t,this.rotation=s,Object.assign(this.croppingParams,i),a&&(n.bindTexture(n.TEXTURE_2D,this.yTextureRef),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,e,t,0,n.RGBA,n.UNSIGNED_BYTE,r))}},m.prototype.drawSelfVideo=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this.isAvaiable()){var a=this.contextGL;this.setUniformFlag(1,this.hasCursor,this.videoMode),this.updateTextureInfoForMultiView(this.textureWidth,this.textureHeight,this.croppingParams,this.rotation,r,e.width,e.height),a.viewport(e.x,e.y,e.width,e.height),t?(a.enable(a.BLEND),a.blendFunc(a.ZERO,a.ZERO),this.updateVertexInfoForMultiView(e.width,e.height,e.width,e.height,this.ROTATION_CLOCK0)):(a.enable(a.BLEND),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),this.updateVertexInfoForMultiView(e.width,e.height,this.croppingParams.width,this.croppingParams.height,this.rotation)),this.BindTextures(i.VIDEO_RGBA),this.render()}},m.prototype.isSetWatermark=function(){return this.hasWaterMark},m.prototype.recoverTextures=function(){},m.prototype.setWatermarkFlag=function(e){this.hasWaterMark=e,e||(this.setWatermarkRepeated(!1),this.setWatermarkOpacity(),this.setWatermarkPosition(16))},m.prototype.setUniformFlag=function(e,t,r){if(this.isAvaiable()){var a=this.contextGL;a.uniform1i(this.onlyRGBARef,e),a.uniform1i(this.bgraModeRef,e&&r===i.VIDEO_BGRA?1:0),a.uniform1i(this.cursorFlagRef,t),e||a.uniform1i(this.yuvmodeRef,r)}},m.prototype.setVideoMode=function(e){this.videoMode=e},m.prototype.getVideoMode=function(e){return this.videoMode},m.prototype.setWatermarkRepeated=function(e){this.watermarkRepeated=e},m.prototype.isWatermarkRepeated=function(){return!!this.watermarkRepeated},m.prototype.setWatermarkOpacity=function(e){this.watermarkOpacity=e||.15},m.prototype.getWatermarkOpacity=function(){return this.watermarkOpacity},m.prototype.setWatermarkPosition=function(e){this.watermarkPosition=e||16},m.prototype.getWatermarkPosition=function(){return this.watermarkPosition},m.prototype.setMultiView=function(e){return this.isMultiView=e},m.prototype.getRepeatedWatermarkUniformValue=function(){return this.isMultiView?30:7},m.prototype.getRepeatedWatermarkTextureValue=function(e){return this.isMultiView?e.TEXTURE30:e.TEXTURE7},m.prototype.setFillMode=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.fillMode=e,this.fillModeForResolution=t},m.prototype.getFillMode=function(){return this.fillMode},m.prototype.getFillModeForResolution=function(){return this.fillModeForResolution},m.prototype.getTextureIndex=function(){return this.textureindex},m.prototype.getTextureWidth=function(){return this.textureWidth},m.prototype.getTextureHeight=function(){return this.textureHeight},m.prototype.getCroppingParams=function(){return this.croppingParams},m.prototype.getIndex=function(){return this.textureindex},m.prototype.getWatermarkWidth=function(){return this.watermarkWidth},m.prototype.getWatermarkHeight=function(){return this.watermarkHeight},m.prototype.getWatermarkOpacity=function(){return this.watermarkOpacity},m.prototype.getAttachedCanvas=function(){return this.canvasElement},m.prototype.resizeCanvasTo=function(e,t){this.contextGL.canvas.width=e,this.contextGL.canvas.height=t},m.prototype.isUseFillMode=function(e){let{width:t,height:r,rotation:i}=e;if(!this.fillMode)return!1;if(!this.fillModeForResolution)return!0;if(!t||!r)return!1;const a=i===this.ROTATION_CLOCK90||i==this.ROTATION_CLOCK270?r/t:t/r;return(Array.isArray(this.fillModeForResolution)?this.fillModeForResolution:[this.fillModeForResolution]).some(e=>Math.abs(a-e)<.01)};t.default=m},function(e,t,r){"use strict";r.r(t);const i={VIDEO_ENCODE:"0",VIDEO_DECODE:"1",AUDIO_ENCODE:"2",AUDIO_DECODE:"3",SHARING_ENCODE:"4",SHARING_DECODE:"5"},a=((()=>{const e={};for(const t in i)e[i[t]]="WCL_"+t})(),{[i.AUDIO_ENCODE]:"audio.encode",[i.AUDIO_DECODE]:"audio.decode",[i.VIDEO_ENCODE]:"video.encode",[i.VIDEO_DECODE]:"video.decode",[i.SHARING_ENCODE]:"share.encode",[i.SHARING_DECODE]:"share.decode"});var s=r(3),n=r.n(s);const o=e=>btoa(String.fromCharCode(...new Uint8Array(e)));class u{constructor(e){n()(this,"process",async()=>{if(this.processList.length){const e=this.processList.splice(0,30),t=await this.encryptData(this.mergeBuffer(e));this.writeLog(o(t)),this.writeLog(this.EOL)}requestAnimationFrame(this.process)}),this.textEncoder=new TextEncoder,this.textDecoder=new TextDecoder,this.EOL=this.textEncoder.encode("\n"),this.processList=[],this.writeLog=e,this.key=null,this.initEncryptPromise=this.initEncrypt()}addLogData(e,t){if(!e||!t)return;const r=this.textEncoder.encode(e);this.processList.push(r),this.processList.push(t),this.processList.push(this.EOL)}async initEncrypt(){this.key=await crypto.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"]),this.iv=crypto.getRandomValues(new Uint8Array(12));const e=new Uint8Array(await crypto.subtle.exportKey("raw",this.key)),t=new Uint8Array([0]);this.writeLog("v"),this.writeLog(this.EOL),this.writeLog(o(t.buffer)),this.writeLog(this.EOL);const r=[e,this.iv];this.writeLog("h"),this.writeLog(this.EOL),this.writeLog(o(this.mergeBuffer(r).buffer)),this.writeLog(this.EOL),this.startProcess()}mergeBuffer(e){const t=e.reduce((e,t)=>e+t.length,0),r=new Uint8Array(t);let i=0;for(const t of e)r.set(t,i),i+=t.length;return r}async encryptData(e){await this.initEncryptPromise;return await crypto.subtle.encrypt({name:"AES-GCM",iv:this.iv},this.key,e)}startProcess(){requestAnimationFrame(this.process)}}var h=r(0);r.d(t,"BaseLogAgent",(function(){return c})),r.d(t,"LocalLogAgent",(function(){return l})),r.d(t,"WsLogAgent",(function(){return d})),r.d(t,"getLogAgent",(function(){return f}));class c{constructor(e){this.port=null,this.cache=[],this.stopCache=!1,e&&(this.logProcesser=new u(this.writeLog.bind(this)))}readyForLog(){}sendLog(e){}writeLog(e){this.readyForLog()?(this.stopCache||(this.cache.forEach(e=>this.sendLog(e)),this.clearCache()),this.sendLog(e)):this.stopCache||this.cache.push(e)}clearCache(){this.stopCache=!0,this.cache=[]}getTime(){const e=new Date;return e.getHours()+":"+e.getMinutes()+":"+e.getSeconds()+":"+e.getMilliseconds()}getLogData(e,t,r){if(t){var i=new Uint8Array(r?t+1:t),a=Object(h.a)().subarray(e+0,e+t);return i.set(a,0,t),r&&(i[t]=10),i}return e.data}writeWasmLog(e,t){const r=this.getTime(),i=this.getLogData(e,t);this.logProcesser?this.logProcesser.addLogData(r,i):(this.writeLog(r),this.writeLog(i),this.writeLog("\n"))}}class l extends c{constructor(){super(!0),this.port=null,this.ready=!1}init(){let e=0;const t=r=>{"local_log_port"===r.data.command?this.port||(this.port=r.data.data):"local_log_ready"===r.data.command&&(this.ready=!0,self.removeEventListener("message",t),clearTimeout(e),this.stopCache||(this.cache.forEach(e=>this.sendLog(e)),this.clearCache()))};self.addEventListener("message",t),e=setTimeout(()=>{self.removeEventListener("message",t),this.clearCache()},6e4)}readyForLog(){return!!this.port&&this.ready}sendLog(e){this.port.postMessage(e)}}class d extends c{constructor(){super(),this.wsUrl="ws://localhost:8080/echo/",this.ws_log=null}init(e){let{workerType:t}=e,r=0;this.ws_log=new WebSocket(this.wsUrl+a[t]+".log"),this.ws_log.addEventListener("open",()=>{clearTimeout(r),1===this.ws_log.readyState&&(this.stopCache||(this.cache.forEach(e=>this.sendLog(e)),this.clearCache()))}),r=setTimeout(()=>{this.ws_log&&1===this.ws_log.readyState||this.clearCache()},6e4)}readyForLog(){return!(!this.ws_log||1!==this.ws_log.readyState)}sendLog(e){this.ws_log.send(e)}}function f(){let e=!1;try{e=!1}catch(e){}return e?new l:null}}]);
//# sourceMappingURL=https://d1cdksi819e9z7.cloudfront.net/sourcemap/vb_worker.min.js-166e61b1b887fbe3870c.map