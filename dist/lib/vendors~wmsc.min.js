(window.webpackJsonpJsMediaSDK_Instance=window.webpackJsonpJsMediaSDK_Instance||[]).push([[4],{95:function(e,t,i){"use strict";function r(){r=function(){return e};var e={},t=Object.prototype,i=t.hasOwnProperty,n=Object.defineProperty||function(e,t,i){e[t]=i.value},a="function"==typeof Symbol?Symbol:{},s=a.iterator||"@@iterator",o=a.asyncIterator||"@@asyncIterator",d=a.toStringTag||"@@toStringTag";function c(e,t,i){return Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,i){return e[t]=i}}function u(e,t,i,r){var a=t&&t.prototype instanceof p?t:p,s=Object.create(a.prototype),o=new C(r||[]);return n(s,"_invoke",{value:y(e,i,o)}),s}function h(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(e){return{type:"throw",arg:e}}}e.wrap=u;var l={};function p(){}function m(){}function g(){}var v={};c(v,s,(function(){return this}));var f=Object.getPrototypeOf,S=f&&f(f(w([])));S&&S!==t&&i.call(S,s)&&(v=S);var _=g.prototype=p.prototype=Object.create(v);function I(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function r(n,a,s,o){var d=h(e[n],e,a);if("throw"!==d.type){var c=d.arg,u=c.value;return u&&"object"==typeof u&&i.call(u,"__await")?t.resolve(u.__await).then((function(e){r("next",e,s,o)}),(function(e){r("throw",e,s,o)})):t.resolve(u).then((function(e){c.value=e,s(c)}),(function(e){return r("throw",e,s,o)}))}o(d.arg)}var a;n(this,"_invoke",{value:function(e,i){function n(){return new t((function(t,n){r(e,i,t,n)}))}return a=a?a.then(n,n):n()}})}function y(e,t,i){var r="suspendedStart";return function(n,a){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===n)throw a;return{value:void 0,done:!0}}for(i.method=n,i.arg=a;;){var s=i.delegate;if(s){var o=M(s,i);if(o){if(o===l)continue;return o}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if("suspendedStart"===r)throw r="completed",i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);r="executing";var d=h(e,t,i);if("normal"===d.type){if(r=i.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:i.done}}"throw"===d.type&&(r="completed",i.method="throw",i.arg=d.arg)}}}function M(e,t){var i=t.method,r=e.iterator[i];if(void 0===r)return t.delegate=null,"throw"===i&&e.iterator.return&&(t.method="return",t.arg=void 0,M(e,t),"throw"===t.method)||"return"!==i&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+i+"' method")),l;var n=h(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function R(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function E(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function C(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(R,this),this.reset(!0)}function w(e){if(e){var t=e[s];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var r=-1,n=function t(){for(;++r<e.length;)if(i.call(e,r))return t.value=e[r],t.done=!1,t;return t.value=void 0,t.done=!0,t};return n.next=n}}return{next:T}}function T(){return{value:void 0,done:!0}}return m.prototype=g,n(_,"constructor",{value:g,configurable:!0}),n(g,"constructor",{value:m,configurable:!0}),m.displayName=c(g,d,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===m||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,g):(e.__proto__=g,c(e,d,"GeneratorFunction")),e.prototype=Object.create(_),e},e.awrap=function(e){return{__await:e}},I(b.prototype),c(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,i,r,n,a){void 0===a&&(a=Promise);var s=new b(u(t,i,r,n),a);return e.isGeneratorFunction(i)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},I(_),c(_,d,"Generator"),c(_,s,(function(){return this})),c(_,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=Object(e),i=[];for(var r in t)i.push(r);return i.reverse(),function e(){for(;i.length;){var r=i.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},e.values=w,C.prototype={constructor:C,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(E),!e)for(var t in this)"t"===t.charAt(0)&&i.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function r(i,r){return s.type="throw",s.arg=e,t.next=i,r&&(t.method="next",t.arg=void 0),!!r}for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n],s=a.completion;if("root"===a.tryLoc)return r("end");if(a.tryLoc<=this.prev){var o=i.call(a,"catchLoc"),d=i.call(a,"finallyLoc");if(o&&d){if(this.prev<a.catchLoc)return r(a.catchLoc,!0);if(this.prev<a.finallyLoc)return r(a.finallyLoc)}else if(o){if(this.prev<a.catchLoc)return r(a.catchLoc,!0)}else{if(!d)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return r(a.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var n=this.tryEntries[r];if(n.tryLoc<=this.prev&&i.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var a=n;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var s=a?a.completion:{};return s.type=e,s.arg=t,a?(this.method="next",this.next=a.finallyLoc,l):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.finallyLoc===e)return this.complete(i.completion,i.afterLoc),E(i),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.tryLoc===e){var r=i.completion;if("throw"===r.type){var n=r.arg;E(i)}return n}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,i){return this.delegate={iterator:w(e),resultName:t,nextLoc:i},"next"===this.method&&(this.arg=void 0),l}},e}function n(e,t,i,r,n,a,s){try{var o=e[a](s),d=o.value}catch(e){return void i(e)}o.done?t(d):Promise.resolve(d).then(r,n)}function a(e){return function(){var t=this,i=arguments;return new Promise((function(r,a){var s=e.apply(t,i);function o(e){n(s,r,a,o,d,"next",e)}function d(e){n(s,r,a,o,d,"throw",e)}o(void 0)}))}}function s(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,(void 0,"symbol"==typeof(n=function(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t);if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(r.key,"string"))?n:String(n)),r)}var n}function o(e,t,i){return t&&s(e.prototype,t),i&&s(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function d(){return(d=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(e[r]=i[r])}return e}).apply(this,arguments)}function c(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,r=new Array(t);i<t;i++)r[i]=e[i];return r}function u(e,t){var i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(i)return(i=i.call(e)).next.bind(i);if(Array.isArray(e)||(i=function(e,t){if(e){if("string"==typeof e)return c(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?c(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var r=0;return function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}i.r(t),i.d(t,"Wmsc",(function(){return je})),i.d(t,"eventExt",(function(){return h})),i.d(t,"eventOut",(function(){return l}));var h,l,p,m,g,v,f,S,_,I,b,y,M=new(function(){function e(){this.confId=void 0,this.nodeId=void 0,this.maxCaptureVideoSize=void 0,this.maxRecvVideoNum=void 0,this.hdVideoEnabled=void 0,this._enabledLayerIds=void 0,this._layersSettings=void 0,this.videoSettings=void 0,this.qosOptions=void 0,this.confId="",this.nodeId="",this.maxCaptureVideoSize=4,this.maxRecvVideoNum=25,this.hdVideoEnabled=!1,this.videoSettings=null,this._enabledLayerIds=[],this._layersSettings=null}var t=e.prototype;return t.setConfig=function(e){var t=e.confId,i=e.nodeId,r=e.maxCaptureResolution,n=e.maxVideoReceiveNum,a=e.HDVideo,s=e.videoSettings,o=e.qosOptions;void 0!==t&&(this.confId=t),void 0!==i&&(this.nodeId=i),void 0!==r&&(this.maxCaptureVideoSize=r),void 0!==n&&(this.maxRecvVideoNum=n),void 0!==a&&(this.hdVideoEnabled=a),void 0!==s&&(this.videoSettings=s),void 0!==o&&(this.qosOptions=o)},t.getConfig=function(){return{confId:this.confId,nodeId:this.nodeId,maxRecvVideoNum:this.maxRecvVideoNum,hdVideoEnabled:this.hdVideoEnabled,videoSettings:this.videoSettings,qosOptions:this.qosOptions}},t.setEnabledLayerIds=function(e){this._enabledLayerIds=e},t.setLayersSettings=function(e){this._layersSettings=e},o(e,[{key:"enabledLayerIds",get:function(){return this._enabledLayerIds}},{key:"layersSettings",get:function(){return this._layersSettings}}]),e}());function R(e,t){return E.apply(this,arguments)}function E(){return(E=a(r().mark((function e(t,n){var a,s,o,d,c;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=(new TextEncoder).encode(t),!window.CompressionStream){e.next=9;break}return s=new CompressionStream(n),(o=s.writable.getWriter()).write(a),o.close(),e.abrupt("return",new Response(s.readable).arrayBuffer());case 9:return e.next=11,i.e(0).then(i.bind(null,94));case 11:return d=e.sent,c=d.gzip,e.abrupt("return",c(a).buffer);case 14:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function C(e,t){return w.apply(this,arguments)}function w(){return(w=a(r().mark((function e(t,n){var a,s,o,d;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!window.DecompressionStream){e.next=8;break}return a=new DecompressionStream(n),(s=a.writable.getWriter()).write(t),s.close(),e.abrupt("return",new Response(a.readable).arrayBuffer().then((function(e){return(new TextDecoder).decode(e)})));case 8:return e.next=10,i.e(0).then(i.bind(null,94));case 10:return o=e.sent,d=o.ungzip,e.abrupt("return",(new TextDecoder).decode(d(t).buffer));case 13:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function T(e){for(var t="",i=new Uint8Array(e),r=0;r<i.byteLength;r++)t+=String.fromCharCode(i[r]);return btoa(t)}function L(e){for(var t=atob(e),i=new Uint8Array(t.length),r=0;r<i.length;r++)i[r]=t.charCodeAt(r);return i.buffer}function x(e,t){return D.apply(this,arguments)}function D(){return(D=a(r().mark((function e(t,i){var n;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=i,e.next=e.t0===y.GZIP_BASE64?3:e.t0===y.PLAIN?7:8;break;case 3:return e.next=5,R(t,"gzip");case 5:return n=e.sent,e.abrupt("return",T(n));case 7:return e.abrupt("return",t);case 8:return e.abrupt("return",null);case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function B(e,t){return P.apply(this,arguments)}function P(){return(P=a(r().mark((function e(t,i){var n;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=i,e.next=e.t0===y.GZIP_BASE64?3:e.t0===y.PLAIN?5:6;break;case 3:return n=L(t),e.abrupt("return",C(n,"gzip"));case 5:return e.abrupt("return",t);case 6:return e.abrupt("return",null);case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function A(e,t){return e.length===t.length&&e.every((function(e,i){return e===t[i]}))}function O(e,t){return e-t}function N(e,t){return void 0===t&&(t="|"),e?e.toString().replaceAll(/[,ï¼Œ]/g,t):""}!function(e){e.NOTIFY_SDK_JOIN_RWG_SUCCESS="NOTIFY_SDK_JOIN_RWG_SUCCESS",e.NOTIFY_SDK_JOIN_RWG_FAILURE="NOTIFY_SDK_JOIN_RWG_FAILURE",e.VIDEO_STREAMS="VIDEO_STREAMS",e.WMSC_MESSAGE_FROM_RWG="WMSC_MESSAGE_FROM_RWG",e.NOTIFY_WMSC_VIDEO_TAG_MAPPING="NOTIFY_WMSC_VIDEO_TAG_MAPPING",e.NOTIFY_SDK_SUBSCRIBE_VIDEO="NOTIFY_SDK_SUBSCRIBE_VIDEO",e.NOTIFY_SDK_UNSUBSCRIBE_VIDEO="NOTIFY_SDK_UNSUBSCRIBE_VIDEO",e.NOTIFY_SDK_ACTIVE_VIDEO_INDICATION="NOTIFY_SDK_ACTIVE_VIDEO_INDICATION",e.UPDATE_WMSC_PARAMS="UPDATE_WMSC_PARAMS"}(h||(h={})),function(e){e.ERROR="ERROR",e.WMSC_MESSAGE_TO_RWG_BY_SDK="WMSC_MESSAGE_TO_RWG_BY_SDK",e.WMSC_MAPPING_STREAMID_AND_MID="WMSC_MAPPING_STREAMID_AND_MID",e.GLOBAL_TRACE="GLOBAL_TRACE",e.MONITOR="MONITOR",e.DIRECT_MONITOR="DIRECT_MONITOR",e.SDP_NEGOTIATION_FAIL="SDP_NEGOTIATION_FAIL",e.CREATE_VIDEO_STREAMS_SUCCESS="CREATE_VIDEO_STREAMS_SUCCESS",e.CREATE_VIDEO_STREAMS_FAIL="CREATE_VIDEO_STREAMS_FAIL",e.V_RECEV_PC_CONNECTED="V_RECEV_PC_CONNECTED",e.V_SEND_PC_CONNECTED="V_SEND_PC_CONNECTED",e.VIDEO_SOURCE_UPDATED="VIDEO_SOURCE_UPDATED",e.VIDEO_TAG_MAPPED="VIDEO_TAG_MAPPED",e.VIDEO_QOS_DATA="VIDEO_QOS_DATA",e.UPDATE_VIDEO_CAPTURE_CONSTRAINTS="UPDATE_VIDEO_CAPTURE_CONSTRAINTS"}(l||(l={})),function(e){e[e.ERROR=0]="ERROR",e[e.WARN=1]="WARN",e[e.INFO=2]="INFO",e[e.DEBUG=3]="DEBUG",e[e.VERBOSE=4]="VERBOSE"}(p||(p={})),function(e){e[e._90P=0]="_90P",e[e._180P=1]="_180P",e[e._360P=2]="_360P",e[e._720P=3]="_720P",e[e._1080P=4]="_1080P",e[e._2160P=5]="_2160P"}(m||(m={})),function(e){e[e.AUDIO=1]="AUDIO",e[e.VIDEO=2]="VIDEO",e[e.SHARE=3]="SHARE"}(g||(g={})),function(e){e[e.VIDEO=1]="VIDEO",e[e.AUDIO=2]="AUDIO",e[e.SHARE=3]="SHARE"}(v||(v={})),function(e){e[e.INGRESS=0]="INGRESS",e[e.EGRESS=1]="EGRESS"}(f||(f={})),function(e){e[e.IDLE=0]="IDLE",e[e.CONNECTING=1]="CONNECTING",e[e.CONNECTED=2]="CONNECTED"}(S||(S={})),function(e){e.STREAM="STREAM",e.SDP="SDP",e.PC_STATE_CHANGE="PC_STATE_CHANGE",e.ERROR="ERROR"}(_||(_={})),function(e){e.LAYERS_UPDATE="LAYERS_UPDATE",e.MIN_BITRATE_UPDATE="MIN_BITRATE_UPDATE",e.ENCODER_RESET="ENCODER_RESET"}(I||(I={})),function(e){e[e.NONE=0]="NONE",e[e.UNDERUSING=1]="UNDERUSING",e[e.NORMAL=2]="NORMAL",e[e.OVERUSING=3]="OVERUSING"}(b||(b={})),function(e){e[e.PLAIN=0]="PLAIN",e[e.GZIP_BASE64=1]="GZIP_BASE64"}(y||(y={}));var V=new(function(){function e(){this.setTrace()}var t=e.prototype;return t.setTrace=function(e,t){var i=this;t&&(t.log||t.info)&&t.error&&t.warn?(this.log=t.log||t.info,this.info=t.info||t.log,this.debug=t.debug||t.log,this.verbose=this._verbose,this.error=t.error,this.warn=t.warn):(this.verbose=this._verbose.bind(this),this.log=this._log.bind(this),this.info=this._info.bind(this),this.debug=this._debug.bind(this),this.error=this._error.bind(this),this.warn=this._warn.bind(this)),this.level=e||p.INFO,this.level=this.level<p.ERROR?p.ERROR:this.level,this.level=this.level>p.VERBOSE?p.VERBOSE:this.level,this.getLevel=function(){return i.level},this._trace=function(e,t){var i,r,n,a,s;switch(e){case"log":(i=console).log.apply(i,t);break;case"debug":(r=console).debug.apply(r,t);break;case"info":(n=console).info.apply(n,t);break;case"warn":(a=console).warn.apply(a,t);break;case"error":(s=console).error.apply(s,t)}}},t.getTracer=function(e){return{log:function(){},debug:function(){},info:function(){},warn:function(){},error:function(){}}},t.setTelemetry=function(e){this._telemetry="function"==typeof e?e:null},t.monitorLog=function(e){e&&this._telemetry&&this._telemetry({type:l.MONITOR,data:e})},t.directSendMonitorLog=function(e){e&&this._telemetry&&this._telemetry({type:l.DIRECT_MONITOR,data:e})},t.globalTrace=function(e){e&&this._telemetry&&this._telemetry({type:l.GLOBAL_TRACE,data:e})},t._verbose=function(){if(this.level>=p.VERBOSE){var e=Array.prototype.slice.call(arguments);return e.unshift("[VERBOSE]"),this._trace("log",e),!0}return!1},t._debug=function(){return this.level>=p.DEBUG&&(this._trace("debug",arguments),!0)},t._log=function(){return this.level>=p.INFO&&(this._trace("log",arguments),!0)},t._info=function(){return this.level>=p.INFO&&(this._trace("info",arguments),!0)},t._warn=function(){return this.level>=p.WARN&&(this._trace("warn",arguments),!0)},t._error=function(){return this.level>=p.ERROR&&(this._trace("error",arguments),!0)},e}()),U=function(){function e(){}return e.splitSections=function(e){return e.split("\r\nm=").map((function(e,t){return t>0?"m="+e:e}))},e.splitLines=function(e){return e.split("\r\n")},e.parseVersionLine=function(e){return parseInt(e.substring(2),10)},e.writeVersionLine=function(e){return"v="+e},e.parseOriginLine=function(e){var t=e.substring(2).split(" "),i=t[0],r=t[1],n=t[2],a=t[3],s=t[4],o=t[5];return{userName:i,sessionId:r,sessionVersion:parseInt(n,10),netType:a,addressType:s,address:o}},e.writeOriginLine=function(e){return"o="+e.userName+" "+e.sessionId+" "+e.sessionVersion+" "+e.netType+" "+e.addressType+" "+e.address},e.parseSessionNameLine=function(e){return e.substring(2)},e.writeSessionNameLine=function(e){return"s="+e},e.parseInformationLine=function(e){return e.substring(2)},e.writeInformationLine=function(e){return"i="+e},e.parseConnectionLine=function(e){var t=e.substring(2).split(" ");return{netType:t[0],addressType:t[1],address:t[2]}},e.writeConnectionLine=function(e){return"c="+e.netType+" "+e.addressType+" "+e.address},e.parseBandwidthLine=function(e){return parseInt(e.substring(7),10)},e.writeBandwidthLine=function(e){return"b=TIAS:"+e},e.parseTimingLine=function(e){var t=e.substring(2).split(" "),i=t[0],r=t[1];return{startTime:parseInt(i,10),stopTime:parseInt(r,10)}},e.writeTimingLine=function(e){return"t="+e.startTime+" "+e.stopTime},e.parseRtpMapLine=function(e){var t=e.substring(9).match(/^(\d+) (.*)/),i=t[2].split("/");return{payloadType:parseInt(t[1],10),codecName:i[0],clockRate:parseInt(i[1],10),channels:i.length>=3?parseInt(i[2],10):null}},e.writeRtpMapLine=function(e){var t=e.payloadType,i=e.codecName,r=e.clockRate,n=e.channels,a="a=rtpmap:"+t+" "+i+"/"+r;return null!=n&&(a+="/"+n),a},e.parseFmtpLine=function(e){var t=e.substring(7).match(/^(\d+) (.*)/),i={payloadType:parseInt(t[1],10)};return t[2].includes("=")?i.params=new Map(t[2].split(";").map((function(e){return e.trim().split("=")}))):i.plain=t[2],i},e.writeFmtpLine=function(e){var t=e.payloadType,i=e.params,r=e.plain,n="a=fmtp:"+t+" ";return i?(i.forEach((function(e,t){null!=e&&(n+=t+"="+e+";")})),n=n.slice(0,-1)):n+=r,n},e.parseRtcpFbLine=function(e){var t=e.substring(10).match(/^(\d+) (.*)/);return{payloadType:parseInt(t[1],10),params:t[2].split(" ")}},e.writeRtcpFbLine=function(e){var t=e.payloadType,i=e.params,r="a=rtcp-fb:"+t;return i.forEach((function(e){r+=" "+e})),r},e.parseRidLine=function(e){var t=e.substring(6).match(/^(\S+) (send|recv)/);return{rid:t[1],direction:t[2]}},e.writeRidLine=function(e){return"a=rid:"+e.rid+" "+e.direction},e.parseSimulcastLine=function(e){var t=e.substring(12).match(/^(send|recv) (.*)/);return{direction:t[1],rids:t[2].split(";").map((function(e){return"~"===e[0]?{id:e.substring(1),paused:!0}:{id:e,paused:!1}}))}},e.writeSimulcastLine=function(e){var t=e.direction,i=e.rids,r="a=simulcast:"+t+" ";return i.forEach((function(e){var t=e.paused?"~"+e.id:e.id;r+=t+";"})),r.slice(0,-1)},e.parseExtensionMapLine=function(e){var t=e.substring(9).match(/^(\d+)(\/sendrecv|\/sendonly|\/recvonly|\/inactive)? (\S+)(\s\S+)?/);return{id:parseInt(t[1],10),direction:t[2]?t[2].substring(1):null,uri:t[3],attributes:t[4]?t[4].trimStart():null}},e.writeExtensionMapLine=function(e){var t=e.id,i=e.direction,r=e.uri,n=e.attributes,a="a=extmap:"+t;return null!=i&&(a+="/"+i),a+=" "+r,null!=n&&(a+=" "+n),a},e.parseMidLine=function(e){return e.substring(6)},e.writeMidLine=function(e){return"a=mid:"+e},e.writeDirectionLine=function(e){return"a="+e},e.parseMsidLine=function(e){var t=e.substring(7).split(" ");return{streamId:t[0],trackId:t[1]}},e.writeMsidLine=function(e){return"a=msid:"+e.streamId+" "+e.trackId},e.parseSsrcLine=function(e){var t=e.indexOf(" ");return{ssrc:parseInt(e.substring(7,t),10),attribute:e.substring(t+1)}},e.writeSsrcLine=function(e){return"a=ssrc:"+e.ssrc+" "+e.attribute},e.parseSsrcGroupLine=function(e){var t=e.substring(13).split(" ");return{semantics:t.shift(),ssrcs:t}},e.writeSsrcGroupLine=function(e){var t=e.semantics,i=e.ssrcs,r="a=ssrc-group:"+t;return i.forEach((function(e){r+=" "+e})),r},e.parseGroupLine=function(e){var t=e.indexOf(" ");return{semantics:e.substring(8,t),ids:e.substring(t+1).split(" ")}},e.writeGroupLine=function(e){var t=e.semantics,i=e.ids,r="a=group:"+t;return i.forEach((function(e){r+=" "+e})),r},e.writeExtMapAllowMixedLine=function(){return"a=extmap-allow-mixed"},e.writeRtcpMuxLine=function(){return"a=rtcp-mux"},e.writeRtcpReducedSizeLine=function(){return"a=rtcp-rsize"},e.parseCandidateLine=function(e){var t=e.substring(12).split(" "),i={foundation:t[0],componentId:parseInt(t[1],10),transport:t[2],priority:parseInt(t[3],10),address:t[4],port:parseInt(t[5],10),candType:t[6],type:t[7],relAddress:null,relPort:null,candExtensions:[]};return"raddr"===t[8]&&"rport"===t[10]?(i.relAddress=t[9],i.relPort=parseInt(t[11],10),i.candExtensions=t.slice(12)):i.candExtensions=t.slice(8),i},e.writeCandidateLine=function(e){var t=e.foundation,i=e.componentId,r=e.transport,n=e.priority,a=e.address,s=e.port,o=e.candType,d=e.type,c=e.relAddress,u=e.relPort,h=e.candExtensions,l="a=candidate:"+t+" "+i+" "+r+" "+n+" "+a+" "+s+" "+o+" "+d;return null!=c&&null!=u&&(l+=" raddr "+c+" rport "+u),h.length&&(l+=" "+h.join(" ")),l},e.parseSessionSection=function(e){for(var t={version:0,origin:null,sessionName:null,information:null,connection:null,bandwidth:null,timing:null,groups:[],extMapAllowMixed:null,otherLines:[]},i=this.splitLines(e),r=0;r<i.length;r++){var n=i[r];n.length&&(n.match(/^v=/)?t.version=this.parseVersionLine(n):n.match(/^o=/)?t.origin=this.parseOriginLine(n):n.match(/^s=/)?t.sessionName=this.parseSessionNameLine(n):n.match(/^i=/)?t.information=this.parseInformationLine(n):n.match(/^c=/)?t.connection=this.parseConnectionLine(n):n.match(/^b=TIAS:/)?t.bandwidth=this.parseBandwidthLine(n):n.match(/^t=/)?t.timing=this.parseTimingLine(n):n.match(/^a=group:/)?t.groups.push(this.parseGroupLine(n)):n.match(/^a=extmap-allow-mixed$/)?t.extMapAllowMixed=!0:t.otherLines.push(n))}return t},e.writeSessionSection=function(e){var t=this,i=[];return i.push(this.writeVersionLine(e.version)),null!=e.origin&&i.push(this.writeOriginLine(e.origin)),null!=e.sessionName&&i.push(this.writeSessionNameLine(e.sessionName)),null!=e.information&&i.push(this.writeInformationLine(e.information)),null!=e.connection&&i.push(this.writeConnectionLine(e.connection)),null!=e.bandwidth&&i.push(this.writeBandwidthLine(e.bandwidth)),null!=e.timing&&i.push(this.writeTimingLine(e.timing)),e.groups.forEach((function(e){i.push(t.writeGroupLine(e))})),e.extMapAllowMixed&&i.push(this.writeExtMapAllowMixedLine()),e.otherLines.length&&i.push.apply(i,e.otherLines),i.join("\r\n")+"\r\n"},e.parseMediaSection=function(e){var t=this,i={type:null,port:null,protocol:null,connection:null,bandwidth:null,mid:null,direction:null,msid:null,rtcpMux:null,rtcpReducedSize:null,codecs:[],extensionMap:new Map,rids:[],simulcast:null,ssrcs:[],ssrcGroups:[],candidates:[],otherLines:[]},r=[],n=[],a=this.splitLines(e),s=a[0].split(" ");i.type=s[0].substring(2),i.port=parseInt(s[1],10),i.protocol=s[2],i.payloadTypes=s.slice(3).map((function(e){return parseInt(e,10)}));for(var o=1;o<a.length;o++){var c,u=a[o];if(u.length)if(u.match(/^c=/))i.connection=this.parseConnectionLine(u);else if(u.match(/^b=TIAS:/))i.bandwidth=this.parseBandwidthLine(u);else if(u.match(/^a=rtpmap:/)){var h=this.parseRtpMapLine(u);i.codecs.push(d({},h,{codecParams:new Map,fmtpLines:[],rtcpFbParams:[]}))}else if(u.match(/^a=fmtp:/))r.push(u);else if(u.match(/^a=rtcp-fb:/))n.push(u);else if(u.match(/^a=rid:/))i.rids.push(this.parseRidLine(u));else if(u.match(/^a=simulcast:/))i.simulcast=this.parseSimulcastLine(u);else if(u.match(/^a=ssrc:/))i.ssrcs.push(this.parseSsrcLine(u));else if(u.match(/^a=ssrc-group:/))i.ssrcGroups.push(this.parseSsrcGroupLine(u));else if(u.match(/^a=extmap:/)){var l=this.parseExtensionMapLine(u);i.extensionMap.set(l.id,l)}else u.match(/^a=mid:/)?i.mid=this.parseMidLine(u):(c=u.match(/^a=(sendrecv|sendonly|recvonly|inactive)/))?i.direction=c[1]:u.match(/^a=msid:/)?i.msid=this.parseMsidLine(u):u.match(/^a=rtcp-mux$/)?i.rtcpMux=!0:u.match(/^a=rtcp-rsize$/)?i.rtcpReducedSize=!0:u.match(/^a=candidate:/)?i.candidates.push(this.parseCandidateLine(u)):i.otherLines.push(u)}return r.forEach((function(e){var r=t.parseFmtpLine(e),n=i.codecs.find((function(e){return e.payloadType===r.payloadType}));n&&(r.params?r.params.forEach((function(e,t){"apt"===t&&(n.associatedPayloadType=parseInt(e,10)),n.codecParams.set(t,e)})):(n.fmtpLines.push(r.plain),"red"===n.codecName&&(n.associatedPayloadType=parseInt(r.plain.split("/")[0],10))))})),n.forEach((function(e){var r=t.parseRtcpFbLine(e),n=i.codecs.find((function(e){return e.payloadType===r.payloadType}));n&&n.rtcpFbParams.push(r.params)})),i},e.writeMediaSection=function(e){var t=this,i=[],r="m="+e.type+" "+e.port+" "+e.protocol;return e.payloadTypes.forEach((function(e){r+=" "+e})),i.push(r),e.connection&&i.push(this.writeConnectionLine(e.connection)),e.bandwidth&&i.push(this.writeBandwidthLine(e.bandwidth)),e.otherLines.length&&i.push.apply(i,e.otherLines),i.push(this.writeMidLine(e.mid)),e.extensionMap.size&&e.extensionMap.forEach((function(e,r){i.push(t.writeExtensionMapLine(e))})),i.push(this.writeDirectionLine(e.direction)),e.msid&&i.push(this.writeMsidLine(e.msid)),e.rtcpMux&&i.push(this.writeRtcpMuxLine()),e.rtcpReducedSize&&i.push(this.writeRtcpReducedSizeLine()),e.codecs.forEach((function(e){var r=e.payloadType,n=e.codecName,a=e.clockRate,s=e.channels,o=e.codecParams,d=e.fmtpLines,c=e.rtcpFbParams;i.push(t.writeRtpMapLine({payloadType:r,codecName:n,clockRate:a,channels:s})),c.forEach((function(e){i.push(t.writeRtcpFbLine({payloadType:r,params:e}))})),o.size&&i.push(t.writeFmtpLine({payloadType:r,params:o})),d.forEach((function(e){i.push(t.writeFmtpLine({payloadType:r,plain:e}))}))})),e.ssrcGroups.forEach((function(e){i.push(t.writeSsrcGroupLine(e))})),e.ssrcs.forEach((function(e){i.push(t.writeSsrcLine(e))})),e.rids.forEach((function(e){i.push(t.writeRidLine(e))})),e.candidates.forEach((function(e){i.push(t.writeCandidateLine(e))})),e.simulcast&&i.push(this.writeSimulcastLine(e.simulcast)),i.join("\r\n")+"\r\n"},e.parse=function(e){var t=this,i={session:null,media:[],application:[]},r=this.splitSections(e);return i.session=this.parseSessionSection(r.shift()),r.forEach((function(e){var r=t.parseMediaSection(e);"audio"!==r.type&&"video"!==r.type||i.media.push(r),"application"===r.type&&i.application.push(r)})),i},e.write=function(e){var t=this,i=this.writeSessionSection(e.session);return e.media.forEach((function(e){i+=t.writeMediaSection(e)})),e.application.forEach((function(e){i+=t.writeMediaSection(e)})),i},e}(),k=function(){function e(){this.browser=void 0,this.browserVersion=void 0,this.os=void 0,this.osVersion=void 0,this.hardwareConcurrency=navigator.hardwareConcurrency||1,this.isMobile=this._isMobile(navigator.userAgent),this._getBrowserAndOSVersions(navigator.userAgent)}var t=e.prototype;return t._getBrowserAndOSVersions=function(t){var i=this;Object.keys(e.regex).forEach((function(r){var n=t.match(e.regex[r]);if(n)switch(r){case"iOS":i.os=r,i.osVersion=n[1].replace(/_/g,".");break;case"macOS":i.os=r;break;case"Windows":case"Android":case"ChromeOS":i.os=r,i.osVersion=n[1];break;case"Linux":t.match(e.regex.Android)||(i.os=r);break;case"SafariIOS":i.browser="Safari",i.browserVersion=n[1].split("/")[1],i.os="iOS",i.osVersion=n[2];break;default:i.browser=r,i.browserVersion=n[1]}}))},t._isMobile=function(e){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(e)},t.getMajorBrowserVersion=function(){var e,t=parseInt(null==(e=this.browserVersion)?void 0:e.split(".")[0],10);return isNaN(t)?void 0:t},t.getMinorBrowserVersion=function(){var e,t=parseInt(null==(e=this.browserVersion)?void 0:e.split(".")[1],10);return isNaN(t)?void 0:t},t.isBrowserVersionGreaterEqualThan=function(e,t){var i=this.getMajorBrowserVersion(),r=this.getMinorBrowserVersion();return i>e||i===e&&r>=t},t.getMajorOsVersion=function(){var e,t=parseInt(null==(e=this.osVersion)?void 0:e.split(".")[0],10);return isNaN(t)?void 0:t},t.getMinorOsVersion=function(){var e,t=parseInt(null==(e=this.osVersion)?void 0:e.split(".")[1],10);return isNaN(t)?void 0:t},t.isOsVersionGreaterEqualThan=function(e,t){var i=this.getMajorOsVersion(),r=this.getMinorOsVersion();return i>e||i===e&&r>=t},e}();k.regex={Chrome:/(?:Chrome|Chromium|CriOS)\/([\d.]+)/,Firefox:/(?:Firefox|FxiOS)\/([\d.]+)/,Safari:/Version\/([\d.]+)\sSafari/,SafariIOS:/(Version\/[\d.]+).*Mobile\/([\w]+)/,IE:/MSIE\s([\d.]+)/,Edge:/Edge\/([\d.]+)/,Opera:/(?:Opera|OPR)\/([\d.]+)/,Android:/Android\s([\d.]+)/,iOS:/(?:iPhone|iPad|iPod).*OS\s([\d_]+)/,Windows:/Windows NT\s([\d.]+)/,macOS:/Mac OS X\s([\d_.]+)/,Linux:/Linux/,ChromeOS:/CrOS/};var F=new k,W=function(){function e(){}return e.parseSdp=function(e){return U.parse(e)},e.writeSdp=function(e){return U.write(e)},e.generateSsrc=function(){return Math.floor(4294967294*Math.random())+1},e.generateId=function(){return Math.random().toString(36).substring(2,12)},e.generateSessionId=function(){return Math.random().toString().substring(2,22)},e.generateUuid=function(){var e=Array.from(Array(256).keys()).map((function(e){return e.toString(16).padStart(2,"0")})),t=crypto.getRandomValues(new Uint8Array(16));return t[6]=15&t[6]|64,t[8]=63&t[8]|128,Array.from(t.entries()).map((function(t){var i=t[0],r=t[1];return[4,6,8,10].includes(i)?"-"+e[r]:e[r]})).join("")},e.getSessionBoilerplate=function(){return"v=\r\no=- "+this.generateSessionId()+" 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},e.getNtpSeconds=function(){return Math.floor((Date.now()+(Date.UTC(1970,0,1)-Date.UTC(1900,0,1)))/1e3)},e.findHeaderExtensionByUri=function(e,t){for(var i,r=u(e.extensionMap);!(i=r()).done;){var n=i.value,a=n[0];if(n[1].uri===t)return a}return-1},e.addHeaderExtension=function(e,t){if(-1!==this.findHeaderExtensionByUri(e,t.uri))return!1;var i=0;e.extensionMap.forEach((function(e,t){t>i&&(i=t)}));var r=i+1;return e.extensionMap.set(r,d({id:r},t)),!0},e.removeHeaderExtensionByUri=function(e,t){var i=!1;return e.extensionMap.forEach((function(e,r,n){e.uri===t&&(n.delete(r),i=!0)})),i},e.removeMidRidHeaderExtensions=function(e){e.extensionMap.forEach((function(e,t,i){/^urn:ietf:params:rtp-hdrext:sdes:(?:mid|rtp-stream-id|repaired-rtp-stream-id)$/.test(e.uri)&&i.delete(t)}))},e.updateCodecParameters=function(e,t,i,r,n){e.media.filter((function(e){return e.type===t&&e.direction===i})).forEach((function(e){e.codecs.filter((function(e){return e.codecName===r})).forEach((function(e){n.forEach((function(t,i){e.codecParams.set(i,t)}))}))}))},e.filterCodecs=function(e,t){e.media.forEach((function(e){var i=[];e.codecs.forEach((function(e){t.includes(e.codecName)&&i.push(e.payloadType)})),e.codecs.forEach((function(e){i.includes(e.associatedPayloadType)&&i.push(e.payloadType)})),e.payloadTypes=e.payloadTypes.filter((function(e){return i.includes(e)})),e.codecs=e.codecs.filter((function(e){return i.includes(e.payloadType)}))})),e.media=e.media.filter((function(e){return e.payloadTypes.length}))},e.filterH264Profiles=function(e,t,i){e.media.filter((function(e){return e.direction===t})).forEach((function(e){var t=[];e.codecs.filter((function(e){return"H264"===e.codecName})).forEach((function(e){var r,n=parseInt(null==(r=e.codecParams.get("profile-level-id"))?void 0:r.substring(0,2),16);i.includes(n)&&t.push(e.payloadType)})),e.codecs.forEach((function(e){t.includes(e.associatedPayloadType)&&t.push(e.payloadType)})),e.payloadTypes=e.payloadTypes.filter((function(e){return t.includes(e)})),e.codecs=e.codecs.filter((function(e){return t.includes(e.payloadType)}))}))},e.getH264ProfileIds=function(e,t,i){var r=new Set,n=e.media.find((function(e){return"video"===e.type&&e.direction===t}));return null==n||n.codecs.forEach((function(e){if("H264"===e.codecName&&(void 0===i||parseInt(e.codecParams.get("packetization-mode"))===i)){var t,n=parseInt(null==(t=e.codecParams.get("profile-level-id"))?void 0:t.substring(0,2),16);n&&r.add(n)}})),Array.from(r.values())},e.mungeEgressLocalOffer=function(t,i){e.filterCodecs(t,["H264"]);var r=t.media.find((function(e){return"video"===e.type&&"sendonly"===e.direction}));if(!r)throw new Error("Failed to find a video media section for send");if(i>1){r.rids=[],r.simulcast=null,r.ssrcs=[],r.ssrcGroups=[];for(var n=r.codecs.some((function(e){return"rtx"===e.codecName})),a=[],s=e.generateUuid(),o="- "+e.generateUuid(),d=0;d<i;d++){var c=e.generateSsrc();if(a.push(c),r.ssrcs.push({ssrc:c,attribute:"cname:"+s}),r.ssrcs.push({ssrc:c,attribute:"msid:"+o}),n){var u=e.generateSsrc();r.ssrcs.push({ssrc:u,attribute:"cname:"+s}),r.ssrcs.push({ssrc:u,attribute:"msid:"+o}),r.ssrcGroups.push({semantics:"FID",ssrcs:[c,u]})}}r.ssrcGroups.push({semantics:"SIM",ssrcs:a})}e.removeMidRidHeaderExtensions(r),"iOS"===F.os&&15===F.getMajorOsVersion()&&1===F.getMinorOsVersion()||e.removeHeaderExtensionByUri(r,"urn:3gpp:video-orientation"),e.addHeaderExtension(r,{uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time"}),i>1&&(t.session.extMapAllowMixed=!0,e.addHeaderExtension(r,{uri:"http://www.webrtc.org/experiments/rtp-hdrext/video-layers-allocation00"}))},e.mungeEgressOfferToRemote=function(t){t.session.timing={startTime:e.getNtpSeconds(),stopTime:0}},e.mungeEgressAnswer=function(t,i){i&&e.updateCodecParameters(t,"video","recvonly","H264",i)},e.mungeIngressLocalOffer=function(t,i){i&&e.updateCodecParameters(t,"video","recvonly","H264",i)},e}(),z=[{layerId:4,width:1920,height:1080,maxFramerate:30,minBitrate:3e6,targetBitrate:4e6,maxBitrate:5e6},{layerId:4,width:1600,height:900,maxFramerate:30,minBitrate:15e5,targetBitrate:3e6,maxBitrate:35e5},{layerId:3,width:1280,height:720,maxFramerate:30,minBitrate:8e5,targetBitrate:2e6,maxBitrate:2e6},{layerId:3,width:960,height:540,maxFramerate:30,minBitrate:5e5,targetBitrate:8e5,maxBitrate:12e5},{layerId:2,width:640,height:360,maxFramerate:30,minBitrate:25e4,targetBitrate:5e5,maxBitrate:7e5},{layerId:2,width:480,height:270,maxFramerate:30,minBitrate:15e4,targetBitrate:35e4,maxBitrate:45e4},{layerId:1,width:320,height:180,maxFramerate:30,minBitrate:1e5,targetBitrate:15e4,maxBitrate:2e5},{layerId:1,width:256,height:144,maxFramerate:30,minBitrate:6e4,targetBitrate:1e5,maxBitrate:15e4},{layerId:0,width:160,height:90,maxFramerate:30,minBitrate:4e4,targetBitrate:8e4,maxBitrate:1e5}];function G(e){M.setLayersSettings(e)}function j(e){M.setEnabledLayerIds(e)}function H(){return M.layersSettings}function q(){return M.enabledLayerIds}function J(){return q()[0]}function Q(e){return q().includes(e)}function Y(){return q().at(-1)}function K(e){var t=H();if(t&&!(t.length<=e)){var i=t[e];return{width:i.width,height:i.height,maxFramerate:i.maxFramerate,minBitrate:i.minBitrate,targetBitrate:i.targetBitrate,maxBitrate:i.maxBitrate}}}function X(e){var t=H(),i=(null==t?void 0:t.findIndex((function(t){return t.layerId===e})))||-1;if(i>=0)return K(i)}function Z(e){var t;return(null==(t=X(e))?void 0:t.maxFramerate)||0}function $(e){var t;return(null==(t=X(e))?void 0:t.targetBitrate)||0}function ee(e){var t;return(null==(t=function(e){var t=H();if(t)for(var i=t.length-1;i>=0;i--)if(t[i].layerId===e)return K(i)}(e))?void 0:t.minBitrate)||0}function te(e,t){var i=X(e);if(i){var r=i.width,n=i.height,a=i.maxBitrate;return Math.floor(t.width*t.height/(r*n)*a)}}function ie(e){var t=Math.min(e.height,e.width);return t>720?4:t>360?3:t>180?2:t>90?1:t>0?0:-1}var re=function(){function e(e){this._array=new Array(e),this._size=e,this._index=0,this._count=0}var t=e.prototype;return t.empty=function(){return 0===this._count},t.full=function(){return this._count===this._size},t.clear=function(){this._array=new Array(this._size),this._index=0,this._count=0},t.fill=function(e){return this._array.fill(e),this._index=0,this._count=this._size,this},t.nextIndex=function(e){return(e+1)%this._size},t.push=function(e){this._array[this._index]=e,this._index=this.nextIndex(this._index),this._count<this._size&&this._count++},t.pop=function(){if(!this.empty()){var e=this.lastIndex;return this._index=e,this._size>0&&this._size--,this._array[e]}},t.at=function(e){if(!(this._count<this._size&&e>=this._count))return this._array[e]},t.front=function(){if(!this.empty())return this._array[this._count<this.size?0:this._index]},t.back=function(){if(!this.empty())return this._array[this.lastIndex]},t.unwrap=function(){return this._count<this._size?this._array.slice(0,this._count):[].concat(this._array.slice(this._index),this._array.slice(0,this._index))},t.findIndex=function(e){if(this._count<this._size){for(var t=0;t<this._count;t++)if(e(this._array[t]))return t}else{for(var i=this._index;i<this._size;i++)if(e(this._array[i]))return i;for(var r=0;r<this._index;r++)if(e(this._array[r]))return r}return-1},t.findLastIndex=function(e){if(this._count<this._size){for(var t=this._count-1;t>=0;t--)if(e(this._array[t]))return t}else{for(var i=this._size-1;i>=this._index;i--)if(e(this._array[i]))return i;for(var r=this._index-1;r>=0;r--)if(e(this._array[r]))return r}return-1},t.find=function(e){var t=this.findIndex(e);return-1===t?void 0:this._array[t]},t.findLast=function(e){var t=this.findLastIndex(e);return-1===t?void 0:this._array[t]},o(e,[{key:"size",get:function(){return this._size}},{key:"count",get:function(){return this._count}},{key:"lastIndex",get:function(){return 0===this._index?this._size-1:this._index-1}}]),e}();V.getTracer("WmscStats");var ne=function(){function e(){this.sendStatsMonitor=new ae({cacheSize:e.sendStatsCacheSize}),this.recvStatsMonitor=new se({cacheSize:e.recvStatsCacheSize}),this.sendUsageStatsEnabled=!1,this.recvUsageStatsEnabled=!1,this.resourceUsageStatsReportTimestamp=0,this.resourceUsageStatsIntervalId=null,this.outgoingBitrateStatsCallback=null,this.resourceUsageStatsCallback=null}var t=e.prototype;return t.getSendStatsMonitor=function(){return this.sendStatsMonitor},t.getRecvStatsMonitor=function(){return this.recvStatsMonitor},t.setOptions=function(e){var t=e||{},i=t.sendUsageStatsEnabled,r=t.recvUsageStatsEnabled;void 0!==i&&(this.sendUsageStatsEnabled=i),void 0!==r&&(this.recvUsageStatsEnabled=r)},t.start=function(t){var i=this;t&&this.setOptions(t),this.sendUsageStatsEnabled&&this.sendStatsMonitor.setOptions({outboundRtpStatsEnabled:!0}),this.sendStatsMonitor.start(),this.recvUsageStatsEnabled&&this.recvStatsMonitor.setOptions({inboundRtpStatsEnabled:!0}),this.recvStatsMonitor.start(),(this.sendUsageStatsEnabled||this.recvUsageStatsEnabled)&&(this.resourceUsageStatsIntervalId=setInterval((function(){i._reportResourceUsageStats()}),e.resourceUsageCheckInterval))},t.stop=function(){this.sendStatsMonitor.stop(),this.recvStatsMonitor.stop(),clearInterval(this.resourceUsageStatsIntervalId),this.resourceUsageStatsIntervalId=null},t.reset=function(){this.sendStatsMonitor.reset(),this.recvStatsMonitor.reset(),this.resourceUsageStatsReportTimestamp=0},t.registerOutgoingBitrateStatsCallback=function(e){this.sendStatsMonitor.outgoingBitrateStatsCallback=e},t.registerResourceUsageStatsCallback=function(e){this.resourceUsageStatsCallback=e},t._reportResourceUsageStats=function(){var e={},t=0;if(this.sendUsageStatsEnabled){var i=this._getSendResourceUsageStats();i&&(e.send=d({},i),t=Math.max(t,i.timestamp))}if(this.recvUsageStatsEnabled){var r=this._getRecvResourceUsageStats();r&&(e.recv=d({},r),t=Math.max(t,r.timestamp))}this.resourceUsageStatsReportTimestamp=t,this.resourceUsageStatsCallback(e)},t._getSendResourceUsageStats=function(){var t=this;if(this.sendStatsMonitor.isStarted()){for(var i,r=this.sendStatsMonitor.getOutboundRtpStats(),n=1e3/K(0).maxFramerate,a=0,s=0,o=0,d=b.NONE,c=function(){var r=i.value;r[0];var c=r[1],u=c.back(),h=Math.max(t.resourceUsageStatsReportTimestamp-500,u.timestamp-e.resourceUsageCheckInterval-500),l=c.find((function(e){return e.timestamp>h}));if(!l)return"continue";var p=u.framesEncoded-l.framesEncoded,m=u.timestamp-l.timestamp;if(0===p||m<e.resourceUsageMinTimeSlice)return"continue";var g,v,f=u.framesSent-l.framesSent,S=p?1e3*(u.totalEncodeTime-l.totalEncodeTime)/p:0,_=b.NONE,I=b.NONE,y=b.NONE;return I=p>f||p>=e.encodeTimeMinFrameCount&&S>=n*e.encodeTimeFactorThresholdCritical?b.OVERUSING:p<=f&&p>=e.encodeTimeMinFrameCount&&S<n*e.encodeTimeFactorThresholdNormal?b.UNDERUSING:b.NORMAL,u.qualityLimitationDurations&&(g=1e3*(u.qualityLimitationDurations.cpu-l.qualityLimitationDurations.cpu)/m,v=1e3*(u.qualityLimitationDurations.other-l.qualityLimitationDurations.other)/m,y=g>=e.qualityLimitationRatioThresholdCritical||v>=e.qualityLimitationRatioThresholdCritical?b.OVERUSING:g<e.qualityLimitationRatioThresholdNormal&&v<e.qualityLimitationRatioThresholdNormal?b.UNDERUSING:b.NORMAL),O(y,_=I)>0&&(_=y),a+=p,s+=f,o=Math.max(o,u.timestamp),O(_,d)>0&&(d=_),d===b.OVERUSING?"break":void 0},h=u(r);!(i=h()).done;){var l=c();if("continue"!==l&&"break"===l)break}return{usageState:d,framesEncoded:a,framesSent:s,timestamp:o}}},t._getRecvResourceUsageStats=function(){var t=this;if(this.recvStatsMonitor.isStarted()){for(var i,r=this.recvStatsMonitor.getInboundRtpStats(),n=0,a=0,s=0,o=0,d=b.NONE,c=function(){var r=i.value;r[0];var c=r[1],u=c.back(),h=Math.max(t.resourceUsageStatsReportTimestamp-500,u.timestamp-e.resourceUsageCheckInterval-500),l=c.find((function(e){return e.timestamp>h}));if(!l)return"continue";var p=u.timestamp-l.timestamp,m=u.framesReceived-l.framesReceived;if(0===m||p<e.resourceUsageMinTimeSlice)return"continue";var g=u.framesDropped-l.framesDropped,v=u.framesDecoded-l.framesDecoded,f=p/m,S=v?1e3*(u.totalDecodeTime-l.totalDecodeTime)/v:0,_=b.NONE;return n+=m,a+=g,s+=v,o=Math.max(o,u.timestamp),O(_=v>=e.decodeTimeMinFrameCount&&S>=f*e.decodeTimeFactorThresholdCritical?b.OVERUSING:v>=e.decodeTimeMinFrameCount&&S<f*e.decodeTimeFactorThresholdNormal?b.UNDERUSING:b.NORMAL,d)>0&&(d=_),d===b.OVERUSING?"break":void 0},h=u(r);!(i=h()).done;){var l=c();if("continue"!==l&&"break"===l)break}return{usageState:d,framesReceived:n,framesDropped:a,framesDecoded:s,timestamp:o}}},e}();ne.sendStatsCacheSize=6,ne.recvStatsCacheSize=6,ne.resourceUsageMinTimeSlice=4500,ne.resourceUsageCheckInterval=5e3,ne.encodeTimeMinFrameCount=20,ne.encodeTimeFactorThresholdNormal=.9,ne.encodeTimeFactorThresholdCritical=1.1,ne.qualityLimitationRatioThresholdNormal=.05,ne.qualityLimitationRatioThresholdCritical=.95,ne.decodeTimeMinFrameCount=20,ne.decodeTimeFactorThresholdNormal=.9,ne.decodeTimeFactorThresholdCritical=1.1;var ae=function(){function e(e){this.cacheSize=e.cacheSize||10,this.started=!1,this.selectedCandidatePairId=null,this.roundTripTime=0,this.remoteCandidateId=null,this.networkProtocol=null,this.outboundRtpStatsEnabled=!1,this.outboundRtpStatsMap=new Map}var t=e.prototype;return t.reset=function(){this.resetCandidateStats(),this.resetOutboundRtpStats()},t.resetCandidateStats=function(){this.selectedCandidatePairId=null,this.roundTripTime=0,this.remoteCandidateId=null,this.networkProtocol=null},t.resetOutboundRtpStats=function(){this.outboundRtpStatsMap.clear()},t.setOptions=function(e){var t=(e||{}).outboundRtpStatsEnabled;void 0!==t&&(this.outboundRtpStatsEnabled=t)},t.start=function(e){e&&this.setOptions(e),this.started=!0},t.stop=function(){this.started=!1},t.isStarted=function(){return this.started},t.getNetworkProtocol=function(){return this.networkProtocol},t.getCurrentRoundTripTime=function(){return this.roundTripTime},t.getOutboundRtpStats=function(){return this.outboundRtpStatsMap},t.onStatsReport=function(e){if(this.started)switch(e.type){case"transport":this.onTransportStats(e);break;case"candidate-pair":this.onCandidatePairStats(e);break;case"remote-candidate":this.onRemoteCandidateStats(e);break;case"outbound-rtp":this.onOutboundRtpStats(e)}},t.onTransportStats=function(e){var t=e.selectedCandidatePairId;"connected"===e.dtlsState&&(this.selectedCandidatePairId=t)},t.onCandidatePairStats=function(e){var t=e.id,i=e.state,r=e.nominated,n=e.availableOutgoingBitrate,a=e.currentRoundTripTime,s=e.remoteCandidateId,o=e.timestamp;t===this.selectedCandidatePairId&&"succeeded"===i&&r&&(this.roundTripTime=a,this.remoteCandidateId=s,n&&this.outgoingBitrateStatsCallback({availableOutgoingBitrate:n,timestamp:o}))},t.onRemoteCandidateStats=function(e){var t=e.id,i=e.protocol,r=e.port;t!==this.remoteCandidateId||this.networkProtocol||(this.networkProtocol=i,V.globalTrace({logLevel:"directReport",log:"WMSC_Network_Change: send|"+i+"|"+r}))},t.onOutboundRtpStats=function(e){if(this.outboundRtpStatsEnabled){var t=e.ssrc,i=e.framesEncoded,r=e.framesSent,n=e.totalEncodeTime,a=e.qualityLimitationDurations,s=e.timestamp,o=this.outboundRtpStatsMap.get(t);o||(o=new re(this.cacheSize),this.outboundRtpStatsMap.set(t,o)),o.push({framesEncoded:i,framesSent:r,totalEncodeTime:n,qualityLimitationDurations:a,timestamp:s})}},e}(),se=function(){function e(e){this.cacheSize=e.cacheSize||10,this.started=!1,this.selectedCandidatePairId=null,this.roundTripTime=0,this.remoteCandidateId=null,this.networkProtocol=null,this.inboundRtpStatsEnabled=!1,this.inboundRtpStatsMap=new Map}var t=e.prototype;return t.reset=function(){this.resetCandidateStats(),this.resetInboundRtpStats()},t.resetCandidateStats=function(){this.selectedCandidatePairId=null,this.roundTripTime=0,this.remoteCandidateId=null,this.networkProtocol=null},t.resetInboundRtpStats=function(){this.inboundRtpStatsMap.clear()},t.setOptions=function(e){var t=(e||{}).inboundRtpStatsEnabled;void 0!==t&&(this.inboundRtpStatsEnabled=t)},t.start=function(e){e&&this.setOptions(e),this.started=!0},t.stop=function(){this.started=!1},t.isStarted=function(){return this.started},t.getNetworkProtocol=function(){return this.networkProtocol},t.getCurrentRoundTripTime=function(){return this.roundTripTime},t.getInboundRtpStats=function(){return this.inboundRtpStatsMap},t.onStatsReport=function(e){if(this.started)switch(e.type){case"transport":this.onTransportStats(e);break;case"candidate-pair":this.onCandidatePairStats(e);break;case"remote-candidate":this.onRemoteCandidateStats(e);break;case"inbound-rtp":this.onInboundRtpStats(e)}},t.onTransportStats=function(e){var t=e.selectedCandidatePairId;"connected"===e.dtlsState&&(this.selectedCandidatePairId=t)},t.onCandidatePairStats=function(e){var t=e.id,i=e.state,r=e.nominated,n=e.currentRoundTripTime,a=e.remoteCandidateId;t===this.selectedCandidatePairId&&"succeeded"===i&&r&&(this.roundTripTime=n,this.remoteCandidateId=a)},t.onRemoteCandidateStats=function(e){var t=e.id,i=e.protocol,r=e.port;t!==this.remoteCandidateId||this.networkProtocol||(this.networkProtocol=i,V.globalTrace({logLevel:"directReport",log:"WMSC_Network_Change: recv|"+i+"|"+r}))},t.onInboundRtpStats=function(e){if(this.inboundRtpStatsEnabled){var t=e.ssrc,i=e.framesDecoded,r=e.framesDropped,n=e.framesReceived,a=e.keyFramesDecoded,s=e.totalDecodeTime,o=e.pliCount,d=e.timestamp,c=this.inboundRtpStatsMap.get(t);c||(c=new re(this.cacheSize),this.inboundRtpStatsMap.set(t,c)),c.push({framesDecoded:i,framesDropped:r,framesReceived:n,keyFramesDecoded:a,totalDecodeTime:s,pliCount:o,timestamp:d})}},e}(),oe=new ne,de=function(){function e(){}return e.mean=function(e){if(e.length)return e.reduce((function(e,t){return e+t}),0)/e.length},e.median=function(e){if(e.length){e.sort((function(e,t){return e-t}));var t=Math.floor(e.length/2);return e.length%2!=0?e[t]:(e[t-1]+e[t])/2}},e.variance=function(e){if(e.length){var t=e.reduce((function(e,t){return e+t}),0)/e.length,i=e.map((function(e){return Math.pow(e-t,2)}));return i.reduce((function(e,t){return e+t}),0)/i.length}},e.expMovingAverage=function(e,t){if(void 0===t&&(t=.5),!e.length)return[];for(var i=[e[0]],r=1;r<e.length;r++)i.push(t*e[r]+(1-t)*i[r-1]);return i},e.bestFitSlope=function(e){if(!(e.length<2)){for(var t=e.length,i=0,r=0,n=0,a=0,s=0;s<t;s++)i+=s,r+=e[s],n+=s*e[s],a+=s*s;return(t*n-i*r)/(t*a-i*i)}},e}(),ce=V.getTracer("WmscQosMgr"),ue=function(e){ce.log(e),V.monitorLog(""+e)},he=8e4,le=2e7,pe=Object.freeze({Hold:0,Increase:1,Decrease:2}),me=Object.freeze({None:0,Increase:1,Decrease:2}),ge=Object.freeze({User:0,OutgoingBandwidth:1,ReceiverBandwidth:2,Other:3}),ve=function(){function e(){this.outgoingBandwidthAdaptationEnabled=!0,this.receiverBandwidthAdaptationEnabled=!0,this.outgoingBandwidthProbingEnabled=!1,this.lossDetectionEnabled=!0,this.performanceAdaptationEnabled=!0,this.sendActive=!1,this.requestedLayerIds=[],this.additionalSubLayerIds=[],this.sendStateUpdatedTime=0,this.layersAllocation=[],this.layersAllocationCache=null,this.layersAllocationUpdateIntervalId=null,this.maxSubVideoSize=-1,this.maxFeasibleSendSize=4,this.sendUsageAdjustments=new re(e.resourceUsageAdjustmentHistorySize),this.sendUsageIncreaseFailedAttempts=0,this.sendUsageIncreaseFailedTime=0,this.encoderRestartedTime=0,this.maxFeasibleRecvSize=2,this.recvUsageAdjustments=new re(e.resourceUsageAdjustmentHistorySize),this.recvUsageIncreaseFailedAttempts=0,this.recvUsageIncreaseFailedTime=0,this.bandwidthRampUpTimeoutId=null,this.outgoingBandwidthReady=!1,this.outgoingBitrateStats=new re(e.outgoingBitrateStatsCacheSize),this.minOutgoingBitrate=he,this.outgoingBandwidth=le,this.outgoingBandwidthInProbing=!1,this.outgoingBandwidthProbedTime=0,this.outgoingBandwidthProbingTimeoutId=null,this.receiverBandwidth=le,this.receiverBandwidthReport=null,this.receiverL3BandwidthEvaluation=null,this.receiverBandwidthUpdatePending=!1,this.receiverBandwidthUpdateTimeoutId=null,this.isDualCall=!0,this.receiverStats=new re(e.receiverStatsCacheSize),this.minOutgoingBitrateAdjustments=new re(e.minOutgoingBitrateAdjustmentHistorySize),this.receiverReport=null,this.residualLossDetectedTimestamp=0,this.inherentLossDetectedTimestamp=0,this.minOutgoingBitrateUpdatedTime=0,this.messageCallback=null,this.maxRecvVideoSizeUpdateCallback=null,this.sendUsageStateUpdateCallback=null,oe.registerOutgoingBitrateStatsCallback(this.onOutgoingBandwidthStats.bind(this)),oe.registerResourceUsageStatsCallback(this.onResourceUsageStats.bind(this))}e.areLayersAllocationsEqual=function(e,t){return e.length===t.length&&e.every((function(e,i){var r=t[i];return e.layerId===r.layerId&&e.bitrate===r.bitrate&&e.formatIdx===r.formatIdx}))},e.getTotalAllocatedBitrate=function(e){return e.reduce((function(e,t){return e+t.bitrate}),0)},e.isBitrateChangeAboveRatio=function(e,t,i){return!e||Math.abs(t-e)/e>i};var t=e.prototype;return t.resetSendStats=function(){oe.getSendStatsMonitor().reset()},t.resetRecvStats=function(){oe.getRecvStatsMonitor().reset()},t._resetLayersAllocation=function(){this.requestedLayerIds=[],this.additionalSubLayerIds=[],this.sendActive=!1,this.sendStateUpdatedTime=0,this.layersAllocation=[],this.layersAllocationCache=null},t._resetLossDetection=function(){this.receiverStats.clear(),this.minOutgoingBitrateAdjustments.clear(),this.receiverReport=null,this.residualLossDetectedTimestamp=0,this.inherentLossDetectedTimestamp=0,this.minOutgoingBitrateUpdatedTime=0},t._resetBandwidthState=function(){clearTimeout(this.bandwidthRampUpTimeoutId),this.bandwidthRampUpTimeoutId=null,clearTimeout(this.outgoingBandwidthProbingTimeoutId),this.outgoingBandwidthProbingTimeoutId=null,this.outgoingBandwidthReady=!1,this.outgoingBandwidthInProbing=!1,this.outgoingBandwidthProbedTime=0,clearTimeout(this.receiverBandwidthUpdateTimeoutId),this.receiverBandwidthUpdateTimeoutId=null,this.receiverBandwidthUpdatePending=!1,this.outgoingBitrateStats.clear(),this.minOutgoingBitrate=he,this.outgoingBandwidth=le,this.receiverBandwidth=le,this.receiverBandwidthReport=null,this.receiverL3BandwidthEvaluation=null,this.isDualCall=!0},t._resetResourceUsageState=function(){this.maxFeasibleSendSize=Y(),this.sendUsageAdjustments.clear(),this.sendUsageIncreaseFailedAttempts=0,this.sendUsageIncreaseFailedTime=0,this.maxFeasibleRecvSize=2,this.recvUsageAdjustments.clear(),this.recvUsageIncreaseFailedAttempts=0,this.recvUsageIncreaseFailedTime=0},t.resetSend=function(){this._resetLayersAllocation(),this._resetLossDetection(),this._resetBandwidthState(),this.resetSendStats()},t.resetRecv=function(){this.maxSubVideoSize=-1,this.resetRecvStats()},t.registerMessageCallback=function(e){this.messageCallback=e},t.registerMaxRecvVideoSizeUpdateCallback=function(e){this.maxRecvVideoSizeUpdateCallback=e},t.registerSendUsageStateUpdateCallback=function(e){this.sendUsageStateUpdateCallback=e},t.setOptions=function(e){var t=e||{},i=t.outgoingBandwidthAdaptationEnabled,r=t.receiverBandwidthAdaptationEnabled,n=t.lossDetectionEnabled,a=t.performanceAdaptationEnabled;void 0!==i&&(this.outgoingBandwidthAdaptationEnabled=i),void 0!==r&&(this.receiverBandwidthAdaptationEnabled=r),void 0!==n&&(this.lossDetectionEnabled=n),void 0!==a&&(this.performanceAdaptationEnabled=a)},t.start=function(e){e&&this.setOptions(e);var t={};this.performanceAdaptationEnabled&&(t.sendUsageStatsEnabled=!0,t.recvUsageStatsEnabled=!0),oe.start(t)},t.stop=function(){clearTimeout(this.bandwidthRampUpTimeoutId),this.bandwidthRampUpTimeoutId=null,clearTimeout(this.outgoingBandwidthProbingTimeoutId),this.outgoingBandwidthProbingTimeoutId=null,clearTimeout(this.receiverBandwidthUpdateTimeoutId),this.receiverBandwidthUpdateTimeoutId=null,clearInterval(this.layersAllocationUpdateIntervalId),this.layersAllocationUpdateIntervalId=null,oe.stop(),this.resetSend(),this.resetRecv()},t.updateLayers=function(e){ce.log("updateLayers, "+e),this._setSendState(!!e.length),this.requestedLayerIds=[].concat(e),this._maybeAddSubLayers(),this.allocateBitrate(this._getAvailableBitrate(),ge.User)},t._setSendState=function(e){this.sendActive!==e&&(this.sendActive=e,this.sendStateUpdatedTime=Date.now(),e?this._activateSend():this._deactivateSend())},t._activateSend=function(){var t=this;this.bandwidthRampUpTimeoutId||(this.bandwidthRampUpTimeoutId=setTimeout((function(){t.outgoingBandwidthReady=!0}),e.bandwidthFirstRampUpDelay)),this.layersAllocationUpdateIntervalId=setInterval((function(){t._sendLastLayersAllocation()}),e.layersAllocationUpdateInterval)},t._deactivateSend=function(){clearInterval(this.layersAllocationUpdateIntervalId),this.layersAllocationUpdateIntervalId=null,this._updateLayersAllocation([]),this._resetLayersAllocation(),this._resetLossDetection()},t.updateMaxSubVideoSize=function(e){this.maxSubVideoSize=e},t.getMaxFeasibleRecvVideoSize=function(){return this.maxFeasibleRecvSize},t._waitForReceiverBandwidthUpdate=function(){var t=this;this.receiverBandwidthUpdatePending=!0,clearTimeout(this.receiverBandwidthUpdateTimeoutId),this.receiverBandwidthUpdateTimeoutId=setTimeout((function(){t.receiverBandwidthUpdatePending=!1}),e.receiverBandwidthUpdateDelay)},t._waitForBandwidthProbing=function(){var t=this;this.outgoingBandwidthInProbing=!0,clearTimeout(this.outgoingBandwidthProbingTimeoutId),this.outgoingBandwidthProbingTimeoutId=setTimeout((function(){t.outgoingBandwidthInProbing=!1}),e.outgoingBandwidthProbingDelay)},t.getMinBandwidth=function(){return he},t.onOutgoingBandwidthStats=function(e){if(this.outgoingBandwidthAdaptationEnabled&&this.sendActive){var t=e.availableOutgoingBitrate,i=e.timestamp;if(this.outgoingBandwidthInProbing){var r,n=(null==(r=this.outgoingBitrateStats.back())?void 0:r.availableBitrate)||0;if(t>n)return;t<n&&(clearTimeout(this.outgoingBandwidthProbingTimeoutId),this.outgoingBandwidthProbingTimeoutId=null,this.outgoingBandwidthInProbing=!1)}this.outgoingBitrateStats.push({availableOutgoingBitrate:t,timestamp:i}),this._onOutgoingBandwidth(t)}},t.onResourceUsageStats=function(e){this.performanceAdaptationEnabled&&(e.send&&this.sendActive&&this._handleSendUsageStats(e.send),e.recv&&this._handleRecvUsageStats(e.recv))},t._handleSendUsageStats=function(t){var i=t.framesEncoded,r=t.usageState,n=t.timestamp,a=this._getFeasibleSendLayerIds();if(this.sendUsageStateUpdateCallback&&this.sendUsageStateUpdateCallback(r),0===i&&n>=this.sendStateUpdatedTime+e.encodingTimeout)return this._handleEncodingTimeout(a);var s=me.None;r===b.OVERUSING?s=me.Decrease:r===b.UNDERUSING&&(s=me.Increase);var o=a[a.length-1];this._maybeAdjustMaxSendSize(o,s)&&(ue("WMSC_VEnc_Cap_Change: "+this.maxFeasibleSendSize),this.allocateBitrate(this._getAvailableBitrate(),ge.Other))},t._handleRecvUsageStats=function(e){var t=e.usageState,i=me.None;t===b.OVERUSING?i=me.Decrease:t===b.UNDERUSING&&(i=me.Increase),this._maybeAdjustMaxRecvSize(this.maxSubVideoSize,i)&&(ue("WMSC_VDec_Cap_Change: "+this.maxFeasibleRecvSize),this.maxRecvVideoSizeUpdateCallback&&this.maxRecvVideoSizeUpdateCallback(this.maxFeasibleRecvSize))},t._handleEncodingTimeout=function(t){var i=Date.now();if(i>=this.encoderRestartedTime+e.encoderRestartMinInterval){var r=t[0],n=t[t.length-1];r===J()?(ue("WMSC_VEnc_Timeout_Reset"),this.messageCallback({type:I.ENCODER_RESET,data:null}),this.encoderRestartedTime=i):(ue("WMSC_VEnc_Timeout_Decrease_Layer"),this._maybeAdjustMaxSendSize(n,me.Decrease)&&this.allocateBitrate(this._getAvailableBitrate(),ge.Other))}},t._maybeAdjustMaxSendSize=function(t,i){var r=Date.now();if(i===me.Decrease){var n=J();if(this.maxFeasibleSendSize>n){var a,s=this.sendUsageAdjustments.back();return this.sendUsageAdjustments.push({layerChange:i,time:r}),(null==s?void 0:s.layerChange)===me.Increase&&(this.sendUsageIncreaseFailedAttempts++,this.sendUsageIncreaseFailedTime=s.time,ce.log("Attempt to increase layer failed "+this.sendUsageIncreaseFailedAttempts+" times")),this.maxFeasibleSendSize=null!=(a=q().findLast((function(e){return e<t})))?a:n,!0}}else if(i===me.Increase){var o,d=Y();if(this.maxFeasibleSendSize<d&&this.sendUsageIncreaseFailedAttempts<e.resourceUsageIncreaseMaxAttempts&&r-this.sendUsageIncreaseFailedTime>=e.resourceUsageIncreaseInitialDelay*Math.pow(2,this.sendUsageIncreaseFailedAttempts-1))return this.sendUsageAdjustments.push({layerChange:i,time:r}),this.maxFeasibleSendSize=null!=(o=q().find((function(e){return e>t})))?o:d,!0}return!1},t._maybeAdjustMaxRecvSize=function(t,i){if(t<=2)return!1;var r=Date.now();if(i===me.Decrease){var n=this.recvUsageAdjustments.back();if(this.recvUsageAdjustments.push({layerChange:i,time:r}),(null==n?void 0:n.layerChange)===me.Increase&&(this.recvUsageIncreaseFailedAttempts++,this.recvUsageIncreaseFailedTime=n.time,ce.log("Attempt to increase receive size failed "+this.recvUsageIncreaseFailedAttempts+" times")),this.maxFeasibleRecvSize>2)return this.maxFeasibleRecvSize--,!0}else if(i===me.Increase&&this.maxFeasibleRecvSize<t&&this.recvUsageIncreaseFailedAttempts<e.resourceUsageIncreaseMaxAttempts&&r-this.recvUsageIncreaseFailedTime>=e.resourceUsageIncreaseInitialDelay*Math.pow(2,this.recvUsageIncreaseFailedAttempts-1))return this.recvUsageAdjustments.push({layerChange:i,time:r}),this.maxFeasibleRecvSize++,!0;return!1},t.onSubInfo=function(e){var t=e.isDualCall;this.onDualCallState(t)},t.onDualCallState=function(e){this.isDualCall!==e&&(this.isDualCall=e,ue("WMSC_Dual_Call_State_Changed: "+e),e?this._waitForReceiverBandwidthUpdate():(this.receiverBandwidthUpdatePending=!1,clearTimeout(this.receiverBandwidthUpdateTimeoutId)))},t._calcReceiverBandwidth=function(e,t){return e?t?Math.min(e.minBw,e.toMmrBw):e.toMmrBw:0},t._evaluateBandwidthDistribution=function(t,i,r){var n=r.reduce((function(e,t){return e+t}),0),a=ee(t),s=$(t)*e.adequateQualityBitrateRatio,o=0,d=0,c=0;if(i>=s)d=n,c=i;else if(n>0){for(var u=0,h=0,l=0,p=0,m=0,g=0,v=0,f=r.length-1;f>=0;f--){var S=r[f];S&&((v=v?512*f:i)>=a&&(u=f,h+=S),v>=s&&(l=f,p+=S),g||(m/n<.6?m+=S:g=f))}g<l&&(m-p)/n<.2?(o=l,d=p):g>u?(o=g,d=m):(o=u,d=h),c=d?Math.max(i,512*o):0}else c=s;return{minBandwidth:i,samples:n,selectedBandwidth:c,selectedSamples:d,excludedDist:d<n?r.slice(0,o):[]}},t.onReceiverBandwidthReport=function(e){if(this.receiverBandwidthAdaptationEnabled&&!this.receiverBandwidthUpdatePending){var t=!1,i=e.minBW,r=e.minL3BW,n=e.toMmrBW;if(e.l3BWDist,!this.isDualCall&&Q(3)){var a=this._getMinL3Bandwidth(),s=this._getSelectedL3Bandwidth();this.receiverL3BandwidthEvaluation=this._evaluateBandwidthDistribution(3,r,[]),this.receiverL3BandwidthEvaluation.minBandwidth===a&&this.receiverL3BandwidthEvaluation.selectedBandwidth===s||(t=!0)}this.receiverBandwidthReport={minBw:i,toMmrBw:n};var o=this._calcReceiverBandwidth(this.receiverBandwidthReport,this.isDualCall);o!==this.receiverBandwidth&&(this.receiverBandwidth=o,t=!0),this.sendActive&&t&&(this._maybeAddSubLayers(),this.allocateBitrate(this._getAvailableBitrate(),ge.ReceiverBandwidth))}},t.onReceiverReport=function(e){if(this.outgoingBandwidthAdaptationEnabled&&this.lossDetectionEnabled&&this.sendActive)if(this.receiverReport){var t=e.recvPkts,i=e.preMissingPkts,r=e.postMissingPkts,n=e.maxJitterMs,a=e.maxSeqGap,s=e.timestampMs,o=this.receiverReport,d=t-o.recvPkts,c=i-o.preMissingPkts,u=r-o.postMissingPkts,h=c+d,l={loss:h>0?c/h:0,residualLoss:h>0?u/h:0,jitter:n,sequenceGap:a,timestamp:s};this.receiverStats.push(l),this.receiverReport=e,"udp"===oe.getSendStatsMonitor().getNetworkProtocol()&&this._updateOutgoingBandwidth(this._adjustOutgoingBandwidthForLoss(this.outgoingBandwidth))}else this.receiverReport=e},t._getAvailableReceiverBandwidth=function(){return Math.floor(this.receiverBandwidth*e.receiverBandwidthUseRatio)},t._getMinL3Bandwidth=function(){var e;return(null==(e=this.receiverL3BandwidthEvaluation)?void 0:e.minBandwidth)||0},t._getSelectedL3Bandwidth=function(){var e;return(null==(e=this.receiverL3BandwidthEvaluation)?void 0:e.selectedBandwidth)||0},t._getOutgoingBandwidthHistory=function(e){if(this.outgoingBitrateStats.empty())return[];for(var t=this.outgoingBitrateStats.unwrap(),i=t[t.length-1].timestamp-e,r=0,n=t.length-1;n>=0;n--)if(t[n].timestamp<i){r=n+1;break}return t.slice(r).map((function(e){return e.availableOutgoingBitrate}))},t._getSubLayersForLayer=function(e){var t=q(),i=[];if(3===e){if(!this.receiverL3BandwidthEvaluation)return i;var r=this.receiverL3BandwidthEvaluation,n=r.minBandwidth;if(r.selectedBandwidth>n)for(var a,s=u(t);!(a=s()).done;){var o=a.value;o<e&&i.push(o)}return i}if(e<3)for(var d,c=u(t);!(d=c()).done;){var h=d.value;h<e&&i.push(h)}return i},t._maybeAddSubLayers=function(){var e=this;if(this.receiverBandwidthAdaptationEnabled){if(!this.isDualCall&&this.requestedLayerIds.length){var t=[];this.requestedLayerIds.forEach((function(i){e._getSubLayersForLayer(i).forEach((function(i){e.requestedLayerIds.includes(i)||t.includes(i)||t.push(i)}))})),this.additionalSubLayerIds=t}this.isDualCall&&this.additionalSubLayerIds.length&&(this.additionalSubLayerIds=[])}},t._getAvailableBitrate=function(){var e=this._getAvailableReceiverBandwidth(),t=e?Math.min(this.outgoingBandwidth,e):this.outgoingBandwidth;return Math.max(he,t)},t._onOutgoingBandwidth=function(e){this.outgoingBandwidthReady&&this._updateOutgoingBandwidth(e)},t._updateOutgoingBandwidth=function(e){this.outgoingBandwidth!==e&&(this.outgoingBandwidth=e,this.allocateBitrate(this._getAvailableBitrate(),ge.OutgoingBandwidth))},t._detectInherentLoss=function(t){var i=this,r=t.findIndex((function(e){return e.timestamp>i.inherentLossDetectedTimestamp&&e.loss}));if(t.length-r>=e.inherentLossDetectionMinDataPoints){var n=t.slice(r).map((function(e){return e.loss})),a=n.length?de.mean(n):0;if(a>=e.lossThresholdLow&&a<e.lossThresholdHigh){var s=de.variance(n);if(ce.log("loss ratios: "+n+", mean: "+a+", variance: "+s),s<e.inherentLossVarianceThresholdHigh)return r}}return-1},t._detectOutOfOrder=function(t){var i=this,r=t.findIndex((function(e){return e.timestamp>i.inherentLossDetectedTimestamp&&e.sequenceGap}));if(t.length-r>=e.outOfOrderDetectionMinDataPoints){var n=t.slice(r).map((function(e){return e.sequenceGap})),a=de.mean(n);if(a>=e.sequenceGapThresholdLow&&a<e.sequenceGapThresholdHigh)return ce.log("sequence gaps: "+n+", mean: "+a),r}return-1},t._isOutgoingBandwidthNormal=function(t){return t>=Math.max(e.minOutgoingBitrateThresholdLow,this.minOutgoingBitrate*e.outgoingBitrateFactorThresholdNormalState)},t._adjustOutgoingBandwidthForLoss=function(t){var i=this;t<this.minOutgoingBitrate&&(t=this.minOutgoingBitrate),this._isOutgoingBandwidthNormal(t)&&this.minOutgoingBitrateAdjustments.clear();var r=this.receiverStats.unwrap(),n=r[r.length-1],a=n.residualLoss,s=n.timestamp,o=r.findIndex((function(e){return e.loss})),d=r.slice(o).map((function(e){return e.loss})),c=d.length?de.mean(d):0;if(a&&ce.log("residual loss: "+a+", mean loss: "+c),a>=e.residualLossThresholdMedium){this.residualLossDetectedTimestamp=s;var u=a>=e.residualLossThresholdHigh?e.residualLossBitrateFastDecreaseFactor:e.residualLossBitrateDecreaseFactor;return this._decreaseOutgoingBitrate(Math.floor(t*u))}if(a>=c*e.residualLossRatioThresholdLow){var h=r.findIndex((function(e){return e.timestamp>i.residualLossDetectedTimestamp}));if(r.reduce((function(t,i,r){return r>=h&&i.residualLoss&&s-i.timestamp<=e.residualLossMonitorTimeWindow?t+1:t}),0)>=e.residualLossCountThreshold)return this.residualLossDetectedTimestamp=s,this._decreaseOutgoingBitrate(Math.floor(t*e.residualLossBitrateDecreaseFactor))}if(this.residualLossDetectedTimestamp&&s-this.residualLossDetectedTimestamp<e.outgoingBitrateIncreaseSuppressionIntervalResidualLoss)return t;var l=this._getOutgoingBitrateDemand();if(t>=l)return t;var p=-1;if(-1===(p=this._detectInherentLoss(r))&&(p=this._detectOutOfOrder(r)),-1!==p&&s-this.inherentLossDetectedTimestamp>=e.inherentLossDetectionMinInterval){var m=this._getOutgoingBandwidthHistory(s-r[p].timestamp+1500);if(m.length>=e.inherentLossDetectionMinDataPoints){var g=de.bestFitSlope(m),v=m[0];if(g<e.outgoingBitrateMaxSlopeRestoreBandwidth&&v>=t*e.outgoingBitrateMinFactorRestoreBandwidth)return ce.log("bandwidth: "+v+" -> "+t+", slope: "+g),this._maybeIncreaseMinOutgoingBitrate(Math.min(l,v)),this.inherentLossDetectedTimestamp=s,t}if(t<e.minOutgoingBitrateThresholdMedium)return this._maybeIncreaseMinOutgoingBitrate(Math.min(e.minOutgoingBitrateThresholdMedium,l,Math.floor(t*e.minOutgoingBitrateIncreaseFactor))),this.inherentLossDetectedTimestamp=s,t}return t},t._decreaseOutgoingBitrate=function(e){return e=Math.max(he,e),this._maybeDecreaseMinOutgoingBitrate(e),e},t._maybeIncreaseMinOutgoingBitrate=function(t){return!(this.minOutgoingBitrateAdjustments.unwrap().slice(-3).filter((function(e){return e===pe.Decrease})).length>=2)&&(this.minOutgoingBitrateAdjustments.push(pe.Increase),this._adjustMinOutgoingBitrate(Math.max(e.minOutgoingBitrateThresholdLow,Math.min(e.minOutgoingBitrateThresholdHigh,t))))},t._maybeDecreaseMinOutgoingBitrate=function(t){if(t<this.minOutgoingBitrate){this.minOutgoingBitrateAdjustments.push(pe.Decrease);var i=this.minOutgoingBitrate<=e.minOutgoingBitrateThresholdLow?he:Math.max(he,Math.min(t,Math.floor(this.minOutgoingBitrate*e.minOutgoingBitrateLeastDecreaseFactor)));return this._adjustMinOutgoingBitrate(i)}return!1},t._adjustMinOutgoingBitrate=function(){var t=a(r().mark((function t(i){var n,a;return r().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(ce.log("adjust min bitrate: "+this.minOutgoingBitrate+" -> "+i),!((n=Date.now())-this.minOutgoingBitrateUpdatedTime<e.minOutgoingBitrateUpdateMinInterval)){t.next=4;break}return t.abrupt("return");case 4:if((a=1e3*Math.floor(i/1e3))===this.minOutgoingBitrate){t.next=19;break}return ce.log("update min bitrate: "+this.minOutgoingBitrate+" -> "+a),this.minOutgoingBitrateUpdatedTime=n,t.prev=8,t.next=11,this.messageCallback({type:I.MIN_BITRATE_UPDATE,data:a});case 11:return this.minOutgoingBitrate=a,t.abrupt("return",!0);case 15:return t.prev=15,t.t0=t.catch(8),ce.error("update min bitrate error: "+t.t0.message),t.abrupt("return",!1);case 19:return t.abrupt("return",!1);case 20:case"end":return t.stop()}}),t,this,[[8,15]])})));return function(e){return t.apply(this,arguments)}}(),t._updateLayersAllocation=function(){var e=a(r().mark((function e(t){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.messageCallback({type:I.LAYERS_UPDATE,data:t});case 3:return e.abrupt("return",!0);case 6:return e.prev=6,e.t0=e.catch(0),ce.error("update layers allocation error: "+e.t0.message),e.abrupt("return",!1);case 10:case"end":return e.stop()}}),e,this,[[0,6]])})));return function(t){return e.apply(this,arguments)}}(),t._sendLastLayersAllocation=function(){var t=a(r().mark((function t(){var i,n,a,s,o,d,c,u;return r().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.layersAllocationCache){t.next=2;break}return t.abrupt("return");case 2:if(i=this.layersAllocationCache,n=i.outgoingBandwidth,a=i.receiverBandwidth,s=i.layerIds,o=i.layersAllocation,d=i.isProbing,this.layersAllocationCache=null,e.areLayersAllocationsEqual(this.layersAllocation,o)){t.next=12;break}return c=e.getTotalAllocatedBitrate(o),u=N("WMSC_Update_Layers_Allocation, bandwidth: "+n+", "+a+", "+c+", layers: "+s+", "+JSON.stringify(o)),ue(u),t.next=10,this._updateLayersAllocation(o);case 10:t.sent&&(this.layersAllocation=o,d&&this._waitForBandwidthProbing());case 12:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}(),t._getAdjustedTargetBitrate=function(e){var t=$(e);if(!this.isDualCall&&3===e){var i=this._getSelectedL3Bandwidth();return Math.min(t,i)}return t},t._getAdjustedMaxBitrate=function(e){var t=function(e){var t;return(null==(t=X(e))?void 0:t.maxBitrate)||0}(e);if(!this.isDualCall&&3===e){var i=this._getSelectedL3Bandwidth();return Math.min(t,i)}return t},t._getSendLayerIds=function(){return[].concat(this.additionalSubLayerIds,this.requestedLayerIds).sort()},t._getFeasibleSendLayerIds=function(){for(var e,t=[],i=u(this._getSendLayerIds());!(e=i()).done;){var r=e.value;if(r>this.maxFeasibleSendSize){t[t.length-1]!==this.maxFeasibleSendSize&&t.push(this.maxFeasibleSendSize);break}t.push(r)}return t},t._getTotalMaxBitrate=function(e){for(var t=0,i=0;i<e.length;i++)i===e.length-1?t+=this._getAdjustedMaxBitrate(e[i]):t+=this._getAdjustedTargetBitrate(e[i]);return t},t._getFormatTotalMaxBitrate=function(e){for(var t=0,i=0;i<e.length;i++){var r=K(e[i]);t+=i===e.length-1?r.maxBitrate:r.targetBitrate}return t},t._getOutgoingBitrateDemand=function(){var e=this._getFeasibleSendLayerIds();return Math.min(this._getTotalMaxBitrate(e),this._getAvailableReceiverBandwidth())},t._shouldProbeBandwidth=function(t,i,r){if(r<=this._getAvailableReceiverBandwidth()&&r>t&&r>i&&this._isOutgoingBandwidthNormal(t)){var n=Math.min(e.outgoingBandwidthProbingTimeWindow,Date.now()-this.outgoingBandwidthProbedTime);if("udp"===oe.getSendStatsMonitor().getNetworkProtocol()&&!this.receiverStats.empty()){var a=this.receiverStats.back().timestamp-n;if(this.receiverStats.find((function(e){return e.timestamp>=a&&e.loss})))return!1}var s=this._getOutgoingBandwidthHistory(n);if(s.length>=e.outgoingBandwidthProbingMinDataPoints){var o=de.bestFitSlope(s);if(o>=e.outgoingBandwidthProbingMinSlope&&o<e.outgoingBandwidthProbingMaxSlope)return!0}}return!1},t._allocateBitrateToLayers=function(e,t,i){for(var r,n,a=[],s=u(t);!(n=s()).done;){var o=n.value,d=this._getAdjustedTargetBitrate(o),c=ee(o);if(!(e>=c&&d>=c)){for(var h=q(),l=void 0===r?h[0]:r+1,p=o-1;p>=l&&h.includes(p);p--){var m=this._getAdjustedTargetBitrate(p),g=ee(p);if(e>=g&&m>=g){a.push({layerId:p,bitrate:g,remainingBitrateDemand:m-g}),e-=g,r=p;break}}break}a.push({layerId:o,bitrate:c,remainingBitrateDemand:d-c}),e-=c,r=o}if(a.length&&e>0)for(var v,f=a.reduce((function(e,t){return e+t.remainingBitrateDemand}),0),S=u(a);!(v=S()).done;){var _=v.value,I=_.remainingBitrateDemand,b=Math.min(I,Math.floor(e/f*I));e-=b,_.bitrate+=b}if(a.length){var y=a[a.length-1],M=this._getAdjustedMaxBitrate(y.layerId);y.bitrate=Math.min(M,y.bitrate+e)}return a.map((function(e){var t=e.layerId,r=e.bitrate,n=function(e,t,i){void 0===i&&(i=!0);var r=H();if(null==r||!r.length)return-1;var n=q();if(i)for(var a=0;a<r.length;a++){var s=r[a];if(n.includes(s.layerId)&&s.layerId===e&&t>=s.minBitrate&&t<=s.maxBitrate)return a}else for(var o=r.length-1;o>=0;o++){var d=r[o];if(n.includes(d.layerId)&&d.layerId===e&&t>=d.minBitrate&&t<=d.maxBitrate)return o}return-1}(t,r);return i&&(r=K(n).maxBitrate),{layerId:t,bitrate:r,formatIdx:n}}))},t._reallocateBitrateToLayers=function(t,i,r,n){var a=this,s=e.getTotalAllocatedBitrate(r),o=this._getTotalMaxBitrate(i);if(s>=o&&t>=o)return r;var d=[],c=0,u=0;if(r.forEach((function(e,t){var i=e.layerId,n=e.formatIdx,s=K(n),o=s.minBitrate,h=t===r.length-1?Math.min(a._getAdjustedMaxBitrate(i),s.maxBitrate):Math.min(a._getAdjustedTargetBitrate(i),s.targetBitrate);d.push({layerId:i,formatIdx:n,minBitrate:o,maxBitrate:h}),c+=o,u+=h})),t>=c&&t<=u){var h=u-c,l=(n?u:t)-c;return d.forEach((function(e){e.bitrate=e.minBitrate+Math.floor((e.maxBitrate-e.minBitrate)/h*l)})),d.map((function(e){return{layerId:e.layerId,bitrate:e.bitrate,formatIdx:e.formatIdx}}))}return this._allocateBitrateToLayers(t,i,n)},t.allocateBitrate=function(t,i){var r,n=this._getFeasibleSendLayerIds(),a=this.layersAllocation.map((function(e){return e.layerId})),s=!1;if(this.outgoingBandwidthProbingEnabled&&(i===ge.OutgoingBandwidth||i===ge.ReceiverBandwidth)){var o;if(null!=(o=this.layersAllocationCache)&&o.isProbing)return;var d=Date.now();if(d-this.outgoingBandwidthProbedTime>=e.outgoingBandwidthProbingMinInterval){var c=this._getTotalMaxBitrate(n),u=this.layersAllocation?e.getTotalAllocatedBitrate(this.layersAllocation):0;this._shouldProbeBandwidth(this.outgoingBandwidth,u,c)&&(ce.log("probe bandwidth, demand: "+c+", reason: "+i),s=!0,this.outgoingBandwidthProbedTime=d)}}(r=!A(a,n)||i!==ge.OutgoingBandwidth&&i!==ge.ReceiverBandwidth?this._allocateBitrateToLayers(t,n,s):this._reallocateBitrateToLayers(t,n,this.layersAllocation,s))&&(this.layersAllocationCache={outgoingBandwidth:this.outgoingBandwidth,receiverBandwidth:this.receiverBandwidth,layerIds:n,layersAllocation:r,reason:i,isProbing:s})},e}();ve.availableBitrateChangeRatioThresholdLow=.08,ve.availableBitrateUpdateMinInterval=1e3,ve.layersAllocationUpdateInterval=300,ve.resourceUsageAdjustmentHistorySize=6,ve.resourceUsageIncreaseInitialDelay=6e4,ve.resourceUsageIncreaseMaxAttempts=6,ve.encodingTimeout=3e3,ve.encoderRestartMinInterval=3e4,ve.bandwidthFirstRampUpDelay=5e3,ve.outgoingBitrateStatsCacheSize=8,ve.receiverBandwidthUseRatio=.9,ve.receiverBandwidthUpdateDelay=1500,ve.adequateQualityBitrateRatio=.6,ve.outgoingBandwidthProbingMinInterval=1e4,ve.outgoingBandwidthProbingTimeWindow=4e3,ve.outgoingBandwidthProbingMinDataPoints=3,ve.outgoingBandwidthProbingMinSlope=1e3,ve.outgoingBandwidthProbingMaxSlope=5e4,ve.outgoingBandwidthProbingDelay=3500,ve.lossThresholdLow=.08,ve.lossThresholdHigh=.6,ve.receiverStatsCacheSize=6,ve.minOutgoingBitrateAdjustmentHistorySize=5,ve.outgoingBitrateFactorThresholdNormalState=1.5,ve.outgoingBitrateMaxSlopeRestoreBandwidth=-1e5,ve.outgoingBitrateMinFactorRestoreBandwidth=1.5,ve.outgoingBitrateIncreaseSuppressionIntervalResidualLoss=15e3,ve.minOutgoingBitrateUpdateMinInterval=900,ve.minOutgoingBitrateThresholdLow=25e4,ve.minOutgoingBitrateThresholdMedium=1e6,ve.minOutgoingBitrateThresholdHigh=2e6,ve.minOutgoingBitrateLeastDecreaseFactor=.8,ve.minOutgoingBitrateIncreaseFactor=1.15,ve.residualLossRatioThresholdLow=.05,ve.residualLossThresholdMedium=.05,ve.residualLossThresholdHigh=.15,ve.residualLossMonitorTimeWindow=6e3,ve.residualLossCountThreshold=2,ve.residualLossBitrateDecreaseFactor=.8,ve.residualLossBitrateFastDecreaseFactor=.64,ve.inherentLossDetectionMinDataPoints=3,ve.inherentLossDetectionMinInterval=3e3,ve.inherentLossVarianceThresholdHigh=.02,ve.outOfOrderDetectionMinDataPoints=3,ve.sequenceGapThresholdLow=10,ve.sequenceGapThresholdHigh=80;var fe=new ve,Se=V.getTracer("WmscMediaMgr"),_e=function(e){Se.log(e),V.monitorLog(""+e)},Ie=new(function(){function e(){var e,t,i=this;this.videoPublished=!1,this.mediaRequested=!1,this.hdVideoEnabled=!1,this.maxSendLayerId=m._1080P,this.sourceLayerId=m._1080P,this.pcs=new Map,this.videoMid=null,this.sendTransceivers=new Map,this.recvTransceivers=new Map,this.messageCallback=null,this.requestedLayerIds=[],this.sendLayerIds=[],this.encodingMap=new Map,this.timeCostMap=new Map,this.recvCodecNum=0,this.recvPreferCodecs=(null==(e=RTCRtpReceiver.getCapabilities("video"))||null==(t=e.codecs)?void 0:t.filter((function(e){var t=e.mimeType,r=e.sdpFmtpLine;return-1!==t.indexOf("red")||-1!==t.indexOf("fec")||"video/rtx"===t||"video/H264"===t&&-1!==r.indexOf("packetization-mode=1")&&(i.recvCodecNum++,!0)})))||[],fe.registerMessageCallback(this.onQosMessage.bind(this))}var t=e.prototype;return t.getSendEncodings=function(e){switch(e){case 1:return[{active:!1}];case 2:return[{active:!1,scaleResolutionDownBy:2},{active:!1,scaleResolutionDownBy:1}];default:return[{active:!1,scaleResolutionDownBy:4},{active:!1,scaleResolutionDownBy:2},{active:!1,scaleResolutionDownBy:1}]}},t.getDefaultEncodingIndex=function(e){return e<=1?0:2===e?1:2},t.getEncodingIndex=function(e){return this.layerEncodingIndexMap.get(e)},t._configSimulcastLayers=function(e,t){this.numSimulcastLayers=e,this.layerEncodingIndexMap=t},t.setDefaultVideoSettings=function(){G(z),j([1,2,3]),this._configSimulcastLayers(3,new Map([[1,0],[2,1],[3,2]])),this.resendVideo()},t.setVideoSettings=function(e){var t=this,i=(e||{}).layersSettings;if(null!=i&&i.length){for(var r=i.sort((function(e,t){return Math.min(t.width,t.height)-Math.min(e.width,e.height)})),n=r.reduce((function(e,t){return Math.min(t.maxFramerate,e)}),30),a=0;a<r.length;a++){var s=r[a],o=s.width,d=s.height,c=s.minBitrate,u=s.maxBitrate,h=ie({width:o,height:d});r[a].layerId=h,r[a].maxFramerate=n,void 0===u&&(r[a].maxBitrate=te(h,{width:o,height:d}),r[a].targetBitrate=r[a].maxBitrate),void 0===c&&(r[a].minBitrate=a>0?r[a-1].maxBitrate:6e4)}var l=new Map;r.forEach((function(e){var i=e.layerId,r=t.getDefaultEncodingIndex(i);l.get(i)?i.push(i):l.set(r,[i])}));for(var p=l.size,m=Array.from(l.keys()),g=new Map,v=function(e){l.get(m[e]).forEach((function(t){g.set(t,e)}))},f=0;f<p;f++)v(f);G(r),j(Array.from(g.keys()).sort()),this._configSimulcastLayers(p,g),this.resendVideo()}else this.setDefaultVideoSettings()},t.registerMessageCallback=function(e){this.messageCallback=e},t.getPc=function(e){return this.pcs.get(e)},t.getIngressPc=function(){return this.pcs.get(f.INGRESS)},t.getEgressPc=function(){return this.pcs.get(f.EGRESS)},t.getSendTransceivers=function(){return this.sendTransceivers},t.getSender=function(e){var t;return null==(t=this.sendTransceivers.get(e))?void 0:t.sender},t.getRecvTransceivers=function(){return this.recvTransceivers},t.getReceiver=function(e){var t;return null==(t=this.recvTransceivers.get(e))?void 0:t.receiver},t.getRemoteSourceId=function(e){var t,i=this.getReceiver(e).getContributingSources(),r=parseInt(null==(t=i[0])?void 0:t.source,10);return isNaN(r)?void 0:r},t.enableHdVideo=function(e){_e("WMSC_Enable_HD_Video: "+e),this.hdVideoEnabled=e,this.resendVideo()},t.setMaxSendLayerId=function(e){this.maxSendLayerId=e},t.publishVideoTrack=function(){var e=a(r().mark((function e(t){var i,n,a;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t&&(i=t.getSettings(),n=i.width,a=i.height,this.sourceLayerId=ie({width:n,height:a}),this.sendLayerIds=this._reduceRequestLayerIds(this.requestedLayerIds)),e.next=3,this._replaceVideoTrack(t||null);case 3:this._onVideoPublished(!!t);case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t._replaceVideoTrack=function(){var e=a(r().mark((function e(t){var i,n;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this.getSender(this.videoMid),n=t?"{ kind: "+t.kind+", id: "+t.id+", enabled: "+t.enabled+", muted: "+t.muted+", contentHint: "+t.contentHint+" }":"",_e(N("WMSC_Replace_Video_Track: sender: "+!!i+" track: "+n)),!i){e.next=5;break}return e.abrupt("return",i.replaceTrack(t));case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t._onVideoPublished=function(e){this.videoPublished=e,this.mediaRequested&&(e?this._onVideoStart():this._onVideoStop())},t._onVideoStart=function(){Se.log("_onVideoStart"),fe.updateLayers(this.sendLayerIds)},t._onVideoStop=function(){Se.log("_onVideoStop"),fe.updateLayers([])},t._onEgressPcClose=function(){Se.log("_onEgressPcClose"),fe.stop(),this.sendTransceivers.clear(),this.videoPublished=!1},t._onIngressPcClose=function(){Se.log("_onIngressPcClose"),this.recvTransceivers.clear()},t._reduceRequestLayerIds=function(e){var t=this;if(!e.length)return e;var i=new Map,r=J(),n=Y(),a=Math.min(this.sourceLayerId,this.maxSendLayerId,this.hdVideoEnabled?n:Math.min(m._360P,n));return e.map((function(e){for(var t=Math.max(r,Math.min(a,e));!Q(t);)--t;return t})).forEach((function(e){var r=t.getEncodingIndex(e),n=i.get(r);(void 0===n||e<n)&&i.set(r,e)})),Array.from(i.values()).sort()},t.onMediaRequest=function(e){var t=!!e.length;this.requestedLayerIds=[].concat(e);var i=this._reduceRequestLayerIds(e);_e(N("WMSC_New_Media_Request: layer ids: "+JSON.stringify(e)+" -> "+JSON.stringify(i))),this.sendLayerIds=i,this.mediaRequested!==t?(this.mediaRequested=t,this.videoPublished&&(t?this._onVideoStart():this._onVideoStop())):this.videoPublished&&t&&fe.updateLayers(this.sendLayerIds)},t.resendVideo=function(){this.requestedLayerIds.length&&this.onMediaRequest(this.requestedLayerIds)},t.onQosMessage=function(){var e=a(r().mark((function e(t){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=t.type,e.next=e.t0===I.LAYERS_UPDATE?3:e.t0===I.MIN_BITRATE_UPDATE?4:e.t0===I.ENCODER_RESET?5:6;break;case 3:return e.abrupt("return",this.onLayersAllocationUpdate(t.data));case 4:return e.abrupt("return",this.updateMinOutgoingBitrate(t.data));case 5:return e.abrupt("return",this.resetEncoder());case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.onLayersAllocationUpdate=function(){var e=a(r().mark((function e(t){var i=this;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.encodingMap.clear(),t.forEach((function(e){var t=e.layerId,r=e.bitrate,n=e.formatIdx,a=i.getEncodingIndex(t);i.encodingMap.set(a,{layerId:t,bitrate:r,formatIdx:n})})),e.next=4,this._updateSendParameters();case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.updateMinOutgoingBitrate=function(){var e=a(r().mark((function e(t){var i,n,a;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this.getEgressPc()){e.next=3;break}throw new Error("Egress peer connection has not been created");case 3:return _e("WMSC_Update_Min_Bitrate: "+t),fe.resetSendStats(),n=W.parseSdp(i.remoteDescription.sdp),W.updateCodecParameters(n,"video","recvonly","H264",new Map([["x-google-min-bitrate",Math.floor(t/1e3)]])),a=W.writeSdp(n),e.prev=8,e.next=11,i.setLocalDescription(i.localDescription);case 11:return e.next=13,i.setRemoteDescription({type:"answer",sdp:a});case 13:e.next=20;break;case 15:return e.prev=15,e.t0=e.catch(8),V.globalTrace({logLevel:"error",log:"WMSC_UMOBF: "+e.t0.message}),_e("WMSC_UMOBF"),e.abrupt("return",Promise.reject(e.t0));case 20:case"end":return e.stop()}}),e,this,[[8,15]])})));return function(t){return e.apply(this,arguments)}}(),t.resetEncoder=function(){var e=a(r().mark((function e(){var t;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.getEgressPc()){e.next=3;break}throw new Error("Egress peer connection has not been created");case 3:return _e("WMSC_Reset_Encoder"),e.prev=4,e.next=7,t.setLocalDescription(t.localDescription);case 7:return e.next=9,t.setRemoteDescription(t.remoteDescription);case 9:e.next=16;break;case 11:return e.prev=11,e.t0=e.catch(4),V.globalTrace({logLevel:"error",log:"WMSC_REF: "+e.t0.message}),_e("WMSC_REF"),e.abrupt("return",Promise.reject(e.t0));case 16:case"end":return e.stop()}}),e,this,[[4,11]])})));return function(){return e.apply(this,arguments)}}(),t._updateSendParameters=function(){var e=a(r().mark((function e(){var t,i,n,a,s,o,d,c,u=this;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=(t=this.getSender(this.videoMid))&&t.track){e.next=4;break}return _e("WMSC_USPTNP: "+!!t),e.abrupt("return");case 4:return i=t.track.getSettings(),n=i.width,a=i.height,s=i.frameRate,o=Math.min(n,a),d="WMSC_Update_Send_Params: "+n+"x"+a+"@"+s+"fps",(c=t.getParameters()).encodings.forEach((function(e,t){var i=u.encodingMap.get(t);if(e.active=!!i,e.active){var r=i.layerId,s=i.bitrate,c=K(i.formatIdx),h=Math.max(1,o/Math.min(c.width,c.height)),l=te(r,{width:n/h,height:a/h});e.maxBitrate=Math.min(l,s),e.scaleResolutionDownBy=h,e.maxFramerate=Z(r),d+="| index "+t+": "+r+"|"+e.maxBitrate+"|"+e.maxFramerate+"|"+e.scaleResolutionDownBy}})),c.degradationPreference="maintain-resolution",_e(d),e.prev=11,e.next=14,t.setParameters(c);case 14:e.next=21;break;case 16:return e.prev=16,e.t0=e.catch(11),V.globalTrace({logLevel:"error",log:"WMSC_SETPARAMSE",errorEvent:e.t0}),_e("WMSC_SETPARAMSE"),e.abrupt("return",Promise.reject(e.t0));case 21:case"end":return e.stop()}}),e,this,[[11,16]])})));return function(){return e.apply(this,arguments)}}(),t._getEgressRemoteCodecParams=function(){var e=fe.getMinBandwidth();return new Map([["x-google-min-bitrate",Math.floor(e/1e3)]])},t._getIngressLocalCodecParams=function(){return new Map([["sps-pps-idr-in-keyframe",1]])},t.createPeerConnection=function(e,t,i,r){if(_e("WMSC_Start_Create_PC: "+e),this.getPc(e))return Se.error("WMSC_PC_Existed, PC "+e+" has been created, cannot create new one"),_e("WMSC_PC_Existed: "+e),!1;var n=new RTCPeerConnection({bundlePolicy:"max-bundle"});if(_e("WMSC_PC_Create_Success: "+e),e===f.INGRESS){for(var a=0;a<r;a++){var s=n.addTransceiver(t,{direction:i}),o=a.toString();this.recvTransceivers.set(o,s),s.setCodecPreferences(this.recvPreferCodecs)}fe.resetRecv()}else{var d=n.addTransceiver(t,{direction:i,sendEncodings:this.getSendEncodings(this.numSimulcastLayers)});this.sendTransceivers.set("0",d),this.videoMid="0",fe.resetSend()}return this.pcs.set(e,n),n.onicecandidate=function(e){},n.ontrack=this.onRemoteStream.bind(this,e),n.onconnectionstatechange=this.onconnectionstatechange.bind(this,e),n.onsignalingstatechange=this.onsignalingstatechange.bind(this,e),n.oniceconnectionstatechange=function(t){var i=t.target.iceConnectionState;Se.log("oniceconnectionstatechange, peerId: "+e+" state: "+i),_e("WMSC_ICESTATE: "+e+"|"+i),"failed"===i&&V.globalTrace({logLevel:"error",log:"WMSC_ICE_State_Error: "+e+"|"+i})},n.onnegotiationneeded=function(t){Se.log("onnegotiationneeded, peerId: "+e),_e("WMSC_onnegotiationneeded: "+e)},n.onicegatheringstatechange=function(t){var i=t.target.iceGatheringState;_e("WMSC_CANDGA: "+e+"|"+i)},n.onicecandidateerror=function(t){var i=t.errorCode,r=t.errorText,n=t.url;_e("WMSC_onicecandidateerror: "+e+"|"+i),V.globalTrace({logLevel:"error",log:"WMSC_onicecandidateerror: "+i+"|"+r+"|"+n})},n},t.onconnectionstatechange=function(e,t){var i=t.target.connectionState;Se.log("WMSC_onconnectionstatechange, peerId: "+e+" state: "+i),_e("WMSC_onconnectionstatechange: "+e+"|"+i),this._handlePcStateChange(e,i)},t._handlePcStateChange=function(e,t){var i=this,r="";switch(t){case"connected":this.messageCallback({type:_.PC_STATE_CHANGE,data:t,peerId:e});var n=this.timeCostMap.get(e);if(n){var a=performance.now();n.push(a);var s=this.getNegotiationTime(e);V.globalTrace({logLevel:"directReport",log:s,tags:["WMSC Negotiation time",e]}),_e("WMSCNT-"+e+"-"+s.join("-")),this.timeCostMap.delete(e)}break;case"disconnected":setTimeout((function(){var r=i.getPc(e);"disconnected"===(null==r?void 0:r.connectionState)&&i.messageCallback({type:_.PC_STATE_CHANGE,data:t,peerId:e})}),2e3);break;case"failed":this.messageCallback({type:_.PC_STATE_CHANGE,data:t,peerId:e}),r="WMSC_PC_State_Failed: "+e+"-"+this.getNegotiationTime().join("-"),_e(r),V.globalTrace({logLevel:"error",log:r}),this.timeCostMap.delete(e)}},t.onsignalingstatechange=function(e,t){var i=t.target.signalingState;Se.log("WMSC_onsignalingstatechange: peerId; "+e+" state: "+i),_e("WMSC_onsignalingstatechange: "+e+"|"+i)},t.onRemoteStream=function(e,t){this.messageCallback&&this.messageCallback({type:_.STREAM,data:t,peerId:e})},t.createOffer=function(){var e=a(r().mark((function e(t,i){var n,a,s,o;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.getPc(t)){e.next=3;break}throw new Error("Peer connection has not been created, peerId: "+t);case 3:return _e("WMSC_CO: "+t),e.prev=4,a=[performance.now()],e.next=8,n.createOffer(i);case 8:return s=e.sent,a.push(performance.now()),_e("WMSC_CO: "+t),o=W.parseSdp(s.sdp),t===f.INGRESS?W.mungeIngressLocalOffer(o,this._getIngressLocalCodecParams()):W.mungeEgressLocalOffer(o,this.numSimulcastLayers),s.sdp=W.writeSdp(o),e.next=16,n.setLocalDescription(s);case 16:return a.push(performance.now()),_e("WMSC_SLDS: "+t),Se.log("createOffer, peerId: "+t+", local offer sdp: "+n.localDescription.sdp),t!==f.INGRESS&&W.mungeEgressOfferToRemote(o),e.abrupt("return",W.writeSdp(o));case 23:return e.prev=23,e.t0=e.catch(4),Se.error(e.t0),V.globalTrace({logLevel:"error",log:"WMSC_OFSLDF: peerId: "+t+"|error: "+e.t0.message}),_e("WMSC_OFSLDF: "+t),e.abrupt("return",Promise.reject(e.t0));case 29:case"end":return e.stop()}}),e,this,[[4,23]])})));return function(t,i){return e.apply(this,arguments)}}(),t.setAnswer=function(){var e=a(r().mark((function e(t,i){var n,a,s,o;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null==(n=this.timeCostMap.get(t))||n.push(performance.now()),a=this.getPc(t)){e.next=5;break}throw new Error("Peer connection has not been created, peerId: "+t);case 5:return s=W.parseSdp(i),t===f.EGRESS&&W.mungeEgressAnswer(s,this._getEgressRemoteCodecParams()),o=W.writeSdp(s),Se.log("setAnswer, peerId: "+t+", answer sdp: "+o),e.prev=9,e.next=12,a.setRemoteDescription({type:"answer",sdp:o});case 12:null==n||n.push(performance.now()),_e("WMSC_SRDS: "+t),e.next=22;break;case 16:return e.prev=16,e.t0=e.catch(9),Se.error(e.t0),V.globalTrace({logLevel:"error",log:"WMSCSRDF: peerId: "+t+", errorMsg:"+e.t0.message}),_e("WMSC_SRDF: "+t),e.abrupt("return",Promise.reject(e.t0));case 22:case"end":return e.stop()}}),e,this,[[9,16]])})));return function(t,i){return e.apply(this,arguments)}}(),t.closePeerConnection=function(e){var t;_e("WMSC_Close_PC: "+e),null==(t=this.pcs.get(e))||t.close(),this.pcs.delete(e),e===f.EGRESS?this._onEgressPcClose():this._onIngressPcClose()},t.getNegotiationTime=function(e){var t=this.timeCostMap.get(e),i=[];if(t){for(var r=t.length,n=0;n<r-1;n++)i.push(Math.round(t[n+1]-t[n]));i.push(Math.round(t[r-1]-t[0]))}return i},t.removeRecvCodecByProfileLevelId=function(e){var t=this;this.recvCodecNum=0,this.recvPreferCodecs=this.recvPreferCodecs.filter((function(i){var r=i.mimeType,n=i.sdpFmtpLine;return"video/H264"!==r||-1===n.indexOf(e)&&(t.recvCodecNum++,!0)}))},e}()),be=1,ye=2,Me=4,Re=5,Ee=110,Ce=206,we=32769,Te=32770,Le=function(e,t,i,r,n,a,s){return{type:be,confID:e,sessionID:t,userID:i,peerID:r,msgID:n,sdp:a,sdpEncoding:s}},xe=V.getTracer("WmscMidMgr"),De=function(e){xe.log(e),V.monitorLog(""+e)},Be=function(){function e(e){var t=this;this.mIdUsedStatus=void 0,this.user2VideoDom=void 0,this.hasPausedVideo=void 0,this.activeSpeakerMId=void 0,this.userId2mId=void 0,this.mIdUsedStatus={},null==e||e.forEach((function(e){t.mIdUsedStatus[e]={userId:0,group:null,used:!1,videoStream:null,videoSize:-1,released:!0}})),this.user2VideoDom=new Map,this.hasPausedVideo=!1,this.activeSpeakerMId="0",this.userId2mId=new Map,this.userId2mId.set(1,"0")}var t=e.prototype;return t.getNewMId=function(e,t){void 0===t&&(t=null);var i=this.userId2mId.get(e);if(void 0===i){var r="",n="";for(var a in this.mIdUsedStatus){var s=this.mIdUsedStatus[a],o=s.used,d=s.released,c=s.preUserId;if(!o&&"0"!==a){if(!c){i=a;break}d&&!r?r=a:n||(n=a)}}i||(i=r||n)}return i&&!this.mIdUsedStatus[i].used&&this._assignMid(i,e,t),i},t._assignMid=function(e,t,i){void 0===i&&(i=null),this.mIdUsedStatus[e].userId=t,this.mIdUsedStatus[e].group=i,this.mIdUsedStatus[e].used=!0,1===t&&(this.activeSpeakerMId=e);var r=this.mIdUsedStatus[e].preUserId;return r&&this.userId2mId.delete(r),this.userId2mId.set(t,e),e},t.releaseMId=function(e){var t=this.mIdUsedStatus[e];if(t){t.group=null;var i=this.user2VideoDom.get(t.userId);null==i||i.forEach((function(e){e.srcObject=null})),t.preUserId=t.userId,t.userId=0,t.used=!1,t.videoSize=-1}},t.getMId=function(e,t){void 0===t&&(t=null);var i=this.userId2mId.get(e);return void 0===i||this.mIdUsedStatus[i].userId!==e||this.mIdUsedStatus[i].group!==t?"":i},t.getUserId=function(e){return{userId:this.mIdUsedStatus[e].userId,group:this.mIdUsedStatus[e].group}},t.getVideoTags=function(e){var t=this.mIdUsedStatus[e].userId;if(t)return this.user2VideoDom.get(t)},t.saveVideoTag=function(e,t){var i=this.user2VideoDom.get(e)||[];for(var r in i.push(t),this.user2VideoDom.set(e,i),this.mIdUsedStatus)this.mIdUsedStatus[r].userId===e&&(t.srcObject=this.mIdUsedStatus[r].videoStream)},t.removeVideoTag=function(e,t){var i=this.user2VideoDom.get(e);if(i){for(var r=0;r<i.length;)i[r]===t?(t.srcObject=null,i.splice(r,1)):r++;i.length||this.user2VideoDom.delete(e)}},t.updateUserId=function(e,t){var i=this.mIdUsedStatus[e];i&&(i.userId=t)},t.updateVideoElement=function(e){var t=this;if(this.mIdUsedStatus[e]){var i=this.mIdUsedStatus[e].userId,r=this.user2VideoDom.get(i);null==r||r.forEach((function(r){r.srcObject=t.mIdUsedStatus[e].videoStream,r.onpause=function(){De("WMSC_V_Tag_Pause: "+i+"|"+document.hidden+"|"+document.visibilityState),t.hasPausedVideo=!0}}))}},t.updateStream=function(e,t){this.mIdUsedStatus[e]&&(this.mIdUsedStatus[e].videoStream=t)},t.setVideoSize=function(e,t){this.mIdUsedStatus[e].videoSize=t},t.getVideoSizeByUserId=function(e){var t=this.userId2mId.get(e);return t?this.mIdUsedStatus[t].videoSize:-1},t.getUserIdByElem=function(e){var t=-1;return this.user2VideoDom.forEach((function(i,r){for(var n=0;n<i.length;n++)if(e===i[n]){t=r;break}})),t},t.getHasPausedVideo=function(){return this.hasPausedVideo||Array.from(this.user2VideoDom.values()).flat().some((function(e){return e.paused}))},t.playAllUsedVideoTag=function(){var e=this,t=Array.from(this.user2VideoDom.values()).flat().map((function(t){if("visible"===document.visibilityState&&t.paused){var i,r=(null==t||null==(i=t.srcObject)?void 0:i.active)||!1;if(null==t||!t.srcObject||!r){var n=e.getUserIdByElem(t);return De("WMSC_V_Tag_C_P: "+n+"|"+!(null==t||!t.srcObject)+"ï½œ"+r),Promise.reject(n)}return t.play().then((function(){return Promise.resolve()})).catch((function(i){var r=e.getUserIdByElem(t);return De("WMSC_V_Tag_P_F: "+r+"|errorName:"+i.name),Promise.reject(r)}))}return null})).filter((function(e){return!!e}));return t.length<=0?Promise.resolve():Promise.all(t).then((function(){return e.hasPausedVideo=!1,Promise.resolve()})).catch((function(t){return e.hasPausedVideo=!0,Promise.reject(t)}))},t.setMidReleasedStatus=function(e,t){this.mIdUsedStatus[e]&&(this.mIdUsedStatus[e].released=t)},t.getMidReleasedStatus=function(e){var t;return null==(t=this.mIdUsedStatus[e])?void 0:t.released},e}(),Pe=new(function(){function e(){this.recvVideoNumPerCpu=4,this.sendVideoSizeLowerLimit=0,this.sendVideoSizeUpperLimit=4,this.recvVideoSizeLowerLimit=0,this.recvVideoSizeUpperLimit=4,this.recvVideoNumLowerLimit=4,this.recvVideoNumUpperLimit="Android"===F.os?9:25,this.sendVideoSizeLowerLimitApp=this.sendVideoSizeLowerLimit,this.sendVideoSizeUpperLimitApp=this.sendVideoSizeUpperLimit,this.recvVideoSizeLowerLimitApp=this.recvVideoSizeLowerLimit,this.recvVideoSizeUpperLimitApp=this.recvVideoSizeUpperLimit,this.recvVideoNumLowerLimitApp=this.recvVideoNumLowerLimit,this.recvVideoNumUpperLimitApp=this.recvVideoNumUpperLimit,this.maxSendVideoSize=0,this.maxRecvVideoSize=0,this.maxRecvVideoNum=0,this.hardwareConcurrency=F.hardwareConcurrency,this._reset()}var t=e.prototype;return t._reset=function(){var e,t;"iOS"===F.os||this.hardwareConcurrency>=8?(e=4,t=4):this.hardwareConcurrency>=4?(e=3,t=3):(e=2,t=2);var i=Math.floor(this.hardwareConcurrency*this.recvVideoNumPerCpu);this.maxSendVideoSize=Math.max(this.sendVideoSizeLowerLimit,this.sendVideoSizeLowerLimitApp,Math.min(this.sendVideoSizeUpperLimit,this.sendVideoSizeUpperLimitApp,e)),this.maxRecvVideoSize=Math.max(this.recvVideoSizeLowerLimit,this.recvVideoSizeLowerLimitApp,Math.min(this.recvVideoSizeUpperLimit,this.recvVideoSizeUpperLimitApp,t)),this.maxRecvVideoNum=Math.max(this.recvVideoNumLowerLimit,this.recvVideoNumLowerLimitApp,Math.min(this.recvVideoNumUpperLimit,this.recvVideoNumUpperLimitApp,i))},t.setLimits=function(e){var t=e.minSendVideoSize,i=e.maxSendVideoSize,r=e.minRecvVideoSize,n=e.maxRecvVideoSize,a=e.minRecvVideoNum,s=e.maxRecvVideoNum;void 0!==t&&(this.sendVideoSizeLowerLimitApp=t),void 0!==i&&(this.sendVideoSizeUpperLimitApp=i),void 0!==r&&(this.recvVideoSizeLowerLimitApp=r),void 0!==n&&(this.recvVideoSizeUpperLimitApp=n),void 0!==a&&(this.recvVideoNumLowerLimitApp=a),void 0!==s&&(this.recvVideoNumUpperLimitApp=s),this._reset()},t.getCapabilities=function(){return{maxSendVideoSize:this.maxSendVideoSize,maxRecvVideoSize:this.maxRecvVideoSize,maxRecvVideoNum:this.maxRecvVideoNum}},e}()),Ae=V.getTracer("WmscMonitor"),Oe=function(e){Ae.log(e),V.monitorLog(""+e)},Ne=new(function(){function e(){this.bToPrint=!0,this.mIdMgr=null,this.captureTimer=null,this.reportTimer=null,this.userId="",this.recvStats={},this.sendStats={},this.isMonitoring=!1,this.subInfo={},this.activeSpeaker="",this.isPreActiveSpeaker=!1,this.recordUserId="",this.captureTimer=null,this.reportTimer=null,this.lastSendPCsStatRecord=new Map,this.captureCount=0,this._startCapture=this._startCapture.bind(this),this.rtpHeaderExt={"http://www.webrtc.org/experiments/rtp-hdrext/playout-delay":0,"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01":1,"urn:ietf:params:rtp-hdrext:sdes:mid":2,"http://www.webrtc.org/experiments/rtp-hdrext/video-layers-allocation00":3},this.sdpDirection={recvonly:0,sendonly:1,sendrecv:2,inactive:3},this.recvStatisticData={},this.reportCount=0,this.maxSubscribedSize=-1,this._telemetry=null,this.uiQosData={},this.isUISubQos=!1,this.UIQosInterval=1,this.candidateLog={0:"",1:"",2:"",3:"",4:""},this.candidatePairLog={0:"",1:"",2:"",3:"",4:""},this.iceCandidatePairState={frozen:0,waiting:1,"in-progress":2,failed:3,succeeded:4},this.ssrcMidMap={},this.candidatePairMonitorLog=new Array(5).fill(""),this.candidatePairChangeCount=new Array(5).fill(0),this.ingressReport={},this.camStream=null,this.recvCodecProfileLevelId="",this.isDecodeSuccess=!1,this.shouldReportNullDecoderError=!0,this.shouldReportDecodeFailedError=!0}var t=e.prototype;return t.setTelemetry=function(e){this._telemetry="function"==typeof e?e:null},t.updateQosSubscription=function(e,t){void 0===t&&(t=1e3),this.isUISubQos=e,this.UIQosInterval=Math.round(t/1e3)},t.setUserId=function(e){this.userId=parseInt(e,10)},t.setQoSDataCb=function(e){this.sendQoSData=e},t.updateSubInfo=function(e,t){t>=0?this.subInfo[e]=t:(delete this.subInfo[e],this.resetRecvStats(e)),Ae.log("updateSubInfo:",this.subInfo)},t.setActiveSpeaker=function(e,t){this.activeSpeaker=4294966272&parseInt(e,10),this.isPreActiveSpeaker=t},t.updateSubscribedSize=function(e,t,i){var r=-1;Array.from(new Set([].concat(e,t,i))).forEach((function(e){r=Math.max(r,e)})),this.maxSubscribedSize=r},t.start=function(){Oe("WMSC_MSTART: "+this.isMonitoring),this.isMonitoring||(this._startCapture(),this._startReport(),this.isMonitoring=!0)},t.resetRecvStats=function(e){this.recvStats.statisticData&&delete this.recvStats.statisticData[e],this.recvStats["begin-video-inbound-rtp"]&&delete this.recvStats["begin-video-inbound-rtp"][e],this.recvStats["video-inbound-rtp"]&&delete this.recvStats["video-inbound-rtp"][e],this.recvStats["video-remote-outbound-rtp"]&&delete this.recvStats["video-remote-outbound-rtp"][e]},t.stop=function(){Oe("WMSC_MSTOP: "+this.isMonitoring),clearInterval(this.reportTimer),clearTimeout(this.captureTimer),this.recvStats={},this.sendStats={},this.isMonitoring=!1},t.getResolutionId=function(e){return e<=14400?0:e<=57600?1:e<=230400?2:e<=921600?3:e<=2073600?4:5},t._sendQosData=function(){if(this.isUISubQos&&this.captureCount%this.UIQosInterval==0){if(this.uiQosData.receiving){var e=(this.recvStats["candidate-pair"]||{}).currentRoundTripTime,t=void 0===e?0:e,i=Math.round(1e3*t);this._telemetry&&this._telemetry({type:l.VIDEO_QOS_DATA,data:d({encoding:!1},this.uiQosData.receiving,{rtt:i})}),this.uiQosData.receiving=null}this.uiQosData.sending&&(this._telemetry&&this._telemetry({type:l.VIDEO_QOS_DATA,data:d({encoding:!0},this.uiQosData.sending)}),this.uiQosData.sending=null)}},t._startCapture=function(){var e=a(r().mark((function e(){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.captureCount++,e.prev=1,e.next=4,Promise.all([this._captureRecvStats(),this._captureSenderStats()]);case 4:this._sendQosData(),e.next=12;break;case 7:e.prev=7,e.t0=e.catch(1),Ae.error("_startCapture, capture error: "+e.t0),Oe("WMSC_LOGCE"),V.globalTrace({logLevel:"error",log:"WMSC_LOGCE",errorEvent:e.t0});case 12:return e.prev=12,this.captureTimer=setTimeout(this._startCapture,1e3),e.finish(12);case 15:case"end":return e.stop()}}),e,this,[[1,7,12,15]])})));return function(){return e.apply(this,arguments)}}(),t._startReport=function(){this.reportTimer=setInterval(this._reportStats.bind(this),15e3)},t._reportStats=function(){try{this.reportCount++,this._getStats(),this._resetStats(),this.ingressReport.begin=null}catch(e){Oe("WMSC_LOGRE"),V.globalTrace({logLevel:"error",log:"WMSC_LOGRE",errorEvent:e})}},t._resetStats=function(){for(var e in this.sendStats){var t=this.sendStats[e].statisticData;for(var i in t.maxRtt=0,t.maxCamCaptureFps=t.maxCaptureFps=0,t.minCamCaptureFps=t.minCaptureFps=Math.MAX_SAFE_INTEGER,t.totalCamCaptureCount=t.totalCaptureCount=0,t.totalCamCaptureFps=t.totalCaptureFps=0,this.sendStats[e]["video-outbound-rtp"])t[i]={maxEncodeTime:0,minEncodeTime:Number.MAX_SAFE_INTEGER,avgEncodeTime:0,minSendFrameRate:Number.MAX_SAFE_INTEGER,maxSendFrameRate:0,avgSendFrameRate:0,minSendBitRate:Number.MAX_SAFE_INTEGER,maxSendBitRate:0,avgSendBitRate:0,minPacketSentDelay:Number.MAX_SAFE_INTEGER,maxPacketSentDelay:0,avgPacketSentDelay:0,maxLossRate:"",avgLossRate:""},this.sendStats[e]["begin-video-outbound-rtp"][i]=this.sendStats[e]["video-outbound-rtp"][i],this.sendStats[e]["video-remote-inbound-rtp"]&&(this.sendStats[e]["begin-video-remote-inbound-rtp"][i]=this.sendStats[e]["video-remote-inbound-rtp"][i]);this.sendStats[e]["begin-candidate-pair"]=this.sendStats[e]["candidate-pair"]}for(var r in this.recvStats["video-inbound-rtp"])this.recvStats.statisticData[r]={maxFps:0,minFps:Number.MAX_SAFE_INTEGER,avgFps:0,maxDecodeTime:0,minDecodeTime:Number.MAX_SAFE_INTEGER,avgDecodeTime:0,maxLossRate:0,avgLossRate:0,maxBt:0,minBt:Number.MAX_SAFE_INTEGER,avgBt:0,maxJitter:0,minLastRecvGap:Number.MAX_SAFE_INTEGER,maxLastRecvGap:0,avgLastRecvGap:0,isVideoPlaying:0,framesRendered:0,framesRenderDrop:0,noDataCount:0,count:0},this.recvStats["begin-video-inbound-rtp"][r]=this.recvStats["video-inbound-rtp"][r],this.recvStats["video-remote-outbound-rtp"]&&(this.recvStats["begin-video-remote-outbound-rtp"][r]=this.recvStats["video-remote-outbound-rtp"][r]);this.recvStats["begin-candidate-pair"]=this.recvStats["candidate-pair"],this.recvStats.statisticData.maxRtt=0},t._captureSenderStats=function(){var e=a(r().mark((function e(){var t,i,n,a,s,o,c,u,h,l,p,m,g,v,S,_,I,b,y,M,R,E,C,w,T,L,x,D,B,P,A,O,N,U,k,F,W,z,G,j,H,q,J,Q,Y,K,X,Z,$,ee,te,ie,re,ne,ae,se,de,ce,ue,he,le,pe,me,ge,ve,fe,Se,_e,be,ye,Me,Re,Ee,Ce,we,Te,Le,xe,De,Be,Pe,Ae,Oe,Ne,Ve,Ue,ke,Fe,We,ze,Ge,je,He,qe,Je,Qe,Ye,Ke,Xe,Ze,$e,et,tt,it,rt,nt,at,st,ot,dt,ct,ut,ht,lt,pt,mt,gt,vt,ft,St,_t,It=this;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=f.EGRESS,i=Ie.getPc(t)){e.next=4;break}return e.abrupt("return");case 4:return e.next=6,i.getStats();case 6:for(Y in n=e.sent,a={},this.sendStats[t]||(this.sendStats[t]={}),s={},o={},c="",u="",h=!1,l=0,n.forEach((function(e){oe.getSendStatsMonitor().onStatsReport(e);var i=e.kind,r=e.type,n=(i?i+"-":"")+r,h="begin-"+n;if("video"!==i||"outbound-rtp"!==r&&"remote-inbound-rtp"!==r)if("candidate-pair"===r){var l=e.id;s[l]=e,u+=It._getCandidatePairLog(e)}else if("local-candidate"===r||"remote-candidate"===r){var p=e.id;o[p]=e,c+=It._getCandidateLog(e)}else a[n]=e;else{var m,g=e.ssrc;a[n]||(a[n]={}),a[n][g]=e,It.sendStats[t][h]&&It.sendStats[t][h][g]||(It.sendStats[t][h]=d({},It.sendStats[t][h],((m={})[g]=e,m)))}})),a.candidates=o,a.candidatePairs=s,a.transport&&(p=a.transport,m=p.selectedCandidatePairId,"connected"===p.dtlsState&&(g=s[m])&&(v=g.localCandidateId,S=g.remoteCandidateId,a["remote-candidate"]=o[S],a["local-candidate"]=o[v],a["candidate-pair"]=g,this.sendStats[t]["begin-candidate-pair"]||(this.sendStats[t]["begin-candidate-pair"]=g))),c!==this.candidateLog[t]&&(V.directSendMonitorLog("WMSC_CANDIDATE: "+t+"|"+c),this.candidateLog[t]=c),u!==this.candidatePairLog[t]&&(this.candidatePairChangeCount[t]++,this.candidatePairLog[t]=u),_=a["candidate-pair"]||{},I=_.currentRoundTripTime,b=a["video-outbound-rtp"]||{},y=a["video-remote-inbound-rtp"]||{},this.sendStats[t].statisticData||(this.sendStats[t].statisticData={}),M=this.sendStats[t]["video-outbound-rtp"]||{},R=this.sendStats[t].statisticData,E=R.minCaptureFps,C=R.maxCaptureFps,w=R.maxRtt,T=R.minCamCaptureFps,L=R.maxCamCaptureFps,x=R.totalCaptureFps,D=void 0===x?0:x,B=R.totalCaptureCount,P=void 0===B?0:B,A=R.totalCamCaptureFps,O=void 0===A?0:A,N=R.totalCamCaptureCount,U=void 0===N?0:N,(k=i.getSenders())[0]&&k[0].track&&(h=!0,F=k[0].track.getSettings(),W=F.frameRate,z=void 0===W?0:W,G=F.width,j=F.height,R.minCaptureFps=Math.round(Math.min(z,E||Number.MAX_SAFE_INTEGER)),R.maxCaptureFps=Math.round(Math.max(z,C||0)),R.totalCaptureFps=D+z,R.totalCaptureCount=P+1,R.avgCaptureFps=Math.round(R.totalCaptureFps/R.totalCaptureCount),R.captureWidth=null!=G?G:"",R.captureHeight=null!=j?j:""),this.camStream&&(q=null==(H=this.camStream.getVideoTracks()[0])?void 0:H.getSettings(),J=q.frameRate,Q=void 0===J?0:J,R.minCamCaptureFps=Math.round(Math.min(Q,T||Number.MAX_SAFE_INTEGER)),R.maxCamCaptureFps=Math.round(Math.max(Q,L||0)),R.totalCamCaptureFps=O+Q,R.totalCamCaptureCount=U+1,R.avgCamCaptureFps=Math.round(R.totalCamCaptureFps/R.totalCamCaptureCount)),I&&(R.maxRtt=Math.max(I,w||0)),b)K=b[Y],X=K.framesPerSecond,Z=void 0===X?"":X,$=K.bytesSent,ee=K.framesSent,te=K.timestamp,ie=K.framesEncoded,re=K.totalEncodeTime,ne=K.packetsSent,ae=K.totalPacketSendDelay,se=K.frameHeight,de=K.frameWidth,ce=K.retransmittedPacketsSent,ue=y[Y]||{},he=ue.jitter,R[Y]||(R[Y]={}),le=R[Y],pe=le.minEncodeFrameRate,me=le.maxEncodeFrameRate,ge=le.minSendFrameRate,ve=le.maxSendFrameRate,fe=le.minSendBitRate,Se=le.maxSendBitRate,_e=le.maxEncodeTime,be=le.minEncodeTime,ye=le.maxPacketSentDelay,Me=le.minPacketSentDelay,Re=le.maxJitter,Ee=le.maxLossRate,Ce=le.sendWidth,we=le.sendHeight,le.minEncodeFrameRate=Math.min(Z,pe||Number.MAX_SAFE_INTEGER),le.maxEncodeFrameRate=Math.max(Z,me||0),le.maxJitter=Math.max(he,Re||0),M&&M[Y]?(Le=M[Y],xe=Le.timestamp,De=Le.bytesSent,Be=Le.framesSent,Pe=Le.framesEncoded,Ae=Le.totalEncodeTime,Oe=Le.packetsSent,Ne=Le.totalPacketSendDelay,Ve=Le.retransmittedPacketsSent,Ue=this.sendStats[t]["begin-video-outbound-rtp"][Y],ke=Ue.framesSent,Fe=Ue.bytesSent,We=Ue.timestamp,ze=Ue.framesEncoded,Ge=Ue.totalEncodeTime,je=Ue.packetsSent,He=Ue.totalPacketSendDelay,qe=Ue.retransmittedPacketsSent,Je=void 0,Qe=void 0,Ye="",Ke="",Xe=Math.round((ee-Be)/((te-xe)/1e3)),Ze=(8*($-De)/((te-xe)/1e3)).toFixed(2),$e=Math.round((ee-ke)/((te-We)/1e3)),et=(8*($-Fe)/((te-We)/1e3)).toFixed(2),tt=(re-Ae)/(ie-Pe)||0,it=(re-Ge)/(ie-ze)||0,rt=Math.round((ie-ze)/((te-We)/1e3)),nt=this.ingressReport,at=nt.current,st=nt.begin,ot=nt.prev,at&&ot&&st?(dt=at.lostPkts,ct=at.recvPkts,ut=ot.lostPkts,ht=ot.recvPkts,lt=st.lostPkts,pt=st.recvPkts,Ke=(mt=dt-ut)/(ct-ht+mt)||0,Ye=(gt=dt-lt)/(ct-pt+gt)||0):(Ye=(ce-qe)/(ne-je)||0,Ke=(ce-Ve)/(ne-Oe)||0),void 0!==ae&&(Je=(1e3*(ae-Ne)/(ne-Oe)).toFixed(3),Qe=(1e3*(ae-He)/(ne-je)).toFixed(3)),R[Y]=d({},le,{maxEncodeTime:Math.max(_e,tt),minEncodeTime:Math.min(tt,be),avgEncodeTime:it,minSendFrameRate:Math.min(Xe,ge),maxSendFrameRate:Math.max(ve,Xe),avgSendFrameRate:$e,minSendBitRate:Math.min(Ze,fe),maxSendBitRate:Math.max(Se,Ze),avgSendBitRate:et,minPacketSentDelay:Math.min(Je,Me),maxPacketSentDelay:Math.max(Je,ye),avgPacketSentDelay:null!=(Te=Qe)?Te:"",avgEncodeFrameRate:rt,avgLossRate:isNaN(Ye)?"":Ye,maxLossRate:isNaN(Ke)?Ee:Math.max(Ke,Ee),sendWidth:de||Ce,sendHeight:se||we})):R[Y]=d({},le,{maxEncodeTime:0,minEncodeTime:Number.MAX_SAFE_INTEGER,avgEncodeTime:0,minSendFrameRate:Number.MAX_SAFE_INTEGER,maxSendFrameRate:0,avgSendFrameRate:0,minSendBitRate:Number.MAX_SAFE_INTEGER,maxSendBitRate:0,avgSendBitRate:0,minPacketSentDelay:Number.MAX_SAFE_INTEGER,maxPacketSentDelay:0,avgPacketSentDelay:0,maxLossRate:"",avgLossRate:""}),se&&de&&(vt=se*de)>l&&(ft=a["candidate-pair"]||{},St=ft.currentRoundTripTime,_t=void 0===St?0:St,l=vt,this.uiQosData.sending={width:de,height:se,fps:Z,rtt:Math.round(1e3*_t),max_loss:1e3*R[Y].maxLossRate,avg_loss:1e3*R[Y].avgLossRate,jitter:Math.round(1e3*(he||0))});this.sendStats[t]=d({},this.sendStats[t],a),this.captureCount%2==0&&h&&this.sendQoSData&&this.checkSendPCsStat();case 36:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t._captureRecvStats=function(){var e=a(r().mark((function e(){var t,i,n,a,s,o,d,c,u,h,l,p,m,g,v,S,_,I=this;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((t=Ie.getPc(f.INGRESS))&&this.mIdMgr){e.next=3;break}return e.abrupt("return");case 3:return i=this.mIdMgr.mIdUsedStatus,e.next=6,t.getStats();case 6:n=e.sent,a=0,s={},o={},d="",c="",this.recvStats.statisticData||(this.recvStats.statisticData={}),u=!1,n.forEach((function(e){oe.getRecvStatsMonitor().onStatsReport(e);var t=e.kind,r=e.type,n=(t?t+"-":"")+r,h="begin-"+n;if("candidate-pair"===r){var l=e.id;s[l]=e,c+=I._getCandidatePairLog(e)}else if("remote-candidate"===r||"local-candidate"===r){var p=e.id;o[p]=e,d+=I._getCandidateLog(e)}else if("video"!==t||"inbound-rtp"!==r&&"remote-outbound-rtp"!==r)I.recvStats[n]=e;else{var m=e.mid,g=e.ssrc;m||(m=I.ssrcMidMap[g]),I.recvStats[h]||(I.recvStats[h]={}),I.recvStats[n]||(I.recvStats[n]={});var v=i[m]||{},f=v.userId,S=v.used;if(m&&S&&"inbound-rtp"===r){var _,b=I.mIdMgr.user2VideoDom.get(f),y=e.framesPerSecond,M=void 0===y?"":y,R=e.timestamp,E=void 0===R?"":R,C=e.framesDecoded,w=void 0===C?"":C,T=e.frameWidth,L=void 0===T?"":T,x=e.frameHeight,D=void 0===x?"":x,B=e.bytesReceived,P=void 0===B?"":B,A=e.framesReceived,O=void 0===A?"":A,N=e.totalDecodeTime,U=void 0===N?"":N,k=e.packetsReceived,W=void 0===k?"":k,z=e.packetsLost,G=void 0===z?"":z,j=e.jitter,H=void 0===j?"":j,q=e.lastPacketReceivedTimestamp,J=void 0===q?0:q,Q=e.fecPacketsReceived,Y=void 0===Q?0:Q,K=e.retransmittedPacketsReceived,X=void 0===K?0:K,Z=e.jitterBufferEmittedCount,$=e.decoderImplementation,ee=e.pliCount;w>0?I.isDecodeSuccess=!0:Z>24&&0===w&&"NullVideoDecoder"===$&&(I.shouldReportNullDecoderError&&(V.globalTrace({logLevel:"error",log:"WMSC_NULLDECODER"}),Oe("WMSC_NULLDECODER"),I.shouldReportNullDecoderError=!1),"6400"===I.recvCodecProfileLevelId.substring(0,4)&&"Windows"===F.os&&(u=!0));var te="",ie="",re="";if(null!=b&&b.length){var ne=b[0];te=ne.currentTime>0&&!ne.paused&&!ne.ended&&ne.readyState>2?1:0;var ae=ne.getVideoPlaybackQuality();ie=ae.totalVideoFrames,re=ae.droppedVideoFrames}if(I.recvStats.statisticData[f]){I.recvStats.statisticData[f].count++;var se=I.recvStats.statisticData[f],de=se.maxFps,ce=se.minFps,ue=se.maxDecodeTime,he=se.minDecodeTime,le=se.maxLossRate,pe=se.maxBt,me=se.minBt,ge=se.maxJitter,ve=se.minLastRecvGap,fe=se.maxLastRecvGap,Se=se.avgLastRecvGap,_e=se.count,Ie=I.recvStats["video-inbound-rtp"][f],be=I.recvStats["begin-video-inbound-rtp"][f]||{},ye=be.timestamp,Me=be.framesDecoded,Re=be.totalDecodeTime,Ee=be.packetsLost,Ce=be.packetsReceived,we=be.bytesReceived,Te=be.fecPacketsReceived,Le=void 0===Te?0:Te,xe=be.retransmittedPacketsReceived,De=void 0===xe?0:xe,Be=be.pliCount,Pe=void 0===Be?0:Be,Ae=be.jitterBufferEmittedCount,Ne=void 0===Ae?0:Ae,Ve=Ie||{},Ue=Ve.packetsLost,ke=Ve.packetsReceived,Fe=Ve.totalDecodeTime,We=Ve.framesDecoded,ze=Ve.bytesReceived,Ge=Ve.timestamp,je=Ve.lastPacketReceivedTimestamp,He=Ve.fecPacketsReceived,qe=void 0===He?0:He,Je=Ve.retransmittedPacketsReceived,Qe=void 0===Je?0:Je;ee&&ee-Pe>0&&w===Me&&G===Ee&&Z&&Z-Ne>5&&I.shouldReportDecodeFailedError&&(V.globalTrace({logLevel:"error",log:"WMSC_DECODE_FAILED"}),Oe("WMSC_DECODE_FAILED"),I.shouldReportDecodeFailedError=!1);var Ye=W-Ce-(Y-Le)-(X-De),Ke=(G-Ue)/(W-ke-(Y-qe)-(X-Qe)+(G-Ue))||0,Xe=(U-Fe)/(w-We)||0;_=8*(P-ze)/((E-Ge)/1e3);var Ze=8*(P-we)/((E-ye)/1e3);if(je){var $e=parseInt(J-je,10);I.recvStats.statisticData[f].minLastRecvGap=Math.min(ve,$e),I.recvStats.statisticData[f].maxLastRecvGap=Math.max(fe,$e),I.recvStats.statisticData[f].avgLastRecvGap=parseInt((Se*(_e-1)+$e)/_e,10),0===$e&&I.recvStats.statisticData[f].noDataCount++}else I.recvStats.statisticData[f].minLastRecvGap=0,I.recvStats.statisticData[f].noDataCount++;I.recvStats.statisticData[f].maxFps=Math.max(de,M),I.recvStats.statisticData[f].minFps=Math.min(ce,M),I.recvStats.statisticData[f].avgFps=Math.round((w-Me)/((E-ye)/1e3)),I.recvStats.statisticData[f].maxDecodeTime=Math.max(ue,Xe),I.recvStats.statisticData[f].minDecodeTime=Math.min(Xe,he),I.recvStats.statisticData[f].avgDecodeTime=(U-Re)/(w-Me)||0,I.recvStats.statisticData[f].prevTotalDecodeTime=U,I.recvStats.statisticData[f].prevFramesDecoded=w,I.recvStats.statisticData[f].maxLossRate=Math.max(le,Ke),I.recvStats.statisticData[f].avgLossRate=(G-Ee)/(Ye+(G-Ee))||0,I.recvStats.statisticData[f].maxJitter=Math.max(ge,H),I.recvStats.statisticData[f].maxBt=Math.max(_,pe),I.recvStats.statisticData[f].minBt=Math.min(_,me),I.recvStats.statisticData[f].avgBt=Ze,I.recvStats.statisticData[f].isVideoPlaying=te,I.recvStats.statisticData[f].framesRendered=ie-re,I.recvStats.statisticData[f].framesRenderDrop=re}else _=8*P/O*M||"",I.recvStats.statisticData[f]={maxFps:M,minFps:M,avgFps:M,maxDecodeTime:0,minDecodeTime:Number.MAX_SAFE_INTEGER,avgDecodeTime:0,maxLossRate:0,avgLossRate:0,maxBt:_,minBt:_,avgBt:_,maxJitter:H,minLastRecvGap:Number.MAX_SAFE_INTEGER,maxLastRecvGap:0,avgLastRecvGap:0,isVideoPlaying:te,framesRendered:ie-re,framesRenderDrop:re,noDataCount:0,count:0};if(L&&D){var et=L*D;et>a&&(I.uiQosData.receiving={avg_loss:Math.max(1e3*I.recvStats.statisticData[f].avgLossRate,0),max_loss:Math.max(1e3*I.recvStats.statisticData[f].maxLossRate,0),fps:M||0,height:D,width:L,jitter:Math.round(1e3*(H||0))},a=et)}I.bToPrint&&I._renderStatsData(m,L,D,M,_)}else if(m&&"inbound-rtp"===r&&!I.mIdMgr.getMidReleasedStatus(m)){var tt=e.lastPacketReceivedTimestamp;tt&&(new Date).getTime()-tt>5e3&&I.mIdMgr.setMidReleasedStatus(m,!0)}f&&(I.recvStats[h][f]||(I.recvStats[h][f]=e),I.recvStats[n][f]=e)}})),u&&!this.isDecodeSuccess&&(V.globalTrace({logLevel:"error",log:"WMSC renegotiation: "+this.recvCodecProfileLevelId}),Oe("WMSC_RN-"+this.recvCodecProfileLevelId),this.onDecodeError&&this.onDecodeError(this.recvCodecProfileLevelId),this.recvCodecProfileLevelId=""),this.recvStats.candidatePairs=s,this.recvStats.candidates=o,(h=this.recvStats.transport)&&(l=h.selectedCandidatePairId,"connected"===h.dtlsState&&(p=s[l])&&(m=p.localCandidateId,g=p.remoteCandidateId,v=p.currentRoundTripTime,S=void 0===v?0:v,this.recvStats["remote-candidate"]=o[g],this.recvStats["local-candidate"]=o[m],this.recvStats["candidate-pair"]=p,this.recvStats["begin-candidate-pair"]?(_=this.recvStats.statisticData.maxRtt,this.recvStats.statisticData.maxRtt=Math.max(_,S)):(this.recvStats["begin-candidate-pair"]=p,this.recvStats.statisticData.maxRtt=S))),d!==this.candidateLog[0]&&(V.directSendMonitorLog("WMSC_CANDIDATE 0: "+d),this.candidateLog[0]=d),c!==this.candidatePairLog[0]&&(this.candidatePairChangeCount[0]++,this.candidatePairLog[0]=c);case 22:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t._getVideoSenderLog=function(){var e="",t="{[ENCO]},";for(var i in this.sendStats){var r=this.sendStats[i];if(r["video-media-source"])for(var n in r["video-outbound-rtp"]){var a=r.statisticData[n],s=a.minEncodeFrameRate,o=a.maxEncodeFrameRate,d=a.avgEncodeFrameRate,c=a.minSendFrameRate,u=a.maxSendFrameRate,h=a.avgSendFrameRate,l=a.minSendBitRate,p=a.maxSendBitRate,m=a.avgSendBitRate,g=a.maxEncodeTime,v=a.minEncodeTime,f=a.avgEncodeTime,S=a.maxPacketSentDelay,_=a.minPacketSentDelay,I=a.avgPacketSentDelay,b=a.sendWidth,y=void 0===b?"":b,M=a.sendHeight,R=void 0===M?"":M,E=r.statisticData,C=E.minCaptureFps,w=E.maxCaptureFps,T=E.avgCaptureFps,L=E.captureHeight,x=E.captureWidth,D=E.minCamCaptureFps,B=E.maxCamCaptureFps,P=E.avgCamCaptureFps;this.camStream||(D=C,B=w,P=T);var A=r["video-outbound-rtp"][n],O=A.keyFramesEncoded,N=void 0===O?"":O,V=A.qualityLimitationReason,U=void 0===V?"":V,k=A.pliCount,F=void 0===k?"":k,W=A.nackCount,z=void 0===W?"":W,G=A.firCount,j=void 0===G?"":G,H=A.framesSent,q=void 0===H?"":H,J=A.retransmittedPacketsSent,Q=void 0===J?"":J,Y=A.powerEfficientEncoder,K=A.hugeFramesSent,X=void 0===K?"":K,Z=A.packetsSent,$=void 0===Z?"":Z,ee=A.bytesSent,te=void 0===ee?"":ee,ie=A.qualityLimitationDurations,re=void 0===ie?{}:ie,ne=A.encoderImplementation,ae=void 0===ne?"":ne,se=A.targetBitrate,oe=void 0===se?"":se,de=re.bandwidth,ce=void 0===de?"":de,ue=re.cpu,he=void 0===ue?"":ue,le=re.none,pe=void 0===le?"":le,me=re.other,ge=void 0===me?"":me,ve=(r.codec||{}).mimeType,fe=-1!==(void 0===ve?"h264":ve).toLowerCase().indexOf("h264")?0:2;Y&&(fe|=1),e+=x+","+L+","+w+","+C+","+T+",,,,,,,"+o+","+s+","+d+","+p+","+l+","+m+","+u+","+c+","+h+","+y+","+R+","+q+",,,,"+B+","+D+","+P+","+(isNaN(S)?"":S)+","+(isNaN(_)?"":_)+","+(isNaN(I)?"":I)+","+$+","+te+","+N+","+X+","+z+","+j+","+F+","+Q+","+U+","+ce+","+he+","+ge+","+pe+","+ae+","+oe+","+n+",",t+=(1e3*g).toFixed(2)+","+(1e3*v).toFixed(2)+","+(1e3*f).toFixed(2)+",,"+fe+","+n+","}}return e?"{[SEND]},"+this.maxSubscribedSize+","+e+t:""},t._getVideoReceiveLog=function(){var e,t=this,i=new Array(8).fill(0),r=new Array(8).fill(0),n=-1,a=new Set,s={};for(var o in this.recvStats["video-inbound-rtp"]){var d=this.recvStats.statisticData[o]||{},c=d.maxFps,u=d.minFps,h=d.avgFps,l=d.maxBt,p=d.minBt,m=d.avgBt,g=d.framesRenderDrop,v=d.framesRendered,f=d.isVideoPlaying,S=d.minLastRecvGap,_=d.maxLastRecvGap,I=d.avgLastRecvGap,b=d.noDataCount,M=d.count,R=this.recvStats["video-inbound-rtp"][o]||{},E=this.recvStats["begin-video-inbound-rtp"][o]||{},C=E.framesReceived,w=void 0===C?"":C,T=E.framesDropped,L=void 0===T?"":T,D=E.framesDecoded,B=void 0===D?"":D,P=E.totalProcessingDelay,A=void 0===P?"":P,O=R.frameHeight,N=void 0===O?0:O,U=R.frameWidth,k=void 0===U?0:U,F=R.freezeCount,W=void 0===F?"":F,z=R.framesReceived,G=void 0===z?"":z,j=R.framesDropped,H=void 0===j?"":j,q=R.keyFramesDecoded,J=void 0===q?"":q,Q=R.pauseCount,Y=void 0===Q?"":Q,K=R.nackCount,X=void 0===K?"":K,Z=R.firCount,$=void 0===Z?"":Z,ee=R.pliCount,te=void 0===ee?"":ee,ie=R.totalProcessingDelay,re=void 0===ie?"":ie,ne=R.fecPacketsReceived,ae=void 0===ne?"":ne,se=R.retransmittedPacketsReceived,oe=void 0===se?"":se,de=R.framesDecoded,ce=void 0===de?"":de,ue=R.bytesReceived,he=void 0===ue?"":ue,le=R.packetsReceived,pe=void 0===le?"":le,me=R.packetsLost,ge=void 0===me?"":me,ve=R.jitterBufferDelay,fe=void 0===ve?0:ve,Se=R.jitterBufferEmittedCount,_e=void 0===Se?"":Se,Ie=R.ssrc,be=void 0===Ie?"":Ie,ye=G-w,Me=H-L,Re=(Me/ye||0).toFixed(2),Ee=((re-A)/(ce-B)*1e3||0).toFixed(2),Ce=ce-B;if(void 0!==this.subInfo[o]){var we=k*N;we>n&&(n=we,e=parseInt(o,10)),we>0&&r[this.getResolutionId(we)]++}else a.add(parseInt(o,10));s[o]=c+","+u+","+h+","+k+","+N+","+o+","+M+","+b+",,,,,,,,,,,,,"+ye+","+Me+","+Re+","+(this.subInfo[o]||"")+",,,,"+Ce+","+f+","+v+","+g+","+(l||0).toFixed(2)+","+(p||0).toFixed(2)+","+(m||0).toFixed(2)+","+pe+","+ge+","+he+","+J+","+Y+","+W+","+X+","+$+","+te+","+ae+","+oe+","+Ee+","+Math.round(1e3*fe)+","+_e+","+_+","+S+","+I+","+be+","+this.ssrcMidMap[be]}for(var Te in this.activeSpeaker&&!a.has(this.activeSpeaker)&&this.recvStats.statisticData[this.activeSpeaker]?this.recordUserId=this.activeSpeaker:this.recordUserId=e,this.subInfo)i[this.subInfo[Te]]++;var Le="{[RECV]},"+i.join(",")+","+r.join(",")+",";if(this.recvStatisticData[(new Date).toUTCString()]=s,this.reportCount%4==0)try{var xe=JSON.stringify(this.recvStatisticData);x(xe,y.GZIP_BASE64).then((function(e){V.globalTrace({logLevel:"log",log:"WCL_WB_VIDEO,"+e}),t.recvStatisticData={}})).catch((function(e){V.globalTrace({logLevel:"error",log:"WMSC compress video log failed",errorEvent:e}),V.globalTrace({logLevel:"log",log:"WCL_WB_VIDEO,"+xe}),t.recvStatisticData={}}))}catch(e){V.globalTrace({logLevel:"error",log:"WMSC_Video_Log_Parse_Failed",errorEvent:e}),this.recvStatisticData={}}return s[this.recordUserId]?""+Le+s[this.recordUserId]:Le},t._getVideoDecodeLog=function(){if(!this.recvStats.statisticData[this.recordUserId])return"";var e=this.recvStats.statisticData[this.recordUserId],t=e.maxDecodeTime,i=e.minDecodeTime,r=e.avgDecodeTime,n=this.recvStats.codec||{},a=this.recvStats["video-inbound-rtp"][this.recordUserId],s=a.powerEfficientDecoder,o=a.decoderImplementation,d=void 0===o?"":o,c=n.mimeType,u=(-1!==(void 0===c?"h264":c).toLowerCase().indexOf("h264")?0:2)|(s?1:0);return"{[DECO]},"+(1e3*t).toFixed(2)+","+(1e3*i).toFixed(2)+","+(1e3*r).toFixed(3)+",,"+u+","+d},t._getDownLinkLog=function(){var e=this.recvStats.statisticData[this.recordUserId]||{},t=e.maxLossRate,i=void 0===t?"":t,r=e.avgLossRate,n=void 0===r?"":r,a=e.maxJitter,s=void 0===a?"":a,o=this.recvStats["video-inbound-rtp"][this.recordUserId]||{},d=o.packetsLost,c=void 0===d?"":d,u=o.jitter,h=void 0===u?"":u,l=this.recvStats["remote-candidate"]||{},p=this.recvStats["candidate-pair"]||{},m=this.recvStats["begin-candidate-pair"]||{},g=this.recvStats.statisticData.maxRtt,v=l.protocol,f=p.availableIncomingBitrate,S=void 0===f?"":f,_=p.bytesReceived,I=void 0===_?"":_,b=p.timestamp,y=void 0===b?"":b,M=p.totalRoundTripTime,R=void 0===M?"":M,E=p.responsesReceived,C=void 0===E?"":E,w=p.packetsReceived,T=void 0===w?"":w,L=(8*(I-m.bytesReceived)/((y-m.timestamp)/1e3)).toFixed(2),x=Math.round(R/C*1e3)||"";return"RWG_WB_DOWNLINK_NETWORK,"+this.userId+",3,"+("udp"===v?0:1)+","+Math.round(y/1e3)+",,"+S+","+L+","+(100*n).toFixed(2)+","+(100*i).toFixed(2)+",,,,"+x+","+1e3*g+","+T+","+c+",,,,,,,,,"+Math.round(1e3*h)+","+Math.round(1e3*s)},t._getUpLinkLog=function(){var e="";for(var t in this.sendStats){var i=this.sendStats[t]["candidate-pair"]||{},r=this.sendStats[t]["begin-candidate-pair"]||{},n=this.sendStats[t]["remote-candidate"]||{},a=this.sendStats[t]["video-remote-inbound-rtp"]||{},s=i.timestamp,o=i.availableOutgoingBitrate,d=void 0===o?"":o,c=i.bytesSent,u=i.totalRoundTripTime,h=i.responsesReceived,l=i.packetsSent,p=void 0===l?"":l,m=r.timestamp,g=r.bytesSent,v=n.protocol,f=this.sendStats[t].statisticData,S=void 0===f?{}:f,_=isNaN(S.maxRtt)?"":Math.round(1e3*S.maxRtt),I="",b="",y="",M="",R="";for(var E in a){var C=S[E],w=C.maxJitter,T=C.avgLossRate,L=C.maxLossRate,x=a[E],D=x.packetsLost,B=x.jitter;if(w&&!y&&(y=Math.round(1e3*w)),T&&!I&&(I=Math.round(100*T)),L&&!b&&(b=Math.round(100*L)),D&&!M&&(M=D),B&&!R&&(R=Math.round(1e3*B)),I&&b&&y&&M&&R)break}var P=(8*(c-g)/((s-m)/1e3)).toFixed(2),A=Math.round(u/h*1e3)||"";e+=",3,"+("udp"===v?0:1)+","+Math.round(s/1e3)+",,"+d+","+P+","+I+","+b+",,,,"+A+","+_+","+p+","+M+",,,,,,,,,"+R+","+y}return e?"RWG_WB_UPLINK_NETWORK,"+this.userId+e:""},t._getStats=function(){var e,t,i=this,r="WCL_WB_MCM_VIDEO,"+this.userId+",,"+(document.hidden?0:1)+",,",n=this._getVideoSenderLog(),a=this._getVideoReceiveLog(),s=this._getVideoDecodeLog();this.reportCount%2==0&&(e=this._getDownLinkLog(),t=this._getUpLinkLog()),(r+=n+a+s+"{[END]}")&&V.directSendMonitorLog(r),e&&V.directSendMonitorLog(e),t&&V.directSendMonitorLog(t),this.candidatePairMonitorLog=this.candidatePairMonitorLog.map((function(e,t){var r=i.candidatePairLog[t];return e!==r&&V.directSendMonitorLog("WMSC_CANDIDATE-PAIR: "+t+"|"+r+"|"+i.candidatePairChangeCount[t]),i.candidatePairChangeCount[t]=0,r})),this.bToPrint&&(r&&Ae.log("_getStats, video log: "+r),e&&Ae.log("_getStats, downlink log: "+e),t&&Ae.log("_getStats, uplink log: "+t))},t._renderStatsData=function(e,t,i,r,n){void 0===t&&(t=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===n&&(n=0)},t.checkSendPCsStat=function(){var e,t,i,r,n,a,s,o=[],d=f.EGRESS,c=Ie.getPc(d);if(c&&"connected"===c.connectionState&&this.sendStats[d]){var u=this.sendStats[d]["candidate-pair"]||{},h=this.sendStats[d]["video-outbound-rtp"]||{},l=h[Object.keys(h)[0]]||{},p={peerId:+d};p.bytesSent=u.bytesSent,p.availableOutgoingBitrate=u.availableOutgoingBitrate;var m=parseInt(1e3*(null!=(e=u.currentRoundTripTime)?e:0));p.rtt=m>1e4?1e4:m<0?0:m,p.timestamp=parseInt(null!=(t=l.timestamp)?t:0),p.framerate=l.framesPerSecond,p.frameHeight=l.frameHeight,p.frameWidth=l.frameWidth,p.rtpPacketsSent=l.packetsSent,p.rtpBytesSent=l.bytesSent,p.rtxBytesSent=l.retransmittedBytesSent,p.rtxPacketsSent=l.retransmittedPacketsSent,p.qualityLimitationDurationsBW=parseInt(null!=(i=null==(r=l.qualityLimitationDurations)?void 0:r.bandwidth)?i:0),p.qualityLimitationDurationsCPU=parseInt(null!=(n=null==(a=l.qualityLimitationDurations)?void 0:a.cpu)?n:0),p.qualityLimitationReason=null!=(s=l.qualityLimitationReason)?s:"none";var g=this.lastSendPCsStatRecord.get(d),v=g&&g.bytesSent||0,S=g&&g.timestamp||0;null!=p.bytesSent||(p.bytesSent=0),null!=p.timestamp||(p.timestamp=0);var _=p.timestamp-S||2e3;p.bitrate=p.bytesSent&&parseInt(8e3*(p.bytesSent-v)/_)||0,o.push(p),this.lastSendPCsStatRecord.set(d,p),this.sendQoSData(o)}},t.sendSdpLog=function(e,t,i){var r=this;try{var n,a=W.parseSdp(i),s=a.session,o=a.media,d=void 0===o?[]:o,c=s.groups,h=void 0===c?[]:c,l=d[0]||{},p=l.direction,m=void 0===p?"":p,g=l.codecs,v=void 0===g?[]:g,S=l.extensionMap,_=l.bandwidth,I=l.candidates,b=new Array(4).fill(-1),M=[],R={},E="WCL_WB_SDP_"+t+","+this.userId+","+e+","+((null==(n=h[0])?void 0:n.ids.length)||0)+","+this.sdpDirection[m]+",";if(S)for(var C,w=u(S);!(C=w()).done;){var T=C.value,L=T[0],D=T[1].uri,B=this.rtpHeaderExt[D];void 0!==B&&(b[B]=L)}E+=b.join(",")+",",v.forEach((function(i){var n=i.codecName,a=i.codecParams,s=i.payloadType,o=i.associatedPayloadType,d=void 0===o?"":o;"H264"===n&&a?"1"===a.get("packetization-mode")&&(M.push(s),M.push(a.get("profile-level-id")),M.push(a.get("max-mbps")||""),M.push(a.get("max-fs")||""),M.push(a.get("x-google-start-bitrate")||""),M.push(a.get("x-google-max-bitrate")||""),M.push(a.get("x-google-min-bitrate")||""),e===f.INGRESS&&"ANSWER"===t&&(r.recvCodecProfileLevelId=a.get("profile-level-id"))):"rtx"===n&&(R[d]=s)}));for(var P=0,A=M.length;P<A;P+=7){var O=M[P];E+=O+","+M[P+1]+","+M[P+2]+","+M[P+3]+","+M[P+4]+","+M[P+5]+","+M[P+6]+","+R[O]+","}d.forEach((function(e){var t=e.ssrcGroups,i=e.mid;t.forEach((function(e){var t=e.semantics,n=e.ssrcs;"FID"===t&&(r.ssrcMidMap[n[0]]=i,E+=n.join(",")+",")}))})),E+=(_||"")+",",I&&I.length>0&&I.forEach((function(e){var t=e.transport,i=e.address,r=e.port,n=e.priority;E+=n+","+("udp"===t?0:1)+","+i+","+r+","})),V.directSendMonitorLog(E),x(i,y.GZIP_BASE64).then((function(i){V.globalTrace({logLevel:"log",log:"WCL_WB_SDP-"+e+"-"+t+"-"+i})}))}catch(r){V.globalTrace({logLevel:"error",log:"WMSCMonitor sendSdpLog error",errorEvent:r}),V.globalTrace({logLevel:"log",log:"WCL_WB_SDP: "+e+"|"+t+"|"+i}),Oe("WMSC_SDPLE: "+e+"|"+t)}},t._getCandidatePairLog=function(e){var t=e.localCandidateId,i=e.remoteCandidateId,r=e.nominated,n=e.state,a=e.priority;return(void 0===a?"":a)+","+t+","+i+","+this.iceCandidatePairState[n]+","+(r?1:0)+","},t._getCandidateLog=function(e){var t=e.id,i=e.candidateType,r=e.port,n=e.priority,a=e.protocol,s=e.type,o=e.networkType;return t+","+n+","+a+","+i+","+r+","+(void 0===o?"":o)+","+("remote-candidate"===s?1:0)+","},t.onReceiverReport=function(e){var t=this.ingressReport,i=t.begin,r=t.current;this.ingressReport.prev=r,this.ingressReport.current=e,i||(this.ingressReport.begin=r)},e}()),Ve=V.getTracer("WmscApiImpl"),Ue=function(e){Ve.log(e),V.monitorLog(""+e)},ke=f.INGRESS,Fe=f.EGRESS,We=function(){function e(e,t){Ve.log("created, config: "+JSON.stringify(e)),M.setConfig(e||{}),this.messageCallback=t,this.resetRunTimeParams(),Pe.setLimits({maxSendVideoSize:M.maxCaptureVideoSize,maxRecvVideoNum:M.maxRecvVideoNum});var i=Pe.getCapabilities(),r=i.maxSendVideoSize,n=i.maxRecvVideoSize,a=i.maxRecvVideoNum;Ue("WMSC_V_Cap_Updated: "+r+"|"+n+"|"+a),this.maxRecvVideoNum=a,this.maxRecvVideoSize=n,Ie.registerMessageCallback(this.onMediaMessage.bind(this)),Ie.enableHdVideo(M.hdVideoEnabled),Ie.setMaxSendLayerId(r),Ie.setVideoSettings(M.videoSettings),this.renewEgressPeerConnection(),this.renewIngressPeerConnection(),Ne.setUserId(M.nodeId),Ne.onDecodeError=this._handleDecodeError.bind(this),Ne.start(),fe.registerSendUsageStateUpdateCallback(this.onSendUsageStateUpdate.bind(this)),fe.registerMaxRecvVideoSizeUpdateCallback(this.onMaxRecvVideoSizeUpdate.bind(this)),fe.start(M.qosOptions),this.recevCSRCRecord=new Map,this._checkCSRCTimer=null,this.negotiationMsgId=0}var t=e.prototype;return t.destroy=function(){this.closeAllPeerConnections(),this.resetRunTimeParams(),this.recevCSRCRecord.clear(),clearInterval(this._checkCSRCTimer),fe.stop(),null==Ne||Ne.stop()},t.resetRunTimeParams=function(){Ve.log("reset run time parameters"),this.pcInfos=new Map([[ke,{status:S.IDLE,reconnectionCount:0,negotiationTimer:0,offerMsgId:0}],[Fe,{status:S.IDLE,reconnectionCount:0,negotiationTimer:0,offerMsgId:0}]]),this.camStreams=null,this.bSendEnabled=!1,this.bActiveVideo=!1,this.bPrevActiveVideo=!1,this.lastSubList=[],this.bReceiveEnabled=!1,this._toSubscribeBuffer=[],this._videoTagMappingBuffer=new Map,this.mIdMgr=null,this.subscriptions=new Map,this.maxSubVideoSize=-1},t.renewEgressPeerConnection=function(){var e=a(r().mark((function e(){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.createPeerConnection(Fe,"video","sendonly"),this.camStreams&&this._addVideoStreams(this.camStreams),this.bSendEnabled=!0,e.next=5,this.startNegotiation(Fe);case 5:Ie.onMediaRequest(this.lastSubList);case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.renewIngressPeerConnection=function(){var e=a(r().mark((function e(){var t;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return Ue("WMSC_Start_Recv_Video"),this.createPeerConnection(ke,"video","recvonly"),this.bReceiveEnabled=!0,e.next=5,this.startNegotiation(ke);case 5:null!=(t=Array.from(Ie.getRecvTransceivers().keys()))&&t.length?(this.mIdMgr=this.mIdMgr||new Be(t),this._mapBufferedVideoTag()):(Ue("WMSC_Get_Recv_Mid_Fail: "+ke),this.mIdMgr=new Be([])),Ne.mIdMgr=this.mIdMgr;case 8:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.stopReceiveVideo=function(){Ue("WMSC_Stop_Recv_Video"),this.sendBye(ke),this.closePeerConnection(ke),this.mIdMgr=null,this.bReceiveEnabled=!1},t.createPeerConnection=function(e,t,i){Ve.log("createPeerConnection, peerId: "+e+", type: "+t+" direction: "+i);var r=e===ke?this.maxRecvVideoNum:1;return Ie.createPeerConnection(e,t,i,r)},t._addVideoStreams=function(){var e=a(r().mark((function e(t){var i,n;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return null!=t&&t.length&&(i=null==(n=t[0].stream)?void 0:n.getVideoTracks()[0]),e.next=3,Ie.publishVideoTrack(i);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),t.onVideoStreamsAsync=function(){var e=a(r().mark((function e(t){var i,n,a,s;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return null!=t&&t.length&&(s=null==(n=t[0].stream)||null==(a=n.getVideoTracks()[0])?void 0:a.getSettings())&&Ue("WMSC_Origin_Video_Stream: "+s.width+"x"+s.height+"--\x3e"+s.frameRate),this.camStreams=t,Ne.camStream=null==(i=t[1])?void 0:i.stream,e.next=5,this._addVideoStreams(t);case 5:return e.abrupt("return",Promise.resolve(!0));case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.startNegotiation=function(){var e=a(r().mark((function e(t){var i,n,a=this;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(i=this._getPcInfo(t)).negotiationTimer=setTimeout((function(){var e=Ie.getNegotiationTime(t);V.globalTrace({logLevel:"error",log:"WMSC Negotiation timeout: "+t+"-"+e.join("-")}),i.reconnectionCount<3?a.restartNegotiation(t):a.messageCallback({type:l.SDP_NEGOTIATION_FAIL,data:t})}),1e4),e.next=4,Ie.createOffer(t);case 4:n=e.sent,this._handleSdpOffer(t,n);case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.restartNegotiation=function(e){var t=this._getPcInfo(e);t.reconnectionCount++,Ue("WMSC_Restart_Nego: "+e+"|"+t.reconnectionCount),this.sendBye(e),this.closePeerConnection(e),e===ke?this.bReceiveEnabled&&this.renewIngressPeerConnection():this.renewEgressPeerConnection()},t.closePeerConnection=function(e){var t=this._getPcInfo(e);return clearTimeout(t.negotiationTimer),t.status=S.IDLE,Ie.closePeerConnection(e)},t.closeAllPeerConnections=function(){for(var e,t=u(this.pcInfos.keys());!(e=t()).done;){var i=e.value;this.closePeerConnection(i)}},t.onMediaMessage=function(e){var t=e.type,i=e.data,r=e.peerId;switch(Ve.log("onMediaMessage, peerId: "+r+" type: "+t),t){case _.STREAM:this._handleRemoteStream(r,i);break;case _.PC_STATE_CHANGE:this._handlePcStateChange(r,i);break;case _.ERROR:Ve.error("onMediaMessage, error: "+i);break;default:Ve.error("onMediaMessage, unknown type: "+t)}},t.onSendUsageStateUpdate=function(e){this._maybeUpdateVideoSourceConstraints(e)},t._maybeUpdateVideoSourceConstraints=function(e){if(e===b.UNDERUSING){var t=this.camStreams[0],i=ie({width:t.width,height:t.height}),r=M.maxCaptureVideoSize;if(M.hdVideoEnabled||(r=Math.min(2,r)),i>=0&&i<r){var n=X(i+1),a={width:n.width,height:n.height,frameRate:n.maxFramerate};return this.messageCallback({type:l.UPDATE_VIDEO_CAPTURE_CONSTRAINTS,data:a}),!0}}return!1},t.onMaxRecvVideoSizeUpdate=function(e){this.maxRecvVideoSize=e;for(var t,i=[],r=u(this.subscriptions);!(t=r()).done;){var n=t.value,a=n[0],s=n[1],o=this.mIdMgr.getVideoSizeByUserId(a),d=Math.min(e,s);o!==d&&i.push({id:a,size:d})}i.length&&this._updateSubscriptions(i)},t.onVideoTagMapping=function(e){var t,i=parseInt(e.userId),r=e.videodom,n=e.action;if(Ue("WMSC_Video_Tag_Mapping: "+i+"|"+n),"remove"!==n)return Ve.log("onVideoTagMapping, userId: "+i),this.mIdMgr?(this.mIdMgr.saveVideoTag(i,r),this.messageCallback({type:l.VIDEO_TAG_MAPPED,data:i}),!0):(Ve.warn("onVideoTagMapping, mIdMgr not ready yet. Will do mapping later."),this._videoTagMappingBuffer.set(i,r),!0);null==(t=this.mIdMgr)||t.removeVideoTag(i,r)},t._mapBufferedVideoTag=function(){var e=this;this._videoTagMappingBuffer.size&&(this._videoTagMappingBuffer.forEach((function(t,i){e.onVideoTagMapping({userId:i,videodom:t})})),this._videoTagMappingBuffer.clear())},t.subscribeVideo=function(e){var t=this,i=this._getPcInfo(ke);if(i.status!==S.CONNECTED)return e.forEach((function(e){t._toSubscribeBuffer.push({params:e,toSub:!0})})),void Ue("WMSC_SubV_PC_N_Ready: "+i.status);var r=Math.min(this.maxRecvVideoSize,fe.getMaxFeasibleRecvVideoSize()),n=-1,a=[];e.forEach((function(e){var i=e.id,s=e.size;t.subscriptions.set(i,s),s>n&&(n=s);var o=Math.min(s,r),d=t._addSubscription({id:i,size:o});if(d){a.push(d);var c=d.userId,u=d.mId,h=d.videoSize;t._updateVideoElement(c,u),t.mIdMgr.setMidReleasedStatus(u,!1),Ue("WMSC_Send_Stream_Mapping: "+c+"ï½œ"+h+"ï½œ"+u),Ne.updateSubInfo(c,h)}})),n>this.maxSubVideoSize&&(this.maxSubVideoSize=n,fe.updateMaxSubVideoSize(n)),a.length&&this._sendStreamMappings(a)},t.unSubscribeVideo=function(e){var t=this;if(this._getPcInfo(ke).status!==S.CONNECTED)return e.forEach((function(e){t._toSubscribeBuffer.push({params:e,toSub:!1})})),void Ue("WMSC_UnsubV_PC_N_Ready");var i=-1,r=[];e.forEach((function(e){t.subscriptions.delete(e.id);var i=t._removeSubscription(e);if(i){var n=i.userId,a=i.videoSize;r.push(i),Ne.updateSubInfo(n,a)}}));for(var n,a=u(this.subscriptions);!(n=a()).done;){var s=n.value[1];s>i&&(i=s)}this.maxSubVideoSize!==i&&(this.maxSubVideoSize=i,fe.updateMaxSubVideoSize(i)),r.length&&this._sendStreamMappings(r)},t._addSubscription=function(e){var t,i,r=parseInt(e.id),n=e.size;Ue("WMSC_SubV_Params: "+r+"|"+n);var a=(null==(t=this.mIdMgr)?void 0:t.getMId(r))||(null==(i=this.mIdMgr)?void 0:i.getNewMId(r));if(a)return this.mIdMgr.setVideoSize(a,n),Ve.log("_addSubscription, userId: "+r+", mId: "+a+", videoSize: "+n),{userId:r,mId:a,videoSize:n};Ue("WMSC_SubV_No_Mid")},t._removeSubscription=function(e){var t,i=parseInt(e.id);this._videoTagMappingBuffer.delete(i),clearInterval(this.recevCSRCRecord.get(i));var r=null==(t=this.mIdMgr)?void 0:t.getMId(i);if(Ue("WMSC_UnsubV_Params: "+i+"|"+r),r)return this.mIdMgr.releaseMId(r),this.recevCSRCRecord.delete(i),{userId:i,mId:r,videoSize:-1}},t._updateSubscriptions=function(e){var t=this,i=[],r=[];e.forEach((function(e){var n,a=e.id,s=e.size,o=null==(n=t.mIdMgr)?void 0:n.getMId(a);o&&(i.push({userId:a,mId:o,videoSize:-1}),r.push({userId:a,mId:o,videoSize:s}),t.mIdMgr.setVideoSize(o,s))})),this._sendStreamMappings(i),this._sendStreamMappings(r)},t.onRwgMessage=function(e){var t="string"==typeof e.data?JSON.parse(e.data):e.data;return t.evt===we?this.onWebRtcMediaNegotiationMessage(t.body):t.evt===Te?this.onWebRtcMediaActionMessage(t.body):void 0},t.onWebRtcMediaNegotiationMessage=function(e){switch(Ue("WMSC_Recv_Nego_Msg: "+e.type),e.type){case ye:return Ve.log("on SDP_ANSWER"),this.onSdpAnswer(e),!0;case Me:return Ve.log("on SDP_BYE"),this.onSdpBye(e),!0;default:return Ve.warn("Received unknown RWG message type: "+e.type),!1}},t.onWebRtcMediaActionMessage=function(e){switch(e.type){case Ce:return this.onSubscribeList(e.activeVideo,e.prevActiveVideo,e.privateVideo),!0;case Ee:return this.onCommand(e),!0;default:return Ve.warn("Received unknown RWG message type: "+e.type),!1}},t.onSdpAnswer=function(){var e=a(r().mark((function e(t){var i,n,a,s,o,d,c;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=t.peerID,n=t.msgID,a=t.sdp,s=t.sdpEncoding,o=this._getPcInfo(t.peerID),d=o.offerMsgId,n===d){e.next=5;break}return Ve.warn("Answer message id "+n+" doesn't match the offer message id "+d+" for peer id "+i),e.abrupt("return");case 5:return e.prev=5,e.next=8,B(a,s);case 8:return c=e.sent,Ne.sendSdpLog(i,"ANSWER",c),e.abrupt("return",Ie.setAnswer(i,c));case 13:e.prev=13,e.t0=e.catch(5),V.globalTrace({logLevel:"error",log:"WMSC_Decompress_SDP_Anwser_F",error:e.t0});case 16:case"end":return e.stop()}}),e,this,[[5,13]])})));return function(t){return e.apply(this,arguments)}}(),t.onSdpBye=function(e){var t=e.peerID,i=e.msgID,r=this._getPcInfo(e.peerID).offerMsgId;i===r?(this.closePeerConnection(t),this.bSendEnabled=!1):Ve.warn("Bye message id "+i+" doesn't match the offer message id "+r+" for peer id "+t+" ")},t.onSubscribeList=function(e,t,i){Ue(N("WMSC_On_Sub_List: "+JSON.stringify(e)+"|"+JSON.stringify(t)+"|"+JSON.stringify(i))),Ne.updateSubscribedSize(e,t,i);var r=Array.from(new Set([].concat(e,t,i)).values()).filter((function(e){return e>=0})).sort();A(r,this.lastSubList)||(this.lastSubList=[].concat(r),this.bSendEnabled||this.renewEgressPeerConnection(),Ie.onMediaRequest(r))},t.onCommand=function(e){if(0===e.cmdId){var t;try{t=JSON.parse(e.cmdParam)}catch(t){Ve.warn("Invalid command message: "+JSON.stringify(e))}void 0!==t.receiverBW?fe.onReceiverBandwidthReport(t.receiverBW):void 0!==t.subInfo?fe.onSubInfo(t.subInfo):void 0!==t.ingressReport&&(fe.onReceiverReport(t.ingressReport),Ne.onReceiverReport(t.ingressReport))}else Ve.warn("Unknown command id "+e.cmdId)},t.onActiveVideoSourceChange=function(e){var t=parseInt(M.nodeId)===parseInt(e.userId);return this.bPrevActiveVideo=this.bActiveVideo&&!t,this.bActiveVideo=t,Ne.setActiveSpeaker(e.userId,this.bPrevActiveVideo),Ue("WMSC_OASC: "+e.userId),!0},t.updateWmscParams=function(e){Ve.log("updateWmscParams, data: "+JSON.stringify(e)),Object.keys(e).forEach((function(t){var i;"HDVideo"===t?(M.setConfig(((i={})[t]=e[t],i)),Ie.enableHdVideo(!!e[t])):Ve.warn("updateWmscParams, unknown param name: "+t)}))},t.sendBye=function(e){var t=function(e,t,i,r,n,a){return{type:Me,confID:e,sessionID:t,userID:i,peerID:r,msgID:n,sdp:a}}(M.confId,g.VIDEO,M.nodeId,e,++this.negotiationMsgId,"");Ue("WMSC_SDPBYE: "+M.confId+"|"+e),this._sendMessageToRwg({evt:we,body:t})},t.stopSendingVideo=function(){this._getPcInfo(Fe).status=S.IDLE,this.sendBye(Fe),Ie.stopSendingVideo()},t._sendStreamMappings=function(e){var t=e.map((function(e){var t=e.userId,i=e.mId,r=e.videoSize;return function(e,t,i,r,n,a,s){return{type:Re,confID:e,sessionID:t,userID:i,peerID:r,mID:n,streamID:a,videoSize:s}}(M.confId,g.VIDEO,t,ke,i,r>=0?function(e,t){var i=0;switch(t){case g.VIDEO:i=v.VIDEO;break;case g.AUDIO:i=v.AUDIO;break;case g.SHARE:i=v.SHARE}return-4&e|i}(t,g.VIDEO):0,r)}));this.messageCallback({type:l.WMSC_MAPPING_STREAMID_AND_MID,data:JSON.stringify({evt:Te,body:t})})},t._sendMessageToRwg=function(e){this.messageCallback({type:l.WMSC_MESSAGE_TO_RWG_BY_SDK,data:JSON.stringify(e)})},t._handleRemoteStream=function(e,t){var i,r;if(e!==ke){var n="WMSC_RSP_N_M: "+e;return Ve.warn(n),void Ue(n)}var a=new MediaStream;a.addTrack(t.track);var s=t.transceiver.mid;null==(i=this.mIdMgr)||i.updateStream(s,a);var o=null==(r=this.mIdMgr)?void 0:r.getVideoTags(s);o&&o.length?(Ue("WMSC_RSV_M: "+s),o.forEach((function(e){e.srcObject=a}))):Ve.log("_handleRemoteStream, video element is not mapped yet, mid= "+s)},t._handleSdpOffer=function(){var e=a(r().mark((function e(t,i){var n,a,s,o;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=y.PLAIN,a=i,e.prev=2,e.next=5,x(i,y.GZIP_BASE64);case 5:a=e.sent,n=y.GZIP_BASE64,e.next=12;break;case 9:e.prev=9,e.t0=e.catch(2),V.globalTrace({logLevel:"error",log:"WMSC_Compress_SDP_Offer_F",errorEvent:e.t0});case 12:s=++this.negotiationMsgId,o=Le(M.confId,g.VIDEO,M.nodeId,t,s,a,n),this._getPcInfo(t).offerMsgId=s,this._sendMessageToRwg({evt:we,body:o}),Ne.sendSdpLog(t,"OFFER",i);case 18:case"end":return e.stop()}}),e,this,[[2,9]])})));return function(t,i){return e.apply(this,arguments)}}(),t._handlePcStateChange=function(e,t){var i=this._getPcInfo(e);if("connected"===t)if(e===ke){for(clearTimeout(i.negotiationTimer),i.status=S.CONNECTED,i.reconnectionCount=0,i.negotiationTimer=0,Ve.log("_handlePcStateChange: peerId= "+e+" connected"),this._reSubVideo();this._toSubscribeBuffer.length;){var r=this._toSubscribeBuffer.shift();r.toSub?this.subscribeVideo([r.params]):this.unSubscribeVideo([r.params])}this.messageCallback({type:l.V_RECEV_PC_CONNECTED,data:e})}else clearTimeout(i.negotiationTimer),i.status=S.CONNECTED,i.negotiationTimer=0,i.reconnectionCount=0,Ve.log("_handlePcStateChange, peerId "+e+" connected"),this.messageCallback({type:l.V_SEND_PC_CONNECTED,data:e});else"disconnected"===t?(Ue("WMSC_PC_Disconn: "+e),this.restartNegotiation(e)):"failed"===t&&(Ue("WMSC_PC_Failed: "+e),this._getPcInfo(e).reconnectionCount<3?this.restartNegotiation(e):this.messageCallback({type:l.SDP_NEGOTIATION_FAIL,data:e}))},t._getPcInfo=function(e){return this.pcInfos.get(e)},t._reSubVideo=function(){var e=this.mIdMgr.mIdUsedStatus,t=[];for(var i in e)if(e[i].used&&e[i].userId){var r=e[i],n=r.userId,a=r.videoSize;t.push({userId:n,mId:i,videoSize:a}),this._updateVideoElement(n,i),this.mIdMgr.setMidReleasedStatus(i,!1)}this._sendStreamMappings(t)},t._updateVideoElement=function(e,t){if(Ue("WMSC_UpdateV_Ele: "+e+"|"+t),Ie.getPc(ke)){var i=this.mIdMgr.mIdUsedStatus[t],r=i.preUserId,n=i.released;if(r&&r!==e&&!n){var a=Date.now();this.recevCSRCRecord.set(e,{mId:t,startToWait:a}),this._checkCSRCTimer||(this._checkCSRCTimer=setInterval(this._checkCSRC.bind(this),100))}else this.mIdMgr.updateVideoElement(t)}},t._checkCSRC=function(){var e=this;if(0===this.recevCSRCRecord.size)return clearInterval(this._checkCSRCTimer),void(this._checkCSRCTimer=null);this.recevCSRCRecord.forEach((function(t,i){var r=t.mId,n=t.startToWait,a=Date.now()-n;if(a>1e4)return Ue("WMSC_CSRC_Timeout: "+i+"|"+r+"|"+n+"|"+a),void e.recevCSRCRecord.delete(i);var s=Ie.getRemoteSourceId(r);s&&s>>2==i>>2&&(Ve.log("Receive subscribe video, userId: "+i+" in "+a+"ms"),e.mIdMgr.updateVideoElement(r),e.messageCallback({type:l.VIDEO_SOURCE_UPDATED,userId:i}),e.recevCSRCRecord.delete(i))}))},t._handleDecodeError=function(e){Ie.removeRecvCodecByProfileLevelId(e),0===Ie.recvCodecNum?(V.globalTrace({logLevel:"error",log:"WMSC_No_Recv_Codec"}),Ue("WMSC_ERC"),this.messageCallback({type:l.SDP_NEGOTIATION_FAIL,data:f.INGRESS})):this.restartNegotiation(f.INGRESS)},e}(),ze=V.getTracer("Wmsc"),Ge=function(e){ze.log(e),V.monitorLog(""+e)},je=function(){function e(e,t){return V.setTrace(),V.setTelemetry(t),Ne.setTelemetry(t),this.messageCallback=t,this.config=e,Ge("WMSC_INIT 1.2.0-hotfix2-20240927"),!0}var t=e.prototype;return t.setTrace=function(e,t){V.setTrace(e,t)},t.updateQosSubscription=function(e,t){Ne.updateQosSubscription(e,t)},t.getHasPausedVideo=function(){var e,t;return null==(e=this.wmscApiImpl)||null==(t=e.mIdMgr)?void 0:t.getHasPausedVideo()},t.playAllUsedVideoTag=function(){var e,t;return null==(e=this.wmscApiImpl)||null==(t=e.mIdMgr)?void 0:t.playAllUsedVideoTag()},t.destroy=function(){var e;Ge("WMSC_DESTROYED"),null==(e=this.wmscApiImpl)||e.destroy(),this.wmscApiImpl=null},t.onMessage=function(e,t){if(e!==h.NOTIFY_SDK_JOIN_RWG_SUCCESS&&!this.wmscApiImpl)return this.sendMessage&&this.sendMessage({type:l.ERROR,data:"WMSC on MediaSDK message, MediaSDK not ready, type = "+e}),ze.error("onMessage, the caller not ready type "+e),!1;switch(e){case h.NOTIFY_SDK_JOIN_RWG_SUCCESS:return this.messageCallback?(this.wmscApiImpl=new We(this.config,this.sendMessage.bind(this)),!0):(ze.error("onMessage, messageCallback to the caller not set"),!1);case h.NOTIFY_SDK_JOIN_RWG_FAILURE:return!0;case h.WMSC_MESSAGE_FROM_RWG:return this._onRwgMessage(t.data);case h.NOTIFY_WMSC_VIDEO_TAG_MAPPING:return this._onVideoTagMapping(t.data);case h.NOTIFY_SDK_SUBSCRIBE_VIDEO:return this._onSubscribeVideo(t.data);case h.NOTIFY_SDK_UNSUBSCRIBE_VIDEO:return this._onUnSubscribeVideo(t.data);case h.NOTIFY_SDK_ACTIVE_VIDEO_INDICATION:return this._onActiveVideoSourceChange(t.data);case h.UPDATE_WMSC_PARAMS:return this._onUpdateWmscParams(t.data);default:return this.sendMessage({type:l.ERROR,data:"WSMC receive not handled event type = "+e}),ze.error("onMessage, unknown type "+e),Ge("WSMC_Rece_U_E: "+e),!1}},t.onMessageAsync=function(e,t){return ze.log("WMSC_Recv_Async_M",e,JSON.stringify(t)),Ge("WMSC_Recv_Async_M: "+e),e===h.VIDEO_STREAMS?this._onVideoStreamsAsync(t.streams):(this.sendMessage({type:l.ERROR,data:"WSMC receive not handled event type ="+e}),ze.error("WSMC receive not handled event type ="+e),Promise.reject("Unknown message type"))},t.sendMessage=function(e){ze.log("sendMessage",JSON.stringify(e)),this.messageCallback&&this.messageCallback(e)},t._onVideoStreamsAsync=function(e){return this.wmscApiImpl.onVideoStreamsAsync(e)},t._onRwgMessage=function(e){return this.wmscApiImpl.onRwgMessage(e)},t._onVideoTagMapping=function(e){return this.wmscApiImpl.onVideoTagMapping(e)},t._onSubscribeVideo=function(e){return this.wmscApiImpl.subscribeVideo(e)},t._onUnSubscribeVideo=function(e){return this.wmscApiImpl.unSubscribeVideo(e)},t._onActiveVideoSourceChange=function(e){return this.wmscApiImpl.onActiveVideoSourceChange(e)},t._onUpdateWmscParams=function(e){return this.wmscApiImpl.updateWmscParams(e)},e}()}}]);
//# sourceMappingURL=https://d1cdksi819e9z7.cloudfront.net/sourcemap/vendors~wmsc.min.js-72c38d9d0cf2c5722dcd.map