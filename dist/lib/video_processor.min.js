!function(e){var t={};function i(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,i),o.l=!0,o.exports}i.m=e,i.c=t,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)i.d(r,o,function(t){return e[t]}.bind(null,o));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=10)}([function(e,t,i){var r=i(9),o=i(5);e.exports=function(e,t){var i=o(e,t,"get");return r(e,i)},e.exports.__esModule=!0,e.exports.default=e.exports},function(e,t,i){var r=i(8),o=i(5);e.exports=function(e,t,i){var n=o(e,t,"set");return r(e,n,i),i},e.exports.__esModule=!0,e.exports.default=e.exports},function(e,t,i){"use strict";var r,o,n;Object.defineProperty(t,"__esModule",{value:!0}),t.VideoProcessorCmd=t.VideoProcessorEvent=t.VideoProcessorWorkerEvent=void 0,function(e){e.ADD_VIDEO_PORT="add_video_port",e.ADD_SHADOW_PORT="add_shadow_port",e.ADD_VIDEO_PROCESSOR="add_video_processor",e.PROCESSOR_READY="processor_ready",e.PROCESSOR_ERROR="processor_error"}(r||(t.VideoProcessorWorkerEvent=r={})),function(e){e.INIT_PROCESSOR="init_processor",e.UNINIT_PROCESSOR="uninit_processor",e.INIT_OUTPUT_CANVAS="init_output_canvas",e.OUTPUT_WRITABLE_STREAM="output_writable_stream",e.INPUT_READABLE_STREAM="input_readable_stream",e.FRAME_DATA="frame_data",e.START_REQUEST_FRAME="start_request_frame",e.STOP_REQUEST_FRAME="stop_request_frame",e.REQUEST_FRAME="request_frame",e.FRAME_CALLBACK="frame_callback",e.RESOLUTION_CHANGE="RESOLUTION_CHANGE",e.PROCESSOR_WORKER_ERROR="PROCESSOR_WORKER_ERROR"}(o||(t.VideoProcessorEvent=o={})),n||(t.VideoProcessorCmd=n={})},function(e,t,i){var r=i(6);e.exports=function(e,t,i){return(t=r(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e},e.exports.__esModule=!0,e.exports.default=e.exports},function(e,t){function i(t){return e.exports=i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e.exports.__esModule=!0,e.exports.default=e.exports,i(t)}e.exports=i,e.exports.__esModule=!0,e.exports.default=e.exports},function(e,t){e.exports=function(e,t,i){if(!t.has(e))throw new TypeError("attempted to "+i+" private field on non-instance");return t.get(e)},e.exports.__esModule=!0,e.exports.default=e.exports},function(e,t,i){var r=i(4).default,o=i(7);e.exports=function(e){var t=o(e,"string");return"symbol"===r(t)?t:String(t)},e.exports.__esModule=!0,e.exports.default=e.exports},function(e,t,i){var r=i(4).default;e.exports=function(e,t){if("object"!==r(e)||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var o=i.call(e,t||"default");if("object"!==r(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)},e.exports.__esModule=!0,e.exports.default=e.exports},function(e,t){e.exports=function(e,t,i){if(t.set)t.set.call(e,i);else{if(!t.writable)throw new TypeError("attempted to set read only private field");t.value=i}},e.exports.__esModule=!0,e.exports.default=e.exports},function(e,t){e.exports=function(e,t){return t.get?t.get.call(e):t.value},e.exports.__esModule=!0,e.exports.default=e.exports},function(e,t,i){"use strict";i.r(t);var r={};i.r(r),i.d(r,"RENDERER_TYPE",(function(){return u})),i.d(r,"CROPPING_SHAPE",(function(){return h}));var o=i(3),n=i.n(o),s=i(1),a=i.n(s),l=i(0),c=i.n(l);const u={_2D:0,WEBGL:1,WEBGL_2:2,WEBGPU:3},h={CIRCLE:0,ELLIPSE:1};function d(e,t){E(e,t),t.add(e)}function p(e,t,i){E(e,t),t.set(e,i)}function E(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function m(e,t,i){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return i}var f=new WeakMap,v=new WeakMap,R=new WeakMap,_=new WeakMap,T=new WeakMap,g=new WeakMap,P=new WeakMap,S=new WeakMap,C=new WeakMap,w=new WeakMap,x=new WeakMap,b=new WeakMap,A=new WeakMap,k=new WeakMap,y=new WeakMap,M=new WeakSet,I=new WeakSet,W=new WeakSet,O=new WeakSet,F=new WeakSet,L=new WeakSet,V=new WeakSet,U=new WeakSet,D=new WeakSet,N=new WeakSet,B=new WeakSet,G=new WeakSet,X=new WeakSet,H=new WeakSet;function j(e,t){e?t===u._2D?m(this,F,K).call(this,e):t===u.WEBGL?m(this,I,q).call(this,e):t===u.WEBGL_2?m(this,W,z).call(this,e):t===u.WEBGPU?m(this,O,Z).call(this,e):m(this,I,q).call(this,e):console.error("DynamicMaskRenderDisplay#initContext() cannot initialize context due to null context")}function q(e){a()(this,R,m(this,L,Y).call(this,e,e.VERTEX_SHADER,"\n    attribute vec2 aPosition;\n    attribute vec2 aTexCoord;\n    varying vec2 vTexCoord;\n    void main() {\n      gl_Position = vec4(aPosition.x, -aPosition.y, 0.0, 1.0);\n      vTexCoord = aTexCoord;\n    }\n")),a()(this,_,m(this,L,Y).call(this,e,e.FRAGMENT_SHADER,"\n    precision mediump float;\n    const int SHAPE_CIRCLE = 0;\n    const int SHAPE_ELLIPSE = 1;\n    varying vec2 vTexCoord;\n    uniform sampler2D uVideoTexture;\n    uniform sampler2D uMaskTexture;\n    uniform vec4 uEllipses[10];\n    uniform float uAngles[10]; \n    uniform int uEllipseCount;\n    uniform int uCroppingShape;\n    uniform float uAspectRatio;\n    uniform float uScaleFactor;\n    uniform int uZoomVideo;\n\n    vec2 applyZoom(vec2 uv, vec2 center, float scaleFactor) {\n        return center + (uv - center) / scaleFactor;\n    }\n\n    void main() {\n        vec4 maskColor = texture2D(uMaskTexture, vTexCoord);\n        vec2 videoUV = vTexCoord;\n        bool inShape = false;\n        bool isZoomVideo = uZoomVideo == 1;\n\n        if (uEllipseCount > 0) {\n            for (int i = 0; i < 10; i++) {\n                if (i >= uEllipseCount) break;\n\n                vec2 ellipseCenter = uEllipses[i].xy;\n                float angle = radians(uAngles[i]);\n                float condition = 0.0;\n                vec2 ellipseRadii;\n\n                if (uCroppingShape == SHAPE_CIRCLE) {\n                    // Circle\n                    float minRadii = min(uEllipses[i].z * uScaleFactor, uEllipses[i].w * uScaleFactor);\n                    ellipseRadii = vec2(minRadii, minRadii);\n                    vec2 pos = vec2(vTexCoord.x, vTexCoord.y / uAspectRatio) - vec2(ellipseCenter.x, ellipseCenter.y / uAspectRatio);\n\n                    condition = dot(pos, pos) / (ellipseRadii.x * ellipseRadii.x);\n                    if (isZoomVideo && condition <= 1.0) {\n                        videoUV = applyZoom(videoUV, ellipseCenter, uScaleFactor);\n                    }\n                } else if (uCroppingShape == SHAPE_ELLIPSE) {\n                    // Ellipse\n                    ellipseRadii = uEllipses[i].zw * uScaleFactor;\n                    vec2 pos = vTexCoord - ellipseCenter;\n\n                    // Rotate position for ellipse calculation\n                    vec2 rotatedPos;\n                    rotatedPos.x = pos.x * cos(angle) + pos.y * sin(angle);\n                    rotatedPos.y = -pos.x * sin(angle) + pos.y * cos(angle);\n\n                    condition = (rotatedPos.x * rotatedPos.x) / (ellipseRadii.x * ellipseRadii.x) +\n                                (rotatedPos.y * rotatedPos.y) / (ellipseRadii.y * ellipseRadii.y);\n\n                    if (isZoomVideo && condition <= 1.0) {\n                        videoUV = applyZoom(videoUV, ellipseCenter, uScaleFactor);\n                    }\n                }\n\n                if (condition <= 1.0) {\n                    inShape = true;\n                    break;\n                }\n            }\n        }\n\n        // Output color based on whether inShape is true\n        gl_FragColor = inShape ? texture2D(uVideoTexture, videoUV) : maskColor;\n    }\n")),a()(this,T,m(this,V,Q).call(this,e,c()(this,R),c()(this,_)));const t=new Float32Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,-1,1,0,1,1,-1,1,0,1,1,1,1]),i=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,i),e.bufferData(e.ARRAY_BUFFER,t,e.STATIC_DRAW);const r=e.getAttribLocation(c()(this,T),"aPosition");e.vertexAttribPointer(r,2,e.FLOAT,!1,16,0),e.enableVertexAttribArray(r);const o=e.getAttribLocation(c()(this,T),"aTexCoord");e.vertexAttribPointer(o,2,e.FLOAT,!1,16,8),e.enableVertexAttribArray(o),a()(this,g,e.createTexture()),a()(this,P,e.createTexture())}function z(e){m(this,I,q).call(this,e)}function Z(e){}function K(e){}function Y(e,t,i){const r=e.createShader(t);return e.shaderSource(r,i),e.compileShader(r),e.getShaderParameter(r,e.COMPILE_STATUS)?r:(console.error("Error compiling shader:",e.getShaderInfoLog(r)),e.deleteShader(r),null)}function Q(e,t,i){const r=e.createProgram();return e.attachShader(r,t),e.attachShader(r,i),e.linkProgram(r),e.getProgramParameter(r,e.LINK_STATUS)||(console.error("Error linking program:",e.getProgramInfoLog(r)),e.deleteProgram(r)),e.useProgram(r),r}function J(e){let t=c()(this,v);t&&e&&(c()(this,P)||a()(this,P,t.createTexture()),t.bindTexture(t.TEXTURE_2D,c()(this,P)),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE))}function $(e,t){let i=c()(this,v),r=c()(this,T);if(!i||!r)return;i.viewport(0,0,c()(this,f).width,c()(this,f).height),i.bindTexture(i.TEXTURE_2D,c()(this,g)),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.clearColor(0,0,0,1),i.clear(i.COLOR_BUFFER_BIT),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,c()(this,g)),i.uniform1i(i.getUniformLocation(r,"uVideoTexture"),0),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,c()(this,P)),i.uniform1i(i.getUniformLocation(r,"uMaskTexture"),1);const o=t.ellipses.length;if(o>0){const e=new Float32Array(t.ellipses.flat());let o;o=c()(this,k)?new Float32Array(t.angles):new Float32Array(t.angles.length).fill(0),i.uniform4fv(i.getUniformLocation(r,"uEllipses"),e),i.uniform1fv(i.getUniformLocation(r,"uAngles"),o)}i.uniform1i(i.getUniformLocation(r,"uEllipseCount"),o),i.uniform1i(i.getUniformLocation(r,"uCroppingShape"),c()(this,x)),i.uniform1f(i.getUniformLocation(r,"uAspectRatio"),c()(this,b)),i.uniform1f(i.getUniformLocation(r,"uScaleFactor"),c()(this,A));let n=0;c()(this,y)&&(n=1),i.uniform1i(i.getUniformLocation(r,"uZoomVideo"),n),i.drawArrays(i.TRIANGLES,0,6)}function ee(e,t,i){let r=c()(this,v);if(!r||!c()(this,f))return void console.error("Canvas context or canvas not initialized");const o=c()(this,f).width,n=c()(this,f).height;r.drawImage(e,0,0,o,n),r.drawImage(t,0,0,o,n),i&&i.ellipses.length>0&&i.ellipses.forEach(t=>{const i=t[0],s=t[1],a=t[2],l=t[3];if(r.save(),r.beginPath(),c()(this,x)==h.ELLIPSE)r.ellipse(i,s,a,l,0,0,2*Math.PI);else if(c()(this,x)==h.CIRCLE){let e=Math.min(a,l)*c()(this,A);r.arc(i,s,e,0,360)}r.clip(),r.drawImage(e,0,0,o,n),r.restore()})}function te(e){e===h.CIRCLE?a()(this,x,h.CIRCLE):(e===h.ELLIPSE||console.error("updateCroppingShape() unsupported cropping shape! Switch to ellipse. val:".concat(e)),a()(this,x,h.ELLIPSE))}function ie(e){return Number.isNaN(e)||!e?(console.error("updateCroppingShapeScaleFactor() scaleFactor is not a number! scaleFactor:".concat(JSON.stringify(e))),void a()(this,A,1)):e<=0?(console.error("updateCroppingShapeScaleFactor() scaleFactor should be a non-zero positive number! scaleFactor:".concat(e)),void a()(this,A,1)):void a()(this,A,e)}function re(e){!0===e?a()(this,k,!0):a()(this,k,!1)}function oe(e){!0===e?a()(this,y,!0):a()(this,y,!1)}var ne=class{constructor(e,t){d(this,H),d(this,X),d(this,G),d(this,B),d(this,N),d(this,D),d(this,U),d(this,V),d(this,L),d(this,F),d(this,O),d(this,W),d(this,I),d(this,M),p(this,f,{writable:!0,value:null}),p(this,v,{writable:!0,value:null}),p(this,R,{writable:!0,value:null}),p(this,_,{writable:!0,value:null}),p(this,T,{writable:!0,value:null}),p(this,g,{writable:!0,value:null}),p(this,P,{writable:!0,value:null}),p(this,S,{writable:!0,value:0}),p(this,C,{writable:!0,value:null}),p(this,w,{writable:!0,value:null}),p(this,x,{writable:!0,value:h.ELLIPSE}),p(this,b,{writable:!0,value:1}),p(this,A,{writable:!0,value:1}),p(this,k,{writable:!0,value:!1}),p(this,y,{writable:!0,value:!1}),a()(this,f,e),a()(this,S,t),a()(this,v,function(e,t){if(!e)return null;t!==u._2D&&t!==u.WEBGL&&t!==u.WEBGL_2&&t!==u.WEBGPU&&(t=u.WEBGL);let i="webgl";i=t===u._2D?"2d":t===u.WEBGL?"webgl":t===u.WEBGL_2?"webgl2":t===u.WEBGPU?"webgpu":"webgl";let r=e.getContext(i);return r||console.error("getContext() cannot get context from canvas! contextType:".concat(i)),r}(e,t)),m(this,M,j).call(this,c()(this,v),t),a()(this,b,e.width/e.height),c()(this,b)<=0&&a()(this,b,1);const i={croppingShape:h.ELLIPSE,scaleFactor:1,useAngle:!1,zoomVideo:!1};this.updateMaskOptions(i)}getRendererType(){return c()(this,S)}updateMaskImage(e){a()(this,C,e),c()(this,S)!=u.WEBGL&&c()(this,S)!=u.WEBGL_2||m(this,U,J).call(this,e)}updateMaskOptions(e){a()(this,w,e),e&&(m(this,B,te).call(this,e.croppingShape),m(this,G,ie).call(this,e.scaleFactor),m(this,X,re).call(this,e.useAngle),m(this,H,oe).call(this,e.zoomVideo))}render(e,t){c()(this,C)&&e&&c()(this,w)&&t&&(c()(this,S)==u.WEBGL_2||c()(this,S)==u.WEBGL?m(this,D,$).call(this,e,t):c()(this,S)==u._2D&&m(this,N,ee).call(this,e,c()(this,C),t))}cleanup(){a()(this,f,null),a()(this,v,null),a()(this,R,null),a()(this,_,null),a()(this,T,null),a()(this,g,null),a()(this,P,null),a()(this,S,0),a()(this,C,null),a()(this,w,null)}};function se(e,t,i){ae(e,t),t.set(e,i)}function ae(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}var le=new WeakMap,ce=new WeakMap,ue=new WeakMap,he=new WeakSet;function de(e,t,i,r){let o=[],n=[];if(e.length<=2)for(let p of e){var s,a;const[e,E,m]=p.keypoints,f={x:(E.x+e.x)/2,y:(E.y+e.y)/2},v=Math.atan2(f.y-E.y,f.x-E.x),R={x:(f.x+m.x)/2,y:(f.y+m.y)/2};if(null!==(s=p.boundingBox)&&void 0!==s&&s.width&&null!==(a=p.boundingBox)&&void 0!==a&&a.height){let e=0,s=0,a=0,E=0;var l,c,h,d;if(r==u._2D)e=R.x*t,s=R.y*i,a=(null===(l=p.boundingBox)||void 0===l?void 0:l.width)/2,E=(null===(c=p.boundingBox)||void 0===c?void 0:c.height)/1.5;else e=R.x,s=R.y,a=(null===(h=p.boundingBox)||void 0===h?void 0:h.width)/2/t,E=(null===(d=p.boundingBox)||void 0===d?void 0:d.height)/1.5/i;o.push([e,s,a,E]),n.push([v*(180/Math.PI)])}}return{ellipses:o,angles:n,raw:e}}var pe=class{constructor(){var e,t;ae(e=this,t=he),t.add(e),se(this,le,{writable:!0,value:null}),se(this,ce,{writable:!0,value:0}),se(this,ue,{writable:!0,value:u.WEBGL})}initDynamicMaskEngine(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:u.WEBGL_2,i=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0;if(!e||!i||!r)return console.error("initDynamicMaskEngine() failed to start! invalid args."),!1;t!==u._2D&&t!==u.WEBGL&&t!==u.WEBGL_2&&t!==u.WEBGPU&&(t=u.WEBGL),c()(this,le)||a()(this,le,new ne(e,t)),this.updateMaskImage(i),this.updateMaskOptions(r),a()(this,ce,1),a()(this,ue,t)}updateMaskImage(e){c()(this,le)&&c()(this,le).updateMaskImage(e)}updateMaskOptions(e){c()(this,le)&&c()(this,le).updateMaskOptions(e)}render(e,t){if(e)if(t){if(c()(this,le)){let i=e.displayWidth,r=e.displayHeight,o=function(e,t,i){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return i}(this,he,de).call(this,t,i,r,c()(this,ue));c()(this,le).render(e,o),a()(this,ce,2)}}else console.error("DynamicMaskEngine#render() dataSet is invalid!");else console.error("DynamicMaskEngine#render() videoSrc is invalid!")}uninitDynamicMaskEngine(){a()(this,ce,0),c()(this,le)&&(c()(this,le).cleanup(),a()(this,le,null))}};function Ee(e,t,i){!function(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}(e,t),t.set(e,i)}var me=new WeakMap;class fe{constructor(){if(Ee(this,me,{writable:!0,value:null}),fe.instance)return fe.instance;fe.instance=this}getDynamicMaskEngine(){return c()(this,me)||a()(this,me,new pe),c()(this,me)}}var ve=new fe,Re=i(2);let _e=!1;const Te=new Map,ge=new Map,Pe=new Map;function Se(e,t){Te.set(e,t)}function Ce(e){let t;"string"==typeof e?t=e:e instanceof ErrorEvent?t=e.error:e instanceof PromiseRejectionEvent&&(t=e.reason),self.postMessage({cmd:Re.VideoProcessorEvent.PROCESSOR_WORKER_ERROR,data:t})}self.addEventListener("error",Ce),self.addEventListener("unhandledrejection",Ce);class we{constructor(e,t){this.port=e,this.options=t,this.getOutput=()=>null}onInit(){}onUninit(){}processFrame(e,t){throw new Error("please implement the processFrame method")}}class xe{constructor(e,t,i){n()(this,"requestFrame",e=>()=>{this.frameReader.read().then(t=>{let{value:i,done:r}=t;r?(clearTimeout(this.readFrameTimer),this.readFrameTimer=0):(this.updateOutputCanvas(i),this.processFrame(i),this.readFrameTimer=setTimeout(this.requestFrame(e),1e3/e.data.frameRate-4))}).catch(()=>{clearTimeout(this.readFrameTimer),this.readFrameTimer=0})}),n()(this,"frameCallback",e=>{const t=Pe.get(this.processorName);t&&t.postMessage({cmd:Re.VideoProcessorEvent.FRAME_CALLBACK,frame:e}),this.port.postMessage({cmd:Re.VideoProcessorEvent.FRAME_CALLBACK,frame:e}),e.close()}),n()(this,"callback",(e,t)=>{this.port.postMessage({cmd:e,data:t})}),n()(this,"processFrame",e=>{if(this.processor){var t;const i=t=>{if(t){let t;this.pVideoFrameCount++,e.close(),(this.frameWriter||this.VideoFrameNeeded)&&(t=this.generateVideoFrame(this.outPutCanvas)),this.frameWriter?(this.checkAndCopyBack(this.outPutCanvas),this.frameWriter.write(t).finally(()=>{t.close()})):this.VideoFrameNeeded&&this.frameCallback(t)}else this.fVideoFrameCount++,this.frameWriter?(this.checkAndCopyBack(e),this.frameWriter.write(e).finally(()=>{e.close()})):this.VideoFrameNeeded?this.frameCallback(e):e.close()};this.tickInWorker&&(null===this.preVideoWidth?this.preVideoWidth=e.visibleRect.width:this.preVideoWidth!=e.visibleRect.width&&(this.preVideoWidth=e.visibleRect.width,this.port.postMessage({cmd:Re.VideoProcessorEvent.RESOLUTION_CHANGE,data:{width:e.visibleRect.width,height:e.visibleRect.height}}))),this.cVideoFrameCount++;const r=this.processor.processFrame(e,this.outPutCanvas);r.then?null===(t=r.then)||void 0===t||t.call(r,e=>i(e)):i(r)}else this.frameCallback(e)}),this.outPutCanvas=null,this.frameWriter=null,this.frameReader=null,this.requestFrameInterval=0,this.port=e,this.processor=t,this.processorName=i,this.outputCanvasReady,this.outputPromise=new Promise(e=>{this.outputCanvasReady=e}),this.preVideoWidth=null,this.tickInWorker=!1,this.VideoFrameNeeded=!0,this.pHealthCheckInterval=0,this.cVideoFrameCount=0,this.pVideoFrameCount=0,this.fVideoFrameCount=0}async onMessage(e,t){var i,r,o;switch(e){case Re.VideoProcessorEvent.INIT_OUTPUT_CANVAS:t.canvas?this.outPutCanvas=t.canvas:this.outPutCanvas=new OffscreenCanvas(1,1),this.outPutCanvas.addEventListener("webglcontextlost",()=>{Ce("pccl")}),this.outPutCanvas.addEventListener("webglcontextrestored",()=>{Ce("pccs")}),null===(i=this.outputCanvasReady)||void 0===i||i.call(this);break;case Re.VideoProcessorEvent.OUTPUT_WRITABLE_STREAM:this.frameWriter=t.writableStream.getWriter();break;case Re.VideoProcessorEvent.INPUT_READABLE_STREAM:this.frameReader=t.readableStream.getReader();break;case Re.VideoProcessorEvent.FRAME_DATA:{this.outPutCanvas||await this.outputPromise;const e=t.frame;if(this.updateOutputCanvas(e),t.captureStream){return void this.processor.processFrame(e,this.outPutCanvas).then(()=>{e.close()})}this.processFrame(e)}break;case Re.VideoProcessorEvent.START_REQUEST_FRAME:this.VideoFrameNeeded=!!t.VideoFrameNeeded,this.tickInWorker=!0,this.frameReader?this.requestFrame({data:t})(this.port):this.requestFrameInterval||(this.requestFrameInterval=setInterval(()=>{this.port.postMessage({cmd:Re.VideoProcessorEvent.REQUEST_FRAME})},1e3/t.frameRate-4));break;case Re.VideoProcessorEvent.STOP_REQUEST_FRAME:this.tickInWorker=!1,this.requestFrameInterval&&(clearInterval(this.requestFrameInterval),this.requestFrameInterval=0),this.readFrameTimer&&(clearTimeout(this.readFrameTimer),this.readFrameTimer=0),null===(r=this.frameReader)||void 0===r||null===(o=r.cancel)||void 0===o||o.call(r)}}updateOutputCanvas(e){this.outPutCanvas.width!==e.visibleRect.width&&(this.outPutCanvas.width=e.visibleRect.width),this.outPutCanvas.height!==e.visibleRect.height&&(this.outPutCanvas.height=e.visibleRect.height)}checkAndCopyBack(e){if(this.VideoFrameNeeded){const t=this.generateVideoFrame(e);this.frameCallback(t)}}generateVideoFrame(e){return new VideoFrame(e,{timestamp:1e3*performance.now()})}startHealthCheck(){this.pHealthCheckInterval||(this.pHealthCheckInterval=setInterval(()=>{Ce("VPCFP:".concat(this.cVideoFrameCount,"-").concat(this.fVideoFrameCount,"-").concat(this.pVideoFrameCount))},1e4))}stopHealthCheck(){clearInterval(this.pHealthCheckInterval),this.pHealthCheckInterval=0}destroy(){var e,t;null===(e=this.frameReader)||void 0===e||e.cancel(),null===(t=this.frameWriter)||void 0===t||t.close()}}const be=new Map;self.addEventListener("message",(function(e){const t=e.data;switch(t.command){case Re.VideoProcessorWorkerEvent.ADD_VIDEO_PROCESSOR:_e||((o=self).registerProcessor=Se,o.VideoProcessor=we,o.ZoomUtils={RenderEngine:ve,RenderEngineConst:r},_e=!0);try{if(self,importScripts(t.url),t.port.start(),!ge.has(t.name)){const e=Te.get(t.name);e&&ge.set(t.name,new e(t.port,t.options))}self.postMessage({cmd:Re.VideoProcessorWorkerEvent.PROCESSOR_READY,name:t.name})}catch(e){console.error(e),self.postMessage({cmd:Re.VideoProcessorWorkerEvent.PROCESSOR_ERROR,name:t.name})}break;case Re.VideoProcessorWorkerEvent.ADD_VIDEO_PORT:(i=t.data).start(),i.addEventListener("message",e=>{const{cmd:t,processorName:r}=e.data;if(be.get(r)||t===Re.VideoProcessorEvent.UNINIT_PROCESSOR||be.set(r,new xe(i,ge.get(r),r)),t===Re.VideoProcessorEvent.INIT_PROCESSOR){const e=be.get(r);e.startHealthCheck(),e.outputPromise.then(()=>{var t;ge.get(r).getOutput=()=>e.outPutCanvas,null===(t=ge.get(r))||void 0===t||t.onInit()})}else if(t===Re.VideoProcessorEvent.UNINIT_PROCESSOR){var o;null===(o=ge.get(r))||void 0===o||o.onUninit();const e=be.get(r);e.stopHealthCheck(),e.destroy(),be.delete(r)}else{var n;r&&(null===(n=be.get(r))||void 0===n||n.onMessage(t,e.data))}});break;case Re.VideoProcessorWorkerEvent.ADD_SHADOW_PORT:{const e=t.data;e.start(),e.addEventListener("message",t=>{const{cmd:i,processorName:r}=t.data;i===Re.VideoProcessorEvent.INIT_PROCESSOR?Pe.set(r,e):i===Re.VideoProcessorEvent.UNINIT_PROCESSOR&&Pe.delete(r)})}}var i,o}))}]);
//# sourceMappingURL=https://d1cdksi819e9z7.cloudfront.net/sourcemap/video_processor.min.js-f48d707506c4ba99ea51.map