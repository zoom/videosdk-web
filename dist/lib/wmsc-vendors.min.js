(window.webpackJsonpJsMediaSDK_Instance=window.webpackJsonpJsMediaSDK_Instance||[]).push([[1],{102:function(e,t,i){"use strict";function n(){n=function(){return e};var e={},t=Object.prototype,i=t.hasOwnProperty,r=Object.defineProperty||function(e,t,i){e[t]=i.value},a="function"==typeof Symbol?Symbol:{},s=a.iterator||"@@iterator",o=a.asyncIterator||"@@asyncIterator",d=a.toStringTag||"@@toStringTag";function c(e,t,i){return Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,i){return e[t]=i}}function u(e,t,i,n){var a=t&&t.prototype instanceof p?t:p,s=Object.create(a.prototype),o=new M(n||[]);return r(s,"_invoke",{value:C(e,i,o)}),s}function l(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(e){return{type:"throw",arg:e}}}e.wrap=u;var h={};function p(){}function f(){}function m(){}var g={};c(g,s,(function(){return this}));var _=Object.getPrototypeOf,v=_&&_(_(T([])));v&&v!==t&&i.call(v,s)&&(g=v);var S=m.prototype=p.prototype=Object.create(g);function b(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function I(e,t){var n;r(this,"_invoke",{value:function(r,a){function s(){return new t((function(n,s){!function n(r,a,s,o){var d=l(e[r],e,a);if("throw"!==d.type){var c=d.arg,u=c.value;return u&&"object"==typeof u&&i.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,s,o)}),(function(e){n("throw",e,s,o)})):t.resolve(u).then((function(e){c.value=e,s(c)}),(function(e){return n("throw",e,s,o)}))}o(d.arg)}(r,a,n,s)}))}return n=n?n.then(s,s):s()}})}function C(e,t,i){var n="suspendedStart";return function(r,a){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===r)throw a;return R()}for(i.method=r,i.arg=a;;){var s=i.delegate;if(s){var o=y(s,i);if(o){if(o===h)continue;return o}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if("suspendedStart"===n)throw n="completed",i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);n="executing";var d=l(e,t,i);if("normal"===d.type){if(n=i.done?"completed":"suspendedYield",d.arg===h)continue;return{value:d.arg,done:i.done}}"throw"===d.type&&(n="completed",i.method="throw",i.arg=d.arg)}}}function y(e,t){var i=t.method,n=e.iterator[i];if(void 0===n)return t.delegate=null,"throw"===i&&e.iterator.return&&(t.method="return",t.arg=void 0,y(e,t),"throw"===t.method)||"return"!==i&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+i+"' method")),h;var r=l(n,e.iterator,t.arg);if("throw"===r.type)return t.method="throw",t.arg=r.arg,t.delegate=null,h;var a=r.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,h):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,h)}function E(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function w(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function M(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(E,this),this.reset(!0)}function T(e){if(e){var t=e[s];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,r=function t(){for(;++n<e.length;)if(i.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return r.next=r}}return{next:R}}function R(){return{value:void 0,done:!0}}return f.prototype=m,r(S,"constructor",{value:m,configurable:!0}),r(m,"constructor",{value:f,configurable:!0}),f.displayName=c(m,d,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===f||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,c(e,d,"GeneratorFunction")),e.prototype=Object.create(S),e},e.awrap=function(e){return{__await:e}},b(I.prototype),c(I.prototype,o,(function(){return this})),e.AsyncIterator=I,e.async=function(t,i,n,r,a){void 0===a&&(a=Promise);var s=new I(u(t,i,n,r),a);return e.isGeneratorFunction(i)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},b(S),c(S,d,"Generator"),c(S,s,(function(){return this})),c(S,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=Object(e),i=[];for(var n in t)i.push(n);return i.reverse(),function e(){for(;i.length;){var n=i.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},e.values=T,M.prototype={constructor:M,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(w),!e)for(var t in this)"t"===t.charAt(0)&&i.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(i,n){return s.type="throw",s.arg=e,t.next=i,n&&(t.method="next",t.arg=void 0),!!n}for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r],s=a.completion;if("root"===a.tryLoc)return n("end");if(a.tryLoc<=this.prev){var o=i.call(a,"catchLoc"),d=i.call(a,"finallyLoc");if(o&&d){if(this.prev<a.catchLoc)return n(a.catchLoc,!0);if(this.prev<a.finallyLoc)return n(a.finallyLoc)}else if(o){if(this.prev<a.catchLoc)return n(a.catchLoc,!0)}else{if(!d)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return n(a.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&i.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var a=r;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var s=a?a.completion:{};return s.type=e,s.arg=t,a?(this.method="next",this.next=a.finallyLoc,h):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),h},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.finallyLoc===e)return this.complete(i.completion,i.afterLoc),w(i),h}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.tryLoc===e){var n=i.completion;if("throw"===n.type){var r=n.arg;w(i)}return r}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,i){return this.delegate={iterator:T(e),resultName:t,nextLoc:i},"next"===this.method&&(this.arg=void 0),h}},e}function r(e,t,i,n,r,a,s){try{var o=e[a](s),d=o.value}catch(e){return void i(e)}o.done?t(d):Promise.resolve(d).then(n,r)}function a(e){return function(){var t=this,i=arguments;return new Promise((function(n,a){var s=e.apply(t,i);function o(e){r(s,n,a,o,d,"next",e)}function d(e){r(s,n,a,o,d,"throw",e)}o(void 0)}))}}function s(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,(r=n.key,a=void 0,"symbol"==typeof(a=function(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(r,"string"))?a:String(a)),n)}var r,a}function o(){return(o=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e}).apply(this,arguments)}function d(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function c(e,t){var i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(i)return(i=i.call(e)).next.bind(i);if(Array.isArray(e)||(i=function(e,t){if(e){if("string"==typeof e)return d(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?d(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}i.r(t),i.d(t,"Wmsc",(function(){return $i})),i.d(t,"eventExt",(function(){return pi})),i.d(t,"eventOut",(function(){return fi}));var u=new(function(){function e(){this.getBrowserInfo()}var t=e.prototype;return t.isMultiGetMedia=function(){return!!(this.ege||this.chrome||this.chromium||this.safari)},t.getHighProfile=function(){return!this.safari?"profile-level-id=64001f":"profile-level-id=640c1f"},t.useConstraints=function(e){return e.framerate&&this.safari},t.getBrowserInfo=function(){var e=navigator.userAgent;this.bWebkit=/\b(iPad|iPhone|iPod)\b/.test(e)&&/WebKit/i.test(e)&&!/Edge/i.test(e)&&!window.MSStream,this.chromium=e.match(/\b(Chromium)\/([\d|.]+)/i),this.ege=e.match(/\b(Edg.*)\/([\d|.]+)/i),this.chrome=!this.chromium&&!this.ege&&e.match(/\b(Chrome)\/([\d|.]+)/i),this.seamonkey=e.match(/\b(seamonkey)\/([\d|.]+)/i),this.firefox=!this.seamonkey&&e.match(/\b(firefox)\/([\d|.]+)/i),this.safari=!this.chrome&&!this.chromium&&e.match(/\b(safari)\/([\d|.]+)/i),this.ios=/\biPad|iPhone\b/.test(e),this.android=/\bAndroid\b/.test(e);var t=this.chromium||this.ege||this.chrome||this.chrome||this.seamonkey||this.firefox||this.safari;this.browserName=t&&t[1],this.version=t&&t[2]},e}()),l={TRACE_LEVEL_ERROR:0,TRACE_LEVEL_WARN:1,TRACE_LEVEL_INFO:2,TRACE_LEVEL_DEBUG:3,TRACE_LEVEL_VERBOSE:4,RES_90p:0,RES_180p:1,RES_360p:2,RES_720p:3,RES_1080p:4,RES_2160p:5,SHARE_USERID_OFFSET:3,AUDIO_USERID_OFFSET:2,VIDEO_USERID_OFFSET:1,PC_STATE_IDLE:0,PC_STATE_CONNECTING:1,PC_STATE_CONNECTED:2,PC_STATE_END:-1,VIDEO_CONSTRAINTS:[{height:90,width:160,frameRate:15},{height:180,width:320,frameRate:30},{height:360,width:640,frameRate:30},{height:720,width:1280,frameRate:30},{height:1080,width:1920,frameRate:30},{height:2160,width:3840,frameRate:30}],MIN_SEND_PC_ID:1,MAX_SEND_PC_NUM:4,MIN_RECEV_VIDEO_NUM:4,MAX_RECEV_VIDEO_NUM:25,WMSC_BR:{RECV:[4e6],SEND:[8e4,14e4,57e4,2e6,4e6,8e6]},VIDEO_SCALES:[[1,1,1,1,1],[2,1,1,1,1],[4,2,1,1,1],[8,4,2,1,1],[12,6,3,1.5,1]],MEDIA_TYPE:{VIDEO:"video",AUDIO:"audio"},TRANSCEIVER_DIRECTION:{SEND_RECV:"sendrecv",SEND_ONLY:"sendonly",RECV_ONLY:"recvonly",INACTIVE:"inactive",STOPPED:"stopped"},AUDIO_SESSION:1,VIDEO_SESSION:2,MediaMgrMsgType:{STREAM:"STREAM",SDP:"SDP",PCSTATUSCHANGE:"PCSTATUSCHANGE",ERROR:"ERROR"},TEXT_ENCODING:{PLAIN:0,GZIP_BASE64:1},getStatsInterval:2e3,getSendPCsStatsInterval:2e3,videoElemPlayInterval:2e3,MAX_PC_RECONNECT_COUNT:3,NEGOTIATION_TIMEOUT:1e4,captureStatsInterval:1e3,reportStatsInterval:15e3,MCCREQ:{NONE:0,CHANGE:1,CHANGE_VIDEOSIZE:2,CHANGE_FRAMERATE:4,CHANGE_BITRATE:8}};function h(e){let t=e.length;for(;--t>=0;)e[t]=0}const p=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),f=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),m=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),g=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),_=new Array(576);h(_);const v=new Array(60);h(v);const S=new Array(512);h(S);const b=new Array(256);h(b);const I=new Array(29);h(I);const C=new Array(30);function y(e,t,i,n,r){this.static_tree=e,this.extra_bits=t,this.extra_base=i,this.elems=n,this.max_length=r,this.has_stree=e&&e.length}let E,w,M;function T(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}h(C);const R=e=>e<256?S[e]:S[256+(e>>>7)],L=(e,t)=>{e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255},A=(e,t,i)=>{e.bi_valid>16-i?(e.bi_buf|=t<<e.bi_valid&65535,L(e,e.bi_buf),e.bi_buf=t>>16-e.bi_valid,e.bi_valid+=i-16):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=i)},D=(e,t,i)=>{A(e,i[2*t],i[2*t+1])},P=(e,t)=>{let i=0;do{i|=1&e,e>>>=1,i<<=1}while(--t>0);return i>>>1},O=(e,t,i)=>{const n=new Array(16);let r,a,s=0;for(r=1;r<=15;r++)s=s+i[r-1]<<1,n[r]=s;for(a=0;a<=t;a++){let t=e[2*a+1];0!==t&&(e[2*a]=P(n[t]++,t))}},x=e=>{let t;for(t=0;t<286;t++)e.dyn_ltree[2*t]=0;for(t=0;t<30;t++)e.dyn_dtree[2*t]=0;for(t=0;t<19;t++)e.bl_tree[2*t]=0;e.dyn_ltree[512]=1,e.opt_len=e.static_len=0,e.sym_next=e.matches=0},k=e=>{e.bi_valid>8?L(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0},N=(e,t,i,n)=>{const r=2*t,a=2*i;return e[r]<e[a]||e[r]===e[a]&&n[t]<=n[i]},B=(e,t,i)=>{const n=e.heap[i];let r=i<<1;for(;r<=e.heap_len&&(r<e.heap_len&&N(t,e.heap[r+1],e.heap[r],e.depth)&&r++,!N(t,n,e.heap[r],e.depth));)e.heap[i]=e.heap[r],i=r,r<<=1;e.heap[i]=n},V=(e,t,i)=>{let n,r,a,s,o=0;if(0!==e.sym_next)do{n=255&e.pending_buf[e.sym_buf+o++],n+=(255&e.pending_buf[e.sym_buf+o++])<<8,r=e.pending_buf[e.sym_buf+o++],0===n?D(e,r,t):(a=b[r],D(e,a+256+1,t),s=p[a],0!==s&&(r-=I[a],A(e,r,s)),n--,a=R(n),D(e,a,i),s=f[a],0!==s&&(n-=C[a],A(e,n,s)))}while(o<e.sym_next);D(e,256,t)},W=(e,t)=>{const i=t.dyn_tree,n=t.stat_desc.static_tree,r=t.stat_desc.has_stree,a=t.stat_desc.elems;let s,o,d,c=-1;for(e.heap_len=0,e.heap_max=573,s=0;s<a;s++)0!==i[2*s]?(e.heap[++e.heap_len]=c=s,e.depth[s]=0):i[2*s+1]=0;for(;e.heap_len<2;)d=e.heap[++e.heap_len]=c<2?++c:0,i[2*d]=1,e.depth[d]=0,e.opt_len--,r&&(e.static_len-=n[2*d+1]);for(t.max_code=c,s=e.heap_len>>1;s>=1;s--)B(e,i,s);d=a;do{s=e.heap[1],e.heap[1]=e.heap[e.heap_len--],B(e,i,1),o=e.heap[1],e.heap[--e.heap_max]=s,e.heap[--e.heap_max]=o,i[2*d]=i[2*s]+i[2*o],e.depth[d]=(e.depth[s]>=e.depth[o]?e.depth[s]:e.depth[o])+1,i[2*s+1]=i[2*o+1]=d,e.heap[1]=d++,B(e,i,1)}while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],((e,t)=>{const i=t.dyn_tree,n=t.max_code,r=t.stat_desc.static_tree,a=t.stat_desc.has_stree,s=t.stat_desc.extra_bits,o=t.stat_desc.extra_base,d=t.stat_desc.max_length;let c,u,l,h,p,f,m=0;for(h=0;h<=15;h++)e.bl_count[h]=0;for(i[2*e.heap[e.heap_max]+1]=0,c=e.heap_max+1;c<573;c++)u=e.heap[c],h=i[2*i[2*u+1]+1]+1,h>d&&(h=d,m++),i[2*u+1]=h,u>n||(e.bl_count[h]++,p=0,u>=o&&(p=s[u-o]),f=i[2*u],e.opt_len+=f*(h+p),a&&(e.static_len+=f*(r[2*u+1]+p)));if(0!==m){do{for(h=d-1;0===e.bl_count[h];)h--;e.bl_count[h]--,e.bl_count[h+1]+=2,e.bl_count[d]--,m-=2}while(m>0);for(h=d;0!==h;h--)for(u=e.bl_count[h];0!==u;)l=e.heap[--c],l>n||(i[2*l+1]!==h&&(e.opt_len+=(h-i[2*l+1])*i[2*l],i[2*l+1]=h),u--)}})(e,t),O(i,c,e.bl_count)},F=(e,t,i)=>{let n,r,a=-1,s=t[1],o=0,d=7,c=4;for(0===s&&(d=138,c=3),t[2*(i+1)+1]=65535,n=0;n<=i;n++)r=s,s=t[2*(n+1)+1],++o<d&&r===s||(o<c?e.bl_tree[2*r]+=o:0!==r?(r!==a&&e.bl_tree[2*r]++,e.bl_tree[32]++):o<=10?e.bl_tree[34]++:e.bl_tree[36]++,o=0,a=r,0===s?(d=138,c=3):r===s?(d=6,c=3):(d=7,c=4))},U=(e,t,i)=>{let n,r,a=-1,s=t[1],o=0,d=7,c=4;for(0===s&&(d=138,c=3),n=0;n<=i;n++)if(r=s,s=t[2*(n+1)+1],!(++o<d&&r===s)){if(o<c)do{D(e,r,e.bl_tree)}while(0!=--o);else 0!==r?(r!==a&&(D(e,r,e.bl_tree),o--),D(e,16,e.bl_tree),A(e,o-3,2)):o<=10?(D(e,17,e.bl_tree),A(e,o-3,3)):(D(e,18,e.bl_tree),A(e,o-11,7));o=0,a=r,0===s?(d=138,c=3):r===s?(d=6,c=3):(d=7,c=4)}};let z=!1;const G=(e,t,i,n)=>{A(e,0+(n?1:0),3),k(e),L(e,i),L(e,~i),i&&e.pending_buf.set(e.window.subarray(t,t+i),e.pending),e.pending+=i};var j={_tr_init:e=>{z||((()=>{let e,t,i,n,r;const a=new Array(16);for(i=0,n=0;n<28;n++)for(I[n]=i,e=0;e<1<<p[n];e++)b[i++]=n;for(b[i-1]=n,r=0,n=0;n<16;n++)for(C[n]=r,e=0;e<1<<f[n];e++)S[r++]=n;for(r>>=7;n<30;n++)for(C[n]=r<<7,e=0;e<1<<f[n]-7;e++)S[256+r++]=n;for(t=0;t<=15;t++)a[t]=0;for(e=0;e<=143;)_[2*e+1]=8,e++,a[8]++;for(;e<=255;)_[2*e+1]=9,e++,a[9]++;for(;e<=279;)_[2*e+1]=7,e++,a[7]++;for(;e<=287;)_[2*e+1]=8,e++,a[8]++;for(O(_,287,a),e=0;e<30;e++)v[2*e+1]=5,v[2*e]=P(e,5);E=new y(_,p,257,286,15),w=new y(v,f,0,30,15),M=new y(new Array(0),m,0,19,7)})(),z=!0),e.l_desc=new T(e.dyn_ltree,E),e.d_desc=new T(e.dyn_dtree,w),e.bl_desc=new T(e.bl_tree,M),e.bi_buf=0,e.bi_valid=0,x(e)},_tr_stored_block:G,_tr_flush_block:(e,t,i,n)=>{let r,a,s=0;e.level>0?(2===e.strm.data_type&&(e.strm.data_type=(e=>{let t,i=4093624447;for(t=0;t<=31;t++,i>>>=1)if(1&i&&0!==e.dyn_ltree[2*t])return 0;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return 1;for(t=32;t<256;t++)if(0!==e.dyn_ltree[2*t])return 1;return 0})(e)),W(e,e.l_desc),W(e,e.d_desc),s=(e=>{let t;for(F(e,e.dyn_ltree,e.l_desc.max_code),F(e,e.dyn_dtree,e.d_desc.max_code),W(e,e.bl_desc),t=18;t>=3&&0===e.bl_tree[2*g[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t})(e),r=e.opt_len+3+7>>>3,a=e.static_len+3+7>>>3,a<=r&&(r=a)):r=a=i+5,i+4<=r&&-1!==t?G(e,t,i,n):4===e.strategy||a===r?(A(e,2+(n?1:0),3),V(e,_,v)):(A(e,4+(n?1:0),3),((e,t,i,n)=>{let r;for(A(e,t-257,5),A(e,i-1,5),A(e,n-4,4),r=0;r<n;r++)A(e,e.bl_tree[2*g[r]+1],3);U(e,e.dyn_ltree,t-1),U(e,e.dyn_dtree,i-1)})(e,e.l_desc.max_code+1,e.d_desc.max_code+1,s+1),V(e,e.dyn_ltree,e.dyn_dtree)),x(e),n&&k(e)},_tr_tally:(e,t,i)=>(e.pending_buf[e.sym_buf+e.sym_next++]=t,e.pending_buf[e.sym_buf+e.sym_next++]=t>>8,e.pending_buf[e.sym_buf+e.sym_next++]=i,0===t?e.dyn_ltree[2*i]++:(e.matches++,t--,e.dyn_ltree[2*(b[i]+256+1)]++,e.dyn_dtree[2*R(t)]++),e.sym_next===e.sym_end),_tr_align:e=>{A(e,2,3),D(e,256,_),(e=>{16===e.bi_valid?(L(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)})(e)}};var H=(e,t,i,n)=>{let r=65535&e|0,a=e>>>16&65535|0,s=0;for(;0!==i;){s=i>2e3?2e3:i,i-=s;do{r=r+t[n++]|0,a=a+r|0}while(--s);r%=65521,a%=65521}return r|a<<16|0};const Z=new Uint32Array((()=>{let e,t=[];for(var i=0;i<256;i++){e=i;for(var n=0;n<8;n++)e=1&e?3988292384^e>>>1:e>>>1;t[i]=e}return t})());var q=(e,t,i,n)=>{const r=Z,a=n+i;e^=-1;for(let i=n;i<a;i++)e=e>>>8^r[255&(e^t[i])];return-1^e},Y={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},K={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:J,_tr_stored_block:Q,_tr_flush_block:X,_tr_tally:$,_tr_align:ee}=j,{Z_NO_FLUSH:te,Z_PARTIAL_FLUSH:ie,Z_FULL_FLUSH:ne,Z_FINISH:re,Z_BLOCK:ae,Z_OK:se,Z_STREAM_END:oe,Z_STREAM_ERROR:de,Z_DATA_ERROR:ce,Z_BUF_ERROR:ue,Z_DEFAULT_COMPRESSION:le,Z_FILTERED:he,Z_HUFFMAN_ONLY:pe,Z_RLE:fe,Z_FIXED:me,Z_DEFAULT_STRATEGY:ge,Z_UNKNOWN:_e,Z_DEFLATED:ve}=K,Se=(e,t)=>(e.msg=Y[t],t),be=e=>2*e-(e>4?9:0),Ie=e=>{let t=e.length;for(;--t>=0;)e[t]=0},Ce=e=>{let t,i,n,r=e.w_size;t=e.hash_size,n=t;do{i=e.head[--n],e.head[n]=i>=r?i-r:0}while(--t);t=r,n=t;do{i=e.prev[--n],e.prev[n]=i>=r?i-r:0}while(--t)};let ye=(e,t,i)=>(t<<e.hash_shift^i)&e.hash_mask;const Ee=e=>{const t=e.state;let i=t.pending;i>e.avail_out&&(i=e.avail_out),0!==i&&(e.output.set(t.pending_buf.subarray(t.pending_out,t.pending_out+i),e.next_out),e.next_out+=i,t.pending_out+=i,e.total_out+=i,e.avail_out-=i,t.pending-=i,0===t.pending&&(t.pending_out=0))},we=(e,t)=>{X(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,Ee(e.strm)},Me=(e,t)=>{e.pending_buf[e.pending++]=t},Te=(e,t)=>{e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t},Re=(e,t,i,n)=>{let r=e.avail_in;return r>n&&(r=n),0===r?0:(e.avail_in-=r,t.set(e.input.subarray(e.next_in,e.next_in+r),i),1===e.state.wrap?e.adler=H(e.adler,t,r,i):2===e.state.wrap&&(e.adler=q(e.adler,t,r,i)),e.next_in+=r,e.total_in+=r,r)},Le=(e,t)=>{let i,n,r=e.max_chain_length,a=e.strstart,s=e.prev_length,o=e.nice_match;const d=e.strstart>e.w_size-262?e.strstart-(e.w_size-262):0,c=e.window,u=e.w_mask,l=e.prev,h=e.strstart+258;let p=c[a+s-1],f=c[a+s];e.prev_length>=e.good_match&&(r>>=2),o>e.lookahead&&(o=e.lookahead);do{if(i=t,c[i+s]===f&&c[i+s-1]===p&&c[i]===c[a]&&c[++i]===c[a+1]){a+=2,i++;do{}while(c[++a]===c[++i]&&c[++a]===c[++i]&&c[++a]===c[++i]&&c[++a]===c[++i]&&c[++a]===c[++i]&&c[++a]===c[++i]&&c[++a]===c[++i]&&c[++a]===c[++i]&&a<h);if(n=258-(h-a),a=h-258,n>s){if(e.match_start=t,s=n,n>=o)break;p=c[a+s-1],f=c[a+s]}}}while((t=l[t&u])>d&&0!=--r);return s<=e.lookahead?s:e.lookahead},Ae=e=>{const t=e.w_size;let i,n,r;do{if(n=e.window_size-e.lookahead-e.strstart,e.strstart>=t+(t-262)&&(e.window.set(e.window.subarray(t,t+t-n),0),e.match_start-=t,e.strstart-=t,e.block_start-=t,e.insert>e.strstart&&(e.insert=e.strstart),Ce(e),n+=t),0===e.strm.avail_in)break;if(i=Re(e.strm,e.window,e.strstart+e.lookahead,n),e.lookahead+=i,e.lookahead+e.insert>=3)for(r=e.strstart-e.insert,e.ins_h=e.window[r],e.ins_h=ye(e,e.ins_h,e.window[r+1]);e.insert&&(e.ins_h=ye(e,e.ins_h,e.window[r+3-1]),e.prev[r&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=r,r++,e.insert--,!(e.lookahead+e.insert<3)););}while(e.lookahead<262&&0!==e.strm.avail_in)},De=(e,t)=>{let i,n,r,a=e.pending_buf_size-5>e.w_size?e.w_size:e.pending_buf_size-5,s=0,o=e.strm.avail_in;do{if(i=65535,r=e.bi_valid+42>>3,e.strm.avail_out<r)break;if(r=e.strm.avail_out-r,n=e.strstart-e.block_start,i>n+e.strm.avail_in&&(i=n+e.strm.avail_in),i>r&&(i=r),i<a&&(0===i&&t!==re||t===te||i!==n+e.strm.avail_in))break;s=t===re&&i===n+e.strm.avail_in?1:0,Q(e,0,0,s),e.pending_buf[e.pending-4]=i,e.pending_buf[e.pending-3]=i>>8,e.pending_buf[e.pending-2]=~i,e.pending_buf[e.pending-1]=~i>>8,Ee(e.strm),n&&(n>i&&(n=i),e.strm.output.set(e.window.subarray(e.block_start,e.block_start+n),e.strm.next_out),e.strm.next_out+=n,e.strm.avail_out-=n,e.strm.total_out+=n,e.block_start+=n,i-=n),i&&(Re(e.strm,e.strm.output,e.strm.next_out,i),e.strm.next_out+=i,e.strm.avail_out-=i,e.strm.total_out+=i)}while(0===s);return o-=e.strm.avail_in,o&&(o>=e.w_size?(e.matches=2,e.window.set(e.strm.input.subarray(e.strm.next_in-e.w_size,e.strm.next_in),0),e.strstart=e.w_size,e.insert=e.strstart):(e.window_size-e.strstart<=o&&(e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,e.insert>e.strstart&&(e.insert=e.strstart)),e.window.set(e.strm.input.subarray(e.strm.next_in-o,e.strm.next_in),e.strstart),e.strstart+=o,e.insert+=o>e.w_size-e.insert?e.w_size-e.insert:o),e.block_start=e.strstart),e.high_water<e.strstart&&(e.high_water=e.strstart),s?4:t!==te&&t!==re&&0===e.strm.avail_in&&e.strstart===e.block_start?2:(r=e.window_size-e.strstart,e.strm.avail_in>r&&e.block_start>=e.w_size&&(e.block_start-=e.w_size,e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,r+=e.w_size,e.insert>e.strstart&&(e.insert=e.strstart)),r>e.strm.avail_in&&(r=e.strm.avail_in),r&&(Re(e.strm,e.window,e.strstart,r),e.strstart+=r,e.insert+=r>e.w_size-e.insert?e.w_size-e.insert:r),e.high_water<e.strstart&&(e.high_water=e.strstart),r=e.bi_valid+42>>3,r=e.pending_buf_size-r>65535?65535:e.pending_buf_size-r,a=r>e.w_size?e.w_size:r,n=e.strstart-e.block_start,(n>=a||(n||t===re)&&t!==te&&0===e.strm.avail_in&&n<=r)&&(i=n>r?r:n,s=t===re&&0===e.strm.avail_in&&i===n?1:0,Q(e,e.block_start,i,s),e.block_start+=i,Ee(e.strm)),s?3:1)},Pe=(e,t)=>{let i,n;for(;;){if(e.lookahead<262){if(Ae(e),e.lookahead<262&&t===te)return 1;if(0===e.lookahead)break}if(i=0,e.lookahead>=3&&(e.ins_h=ye(e,e.ins_h,e.window[e.strstart+3-1]),i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==i&&e.strstart-i<=e.w_size-262&&(e.match_length=Le(e,i)),e.match_length>=3)if(n=$(e,e.strstart-e.match_start,e.match_length-3),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=3){e.match_length--;do{e.strstart++,e.ins_h=ye(e,e.ins_h,e.window[e.strstart+3-1]),i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart}while(0!=--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=ye(e,e.ins_h,e.window[e.strstart+1]);else n=$(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(n&&(we(e,!1),0===e.strm.avail_out))return 1}return e.insert=e.strstart<2?e.strstart:2,t===re?(we(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(we(e,!1),0===e.strm.avail_out)?1:2},Oe=(e,t)=>{let i,n,r;for(;;){if(e.lookahead<262){if(Ae(e),e.lookahead<262&&t===te)return 1;if(0===e.lookahead)break}if(i=0,e.lookahead>=3&&(e.ins_h=ye(e,e.ins_h,e.window[e.strstart+3-1]),i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=2,0!==i&&e.prev_length<e.max_lazy_match&&e.strstart-i<=e.w_size-262&&(e.match_length=Le(e,i),e.match_length<=5&&(e.strategy===he||3===e.match_length&&e.strstart-e.match_start>4096)&&(e.match_length=2)),e.prev_length>=3&&e.match_length<=e.prev_length){r=e.strstart+e.lookahead-3,n=$(e,e.strstart-1-e.prev_match,e.prev_length-3),e.lookahead-=e.prev_length-1,e.prev_length-=2;do{++e.strstart<=r&&(e.ins_h=ye(e,e.ins_h,e.window[e.strstart+3-1]),i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart)}while(0!=--e.prev_length);if(e.match_available=0,e.match_length=2,e.strstart++,n&&(we(e,!1),0===e.strm.avail_out))return 1}else if(e.match_available){if(n=$(e,0,e.window[e.strstart-1]),n&&we(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return 1}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(n=$(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<2?e.strstart:2,t===re?(we(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(we(e,!1),0===e.strm.avail_out)?1:2};function xe(e,t,i,n,r){this.good_length=e,this.max_lazy=t,this.nice_length=i,this.max_chain=n,this.func=r}const ke=[new xe(0,0,0,0,De),new xe(4,4,8,4,Pe),new xe(4,5,16,8,Pe),new xe(4,6,32,32,Pe),new xe(4,4,16,16,Oe),new xe(8,16,32,32,Oe),new xe(8,16,128,128,Oe),new xe(8,32,128,256,Oe),new xe(32,128,258,1024,Oe),new xe(32,258,258,4096,Oe)];function Ne(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=ve,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(1146),this.dyn_dtree=new Uint16Array(122),this.bl_tree=new Uint16Array(78),Ie(this.dyn_ltree),Ie(this.dyn_dtree),Ie(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(16),this.heap=new Uint16Array(573),Ie(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(573),Ie(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const Be=e=>{if(!e)return 1;const t=e.state;return!t||t.strm!==e||42!==t.status&&57!==t.status&&69!==t.status&&73!==t.status&&91!==t.status&&103!==t.status&&113!==t.status&&666!==t.status?1:0},Ve=e=>{if(Be(e))return Se(e,de);e.total_in=e.total_out=0,e.data_type=_e;const t=e.state;return t.pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=2===t.wrap?57:t.wrap?42:113,e.adler=2===t.wrap?0:1,t.last_flush=-2,J(t),se},We=e=>{const t=Ve(e);var i;return t===se&&((i=e.state).window_size=2*i.w_size,Ie(i.head),i.max_lazy_match=ke[i.level].max_lazy,i.good_match=ke[i.level].good_length,i.nice_match=ke[i.level].nice_length,i.max_chain_length=ke[i.level].max_chain,i.strstart=0,i.block_start=0,i.lookahead=0,i.insert=0,i.match_length=i.prev_length=2,i.match_available=0,i.ins_h=0),t},Fe=(e,t,i,n,r,a)=>{if(!e)return de;let s=1;if(t===le&&(t=6),n<0?(s=0,n=-n):n>15&&(s=2,n-=16),r<1||r>9||i!==ve||n<8||n>15||t<0||t>9||a<0||a>me||8===n&&1!==s)return Se(e,de);8===n&&(n=9);const o=new Ne;return e.state=o,o.strm=e,o.status=42,o.wrap=s,o.gzhead=null,o.w_bits=n,o.w_size=1<<o.w_bits,o.w_mask=o.w_size-1,o.hash_bits=r+7,o.hash_size=1<<o.hash_bits,o.hash_mask=o.hash_size-1,o.hash_shift=~~((o.hash_bits+3-1)/3),o.window=new Uint8Array(2*o.w_size),o.head=new Uint16Array(o.hash_size),o.prev=new Uint16Array(o.w_size),o.lit_bufsize=1<<r+6,o.pending_buf_size=4*o.lit_bufsize,o.pending_buf=new Uint8Array(o.pending_buf_size),o.sym_buf=o.lit_bufsize,o.sym_end=3*(o.lit_bufsize-1),o.level=t,o.strategy=a,o.method=i,We(e)};var Ue={deflateInit:(e,t)=>Fe(e,t,ve,15,8,ge),deflateInit2:Fe,deflateReset:We,deflateResetKeep:Ve,deflateSetHeader:(e,t)=>Be(e)||2!==e.state.wrap?de:(e.state.gzhead=t,se),deflate:(e,t)=>{if(Be(e)||t>ae||t<0)return e?Se(e,de):de;const i=e.state;if(!e.output||0!==e.avail_in&&!e.input||666===i.status&&t!==re)return Se(e,0===e.avail_out?ue:de);const n=i.last_flush;if(i.last_flush=t,0!==i.pending){if(Ee(e),0===e.avail_out)return i.last_flush=-1,se}else if(0===e.avail_in&&be(t)<=be(n)&&t!==re)return Se(e,ue);if(666===i.status&&0!==e.avail_in)return Se(e,ue);if(42===i.status&&0===i.wrap&&(i.status=113),42===i.status){let t=ve+(i.w_bits-8<<4)<<8,n=-1;if(n=i.strategy>=pe||i.level<2?0:i.level<6?1:6===i.level?2:3,t|=n<<6,0!==i.strstart&&(t|=32),t+=31-t%31,Te(i,t),0!==i.strstart&&(Te(i,e.adler>>>16),Te(i,65535&e.adler)),e.adler=1,i.status=113,Ee(e),0!==i.pending)return i.last_flush=-1,se}if(57===i.status)if(e.adler=0,Me(i,31),Me(i,139),Me(i,8),i.gzhead)Me(i,(i.gzhead.text?1:0)+(i.gzhead.hcrc?2:0)+(i.gzhead.extra?4:0)+(i.gzhead.name?8:0)+(i.gzhead.comment?16:0)),Me(i,255&i.gzhead.time),Me(i,i.gzhead.time>>8&255),Me(i,i.gzhead.time>>16&255),Me(i,i.gzhead.time>>24&255),Me(i,9===i.level?2:i.strategy>=pe||i.level<2?4:0),Me(i,255&i.gzhead.os),i.gzhead.extra&&i.gzhead.extra.length&&(Me(i,255&i.gzhead.extra.length),Me(i,i.gzhead.extra.length>>8&255)),i.gzhead.hcrc&&(e.adler=q(e.adler,i.pending_buf,i.pending,0)),i.gzindex=0,i.status=69;else if(Me(i,0),Me(i,0),Me(i,0),Me(i,0),Me(i,0),Me(i,9===i.level?2:i.strategy>=pe||i.level<2?4:0),Me(i,3),i.status=113,Ee(e),0!==i.pending)return i.last_flush=-1,se;if(69===i.status){if(i.gzhead.extra){let t=i.pending,n=(65535&i.gzhead.extra.length)-i.gzindex;for(;i.pending+n>i.pending_buf_size;){let r=i.pending_buf_size-i.pending;if(i.pending_buf.set(i.gzhead.extra.subarray(i.gzindex,i.gzindex+r),i.pending),i.pending=i.pending_buf_size,i.gzhead.hcrc&&i.pending>t&&(e.adler=q(e.adler,i.pending_buf,i.pending-t,t)),i.gzindex+=r,Ee(e),0!==i.pending)return i.last_flush=-1,se;t=0,n-=r}let r=new Uint8Array(i.gzhead.extra);i.pending_buf.set(r.subarray(i.gzindex,i.gzindex+n),i.pending),i.pending+=n,i.gzhead.hcrc&&i.pending>t&&(e.adler=q(e.adler,i.pending_buf,i.pending-t,t)),i.gzindex=0}i.status=73}if(73===i.status){if(i.gzhead.name){let t,n=i.pending;do{if(i.pending===i.pending_buf_size){if(i.gzhead.hcrc&&i.pending>n&&(e.adler=q(e.adler,i.pending_buf,i.pending-n,n)),Ee(e),0!==i.pending)return i.last_flush=-1,se;n=0}t=i.gzindex<i.gzhead.name.length?255&i.gzhead.name.charCodeAt(i.gzindex++):0,Me(i,t)}while(0!==t);i.gzhead.hcrc&&i.pending>n&&(e.adler=q(e.adler,i.pending_buf,i.pending-n,n)),i.gzindex=0}i.status=91}if(91===i.status){if(i.gzhead.comment){let t,n=i.pending;do{if(i.pending===i.pending_buf_size){if(i.gzhead.hcrc&&i.pending>n&&(e.adler=q(e.adler,i.pending_buf,i.pending-n,n)),Ee(e),0!==i.pending)return i.last_flush=-1,se;n=0}t=i.gzindex<i.gzhead.comment.length?255&i.gzhead.comment.charCodeAt(i.gzindex++):0,Me(i,t)}while(0!==t);i.gzhead.hcrc&&i.pending>n&&(e.adler=q(e.adler,i.pending_buf,i.pending-n,n))}i.status=103}if(103===i.status){if(i.gzhead.hcrc){if(i.pending+2>i.pending_buf_size&&(Ee(e),0!==i.pending))return i.last_flush=-1,se;Me(i,255&e.adler),Me(i,e.adler>>8&255),e.adler=0}if(i.status=113,Ee(e),0!==i.pending)return i.last_flush=-1,se}if(0!==e.avail_in||0!==i.lookahead||t!==te&&666!==i.status){let n=0===i.level?De(i,t):i.strategy===pe?((e,t)=>{let i;for(;;){if(0===e.lookahead&&(Ae(e),0===e.lookahead)){if(t===te)return 1;break}if(e.match_length=0,i=$(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,i&&(we(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,t===re?(we(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(we(e,!1),0===e.strm.avail_out)?1:2})(i,t):i.strategy===fe?((e,t)=>{let i,n,r,a;const s=e.window;for(;;){if(e.lookahead<=258){if(Ae(e),e.lookahead<=258&&t===te)return 1;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=3&&e.strstart>0&&(r=e.strstart-1,n=s[r],n===s[++r]&&n===s[++r]&&n===s[++r])){a=e.strstart+258;do{}while(n===s[++r]&&n===s[++r]&&n===s[++r]&&n===s[++r]&&n===s[++r]&&n===s[++r]&&n===s[++r]&&n===s[++r]&&r<a);e.match_length=258-(a-r),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=3?(i=$(e,1,e.match_length-3),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(i=$(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),i&&(we(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,t===re?(we(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(we(e,!1),0===e.strm.avail_out)?1:2})(i,t):ke[i.level].func(i,t);if(3!==n&&4!==n||(i.status=666),1===n||3===n)return 0===e.avail_out&&(i.last_flush=-1),se;if(2===n&&(t===ie?ee(i):t!==ae&&(Q(i,0,0,!1),t===ne&&(Ie(i.head),0===i.lookahead&&(i.strstart=0,i.block_start=0,i.insert=0))),Ee(e),0===e.avail_out))return i.last_flush=-1,se}return t!==re?se:i.wrap<=0?oe:(2===i.wrap?(Me(i,255&e.adler),Me(i,e.adler>>8&255),Me(i,e.adler>>16&255),Me(i,e.adler>>24&255),Me(i,255&e.total_in),Me(i,e.total_in>>8&255),Me(i,e.total_in>>16&255),Me(i,e.total_in>>24&255)):(Te(i,e.adler>>>16),Te(i,65535&e.adler)),Ee(e),i.wrap>0&&(i.wrap=-i.wrap),0!==i.pending?se:oe)},deflateEnd:e=>{if(Be(e))return de;const t=e.state.status;return e.state=null,113===t?Se(e,ce):se},deflateSetDictionary:(e,t)=>{let i=t.length;if(Be(e))return de;const n=e.state,r=n.wrap;if(2===r||1===r&&42!==n.status||n.lookahead)return de;if(1===r&&(e.adler=H(e.adler,t,i,0)),n.wrap=0,i>=n.w_size){0===r&&(Ie(n.head),n.strstart=0,n.block_start=0,n.insert=0);let e=new Uint8Array(n.w_size);e.set(t.subarray(i-n.w_size,i),0),t=e,i=n.w_size}const a=e.avail_in,s=e.next_in,o=e.input;for(e.avail_in=i,e.next_in=0,e.input=t,Ae(n);n.lookahead>=3;){let e=n.strstart,t=n.lookahead-2;do{n.ins_h=ye(n,n.ins_h,n.window[e+3-1]),n.prev[e&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=e,e++}while(--t);n.strstart=e,n.lookahead=2,Ae(n)}return n.strstart+=n.lookahead,n.block_start=n.strstart,n.insert=n.lookahead,n.lookahead=0,n.match_length=n.prev_length=2,n.match_available=0,e.next_in=s,e.input=o,e.avail_in=a,n.wrap=r,se},deflateInfo:"pako deflate (from Nodeca project)"};const ze=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var Ge=function(e){const t=Array.prototype.slice.call(arguments,1);for(;t.length;){const i=t.shift();if(i){if("object"!=typeof i)throw new TypeError(i+"must be non-object");for(const t in i)ze(i,t)&&(e[t]=i[t])}}return e},je=e=>{let t=0;for(let i=0,n=e.length;i<n;i++)t+=e[i].length;const i=new Uint8Array(t);for(let t=0,n=0,r=e.length;t<r;t++){let r=e[t];i.set(r,n),n+=r.length}return i};let He=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){He=!1}const Ze=new Uint8Array(256);for(let e=0;e<256;e++)Ze[e]=e>=252?6:e>=248?5:e>=240?4:e>=224?3:e>=192?2:1;Ze[254]=Ze[254]=1;var qe=e=>{if("function"==typeof TextEncoder&&TextEncoder.prototype.encode)return(new TextEncoder).encode(e);let t,i,n,r,a,s=e.length,o=0;for(r=0;r<s;r++)i=e.charCodeAt(r),55296==(64512&i)&&r+1<s&&(n=e.charCodeAt(r+1),56320==(64512&n)&&(i=65536+(i-55296<<10)+(n-56320),r++)),o+=i<128?1:i<2048?2:i<65536?3:4;for(t=new Uint8Array(o),a=0,r=0;a<o;r++)i=e.charCodeAt(r),55296==(64512&i)&&r+1<s&&(n=e.charCodeAt(r+1),56320==(64512&n)&&(i=65536+(i-55296<<10)+(n-56320),r++)),i<128?t[a++]=i:i<2048?(t[a++]=192|i>>>6,t[a++]=128|63&i):i<65536?(t[a++]=224|i>>>12,t[a++]=128|i>>>6&63,t[a++]=128|63&i):(t[a++]=240|i>>>18,t[a++]=128|i>>>12&63,t[a++]=128|i>>>6&63,t[a++]=128|63&i);return t},Ye=(e,t)=>{const i=t||e.length;if("function"==typeof TextDecoder&&TextDecoder.prototype.decode)return(new TextDecoder).decode(e.subarray(0,t));let n,r;const a=new Array(2*i);for(r=0,n=0;n<i;){let t=e[n++];if(t<128){a[r++]=t;continue}let s=Ze[t];if(s>4)a[r++]=65533,n+=s-1;else{for(t&=2===s?31:3===s?15:7;s>1&&n<i;)t=t<<6|63&e[n++],s--;s>1?a[r++]=65533:t<65536?a[r++]=t:(t-=65536,a[r++]=55296|t>>10&1023,a[r++]=56320|1023&t)}}return((e,t)=>{if(t<65534&&e.subarray&&He)return String.fromCharCode.apply(null,e.length===t?e:e.subarray(0,t));let i="";for(let n=0;n<t;n++)i+=String.fromCharCode(e[n]);return i})(a,r)},Ke=(e,t)=>{(t=t||e.length)>e.length&&(t=e.length);let i=t-1;for(;i>=0&&128==(192&e[i]);)i--;return i<0||0===i?t:i+Ze[e[i]]>t?i:t};var Je=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const Qe=Object.prototype.toString,{Z_NO_FLUSH:Xe,Z_SYNC_FLUSH:$e,Z_FULL_FLUSH:et,Z_FINISH:tt,Z_OK:it,Z_STREAM_END:nt,Z_DEFAULT_COMPRESSION:rt,Z_DEFAULT_STRATEGY:at,Z_DEFLATED:st}=K;function ot(e){this.options=Ge({level:rt,method:st,chunkSize:16384,windowBits:15,memLevel:8,strategy:at},e||{});let t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Je,this.strm.avail_out=0;let i=Ue.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(i!==it)throw new Error(Y[i]);if(t.header&&Ue.deflateSetHeader(this.strm,t.header),t.dictionary){let e;if(e="string"==typeof t.dictionary?qe(t.dictionary):"[object ArrayBuffer]"===Qe.call(t.dictionary)?new Uint8Array(t.dictionary):t.dictionary,i=Ue.deflateSetDictionary(this.strm,e),i!==it)throw new Error(Y[i]);this._dict_set=!0}}function dt(e,t){const i=new ot(t);if(i.push(e,!0),i.err)throw i.msg||Y[i.err];return i.result}ot.prototype.push=function(e,t){const i=this.strm,n=this.options.chunkSize;let r,a;if(this.ended)return!1;for(a=t===~~t?t:!0===t?tt:Xe,"string"==typeof e?i.input=qe(e):"[object ArrayBuffer]"===Qe.call(e)?i.input=new Uint8Array(e):i.input=e,i.next_in=0,i.avail_in=i.input.length;;)if(0===i.avail_out&&(i.output=new Uint8Array(n),i.next_out=0,i.avail_out=n),(a===$e||a===et)&&i.avail_out<=6)this.onData(i.output.subarray(0,i.next_out)),i.avail_out=0;else{if(r=Ue.deflate(i,a),r===nt)return i.next_out>0&&this.onData(i.output.subarray(0,i.next_out)),r=Ue.deflateEnd(this.strm),this.onEnd(r),this.ended=!0,r===it;if(0!==i.avail_out){if(a>0&&i.next_out>0)this.onData(i.output.subarray(0,i.next_out)),i.avail_out=0;else if(0===i.avail_in)break}else this.onData(i.output)}return!0},ot.prototype.onData=function(e){this.chunks.push(e)},ot.prototype.onEnd=function(e){e===it&&(this.result=je(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var ct={Deflate:ot,deflate:dt,deflateRaw:function(e,t){return(t=t||{}).raw=!0,dt(e,t)},gzip:function(e,t){return(t=t||{}).gzip=!0,dt(e,t)},constants:K};var ut=function(e,t){let i,n,r,a,s,o,d,c,u,l,h,p,f,m,g,_,v,S,b,I,C,y,E,w;const M=e.state;i=e.next_in,E=e.input,n=i+(e.avail_in-5),r=e.next_out,w=e.output,a=r-(t-e.avail_out),s=r+(e.avail_out-257),o=M.dmax,d=M.wsize,c=M.whave,u=M.wnext,l=M.window,h=M.hold,p=M.bits,f=M.lencode,m=M.distcode,g=(1<<M.lenbits)-1,_=(1<<M.distbits)-1;e:do{p<15&&(h+=E[i++]<<p,p+=8,h+=E[i++]<<p,p+=8),v=f[h&g];t:for(;;){if(S=v>>>24,h>>>=S,p-=S,S=v>>>16&255,0===S)w[r++]=65535&v;else{if(!(16&S)){if(0==(64&S)){v=f[(65535&v)+(h&(1<<S)-1)];continue t}if(32&S){M.mode=16191;break e}e.msg="invalid literal/length code",M.mode=16209;break e}b=65535&v,S&=15,S&&(p<S&&(h+=E[i++]<<p,p+=8),b+=h&(1<<S)-1,h>>>=S,p-=S),p<15&&(h+=E[i++]<<p,p+=8,h+=E[i++]<<p,p+=8),v=m[h&_];i:for(;;){if(S=v>>>24,h>>>=S,p-=S,S=v>>>16&255,!(16&S)){if(0==(64&S)){v=m[(65535&v)+(h&(1<<S)-1)];continue i}e.msg="invalid distance code",M.mode=16209;break e}if(I=65535&v,S&=15,p<S&&(h+=E[i++]<<p,p+=8,p<S&&(h+=E[i++]<<p,p+=8)),I+=h&(1<<S)-1,I>o){e.msg="invalid distance too far back",M.mode=16209;break e}if(h>>>=S,p-=S,S=r-a,I>S){if(S=I-S,S>c&&M.sane){e.msg="invalid distance too far back",M.mode=16209;break e}if(C=0,y=l,0===u){if(C+=d-S,S<b){b-=S;do{w[r++]=l[C++]}while(--S);C=r-I,y=w}}else if(u<S){if(C+=d+u-S,S-=u,S<b){b-=S;do{w[r++]=l[C++]}while(--S);if(C=0,u<b){S=u,b-=S;do{w[r++]=l[C++]}while(--S);C=r-I,y=w}}}else if(C+=u-S,S<b){b-=S;do{w[r++]=l[C++]}while(--S);C=r-I,y=w}for(;b>2;)w[r++]=y[C++],w[r++]=y[C++],w[r++]=y[C++],b-=3;b&&(w[r++]=y[C++],b>1&&(w[r++]=y[C++]))}else{C=r-I;do{w[r++]=w[C++],w[r++]=w[C++],w[r++]=w[C++],b-=3}while(b>2);b&&(w[r++]=w[C++],b>1&&(w[r++]=w[C++]))}break}}break}}while(i<n&&r<s);b=p>>3,i-=b,p-=b<<3,h&=(1<<p)-1,e.next_in=i,e.next_out=r,e.avail_in=i<n?n-i+5:5-(i-n),e.avail_out=r<s?s-r+257:257-(r-s),M.hold=h,M.bits=p};const lt=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),ht=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),pt=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),ft=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var mt=(e,t,i,n,r,a,s,o)=>{const d=o.bits;let c,u,l,h,p,f,m=0,g=0,_=0,v=0,S=0,b=0,I=0,C=0,y=0,E=0,w=null;const M=new Uint16Array(16),T=new Uint16Array(16);let R,L,A,D=null;for(m=0;m<=15;m++)M[m]=0;for(g=0;g<n;g++)M[t[i+g]]++;for(S=d,v=15;v>=1&&0===M[v];v--);if(S>v&&(S=v),0===v)return r[a++]=20971520,r[a++]=20971520,o.bits=1,0;for(_=1;_<v&&0===M[_];_++);for(S<_&&(S=_),C=1,m=1;m<=15;m++)if(C<<=1,C-=M[m],C<0)return-1;if(C>0&&(0===e||1!==v))return-1;for(T[1]=0,m=1;m<15;m++)T[m+1]=T[m]+M[m];for(g=0;g<n;g++)0!==t[i+g]&&(s[T[t[i+g]]++]=g);if(0===e?(w=D=s,f=20):1===e?(w=lt,D=ht,f=257):(w=pt,D=ft,f=0),E=0,g=0,m=_,p=a,b=S,I=0,l=-1,y=1<<S,h=y-1,1===e&&y>852||2===e&&y>592)return 1;for(;;){R=m-I,s[g]+1<f?(L=0,A=s[g]):s[g]>=f?(L=D[s[g]-f],A=w[s[g]-f]):(L=96,A=0),c=1<<m-I,u=1<<b,_=u;do{u-=c,r[p+(E>>I)+u]=R<<24|L<<16|A|0}while(0!==u);for(c=1<<m-1;E&c;)c>>=1;if(0!==c?(E&=c-1,E+=c):E=0,g++,0==--M[m]){if(m===v)break;m=t[i+s[g]]}if(m>S&&(E&h)!==l){for(0===I&&(I=S),p+=_,b=m-I,C=1<<b;b+I<v&&(C-=M[b+I],!(C<=0));)b++,C<<=1;if(y+=1<<b,1===e&&y>852||2===e&&y>592)return 1;l=E&h,r[l]=S<<24|b<<16|p-a|0}}return 0!==E&&(r[p+E]=m-I<<24|64<<16|0),o.bits=S,0};const{Z_FINISH:gt,Z_BLOCK:_t,Z_TREES:vt,Z_OK:St,Z_STREAM_END:bt,Z_NEED_DICT:It,Z_STREAM_ERROR:Ct,Z_DATA_ERROR:yt,Z_MEM_ERROR:Et,Z_BUF_ERROR:wt,Z_DEFLATED:Mt}=K,Tt=16209,Rt=e=>(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24);function Lt(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const At=e=>{if(!e)return 1;const t=e.state;return!t||t.strm!==e||t.mode<16180||t.mode>16211?1:0},Dt=e=>{if(At(e))return Ct;const t=e.state;return e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=16180,t.last=0,t.havedict=0,t.flags=-1,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new Int32Array(852),t.distcode=t.distdyn=new Int32Array(592),t.sane=1,t.back=-1,St},Pt=e=>{if(At(e))return Ct;const t=e.state;return t.wsize=0,t.whave=0,t.wnext=0,Dt(e)},Ot=(e,t)=>{let i;if(At(e))return Ct;const n=e.state;return t<0?(i=0,t=-t):(i=5+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?Ct:(null!==n.window&&n.wbits!==t&&(n.window=null),n.wrap=i,n.wbits=t,Pt(e))},xt=(e,t)=>{if(!e)return Ct;const i=new Lt;e.state=i,i.strm=e,i.window=null,i.mode=16180;const n=Ot(e,t);return n!==St&&(e.state=null),n};let kt,Nt,Bt=!0;const Vt=e=>{if(Bt){kt=new Int32Array(512),Nt=new Int32Array(32);let t=0;for(;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(mt(1,e.lens,0,288,kt,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;mt(2,e.lens,0,32,Nt,0,e.work,{bits:5}),Bt=!1}e.lencode=kt,e.lenbits=9,e.distcode=Nt,e.distbits=5},Wt=(e,t,i,n)=>{let r;const a=e.state;return null===a.window&&(a.wsize=1<<a.wbits,a.wnext=0,a.whave=0,a.window=new Uint8Array(a.wsize)),n>=a.wsize?(a.window.set(t.subarray(i-a.wsize,i),0),a.wnext=0,a.whave=a.wsize):(r=a.wsize-a.wnext,r>n&&(r=n),a.window.set(t.subarray(i-n,i-n+r),a.wnext),(n-=r)?(a.window.set(t.subarray(i-n,i),0),a.wnext=n,a.whave=a.wsize):(a.wnext+=r,a.wnext===a.wsize&&(a.wnext=0),a.whave<a.wsize&&(a.whave+=r))),0};var Ft={inflateReset:Pt,inflateReset2:Ot,inflateResetKeep:Dt,inflateInit:e=>xt(e,15),inflateInit2:xt,inflate:(e,t)=>{let i,n,r,a,s,o,d,c,u,l,h,p,f,m,g,_,v,S,b,I,C,y,E=0;const w=new Uint8Array(4);let M,T;const R=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(At(e)||!e.output||!e.input&&0!==e.avail_in)return Ct;i=e.state,16191===i.mode&&(i.mode=16192),s=e.next_out,r=e.output,d=e.avail_out,a=e.next_in,n=e.input,o=e.avail_in,c=i.hold,u=i.bits,l=o,h=d,y=St;e:for(;;)switch(i.mode){case 16180:if(0===i.wrap){i.mode=16192;break}for(;u<16;){if(0===o)break e;o--,c+=n[a++]<<u,u+=8}if(2&i.wrap&&35615===c){0===i.wbits&&(i.wbits=15),i.check=0,w[0]=255&c,w[1]=c>>>8&255,i.check=q(i.check,w,2,0),c=0,u=0,i.mode=16181;break}if(i.head&&(i.head.done=!1),!(1&i.wrap)||(((255&c)<<8)+(c>>8))%31){e.msg="incorrect header check",i.mode=Tt;break}if((15&c)!==Mt){e.msg="unknown compression method",i.mode=Tt;break}if(c>>>=4,u-=4,C=8+(15&c),0===i.wbits&&(i.wbits=C),C>15||C>i.wbits){e.msg="invalid window size",i.mode=Tt;break}i.dmax=1<<i.wbits,i.flags=0,e.adler=i.check=1,i.mode=512&c?16189:16191,c=0,u=0;break;case 16181:for(;u<16;){if(0===o)break e;o--,c+=n[a++]<<u,u+=8}if(i.flags=c,(255&i.flags)!==Mt){e.msg="unknown compression method",i.mode=Tt;break}if(57344&i.flags){e.msg="unknown header flags set",i.mode=Tt;break}i.head&&(i.head.text=c>>8&1),512&i.flags&&4&i.wrap&&(w[0]=255&c,w[1]=c>>>8&255,i.check=q(i.check,w,2,0)),c=0,u=0,i.mode=16182;case 16182:for(;u<32;){if(0===o)break e;o--,c+=n[a++]<<u,u+=8}i.head&&(i.head.time=c),512&i.flags&&4&i.wrap&&(w[0]=255&c,w[1]=c>>>8&255,w[2]=c>>>16&255,w[3]=c>>>24&255,i.check=q(i.check,w,4,0)),c=0,u=0,i.mode=16183;case 16183:for(;u<16;){if(0===o)break e;o--,c+=n[a++]<<u,u+=8}i.head&&(i.head.xflags=255&c,i.head.os=c>>8),512&i.flags&&4&i.wrap&&(w[0]=255&c,w[1]=c>>>8&255,i.check=q(i.check,w,2,0)),c=0,u=0,i.mode=16184;case 16184:if(1024&i.flags){for(;u<16;){if(0===o)break e;o--,c+=n[a++]<<u,u+=8}i.length=c,i.head&&(i.head.extra_len=c),512&i.flags&&4&i.wrap&&(w[0]=255&c,w[1]=c>>>8&255,i.check=q(i.check,w,2,0)),c=0,u=0}else i.head&&(i.head.extra=null);i.mode=16185;case 16185:if(1024&i.flags&&(p=i.length,p>o&&(p=o),p&&(i.head&&(C=i.head.extra_len-i.length,i.head.extra||(i.head.extra=new Uint8Array(i.head.extra_len)),i.head.extra.set(n.subarray(a,a+p),C)),512&i.flags&&4&i.wrap&&(i.check=q(i.check,n,p,a)),o-=p,a+=p,i.length-=p),i.length))break e;i.length=0,i.mode=16186;case 16186:if(2048&i.flags){if(0===o)break e;p=0;do{C=n[a+p++],i.head&&C&&i.length<65536&&(i.head.name+=String.fromCharCode(C))}while(C&&p<o);if(512&i.flags&&4&i.wrap&&(i.check=q(i.check,n,p,a)),o-=p,a+=p,C)break e}else i.head&&(i.head.name=null);i.length=0,i.mode=16187;case 16187:if(4096&i.flags){if(0===o)break e;p=0;do{C=n[a+p++],i.head&&C&&i.length<65536&&(i.head.comment+=String.fromCharCode(C))}while(C&&p<o);if(512&i.flags&&4&i.wrap&&(i.check=q(i.check,n,p,a)),o-=p,a+=p,C)break e}else i.head&&(i.head.comment=null);i.mode=16188;case 16188:if(512&i.flags){for(;u<16;){if(0===o)break e;o--,c+=n[a++]<<u,u+=8}if(4&i.wrap&&c!==(65535&i.check)){e.msg="header crc mismatch",i.mode=Tt;break}c=0,u=0}i.head&&(i.head.hcrc=i.flags>>9&1,i.head.done=!0),e.adler=i.check=0,i.mode=16191;break;case 16189:for(;u<32;){if(0===o)break e;o--,c+=n[a++]<<u,u+=8}e.adler=i.check=Rt(c),c=0,u=0,i.mode=16190;case 16190:if(0===i.havedict)return e.next_out=s,e.avail_out=d,e.next_in=a,e.avail_in=o,i.hold=c,i.bits=u,It;e.adler=i.check=1,i.mode=16191;case 16191:if(t===_t||t===vt)break e;case 16192:if(i.last){c>>>=7&u,u-=7&u,i.mode=16206;break}for(;u<3;){if(0===o)break e;o--,c+=n[a++]<<u,u+=8}switch(i.last=1&c,c>>>=1,u-=1,3&c){case 0:i.mode=16193;break;case 1:if(Vt(i),i.mode=16199,t===vt){c>>>=2,u-=2;break e}break;case 2:i.mode=16196;break;case 3:e.msg="invalid block type",i.mode=Tt}c>>>=2,u-=2;break;case 16193:for(c>>>=7&u,u-=7&u;u<32;){if(0===o)break e;o--,c+=n[a++]<<u,u+=8}if((65535&c)!=(c>>>16^65535)){e.msg="invalid stored block lengths",i.mode=Tt;break}if(i.length=65535&c,c=0,u=0,i.mode=16194,t===vt)break e;case 16194:i.mode=16195;case 16195:if(p=i.length,p){if(p>o&&(p=o),p>d&&(p=d),0===p)break e;r.set(n.subarray(a,a+p),s),o-=p,a+=p,d-=p,s+=p,i.length-=p;break}i.mode=16191;break;case 16196:for(;u<14;){if(0===o)break e;o--,c+=n[a++]<<u,u+=8}if(i.nlen=257+(31&c),c>>>=5,u-=5,i.ndist=1+(31&c),c>>>=5,u-=5,i.ncode=4+(15&c),c>>>=4,u-=4,i.nlen>286||i.ndist>30){e.msg="too many length or distance symbols",i.mode=Tt;break}i.have=0,i.mode=16197;case 16197:for(;i.have<i.ncode;){for(;u<3;){if(0===o)break e;o--,c+=n[a++]<<u,u+=8}i.lens[R[i.have++]]=7&c,c>>>=3,u-=3}for(;i.have<19;)i.lens[R[i.have++]]=0;if(i.lencode=i.lendyn,i.lenbits=7,M={bits:i.lenbits},y=mt(0,i.lens,0,19,i.lencode,0,i.work,M),i.lenbits=M.bits,y){e.msg="invalid code lengths set",i.mode=Tt;break}i.have=0,i.mode=16198;case 16198:for(;i.have<i.nlen+i.ndist;){for(;E=i.lencode[c&(1<<i.lenbits)-1],g=E>>>24,_=E>>>16&255,v=65535&E,!(g<=u);){if(0===o)break e;o--,c+=n[a++]<<u,u+=8}if(v<16)c>>>=g,u-=g,i.lens[i.have++]=v;else{if(16===v){for(T=g+2;u<T;){if(0===o)break e;o--,c+=n[a++]<<u,u+=8}if(c>>>=g,u-=g,0===i.have){e.msg="invalid bit length repeat",i.mode=Tt;break}C=i.lens[i.have-1],p=3+(3&c),c>>>=2,u-=2}else if(17===v){for(T=g+3;u<T;){if(0===o)break e;o--,c+=n[a++]<<u,u+=8}c>>>=g,u-=g,C=0,p=3+(7&c),c>>>=3,u-=3}else{for(T=g+7;u<T;){if(0===o)break e;o--,c+=n[a++]<<u,u+=8}c>>>=g,u-=g,C=0,p=11+(127&c),c>>>=7,u-=7}if(i.have+p>i.nlen+i.ndist){e.msg="invalid bit length repeat",i.mode=Tt;break}for(;p--;)i.lens[i.have++]=C}}if(i.mode===Tt)break;if(0===i.lens[256]){e.msg="invalid code -- missing end-of-block",i.mode=Tt;break}if(i.lenbits=9,M={bits:i.lenbits},y=mt(1,i.lens,0,i.nlen,i.lencode,0,i.work,M),i.lenbits=M.bits,y){e.msg="invalid literal/lengths set",i.mode=Tt;break}if(i.distbits=6,i.distcode=i.distdyn,M={bits:i.distbits},y=mt(2,i.lens,i.nlen,i.ndist,i.distcode,0,i.work,M),i.distbits=M.bits,y){e.msg="invalid distances set",i.mode=Tt;break}if(i.mode=16199,t===vt)break e;case 16199:i.mode=16200;case 16200:if(o>=6&&d>=258){e.next_out=s,e.avail_out=d,e.next_in=a,e.avail_in=o,i.hold=c,i.bits=u,ut(e,h),s=e.next_out,r=e.output,d=e.avail_out,a=e.next_in,n=e.input,o=e.avail_in,c=i.hold,u=i.bits,16191===i.mode&&(i.back=-1);break}for(i.back=0;E=i.lencode[c&(1<<i.lenbits)-1],g=E>>>24,_=E>>>16&255,v=65535&E,!(g<=u);){if(0===o)break e;o--,c+=n[a++]<<u,u+=8}if(_&&0==(240&_)){for(S=g,b=_,I=v;E=i.lencode[I+((c&(1<<S+b)-1)>>S)],g=E>>>24,_=E>>>16&255,v=65535&E,!(S+g<=u);){if(0===o)break e;o--,c+=n[a++]<<u,u+=8}c>>>=S,u-=S,i.back+=S}if(c>>>=g,u-=g,i.back+=g,i.length=v,0===_){i.mode=16205;break}if(32&_){i.back=-1,i.mode=16191;break}if(64&_){e.msg="invalid literal/length code",i.mode=Tt;break}i.extra=15&_,i.mode=16201;case 16201:if(i.extra){for(T=i.extra;u<T;){if(0===o)break e;o--,c+=n[a++]<<u,u+=8}i.length+=c&(1<<i.extra)-1,c>>>=i.extra,u-=i.extra,i.back+=i.extra}i.was=i.length,i.mode=16202;case 16202:for(;E=i.distcode[c&(1<<i.distbits)-1],g=E>>>24,_=E>>>16&255,v=65535&E,!(g<=u);){if(0===o)break e;o--,c+=n[a++]<<u,u+=8}if(0==(240&_)){for(S=g,b=_,I=v;E=i.distcode[I+((c&(1<<S+b)-1)>>S)],g=E>>>24,_=E>>>16&255,v=65535&E,!(S+g<=u);){if(0===o)break e;o--,c+=n[a++]<<u,u+=8}c>>>=S,u-=S,i.back+=S}if(c>>>=g,u-=g,i.back+=g,64&_){e.msg="invalid distance code",i.mode=Tt;break}i.offset=v,i.extra=15&_,i.mode=16203;case 16203:if(i.extra){for(T=i.extra;u<T;){if(0===o)break e;o--,c+=n[a++]<<u,u+=8}i.offset+=c&(1<<i.extra)-1,c>>>=i.extra,u-=i.extra,i.back+=i.extra}if(i.offset>i.dmax){e.msg="invalid distance too far back",i.mode=Tt;break}i.mode=16204;case 16204:if(0===d)break e;if(p=h-d,i.offset>p){if(p=i.offset-p,p>i.whave&&i.sane){e.msg="invalid distance too far back",i.mode=Tt;break}p>i.wnext?(p-=i.wnext,f=i.wsize-p):f=i.wnext-p,p>i.length&&(p=i.length),m=i.window}else m=r,f=s-i.offset,p=i.length;p>d&&(p=d),d-=p,i.length-=p;do{r[s++]=m[f++]}while(--p);0===i.length&&(i.mode=16200);break;case 16205:if(0===d)break e;r[s++]=i.length,d--,i.mode=16200;break;case 16206:if(i.wrap){for(;u<32;){if(0===o)break e;o--,c|=n[a++]<<u,u+=8}if(h-=d,e.total_out+=h,i.total+=h,4&i.wrap&&h&&(e.adler=i.check=i.flags?q(i.check,r,h,s-h):H(i.check,r,h,s-h)),h=d,4&i.wrap&&(i.flags?c:Rt(c))!==i.check){e.msg="incorrect data check",i.mode=Tt;break}c=0,u=0}i.mode=16207;case 16207:if(i.wrap&&i.flags){for(;u<32;){if(0===o)break e;o--,c+=n[a++]<<u,u+=8}if(4&i.wrap&&c!==(4294967295&i.total)){e.msg="incorrect length check",i.mode=Tt;break}c=0,u=0}i.mode=16208;case 16208:y=bt;break e;case Tt:y=yt;break e;case 16210:return Et;case 16211:default:return Ct}return e.next_out=s,e.avail_out=d,e.next_in=a,e.avail_in=o,i.hold=c,i.bits=u,(i.wsize||h!==e.avail_out&&i.mode<Tt&&(i.mode<16206||t!==gt))&&Wt(e,e.output,e.next_out,h-e.avail_out),l-=e.avail_in,h-=e.avail_out,e.total_in+=l,e.total_out+=h,i.total+=h,4&i.wrap&&h&&(e.adler=i.check=i.flags?q(i.check,r,h,e.next_out-h):H(i.check,r,h,e.next_out-h)),e.data_type=i.bits+(i.last?64:0)+(16191===i.mode?128:0)+(16199===i.mode||16194===i.mode?256:0),(0===l&&0===h||t===gt)&&y===St&&(y=wt),y},inflateEnd:e=>{if(At(e))return Ct;let t=e.state;return t.window&&(t.window=null),e.state=null,St},inflateGetHeader:(e,t)=>{if(At(e))return Ct;const i=e.state;return 0==(2&i.wrap)?Ct:(i.head=t,t.done=!1,St)},inflateSetDictionary:(e,t)=>{const i=t.length;let n,r,a;return At(e)?Ct:(n=e.state,0!==n.wrap&&16190!==n.mode?Ct:16190===n.mode&&(r=1,r=H(r,t,i,0),r!==n.check)?yt:(a=Wt(e,t,i,i),a?(n.mode=16210,Et):(n.havedict=1,St)))},inflateInfo:"pako inflate (from Nodeca project)"};var Ut=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const zt=Object.prototype.toString,{Z_NO_FLUSH:Gt,Z_FINISH:jt,Z_OK:Ht,Z_STREAM_END:Zt,Z_NEED_DICT:qt,Z_STREAM_ERROR:Yt,Z_DATA_ERROR:Kt,Z_MEM_ERROR:Jt}=K;function Qt(e){this.options=Ge({chunkSize:65536,windowBits:15,to:""},e||{});const t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&0==(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Je,this.strm.avail_out=0;let i=Ft.inflateInit2(this.strm,t.windowBits);if(i!==Ht)throw new Error(Y[i]);if(this.header=new Ut,Ft.inflateGetHeader(this.strm,this.header),t.dictionary&&("string"==typeof t.dictionary?t.dictionary=qe(t.dictionary):"[object ArrayBuffer]"===zt.call(t.dictionary)&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(i=Ft.inflateSetDictionary(this.strm,t.dictionary),i!==Ht)))throw new Error(Y[i])}function Xt(e,t){const i=new Qt(t);if(i.push(e),i.err)throw i.msg||Y[i.err];return i.result}Qt.prototype.push=function(e,t){const i=this.strm,n=this.options.chunkSize,r=this.options.dictionary;let a,s,o;if(this.ended)return!1;for(s=t===~~t?t:!0===t?jt:Gt,"[object ArrayBuffer]"===zt.call(e)?i.input=new Uint8Array(e):i.input=e,i.next_in=0,i.avail_in=i.input.length;;){for(0===i.avail_out&&(i.output=new Uint8Array(n),i.next_out=0,i.avail_out=n),a=Ft.inflate(i,s),a===qt&&r&&(a=Ft.inflateSetDictionary(i,r),a===Ht?a=Ft.inflate(i,s):a===Kt&&(a=qt));i.avail_in>0&&a===Zt&&i.state.wrap>0&&0!==e[i.next_in];)Ft.inflateReset(i),a=Ft.inflate(i,s);switch(a){case Yt:case Kt:case qt:case Jt:return this.onEnd(a),this.ended=!0,!1}if(o=i.avail_out,i.next_out&&(0===i.avail_out||a===Zt))if("string"===this.options.to){let e=Ke(i.output,i.next_out),t=i.next_out-e,r=Ye(i.output,e);i.next_out=t,i.avail_out=n-t,t&&i.output.set(i.output.subarray(e,e+t),0),this.onData(r)}else this.onData(i.output.length===i.next_out?i.output:i.output.subarray(0,i.next_out));if(a!==Ht||0!==o){if(a===Zt)return a=Ft.inflateEnd(this.strm),this.onEnd(a),this.ended=!0,!0;if(0===i.avail_in)break}}return!0},Qt.prototype.onData=function(e){this.chunks.push(e)},Qt.prototype.onEnd=function(e){e===Ht&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=je(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var $t={Inflate:Qt,inflate:Xt,inflateRaw:function(e,t){return(t=t||{}).raw=!0,Xt(e,t)},ungzip:Xt,constants:K};const{Deflate:ei,deflate:ti,deflateRaw:ii,gzip:ni}=ct,{Inflate:ri,inflate:ai,inflateRaw:si,ungzip:oi}=$t;var di,ci,ui=ni,li=oi,hi={extend:function(e,t,i){if(!(arguments.length<2)&&e&&t)for(var n in t)(!i||i&&!Object.prototype.hasOwnProperty.call(e,n))&&(e[n]=t[n])},getNodeId:function(e){return 4294966272&e},getMUserId:function(e,t){return/video/i.test(e)?-4&t|l.VIDEO_USERID_OFFSET:/audio/i.test(e)?-4&t|l.AUDIO_USERID_OFFSET:-4&t|l.SHARE_USERID_OFFSET},getResolutionIndex:function(e){switch(e){case 90:return 0;case 180:return 1;case 360:return 2;case 720:return 3;case 1080:return 4;case 2160:return 5;default:return-1}},stopMediaStreams:function(e){e&&(Array.isArray(e)?e.forEach((function(e){hi.stopMediaStream(e)})):hi.stopMediaStream(e))},stopMediaStream:function(e){null!=e&&e.getTracks&&!e.isOriginal&&e.getTracks().forEach((function(e){e.stop()}))},supportApplyConstraint:function(){return!u.firefox&&(!u.safari||parseInt(u.version)>=17)},compress:function(e,t){var i=(new TextEncoder).encode(e);if(window.CompressionStream){var n=new CompressionStream(t),r=n.writable.getWriter();return r.write(i),r.close(),new Response(n.readable).arrayBuffer()}return ui(i).buffer},decompress:function(e,t){if(window.DecompressionStream){var i=new DecompressionStream(t),n=i.writable.getWriter();return n.write(e),n.close(),new Response(i.readable).arrayBuffer().then((function(e){return(new TextDecoder).decode(e)}))}return(new TextDecoder).decode(li(e).buffer)},arrayBufferToBase64:function(e){for(var t="",i=new Uint8Array(e),n=0;n<i.byteLength;n++)t+=String.fromCharCode(i[n]);return btoa(t)},base64ToArrayBuffer:function(e){for(var t=atob(e),i=new Uint8Array(t.length),n=0;n<i.length;n++)i[n]=t.charCodeAt(n);return i.buffer},encodeString:(ci=a(n().mark((function e(t,i){var r;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=i,e.next=e.t0===l.TEXT_ENCODING.GZIP_BASE64?3:e.t0===l.TEXT_ENCODING.PLAIN?7:8;break;case 3:return e.next=5,hi.compress(t,"gzip");case 5:return r=e.sent,e.abrupt("return",hi.arrayBufferToBase64(r));case 7:return e.abrupt("return",t);case 8:return e.abrupt("return",null);case 9:case"end":return e.stop()}}),e)}))),function(e,t){return ci.apply(this,arguments)}),decodeString:(di=a(n().mark((function e(t,i){var r;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=i,e.next=e.t0===l.TEXT_ENCODING.GZIP_BASE64?3:e.t0===l.TEXT_ENCODING.PLAIN?5:6;break;case 3:return r=hi.base64ToArrayBuffer(t),e.abrupt("return",hi.decompress(r,"gzip"));case 5:return e.abrupt("return",t);case 6:return e.abrupt("return",null);case 7:case"end":return e.stop()}}),e)}))),function(e,t){return di.apply(this,arguments)}),compareArrays:function(e,t){return e.length===t.length&&e.every((function(e,i){return e===t[i]}))},getReceiverByMid:function(e,t){var i;return null==(i=e.getTransceivers().find((function(e){return e.mid===t})))?void 0:i.receiver},end:function(){},isDebug:function(){return!1}},pi={NOTIFY_SDK_JOIN_RWG_SUCCESS:"NOTIFY_SDK_JOIN_RWG_SUCCESS",NOTIFY_SDK_JOIN_RWG_FAILURE:"NOTIFY_SDK_JOIN_RWG_FAILURE",VIDEO_STREAMS:"VIDEO_STREAMS",WMSC_MESSAGE_FROM_RWG:"WMSC_MESSAGE_FROM_RWG",NOTIFY_WMSC_VIDEO_TAG_MAPPING:"NOTIFY_WMSC_VIDEO_TAG_MAPPING",NOTIFY_SDK_SUBSCRIBE_VIDEO:"NOTIFY_SDK_SUBSCRIBE_VIDEO",NOTIFY_SDK_UNSUBSCRIBE_VIDEO:"NOTIFY_SDK_UNSUBSCRIBE_VIDEO",NOTIFY_SDK_ACTIVE_VIDEO_INDICATION:"NOTIFY_SDK_ACTIVE_VIDEO_INDICATION",UPDATE_WMSC_PARAMS:"UPDATE_WMSC_PARAMS"},fi={ERROR:"ERROR",WMSC_MESSAGE_TO_RWG_BY_SDK:"WMSC_MESSAGE_TO_RWG_BY_SDK",WMSC_MAPPING_STREAMID_AND_MID:"WMSC_MAPPING_STREAMID_AND_MID",GLOBAL_TRACE:"GLOBAL_TRACE",MONITOR:"MONITOR",ADD_MONITOR:"ADD_MONITOR",SDP_NEGOTIATION_FAIL:"SDP_NEGOTIATION_FAIL",CREATE_VIDEO_STREAMS_SUCCESS:"CREATE_VIDEO_STREAMS_SUCCESS",CREATE_VIDEO_STREAMS_FAIL:"CREATE_VIDEO_STREAMS_FAIL",V_RECEV_PC_CONNECTED:"V_RECEV_PC_CONNECTED",V_SEND_PC_CONNECTED:"V_SEND_PC_CONNECTED",VIDEO_SOURCE_UPDATED:"VIDEO_SOURCE_UPDATED",VIDEO_TAG_MAPPED:"VIDEO_TAG_MAPPED",VIDEO_QOS_DATA:"VIDEO_QOS_DATA"},mi=new(function(){function e(){this.setTrace()}var t=e.prototype;return t.setTrace=function(e,t){var i=this;t&&(t.log||t.info)&&t.error&&t.warn?(this.log=t.log||t.info,this.info=t.info||t.log,this.debug=t.debug||t.log,this.verbose=this._verbose,this.error=t.error,this.warn=t.warn):(this.verbose=this._verbose.bind(this),this.log=this._log.bind(this),this.info=this._info.bind(this),this.debug=this._debug.bind(this),this.error=this._error.bind(this),this.warn=this._warn.bind(this)),this.level=e||l.TRACE_LEVEL_INFO,this.level=this<l.TRACE_LEVEL_ERROR?l.TRACE_LEVEL_ERROR:this.level,this.level=this>l.TRACE_LEVEL_VERBOSE?l.TRACE_LEVEL_VERBOSE:this.level,this.getLevel=function(){return i.level},this._trace=function(e,t){var i,n,r,a,s;if(hi.isDebug())switch(e){case"log":(i=console).log.apply(i,t);break;case"debug":(n=console).debug.apply(n,t);break;case"info":(r=console).info.apply(r,t);break;case"warn":(a=console).warn.apply(a,t);break;case"error":(s=console).error.apply(s,t)}}},t.setTelemetry=function(e){this._telemetry="function"==typeof e?e:null},t.monitorLog=function(e){this._telemetry&&this._telemetry({type:fi.MONITOR,data:e})},t.globalTrace=function(e){this._telemetry&&this._telemetry({type:fi.GLOBAL_TRACE,data:e})},t.addMonitorLog=function(e){this._telemetry&&this._telemetry({type:fi.ADD_MONITOR,data:e})},t._verbose=function(){if(this.level>=l.TRACE_LEVEL_VERBOSE){var e=Array.prototype.slice.call(arguments);return e.unshift("[VERBOSE]"),this._trace("log",e),!0}return!1},t._debug=function(){return this.level>=l.TRACE_LEVEL_DEBUG&&(this._trace("debug",arguments),!0)},t._log=function(){return this.level>=l.TRACE_LEVEL_INFO&&(this._trace("log",arguments),!0)},t._info=function(){return this.level>=l.TRACE_LEVEL_INFO&&(this._trace("info",arguments),!0)},t._warn=function(){return this.level>=l.TRACE_LEVEL_WARN&&(this._trace("warn",arguments),!0)},t._error=function(){return this.level>=l.TRACE_LEVEL_ERROR&&(this._trace("error",arguments),!0)},e}()),gi={},_i={CMD_BIT_STREAM_RECORD:1,CMD_BIT_STREAM_LOAD:2,SDP_OFFER:1,SDP_ANSWER:2,SDP_OK:3,SDP_BYE:4,STREAM_MAPPING:5,KEYFRAME_REQ:6,CMD:110,CMD_PARAM:{CMD_NONE:0,CMD_BIT_STREAM_RECORD:1,CMD_BIT_STREAM_LOAD:2,STREAM_CONGEST_CTL:3,STREAM_CONGEST_REPORT:4},JOIN_CONF:200,JOIN_CONF_ACK:712,DROP_USER:201,CLOSE_CONF:202,ROSTER_REPORT:203,CAM_INDICATOR:204,SUBSCRIBE:205,SUBSCRIBE_LIST:206,KEEPALIVE:207,MEDIA_NEGOTIATION_FROM_RWG:4096,MEDIA_ACTION_FROM_RWG:4097,JOIN_CONF_SUCCESS:4098,JOIN_SESSION_SUCCESS:4099,ROSTER_REPORT_UPDATE:4100,ACTIVE_VIDEO:4101,ACTIVE_VIDEO_SOURCE:4102,DIRECT_MESSAGE_TO_RWG:1024,CAM_STATE_IND:1025,CAM_REQ:1026,VIDEO_SUBSCRIBE_REQ:1027,MEDIA_NEGOTIATION_TO_RWG:1028,MEDIA_ACTION_TO_RWG:1029,WS_WEBRTC_MEDIA_NEGOTIATION:32769,WS_WEBRTC_MEDIA_ACTION:32770,MSGTYPE_END:65536},vi=1;gi.joinConf=function(e,t,i,n){return{type:_i.JOIN_CONF,confID:e,sessionID:t,username:i,olduserID:n}},gi.joinConfAck=function(){return{type:_i.JOIN_CONF_ACK,confID:"",sessionID:0,userID:0}},gi.closeConf=function(e,t,i){return{type:_i.CLOSE_CONF,confID:e,sessionID:t,userID:i}},gi.dropUser=function(e,t,i){return{type:_i.DROP_USER,confID:e,sessionID:t,userID:i}},gi.rosterReport=function(e){return{type:_i.ROSTER_REPORT_UPDATE,confID:"",sessionID:0,userID:0,users:e}},gi.camIndicator=function(e,t,i,n){return{type:_i.CAM_INDICATOR,confID:e,sessionID:t,userID:i,camOn:n}},gi.subscribe=function(e,t,i,n,r){return{type:_i.SUBSCRIBE,confID:e,sessionID:t,userID:i,srcUserID:n,videoSize:r}},gi.subscribeList=function(e,t,i,n,r,a){return{type:_i.SUBSCRIBE_LIST,confID:"",sessionID:0,userID:0,activeSpeaker:n,prevActiveSpeaker:r,subUsers:a}},gi.streamMapping=function(e,t,i,n,r,a,s){return{type:_i.STREAM_MAPPING,confID:e,sessionID:t,userID:i,peerID:n,streamID:r?(-4&r)+l.VIDEO_USERID_OFFSET:0,mID:a,videoSize:s}},gi.offerSdp=function(){var e=a(n().mark((function e(t,i,r,a,s){var d,c,u;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return d=l.TEXT_ENCODING.GZIP_BASE64,c={type:_i.SDP_OFFER,confID:t,sessionID:i,userID:r,peerID:a},e.prev=2,e.next=5,hi.encodeString(s,l.TEXT_ENCODING.GZIP_BASE64);case 5:return u=e.sent,e.abrupt("return",o({sdp:u,sdpEncoding:d},c));case 9:return e.prev=9,e.t0=e.catch(2),mi.globalTrace({logLevel:"error",log:"WMSC compress sdp failed",errorEvent:e.t0}),e.abrupt("return",o({sdp:s},c));case 13:case"end":return e.stop()}}),e,null,[[2,9]])})));return function(t,i,n,r,a){return e.apply(this,arguments)}}(),gi.answerSdp=function(e,t,i,n,r){return{type:_i.SDP_ANSWER,confID:e,sessionID:t,userID:i,peerID:n,sdp:r}},gi.okSdp=function(e,t,i,n,r){return{type:_i.SDP_OK,confID:e,sessionID:t,userID:i,peerID:n,sdp:r}},gi.byeSdp=function(e,t,i,n,r){return{type:_i.SDP_BYE,confID:e,sessionID:t,userID:i,peerID:n,sdp:r}},gi.keepalive=function(e,t,i,n){return{type:_i.KEEPALIVE,confID:e,sessionID:t,userID:i,peerID:-1,seqNo:n}},gi.bitstreamRecord=function(e,t,i,n,r,a){return{type:_i.CMD,confID:e,sessionID:t,userID:i,peerID:n,cmd:r,filename:a}},gi.congestReportCmdMsg=function(e,t,i,n,r){return{type:_i.CMD,confID:e,sessionID:t||vi,userID:i,peerID:-1,cmd:n,cmdParam:r}};var Si=function(){function e(){}return e.splitSections=function(e){return e.split("\r\nm=").map((function(e,t){return t>0?"m="+e:e}))},e.splitLines=function(e){return e.split("\r\n")},e.parseVersionLine=function(e){return parseInt(e.substring(2),10)},e.writeVersionLine=function(e){return"v="+e},e.parseOriginLine=function(e){var t=e.substring(2).split(" "),i=t[0],n=t[1],r=t[2],a=t[3],s=t[4],o=t[5];return{userName:i,sessionId:n,sessionVersion:parseInt(r,10),netType:a,addressType:s,address:o}},e.writeOriginLine=function(e){return"o="+e.userName+" "+e.sessionId+" "+e.sessionVersion+" "+e.netType+" "+e.addressType+" "+e.address},e.parseSessionNameLine=function(e){return e.substring(2)},e.writeSessionNameLine=function(e){return"s="+e},e.parseInformationLine=function(e){return e.substring(2)},e.writeInformationLine=function(e){return"i="+e},e.parseConnectionLine=function(e){var t=e.substring(2).split(" ");return{netType:t[0],addressType:t[1],address:t[2]}},e.writeConnectionLine=function(e){return"c="+e.netType+" "+e.addressType+" "+e.address},e.parseBandwidthLine=function(e){return parseInt(e.substring(7),10)},e.writeBandwidthLine=function(e){return"b=TIAS:"+e},e.parseTimingLine=function(e){var t=e.substring(2).split(" "),i=t[0],n=t[1];return{startTime:parseInt(i,10),stopTime:parseInt(n,10)}},e.writeTimingLine=function(e){return"t="+e.startTime+" "+e.stopTime},e.parseRtpMapLine=function(e){var t=e.substring(9).match(/^(\d+) (.*)/),i=t[2].split("/");return{payloadType:parseInt(t[1],10),codecName:i[0],clockRate:parseInt(i[1],10),channels:i.length>=3?parseInt(i[2],10):null}},e.writeRtpMapLine=function(e){var t=e.payloadType,i=e.codecName,n=e.clockRate,r=e.channels,a="a=rtpmap:"+t+" "+i+"/"+n;return null!=r&&(a+="/"+r),a},e.parseFmtpLine=function(e){var t=e.substring(7).match(/^(\d+) (.*)/),i={payloadType:parseInt(t[1],10)};return t[2].includes("=")?i.params=new Map(t[2].split(";").map((function(e){return e.trim().split("=")}))):i.plain=t[2],i},e.writeFmtpLine=function(e){var t=e.payloadType,i=e.params,n=e.plain,r="a=fmtp:"+t+" ";return i?(i.forEach((function(e,t){null!=e&&(r+=t+"="+e+";")})),r=r.slice(0,-1)):r+=n,r},e.parseRtcpFbLine=function(e){var t=e.substring(10).match(/^(\d+) (.*)/);return{payloadType:parseInt(t[1],10),params:t[2].split(" ")}},e.writeRtcpFbLine=function(e){var t=e.payloadType,i=e.params,n="a=rtcp-fb:"+t;return i.forEach((function(e){n+=" "+e})),n},e.parseRidLine=function(e){var t=e.substring(6).match(/^(\S+) (send|recv)/);return{rid:t[1],direction:t[2]}},e.writeRidLine=function(e){return"a=rid:"+e.rid+" "+e.direction},e.parseSimulcastLine=function(e){var t=e.substring(12).match(/^(send|recv) (.*)/);return{direction:t[1],rids:t[2].split(";").map((function(e){return"~"===e[0]?{id:e.substring(1),paused:!0}:{id:e,paused:!1}}))}},e.writeSimulcastLine=function(e){var t=e.direction,i=e.rids,n="a=simulcast:"+t+" ";return i.forEach((function(e){var t=e.paused?"~"+e.id:e.id;n+=t+";"})),n.slice(0,-1)},e.parseExtensionMapLine=function(e){var t=e.substring(9).match(/^(\d+)(\/sendrecv|\/sendonly|\/recvonly|\/inactive)? (\S+)(\s\S+)?/);return{id:parseInt(t[1],10),direction:t[2]?t[2].substring(1):null,uri:t[3],attributes:t[4]?t[4].trimStart():null}},e.writeExtensionMapLine=function(e){var t=e.id,i=e.direction,n=e.uri,r=e.attributes,a="a=extmap:"+t;return null!=i&&(a+="/"+i),a+=" "+n,null!=r&&(a+=" "+r),a},e.parseMidLine=function(e){return e.substring(6)},e.writeMidLine=function(e){return"a=mid:"+e},e.writeDirectionLine=function(e){return"a="+e},e.parseMsidLine=function(e){var t=e.substring(7).split(" ");return{streamId:t[0],trackId:t[1]}},e.writeMsidLine=function(e){return"a=msid:"+e.streamId+" "+e.trackId},e.parseSsrcLine=function(e){var t=e.indexOf(" ");return{ssrc:parseInt(e.substring(7,t),10),attribute:e.substring(t+1)}},e.writeSsrcLine=function(e){return"a=ssrc:"+e.ssrc+" "+e.attribute},e.parseSsrcGroupLine=function(e){var t=e.substring(13).split(" ");return{semantics:t.shift(),ssrcs:t}},e.writeSsrcGroupLine=function(e){var t=e.semantics,i=e.ssrcs,n="a=ssrc-group:"+t;return i.forEach((function(e){n+=" "+e})),n},e.parseGroupLine=function(e){var t=e.indexOf(" ");return{semantics:e.substring(8,t),ids:e.substring(t+1).split(" ")}},e.writeGroupLine=function(e){var t=e.semantics,i=e.ids,n="a=group:"+t;return i.forEach((function(e){n+=" "+e})),n},e.writeExtMapAllowMixedLine=function(){return"a=extmap-allow-mixed"},e.writeRtcpMuxLine=function(){return"a=rtcp-mux"},e.writeRtcpReducedSizeLine=function(){return"a=rtcp-rsize"},e.parseCandidateLine=function(e){var t=e.substring(12).split(" "),i={foundation:t[0],componentId:parseInt(t[1],10),transport:t[2],priority:parseInt(t[3],10),address:t[4],port:parseInt(t[5],10),candType:t[6],type:t[7],relAddress:null,relPort:null,candExtensions:[]};return"raddr"===t[8]&&"rport"===t[10]?(i.relAddress=t[9],i.relPort=parseInt(t[11],10),i.candExtensions=t.slice(12)):i.candExtensions=t.slice(8),i},e.writeCandidateLine=function(e){var t=e.foundation,i=e.componentId,n=e.transport,r=e.priority,a=e.address,s=e.port,o=e.candType,d=e.type,c=e.relAddress,u=e.relPort,l=e.candExtensions,h="a=candidate:"+t+" "+i+" "+n+" "+r+" "+a+" "+s+" "+o+" "+d;return null!=c&&null!=u&&(h+=" raddr "+c+" rport "+u),l.length&&(h+=" "+l.join(" ")),h},e.parseSessionSection=function(e){for(var t={version:0,origin:null,sessionName:null,information:null,connection:null,bandwidth:null,timing:null,groups:[],extMapAllowMixed:null,otherLines:[]},i=this.splitLines(e),n=0;n<i.length;n++){var r=i[n];r.length&&(r.match(/^v=/)?t.version=this.parseVersionLine(r):r.match(/^o=/)?t.origin=this.parseOriginLine(r):r.match(/^s=/)?t.sessionName=this.parseSessionNameLine(r):r.match(/^i=/)?t.information=this.parseInformationLine(r):r.match(/^c=/)?t.connection=this.parseConnectionLine(r):r.match(/^b=TIAS:/)?t.bandwidth=this.parseBandwidthLine(r):r.match(/^t=/)?t.timing=this.parseTimingLine(r):r.match(/^a=group:/)?t.groups.push(this.parseGroupLine(r)):r.match(/^a=extmap-allow-mixed$/)?t.extMapAllowMixed=!0:t.otherLines.push(r))}return t},e.writeSessionSection=function(e){var t=this,i=[];return i.push(this.writeVersionLine(e.version)),null!=e.origin&&i.push(this.writeOriginLine(e.origin)),null!=e.sessionName&&i.push(this.writeSessionNameLine(e.sessionName)),null!=e.information&&i.push(this.writeInformationLine(e.information)),null!=e.connection&&i.push(this.writeConnectionLine(e.connection)),null!=e.bandwidth&&i.push(this.writeBandwidthLine(e.bandwidth)),null!=e.timing&&i.push(this.writeTimingLine(e.timing)),e.groups.forEach((function(e){i.push(t.writeGroupLine(e))})),e.extMapAllowMixed&&i.push(this.writeExtMapAllowMixedLine()),e.otherLines.length&&i.push.apply(i,e.otherLines),i.join("\r\n")+"\r\n"},e.parseMediaSection=function(e){var t=this,i={type:null,port:null,protocol:null,connection:null,bandwidth:null,mid:null,direction:null,msid:null,rtcpMux:null,rtcpReducedSize:null,codecs:[],extensionMap:new Map,rids:[],simulcast:null,ssrcs:[],ssrcGroups:[],candidates:[],otherLines:[]},n=[],r=[],a=this.splitLines(e),s=a[0].split(" ");i.type=s[0].substring(2),i.port=parseInt(s[1],10),i.protocol=s[2],i.payloadTypes=s.slice(3).map((function(e){return parseInt(e,10)}));for(var d=1;d<a.length;d++){var c,u=a[d];if(u.length)if(u.match(/^c=/))i.connection=this.parseConnectionLine(u);else if(u.match(/^b=TIAS:/))i.bandwidth=this.parseBandwidthLine(u);else if(u.match(/^a=rtpmap:/)){var l=this.parseRtpMapLine(u);i.codecs.push(o({},l,{codecParams:new Map,fmtpLines:[],rtcpFbParams:[]}))}else if(u.match(/^a=fmtp:/))n.push(u);else if(u.match(/^a=rtcp-fb:/))r.push(u);else if(u.match(/^a=rid:/))i.rids.push(this.parseRidLine(u));else if(u.match(/^a=simulcast:/))i.simulcast=this.parseSimulcastLine(u);else if(u.match(/^a=ssrc:/))i.ssrcs.push(this.parseSsrcLine(u));else if(u.match(/^a=ssrc-group:/))i.ssrcGroups.push(this.parseSsrcGroupLine(u));else if(u.match(/^a=extmap:/)){var h=this.parseExtensionMapLine(u);i.extensionMap.set(h.id,h)}else u.match(/^a=mid:/)?i.mid=this.parseMidLine(u):(c=u.match(/^a=(sendrecv|sendonly|recvonly|inactive)/))?i.direction=c[1]:u.match(/^a=msid:/)?i.msid=this.parseMsidLine(u):u.match(/^a=rtcp-mux$/)?i.rtcpMux=!0:u.match(/^a=rtcp-rsize$/)?i.rtcpReducedSize=!0:u.match(/^a=candidate:/)?i.candidates.push(this.parseCandidateLine(u)):i.otherLines.push(u)}return n.forEach((function(e){var n=t.parseFmtpLine(e),r=i.codecs.find((function(e){return e.payloadType===n.payloadType}));r&&(n.params?n.params.forEach((function(e,t){"apt"===t&&(r.associatedPayloadType=parseInt(e,10)),r.codecParams.set(t,e)})):(r.fmtpLines.push(n.plain),"red"===r.codecName&&(r.associatedPayloadType=parseInt(n.plain.split("/")[0],10))))})),r.forEach((function(e){var n=t.parseRtcpFbLine(e),r=i.codecs.find((function(e){return e.payloadType===n.payloadType}));r&&r.rtcpFbParams.push(n.params)})),i},e.writeMediaSection=function(e){var t=this,i=[],n="m="+e.type+" "+e.port+" "+e.protocol;return e.payloadTypes.forEach((function(e){n+=" "+e})),i.push(n),e.connection&&i.push(this.writeConnectionLine(e.connection)),e.bandwidth&&i.push(this.writeBandwidthLine(e.bandwidth)),e.otherLines.length&&i.push.apply(i,e.otherLines),i.push(this.writeMidLine(e.mid)),e.extensionMap.size&&e.extensionMap.forEach((function(e,n){i.push(t.writeExtensionMapLine(e))})),i.push(this.writeDirectionLine(e.direction)),e.msid&&i.push(this.writeMsidLine(e.msid)),e.rtcpMux&&i.push(this.writeRtcpMuxLine()),e.rtcpReducedSize&&i.push(this.writeRtcpReducedSizeLine()),e.codecs.forEach((function(e){var n=e.payloadType,r=e.codecName,a=e.clockRate,s=e.channels,o=e.codecParams,d=e.fmtpLines,c=e.rtcpFbParams;i.push(t.writeRtpMapLine({payloadType:n,codecName:r,clockRate:a,channels:s})),c.forEach((function(e){i.push(t.writeRtcpFbLine({payloadType:n,params:e}))})),o.size&&i.push(t.writeFmtpLine({payloadType:n,params:o})),d.forEach((function(e){i.push(t.writeFmtpLine({payloadType:n,plain:e}))}))})),e.ssrcGroups.forEach((function(e){i.push(t.writeSsrcGroupLine(e))})),e.ssrcs.forEach((function(e){i.push(t.writeSsrcLine(e))})),e.rids.forEach((function(e){i.push(t.writeRidLine(e))})),e.candidates.forEach((function(e){i.push(t.writeCandidateLine(e))})),e.simulcast&&i.push(this.writeSimulcastLine(e.simulcast)),i.join("\r\n")+"\r\n"},e.parse=function(e){var t=this,i={session:null,media:[],application:[]},n=this.splitSections(e);return i.session=this.parseSessionSection(n.shift()),n.forEach((function(e){var n=t.parseMediaSection(e);"audio"!==n.type&&"video"!==n.type||i.media.push(n),"application"===n.type&&i.application.push(n)})),i},e.write=function(e){var t=this,i=this.writeSessionSection(e.session);return e.media.forEach((function(e){i+=t.writeMediaSection(e)})),e.application.forEach((function(e){i+=t.writeMediaSection(e)})),i},e}(),bi=function(){function e(){}return e.parseSdp=function(e){return Si.parse(e)},e.writeSdp=function(e){return Si.write(e)},e.generateSsrc=function(){return Math.floor(4294967294*Math.random())+1},e.generateId=function(){return Math.random().toString(36).substring(2,12)},e.generateSessionId=function(){return Math.random().toString().substring(2,22)},e.generateUuid=function(){var e=Array.from(Array(256).keys()).map((function(e){return e.toString(16).padStart(2,"0")})),t=crypto.getRandomValues(new Uint8Array(16));return t[6]=15&t[6]|64,t[8]=63&t[8]|128,Array.from(t.entries()).map((function(t){var i=t[0],n=t[1];return[4,6,8,10].includes(i)?"-"+e[n]:e[n]})).join("")},e.getSessionBoilerplate=function(){return"v=\r\no=- "+this.generateSessionId()+" 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},e.getNtpSeconds=function(){return Math.floor((Date.now()+(Date.UTC(1970,0,1)-Date.UTC(1900,0,1)))/1e3)},e.findHeaderExtension=function(e,t){for(var i,n=c(e.extensionMap);!(i=n()).done;){var r=i.value,a=r[0];if(r[1].uri===t)return a}return-1},e.addHeaderExtension=function(e,t){if(-1!==this.findHeaderExtension(e,t.uri))return!1;var i=0;e.extensionMap.forEach((function(e,t){t>i&&(i=t)}));var n=i+1;return e.extensionMap.set(n,o({id:n},t)),!0},e.updateCodecParameters=function(e,t,i,n,r){e.media.filter((function(e){return e.type===t&&e.direction===i})).forEach((function(e){e.codecs.filter((function(e){return e.codecName===n})).forEach((function(e){r.forEach((function(t,i){e.codecParams.set(i,t)}))}))}))},e.filterCodecs=function(e,t){e.media.forEach((function(e){var i=[];e.codecs.forEach((function(e){t.includes(e.codecName)&&i.push(e.payloadType)})),e.codecs.forEach((function(e){i.includes(e.associatedPayloadType)&&i.push(e.payloadType)})),e.payloadTypes=e.payloadTypes.filter((function(e){return i.includes(e)})),e.codecs=e.codecs.filter((function(e){return i.includes(e.payloadType)}))})),e.media=e.media.filter((function(e){return e.payloadTypes.length}))},e}(),Ii=l.MIN_SEND_PC_ID,Ci=new(function(){function e(e){this.sendBR=Array.from(l.WMSC_BR.SEND),this.frameRate=[30,30,30,30,30],this.codecProfile="constrained",this.recvPCInfo=null,this.sendPCsInfo={},this.apiCallBack=null,this.userId=""}var t=e.prototype;return t.setUserId=function(e){this.userId=e},t.getPCEntry=function(e){var t,i=(null==(t=this.recvPCInfo)?void 0:t.peerId)===e?this.recvPCInfo:null;return i||this.sendPCsInfo&&this.sendPCsInfo[e]},t.getSendBR=function(){return this.sendBR},t.getSendPCsInfo=function(){return this.sendPCsInfo},t.setupCallBack=function(e){this.apiCallBack=e},t.updateSenderParam=function(e){mi.log("WMSCMediaMgr.updateSenderParam, set encoder parameters",JSON.stringify(e));var t=e.bitrate,i=e.videoSize;i>l.RES_2160p||i<0||(t!==this.sendBR[i]&&(this.sendBR[i]=+t,this.updateBitrate(i+Ii)),e.framerate!==this.frameRate[i]&&(this.frameRate[i]=+e.framerate,this.updateFramerate(i+Ii)),e.profile!==this.codecProfile&&(this.codecProfile=e.profile))},t.updateBitrate=function(e){var t=this.sendPCsInfo&&this.sendPCsInfo[e];t&&t.status===l.PC_STATE_CONNECTED&&function(){var i=a(n().mark((function i(){var r,a,s;return n().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return r=t.pc.getSenders(),(a=r[0].getParameters()).encodings[0].maxBitrate=this.sendBR[e-Ii],s=this.scales[e],u.isMultiGetMedia()||1===s||(a.encodings[0].scaleResolutionDownBy=1*s),i.next=7,r[0].setParameters(a);case 7:case"end":return i.stop()}}),i,this)})));return function(){return i.apply(this,arguments)}}().call(this)},t.updateFramerate=function(e){var t=this.sendPCsInfo&&this.sendPCsInfo[e];t&&t.status===l.PC_STATE_CONNECTED&&function(){var i=a(n().mark((function i(){var r,a,s,o;return n().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:if(r=t.pc.getSenders(),!u.useConstraints({framerate:!0})||!r[0].track){i.next=15;break}return(a=r[0].track.getConstraints()).frameRate=this.frameRate[e-Ii],i.next=7,r[0].track.applyConstraints(a);case 7:return(s=r[0].getParameters()).encodings[0].maxBitrate=this.sendBR[e-Ii],s.encodings[0].degradationPreference="maintain-resolution",s.encodings[0].active=!!s.encodings[0].maxBitrate,i.next=13,r[0].setParameters(s);case 13:i.next=22;break;case 15:return(o=r[0].getParameters()).encodings[0].maxFramerate=this.frameRate[e-Ii],o.encodings[0].maxBitrate=this.sendBR[e-Ii],o.encodings[0].degradationPreference="maintain-resolution",o.encodings[0].active=!!o.encodings[0].maxBitrate,i.next=22,r[0].setParameters(o);case 22:case"end":return i.stop()}}),i,this)})));return function(){return i.apply(this,arguments)}}().call(this)},t.getNewPeerConnection=function(e,t,i,n,r){var a=this;this.sendMonitorLog("Start creating new PC, peerId: "+t);var s={serverAddr:e,mediaType:i,direction:n,peerId:t,size:r},o=n===l.TRANSCEIVER_DIRECTION.RECV_ONLY,d=null,c=this.getPCEntry(t);if(o){if(c)return mi.error("WMSCMediaMgr.getNewPeerConnection, receiving PeerConnection has been created. Close it first"),!1;d=new RTCPeerConnection,this.sendMonitorLog("New PC created, peerId: "+t),this.recvPCInfo={config:s,peerId:t,pc:d,size:r,status:l.PC_STATE_IDLE};for(var u=0;u<r;u++)d.addTransceiver(i,{direction:n})}else{if(c)return mi.error("WMSCMediaMgr.getNewPeerConnection, sending PeerConnection peerId "+t+" has been created. Close it first"),!1;this.sendPCsInfo=this.sendPCsInfo||{},d=new RTCPeerConnection,this.sendMonitorLog("New PC created, peerId: "+t),this.sendPCsInfo[t]={config:s,pc:d,peerId:t,status:l.PC_STATE_IDLE}}return d.onicecandidate=function(e){},d.ontrack=this.getRemoteStream.bind(this,t),d.onconnectionstatechange=this.onconnectionstatechange.bind(this,t),d.onsignalingstatechange=this.onsignalingstatechange.bind(this,t),d.oniceconnectionstatechange=function(e){var i=e.target.iceConnectionState;mi.log("WMSCMediaMgr.oniceconnectionstatechange peerId= "+t+" state = "+i),mi.addMonitorLog("WMSCICESTATE-"+t+"-"+i),"failed"===i&&mi.globalTrace({logLevel:"error",log:"WMSC ICE STATE ERROR: "+t+"-"+i})},d.onnegotiationneeded=function(e){mi.log("WMSCMediaMgr.onnegotiationneeded ev = "+JSON.stringify(e)),a.sendMonitorLog("Onnegotiationneeded, peerId: "+t)},d.onicegatheringstatechange=function(e){var i=e.target.iceGatheringState;mi.addMonitorLog("WMSCCANDGA-"+t+"-"+i)},d.onicecandidateerror=function(e){var i=e.errorCode,n=e.errorText,r=e.url;mi.addMonitorLog("WMSCCANDE-"+t+"-"+i),mi.globalTrace({logLevel:"error",log:"WMSC CANDIDATE ERROR: "+i+"-"+n+"-"+r})},d},t.onconnectionstatechange=function(e,t){var i=t.target.connectionState;switch(mi.log("WSMC.onconnectionstatechange, peerId: "+e+" state: "+i),mi.addMonitorLog("WCL_WMSC_EVENT_PEER_STATUS,"+this.userId+","+e+","+i),i){case"connected":this._handlePCConnected(e);break;case"disconnected":this.apiCallBack(e,l.MediaMgrMsgType.PCSTATUSCHANGE,"disconnected");break;case"failed":this._handlePCFailed(e),mi.globalTrace({logLevel:"error",log:"WMSC peer connection failed: "+e})}},t._handlePCConnected=function(e){if(e===this.recvPCInfo.peerId)this.recvPCInfo.status=l.PC_STATE_CONNECTED;else{var t=this.sendPCsInfo&&this.sendPCsInfo[e];t&&(t.status=l.PC_STATE_CONNECTED),this.updateBitrate(e)}this.apiCallBack(e,l.MediaMgrMsgType.PCSTATUSCHANGE,"connected")},t._handlePCFailed=function(e){(e===this.recvPCInfo.peerId?this.recvPCInfo:this.sendPCsInfo[e]).status=l.PC_STATE_IDLE,this.apiCallBack(e,l.MediaMgrMsgType.PCSTATUSCHANGE,"failed")},t.onsignalingstatechange=function(e,t){var i=t.target.signalingState;mi.log("WMSCMediaMgr.onsignalingstatechange ev = "+e+" "+i),mi.addMonitorLog("WMSCSIG-"+e+"-"+i)},t.getRemoteStream=function(e,t){this.apiCallBack&&this.apiCallBack(e,l.MediaMgrMsgType.STREAM,t)},t.createVideoArray=function(e,t){return 1===t.length?this._createVideoArrayByClone(e,t[0].stream):this._createVideoArray(e,t)},t.addVideo2PC=function(e,t,i,n){var r=this.getPCEntry(e);if(!r)return mi.error("WMSCMediaMgr.addVideo2PC sender PC peerId = "+e+" is not created yet"),!1;var a=hi.supportApplyConstraint();this.scales=this.scales||[],this.scales[e]=n;var s=t[i];if(!s)return mi.error("WMSCMediaMgr.addVideo2PC could not find vStream for sIndex: "+i),this.sendMonitorLog("AddVideo2PC could not find vStream for sIndex: "+i),!1;var o=s.getVideoTracks()[0];mi.log("WMSCMediaMgr.addVideo2PC, video heigth= "+o.getSettings().height),r.pc.addTrack(o);var d=r.pc.getTransceivers()[0];if(d.direction="sendonly",!a){var c=d.sender,u=c.getParameters();u.encodings[0].scaleResolutionDownBy=n,c.setParameters(u)}return!0},t.startNegotiation=function(e,t){var i=this.getPCEntry(e);if(!i)return mi.error("WMSCMediaMgr.startNegotiation, no pc for peerId: "+e),!1;var r=this;function s(){return(s=a(n().mark((function a(){var s,o;return n().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,i.pc.createOffer(t);case 3:return s=n.sent,e===r.recvPCInfo.peerId&&(o=bi.parseSdp(s.sdp),bi.updateCodecParameters(o,"video","recvonly","H264",new Map([["sps-pps-idr-in-keyframe",1]])),s.sdp=bi.writeSdp(o)),n.next=7,i.pc.setLocalDescription(s);case 7:i.status=l.PC_STATE_CONNECTING,r.apiCallBack(e,l.MediaMgrMsgType.SDP,{description:i.pc.localDescription}),n.next=18;break;case 11:return n.prev=11,n.t0=n.catch(0),mi.error(n.t0),mi.globalTrace({logLevel:"error",log:"WMSC createOffer or setLocalDescription failed: peerId-"+e+", error: "+n.t0.message}),mi.addMonitorLog("WMSCOFSLDF-"+e),r.apiCallBack(e,l.MediaMgrMsgType.SDP,{description:null}),n.abrupt("return",!1);case 18:case"end":return n.stop()}}),a,null,[[0,11]])})))).apply(this,arguments)}return this.sendMonitorLog("Start Negotiation, peerId: "+e),function(){s.apply(this,arguments)}(),!0},t.onServerMsg=function(e,t){var i=this.getPCEntry(e);return i?(t.type===_i.SDP_ANSWER&&(this.updateAnswerSdp(e,t),i.pc.setRemoteDescription({type:"answer",sdp:t.sdp}).catch((function(t){mi.globalTrace({logLevel:"error",log:"WMSC setRemoteDescription failed: "+e+"-"+t.message}),mi.addMonitorLog("WMSCSRDF-"+e)}))),!0):(mi.error("WMSCMediaMgr.onServerMsg peerID: "+e+" PC not created yet"),!1)},t.updateAnswerSdp=function(e,t){if(!/a=sendonly/.test(t.sdp)&&!/constrained/.test(this.codecProfile)){var i=/baseline/.test(this.codecProfile)?"profile-level-id=42001f":u.getHighProfile();t.sdp=t.sdp.replace("profile-level-id=42e01f",i)}},t.onMCCReq=function(e){var t,i=this;e.cmdParam=e.cmdParam&&JSON.parse(e.cmdParam),mi.log("WMSCMediaMgr.onMCCReq: data = "+JSON.stringify(e));var n=null==(t=e.cmdParam)?void 0:t.req;if(!n||!n.length)return!0;n.forEach((function(e){e.action===l.MCCREQ.CHANGE_FRAMERATE?(i.frameRate[e.videoSize]=e.framerate,i.updateFramerate(e.videoSize+l.MIN_SEND_PC_ID)):e.action!==l.MCCREQ.CHANGE_BITRATE&&e.action!==l.MCCREQ.CHANGE||(i.sendBR[e.videoSize]=e.bitrate,i.frameRate[e.videoSize]=e.framerate,i.updateFramerate(e.videoSize+l.MIN_SEND_PC_ID))}))},t.stopSendingVideo=function(){for(var e in this.sendPCsInfo){var t,i=this.sendPCsInfo[e];try{var n=i.pc.getSenders()[0];i.pc.removeTrack(n)}catch(e){mi.error("WMSCMediaMgr.stopSendingVideo could not remove track from PC, "+JSON.stringify(e))}null==(t=i.pc)||t.close()}this.sendPCsInfo={}},t.closePeerConnection=function(e){var t;if(this.sendMonitorLog("Close PeerConnection, peerId: "+e),e===(null==(t=this.recvPCInfo)?void 0:t.peerId)){var i;null==(i=this.recvPCInfo.pc)||i.close(),this.recvPCInfo.pc=null,this.recvPCInfo=null}else{var n;if(!this.sendPCsInfo)return;var r=this.sendPCsInfo[e];null==r||null==(n=r.pc)||n.close(),r&&delete this.sendPCsInfo[e],Object.keys(this.sendPCsInfo).length||(this.sendPCsInfo=null)}},t._createVideoArrayByClone=function(){var e=a(n().mark((function e(t,i){var r,a,s,o,d,c,u,h,p,f;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:mi.log("WMSCMediaMgr._createVideoArrayByClone, size: "+t),r=t,a=[],s=0;case 4:if(!(s<=r)){e.next=17;break}if(o=i.clone(),d=hi.supportApplyConstraint(),c=o.getVideoTracks()[0],!d){e.next=11;break}return e.next=11,c.applyConstraints(l.VIDEO_CONSTRAINTS[s]);case 11:null!=(u=this.sendPCsInfo?this.sendPCsInfo[s+Ii]:null)&&u.status&&(h=u.pc.getSenders()[0],p=u.peerId,mi.log("WMSCMediaMgr._createVideoArrayByClone, replace previous track for peerId: "+p),this.sendMonitorLog("replace video track for peerId: "+p),h.replaceTrack(c),d||((f=h.getParameters()).encodings[0].scaleResolutionDownBy=this.scales[p]||1,h.setParameters(f))),a.push(o);case 14:s++,e.next=4;break;case 17:return e.abrupt("return",{streams:a});case 18:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}(),t._createVideoArray=function(){var e=a(n().mark((function e(t,i){var r;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=[],i.forEach((function(e){r.push(e.stream)})),e.abrupt("return",Promise.resolve({streams:r}));case 3:case"end":return e.stop()}}),e)})));return function(t,i){return e.apply(this,arguments)}}(),t.sendMonitorLog=function(e){mi.monitorLog("WCL_WMSC_EVENT, "+e)},t.addMonitorLog=function(e){mi.addMonitorLog("WCL_WMSC_EVENT, "+e)},e}()),yi=new MediaStream,Ei=function(){function e(e){var t=this;this.mIdUsedStatus={},null==e||e.forEach((function(e){t.mIdUsedStatus[e]={userId:null,group:null,used:!1,videoStream:null,videoSize:null}})),this.user2VideoDom=new Map,this.hasPausedVideo=!1}var t=e.prototype;return t.getNewMId=function(e,t){void 0===t&&(t=null);var i=this.getMId(e,t);if(i)return i;for(var n in this.mIdUsedStatus)if(!this.mIdUsedStatus[n].used)return this.mIdUsedStatus[n].userId=e,this.mIdUsedStatus[n].group=t,this.mIdUsedStatus[n].used=!0,n;return""},t.releaseMId=function(e){var t=this.mIdUsedStatus[e];if(t){t.group=null;var i=this.user2VideoDom.get(t.userId);i&&(i.srcObject=yi),t.userId=null,t.used=!1,t.videoSize=null}},t.getMId=function(e,t){for(var i in void 0===t&&(t=null),this.mIdUsedStatus)if(this.mIdUsedStatus[i].userId===e&&this.mIdUsedStatus[i].group===t)return i;return""},t.getUserId=function(e){return{userId:this.mIdUsedStatus[e].userId,group:this.mIdUsedStatus[e].group}},t.getVideoTag=function(e){var t=this.mIdUsedStatus[e].userId;return t?this.user2VideoDom.get(t):null},t.saveVideoTag=function(e,t){var i=this.user2VideoDom.get(e);if(i){if(i===t)return;i.srcObject=yi}for(var n in this.user2VideoDom.set(e,t),this.mIdUsedStatus)this.mIdUsedStatus[n].userId===e&&(t.srcObject=this.mIdUsedStatus[n].videoStream)},t.removeVideoTag=function(e,t){var i=this.user2VideoDom.get(e);i===t&&(i.srcObject=yi,this.user2VideoDom.delete(e))},t.updateUserId=function(e,t){var i=this.mIdUsedStatus[e];i&&(i.userId=t)},t.updateVideoElement=function(e){var t=this;if(this.mIdUsedStatus[e]){var i=this.mIdUsedStatus[e].userId,n=this.user2VideoDom.get(i);if(!n)return;n&&(n.srcObject=this.mIdUsedStatus[e].videoStream,n.onpause=function(){mi.addMonitorLog("wmsc video tag listen paused, userId: "+i+", hidden: "+document.hidden+", visibilityState: "+document.visibilityState),t.hasPausedVideo=!0})}},t.updateStream=function(e,t){this.mIdUsedStatus[e]&&(this.mIdUsedStatus[e].videoStream=t)},t.setVideoSize=function(e,t){this.mIdUsedStatus[e].videoSize=t},t.getUserIdByElem=function(e){var t="";return this.user2VideoDom.forEach((function(i,n){e===i&&(t=n)})),t},t.getHasPausedVideo=function(){return this.hasPausedVideo||Array.from(this.user2VideoDom.values()).some((function(e){return e.paused}))},t.playAllUsedVideoTag=function(){var e=this,t=Array.from(this.user2VideoDom.values()).map((function(t){if("visible"===document.visibilityState&&t.paused){var i;if(null==t||!t.srcObject||null==t||null==(i=t.srcObject)||!i.active){var n,r=e.getUserIdByElem(t);return mi.addMonitorLog("wmsc video tag can not play, userId: "+r+", srcObject:"+!(null==t||!t.srcObject)+",srcObject active:"+(null==t||null==(n=t.srcObject)?void 0:n.active)),Promise.reject(r)}return t.play().then((function(){return Promise.resolve()})).catch((function(i){var n=e.getUserIdByElem(t);return mi.addMonitorLog("wmsc video tag play fail, userId: "+n+", errorName:"+i.name+", errorMessage:"+i.message),Promise.reject(n)}))}return null})).filter((function(e){return!!e}));return t.length<=0?Promise.resolve():Promise.all(t).then((function(){return e.hasPausedVideo=!1,Promise.resolve()})).catch((function(t){return e.hasPausedVideo=!0,Promise.reject(t)}))},e}(),wi=new(function(){function e(){this.confId=null,this.nodeId=null,this.maxRecvVideoNum=25,this.recvPeerId=0,this.sendPeerId=1,this.simulcastEnabled=!0,this.hdVideoEnabled=!1,this.videoSettings=null}var t=e.prototype;return t.setConfig=function(e){var t=e.confId,i=e.nodeId,n=e.simulcastEnabled,r=e.maxVideoReceiveNum,a=e.HDVideo,s=e.videoSettings,o=e.qosOptions;void 0!==t&&(this.confId=t),void 0!==i&&(this.nodeId=i),void 0!==n&&(this.simulcastEnabled=n),void 0!==r&&(this.maxRecvVideoNum=r),void 0!==a&&(this.hdVideoEnabled=a),void 0!==s&&(this.videoSettings=s),void 0!==o&&(this.qosOptions=o)},t.getConfig=function(){return{confId:this.confId,nodeId:this.nodeId,simulcastEnabled:this.simulcastEnabled,maxRecvVideoNum:this.maxRecvVideoNum,hdVideoEnabled:this.hdVideoEnabled,videoSettings:this.videoSettings,qosOptions:this.qosOptions}},e}()),Mi=new(function(){function e(){}var t=e.prototype;return t.mungeLocalOfferForSend=function(e,t){var i=bi.parseSdp(e);bi.filterCodecs(i,["H264"]);var n=i.media.find((function(e){return"video"===e.type&&"sendonly"===e.direction}));if(!n)throw new Error("Failed to find a video media section for send");if(t>1){n.rids=[],n.simulcast=null,n.ssrcs=[],n.ssrcGroups=[];for(var r=n.codecs.some((function(e){return"rtx"===e.codecName})),a=[],s=bi.generateUuid(),o="- "+bi.generateUuid(),d=0;d<t;d++){var c=bi.generateSsrc();if(a.push(c),n.ssrcs.push({ssrc:c,attribute:"cname:"+s}),n.ssrcs.push({ssrc:c,attribute:"msid:"+o}),r){var u=bi.generateSsrc();n.ssrcs.push({ssrc:u,attribute:"cname:"+s}),n.ssrcs.push({ssrc:u,attribute:"msid:"+o}),n.ssrcGroups.push({semantics:"FID",ssrcs:[c,u]})}}n.ssrcGroups.push({semantics:"SIM",ssrcs:a})}return n.extensionMap.forEach((function(e,t,i){if(/^urn:ietf:params:rtp-hdrext:sdes:(?:mid|rtp-stream-id|repaired-rtp-stream-id)$/.test(e.uri))i.delete(t);else if("urn:3gpp:video-orientation"===e.uri){/iPad|iPhone|iPod/.test(navigator.userAgent)&&/OS 15_1/.test(navigator.userAgent)||i.delete(t)}})),bi.addHeaderExtension(n,{uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time"}),t>1&&(i.session.extMapAllowMixed=!0,bi.addHeaderExtension(n,{uri:"http://www.webrtc.org/experiments/rtp-hdrext/video-layers-allocation00"})),bi.writeSdp(i)},t.mungeOfferToRemoteForSend=function(e){var t=bi.parseSdp(e);return t.session.timing={startTime:bi.getNtpSeconds(),stopTime:0},bi.writeSdp(t)},t.mungeAnswerForSend=function(e,t){var i=bi.parseSdp(e);return bi.updateCodecParameters(i,"video","recvonly","H264",t),bi.writeSdp(i)},t.mungeLocalOfferForRecv=function(e,t){var i=bi.parseSdp(e);return bi.filterCodecs(i,["H264"]),bi.updateCodecParameters(i,"video","recvonly","H264",t),bi.writeSdp(i)},e}()),Ti=[{layerId:0,width:160,height:90,framerate:30,minBitrate:4e4,maxBitrate:8e4},{layerId:1,width:320,height:180,framerate:30,minBitrate:1e5,maxBitrate:2e5},{layerId:2,width:640,height:360,framerate:30,minBitrate:3e5,maxBitrate:5e5},{layerId:3,width:1280,height:720,framerate:30,minBitrate:8e5,maxBitrate:2e6},{layerId:4,width:1920,height:1080,framerate:30,minBitrate:3e6,maxBitrate:5e6}],Ri=new(function(){function e(e){this.videoDimensionDegradeFactor=.75,this.layerIds=[],this.layersSettings={},this.setDefaultLayersSettings()}var t=e.prototype;return t.setDefaultLayersSettings=function(){this.updateLayersSettings(Ti)},t.updateLayersSettings=function(e){var t=[],i={};e.forEach((function(e){var n=e.layerId,r=e.width,a=e.height,s=e.framerate,o=e.minBitrate,d=e.maxBitrate;t.push(n),i[n]={width:r,height:a,framerate:s,minBitrate:o,maxBitrate:d}})),this.layerIds=t,this.layersSettings=i},t.getLayersSettings=function(){return this.layersSettings},t.getVideoSettings=function(e){return this.layersSettings[e]},t.getMinEncodingBitrate=function(){return 6e4},t.getMaxBitrate=function(e){return this.layersSettings[e].maxBitrate},t.getMinBitrate=function(e){return this.layersSettings[e].minBitrate},t.getMaxBitrateByVideoSettings=function(e,t){var i=this.layersSettings[e],n=i.width,r=i.height,a=i.maxBitrate;return Math.round(t.width*t.height/(n*r)*a)},t.getMinVideoDimension=function(e){var t=this.layerIds.indexOf(e);return t>0?this.getMaxVideoDimension(this.layerIds[t-1])+1:90},t.getMaxVideoDimension=function(e){var t=this.layersSettings[e],i=t.width,n=t.height;return Math.min(i,n)},t.getLayerIdByVideoDimension=function(e){return e>720?4:e>360?3:e>180?2:e>90?1:0},t.getVideoDimension=function(e,t){return t<this.getMinBitrate(e)?this.getInterpolatedVideoDimension(this.getMinVideoDimension(e),this.getMaxVideoDimension(e)):this.getMaxVideoDimension(e)},t.getInterpolatedVideoDimension=function(e,t){var i=Math.max(e,Math.round(t*this.videoDimensionDegradeFactor));return i<=144&&i>=135?144:i},t.setTrackContentHint=function(e,t){"contentHint"in e?(e.contentHint=t,e.contentHint!==t&&mi.error("Invalid track contentHint: "+t)):mi.warn("MediaStreamTrack contentHint attribute not supported")},t.printTrackInfo=function(e){return e?"{ kind: "+e.kind+", id: "+e.id+", enabled: "+e.enabled+", muted: "+e.muted+", contentHint: "+e.contentHint+" }":""},e}()),Li=function(){function e(e){this._array=new Array(e),this._size=e,this._index=0,this._count=0}var t,i,n,r=e.prototype;return r.empty=function(){return 0===this._count},r.full=function(){return this._count===this._size},r.clear=function(){this._array=new Array(this._size),this._index=0,this._count=0},r.fill=function(e){return this._array.fill(e),this._index=0,this._count=this._size,this},r._lastindex=function(){return 0===this._index?this._size-1:this._index-1},r._nextindex=function(){return(this._index+1)%this._size},r.push=function(e){this._array[this._index]="object"==typeof e?o({},e):e,this._index=this._nextindex(),this._count<this._size&&this._count++},r.pop=function(){var e=this._lastindex();return this._index=e,this._size>0&&this._size--,this._array[e]},r.front=function(){return this._array[this._count<this.size?0:this._index]},r.back=function(){return this._array[this._lastindex()]},r.unwrap=function(){return this._count<this._size?this._array.slice(0,this._count):[].concat(this._array.slice(this._index),this._array.slice(0,this._index))},t=e,(i=[{key:"size",get:function(){return this._size}},{key:"count",get:function(){return this._count}}])&&s(t.prototype,i),n&&s(t,n),Object.defineProperty(t,"prototype",{writable:!1}),e}(),Ai=new(function(){function e(e){this.selectedCandidatePairId=null,this.roundTripTime=0,this.remoteCandidateId=null,this.networkProtocol=null,this.resourceUsageStatsEnabled=!0,this.resourceUsageStatsWindowSize=12,this.resourceUsageTimeWindow=1e4,this.resourceUsageStatsMap=new Map,this.resourceUsageStatsReportTimestamp=0,this.encodeTimeMinFrameCount=20,this.encodeTimeThresholdNormal=30,this.encodeTimeThresholdCritical=100,this.qualityLimitationRatioThresholdNormal=.05,this.qualityLimitationRatioThresholdCritical=.8,this.outgoingBitrateStatsCallback=null,this.resourceUsageStatsCallback=null}var t=e.prototype;return t.registerOutgoingBitrateStatsCallback=function(e){this.outgoingBitrateStatsCallback=e},t.registerResourceUsageStatsCallback=function(e){this.resourceUsageStatsCallback=e},t.reset=function(){this.resetCandidateStats(),this.resetResourceUsageStats()},t.resetCandidateStats=function(){this.selectedCandidatePairId=null,this.roundTripTime=0,this.remoteCandidateId=null,this.networkProtocol=null},t.resetResourceUsageStats=function(){this.resourceUsageStatsMap=new Map,this.resourceUsageStatsReportTimestamp=0},t.getNetworkProtocol=function(){return this.networkProtocol},t.getCurrentRoundTripTime=function(){return this.roundTripTime},t.enableResourceUsageStats=function(e){this.resourceUsageStatsEnabled=e},t.onStatsReport=function(e){switch(e.type){case"transport":this.onTransportStats(e);break;case"candidate-pair":this.onCandidatePairStats(e);break;case"remote-candidate":this.onRemoteCandidateStats(e);break;case"outbound-rtp":this.onOutboundRtpStats(e)}},t.onTransportStats=function(e){var t=e.selectedCandidatePairId;"connected"===e.dtlsState&&(this.selectedCandidatePairId=t)},t.onCandidatePairStats=function(e){var t=e.id,i=e.state,n=e.nominated,r=e.availableOutgoingBitrate,a=e.currentRoundTripTime,s=e.remoteCandidateId,o=e.timestamp;t===this.selectedCandidatePairId&&"succeeded"===i&&n&&(this.roundTripTime=a,this.remoteCandidateId=s,r&&this.outgoingBitrateStatsCallback({availableOutgoingBitrate:r,timestamp:o}))},t.onRemoteCandidateStats=function(e){var t=e.id,i=e.protocol;t===this.remoteCandidateId&&(this.networkProtocol=i)},t.onOutboundRtpStats=function(e){if(this.resourceUsageStatsEnabled){var t=e.ssrc,i=e.framesEncoded,n=e.totalEncodeTime,r=e.qualityLimitationDurations,a=e.timestamp;this._handleResourceUsageStats({ssrc:t,framesEncoded:i,totalEncodeTime:n,qualityLimitationDurations:r,timestamp:a})}},t._handleResourceUsageStats=function(e){var t=e.ssrc,i=e.framesEncoded,n=e.totalEncodeTime,r=e.qualityLimitationDurations,a=e.timestamp,s=this.resourceUsageStatsMap.get(t);if(s||(s=new Li(this.resourceUsageStatsWindowSize),this.resourceUsageStatsMap.set(t,s)),s.push({framesEncoded:i,totalEncodeTime:n,qualityLimitationDurations:r,timestamp:a}),s.back().framesEncoded-s.front().framesEncoded!=0){for(var o=s.unwrap(),d=o.length-1;d>0&&o[d].timestamp>this.resourceUsageStatsReportTimestamp+500&&o[d].timestamp>a-this.resourceUsageTimeWindow;)d--;var c=o[d],u=a-c.timestamp,l=i-c.framesEncoded;if(!(u<this.resourceUsageTimeWindow)){var h=l?1e3*(n-c.totalEncodeTime)/l:0,p=u&&null!=r&&r.cpu?(r.cpu-c.qualityLimitationDurations.cpu)/u:0,f=u&&null!=r&&r.other?(r.other-c.qualityLimitationDurations.other)/u:0,m=null;l>=this.encodeTimeMinFrameCount&&h>=this.encodeTimeThresholdCritical||p>=this.qualityLimitationRatioThresholdCritical||f>=this.qualityLimitationRatioThresholdCritical?m=!0:h<this.encodeTimeThresholdNormal&&p<this.qualityLimitationRatioThresholdNormal&&f<this.qualityLimitationRatioThresholdNormal&&(m=!1),mi.log("WmscStatsMonitor._handleResourceUsageStats, overused: "+m+", duration: "+u+", frameCount: "+l+", avgEncodeTime: "+h+", cpuLimitationRatio: "+p+", otherLimitationRatio: "+f),null!=m&&(this.resourceUsageStatsReportTimestamp=a,this.resourceUsageStatsCallback({overused:m,timestamp:a}))}}},e}()),Di=function(){function e(){}return e.mean=function(e){return e.reduce((function(e,t){return e+t}),0)/e.length},e.median=function(e){e.sort((function(e,t){return e-t}));var t=Math.floor(e.length/2);return e.length%2!=0?e[t]:(e[t-1]+e[t])/2},e.variance=function(e){var t=e.reduce((function(e,t){return e+t}),0)/e.length,i=e.map((function(e){return Math.pow(e-t,2)}));return i.reduce((function(e,t){return e+t}),0)/i.length},e.expMovingAverage=function(e,t){void 0===t&&(t=.5);for(var i=[e[0]],n=1;n<e.length;n++)i.push(t*e[n]+(1-t)*i[n-1]);return i},e.bestFitSlope=function(e){if(e.length<2)return 0;for(var t=e.length,i=0,n=0,r=0,a=0,s=0;s<t;s++)i+=s,n+=e[s],r+=s*e[s],a+=s*s;return(t*r-i*n)/(t*a-i*i)},e}(),Pi=0,Oi=2,xi=0,ki=1,Ni=2,Bi=0,Vi=1,Wi=2,Fi=new(function(){function e(e){this.started=!1,this.enabledLayerIds=[],this.availableBitrateChangeRatioThresholdLow=.08,this.availableBitrateUpdateMinInterval=1500,this.adequateQualityBitrateRatio=.6,this.layerChangeUpdateMinInterval=3e3,this.outgoingBandwidthAdaptationEnabled=!0,this.receiverBandwidthAdaptationEnabled=!0,this.lossDetectionEnabled=!0,this.performanceAdaptationEnabled=!0,this.bandwidthFirstRampUpDelay=5e3,this.bandwidthRampUpTimeoutId=null,this.outgoingBandwidthReady=!1,this.receiverBandwidthReady=!1,this.outgoingBandwidth=2e7,this.receiverBandwidth=2e7,this.receiverBandwidthReport=null,this.receiverL3BandwidthEvaluation=null,this.receiverBandwidthSmoothingFactor=.5,this.isDualCall=!0,this.receiverReport=null,this.lossThresholdLow=.08,this.lossThresholdHigh=.6,this.outgoingBitrateStatsWindowSize=8,this.receiverStatsWindowSize=5,this.minOutgoingBitrateAdjustmentHistorySize=5,this.outgoingBitrateStats=new Li(this.outgoingBitrateStatsWindowSize),this.receiverStats=new Li(this.receiverStatsWindowSize),this.minOutgoingBitrateAdjustments=new Li(this.minOutgoingBitrateAdjustmentHistorySize),this.residualLossThresholdLow=.005,this.residualLossThresholdMedium=.05,this.residualLossThresholdHigh=.15,this.residualLossMonitorTimeWindow=5e3,this.residualLossCountThreshold=2,this.residualLossBitrateDecreaseFactor=.8,this.residualLossBitrateFastDecreaseFactor=.64,this.inherentLossDetectionMinDataPoints=3,this.inherentLossVarianceThresholdHigh=.02,this.sequenceGapThresholdLow=10,this.sequenceGapThresholdHigh=50,this.outgoingBitrateFactorThresholdNormalState=1.5,this.outgoingBitrateMinFactorRestoreBandwidth=1.5,this.outgoingBitrateIncreaseSuppressionIntervalResidualLoss=1e4,this.minOutgoingBitrateThresholdLow=25e4,this.minOutgoingBitrateThresholdMedium=8e5,this.minOutgoingBitrateThresholdHigh=15e5,this.minOutgoingBitrateIncreaseMinInterval=4e3,this.minOutgoingBitrateLeastDecreaseFactor=.8,this.minOutgoingBitrateFastDecreaseFactor=.64,this.minOutgoingBitrateIncreaseFactor=1.15,this.layersAllocationCallback=null,this.minOutgoingBitrateCallback=null,this.reset(),Ai.registerOutgoingBitrateStatsCallback(this.onOutgoingBandwidthStats.bind(this)),Ai.enableResourceUsageStats(this.performanceAdaptationEnabled),Ai.registerResourceUsageStatsCallback(this.onResourceUsageStats.bind(this))}var t=e.prototype;return t._resetLayersAllocation=function(){this.requestedLayerIds=[],this.additionalSubLayerIds=[],this.layersAllocation=[],this.availableBitrate=0,this.availableBitrateUpdatedTime=0,this.lastLayerChange=xi,this.lastLayerChangeUpdatedTime=0},t._resetQualityAdaptation=function(){this.maxFeasibleLayerId=this.enabledLayerIds[this.enabledLayerIds.length-1],this._resetLossDetection()},t._resetLossDetection=function(){this.receiverStats.clear(),this.outgoingBitrateStats.clear(),this.residualLossDetectedTimestamp=0,this.inherentLossDetectedTimestamp=0},t._resetMinOutgoingBitrate=function(){this.minOutgoingBitrate=8e4,this.minOutgoingBitrateIncreasedTime=0},t.reset=function(){this._resetLayersAllocation(),this._resetQualityAdaptation(),this._resetMinOutgoingBitrate()},t.registerLayersAllocationCallback=function(e){this.layersAllocationCallback=e},t.registerMinOutgoingBitrateCallback=function(e){this.minOutgoingBitrateCallback=e},t.enableLayers=function(e){this.enabledLayerIds=[].concat(e.sort()),this.maxFeasibleLayerId=this.enabledLayerIds[this.enabledLayerIds.length-1]},t.setOptions=function(e){var t=e.outgoingBandwidthAdaptationEnabled,i=e.receiverBandwidthAdaptationEnabled,n=e.lossDetectionEnabled,r=e.performanceAdaptationEnabled;void 0!==t&&(this.outgoingBandwidthAdaptationEnabled=t),void 0!==i&&(this.receiverBandwidthAdaptationEnabled=i),void 0!==n&&(this.lossDetectionEnabled=n),void 0!==r&&(this.performanceAdaptationEnabled=r,Ai.enableResourceUsageStats(r))},t.updateLayers=function(e,t){void 0===t&&(t=!1),mi.log("WmscQosMgr.updateLayers, "+e+", "+t),this.requestedLayerIds=[].concat(e),this._maybeAddSubLayers(),this.allocateBitrate(this._calcAvailableBitrate(),t,Vi)},t.start=function(){var e=this;this.started=!0,this.outgoingBandwidthAdaptationEnabled&&!this.outgoingBandwidthReady&&(this.bandwidthRampUpTimeoutId=setTimeout((function(){e.outgoingBandwidthReady=!0,e.receiverBandwidthReady=!0}),this.bandwidthFirstRampUpDelay))},t.stop=function(){this.started=!1,this.bandwidthRampUpTimeoutId&&(clearTimeout(this.bandwidthRampUpTimeoutId),this.bandwidthRampUpTimeoutId=null),this._resetLayersAllocation(),this._resetQualityAdaptation()},t.getMinBandwidth=function(){return 8e4},t._isOutgoingBandwidthReady=function(){return this.started&&this.outgoingBandwidthReady},t.onOutgoingBandwidthStats=function(e){if(this.outgoingBandwidthAdaptationEnabled&&this._isOutgoingBandwidthReady()){var t=e.availableOutgoingBitrate,i=e.timestamp;this.outgoingBitrateStats.push({availableOutgoingBitrate:t,timestamp:i}),this._onOutgoingBandwidth(t)}},t.onResourceUsageStats=function(e){if(this.performanceAdaptationEnabled&&this.started){var t=this._getFeasibleSendLayerIds();if(t.length){var i=e.overused,n=t[t.length-1],r=this.maxFeasibleLayerId;if(i){var a=this.enabledLayerIds[0];this.maxFeasibleLayerId>a&&(this.maxFeasibleLayerId=Math.max(a,n-1))}else{var s=this.enabledLayerIds[this.enabledLayerIds.length-1];this.maxFeasibleLayerId<s&&(this.maxFeasibleLayerId=Math.min(s,n+1))}if(this.maxFeasibleLayerId!==r){var o="Video encoding capability changed to layer "+this.maxFeasibleLayerId;mi.log("WmscQosMgr.onResourceUsageStats, "+o),this.sendMonitorLog(o),this.allocateBitrate(this._calcAvailableBitrate(),!1,Wi)}}}},t.onSubInfo=function(e){var t=e.isDualCall;this.onDualCallState(t)},t.onDualCallState=function(e){mi.log("WmscQosMgr.onDualCallState, "+e),this.isDualCall!==e&&(this.isDualCall=e,this.sendMonitorLog("DualCall state changed to "+e),this.receiverBandwidth=this._calcReceiverBandwidth(this.receiverBandwidthReport,e),this.started&&(this._maybeAddSubLayers(),this.allocateBitrate(this._calcAvailableBitrate(),!1,Bi)))},t._calcReceiverBandwidth=function(e,t){return e?t?Math.min(e.minBw,e.toMmrBw):e.toMmrBw:0},t._evaluateBandwidthDistribution=function(e,t,i){var n=i.reduce((function(e,t){return e+t}),0);if(!n)return null;var r=this._getMinBitrateForLayer(e),a=this._getMaxBitrateForLayer(e)*this.adequateQualityBitrateRatio,s=0,o=0,d=0;if(t>=a)o=n,d=t;else{for(var c=0,u=0,l=0,h=0,p=0,f=0,m=0,g=i.length-1;g>=0;g--){var _=i[g];_&&((m=m?512*g:t)>=r&&(c=g,u+=_),m>=a&&(l=g,h+=_),f||(p/n<.6?p+=_:f=g))}f<l&&(p-h)/n<.2?(s=l,o=h):f>c?(s=f,o=p):(s=c,o=u),d=o?Math.max(t,512*s):0}return{minBandwidth:t,samples:n,selectedBandwidth:d,selectedSamples:o,excludedDist:o<n?i.slice(0,s):[]}},t.onReceiverBandwidthReport=function(e){if(this.receiverBandwidthAdaptationEnabled&&this.receiverBandwidthReady){var t=e.minBW,i=e.minL3BW,n=e.toMmrBW,r=e.l3BWDist;if(t&&n){this.enabledLayerIds.includes(3)&&i&&r&&(this.receiverL3BandwidthEvaluation=this._evaluateBandwidthDistribution(3,i,r));var a=this._calcReceiverBandwidth(this.receiverBandwidthReport,this.isDualCall);this.receiverBandwidthReport={minBw:t,toMmrBw:n};var s=this._calcReceiverBandwidth(this.receiverBandwidthReport,this.isDualCall),o=a?Math.floor(a*this.receiverBandwidthSmoothingFactor+s*(1-this.receiverBandwidthSmoothingFactor)):s;this.receiverBandwidth=o,this.started&&this._updateAvailableBitrate(this._calcAvailableBitrate())}}},t.onReceiverReport=function(e){if(this._shouldDetectLoss()&&this._isOutgoingBandwidthReady())if(this.receiverReport){var t=e.recvPkts,i=e.preMissingPkts,n=e.postMissingPkts,r=e.maxJitterMs,a=e.maxSeqGap,s=e.timestampMs,o=this.receiverReport,d=t-o.recvPkts,c=i-o.preMissingPkts,u=n-o.postMissingPkts,l=c+d,h={loss:l>0?c/l:0,residualLoss:l>0?u/l:0,jitter:r,sequenceGap:a,timestamp:s};this.receiverStats.push(h),this.receiverReport=e;var p=this._adjustOutgoingBandwidthForLoss(this.outgoingBandwidth);this._updateOutgoingBandwidth(p)}else this.receiverReport=e},t._getOutgoingBandwidthHistory=function(e){if(!this.outgoingBitrateStats.count)return[];for(var t=this.outgoingBitrateStats.unwrap(),i=t[t.length-1].timestamp-e,n=0,r=t.length-1;r>=0;r--){if(t[r].timestamp<i){n=r;break}}return t.slice(n).map((function(e){return e.availableOutgoingBitrate}))},t._getSubLayersForLayer=function(e){var t,i=this,n=[];if(3===e&&null!=(t=this.receiverL3BandwidthEvaluation)&&t.selectedSamples){var r=0;return this.receiverL3BandwidthEvaluation.excludedDist.forEach((function(e,t){if(e){r=r?512*t:i.receiverL3BandwidthEvaluation.minBandwidth;var a=i._findLayerForBitrate(r);n.push(a)}})),n}for(var a,s=c(this.enabledLayerIds);!(a=s()).done;){var o=a.value;o<3&&o<e&&n.push(o)}return n},t._maybeAddSubLayers=function(){var e=this;if(this.receiverBandwidthAdaptationEnabled){if(!this.isDualCall&&this.requestedLayerIds.length){var t=[];this.requestedLayerIds.forEach((function(i){e._getSubLayersForLayer(i).forEach((function(i){e.requestedLayerIds.includes(i)||t.includes(i)||t.push(i)}))})),this.additionalSubLayerIds=t}this.isDualCall&&this.additionalSubLayerIds.length&&(this.additionalSubLayerIds=[])}},t._hasChangedMoreThanRatio=function(e,t,i){return!e||Math.abs(t-e)/e>=i},t._calcAvailableBitrate=function(e,t){e=e||this.outgoingBandwidth;var i=(t=t||this.receiverBandwidth)?Math.min(e,t):e;return Math.max(8e4,i)},t._updateAvailableBitrate=function(e){var t=performance.now();t-this.availableBitrateUpdatedTime>=this.availableBitrateUpdateMinInterval&&this._hasChangedMoreThanRatio(this.availableBitrate,e,this.availableBitrateChangeRatioThresholdLow)&&(this.allocateBitrate(e,!1,Bi),this.availableBitrate=e,this.availableBitrateUpdatedTime=t)},t._onOutgoingBandwidth=function(e){this._updateOutgoingBandwidth(e)},t._updateOutgoingBandwidth=function(e){this.outgoingBandwidth=e,this._updateAvailableBitrate(this._calcAvailableBitrate())},t._shouldDetectLoss=function(){return this.outgoingBandwidthAdaptationEnabled&&this.lossDetectionEnabled&&"udp"===Ai.getNetworkProtocol()},t._shouldDetectInherentLoss=function(e){return e>=this.lossThresholdLow&&e<this.lossThresholdHigh},t._adjustOutgoingBandwidthForLoss=function(e){var t=this;if(e<this.minOutgoingBitrate)return this.minOutgoingBitrate;e>=Math.max(this.minOutgoingBitrateThresholdLow,this.minOutgoingBitrate*this.outgoingBitrateFactorThresholdNormalState)&&this.minOutgoingBitrateAdjustments.clear();var i=this._getOutgoingBitrateDemand();if(e>=i)return e;var n=this.receiverStats.unwrap(),r=n[n.length-1],a=r.residualLoss;if(a&&mi.log("[QoS] bandwidth: "+e+", residual loss: "+a),a>=this.residualLossThresholdMedium){this.residualLossDetectedTimestamp=r.timestamp;var s=a>=this.residualLossThresholdHigh?this.residualLossBitrateFastDecreaseFactor:this.residualLossBitrateDecreaseFactor;return this._decreaseOutgoingBitrate(Math.floor(e*s))}if(a>=this.residualLossThresholdLow){var o=n.findIndex((function(e){return e.timestamp>t.residualLossDetectedTimestamp}));if(n.reduce((function(e,i,n){return n>=o&&i.residualLoss&&r.timestamp-i.timestamp<=t.residualLossMonitorTimeWindow?e+1:e}),0)>=this.residualLossCountThreshold)return this.residualLossDetectedTimestamp=r.timestamp,this._decreaseOutgoingBitrate(Math.floor(e*this.residualLossBitrateDecreaseFactor))}if(this.residualLossDetectedTimestamp&&r.timestamp-this.residualLossDetectedTimestamp<this.outgoingBitrateIncreaseSuppressionIntervalResidualLoss)return e;var d=n.findIndex((function(e){return e.timestamp>t.inherentLossDetectedTimestamp&&e.loss})),c=n.slice(d),u=c.map((function(e){return e.loss})),l=u.length?Di.mean(u):0;if(this._shouldDetectInherentLoss(l)&&u.length>=this.inherentLossDetectionMinDataPoints){var h=Di.variance(u);if(mi.log("[QoS] bandwidth: "+e+", demand: "+i+", loss: "+u+", mean: "+l+", variance: "+h),h<this.inherentLossVarianceThresholdHigh){this.inherentLossDetectedTimestamp=c[c.length-1].timestamp;var p=this._getOutgoingBandwidthHistory(this.inherentLossDetectedTimestamp-c[0].timestamp+500);if(p.length>=2){var f=Di.bestFitSlope(p),m=p[0];if(f<0&&m>=e*this.outgoingBitrateMinFactorRestoreBandwidth)return this._maybeIncreaseMinOutgoingBitrate(Math.min(i,m)),e}if(e<this.minOutgoingBitrateThresholdMedium)return this._maybeIncreaseMinOutgoingBitrate(Math.min(this.minOutgoingBitrateThresholdMedium,i,Math.floor(e*this.minOutgoingBitrateIncreaseFactor))),e}}var g=n.map((function(e){return e.sequenceGap})),_=g.length?Di.mean(g):0;return _>=this.sequenceGapThresholdLow&&_<this.sequenceGapThresholdHigh&&(mi.log("[QoS] bandwidth: "+e+", mean gap: "+_),e<this.minOutgoingBitrateThresholdMedium)?(this._maybeIncreaseMinOutgoingBitrate(Math.min(this.minOutgoingBitrateThresholdMedium,i,Math.floor(e*this.minOutgoingBitrateIncreaseFactor))),e):e},t._decreaseOutgoingBitrate=function(e){return e=Math.max(8e4,e),this._maybeDecreaseMinOutgoingBitrate(e),e},t._maybeIncreaseMinOutgoingBitrate=function(e){var t=performance.now();return!(this.minOutgoingBitrateAdjustments.unwrap().slice(-3).filter((function(e){return e===Pi})).length>=2)&&(t-this.minOutgoingBitrateIncreasedTime>=this.minOutgoingBitrateIncreaseMinInterval&&(this.minOutgoingBitrateIncreasedTime=t,this.minOutgoingBitrateAdjustments.push(Oi),this._adjustMinOutgoingBitrate(Math.max(this.minOutgoingBitrateThresholdLow,Math.min(this.minOutgoingBitrateThresholdHigh,e)))))},t._maybeDecreaseMinOutgoingBitrate=function(e){if(e<this.minOutgoingBitrate){this.minOutgoingBitrateAdjustments.push(Pi);var t=this.minOutgoingBitrate<=this.minOutgoingBitrateThresholdLow?8e4:Math.max(8e4,Math.min(e,Math.floor(this.minOutgoingBitrate*this.minOutgoingBitrateLeastDecreaseFactor)));return this._adjustMinOutgoingBitrate(t)}return!1},t._adjustMinOutgoingBitrate=function(e){mi.log("[QoS] adjust min bitrate: "+this.minOutgoingBitrate+" -> "+e);var t=1e3*Math.floor(e/1e3);return t!==this.minOutgoingBitrate&&(mi.log("[QoS] update min bitrate: "+this.minOutgoingBitrate+" -> "+t),this.minOutgoingBitrate=t,this.minOutgoingBitrateCallback(t),!0)},t._areLayersAllocationsEqual=function(e,t){return e.length===t.length&&e.every((function(e,i){var n=t[i];return e.layerId===n.layerId&&e.bitrate===n.bitrate}))},t._getMaxAllocatedLayerId=function(e){return e.length?e[e.length-1].layerId:-1},t._getMaxVideoDimension=function(e){if(!e.length)return 0;var t=e[e.length-1],i=t.layerId,n=t.bitrate;return Ri.getVideoDimension(i,n)},t._updateLayersAllocation=function(e){this.layersAllocation=e,"function"==typeof this.layersAllocationCallback&&this.layersAllocationCallback(e)},t._getMinBitrateForLayer=function(e){return e>this.enabledLayerIds[0]?Ri.getMaxBitrate(e-1):Ri.getMinEncodingBitrate()},t._getMaxBitrateForLayer=function(e){return Ri.getMaxBitrate(e)},t._getAdjustedBitrateForLayer=function(e){var t,i=this._getMaxBitrateForLayer(e);return 3===e&&null!=(t=this.receiverL3BandwidthEvaluation)&&t.selectedSamples?Math.min(i,this.receiverL3BandwidthEvaluation.selectedBandwidth):i},t._findLayerForBitrate=function(e){for(var t=this.enabledLayerIds.length-1;t>=0;t--){if(e>=this._getMinBitrateForLayer(this.enabledLayerIds[t]))return this.enabledLayerIds[t]}return this.enabledLayerIds[0]},t._getSendLayerIds=function(){return[].concat(this.additionalSubLayerIds,this.requestedLayerIds).sort()},t._getFeasibleSendLayerIds=function(){var e=this;return this._getSendLayerIds().filter((function(t){return t<=e.maxFeasibleLayerId}))},t._getTotalBitrateDemand=function(){for(var e=this._getSendLayerIds(),t=0,i=0;i<e.length;i++){t+=this._getAdjustedBitrateForLayer(e[i])}return t},t._getOutgoingBitrateDemand=function(){return Math.min(this._getTotalBitrateDemand(),this.receiverBandwidth)},t._allocateBitrateToLayers=function(e,t){for(var i,n,r=[],a=c(t);!(n=a()).done;){var s=n.value,o=this._getAdjustedBitrateForLayer(s),d=this._getMinBitrateForLayer(s);if(!(e>=d)){for(var u=void 0===i?this.enabledLayerIds[0]:i+1,l=s-1;l>=u&&this.enabledLayerIds.includes(l);l--){var h=this._getAdjustedBitrateForLayer(l),p=this._getMinBitrateForLayer(l);if(e>=p){r.push({layerId:l,bitrate:p,remainingBitrateDemand:h-p}),e-=p,i=l;break}}break}r.push({layerId:s,bitrate:d,remainingBitrateDemand:o-d}),e-=d,i=s}if(r.length&&e>0)for(var f,m=r.reduce((function(e,t){return e+t.remainingBitrateDemand}),0),g=c(r);!(f=g()).done;){var _=f.value,v=_.remainingBitrateDemand,S=Math.min(v,Math.floor(e/m*v));e-=S,_.bitrate+=S}return r.map((function(e){return{layerId:e.layerId,bitrate:e.bitrate}}))},t.allocateBitrate=function(e,t,i){if(this.requestedLayerIds.length){var n=performance.now(),r=this._getFeasibleSendLayerIds(),a=this._allocateBitrateToLayers(e,r),s=xi;if(this.layersAllocation.length){var o=this._getMaxVideoDimension(this.layersAllocation),d=this._getMaxVideoDimension(a);d<o?s=Ni:d>o&&(s=ki)}var c=!1;if(t?(this._updateLayersAllocation(a),c=!0):this._areLayersAllocationsEqual(this.layersAllocation,a)||(i===Bi&&s!==xi&&this.lastLayerChange!==s&&n-this.lastLayerChangeUpdatedTime<this.layerChangeUpdateMinInterval?mi.log("[QoS] pending layer change "+s):(this._updateLayersAllocation(a),c=!0)),c){s!==xi&&(this.lastLayerChange=s,this.lastLayerChangeUpdatedTime=n);var u="bandwidth: "+this.outgoingBandwidth+","+this.receiverBandwidth+","+e+", layers: "+r+", "+JSON.stringify(a);mi.log("WmscQosMgr.allocateBitrate, "+u),this.sendMonitorLog("Layers allocation updated, "+u)}}},t.sendMonitorLog=function(e){mi.monitorLog("WCL_WMSC_EVENT, "+e)},e}()),Ui=new(function(){function e(e){this.videoTrack=null,this.videoPublished=!1,this.mediaRequested=!1,this.hdVideoEnabled=!1,this.pcs={},this.recvPCInfo=null,this.sendPCsInfo=null,this.apiCallBack=null,this.requestedLayerIds=[],this.sendLayerIds=[],this.encodingMap=new Map,Fi.registerLayersAllocationCallback(this.onLayersAllocationUpdate.bind(this)),Fi.registerMinOutgoingBitrateCallback(this.updateMinOutgoingBitrate.bind(this))}var t=e.prototype;return t.getSendEncodings=function(e){switch(e){case 1:return[{active:!1}];case 2:return[{active:!1,scaleResolutionDownBy:2},{active:!1,scaleResolutionDownBy:1}];default:return[{active:!1,scaleResolutionDownBy:4},{active:!1,scaleResolutionDownBy:2},{active:!1,scaleResolutionDownBy:1}]}},t.getDefaultEncodingIndex=function(e){return e<=1?0:2===e?1:2},t.getEncodingIndex=function(e){return this.layerEncodingIndexMap.get(e)},t._configSimulcastLayers=function(e,t){this.numSimulcastLayers=e,this.layerEncodingIndexMap=t;var i=Array.from(t.keys()).sort();this.enabledLayerIds=i,Fi.enableLayers(i)},t.setDefaultVideoSettings=function(){Ri.setDefaultLayersSettings(),this._configSimulcastLayers(3,new Map([[1,0],[2,1],[3,2]])),this.restartVideo()},t.setVideoSettings=function(e){var t=this,i=e.layersSettings;if(null!=i&&i.length){for(var n=i.sort((function(e,t){return Math.min(e.width,e.height)-Math.min(t.width,t.height)})),r=n.reduce((function(e,t){return Math.min(t.framerate,e)}),30),a=0;a<n.length;a++){var s=n[a],o=s.width,d=s.height,c=s.minBitrate,u=s.maxBitrate,l=Ri.getLayerIdByVideoDimension(Math.min(o,d));n[a].layerId=l,n[a].framerate=r,void 0===u&&(n[a].maxBitrate=Ri.getMaxBitrateByVideoSettings(l,{width:o,height:d})),void 0===c&&(n[a].minBitrate=a>0?n[a-1].maxBitrate:Ri.getMinEncodingBitrate())}var h=new Map;n.forEach((function(e){var i=e.layerId,n=t.getDefaultEncodingIndex(i);h.get(i)?i.push(i):h.set(n,[i])}));for(var p=h.size,f=Array.from(h.keys()),m=new Map,g=function(e){h.get(f[e]).forEach((function(t){m.set(t,e)}))},_=0;_<p;_++)g(_);Ri.updateLayersSettings(n),this._configSimulcastLayers(p,m),this.restartVideo()}else this.setDefaultVideoSettings()},t.setupCallBack=function(e){this.apiCallBack=e},t.getPc=function(e){return this.pcs[e]},t.getRecvPc=function(){return this.pcs[wi.recvPeerId]},t.getSendPc=function(){return this.pcs[wi.sendPeerId]},t.getSender=function(){var e;return null==(e=this.pcs[wi.sendPeerId])?void 0:e.getSenders()[0]},t.enableHdVideo=function(e){mi.log("WmscMediaMgr.enableHdVideo, "+e),this.sendMonitorLog("Enable HD video: "+e),this.hdVideoEnabled=e},t.publishVideoTrack=function(){var e=a(n().mark((function e(t){return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.videoTrack=t,e.next=3,this._replaceVideoTrack(t||null);case 3:this._onVideoPublished(!!t);case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t._replaceVideoTrack=function(){var e=a(n().mark((function e(t){var i,r;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this.getSender(),r=Ri.printTrackInfo(t),mi.log("WmscMediaMgr._replaceVideoTrack, sender: "+!!i+", track: "+r),this.sendMonitorLog("Replace video track, sender: "+!!i+", track: "+r),!i){e.next=6;break}return e.abrupt("return",i.replaceTrack(t));case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t._onVideoPublished=function(e){this.videoPublished=e,this.mediaRequested&&(e?this._onVideoStart():this._onVideoStop())},t._onVideoStart=function(){mi.log("WmscMediaMgr._onVideoStart"),Fi.start(),Fi.updateLayers(this.sendLayerIds,!0)},t._onVideoStop=function(){mi.log("WmscMediaMgr._onVideoStop"),Fi.stop(),this.encodingMap.clear(),this._updateSendParameters()},t._onSendPcClose=function(){mi.log("WmscMediaMgr._onSendPcClose"),Fi.stop(),this.videoPublished=!1},t._reduceRequestLayerIds=function(e){var t=this;if(!e.length)return e;var i=new Map,n=this.enabledLayerIds[0],r=this.enabledLayerIds[this.enabledLayerIds.length-1],a=this.hdVideoEnabled?r:Math.min(2,r);return e.map((function(e){for(var i=Math.max(n,Math.min(a,e));!t.enabledLayerIds.includes(i);)--i;return i})).forEach((function(e){var n=t.getEncodingIndex(e),r=i.get(n);(void 0===r||e<r)&&i.set(n,e)})),Array.from(i.values()).sort()},t.onMediaRequest=function(e){var t=!!e.length;this.requestedLayerIds=[].concat(e);var i=this._reduceRequestLayerIds(e);mi.log("WmscMediaMgr.onMediaRequest, layer ids: "+e+" -> "+i),this.sendMonitorLog("New media request, layer ids: "+e+" -> "+i),this.sendLayerIds=i,this.mediaRequested!==t?(this.mediaRequested=t,this.videoPublished&&(t?this._onVideoStart():this._onVideoStop())):t&&Fi.updateLayers(this.sendLayerIds,!1)},t.restartVideo=function(){this.requestedLayerIds.length&&this.onMediaRequest(this.requestedLayerIds)},t.onLayersAllocationUpdate=function(e){var t=this;this.encodingMap.clear(),e.forEach((function(i){var n=i.layerId,r=i.bitrate,a=1===e.length&&1===t.sendLayerIds.length?t.sendLayerIds[0]:n,s=t.getEncodingIndex(a);t.encodingMap.set(s,{layerId:n,bitrate:r})})),this._updateSendParameters()},t._updateSendParameters=function(){var e=a(n().mark((function e(){var t,i,r,a,s,o,d,c,u=this;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.getSender()){e.next=4;break}return this.sendMonitorLog("Update send parameters, sender not found"),e.abrupt("return");case 4:if(this.videoPublished){e.next=6;break}return e.abrupt("return");case 6:return i=this.videoTrack.getSettings(),r=i.width,a=i.height,s=i.frameRate,o=Math.min(r,a),d="Update encoding params, "+r+"x"+a+"@"+s+"fps",(c=t.getParameters()).encodings.forEach((function(e,t){var i=u.encodingMap.get(t);if(e.active=!!i,e.active){var n=i.layerId,s=i.bitrate,c=Ri.getVideoSettings(n),l=Ri.getVideoDimension(n,s),h=Math.max(1,o/l),p=Math.floor(r/h*(a/h)/(c.width*c.height)*c.maxBitrate);e.maxBitrate=Math.min(p,s),e.scaleResolutionDownBy=h,e.maxFramerate=c.framerate,d+=", index "+t+": "+n+","+e.maxBitrate+","+e.maxFramerate+","+e.scaleResolutionDownBy}})),mi.log(d),e.prev=12,e.next=15,t.setParameters(c);case 15:this.sendMonitorLog(d),e.next=23;break;case 18:return e.prev=18,e.t0=e.catch(12),mi.globalTrace({logLevel:"error",log:"WMSC setParameters failed",errorEvent:e.t0}),mi.addMonitorLog("WMSCSETPARAMSE"),e.abrupt("return",Promise.reject(e.t0));case 23:case"end":return e.stop()}}),e,this,[[12,18]])})));return function(){return e.apply(this,arguments)}}(),t._getRemoteCodecParamsForSend=function(){var e=Fi.getMinBandwidth();return new Map([["x-google-min-bitrate",Math.floor(e/1e3)]])},t._getLocalCodecParamsForRecv=function(){return new Map([["sps-pps-idr-in-keyframe",1]])},t.updateMinOutgoingBitrate=function(){var e=a(n().mark((function e(t){var i,r;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this.getSendPc()){e.next=3;break}return e.abrupt("return");case 3:return this.sendMonitorLog("Update min bitrate to "+t),Ai.resetResourceUsageStats(),r=Mi.mungeAnswerForSend(i.remoteDescription.sdp,new Map([["x-google-min-bitrate",Math.floor(t/1e3)]])),e.prev=6,e.next=9,i.setLocalDescription(i.localDescription);case 9:return e.next=11,i.setRemoteDescription({type:"answer",sdp:r});case 11:e.next=17;break;case 13:e.prev=13,e.t0=e.catch(6),mi.globalTrace({logLevel:"error",log:"WMSC updateMinOutgoingBitrate failed: "+e.t0.message}),mi.addMonitorLog("WMSCUMOBF");case 17:case"end":return e.stop()}}),e,this,[[6,13]])})));return function(t){return e.apply(this,arguments)}}(),t.getNewPeerConnection=function(e,t,i,n){var r=this;if(this.sendMonitorLog("Start creating new PC, peerId: "+e),this.getPc(e))return mi.error("WmscMediaMgr.getNewPeerConnection, PC "+e+" has been created. Close it first"),!1;var a=new RTCPeerConnection;if(this.sendMonitorLog("New PC created, peerId: "+e),e===wi.recvPeerId){for(var s=0;s<n;s++)a.addTransceiver(t,{direction:i});this.recvPCInfo={pc:a,peerId:e}}else a.addTransceiver(t,{direction:i,sendEncodings:this.getSendEncodings(this.numSimulcastLayers)}),this.sendPCsInfo=this.sendPCsInfo||{},this.sendPCsInfo[e]={pc:a,peerId:e},Ai.reset(),Fi.reset();return this.pcs[e]=a,a.onicecandidate=function(e){},a.ontrack=this.getRemoteStream.bind(this,e),a.onconnectionstatechange=this.onconnectionstatechange.bind(this,e),a.onsignalingstatechange=this.onsignalingstatechange.bind(this,e),a.oniceconnectionstatechange=function(t){var i=t.target.iceConnectionState;mi.log("WmscMediaMgr.oniceconnectionstatechange, peerId: "+e+" state: "+i),mi.addMonitorLog("WMSCICESTATE-"+e+"-"+i),"failed"===i&&mi.globalTrace({logLevel:"error",log:"WMSC ICE STATE ERROR: "+e+"-"+i})},a.onnegotiationneeded=function(t){mi.log("WmscMediaMgr.onnegotiationneeded, peerId: "+e),r.addMonitorLog("Onnegotiationneeded, peerId: "+e)},a.onicegatheringstatechange=function(t){var i=t.target.iceGatheringState;mi.addMonitorLog("WMSCCANDGA-"+e+"-"+i)},a.onicecandidateerror=function(t){var i=t.errorCode,n=t.errorText,r=t.url;mi.addMonitorLog("WMSCCANDE-"+e+"-"+i),mi.globalTrace({logLevel:"error",log:"WMSC CANDIDATE ERROR: "+i+"-"+n+"-"+r})},a},t.onconnectionstatechange=function(e,t){var i=t.target.connectionState;switch(mi.log("WmscMediaMgr.onconnectionstatechange, peerId: "+e+" state: "+i),mi.addMonitorLog("WCL_WMSC_EVENT_PEER_STATUS,"+wi.nodeId+","+e+","+i),i){case"connected":this._handlePCConnected(e);break;case"disconnected":this._handlePCDisconnected(e);break;case"failed":this._handlePCFailed(e),mi.globalTrace({logLevel:"error",log:"WMSC peer connection failed: "+e})}},t._handlePCConnected=function(e){this.apiCallBack(e,l.MediaMgrMsgType.PCSTATUSCHANGE,"connected")},t._handlePCDisconnected=function(e){var t=this;setTimeout((function(){var i=t.getPc(e);"disconnected"===(null==i?void 0:i.connectionState)&&t.apiCallBack(e,l.MediaMgrMsgType.PCSTATUSCHANGE,"disconnected")}),2e3)},t._handlePCFailed=function(e){this.apiCallBack(e,l.MediaMgrMsgType.PCSTATUSCHANGE,"failed")},t.onsignalingstatechange=function(e,t){var i=t.target.signalingState;mi.log("WmscMediaMgr.onsignalingstatechange, peerId; "+e+" state: "+i),mi.addMonitorLog("WMSCSIG-"+e+"-"+i)},t.getRemoteStream=function(e,t){this.apiCallBack&&this.apiCallBack(e,l.MediaMgrMsgType.STREAM,t)},t.startNegotiation=function(e,t){var i=this.getPc(e);if(!i)return mi.error("WmscMediaMgr.startNegotiation, no pc for peerId: "+e),!1;var r=this;function s(){return(s=a(n().mark((function a(){var s;return n().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,i.createOffer(t);case 3:return s=n.sent,e===wi.recvPeerId?s.sdp=Mi.mungeLocalOfferForRecv(s.sdp,r._getLocalCodecParamsForRecv()):s.sdp=Mi.mungeLocalOfferForSend(s.sdp,r.numSimulcastLayers),n.next=7,i.setLocalDescription(s);case 7:return r.apiCallBack(e,l.MediaMgrMsgType.SDP,{description:i.localDescription}),n.abrupt("return",!0);case 11:return n.prev=11,n.t0=n.catch(0),mi.error(n.t0),mi.globalTrace({logLevel:"error",log:"WMSC createOffer or setLocalDescription failed: peerId-"+e+", error: "+n.t0.message}),mi.addMonitorLog("WMSCOFSLDF-"+e),r.apiCallBack(e,l.MediaMgrMsgType.SDP,{description:null}),n.abrupt("return",!1);case 18:case"end":return n.stop()}}),a,null,[[0,11]])})))).apply(this,arguments)}return this.sendMonitorLog("Start Negotiation, peerId: "+e),function(){return s.apply(this,arguments)}()},t.onServerMsg=function(e,t){var i=this.getPc(e);return i?(t.type===_i.SDP_ANSWER&&(e===wi.sendPeerId&&(t.sdp=Mi.mungeAnswerForSend(t.sdp,this._getRemoteCodecParamsForSend())),i.setRemoteDescription({type:"answer",sdp:t.sdp}).catch((function(t){mi.globalTrace({logLevel:"error",log:"WMSC setRemoteDescription failed: "+e+"-"+t.message}),mi.addMonitorLog("WMSCSRDF-"+e)}))),!0):(mi.error("WmscMediaMgr.onServerMsg peerId "+e+" pc not created yet"),!1)},t.closePeerConnection=function(e){var t;this.sendMonitorLog("Close PeerConnection, peerId: "+e),null==(t=this.pcs[e])||t.close(),this.pcs[e]=null,e===wi.sendPeerId?(this.sendPCsInfo=null,this._onSendPcClose()):this.recvPCInfo=null},t.sendMonitorLog=function(e){mi.monitorLog("WCL_WMSC_EVENT, "+e)},t.addMonitorLog=function(e){mi.addMonitorLog("WCL_WMSC_EVENT, "+e)},e}()),zi=new(function(){function e(){this.bToPrint=!0,this.mIdMgr=null,this.captureTimer=null,this.reportTimer=null,this.userId="",this.recvStats={},this.sendStats={},this.isMonitoring=!1,this.subInfo={},this.activeSpeaker="",this.isPreActiveSpeaker=!1,this.downLinkStats={},this.recordUserId="",this.captureTimer=null,this.reportTimer=null,this.lastSendPCsStatRecord=new Map,this.captureCount=0,this.isSimulcast=!1,this.wmscMediaMgr=Ci,this._startCapture=this._startCapture.bind(this),this.rtpHeaderExt={"http://www.webrtc.org/experiments/rtp-hdrext/playout-delay":0,"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01":1,"urn:ietf:params:rtp-hdrext:sdes:mid":2,"http://www.webrtc.org/experiments/rtp-hdrext/video-layers-allocation00":3},this.sdpDirection={recvonly:0,sendonly:1,sendrecv:2,inactive:3},this.recvStatisticData={},this.reportCount=0,this.maxSubscribedSize=-1,this._telemetry=null,this.uiQosData={},this.isUISubQos=!1,this.UIQosInterval=1,this.candidateLog={0:"",1:"",2:"",3:"",4:""},this.candidatePairLog={0:"",1:"",2:"",3:"",4:""},this.iceCandidatePairState={frozen:0,waiting:1,"in-progress":2,failed:3,succeeded:4},this.ssrcMidMap={},this.candidatePairMonitorLog=new Array(5).fill(""),this.candidatePairChangeCount=new Array(5).fill(0),this.ingressReport={}}var t=e.prototype;return t.setTelemetry=function(e){this._telemetry="function"==typeof e?e:null},t.updateQosSubscription=function(e,t){void 0===t&&(t=1e3),this.isUISubQos=e,this.UIQosInterval=Math.round(t/1e3)},t.setUserId=function(e){this.userId=parseInt(e,10)},t.setSimulcast=function(e){this.isSimulcast=e,this.isSimulcast?this.wmscMediaMgr=Ui:this.wmscMediaMgr=Ci},t.setQoSDataCb=function(e){this.sendQoSData=e},t.updateSubInfo=function(e,t,i){e?i&&(this.subInfo[e]=i):(e=this.mIdMgr.getUserId(t).userId,delete this.subInfo[e]),mi.log("WMSCMonitor.updateSubInfo: "+this.subInfo)},t.setActiveSpeaker=function(e,t){this.activeSpeaker=hi.getNodeId(parseInt(e,10)),this.isPreActiveSpeaker=t},t.updateSubscribedSize=function(e,t,i){var n=-1;Array.from(new Set([].concat(e,t,i))).forEach((function(e){n=Math.max(n,e)})),this.maxSubscribedSize=n},t.start=function(){mi.addMonitorLog("WMSCMSTART-"+this.isMonitoring),this.isMonitoring||(this._startCapture(),this._startReport(),this.isMonitoring=!0)},t.resetRecvStats=function(e){this.recvStats[e]&&delete this.recvStats[e]},t.stop=function(){mi.addMonitorLog("WMSCMSTOP-"+this.isMonitoring),clearInterval(this.reportTimer),clearTimeout(this.captureTimer),this.recvStats={},this.sendStats={},this.downLinkStats={},this.isMonitoring=!1},t.getResolutionId=function(e){return e<=14400?0:e<=57600?1:e<=230400?2:e<=921600?3:e<=2073600?4:5},t._sendQosData=function(){if(this.isUISubQos&&this.captureCount%this.UIQosInterval==0){if(this.uiQosData.receiving){var e=this.downLinkStats.candidatePairStats,t=(void 0===e?{}:e).currentRoundTripTime,i=void 0===t?0:t,n=Math.round(1e3*i);this._telemetry&&this._telemetry({type:fi.VIDEO_QOS_DATA,data:o({encoding:!1},this.uiQosData.receiving,{rtt:n})}),this.uiQosData.receiving=null}this.uiQosData.sending&&(this._telemetry&&this._telemetry({type:fi.VIDEO_QOS_DATA,data:o({encoding:!0},this.uiQosData.sending)}),this.uiQosData.sending=null)}},t._startCapture=function(){var e=a(n().mark((function e(){return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.captureCount++,e.prev=1,e.next=4,Promise.all([this._captureRecvStats(),this._captureSenderStats()]);case 4:this._sendQosData(),e.next=12;break;case 7:e.prev=7,e.t0=e.catch(1),mi.error("WMSCMonitor._startCapture, capture error: "+e.t0),mi.addMonitorLog("WMSCLOGCE"),mi.globalTrace({logLevel:"error",log:"WMSCMonitor capture error",errorEvent:e.t0});case 12:return e.prev=12,this.captureTimer=setTimeout(this._startCapture,l.captureStatsInterval),e.finish(12);case 15:case"end":return e.stop()}}),e,this,[[1,7,12,15]])})));return function(){return e.apply(this,arguments)}}(),t._startReport=function(){this.reportTimer=setInterval(this._reportStats.bind(this),l.reportStatsInterval)},t._reportStats=function(){this.reportCount++,this._getStats(),this.recvStats={},this.sendStats={},this.downLinkStats={},this.ingressReport.begin=null},t._captureSenderStats=function(){var e=a(n().mark((function e(){var t,i,r,a,s=this;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.wmscMediaMgr.sendPCsInfo){e.next=2;break}return e.abrupt("return","");case 2:t=!1,i=0,r=n().mark((function e(r){var a,d,c,u,l,h,p,f,m,g,_,v,S,b,I,C,y,E,w,M,T,R,L,A,D,P,O,x,k,N,B,V,W,F,U,z,G,j,H,Z,q,Y,K,J,Q,X,$,ee,te,ie,ne,re,ae,se,oe,de,ce,ue,le,he,pe,fe,me,ge,_e,ve,Se,be,Ie,Ce,ye,Ee,we,Me,Te,Re,Le,Ae,De,Pe,Oe,xe,ke,Ne,Be,Ve,We,Fe,Ue,ze,Ge,je,He,Ze,qe,Ye,Ke,Je,Qe,Xe,$e,et,tt,it,nt,rt,at,st;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=s.wmscMediaMgr.sendPCsInfo[r].pc){e.next=3;break}return e.abrupt("return","continue");case 3:return e.next=5,a.getStats();case 5:for(V in d=e.sent,c={},s.sendStats[r]||(s.sendStats[r]={}),u={},l={},h="",p="",d.forEach((function(e){var t=e.kind,i=e.type,n=(t?t+"-":"")+i,a="begin-"+n;if(s.isSimulcast&&Ai.onStatsReport(e),"video"!==t||"outbound-rtp"!==i&&"remote-inbound-rtp"!==i)if("candidate-pair"===i){var d=e.id;u[d]=e,p+=s._getCandidatePairLog(e)}else if("local-candidate"===i||"remote-candidate"===i){var f=e.id;l[f]=e,h+=s._getCandidateLog(e)}else c[n]=e;else{var m,g=e.ssrc;if(c[n]||(c[n]={}),c[n][g]=e,!s.sendStats[r][a]||!s.sendStats[r][a][g])s.sendStats[r][a]=o({},s.sendStats[r][a],((m={})[g]=e,m))}})),c.candidates=l,c.candidatePairs=u,c.transport&&(f=c.transport,m=f.selectedCandidatePairId,"connected"===f.dtlsState&&(g=u[m],_=g.localCandidateId,v=g.remoteCandidateId,c["remote-candidate"]=l[v],c["local-candidate"]=l[_],c["candidate-pair"]=g,s.sendStats[r]["begin-candidate-pair"]||(s.sendStats[r]["begin-candidate-pair"]=g))),h!==s.candidateLog[r]&&(mi.monitorLog("WMSC candidate "+r+": "+h),s.candidateLog[r]=h),p!==s.candidatePairLog[r]&&(s.candidatePairChangeCount[r]++,s.candidatePairLog[r]=p),S=c["candidate-pair"]||{},b=S.currentRoundTripTime,I=c["video-outbound-rtp"]||{},C=c["video-remote-inbound-rtp"]||{},s.sendStats[r].statisticData||(s.sendStats[r].statisticData={}),y=s.sendStats[r]["video-outbound-rtp"]||{},E=s.sendStats[r].statisticData,w=E.minCaptureFps,M=E.maxCaptureFps,T=E.maxRtt,R=E.totalCaptureFps,L=void 0===R?0:R,A=E.totalCaptureCount,D=void 0===A?0:A,(P=a.getSenders())[0]&&P[0].track&&(t=!0,O=P[0].track.getSettings(),x=O.frameRate,k=void 0===x?0:x,N=O.width,B=O.height,E.minCaptureFps=Math.min(k,w||Number.MAX_SAFE_INTEGER),E.maxCaptureFps=Math.max(k,M||0),E.totalCaptureFps=L+k,E.totalCaptureCount=D+1,E.avgCaptureFps=Math.round(E.totalCaptureFps/E.totalCaptureCount),E.captureWidth=null!=N?N:"",E.captureHeight=null!=B?B:""),b&&(E.maxRtt=Math.max(b,T||0)),I)W=I[V],F=W.framesPerSecond,U=void 0===F?"":F,z=W.bytesSent,G=W.framesSent,j=W.timestamp,H=W.framesEncoded,Z=W.totalEncodeTime,q=W.packetsSent,Y=W.totalPacketSendDelay,K=W.frameHeight,J=W.frameWidth,Q=W.retransmittedPacketsSent,X=C[V]||{},$=X.jitter,E[V]||(E[V]={}),ee=E[V],te=ee.minEncodeFrameRate,ie=ee.maxEncodeFrameRate,ne=ee.minSendFrameRate,re=ee.maxSendFrameRate,ae=ee.minSendBitRate,se=ee.maxSendBitRate,oe=ee.maxEncodeTime,de=ee.minEncodeTime,ce=ee.maxPacketSentDelay,ue=ee.minPacketSentDelay,le=ee.maxJitter,he=ee.maxLossRate,pe=ee.sendWidth,fe=ee.sendHeight,ee.minEncodeFrameRate=Math.min(U,te||Number.MAX_SAFE_INTEGER),ee.maxEncodeFrameRate=Math.max(U,ie||0),ee.maxJitter=Math.max($,le||0),y&&y[V]?(ge=y[V],_e=ge.timestamp,ve=ge.bytesSent,Se=ge.framesSent,be=ge.framesEncoded,Ie=ge.totalEncodeTime,Ce=ge.packetsSent,ye=ge.totalPacketSendDelay,Ee=ge.retransmittedPacketsSent,we=s.sendStats[r]["begin-video-outbound-rtp"][V],Me=we.framesSent,Te=we.bytesSent,Re=we.timestamp,Le=we.framesEncoded,Ae=we.totalEncodeTime,De=we.packetsSent,Pe=we.totalPacketSendDelay,Oe=we.retransmittedPacketsSent,xe=void 0,ke=void 0,Ne="",Be="",Ve=Math.round((G-Se)/((j-_e)/1e3)),We=(8*(z-ve)/((j-_e)/1e3)).toFixed(2),Fe=Math.round((G-Me)/((j-Re)/1e3)),Ue=(8*(z-Te)/((j-Re)/1e3)).toFixed(2),ze=(Z-Ie)/(H-be)||0,Ge=(Z-Ae)/(H-Le)||0,je=Math.round((H-Le)/((j-Re)/1e3)),He=s.ingressReport,Ze=He.current,qe=He.begin,Ye=He.prev,Ze&&Ye&&qe?(Ke=Ze.lostPkts,Je=Ze.recvPkts,Qe=Ye.lostPkts,Xe=Ye.recvPkts,$e=qe.lostPkts,et=qe.recvPkts,Be=(tt=Ke-Qe)/(Je-Xe+tt)||0,Ne=(it=Ke-$e)/(Je-et+it)||0):(Ne=(Q-Oe)/(q-De)||0,Be=(Q-Ee)/(q-Ce)||0),void 0!==Y&&(xe=(1e3*(Y-ye)/(q-Ce)).toFixed(3),ke=(1e3*(Y-Pe)/(q-De)).toFixed(3)),E[V]=o({},ee,{maxEncodeTime:Math.max(oe,ze),minEncodeTime:Math.min(ze,de),avgEncodeTime:Ge,minSendFrameRate:Math.min(Ve,ne),maxSendFrameRate:Math.max(re,Ve),avgSendFrameRate:Fe,minSendBitRate:Math.min(We,ae),maxSendBitRate:Math.max(se,We),avgSendBitRate:Ue,minPacketSentDelay:Math.min(xe,ue),maxPacketSentDelay:Math.max(xe,ce),avgPacketSentDelay:null!=(me=ke)?me:"",avgEncodeFrameRate:je,avgLossRate:isNaN(Ne)?"":Ne,maxLossRate:isNaN(Be)?he:Math.max(Be,he),sendWidth:J||pe,sendHeight:K||fe})):E[V]=o({},ee,{maxEncodeTime:0,minEncodeTime:Number.MAX_SAFE_INTEGER,avgEncodeTime:0,minSendFrameRate:Number.MAX_SAFE_INTEGER,maxSendFrameRate:0,avgSendFrameRate:0,minSendBitRate:Number.MAX_SAFE_INTEGER,maxSendBitRate:0,avgSendBitRate:0,minPacketSentDelay:Number.MAX_SAFE_INTEGER,maxPacketSentDelay:0,avgPacketSentDelay:0,maxLossRate:"",avgLossRate:""}),K&&J&&(nt=K*J)>i&&(rt=c["candidate-pair"]||{},at=rt.currentRoundTripTime,st=void 0===at?0:at,i=nt,s.uiQosData.sending={width:J,height:K,fps:U,rtt:Math.round(1e3*st),max_loss:1e3*E[V].maxLossRate,avg_loss:1e3*E[V].avgLossRate,jitter:Math.round(1e3*($||0))});s.sendStats[r]=o({},s.sendStats[r],c);case 31:case"end":return e.stop()}}),e)})),e.t0=n().keys(this.wmscMediaMgr.sendPCsInfo);case 6:if((e.t1=e.t0()).done){e.next=14;break}return a=e.t1.value,e.delegateYield(r(a),"t2",9);case 9:if("continue"!==e.t2){e.next=12;break}return e.abrupt("continue",6);case 12:e.next=6;break;case 14:this.captureCount%2==0&&t&&this.sendQoSData&&this.checkSendPCsStat();case 15:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t._captureRecvStats=function(){var e=a(n().mark((function e(){var t,i,r,a,s,o,d,c,u,l,h,p,f,m,g,_,v,S,b=this;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.wmscMediaMgr.recvPCInfo&&this.mIdMgr){e.next=2;break}return e.abrupt("return");case 2:if(t=this.wmscMediaMgr.recvPCInfo.pc){e.next=5;break}return e.abrupt("return");case 5:return i=this.mIdMgr.mIdUsedStatus,e.next=8,t.getStats();case 8:r=e.sent,s=0,o={},d={},c="",u="",r.forEach((function(e){var t=e.kind,n=e.type;if("candidate-pair"===n){var r=e.id;o[r]=e,u+=b._getCandidatePairLog(e)}else if("remote-candidate"===n||"local-candidate"===n){var h=e.id;d[h]=e,c+=b._getCandidateLog(e)}else if("codec"===n)a=e;else if("video"===t&&"inbound-rtp"===n){var p=e.mid,f=e.ssrc;if(p||(p=b.ssrcMidMap[f]),p&&i[p].used){var m,g=i[p].userId,_=b.mIdMgr.user2VideoDom.get(g),v=e.framesPerSecond,S=void 0===v?"":v,I=e.timestamp,C=void 0===I?"":I,y=e.framesDecoded,E=void 0===y?"":y,w=e.frameWidth,M=void 0===w?"":w,T=e.frameHeight,R=void 0===T?"":T,L=e.bytesReceived,A=void 0===L?"":L,D=e.framesReceived,P=void 0===D?"":D,O=e.totalDecodeTime,x=void 0===O?"":O,k=e.packetsReceived,N=void 0===k?"":k,B=e.packetsLost,V=void 0===B?"":B,W=e.jitter,F=void 0===W?"":W,U=e.lastPacketReceivedTimestamp,z=void 0===U?0:U,G="",j="",H="";if(_){G=_.currentTime>0&&!_.paused&&!_.ended&&_.readyState>2?1:0;var Z=_.getVideoPlaybackQuality();j=Z.totalVideoFrames,H=Z.droppedVideoFrames}if(b.recvStats[g]){b.recvStats[g].count++;var q=b.recvStats[g],Y=q.maxFps,K=q.minFps,J=q.maxDecodeTime,Q=q.minDecodeTime,X=q.maxLossRate,$=q.maxBt,ee=q.minBt,te=q.stats,ie=q.maxJitter,ne=q.beginStats,re=q.minLastRecvGap,ae=q.maxLastRecvGap,se=q.avgLastRecvGap,oe=q.count,de=ne||{},ce=de.timestamp,ue=de.framesDecoded,le=de.totalDecodeTime,he=de.packetsLost,pe=de.packetsReceived,fe=de.bytesReceived,me=te||{},ge=me.packetsLost,_e=me.packetsReceived,ve=me.totalDecodeTime,Se=me.framesDecoded,be=me.bytesReceived,Ie=me.timestamp,Ce=me.lastPacketReceivedTimestamp,ye=(V-ge)/(N-_e+(V-ge))||0,Ee=(x-ve)/(E-Se)||0;m=8*(A-be)/((C-Ie)/1e3);var we=8*(A-fe)/((C-ce)/1e3);if(Ce){var Me=parseInt(z-Ce,10);b.recvStats[g].minLastRecvGap=Math.min(re,Me),b.recvStats[g].maxLastRecvGap=Math.max(ae,Me),b.recvStats[g].avgLastRecvGap=parseInt((se*(oe-1)+Me)/oe,10),0===Me&&b.recvStats[g].noDataCount++}else b.recvStats[g].minLastRecvGap=0,b.recvStats[g].noDataCount++;b.recvStats[g].codecStats=a,b.recvStats[g].maxFps=Math.max(Y,S),b.recvStats[g].minFps=Math.min(K,S),b.recvStats[g].avgFps=Math.round((E-ue)/((C-ce)/1e3)),b.recvStats[g].maxDecodeTime=Math.max(J,Ee),b.recvStats[g].minDecodeTime=Math.min(Ee,Q),b.recvStats[g].avgDecodeTime=(x-le)/(E-ue)||0,b.recvStats[g].prevTotalDecodeTime=x,b.recvStats[g].prevFramesDecoded=E,b.recvStats[g].maxLossRate=Math.max(X,ye),b.recvStats[g].avgLossRate=(V-he)/(N-pe+(V-he))||0,b.recvStats[g].maxJitter=Math.max(ie,F),b.recvStats[g].maxBt=Math.max(m,$),b.recvStats[g].minBt=Math.min(m,ee),b.recvStats[g].avgBt=we,b.recvStats[g].isVideoPlaying=G,b.recvStats[g].framesRendered=j-H,b.recvStats[g].framesRenderDrop=H,b.recvStats[g].stats=e}else m=8*A/P*S||"",b.recvStats[g]={maxFps:S,minFps:S,avgFps:S,maxDecodeTime:0,minDecodeTime:Number.MAX_SAFE_INTEGER,avgDecodeTime:0,maxLossRate:0,avgLossRate:0,maxBt:m,minBt:m,avgBt:m,maxJitter:F,minLastRecvGap:Number.MAX_SAFE_INTEGER,maxLastRecvGap:0,avgLastRecvGap:0,beginStats:e,isVideoPlaying:G,framesRendered:j-H,framesRenderDrop:H,stats:e,codecStats:a,noDataCount:0,count:0};if(M&&R){var Te=M*R;Te>s&&(b.uiQosData.receiving={avg_loss:Math.max(1e3*b.recvStats[g].avgLossRate,0),max_loss:Math.max(1e3*b.recvStats[g].maxLossRate,0),fps:S||0,height:R,width:M,jitter:Math.round(1e3*(F||0))},s=Te)}b.bToPrint&&b._renderStatsData(p,M,R,S,m)}}else"transport"===n&&(l=e)})),l&&(p=(h=l).selectedCandidatePairId,"connected"===h.dtlsState&&(f=o[p],m=f.localCandidateId,g=f.remoteCandidateId,_=f.currentRoundTripTime,v=void 0===_?0:_,this.downLinkStats.remoteCandidateStats=d[g],this.downLinkStats.localCandidateStats=d[m],this.downLinkStats.beginCandidatePairStats?(S=this.downLinkStats.maxRtt,this.downLinkStats.candidatePairStats=f,this.downLinkStats.maxRtt=Math.max(S,v)):(this.downLinkStats.beginCandidatePairStats=f,this.downLinkStats.maxRtt=v))),this.downLinkStats.candidates=d,this.downLinkStats.candidatePairs=o,c!==this.candidateLog[0]&&(mi.monitorLog("WMSC candidate 0: "+c),this.candidateLog[0]=c),u!==this.candidatePairLog[0]&&(this.candidatePairChangeCount[0]++,this.candidatePairLog[0]=u);case 20:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t._getVideoSenderLog=function(){var e="",t="{[ENCO]},";for(var i in this.sendStats){var n=this.sendStats[i];if(n["video-media-source"])for(var r in n["video-outbound-rtp"]){var a=n.statisticData[r],s=a.minEncodeFrameRate,o=a.maxEncodeFrameRate,d=a.avgEncodeFrameRate,c=a.minSendFrameRate,u=a.maxSendFrameRate,l=a.avgSendFrameRate,h=a.minSendBitRate,p=a.maxSendBitRate,f=a.avgSendBitRate,m=a.maxEncodeTime,g=a.minEncodeTime,_=a.avgEncodeTime,v=a.maxPacketSentDelay,S=a.minPacketSentDelay,b=a.avgPacketSentDelay,I=a.sendWidth,C=void 0===I?"":I,y=a.sendHeight,E=void 0===y?"":y,w=n.statisticData,M=w.minCaptureFps,T=w.maxCaptureFps,R=w.avgCaptureFps,L=w.captureHeight,A=w.captureWidth,D=n["video-outbound-rtp"][r],P=D.keyFramesEncoded,O=void 0===P?"":P,x=D.qualityLimitationReason,k=void 0===x?"":x,N=D.pliCount,B=void 0===N?"":N,V=D.nackCount,W=void 0===V?"":V,F=D.firCount,U=void 0===F?"":F,z=D.framesSent,G=void 0===z?"":z,j=D.retransmittedPacketsSent,H=void 0===j?"":j,Z=D.powerEfficientEncoder,q=D.hugeFramesSent,Y=void 0===q?"":q,K=D.packetsSent,J=void 0===K?"":K,Q=D.bytesSent,X=void 0===Q?"":Q,$=D.qualityLimitationDurations,ee=void 0===$?{}:$,te=D.encoderImplementation,ie=void 0===te?"":te,ne=D.targetBitrate,re=void 0===ne?"":ne,ae=ee.bandwidth,se=void 0===ae?"":ae,oe=ee.cpu,de=void 0===oe?"":oe,ce=ee.none,ue=void 0===ce?"":ce,le=ee.other,he=void 0===le?"":le,pe=(n.codec||{}).mimeType,fe=-1!==(void 0===pe?"h264":pe).toLowerCase().indexOf("h264")?0:2;Z&&(fe|=1),e+=A+","+L+","+T+","+M+","+R+",,,,,,,"+o+","+s+","+d+","+p+","+h+","+f+","+u+","+c+","+l+","+C+","+E+","+G+",,,,"+T+","+M+","+R+","+(isNaN(v)?"":v)+","+(isNaN(S)?"":S)+","+(isNaN(b)?"":b)+","+J+","+X+","+O+","+Y+","+W+","+U+","+B+","+H+","+k+","+se+","+de+","+he+","+ue+","+ie+","+re+","+r+",",t+=(1e3*m).toFixed(2)+","+(1e3*g).toFixed(2)+","+(1e3*_).toFixed(2)+",,"+fe+","+r+","}}return e?"{[SEND]},"+this.maxSubscribedSize+","+e+t:""},t._getVideoReceiveLog=function(){var e,t=this,i=new Array(8).fill(0),n=new Array(8).fill(0),r=-1,a=new Set,s={};for(var o in this.recvStats){var d=this.recvStats[o],c=d.maxFps,u=d.minFps,h=d.avgFps,p=d.maxBt,f=d.minBt,m=d.avgBt,g=d.framesRenderDrop,_=d.framesRendered,v=d.isVideoPlaying,S=d.minLastRecvGap,b=d.maxLastRecvGap,I=d.avgLastRecvGap,C=d.noDataCount,y=d.count,E=d.stats,w=void 0===E?{}:E,M=d.beginStats,T=void 0===M?{}:M,R=T.framesReceived,L=void 0===R?"":R,A=T.framesDropped,D=void 0===A?"":A,P=T.framesDecoded,O=void 0===P?"":P,x=T.totalProcessingDelay,k=void 0===x?"":x,N=w.frameHeight,B=void 0===N?0:N,V=w.frameWidth,W=void 0===V?0:V,F=w.freezeCount,U=void 0===F?"":F,z=w.framesReceived,G=void 0===z?"":z,j=w.framesDropped,H=void 0===j?"":j,Z=w.keyFramesDecoded,q=void 0===Z?"":Z,Y=w.pauseCount,K=void 0===Y?"":Y,J=w.nackCount,Q=void 0===J?"":J,X=w.firCount,$=void 0===X?"":X,ee=w.pliCount,te=void 0===ee?"":ee,ie=w.totalProcessingDelay,ne=void 0===ie?"":ie,re=w.fecPacketsReceived,ae=void 0===re?"":re,se=w.retransmittedPacketsReceived,oe=void 0===se?"":se,de=w.framesDecoded,ce=void 0===de?"":de,ue=w.bytesReceived,le=void 0===ue?"":ue,he=w.packetsReceived,pe=void 0===he?"":he,fe=w.packetsLost,me=void 0===fe?"":fe,ge=w.jitterBufferDelay,_e=void 0===ge?0:ge,ve=w.jitterBufferEmittedCount,Se=void 0===ve?"":ve,be=G-L,Ie=H-D,Ce=(Ie/be||0).toFixed(2),ye=((ne-k)/(ce-O)*1e3||0).toFixed(2),Ee=ce-O;if(void 0!==this.subInfo[o]){var we=W*B;we>r&&(r=we,e=parseInt(o,10)),we>0&&n[this.getResolutionId(we)]++}else a.add(parseInt(o,10));s[o]=c+","+u+","+h+","+W+","+B+","+o+","+y+","+C+",,,,,,,,,,,,,"+be+","+Ie+","+Ce+","+(this.subInfo[o]||"")+",,,,"+Ee+","+v+","+_+","+g+","+(p||0).toFixed(2)+","+(f||0).toFixed(2)+","+(m||0).toFixed(2)+","+pe+","+me+","+le+","+q+","+K+","+U+","+Q+","+$+","+te+","+ae+","+oe+","+ye+","+Math.round(1e3*_e)+","+Se+","+b+","+S+","+I}for(var Me in this.activeSpeaker&&!a.has(this.activeSpeaker)&&this.recvStats[this.activeSpeaker]?this.recordUserId=this.activeSpeaker:this.recordUserId=e,this.subInfo){i[this.subInfo[Me]]++}var Te="{[RECV]},"+i.join(",")+","+n.join(",")+",";if(this.recvStatisticData[(new Date).toUTCString()]=s,this.reportCount%4==0)try{var Re=JSON.stringify(this.recvStatisticData);hi.encodeString(Re,l.TEXT_ENCODING.GZIP_BASE64).then((function(e){mi.globalTrace({logLevel:"log",log:"WCL_WB_VIDEO,"+e}),t.recvStatisticData={}})).catch((function(e){mi.globalTrace({logLevel:"error",log:"WMSC compress video log failed",errorEvent:e}),mi.globalTrace({logLevel:"log",log:"WCL_WB_VIDEO,"+Re}),t.recvStatisticData={}}))}catch(e){mi.globalTrace({logLevel:"error",log:"WMSC video log parse failed",errorEvent:e}),this.recvStatisticData={}}return s[this.recordUserId]?""+Te+s[this.recordUserId]:Te},t._getVideoDecodeLog=function(){if(!this.recvStats[this.recordUserId])return"";var e=this.recvStats[this.recordUserId],t=e.maxDecodeTime,i=e.minDecodeTime,n=e.avgDecodeTime,r=e.codecStats,a=(void 0===r?{}:r).mimeType,s=-1!==(void 0===a?"h264":a).toLowerCase().indexOf("h264")?0:2;return"{[DECO]},"+(1e3*t).toFixed(2)+","+(1e3*i).toFixed(2)+","+(1e3*n).toFixed(3)+",,"+s+","},t._getDownLinkLog=function(){var e=this.recvStats[this.recordUserId]||{},t=e.maxLossRate,i=void 0===t?"":t,n=e.avgLossRate,r=void 0===n?"":n,a=e.stats,s=void 0===a?{}:a,o=e.maxJitter,d=void 0===o?"":o,c=s.packetsLost,u=void 0===c?"":c,l=s.jitter,h=void 0===l?"":l,p=this.downLinkStats,f=p.remoteCandidateStats,m=void 0===f?{}:f,g=p.candidatePairStats,_=void 0===g?{}:g,v=p.beginCandidatePairStats,S=void 0===v?{}:v,b=p.maxRtt,I=m.protocol,C=_.availableIncomingBitrate,y=void 0===C?"":C,E=_.bytesReceived,w=void 0===E?"":E,M=_.timestamp,T=void 0===M?"":M,R=_.totalRoundTripTime,L=void 0===R?"":R,A=_.responsesReceived,D=void 0===A?"":A,P=_.packetsReceived,O=void 0===P?"":P,x=(8*(w-S.bytesReceived)/((T-S.timestamp)/1e3)).toFixed(2),k=Math.round(L/D*1e3)||"";return"RWG_WB_DOWNLINK_NETWORK,"+this.userId+",3,"+("udp"===I?0:1)+","+Math.round(T/1e3)+",,"+y+","+x+","+(100*r).toFixed(2)+","+(100*i).toFixed(2)+",,,,"+k+","+1e3*b+","+O+","+u+",,,,,,,,,"+Math.round(1e3*h)+","+Math.round(1e3*d)},t._getUpLinkLog=function(){var e="";for(var t in this.sendStats){var i=this.sendStats[t]["candidate-pair"]||{},n=this.sendStats[t]["begin-candidate-pair"]||{},r=this.sendStats[t]["remote-candidate"]||{},a=this.sendStats[t]["video-remote-inbound-rtp"]||{},s=i.timestamp,o=i.availableOutgoingBitrate,d=void 0===o?"":o,c=i.bytesSent,u=i.totalRoundTripTime,l=i.responsesReceived,h=i.packetsSent,p=void 0===h?"":h,f=n.timestamp,m=n.bytesSent,g=r.protocol,_=this.sendStats[t].statisticData,v=void 0===_?{}:_,S=isNaN(v.maxRtt)?"":Math.round(1e3*v.maxRtt),b="",I="",C="",y="",E="";for(var w in a){var M=v[w],T=M.maxJitter,R=M.avgLossRate,L=M.maxLossRate,A=a[w],D=A.packetsLost,P=A.jitter;if(T&&!C&&(C=Math.round(1e3*T)),R&&!b&&(b=Math.round(100*R)),L&&!I&&(I=Math.round(100*L)),D&&!y&&(y=D),P&&!E&&(E=Math.round(1e3*P)),b&&I&&C&&y&&E)break}var O=(8*(c-m)/((s-f)/1e3)).toFixed(2),x=Math.round(u/l*1e3)||"";e+=",3,"+("udp"===g?0:1)+","+Math.round(s/1e3)+",,"+d+","+O+","+b+","+I+",,,,"+x+","+S+","+p+","+y+",,,,,,,,,"+E+","+C}return e?"RWG_WB_UPLINK_NETWORK,"+this.userId+e:""},t._getStats=function(){var e=this;try{var t,i,n="WCL_WB_MCM_VIDEO,"+this.userId+",,"+(document.hidden?0:1)+",,",r=this._getVideoReceiveLog(),a=this._getVideoSenderLog(),s=this._getVideoDecodeLog();this.reportCount%2==0&&(t=this._getDownLinkLog(),i=this._getUpLinkLog()),(n+=a+r+s+"{[END]}")&&mi.monitorLog(n),t&&mi.monitorLog(t),i&&mi.monitorLog(i),this.candidatePairMonitorLog=this.candidatePairMonitorLog.map((function(t,i){var n=e.candidatePairLog[i];return t!==n&&mi.monitorLog("WMSC candidate-pair "+i+": "+n+","+e.candidatePairChangeCount[i]),e.candidatePairChangeCount[i]=0,n})),this.bToPrint&&(n&&mi.log("WMSCMonitor._getStats, video log: "+n),t&&mi.log("WMSCMonitor._getStats, downlink log: "+t),i&&mi.log("WMSCMonitor._getStats, uplink log: "+i))}catch(e){mi.addMonitorLog("WMSCLOGRE"),mi.globalTrace({logLevel:"error",log:"WMSCMonitor report error",errorEvent:e})}},t._renderStatsData=function(e,t,i,n,r){var a,s;if(void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),hi.isDebug()){var o=null==(a=this.mIdMgr)?void 0:a.getVideoTag(e),d=(null==(s=this.mIdMgr)?void 0:s.getUserId(e)).userId;if(o){var c,u=o.parentNode;if(!u)return;var l=[{elementId:"m_"+d,value:"Mid: "+e},{elementId:"u_"+d,value:"userId: "+d},{elementId:"f_"+d,value:"FrameRate: "+n},{elementId:"r_"+d,value:"Resolution: "+t+"x"+i},{elementId:"b_"+d,value:"Bitrate: "+(r/1024).toFixed(2)+"kbps"},{elementId:"s_"+d,value:"isSimulcast: "+!!this.isSimulcast},{elementId:"v_"+d,value:"video tag paused: "+!!o.paused},{elementId:"vr_"+d,value:"stream active: "+!(null==o||null==(c=o.srcObject)||!c.active)}],h="wmsc_debug_"+d,p=u.querySelector("#"+h);p||o.insertAdjacentHTML("afterend",'<div id="'+h+'" style="position: absolute; top: 50%; transform: translate(0, -50%); right: 0px; padding-right:3px"></div>'),l.reverse().forEach((function(e){var t=e.elementId,i=e.value,n=u.querySelector("#"+t);n?n.innerText=i:p&&p.insertAdjacentHTML("afterbegin",'<div id="'+t+'" style="color: red; font-size: 12px; text-align: right; margin-right: 5px">'+i+"</div>")}))}}},t.checkSendPCsStat=function(){var e=[],t=this.wmscMediaMgr.sendPCsInfo;for(var i in t){var n,r,a,s,o,d,c,u,h=null==(n=t[i])?void 0:n.pc;if(h&&"connected"===h.connectionState&&this.sendStats[i]){var p=this.sendStats[i]["candidate-pair"]||{},f=this.sendStats[i]["video-outbound-rtp"]||{},m=f[Object.keys(f)[0]]||{},g={peerId:+i};g.bytesSent=p.bytesSent,g.availableOutgoingBitrate=p.availableOutgoingBitrate;var _=parseInt(1e3*(null!=(r=p.currentRoundTripTime)?r:0));g.rtt=_>1e4?1e4:_<0?0:_,g.timestamp=parseInt(null!=(a=m.timestamp)?a:0),g.framerate=m.framesPerSecond,g.frameHeight=m.frameHeight,g.frameWidth=m.frameWidth,g.rtpPacketsSent=m.packetsSent,g.rtpBytesSent=m.bytesSent,g.rtxBytesSent=m.retransmittedBytesSent,g.rtxPacketsSent=m.retransmittedPacketsSent,g.qualityLimitationDurationsBW=parseInt(null!=(s=null==(o=m.qualityLimitationDurations)?void 0:o.bandwidth)?s:0),g.qualityLimitationDurationsCPU=parseInt(null!=(d=null==(c=m.qualityLimitationDurations)?void 0:c.cpu)?d:0),g.qualityLimitationReason=null!=(u=m.qualityLimitationReason)?u:"none";var v=this.lastSendPCsStatRecord.get(i),S=v&&v.bytesSent||0,b=v&&v.timestamp||0;null!=g.bytesSent||(g.bytesSent=0),null!=g.timestamp||(g.timestamp=0);var I=g.timestamp-b||2*l.captureStatsInterval;g.bitrate=g.bytesSent&&parseInt(8e3*(g.bytesSent-S)/I)||0,e.push(g),this.lastSendPCsStatRecord.set(i,g)}}this.sendQoSData(e)},t.sendSdpLog=function(e,t,i){var n,r=this,a=bi.parseSdp(i),s=a.session,o=a.media,d=void 0===o?[]:o,u=s.groups,h=void 0===u?[]:u,p=d[0]||{},f=p.direction,m=void 0===f?"":f,g=p.codecs,_=void 0===g?[]:g,v=p.extensionMap,S=p.bandwidth,b=p.candidates,I=new Array(4).fill(-1),C=[],y={},E="WCL_WB_SDP_"+t+","+this.userId+","+e+","+((null==(n=h[0])?void 0:n.ids.length)||0)+","+this.sdpDirection[m]+",";if(v)for(var w,M=c(v);!(w=M()).done;){var T=w.value,R=T[0],L=T[1].uri,A=this.rtpHeaderExt[L];void 0!==A&&(I[A]=R)}E+=I.join(",")+",",_.forEach((function(e){var t=e.codecName,i=e.codecParams,n=e.payloadType,r=e.associatedPayloadType,a=void 0===r?"":r;"H264"===t&&i?"1"===i.get("packetization-mode")&&(C.push(n),C.push(i.get("profile-level-id")),C.push(i.get("max-mbps")||""),C.push(i.get("max-fs")||""),C.push(i.get("x-google-start-bitrate")||""),C.push(i.get("x-google-max-bitrate")||""),C.push(i.get("x-google-min-bitrate")||"")):"rtx"===t&&(y[a]=n)}));for(var D=0,P=C.length;D<P;D+=7){var O=C[D];E+=O+","+C[D+1]+","+C[D+2]+","+C[D+3]+","+C[D+4]+","+C[D+5]+","+C[D+6]+","+y[O]+","}d.forEach((function(e){var t=e.ssrcGroups,i=e.mid;t.forEach((function(e){var t=e.semantics,n=e.ssrcs;"FID"===t&&(r.ssrcMidMap[n[0]]=i,E+=n.join(",")+",")}))})),E+=(S||"")+",",b&&b.length>0&&b.forEach((function(e){var t=e.transport,i=e.address,n=e.port,r=e.priority;E+=r+","+("udp"===t?0:1)+","+i+","+n+","})),mi.monitorLog(E);try{hi.encodeString(i,l.TEXT_ENCODING.GZIP_BASE64).then((function(i){mi.globalTrace({logLevel:"log",log:"WCL_WB_SDP-"+e+"-"+t+"-"+i})}))}catch(n){mi.globalTrace({logLevel:"error",log:"WMSC compress sdp log failed",errorEvent:n}),mi.globalTrace({logLevel:"log",log:"WCL_WB_SDP-"+e+"-"+t+"-"+i})}},t._getCandidatePairLog=function(e){var t=e.localCandidateId,i=e.remoteCandidateId,n=e.nominated,r=e.state,a=e.priority;return(void 0===a?"":a)+","+t+","+i+","+this.iceCandidatePairState[r]+","+(n?1:0)+","},t._getCandidateLog=function(e){var t=e.id,i=e.candidateType,n=e.port,r=e.priority,a=e.protocol,s=e.type,o=e.networkType;return t+","+r+","+a+","+i+","+n+","+(void 0===o?"":o)+","+("remote-candidate"===s?1:0)+","},t.onReceiverReport=function(e){var t=this.ingressReport,i=t.begin,n=t.current;this.ingressReport.prev=n,this.ingressReport.current=e,i||(this.ingressReport.begin=n)},e}());window.PS=function(e){zi.bToPrint=!!e};var Gi={sendResolutionLowerLimit:l.RES_90p,sendResolutionUpperLimit:l.RES_1080p,recvVideoNumLowerLimit:l.MIN_RECEV_VIDEO_NUM,recvVideoNumUpperLimit:l.MAX_RECEV_VIDEO_NUM},ji=new(function(){function e(){this.sendResolutionLowerLimit=Gi.sendResolutionLowerLimit,this.sendResolutionUpperLimit=Gi.sendResolutionUpperLimit,this.recvVideoNumLowerLimit=Gi.recvVideoNumLowerLimit,this.recvVideoNumUpperLimit=Gi.recvVideoNumUpperLimit,this.maxSendResolution=0,this.maxRecvVideoNum=0,this.hardwareConcurrency=navigator.hardwareConcurrency||1,this._init()}var t=e.prototype;return t._init=function(){var e;u.ios&&(this.recvVideoNumLowerLimit=10),e=u.ios||this.hardwareConcurrency>=8?l.RES_1080p:this.hardwareConcurrency>=4?l.RES_720p:l.RES_360p;var t=Math.floor(1.5*this.hardwareConcurrency);this.maxSendResolution=Math.max(this.sendResolutionLowerLimit,Math.min(this.sendResolutionUpperLimit,e)),this.maxRecvVideoNum=Math.max(this.recvVideoNumLowerLimit,Math.min(this.recvVideoNumUpperLimit,t))},t.setLimits=function(e){var t=e.minSendResolution,i=e.maxSendResolution,n=e.minRecvVideoNum,r=e.maxRecvVideoNum;void 0!==t&&(this.sendResolutionLowerLimit=t),void 0!==i&&(this.sendResolutionUpperLimit=i),void 0!==n&&(this.recvVideoNumLowerLimit=n),void 0!==r&&(this.recvVideoNumUpperLimit=r)},t.getCapabilities=function(){return{maxSendResolution:this.maxSendResolution,maxRecvVideoNum:this.maxRecvVideoNum}},e}()),Hi=l.MIN_SEND_PC_ID,Zi=l.MIN_SEND_PC_ID+l.MAX_SEND_PC_NUM-1,qi=l.MAX_PC_RECONNECT_COUNT,Yi=l.NEGOTIATION_TIMEOUT,Ki=function(){function e(e,t){var i=e||{};i.userId=i.nodeId,zi.setUserId(i.userId),Ci.setUserId(i.userId),i.maxCaptureResolution=Math.max(l.RES_720p,Math.min(i.maxCaptureResolution||0,l.RES_1080p)),ji.setLimits({maxSendResolution:i.maxCaptureResolution,maxRecvVideoNum:i.maxVideoReceiveNum});var n=ji.getCapabilities().maxRecvVideoNum;this.recvVideoNum=n,i.recvPeerId=0,i.maxSendPeerId=i.recvPeerId+l.MAX_SEND_PC_NUM,this.recvPCStatus={peerId:i.recvPeerId,status:0,size:this.recvVideoNum,reconnectionCount:0,negotiationTimer:0},this.sendPCStatus=[];for(var r=l.VIDEO_SCALES[i.maxCaptureResolution],a=Hi;a<=Zi;a++){var s=a-Hi;this.sendPCStatus.push({peerId:a,sIndex:s,scale:r[s],status:0,size:1,reconnectionCount:0,negotiationTimer:0})}this.config=i,this._toCaller=t,this.resetRunTimeParams(),mi.log("WmscApiImpl created, config="+JSON.stringify(this.config)),Ci.setupCallBack(this.onMediaMgrMessage.bind(this)),this.startRecevVideo(),zi.start(),this.recevCSRCRecrod=new Map,zi.setQoSDataCb(this.sendQoSData.bind(this)),this.sendMonitorLog("WMSC instance created")}var t=e.prototype;return t.destroy=function(){this.closeAllPeerConnections(),this.resetRunTimeParams(),this.recevCSRCRecrod.forEach((function(e){clearInterval(e)})),null==zi||zi.stop()},t.resetRunTimeParams=function(){mi.log("WmscApiImpl reset run time parameters"),this.recvPCStatus.status=l.PC_STATE_IDLE,this.sendPCStatus.forEach((function(e){e.status=l.PC_STATE_IDLE})),this.bActiveVideo=!1,this.bPrevActiveVideo=!1,this.camStreams=null,this.bSendEnabled=!1,this.bReceiveEnabled=!1,this.lastSubList=Array(this.sendPCStatus.length).fill(!1),this._toSubscribeBuffer=[],this._videoTagMappingBuffer=new Map,this.mIdMgr=null},t.startRecevVideo=function(){var e=a(n().mark((function e(){var t,i;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.bReceiveEnabled=!0,mi.log("WmscApiImpl.startRecevVideo with max recv number: "+this.recvVideoNum),this.sendMonitorLog("Start receiving video"),(t=this.recvPCStatus).status){e.next=14;break}return t.status=l.PC_STATE_CONNECTING,e.next=8,this.createPeerConnection(t,l.MEDIA_TYPE.VIDEO,l.TRANSCEIVER_DIRECTION.RECV_ONLY);case 8:if(!(i=e.sent)){e.next=11;break}return e.abrupt("return",this.startNegotiation(t.peerId));case 11:return e.abrupt("return",i);case 14:if(t.status!==l.PC_STATE_CONNECTED){e.next=16;break}return e.abrupt("return",!1);case 16:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.stopReceiveVideo=function(){var e=this.recvPCStatus.peerId;this.sendMonitorLog("Stop receiving video"),this.recvPCStatus.status=l.PC_STATE_IDLE,this.sendBye(e),this.closePeerConnection(e),this.mIdMgr=null,this.bReceiveEnabled=!1},t.createPeerConnection=function(e,t,i){var n=this.config.serverAddr,r=e.peerId,a=e.size;return mi.log("WmscApiImpl.createPeerConnection, type: "+t+" direction: "+i),Ci.getNewPeerConnection(n,r,t,i,a)},t.onVideoStreamsAsync=function(){var e=a(n().mark((function e(t){var i,r,a,s;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=t&&t.length){e.next=7;break}return mi.log("WmscApiImpl.onVideoStreamsAsync, stream is empty, stop sending video."),this.sendMonitorLog("Stop sending video"),this.bSendEnabled=!1,this.stopSendingVideo(),hi.stopMediaStreams(this.camStreams),e.abrupt("return",Promise.resolve(!0));case 7:return r=this.config.maxCaptureResolution||l.RES_720p,e.next=10,Ci.createVideoArray(r,t);case 10:if(null==(a=e.sent)||null==(i=a.streams)||!i.length){e.next=19;break}return s=this.camStreams,this.camStreams=a.streams,s&&(this.sendMonitorLog("on new local video stream"),hi.stopMediaStreams(s)),this.bSendEnabled=!0,e.abrupt("return",Promise.resolve(!0));case 19:if(null==a||!a.errorMsg){e.next=22;break}return this.sendMonitorLog("Failed to create video array, "+a.errorMsg),e.abrupt("return",Promise.reject(a.errorMsg));case 22:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.addVideo2PC=function(e,t,i,n){return Ci.addVideo2PC(e,t,i,n)},t.startNegotiation=function(e){var t=this,i=this._getPCStatus(e);if(i)return i.negotiationTimer=setTimeout((function(){i.reconnectionCount<qi?t.restartNegotiation(i):t._toCaller({type:fi.SDP_NEGOTIATION_FAIL,data:e})}),Yi),Ci.startNegotiation(e)},t.restartNegotiation=function(){var e=a(n().mark((function e(t){var i,r;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.reconnectionCount+=1,i=t.peerId,r=t.reconnectionCount,this.sendMonitorLog("Restart Negotiation, peerId: "+i+" count: "+r),this.sendBye(i),this.closePeerConnection(i),0!==i||!this.bReceiveEnabled){e.next=9;break}this.startRecevVideo(),e.next=14;break;case 9:return t.status=l.PC_STATE_CONNECTING,e.next=12,this.createPeerConnection(t,l.MEDIA_TYPE.VIDEO,l.TRANSCEIVER_DIRECTION.SEND_ONLY);case 12:this.addVideo2PC(t.peerId,this.camStreams,i-Hi,t.scale),this.startNegotiation(t.peerId);case 14:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.closePeerConnection=function(e){var t=this._getPCStatus(e);if(t)return clearTimeout(t.negotiationTimer),t.status=l.PC_STATE_IDLE,Ci.closePeerConnection(e)},t.closeAllPeerConnections=function(){var e=this;this.closePeerConnection(this.recvPCStatus.peerId),this.sendPCStatus.forEach((function(t){e.closePeerConnection(t.peerId)}))},t.updateSenderParam=function(e){return Ci.updateSenderParam(e)},t.onMediaMgrMessage=function(e,t,i){mi.log("WmscApiImpl.onMessageFromMediaMgr: peerId= "+e+", type= "+t);var n=l.MediaMgrMsgType;switch(t){case n.STREAM:this._handlePCOnStream(e,i);break;case n.SDP:this._handlePCSdp(e,i);break;case n.PCSTATUSCHANGE:this._handlePCStatusChange(e,i);break;case n.ERROR:mi.error("WmscApiImpl.onMessageFromMediaMgr, receive error:  "+i.error);break;default:mi.error("WmscApiImpl.onMessageFromMediaMgr, unknown type: "+t)}},t.onVideoTagMapping=function(e){var t,i=parseInt(e.userId),n=e.videodom,r=e.action;if(this.sendMonitorLog("Receive video tag mapping, user: "+i+" action: "+r),"remove"!==r)return n.setAttribute("autoplay",""),n.setAttribute("muted",""),n.setAttribute("playsinline",""),mi.log("WmscApiImpl.onVideoTagMapping, userId: "+i),this.mIdMgr?(this.mIdMgr.saveVideoTag(i,n),this._toCaller({type:fi.VIDEO_TAG_MAPPED,data:i}),!0):(mi.warn("WmscApiImpl.onVideoTagMapping, mIdMgr not ready yet. Will do mapping later."),this._videoTagMappingBuffer.set(i,n),!0);null==(t=this.mIdMgr)||t.removeVideoTag(i,n)},t._mapBufferedVideoTag=function(){var e=this;this._videoTagMappingBuffer.size&&(this._videoTagMappingBuffer.forEach((function(t,i){e.onVideoTagMapping({userId:i,videodom:t})})),this._videoTagMappingBuffer.clear())},t.subscribeVideo=function(e){var t,i;if(this.recvPCStatus.status!==l.PC_STATE_CONNECTED)return this._toSubscribeBuffer.push({param:e,toSub:!0}),mi.warn("WmscApiImpl.SubscribeVideo, pc is not ready yet, will re-do subscribe later."),!1;var n=e.size,r=parseInt(e.id);if(this.sendMonitorLog("SubscribeVideo, userId: "+r+" size: "+n),!r)return!1;var a=(null==(t=this.mIdMgr)?void 0:t.getMId(r))||(null==(i=this.mIdMgr)?void 0:i.getNewMId(r));return a?(this._sendStreamMapping(this.recvPCStatus.peerId,r,a,n),this.mIdMgr.setVideoSize(a,n),this._updateVideoElement(r,a),zi.resetRecvStats(r),mi.log("WmscApiImpl.SubscribeVideo, subscribe to user: "+r+" size: "+n),!0):(mi.error("WmscApiImpl.SubscribeVideo, no more mId or rx peerConnetion not ready."),!1)},t.unSubscribeVideo=function(e){var t,i=parseInt(e.userId);if(this._videoTagMappingBuffer.delete(i),clearInterval(this.recevCSRCRecrod.get(i)),this.recvPCStatus.status!==l.PC_STATE_CONNECTED)return this._toSubscribeBuffer.push({param:e,toSub:!1}),mi.warn("WmscApiImpl.unSubscribeVideo, pc is not ready yet, will re-do unSubscribe later."),!1;var n=null==(t=this.mIdMgr)?void 0:t.getMId(i);return n&&(this.sendMonitorLog("UnSubscribeVideo, userId: "+i),this._sendStreamMapping(this.recvPCStatus.peerId,0,n),this.mIdMgr.releaseMId(n),this.recevCSRCRecrod.delete(i),mi.log("WmscApiImpl.unSubscribeVideo, userId: "+i+" mId: "+n)),!0},t.onRWGMessage=function(e){var t="string"==typeof e.data?JSON.parse(e.data):e.data;return mi.log("Receive msg from RWG, type: "+t.evt),t.evt===_i.WS_WEBRTC_MEDIA_NEGOTIATION?this.onWebRTCMediaNegotiationMSg(t.body):t.evt===_i.WS_WEBRTC_MEDIA_ACTION?this.onWebRTCMediaActionMSg(t.body):void 0},t.onWebRTCMediaNegotiationMSg=function(e){switch(this.sendMonitorLog("Receive WebRTC media negotiation Msg, type: "+e.type),e.type){case _i.SDP_ANSWER:return mi.log("WmscApiImpl on SDP_ANSWER"),this.onAnswer(e),!0;case _i.SDP_BYE:return mi.log("WmscApiImpl on SDP_BYE"),this.onPCBye(e),!0;default:return mi.warn("Received unknown RWG message type: "+e.type),!1}},t.onWebRTCMediaActionMSg=function(e){switch(e.type){case _i.SUBSCRIBE_LIST:return mi.log("WmscApiImpl on SUBSCRIBE_LIST"),this.onSubscribeList(e.activeVideo,e.prevActiveVideo,e.privateVideo),!0;case _i.CMD:return mi.log("WmscApiImpl on CMD"),this.onMCCReq(e),!0;default:return mi.warn("Received unknown RWG message type: "+e.type),!1}},t.onAnswer=function(e){if(void 0===e.sdpEncoding||e.sdpEncoding===l.TEXT_ENCODING.PLAIN)return zi.sendSdpLog(e.peerID,"ANWSER",e.sdp),Ci.onServerMsg(e.peerID,e);hi.decodeString(e.sdp,e.sdpEncoding).then((function(t){return e.sdp=t,zi.sendSdpLog(e.peerID,"ANWSER",t),Ci.onServerMsg(e.peerID,e)}))},t.onPCBye=function(e){this.closePeerConnection(e.peerID)},t.onSubscribeList=function(e,t,i){var n=this;if(this.sendMonitorLog("OnSubscribeList: "+e+" "+t+" "+i),this.bSendEnabled)if(null!=e&&e.length||null!=t&&t.length||null!=i&&i.length){zi.updateSubscribedSize(e,t,i),mi.log("WmscApiImpl.onSubscribeList, "+e+" "+t+" "+i);var r=this._getSubList([e,t,i]);this._compareSubList(r)?(mi.log("WmscApiImpl.onSubscribeList "+JSON.stringify(r)),clearTimeout(this.subScribeListTimerId),this.subScribeListTimerId=setTimeout((function(){n.subScribeListTimerId=0,n.actionOnSubscribeList(r)}),1e3)):mi.log("WmscApiImpl.onSubscribeList subList was not change, do nothing.")}else mi.error("WmscApiImpl.onSubscribeList invalid parameters");else mi.warn("WmscApiImpl.onSubscribeList client didnt start sending video yet.")},t.actionOnSubscribeList=function(e){var t=this;if(mi.log("WmscApiImpl.onSubscribeList "+JSON.stringify(e)),clearTimeout(this.waitingCamCaptureReadyId),this.waitingCamCaptureReadyId=0,this.camStreams.length<this.sendPCStatus.length)this.waitingCamCaptureReadyId=setTimeout((function(){t.waitingCamCaptureReadyId=0,t.actionOnSubscribeList(e)}),1e3);else if(e.some((function(e){return e}))){if(!1===this.config.HDVideo)for(var i=3;i<e.length;i++)e[i]&&(e[i]=!1,e[2]=!0);for(var r=!1,s=e.length-1;s>=0;s--)r?e[s]=!0:r=e[s];(function(){return o.apply(this,arguments)}).call(this)}else this.closeSendPCs();function o(){return(o=a(n().mark((function t(){var i,r;return n().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.bSendEnabled){t.next=2;break}return t.abrupt("return");case 2:this.sendMonitorLog("Action onSubscribeList, "+e),i=0;case 4:if(!(i<e.length)){t.next=19;break}if(r=this.sendPCStatus[i],!e[i]){t.next=15;break}if(r.status!==l.PC_STATE_IDLE){t.next=13;break}return r.status=l.PC_STATE_CONNECTING,t.next=11,this.createPeerConnection(r,l.MEDIA_TYPE.VIDEO,l.TRANSCEIVER_DIRECTION.SEND_ONLY);case 11:this.addVideo2PC(r.peerId,this.camStreams,i,r.scale),this.startNegotiation(r.peerId);case 13:t.next=16;break;case 15:e[i]||r.status&&(this.closePCs(r.peerId),r.status=l.PC_STATE_IDLE);case 16:i++,t.next=4;break;case 19:case"end":return t.stop()}}),t,this)})))).apply(this,arguments)}},t.onActiveVideoSourceChange=function(e){mi.log("WmscApiImpl.onActiveVideoSourceChange: data = "+JSON.stringify(e));var t=parseInt(this.config.userId)===parseInt(e.userId);return this.bPrevActiveVideo=this.bActiveVideo&&!t,this.bActiveVideo=t,zi.setActiveSpeaker(e.userId,this.bPrevActiveVideo),mi.monitorLog("onActiveSpeakerChangeto: "+e.userId),!0},t.onMCCReq=function(e){return Ci.onMCCReq(e)},t.updateWMSCParams=function(e){var t=this;mi.log("WmscApiImpl.updateWMSCParams: data = "+JSON.stringify(e)),Object.keys(e).forEach((function(i){switch(i){case"HDVideo":t.config.HDVideo=e[i];break;default:mi.warn("WmscApiImpl.updateWMSCParams: unknown param name: "+i)}}))},t.closeSendPCs=function(){var e,t=this;null==(e=this.sendPCStatus)||e.forEach((function(e){e.status&&(t.closePCs(e.peerId,1),e.status=l.PC_STATE_IDLE)}))},t.closePCs=function(e,t){if(void 0===t&&(t=1),mi.log("WmscApiImpl.closeSendPeerConnedtion stPeerId= "+e+" size= "+t),e<=0)this.sendBye(e),this._videoTagMappingBuffer.clear(),this._toSubscribeBuffer=[],this.closePeerConnection(e);else for(var i=e;i<e+t;i++)this.sendBye(i),this.closePeerConnection(i)},t.sendBye=function(e){if(this.recvPCStatus.peerId===e)this.recvPCStatus.bsRecording&&(this.sendRecordingReq(e),this.recvPCStatus.bsRecording=!1);else for(var t=this.sendPCStatus,i=0;i<t.length;i++)if(t[i].peerId===e&&t[i].bsRecording){t[i].bsRecording=!1,this.sendRecordingReq(e);break}var n=this.config,r=n.confId,a=n.userId,s=gi.byeSdp(r,l.VIDEO_SESSION,a,e,"");mi.addMonitorLog("WMSCSDPBYE-"+r+"-"+e),this._sendMsgtoRWGBySDK({evt:_i.WS_WEBRTC_MEDIA_NEGOTIATION,body:s})},t.stopSendingVideo=function(){var e=this;this.sendMonitorLog("Stop sending video"),this.sendPCStatus.forEach((function(t){t.status=l.PC_STATE_IDLE,e.sendBye(t.peerId)})),Ci.stopSendingVideo()},t.sendRecordingReq=function(e,t,i){var n=this.config,r=n.confId,a=n.userId,s=n.sessionId,o=t?i?_i.CMD_PARAM.CMD_BIT_STREAM_LOAD:_i.CMD_PARAM.CMD_BIT_STREAM_RECORD:_i.CMD_PARAM.CMD_NONE,d=gi.bitstreamRecord(r,s,a,e,o,t);this._sendMsgtoRWGBySDK({evt:_i.WS_WEBRTC_MEDIA_ACTION,body:d})},t._sendStreamMapping=function(e,t,i,n){mi.log("WmscApiImpl._sendStreamMapping,peerId: "+e+" userId: "+t+" mID: "+i),this.sendMonitorLog("Send stream mapping, userId: "+t+" size: "+n+" mId: "+i);var r=this.config.confId;zi.updateSubInfo(t,i,n);var a=gi.streamMapping(r,l.VIDEO_SESSION,t,e,t,i,n);this._toCaller({type:fi.WMSC_MAPPING_STREAMID_AND_MID,data:JSON.stringify({evt:_i.WS_WEBRTC_MEDIA_ACTION,body:a})})},t._sendMsgtoRWGBySDK=function(e){this._toCaller({type:fi.WMSC_MESSAGE_TO_RWG_BY_SDK,data:JSON.stringify(e)})},t._handlePCOnStream=function(e,t){var i,n;if(e===this.recvPCStatus.peerId){var r=new MediaStream;r.addTrack(t.track);var a=t.transceiver.mid;null==(i=this.mIdMgr)||i.updateStream(a,r);var s=null==(n=this.mIdMgr)?void 0:n.getVideoTag(a);if(!s)return mi.log("WmscApiImpl._handlePCOnStream, video element is not mapped yet, mid= "+a),!1;s.srcObject=r}else mi.warn("WmscApiImpl._handlePCOnStream, peerId= "+e+" for sending should not be here")},t._handlePCSdp=function(e,t){var i=this;if(mi.log("WmscApiImpl._handlePCSdp sdp: peerId= "+e+" description= "+t.description),t.description&&/offer/i.test(t.description.type)){var n=this.config,r=t.description.sdp;if(e===this.recvPCStatus.peerId){var a=r.match(/a=group:BUNDLE (.+)/),s=a&&a.length>1&&a[1].split(" ");null!=s&&s.length?(this.mIdMgr=this.mIdMgr||new Ei(s),this._mapBufferedVideoTag()):(mi.error("WmscApiImpl._handlePCSdp could not get receive mid from local offer"),this.mIdMgr=new Ei([]),mi.warn("WmscApiImpl._handlePCSdp midMgr was initialized as empty")),zi.mIdMgr=this.mIdMgr}mi.log("WmscApiImpl._handlePCSdp offer sdp= "+r),zi.sendSdpLog(e,"OFFER",r),gi.offerSdp(n.confId,l.VIDEO_SESSION,n.userId,e,r).then((function(e){i._sendMsgtoRWGBySDK({evt:_i.WS_WEBRTC_MEDIA_NEGOTIATION,body:e})}))}},t._handlePCStatusChange=function(e,t){if(/^connected/i.test(t))if(e===this.recvPCStatus.peerId){for(clearTimeout(this.recvPCStatus.negotiationTimer),this.recvPCStatus.status=l.PC_STATE_CONNECTED,this.recvPCStatus.reconnectionCount=0,this.recvPCStatus.negotiationTimer=0,mi.log("WmscApiImpl._handlePCStatusChange: peerId= "+e+" connected"),this._reSubVideo();this._toSubscribeBuffer.length;){var i=this._toSubscribeBuffer.shift();i.toSub?this.subscribeVideo(i.param):this.unSubscribeVideo(i.param)}this._toCaller({type:fi.V_RECEV_PC_CONNECTED,data:e})}else{var n=this.sendPCStatus;if(n)for(var r=0;r<n.length;r++)if(n[r].peerId===e){clearTimeout(n[r].negotiationTimer),n[r].status=l.PC_STATE_CONNECTED,n[r].negotiationTimer=0,n[r].reconnectionCount=0,mi.log("WmscApiImpl._handlePCStatusChange: peerId= "+e+" connected"),this._toCaller({type:fi.V_SEND_PC_CONNECTED,data:e});break}}else if(/disconnected/i.test(t)){this.sendMonitorLog("PC disconnected, peerId: "+e+", will try reconnect");var a=this._getPCStatus(e);if(mi.warn("WmscApiImpl._handlePCStatusChange, pc disconnected, peerId = "+e+", will try reconnect"),!a)return;this.restartNegotiation(a)}else if(/fail/i.test(t)){this.sendMonitorLog("PC connect failed, peerId: "+e);var s=this._getPCStatus(e);if(!s)return;s.reconnectionCount<qi?this.restartNegotiation(s):this._toCaller({type:fi.SDP_NEGOTIATION_FAIL,data:e}),mi.error("WmscApiImpl._handlePCStatusChange, peerconnection failed, peerId = "+e)}},t._getSubList=function(e){var t=this.sendPCStatus.length,i=Array(t).fill(!1);return e.forEach((function(e){e.forEach((function(e){e>=0&&e<t?i[parseInt(e)]=!0:e>=t&&(i[t-1]=!0)}))})),i},t._compareSubList=function(e){for(var t=0;t<e.length;t++)if(this.lastSubList[t]!==e[t])return this.lastSubList=e,!0;return!1},t._reSubVideo=function(){var e=this.mIdMgr.mIdUsedStatus,t=this.recvPCStatus.peerId;for(var i in e)if(e[i].used&&e[i].userId){var n=e[i],r=n.userId,a=n.videoSize;this._sendStreamMapping(t,r,i,a),this._updateVideoElement(r,i)}},t._updateVideoElement=function(e,t){var i=this,n=Ci.getPCEntry(this.config.recvPeerId).pc;if(n){clearInterval(this.recevCSRCRecrod.get(e));var r=setInterval((function(){var r=hi.getReceiverByMid(n,t);if(r){var a=r.getContributingSources()[0],s=parseInt(null==a?void 0:a.source)||0;s>>2==e>>2&&(mi.log("WmscApiImpl._updateVideoElement, streamId: "+s+", userId: "+e),clearInterval(i.recevCSRCRecrod.get(e)),i.mIdMgr.updateVideoElement(t),i._toCaller({type:fi.VIDEO_SOURCE_UPDATED,userId:e}))}else clearInterval(i.recevCSRCRecrod.get(e))}),200);this.recevCSRCRecrod.set(e,r)}},t._getPCStatus=function(e){if(e===this.recvPCStatus.peerId)return this.recvPCStatus;for(var t=0;t<this.sendPCStatus.length;t++){var i;if(e===(null==(i=this.sendPCStatus[t])?void 0:i.peerId))return this.sendPCStatus[t]}return null},t.sendQoSData=function(e){var t=JSON.stringify(e),i=this.config,n=i.confId,r=i.sessionId,a=i.userId,s=gi.congestReportCmdMsg(n,r,a,_i.CMD_PARAM.STREAM_CONGEST_REPORT,t),o={evt:_i.WS_WEBRTC_MEDIA_ACTION,body:s};this._sendMsgtoRWGBySDK(o)},t.sendMonitorLog=function(e){mi.monitorLog("WCL_WMSC_EVENT, "+e)},e}(),Ji=l.MAX_PC_RECONNECT_COUNT,Qi=l.NEGOTIATION_TIMEOUT,Xi=function(){function e(e,t){mi.log("WmscApiImpl created, config: "+JSON.stringify(e)),wi.setConfig(e||{}),ji.setLimits({maxRecvVideoNum:wi.maxRecvVideoNum});var i=ji.getCapabilities().maxRecvVideoNum;this.recvPCStatus={peerId:wi.recvPeerId,status:l.PC_STATE_IDLE,size:i,reconnectionCount:0,negotiationTimer:0},this.sendPCStatus={peerId:wi.sendPeerId,status:l.PC_STATE_IDLE,size:1,reconnectionCount:0,negotiationTimer:0},this._toCaller=t,this.resetRunTimeParams(),Ui.setupCallBack(this.onMediaMgrMessage.bind(this)),Ui.enableHdVideo(wi.hdVideoEnabled),Ui.setVideoSettings(wi.videoSettings||{}),Fi.setOptions(wi.qosOptions||{}),this.renewPeerConnectionForSend(),this.startRecevVideo(),zi.setUserId(wi.nodeId),zi.setSimulcast(wi.simulcastEnabled),zi.start(),this.recevCSRCRecord=new Map}var t=e.prototype;return t.destroy=function(){this.closeAllPeerConnections(),this.resetRunTimeParams(),this.recevCSRCRecord.forEach((function(e){clearInterval(e)})),null==zi||zi.stop()},t.resetRunTimeParams=function(){mi.log("WmscApiImpl reset run time parameters"),this.sendPCStatus.status=l.PC_STATE_IDLE,this.camStreams=null,this.bSendEnabled=!1,this.bActiveVideo=!1,this.bPrevActiveVideo=!1,this.lastSubList=[],this.recvPCStatus.status=l.PC_STATE_IDLE,this.bReceiveEnabled=!1,this._toSubscribeBuffer=[],this._videoTagMappingBuffer=new Map,this.mIdMgr=null},t.renewPeerConnectionForSend=function(){var e=a(n().mark((function e(){var t;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.sendPCStatus,this.createPeerConnection(t,l.MEDIA_TYPE.VIDEO,l.TRANSCEIVER_DIRECTION.SEND_ONLY),this.camStreams&&this._addVideoStreams(this.camStreams),this.bSendEnabled=!0,e.abrupt("return",this.startNegotiation(t.peerId));case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t._addVideoStreams=function(){var e=a(n().mark((function e(t){var i,r;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return null!=t&&t.length&&(i=null==(r=t[0].stream)?void 0:r.getVideoTracks()[0]),e.next=3,Ui.publishVideoTrack(i);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),t.startRecevVideo=function(){var e=a(n().mark((function e(){var t,i;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.bReceiveEnabled=!0,mi.log("WmscApiImpl.startRecevVideo with max recv number: "+this.recvPCStatus.size),this.sendMonitorLog("Start receiving video"),(t=this.recvPCStatus).status){e.next=12;break}if(t.status=l.PC_STATE_CONNECTING,!(i=this.createPeerConnection(t,l.MEDIA_TYPE.VIDEO,l.TRANSCEIVER_DIRECTION.RECV_ONLY))){e.next=9;break}return e.abrupt("return",this.startNegotiation(t.peerId));case 9:return e.abrupt("return",i);case 12:if(t.status!==l.PC_STATE_CONNECTED){e.next=14;break}return e.abrupt("return",!1);case 14:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.stopReceiveVideo=function(){var e=this.recvPCStatus.peerId;this.sendMonitorLog("Stop receiving video"),this.recvPCStatus.status=l.PC_STATE_IDLE,this.sendBye(e),this.closePeerConnection(e),this.mIdMgr=null,this.bReceiveEnabled=!1},t.createPeerConnection=function(e,t,i){var n=e.peerId,r=e.size;return mi.log("WmscApiImpl.createPeerConnection, type: "+t+" direction: "+i),Ui.getNewPeerConnection(n,t,i,r)},t.onVideoStreamsAsync=function(){var e=a(n().mark((function e(t){var i;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=[],t.forEach((function(e){var t;i.push({stream:null==(t=e.stream)?void 0:t.clone()})})),e.next=4,this._addVideoStreams(i);case 4:return hi.stopMediaStreams(this.camStreams),this.camStreams=i.length?i:null,e.abrupt("return",Promise.resolve(!0));case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.startNegotiation=function(e){var t=this,i=this._getPCStatus(e);if(i)return i.negotiationTimer=setTimeout((function(){i.reconnectionCount<Ji?t.restartNegotiation(i):t._toCaller({type:fi.SDP_NEGOTIATION_FAIL,data:e})}),Qi),Ui.startNegotiation(e)},t.restartNegotiation=function(){var e=a(n().mark((function e(t){var i,r;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.reconnectionCount+=1,i=t.peerId,r=t.reconnectionCount,this.sendMonitorLog("Restart Negotiation, peerId: "+i+" count: "+r),this.sendBye(i),this.closePeerConnection(i),0!==i||!this.bReceiveEnabled){e.next=9;break}this.startRecevVideo(),e.next=12;break;case 9:return e.next=11,this.renewPeerConnectionForSend();case 11:Ui.onMediaRequest(this.lastSubList);case 12:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.closePeerConnection=function(e){var t=this._getPCStatus(e);if(t)return clearTimeout(t.negotiationTimer),t.status=l.PC_STATE_IDLE,Ui.closePeerConnection(e)},t.closeAllPeerConnections=function(){this.closePeerConnection(this.recvPCStatus.peerId),this.closePeerConnection(this.sendPCStatus.peerId)},t.onMediaMgrMessage=function(e,t,i){mi.log("WmscApiImpl.onMessageFromMediaMgr, peerId: "+e+" type: "+t);var n=l.MediaMgrMsgType;switch(t){case n.STREAM:this._handlePCOnStream(e,i);break;case n.SDP:this._handlePCSdp(e,i);break;case n.PCSTATUSCHANGE:this._handlePCStatusChange(e,i);break;case n.ERROR:mi.error("WmscApiImpl.onMessageFromMediaMgr, receive error: "+i.error);break;default:mi.error("WmscApiImpl.onMessageFromMediaMgr, unknown type: "+t)}},t.onVideoTagMapping=function(e){var t,i=parseInt(e.userId),n=e.videodom,r=e.action;if(this.sendMonitorLog("Receive video tag mapping, user: "+i+" action: "+r),"remove"!==r)return n.setAttribute("autoplay",""),n.setAttribute("muted",""),n.setAttribute("playsinline",""),mi.log("WmscApiImpl.onVideoTagMapping, userId: "+i),this.mIdMgr?(this.mIdMgr.saveVideoTag(i,n),this._toCaller({type:fi.VIDEO_TAG_MAPPED,data:i}),!0):(mi.warn("WmscApiImpl.onVideoTagMapping, mIdMgr not ready yet. Will do mapping later."),this._videoTagMappingBuffer.set(i,n),!0);null==(t=this.mIdMgr)||t.removeVideoTag(i,n)},t._mapBufferedVideoTag=function(){var e=this;this._videoTagMappingBuffer.size&&(this._videoTagMappingBuffer.forEach((function(t,i){e.onVideoTagMapping({userId:i,videodom:t})})),this._videoTagMappingBuffer.clear())},t.subscribeVideo=function(e){var t,i;if(this.recvPCStatus.status!==l.PC_STATE_CONNECTED)return this._toSubscribeBuffer.push({param:e,toSub:!0}),mi.warn("WmscApiImpl.SubscribeVideo, pc is not ready yet, will re-do subscribe later."),!1;var n=e.size,r=parseInt(e.id);if(this.sendMonitorLog("SubscribeVideo, userId: "+r+" size: "+n),!r)return!1;var a=(null==(t=this.mIdMgr)?void 0:t.getMId(r))||(null==(i=this.mIdMgr)?void 0:i.getNewMId(r));return a?(this._sendStreamMapping(this.recvPCStatus.peerId,r,a,n),this.mIdMgr.setVideoSize(a,n),this._updateVideoElement(r,a),zi.resetRecvStats(r),mi.log("WmscApiImpl.SubscribeVideo, subscribe to user: "+r+" size: "+n),!0):(mi.error("WmscApiImpl.SubscribeVideo, no more mId or rx peerConnetion not ready."),!1)},t.unSubscribeVideo=function(e){var t,i=parseInt(e.userId);if(this._videoTagMappingBuffer.delete(i),clearInterval(this.recevCSRCRecord.get(i)),this.recvPCStatus.status!==l.PC_STATE_CONNECTED)return this._toSubscribeBuffer.push({param:e,toSub:!1}),void mi.warn("WmscApiImpl.unSubscribeVideo, pc is not ready yet, will re-do unSubscribe later.");var n=null==(t=this.mIdMgr)?void 0:t.getMId(i);return n&&(this.sendMonitorLog("UnSubscribeVideo, userId: "+i),this._sendStreamMapping(this.recvPCStatus.peerId,0,n),this.mIdMgr.releaseMId(n),this.recevCSRCRecord.delete(i),mi.log("WmscApiImpl.unSubscribeVideo, userId: "+i+" mId: "+n)),!0},t.onRWGMessage=function(e){var t="string"==typeof e.data?JSON.parse(e.data):e.data;return mi.log("Receive msg from RWG, type: "+t.evt),t.evt===_i.WS_WEBRTC_MEDIA_NEGOTIATION?this.onWebRTCMediaNegotiationMSg(t.body):t.evt===_i.WS_WEBRTC_MEDIA_ACTION?this.onWebRTCMediaActionMSg(t.body):void 0},t.onWebRTCMediaNegotiationMSg=function(e){switch(this.sendMonitorLog("Receive WebRTC media negotiation Msg, type: "+e.type),e.type){case _i.SDP_ANSWER:return mi.log("WmscApiImpl on SDP_ANSWER"),this.onAnswer(e),!0;case _i.SDP_BYE:return mi.log("WmscApiImpl on SDP_BYE"),this.onPCBye(e),!0;default:return mi.warn("Received unknown RWG message type: "+e.type),!1}},t.onWebRTCMediaActionMSg=function(e){switch(e.type){case _i.SUBSCRIBE_LIST:return this.onSubscribeList(e.activeVideo,e.prevActiveVideo,e.privateVideo),!0;case _i.CMD:return this.onCommand(e),!0;default:return mi.warn("Received unknown RWG message type: "+e.type),!1}},t.onAnswer=function(e){if(void 0===e.sdpEncoding)return zi.sendSdpLog(e.peerID,"ANWSER",e.sdp),Ui.onServerMsg(e.peerID,e);hi.decodeString(e.sdp,e.sdpEncoding).then((function(t){return e.sdp=t,zi.sendSdpLog(e.peerID,"ANWSER",t),Ui.onServerMsg(e.peerID,e)}))},t.onPCBye=function(e){this.closePeerConnection(e.peerID),this.bSendEnabled=!1},t.onSubscribeList=function(e,t,i){this.sendMonitorLog("OnSubscribeList: "+e+" "+t+" "+i),mi.log("WmscApiImpl.onSubscribeList, "+e+" "+t+" "+i),zi.updateSubscribedSize(e,t,i);var n=Array.from(new Set([].concat(e,t,i)).values()).filter((function(e){return e>=0})).sort();hi.compareArrays(n,this.lastSubList)||(this.lastSubList=[].concat(n),this.bSendEnabled||this.renewPeerConnectionForSend(),Ui.onMediaRequest(n))},t.onCommand=function(e){switch(e.cmdId){case 0:var t;try{t=JSON.parse(e.cmdParam)}catch(t){mi.warn("Invalid command message: "+JSON.stringify(e))}void 0!==t.receiverBW?Fi.onReceiverBandwidthReport(t.receiverBW):void 0!==t.subInfo?Fi.onSubInfo(t.subInfo):void 0!==t.ingressReport&&(Fi.onReceiverReport(t.ingressReport),zi.onReceiverReport(t.ingressReport));break;default:mi.warn("Unknown command id "+e.cmdId)}},t.onActiveVideoSourceChange=function(e){mi.log("WmscApiImpl.onActiveVideoSourceChange, data: "+JSON.stringify(e));var t=parseInt(wi.nodeId)===parseInt(e.userId);return this.bPrevActiveVideo=this.bActiveVideo&&!t,this.bActiveVideo=t,zi.setActiveSpeaker(e.userId,this.bPrevActiveVideo),mi.monitorLog("onActiveSpeakerChangeto: "+e.userId),!0},t.updateWMSCParams=function(e){mi.log("WmscApiImpl.updateWMSCParams, data: "+JSON.stringify(e)),Object.keys(e).forEach((function(t){switch(t){case"HDVideo":Ui.enableHdVideo(!!e[t]);break;default:mi.warn("WmscApiImpl.updateWMSCParams, unknown param name: "+t)}}))},t.sendBye=function(e){this.recvPCStatus.peerId===e?this.recvPCStatus.bsRecording&&(this.sendRecordingReq(e),this.recvPCStatus.bsRecording=!1):this.sendPCStatus.bsRecording&&(this.sendRecordingReq(e),this.sendPCStatus.bsRecording=!1);var t=wi.confId,i=wi.nodeId,n=gi.byeSdp(t,l.VIDEO_SESSION,i,e,"");mi.addMonitorLog("WMSCSDPBYE-"+t+"-"+e),this._sendMsgtoRWGBySDK({evt:_i.WS_WEBRTC_MEDIA_NEGOTIATION,body:n})},t.stopSendingVideo=function(){this.sendPCStatus.status=l.PC_STATE_IDLE,this.sendBye(this.sendPCStatus.peerId),Ui.stopSendingVideo()},t.sendRecordingReq=function(e,t,i){var n=wi.confId,r=wi.nodeId,a=t?i?_i.CMD_PARAM.CMD_BIT_STREAM_LOAD:_i.CMD_PARAM.CMD_BIT_STREAM_RECORD:_i.CMD_PARAM.CMD_NONE,s=gi.bitstreamRecord(n,l.VIDEO_SESSION,r,e,a,t);this._sendMsgtoRWGBySDK({evt:_i.WS_WEBRTC_MEDIA_ACTION,body:s})},t._sendStreamMapping=function(e,t,i,n){mi.log("WmscApiImpl._sendStreamMapping, peerId: "+e+" userId: "+t+" mID: "+i),this.sendMonitorLog("Send stream mapping, userId: "+t+" size: "+n+" mId: "+i);var r=wi.confId;zi.updateSubInfo(t,i,n);var a=gi.streamMapping(r,l.VIDEO_SESSION,t,e,t,i,n);this._toCaller({type:fi.WMSC_MAPPING_STREAMID_AND_MID,data:JSON.stringify({evt:_i.WS_WEBRTC_MEDIA_ACTION,body:a})})},t._sendMsgtoRWGBySDK=function(e){this._toCaller({type:fi.WMSC_MESSAGE_TO_RWG_BY_SDK,data:JSON.stringify(e)})},t._handlePCOnStream=function(e,t){var i,n;if(e===this.recvPCStatus.peerId){var r=new MediaStream;r.addTrack(t.track);var a=t.transceiver.mid;null==(i=this.mIdMgr)||i.updateStream(a,r);var s=null==(n=this.mIdMgr)?void 0:n.getVideoTag(a);if(!s)return mi.log("WmscApiImpl._handlePCOnStream, video element is not mapped yet, mid= "+a),!1;s.srcObject=r}else mi.warn("WmscApiImpl._handlePCOnStream, peerId "+e+" for sending should not be here")},t._handlePCSdp=function(e,t){var i=this;if(mi.log("WmscApiImpl._handlePCSdp, peerId: "+e+" description: "+t.description),t.description&&/offer/i.test(t.description.type)){var n=t.description.sdp;if(e===this.recvPCStatus.peerId){var r=n.match(/a=group:BUNDLE (.+)/),a=r&&r.length>1&&r[1].split(" ");null!=a&&a.length?(this.mIdMgr=this.mIdMgr||new Ei(a),this._mapBufferedVideoTag()):(mi.error("WmscApiImpl._handlePCSdp could not get receive mid from local offer"),this.mIdMgr=new Ei([]),mi.warn("WmscApiImpl._handlePCSdp midMgr was initialized as empty")),zi.mIdMgr=this.mIdMgr}else n=Mi.mungeOfferToRemoteForSend(n);mi.log("WmscApiImpl._handlePCSdp offer sdp=",n),zi.sendSdpLog(e,"OFFER",n),gi.offerSdp(wi.confId,l.VIDEO_SESSION,wi.nodeId,e,n).then((function(e){i._sendMsgtoRWGBySDK({evt:_i.WS_WEBRTC_MEDIA_NEGOTIATION,body:e})}))}},t._handlePCStatusChange=function(e,t){if(/^connected/i.test(t))if(e===this.recvPCStatus.peerId){for(clearTimeout(this.recvPCStatus.negotiationTimer),this.recvPCStatus.status=l.PC_STATE_CONNECTED,this.recvPCStatus.reconnectionCount=0,this.recvPCStatus.negotiationTimer=0,mi.log("WmscApiImpl._handlePCStatusChange: peerId= "+e+" connected"),this._reSubVideo();this._toSubscribeBuffer.length;){var i=this._toSubscribeBuffer.shift();i.toSub?this.subscribeVideo(i.param):this.unSubscribeVideo(i.param)}this._toCaller({type:fi.V_RECEV_PC_CONNECTED,data:e})}else clearTimeout(this.sendPCStatus.negotiationTimer),this.sendPCStatus.status=l.PC_STATE_CONNECTED,this.sendPCStatus.negotiationTimer=0,this.sendPCStatus.reconnectionCount=0,mi.log("WmscApiImpl._handlePCStatusChange, peerId "+e+" connected"),this._toCaller({type:fi.V_SEND_PC_CONNECTED,data:e});else if(/disconnected/i.test(t)){this.sendMonitorLog("PC disconnected, peerId: "+e+", will try reconnect"),mi.warn("WmscApiImpl._handlePCStatusChange, pc disconnected, peerId = "+e+", will try reconnect");var n=this._getPCStatus(e);if(!n)return;this.restartNegotiation(n)}else if(/fail/i.test(t)){this.sendMonitorLog("PC connect failed, peerId: "+e);var r=this._getPCStatus(e);if(!r)return;r.reconnectionCount<Ji?this.restartNegotiation(r):this._toCaller({type:fi.SDP_NEGOTIATION_FAIL,data:e}),mi.error("WmscApiImpl._handlePCStatusChange, peerId "+e+" failed")}},t._getPCStatus=function(e){return e===this.recvPCStatus.peerId?this.recvPCStatus:this.sendPCStatus},t._reSubVideo=function(){var e=this.mIdMgr.mIdUsedStatus,t=this.recvPCStatus.peerId;for(var i in e)if(e[i].used&&e[i].userId){var n=e[i],r=n.userId,a=n.videoSize;this._sendStreamMapping(t,r,i,a),this._updateVideoElement(r,i)}},t._updateVideoElement=function(e,t){var i=this;mi.log("WmscApiImpl._updateVideoElement, userId: "+e+" mId: "+t);var n=Ui.getRecvPc();if(n){clearInterval(this.recevCSRCRecord.get(e));var r=Date.now(),a=setInterval((function(){var a=Date.now()-r;if(a>1e4)return clearInterval(i.recevCSRCRecord.get(e)),void i.sendMonitorLog("Could not receive subscribed video in 10 seconds, user: "+e+", mId: "+t);var s=hi.getReceiverByMid(n,t);if(s){var o=s.getContributingSources()[0];(parseInt(null==o?void 0:o.source)||0)>>2==e>>2&&(mi.log("Receive subscribe video, userId: "+e+" in "+a+"ms"),clearInterval(i.recevCSRCRecord.get(e)),i.mIdMgr.updateVideoElement(t),i._toCaller({type:fi.VIDEO_SOURCE_UPDATED,userId:e}))}else clearInterval(i.recevCSRCRecord.get(e))}),200);this.recevCSRCRecord.set(e,a)}},t.sendMonitorLog=function(e){mi.monitorLog("WCL_WMSC_EVENT, "+e)},e}(),$i=function(){function e(e,t){return mi.setTrace(),mi.setTelemetry(t),zi.setTelemetry(t),this._toCaller=t,this.config=e,mi.log("WmscApi.init"),mi.monitorLog("WCL_WMSC_EVENT, WMSC API initialized"),!0}var t=e.prototype;return t.setTrace=function(e,t){mi.setTrace(e,t)},t.updateQosSubscription=function(e,t){zi.updateQosSubscription(e,t)},t.getHasPausedVideo=function(){var e,t;return null==(e=this.wmscApiImpl)||null==(t=e.mIdMgr)?void 0:t.getHasPausedVideo()},t.playAllUsedVideoTag=function(){var e,t;return null==(e=this.wmscApiImpl)||null==(t=e.mIdMgr)?void 0:t.playAllUsedVideoTag()},t.destroy=function(){var e;mi.log("Wmsc.destroy"),mi.monitorLog("WCL_WMSC_EVENT, WMSC instance destroyed."),null==(e=this.wmscApiImpl)||e.destroy(),this.wmscApiImpl=null},t.onMessage=function(e,t){if(mi.log("Wmsc.onMessage",e),e!==pi.NOTIFY_SDK_JOIN_RWG_SUCCESS&&!this.wmscApiImpl)return this.toCaller&&this.toCaller({type:fi.ERROR,data:"WSMC on MediaSDK messsage, MediaSDK not ready, type = "+e}),mi.error("Wmsc.onMessage, the caller not ready type=",e),!1;switch(e){case pi.NOTIFY_SDK_JOIN_RWG_SUCCESS:return this._toCaller?(this.config.simulcastEnabled?this.wmscApiImpl=new Xi(this.config,this.toCaller.bind(this)):this.wmscApiImpl=new Ki(this.config,this.toCaller.bind(this)),!0):(mi.error("Wmsc.onMessage, _toCaller to the caller not set"),!1);case pi.NOTIFY_SDK_JOIN_RWG_FAILURE:return!0;case pi.WMSC_MESSAGE_FROM_RWG:return this._onRWGMessage(t.data);case pi.NOTIFY_WMSC_VIDEO_TAG_MAPPING:return this._onVideoTagMapping(t.data);case pi.NOTIFY_SDK_SUBSCRIBE_VIDEO:return this._onSubscribeVideo(t.data);case pi.NOTIFY_SDK_UNSUBSCRIBE_VIDEO:return this._onUnSubscribeVideo(t.data);case pi.NOTIFY_SDK_ACTIVE_VIDEO_INDICATION:return this._onActiveVideoSourceChange(t.data);case pi.UPDATE_WMSC_PARAMS:return this._onUpdateWMSCParams(t.data);default:return this.toCaller({type:fi.ERROR,data:"WSMC on MediaSDK messsage, not handled type = "+e}),mi.error("Wmsc.onMessage, not handled type=",e),!1}},t.onMessageAsync=function(e,t){switch(mi.log("Wmsc.onMessageAsync",e,JSON.stringify(t)),mi.monitorLog("WCL_WMSC_EVENT, on MediaSDK Async messsage: "+e),e){case pi.VIDEO_STREAMS:return this._onVideoStreamsAsync(t.streams);default:return this.toCaller({type:fi.ERROR,data:"WSMC on MediaSDK messsage, not handled type = "+e}),mi.error("Wmsc.onMessage, not handled type=",e),Promise.reject("Unknow message type")}},t.toCaller=function(e){mi.log("Wmsc.callback, type=",JSON.stringify(e)),this._toCaller&&this._toCaller(e)},t._onVideoStreamsAsync=function(e){return this.wmscApiImpl.onVideoStreamsAsync(e)},t._onRWGMessage=function(e){return this.wmscApiImpl.onRWGMessage(e)},t._onVideoTagMapping=function(e){return this.wmscApiImpl.onVideoTagMapping(e)},t._onSubscribeVideo=function(e){return this.wmscApiImpl.subscribeVideo(e)},t._onUnSubscribeVideo=function(e){return this.wmscApiImpl.unSubscribeVideo(e)},t._onActiveVideoSourceChange=function(e){return this.wmscApiImpl.onActiveVideoSourceChange(e)},t._onUpdateWMSCParams=function(e){return this.wmscApiImpl.updateWMSCParams(e)},e}()},103:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=class{constructor(){this.status="pending",this.promise=new Promise((e,t)=>{this.reject=e=>(this.status="rejected",t(e)),this.resolve=t=>(this.status="fullfilled",e(t))}),this.then=this.promise.then,this.catch=this.promise.catch}}},104:function(e,t,i){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&n(t,e,i);return r(t,e),t},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.WMSCManager=t.eventExt=void 0;const o=i(102);Object.defineProperty(t,"eventExt",{enumerable:!0,get:function(){return o.eventExt}});const d=s(i(103)),c=s(i(0)),u=i(2),l=s(i(9)),h=s(i(7)),p=a(i(3)),f=s(i(34));var m;!function(e){e.visibilitychange="visibilitychange",e.streamCaptureSuccess="streamCaptureSuccess",e.videoTrackUnmute="videoTrackUnmute",e.addRenderVideo="addRenderVideo",e.userClick="userClick"}(m||(m={}));t.WMSCManager=class{constructor(e){this._config={webRTCWebSocketUrl:"",confId:"",nodeId:"",useSimulcast:!0,HDVideo:!1},this._websocket=null,this._wmsc=null,this._isDestroyed=!1,this._qosFlag=new Set,this.isJoinRWGSuccess=!1,this._joinRWGSuccessPromise=new d.default,this._lastTimeStamp=0,this.selfVideoDom=null,this._createWSS=()=>{this._onWSSOpenTimer=setTimeout(()=>{this.sendMonitorLog("webrtc wss not open in 30s, should failover"),this._tryFailover(u.NOTIFY_UI_WMSC_WSS_DISCONNECTED)},3e4);const{webRTCWebSocketUrl:e}=this._config;this._websocket=new WebSocket(e),this._websocket.onopen=this._onOpen,this._websocket.onclose=this._onClose,this._websocket.onmessage=this._onMessage,this._websocket.onerror=this._onError,this.sendMonitorLog("Create WSS to: "+e)},this._onOpen=e=>{if(clearTimeout(this._onWSSOpenTimer),!this._wmsc){const{confId:e,nodeId:t,HDVideo:i,useSimulcast:n}=this._config;if(!e||!t)return;const r={maxCaptureResolution:3,maxVideoReceiveNum:25,confId:e,nodeId:t,HDVideo:i,simulcastEnabled:n};this._wmsc=new o.Wmsc(r,this._wmscCallBack),this.sendMonitorLog("Create WMSC instance with: "+JSON.stringify(r))}},this._isKeepAliveMessage=e=>{let t=!0;for(let i=0;i<4;i++)if(0!==e[i]){t=!1;break}return t},this._checkReceiveTimeout=()=>{clearTimeout(this._keepAliveTimer),this._keepAliveTimer=setTimeout(()=>{const e=Date.now();this.sendMonitorLog(`webrtc wss not receive message in 30s, should failover, last timestamp: ${this._lastTimeStamp}, current timestamp: ${e}`),this._tryFailover(u.NOTIFY_UI_WMSC_WSS_DISCONNECTED)},3e4)},this._replyActiveAliveMessage=e=>{(null==e?void 0:e.data)instanceof Blob&&p.default.readBlobAsBuffer(e.data).then(e=>{var t;const i=new Int8Array(e);this._isKeepAliveMessage(i)&&(null===(t=this._websocket)||void 0===t||t.send(i))}).catch(e=>{console.log("error: ",e)})},this._onMessage=e=>{if(this._lastTimeStamp=Date.now(),this._checkReceiveTimeout(),this._replyActiveAliveMessage(e),!((null==e?void 0:e.data)instanceof Blob)&&this._wmsc){if(e.data){const{evt:t}=JSON.parse(e.data);if(0===t)return this.sendMessageToWMSC({type:o.eventExt.NOTIFY_SDK_JOIN_RWG_SUCCESS,data:""}),this.isJoinRWGSuccess=!0,this._joinRWGSuccessPromise.resolve()}this.sendMessageToWMSC({type:o.eventExt.WMSC_MESSAGE_FROM_RWG,data:e})}},this._onClose=e=>{1e3!==e.code&&l.default.error("WMSC WSS close",e),this.sendMonitorLog("webrtc WSS onClose, expected: "+this._isDestroyed),this._tryFailover(u.NOTIFY_UI_WMSC_WSS_DISCONNECTED)},this._onError=e=>{l.default.error("WMSC WSS error",e),this.sendMonitorLog("webrtc WSS onError, destroyed: "+this._isDestroyed),this._tryFailover(u.NOTIFY_UI_WMSC_WSS_DISCONNECTED)},this._tryFailover=e=>{this._isDestroyed||c.default.Notify_APPUI&&(this.destroy(),c.default.Notify_APPUI(e))},this._disconnect=()=>{this._websocket&&(this._websocket.readyState!==WebSocket.CONNECTING&&this._websocket.readyState!==WebSocket.OPEN||(this._websocket.close(),this.sendMonitorLog("Close WSS")))},this.sendMessageToWMSC=e=>{var t;(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.data)instanceof Blob||this._wmsc&&this._wmsc.onMessage(e.type,e)},this.sendMessageToWMSCAsync=e=>{if(!this._wmsc)return Promise.reject("this._wmsc is undefined");const{type:t}=e;switch(t){case o.eventExt.VIDEO_STREAMS:return this._wmsc.onMessageAsync(e.type,e);default:return Promise.reject("Not found event type "+e.type)}},this._wmscCallBack=e=>{var t;if(!e)return;const{type:i,data:n}=e;switch(i){case o.eventOut.WMSC_MESSAGE_TO_RWG_BY_SDK:this.sendMesssageToRWG(n);break;case o.eventOut.WMSC_MAPPING_STREAMID_AND_MID:const e=JSON.parse(n);if(!(null==e?void 0:e.body))return;c.default.sendMessageToRwg(u.SEND_MESSAGE_TO_RWG,e),0!==e.body.userID&&"videoSize"in e.body&&c.default.sendMessageToRwg(u.SEND_MESSAGE_TO_RWG,{evt:u.WS_VIDEO_MULTI_SUBSCRIBE_REQ,body:{subInfoList:[{id:e.body.userID,size:e.body.videoSize,bOn:!1}]}});break;case o.eventOut.SDP_NEGOTIATION_FAIL:(null===(t=this._websocket)||void 0===t?void 0:t.readyState)===WebSocket.OPEN&&(this.sendMonitorLog("webrtc sdp negotiation fail, should failover"),this._tryFailover(u.NOTIFY_UI_WMSC_FAILOVER));break;case o.eventOut.GLOBAL_TRACE:{const{logLevel:e,log:t,errorEvent:i}=n;l.default[e](t,i);break}case o.eventOut.MONITOR:this.sendMonitorLog(n,!0);break;case o.eventOut.ADD_MONITOR:h.default.add_monitor(n);break;case o.eventOut.VIDEO_QOS_DATA:c.default.Notify_APPUI(u.VIDEO_QOS_DATA,n)}},this.waitJoinRWGSuccess=()=>this._joinRWGSuccessPromise.promise,this.updateQosSubscription=(e,t,i)=>{var n,r;e?(this._qosFlag.add(t),null===(n=this._wmsc)||void 0===n||n.updateQosSubscription(e,i)):(this._qosFlag.delete(t),0===this._qosFlag.size&&(null===(r=this._wmsc)||void 0===r||r.updateQosSubscription(e,i)))},this.sendMonitorLog=(e,t=!1)=>{if(!e)return;let i=t?e:"WCL_WMSC_EVENT, "+e;c.default.sendMessageToRwg(u.MONITOR_LOG,{evt:u.RWG_MONITOR_LOG_EVENT,seq:1,body:{data:i}})},this.playAllVideoTag=e=>{var t,i;if((null===(t=null==this?void 0:this.selfVideoDom)||void 0===t?void 0:t.paused)&&this.playSelfVideo(e),null===(i=null==this?void 0:this._wmsc)||void 0===i?void 0:i.playAllUsedVideoTag){if(!this._wmsc.getHasPausedVideo())return;this._wmsc.playAllUsedVideoTag().then(()=>{}).catch(t=>{this.sendMonitorLog(`some receive video tag play faile, source: ${e}, useId: ${t}`)})}},this.playSelfVideo=e=>{var t,i;if("visible"!==document.visibilityState)return void this.sendMonitorLog(`play self video, but visibilityState: ${document.visibilityState}, source: ${e}`);if(!this.selfVideoDom)return void this.sendMonitorLog("play self video, but video tag not exist, source: "+e);if(!this.selfVideoDom.paused)return void this.sendMonitorLog("play self video, but video tag not paused, source: "+e);if(!this.selfVideoDom.srcObject)return void this.sendMonitorLog("play self video, but video tag not contain srcObject, source: "+e);const n=null===(i=null===(t=this.selfVideoDom)||void 0===t?void 0:t.srcObject)||void 0===i?void 0:i.getVideoTracks();Array.isArray(n)&&n[0]&&n[0].muted?this.sendMonitorLog("play self video, but video track muted, source: "+e):this.selfVideoDom.play().then(()=>{this.sendMonitorLog("play self video success, source: "+e)}).catch(e=>{this.sendMonitorLog(`play self video failed, error name: ${e.name}, error message: ${e.message}`)})},this.mirrorSelfVideo=e=>{if(this.selfVideoDom){const t=`rotateY(${e?180:0}deg)`;let i=this.selfVideoDom.style.transform;-1!==i.indexOf("rotateY")?i=i.replace(/rotateY\([0-9]+(deg)?\)/,t):i+=" "+t,this.selfVideoDom.style.transform=i}else this.sendMonitorLog("try mirror self video, but not selfVideoDom, isMirror:"+e)},this.destroy=()=>{var e;clearTimeout(this._onWSSOpenTimer),clearTimeout(this._keepAliveTimer),this._cleanUserEventListener&&this._cleanUserEventListener(),this.selfVideoDom=null,this.isJoinRWGSuccess=!1,this._isDestroyed=!0,this._disconnect(),this._wmsc&&(null===(e=this._wmsc)||void 0===e||e.destroy())},this._isDestroyed=!1,this._config=Object.assign(this._config,e),this._createWSS(),this._throttlePlayAllVideoTag=(0,f.default)(this.playAllVideoTag,500),this._cleanUserEventListener=(0,p.addUserEventListener)(()=>this._throttlePlayAllVideoTag(m.userClick)),document.addEventListener("visibilitychange",()=>{"visible"===document.visibilityState&&this._throttlePlayAllVideoTag(m.visibilitychange)})}sendMesssageToRWG(e){this._websocket&&this._websocket.readyState===WebSocket.OPEN&&("object"==typeof e?this._websocket.send(JSON.stringify(e)):this._websocket.send(e))}}}}]);
//# sourceMappingURL=https://d1cdksi819e9z7.cloudfront.net/sourcemap/wmsc-vendors.min.js-d9e6bc43b8b6622fc237.map