(self.__MEDIA_SDK_CHUNK_LOADER__=self.__MEDIA_SDK_CHUNK_LOADER__||[]).push([[557],{763:(e,t,i)=>{"use strict";i.r(t),i.d(t,{WMSCManager:()=>Ii,eventExt:()=>F});var a={};i.r(a),i.d(a,{TO:()=>E,NS:()=>b,mz:()=>R,GA:()=>A,FK:()=>_,pO:()=>S,fZ:()=>v,Rz:()=>D,r3:()=>w,By:()=>L,ey:()=>y,rF:()=>T,wK:()=>g,LA:()=>N,tT:()=>V,ul:()=>u,j$:()=>m,Y7:()=>p,RJ:()=>h,bl:()=>M,Dz:()=>P,c$:()=>O,lN:()=>C,zk:()=>k,nd:()=>r,ue:()=>B,pg:()=>f,S$:()=>I,tP:()=>s,qe:()=>U});var s,n,r,o,c=i(7857),d=i(129),l=i.n(d);!function(e){e[e.ERROR=0]="ERROR",e[e.WARN=1]="WARN",e[e.INFO=2]="INFO",e[e.DEBUG=3]="DEBUG",e[e.VERBOSE=4]="VERBOSE"}(s||(s={})),function(e){e[e._90P=0]="_90P",e[e._180P=1]="_180P",e[e._360P=2]="_360P",e[e._720P=3]="_720P",e[e._1080P=4]="_1080P",e[e._2160P=5]="_2160P"}(n||(n={})),function(e){e[e.AUDIO=1]="AUDIO",e[e.VIDEO=2]="VIDEO",e[e.SHARE=3]="SHARE"}(r||(r={})),function(e){e[e.VIDEO=1]="VIDEO",e[e.AUDIO=2]="AUDIO",e[e.SHARE=3]="SHARE"}(o||(o={}));const h=0;var u;!function(e){e[e.IDLE=0]="IDLE",e[e.CONNECTING=1]="CONNECTING",e[e.CONNECTED=2]="CONNECTED"}(u||(u={}));const m=6e3,p=2e3,g=1e4,S=3,_=3,v=3,f=15e3;var y,M,C;!function(e){e.STREAM="STREAM",e.SDP="SDP",e.PC_STATE_CHANGE="PC_STATE_CHANGE",e.UPDATE_BITRATE="UPDATE_BITRATE",e.ERROR="ERROR"}(y||(y={})),function(e){e.LAYERS_UPDATE="LAYERS_UPDATE",e.MIN_BITRATE_UPDATE="MIN_BITRATE_UPDATE",e.ENCODER_RESET="ENCODER_RESET"}(M||(M={})),function(e){e[e.NONE=0]="NONE",e[e.UNDERUSING=1]="UNDERUSING",e[e.NORMAL=2]="NORMAL",e[e.OVERUSING=3]="OVERUSING"}(C||(C={}));const E=1;var I;!function(e){e[e.PLAIN=0]="PLAIN",e[e.GZIP_BASE64=1]="GZIP_BASE64"}(I||(I={}));const T=2,A=100,R=62464,b=17120,w=26,D=w+1,L=16,P=299,O=6;var V,N,k,B;!function(e){e[e.NET_QUALITY_UNKNOWN=-1]="NET_QUALITY_UNKNOWN",e[e.NET_QUALITY_VERY_BAD=0]="NET_QUALITY_VERY_BAD",e[e.NET_QUALITY_BAD=1]="NET_QUALITY_BAD",e[e.NET_QUALITY_NOT_GOOD=2]="NET_QUALITY_NOT_GOOD",e[e.NET_QUALITY_NORMAL=3]="NET_QUALITY_NORMAL",e[e.NET_QUALITY_GOOD=4]="NET_QUALITY_GOOD",e[e.NET_QUALITY_EXCELLENT=5]="NET_QUALITY_EXCELLENT"}(V||(V={})),function(e){e[e.NET_BW_LEVEL_UNKNOWN=-1]="NET_BW_LEVEL_UNKNOWN",e[e.NET_BW_LEVEL_VERY_LOW=0]="NET_BW_LEVEL_VERY_LOW",e[e.NET_BW_LEVEL_LOW=1]="NET_BW_LEVEL_LOW",e[e.NET_BW_LEVEL_NORMAL=2]="NET_BW_LEVEL_NORMAL"}(N||(N={})),function(e){e[e.ICE=0]="ICE",e[e.MEDIA=1]="MEDIA",e[e.ADD_MLINE=2]="ADD_MLINE",e[e.REMOVE_MLINE=3]="REMOVE_MLINE",e[e.UPDATE_BITRATE=4]="UPDATE_BITRATE"}(k||(k={})),function(e){e[e.HD_VIDEO=2097152]="HD_VIDEO",e[e.FULL_HD_VIDEO=4096]="FULL_HD_VIDEO",e[e.DUAL_CALL=1]="DUAL_CALL",e[e.AV1_CODEC=262144]="AV1_CODEC"}(B||(B={}));const U="WMSC_DETECT_CANPLAY_VIDEO",x=new class{constructor(){this.confId="",this.nodeId="",this.webrtcMode=0,this.isMacIntel=!1,this.videoSettings={maxCaptureVideoSize:4,maxRecvVideoNum:w,hdVideoEnabled:!1},this._enabledLayerIds=[],this._layersSettings=null,this.iceServers=[]}setConfig(e){const{confId:t,nodeId:i,webrtcMode:a,isMacIntel:s,videoSettings:n,qosOptions:r,iceServers:o,avSyncMode:c}=e;void 0!==t&&(this.confId=t),void 0!==i&&(this.nodeId=i),void 0!==a&&(this.webrtcMode=a),void 0!==s&&(this.isMacIntel=s),void 0!==n&&(this.videoSettings=Object.assign(Object.assign({},this.videoSettings),n)),void 0!==r&&(this.qosOptions=r),null!=o&&(this.iceServers=o||[]),void 0!==c&&(this.avSyncMode=c)}getConfig(){const{confId:e,nodeId:t,webrtcMode:i,isMacIntel:a,videoSettings:s,qosOptions:n,iceServers:r}=this;return{confId:e,nodeId:t,webrtcMode:i,isMacIntel:a,videoSettings:s,qosOptions:n,iceServers:r}}setEnabledLayerIds(e){this._enabledLayerIds=e}get enabledLayerIds(){return this._enabledLayerIds}setLayersSettings(e){this._layersSettings=e}get layersSettings(){return this._layersSettings}};var F,W,z;!function(e){e.NOTIFY_SDK_JOIN_RWG_SUCCESS="NOTIFY_SDK_JOIN_RWG_SUCCESS",e.NOTIFY_SDK_JOIN_RWG_FAILURE="NOTIFY_SDK_JOIN_RWG_FAILURE",e.VIDEO_STREAMS="VIDEO_STREAMS",e.WMSC_MESSAGE_FROM_RWG="WMSC_MESSAGE_FROM_RWG",e.NOTIFY_WMSC_VIDEO_TAG_MAPPING="NOTIFY_WMSC_VIDEO_TAG_MAPPING",e.NOTIFY_SDK_SUBSCRIBE_VIDEO="NOTIFY_SDK_SUBSCRIBE_VIDEO",e.NOTIFY_SDK_UNSUBSCRIBE_VIDEO="NOTIFY_SDK_UNSUBSCRIBE_VIDEO",e.NOTIFY_SDK_ACTIVE_VIDEO_INDICATION="NOTIFY_SDK_ACTIVE_VIDEO_INDICATION",e.UPDATE_WMSC_PARAMS="UPDATE_WMSC_PARAMS",e.UPDATE_VIDEO_SOURCE_SETTINGS="UPDATE_VIDEO_SOURCE_SETTINGS"}(F||(F={})),function(e){e.ERROR="ERROR",e.WMSC_MESSAGE_TO_RWG_BY_SDK="WMSC_MESSAGE_TO_RWG_BY_SDK",e.WMSC_MAPPING_STREAMID_AND_MID="WMSC_MAPPING_STREAMID_AND_MID",e.GLOBAL_TRACE="GLOBAL_TRACE",e.MONITOR="MONITOR",e.DIRECT_MONITOR="DIRECT_MONITOR",e.CREATE_VIDEO_STREAMS_SUCCESS="CREATE_VIDEO_STREAMS_SUCCESS",e.CREATE_VIDEO_STREAMS_FAIL="CREATE_VIDEO_STREAMS_FAIL",e.PC_CONNECTED="PC_CONNECTED",e.VIDEO_SOURCE_UPDATED="VIDEO_SOURCE_UPDATED",e.VIDEO_TAG_MAPPED="VIDEO_TAG_MAPPED",e.VIDEO_QOS_DATA="VIDEO_QOS_DATA",e.UPDATE_VIDEO_CAPTURE_CONSTRAINTS="UPDATE_VIDEO_CAPTURE_CONSTRAINTS",e.ERROR_MESSAGE="ERROR_MESSAGE",e.NETWORK_QUALITY_CHANGE="NETWORK_QUALITY_CHANGE",e.NETWORK_QUALITY_CHANGE_AUDIO="NETWORK_QUALITY_CHANGE_AUDIO",e.VIDEO_CAPABILITIES_CHANGE="VIDEO_CAPABILITIES_CHANGE",e.UPDATE_VIDEO_SUBSCRIPTION="UPDATE_VIDEO_SUBSCRIPTION",e.UPDATE_VIDEO_UNSUBSCRIPTION="UPDATE_VIDEO_UNSUBSCRIPTION",e.SDP_NEGOTIATION_FAIL="SDP_NEGOTIATION_FAIL",e.PC_FAIL="PC_FAIL",e.VIDEO_FAIL="VIDEO_FAIL",e.PC_CLOSED="PC_CLOSED",e.AUDIO_RECAPTURE="AUDIO_RECAPTURE",e.CURRENT_DECODE_VIDEO_QUALITY="CURRENT_DECODE_VIDEO_QUALITY",e.CURRENT_DECODE_VIDEO_FPS="CURRENT_DECODE_VIDEO_FPS"}(W||(W={})),function(e){e[e.None=0]="None",e[e.App_SYNC=1]="App_SYNC",e[e.WEBRTC_SYNC=2]="WEBRTC_SYNC"}(z||(z={}));var j=i(7201),G=i.n(j),H=function(e,t,i,a){return new(i||(i=Promise))((function(s,n){function r(e){try{c(a.next(e))}catch(e){n(e)}}function o(e){try{c(a.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,o)}c((a=a.apply(e,t||[])).next())}))};function Q(e){return(4294966272&e)>>>0}function q(e,t){return H(this,void 0,void 0,(function*(){switch(t){case I.GZIP_BASE64:{const t=yield function(e){return H(this,void 0,void 0,(function*(){const t=(new TextEncoder).encode(e);if(window.CompressionStream){const e=new CompressionStream("gzip"),i=e.writable.getWriter();return i.write(t),i.close(),new Response(e.readable).arrayBuffer()}{const{gzip:e}=yield i.e(404).then(i.bind(i,3075));return e(t).buffer}}))}(e);return function(e){let t="";const i=new Uint8Array(e);for(let e=0;e<i.byteLength;e++)t+=String.fromCharCode(i[e]);return btoa(t)}(t)}case I.PLAIN:return e;default:return null}}))}function Y(e,t){return e.length===t.length&&e.every(((e,i)=>e===t[i]))}function K(e,t){return e-t}function J(e,t){t=t||{};const i=e=>{var t,i;if("number"==typeof e)return e;if(e&&"object"==typeof e){const{exact:a,ideal:s,max:n,min:r}=e;return null!==(i=null!==(t=null!=a?a:s)&&void 0!==t?t:n)&&void 0!==i?i:r}};return{width:(e=e||{}).width||i(t.width),height:e.height||i(t.height),frameRate:e.frameRate||i(t.frameRate)}}function X(e){var t;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"|";return e?G()(t=e.toString()).call(t,/[,ï¼Œ]/g,i):""}function Z(){return parseInt((arguments.length>0&&void 0!==arguments[0]?arguments[0]:"").substring(0,2),16)===A}function $(){return parseInt((arguments.length>0&&void 0!==arguments[0]?arguments[0]:"").substring(0,4),16)===R}function ee(){return parseInt((arguments.length>0&&void 0!==arguments[0]?arguments[0]:"").substring(0,4),16)===b}const te=new class{constructor(){this.setTrace()}setTrace(e,t){t&&(t.log||t.info)&&t.error&&t.warn?(this.log=t.log||t.info,this.info=t.info||t.log,this.debug=t.debug||t.log,this.verbose=this._verbose,this.error=t.error,this.warn=t.warn):(this.verbose=this._verbose.bind(this),this.log=this._log.bind(this),this.info=this._info.bind(this),this.debug=this._debug.bind(this),this.error=this._error.bind(this),this.warn=this._warn.bind(this)),this.level=e||s.INFO,this.level=this.level<s.ERROR?s.ERROR:this.level,this.level=this.level>s.VERBOSE?s.VERBOSE:this.level,this.getLevel=()=>this.level,this._trace=(e,t)=>{switch(e){case"log":console.log(...t);break;case"debug":console.debug(...t);break;case"info":console.info(...t);break;case"warn":console.warn(...t);break;case"error":console.error(...t)}}}getTracer(e){return{log:()=>{},debug:()=>{},info:()=>{},warn:()=>{},error:()=>{}}}setTelemetry(e){this._telemetry="function"==typeof e?e:null}monitorLog(e){e&&this._telemetry&&this._telemetry({type:W.MONITOR,data:e})}directSendMonitorLog(e){e&&this._telemetry&&this._telemetry({type:W.DIRECT_MONITOR,data:e})}globalTrace(e){e&&this._telemetry&&this._telemetry({type:W.GLOBAL_TRACE,data:e})}_verbose(){if(this.level>=s.VERBOSE){const e=[...arguments];return e.unshift("[VERBOSE]"),this._trace("log",e),!0}return!1}_debug(){return this.level>=s.DEBUG&&(this._trace("debug",arguments),!0)}_log(){return this.level>=s.INFO&&(this._trace("log",arguments),!0)}_info(){return this.level>=s.INFO&&(this._trace("info",arguments),!0)}_warn(){return this.level>=s.WARN&&(this._trace("warn",arguments),!0)}_error(){return this.level>=s.ERROR&&(this._trace("error",arguments),!0)}};var ie=i(1265),ae=i.n(ie),se=i(8048),ne=i.n(se);function re(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,a)}return i}function oe(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?re(Object(i),!0).forEach((function(t){(0,c.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):re(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class ce{static splitSections(e){return e.split("\r\nm=").map(((e,t)=>t>0?"m="+e:e))}static splitLines(e){return e.split("\r\n")}static parseVersionLine(e){return parseInt(e.substring(2),10)}static writeVersionLine(e){return"v=".concat(e)}static parseOriginLine(e){const[t,i,a,s,n,r]=e.substring(2).split(" ");return{userName:t,sessionId:i,sessionVersion:parseInt(a,10),netType:s,addressType:n,address:r}}static writeOriginLine(e){const{userName:t,sessionId:i,sessionVersion:a,netType:s,addressType:n,address:r}=e;return"o=".concat(t," ").concat(i," ").concat(a," ").concat(s," ").concat(n," ").concat(r)}static parseSessionNameLine(e){return e.substring(2)}static writeSessionNameLine(e){return"s=".concat(e)}static parseInformationLine(e){return e.substring(2)}static writeInformationLine(e){return"i=".concat(e)}static parseConnectionLine(e){const[t,i,a]=e.substring(2).split(" ");return{netType:t,addressType:i,address:a}}static writeConnectionLine(e){const{netType:t,addressType:i,address:a}=e;return"c=".concat(t," ").concat(i," ").concat(a)}static parseBandwidthLine(e){return parseInt(e.substring(7),10)}static writeBandwidthLine(e){return"b=TIAS:".concat(e)}static parseTimingLine(e){const[t,i]=e.substring(2).split(" ");return{startTime:parseInt(t,10),stopTime:parseInt(i,10)}}static writeTimingLine(e){const{startTime:t,stopTime:i}=e;return"t=".concat(t," ").concat(i)}static parseRtpMapLine(e){const t=e.substring(9).match(/^(\d+) (.*)/),i=t[2].split("/");return{payloadType:parseInt(t[1],10),codecName:i[0],clockRate:parseInt(i[1],10),channels:i.length>=3?parseInt(i[2],10):null}}static writeRtpMapLine(e){const{payloadType:t,codecName:i,clockRate:a,channels:s}=e;let n="a=rtpmap:".concat(t," ").concat(i,"/").concat(a);return null!=s&&(n+="/"+s),n}static parseFmtpLine(e){const t=e.substring(7).match(/^(\d+) (.*)/),i={payloadType:parseInt(t[1],10)};return t[2].includes("=")?i.params=new Map(t[2].split(";").map((e=>ae()(e).call(e).split("=")))):i.plain=t[2],i}static writeFmtpLine(e){const{payloadType:t,params:i,plain:a}=e;let s="a=fmtp:".concat(t," ");return i?(i.forEach(((e,t)=>{null!=e&&(s+="".concat(t,"=").concat(e,";"))})),s=s.slice(0,-1)):s+=a,s}static parseRtcpFbLine(e){const t=e.substring(10).match(/^(\d+) (.*)/);return{payloadType:parseInt(t[1],10),params:t[2].split(" ")}}static writeRtcpFbLine(e){const{payloadType:t,params:i}=e;let a="a=rtcp-fb:".concat(t);return i.forEach((e=>{a+=" "+e})),a}static parseRidLine(e){const t=e.substring(6).match(/^(\S+)\s+(send|recv|sendrecv)\s*(.*)$/),i=new Map;return t[3]&&t[3].split(";").forEach((e=>{const[t,a]=e.split("=");i.set(t,a)})),{rid:t[1],direction:t[2],params:i}}static writeRidLine(e){const{rid:t,direction:i,params:a}=e;let s;return(null==a?void 0:a.size)>0&&(s=Array.from(a.entries()).map((e=>{let[t,i]=e;return"".concat(t,"=").concat(i)})).join(";")),"a=rid:".concat(t," ").concat(i).concat(s?" "+s:"")}static parseSimulcastLine(e){const t=e.substring(12).match(/^(send|recv) (.*)/);return{direction:t[1],rids:t[2].split(";").map((e=>"~"===e[0]?{id:e.substring(1),paused:!0}:{id:e,paused:!1}))}}static writeSimulcastLine(e){const{direction:t,rids:i}=e;let a="a=simulcast:".concat(t," ");return i.forEach((e=>{const t=e.paused?"~"+e.id:e.id;a+=t+";"})),a.slice(0,-1)}static parseExtensionMapLine(e){var t;const i=e.substring(9).match(/^(\d+)(\/sendrecv|\/sendonly|\/recvonly|\/inactive)? (\S+)(\s\S+)?/);return{id:parseInt(i[1],10),direction:i[2]?i[2].substring(1):null,uri:i[3],attributes:i[4]?ne()(t=i[4]).call(t):null}}static writeExtensionMapLine(e){const{id:t,direction:i,uri:a,attributes:s}=e;let n="a=extmap:".concat(t);return null!=i&&(n+="/"+i),n+=" "+a,null!=s&&(n+=" "+s),n}static parseMidLine(e){return e.substring(6)}static writeMidLine(e){return"a=mid:".concat(e)}static writeDirectionLine(e){return"a=".concat(e)}static parseMsidLine(e){const[t,i]=e.substring(7).split(" ");return{streamId:t,trackId:i}}static writeMsidLine(e){const{streamId:t,trackId:i}=e;return"a=msid:".concat(t," ").concat(i)}static parseSsrcLine(e){const t=e.indexOf(" ");return{ssrc:parseInt(e.substring(7,t),10),attribute:e.substring(t+1)}}static writeSsrcLine(e){const{ssrc:t,attribute:i}=e;return"a=ssrc:".concat(t," ").concat(i)}static parseSsrcGroupLine(e){const t=e.substring(13).split(" ");return{semantics:t.shift(),ssrcs:t}}static writeSsrcGroupLine(e){const{semantics:t,ssrcs:i}=e;let a="a=ssrc-group:".concat(t);return i.forEach((e=>{a+=" "+e})),a}static parseGroupLine(e){const t=e.indexOf(" ");return{semantics:e.substring(8,t),ids:e.substring(t+1).split(" ")}}static writeGroupLine(e){const{semantics:t,ids:i}=e;let a="a=group:".concat(t);return i.forEach((e=>{a+=" "+e})),a}static writeExtMapAllowMixedLine(){return"a=extmap-allow-mixed"}static writeRtcpMuxLine(){return"a=rtcp-mux"}static writeRtcpReducedSizeLine(){return"a=rtcp-rsize"}static parseCandidateLine(e){const t=e.substring(12).split(" "),i={foundation:t[0],componentId:parseInt(t[1],10),transport:t[2],priority:parseInt(t[3],10),address:t[4],port:parseInt(t[5],10),candType:t[6],type:t[7],relAddress:null,relPort:null,candExtensions:[]};return"raddr"===t[8]&&"rport"===t[10]?(i.relAddress=t[9],i.relPort=parseInt(t[11],10),i.candExtensions=t.slice(12)):i.candExtensions=t.slice(8),i}static writeCandidateLine(e){const{foundation:t,componentId:i,transport:a,priority:s,address:n,port:r,candType:o,type:c,relAddress:d,relPort:l,candExtensions:h}=e;let u="a=candidate:".concat(t," ").concat(i," ").concat(a," ").concat(s)+" ".concat(n," ").concat(r," ").concat(o," ").concat(c);return null!=d&&null!=l&&(u+=" raddr ".concat(d," rport ").concat(l)),h.length&&(u+=" "+h.join(" ")),u}static parseSessionSection(e){const t={version:0,origin:null,sessionName:null,information:null,connection:null,bandwidth:null,timing:null,groups:[],extMapAllowMixed:null,otherLines:[]},i=this.splitLines(e);for(let e=0;e<i.length;e++){const a=i[e];a.length&&(a.match(/^v=/)?t.version=this.parseVersionLine(a):a.match(/^o=/)?t.origin=this.parseOriginLine(a):a.match(/^s=/)?t.sessionName=this.parseSessionNameLine(a):a.match(/^i=/)?t.information=this.parseInformationLine(a):a.match(/^c=/)?t.connection=this.parseConnectionLine(a):a.match(/^b=TIAS:/)?t.bandwidth=this.parseBandwidthLine(a):a.match(/^t=/)?t.timing=this.parseTimingLine(a):a.match(/^a=group:/)?t.groups.push(this.parseGroupLine(a)):a.match(/^a=extmap-allow-mixed$/)?t.extMapAllowMixed=!0:t.otherLines.push(a))}return t}static writeSessionSection(e){const t=[];return t.push(this.writeVersionLine(e.version)),null!=e.origin&&t.push(this.writeOriginLine(e.origin)),null!=e.sessionName&&t.push(this.writeSessionNameLine(e.sessionName)),null!=e.information&&t.push(this.writeInformationLine(e.information)),null!=e.connection&&t.push(this.writeConnectionLine(e.connection)),null!=e.bandwidth&&t.push(this.writeBandwidthLine(e.bandwidth)),null!=e.timing&&t.push(this.writeTimingLine(e.timing)),e.groups.forEach((e=>{t.push(this.writeGroupLine(e))})),e.extMapAllowMixed&&t.push(this.writeExtMapAllowMixedLine()),e.otherLines.length&&t.push(...e.otherLines),t.join("\r\n")+"\r\n"}static parseMediaSection(e){const t={type:null,port:null,protocol:null,formats:[],connection:null,bandwidth:null,mid:null,direction:null,msid:null,rtcpMux:null,rtcpReducedSize:null,icePwd:null,iceUfrag:null,rtcp:null,codecs:[],extensionMap:new Map,rids:[],simulcast:null,ssrcs:[],ssrcGroups:[],candidates:[],otherLines:[]},i=[],a=[],s=this.splitLines(e),n=s[0].split(" ");t.type=n[0].substring(2),t.port=parseInt(n[1],10),t.protocol=n[2],t.formats=n.slice(3);for(let e=1;e<s.length;e++){let n;const r=s[e];if(r.length)if(r.match(/^c=/))t.connection=this.parseConnectionLine(r);else if(r.match(/^b=TIAS:/))t.bandwidth=this.parseBandwidthLine(r);else if(r.match(/^a=rtpmap:/)){const e=this.parseRtpMapLine(r);t.codecs.push(oe(oe({},e),{},{codecParams:new Map,rtcpFbParams:[]}))}else if(r.match(/^a=fmtp:/))i.push(r);else if(r.match(/^a=rtcp-fb:/))a.push(r);else if(r.match(/^a=rid:/))t.rids.push(this.parseRidLine(r));else if(r.match(/^a=simulcast:/))t.simulcast=this.parseSimulcastLine(r);else if(r.match(/^a=ssrc:/))t.ssrcs.push(this.parseSsrcLine(r));else if(r.match(/^a=ssrc-group:/))t.ssrcGroups.push(this.parseSsrcGroupLine(r));else if(r.match(/^a=extmap:/)){const e=this.parseExtensionMapLine(r);t.extensionMap.set(e.id,e)}else r.match(/^a=mid:/)?t.mid=this.parseMidLine(r):(n=r.match(/^a=(sendrecv|sendonly|recvonly|inactive)/))?t.direction=n[1]:r.match(/^a=msid:/)?t.msid=this.parseMsidLine(r):r.match(/^a=rtcp-mux$/)?t.rtcpMux=!0:r.match(/^a=rtcp-rsize$/)?t.rtcpReducedSize=!0:r.match(/^a=candidate:/)?t.candidates.push(this.parseCandidateLine(r)):r.match(/^a=rtcp:/)?t.rtcp=r:r.match(/^a=ice-ufrag:/)?t.iceUfrag=r.substring(12):r.match(/^a=ice-pwd:/)?t.icePwd=r.substring(10):t.otherLines.push(r)}return i.forEach((e=>{const i=this.parseFmtpLine(e),a=t.codecs.find((e=>e.payloadType===i.payloadType));a&&(i.params?i.params.forEach(((e,t)=>{"apt"===t&&(a.associatedPayloadType=parseInt(e,10)),a.codecParams.set(t,e)})):(a.fmtpLines=[i.plain],"red"===a.codecName&&(a.associatedPayloadType=parseInt(i.plain.split("/")[0],10))))})),a.forEach((e=>{const i=this.parseRtcpFbLine(e),a=t.codecs.find((e=>e.payloadType===i.payloadType));a&&a.rtcpFbParams.push(i.params)})),t}static writeMediaSection(e){var t,i,a,s;const n=[];let r="m=".concat(e.type," ").concat(e.port," ").concat(e.protocol);return e.formats.forEach((e=>{r+=" "+e})),n.push(r),e.connection&&n.push(this.writeConnectionLine(e.connection)),e.bandwidth&&n.push(this.writeBandwidthLine(e.bandwidth)),e.rtcp&&n.push(e.rtcp),e.iceUfrag&&n.push("a=ice-ufrag:".concat(e.iceUfrag)),e.icePwd&&n.push("a=ice-pwd:".concat(e.icePwd)),e.otherLines.length&&n.push(...e.otherLines),n.push(this.writeMidLine(e.mid)),e.extensionMap.size&&e.extensionMap.forEach(((e,t)=>{n.push(this.writeExtensionMapLine(e))})),e.direction&&n.push(this.writeDirectionLine(e.direction)),e.msid&&n.push(this.writeMsidLine(e.msid)),e.rtcpMux&&n.push(this.writeRtcpMuxLine()),e.rtcpReducedSize&&n.push(this.writeRtcpReducedSizeLine()),e.codecs.forEach((e=>{const{payloadType:t,codecName:i,clockRate:a,channels:s,codecParams:r,fmtpLines:o,rtcpFbParams:c}=e;n.push(this.writeRtpMapLine({payloadType:t,codecName:i,clockRate:a,channels:s})),c.forEach((e=>{n.push(this.writeRtcpFbLine({payloadType:t,params:e}))})),r.size&&n.push(this.writeFmtpLine({payloadType:t,params:r})),null==o||o.forEach((e=>{n.push(this.writeFmtpLine({payloadType:t,plain:e}))}))})),null===(t=e.ssrcGroups)||void 0===t||t.forEach((e=>{n.push(this.writeSsrcGroupLine(e))})),null===(i=e.ssrcs)||void 0===i||i.forEach((e=>{n.push(this.writeSsrcLine(e))})),null===(a=e.rids)||void 0===a||a.forEach((e=>{n.push(this.writeRidLine(e))})),e.simulcast&&n.push(this.writeSimulcastLine(e.simulcast)),null===(s=e.candidates)||void 0===s||s.forEach((e=>{n.push(this.writeCandidateLine(e))})),n.join("\r\n")+"\r\n"}static parse(e){const t={session:null,media:[],application:[]},i=this.splitSections(e);return t.session=this.parseSessionSection(i.shift()),i.forEach((e=>{const i=this.parseMediaSection(e);switch(i.type){case"audio":case"video":t.media.push(i);break;case"application":t.application.push(i)}})),t}static write(e){let t=this.writeSessionSection(e.session);return e.media.forEach((e=>{t+=this.writeMediaSection(e)})),e.application.forEach((e=>{t+=this.writeMediaSection(e)})),t}}var de=i(8935);class le{static parseSdp(e){return ce.parse(e)}static writeSdp(e){return ce.write(e)}static cloneSdp(e){return"function"==typeof structuredClone?structuredClone(e):this.parseSdp(this.writeSdp(e))}static generateSsrc(){return Math.floor(4294967294*Math.random())+1}static generateId(){return Math.random().toString(36).substring(2,12)}static generateSessionId(){return Math.random().toString().substring(2,22)}static generateUuid(){const e=Array.from(Array(256).keys()).map((e=>e.toString(16).padStart(2,"0"))),t=crypto.getRandomValues(new Uint8Array(16));return t[6]=15&t[6]|64,t[8]=63&t[8]|128,Array.from(t.entries()).map((t=>{let[i,a]=t;return[4,6,8,10].includes(i)?"-".concat(e[a]):e[a]})).join("")}static generateIceCredentials(){const e=e=>[...Array(e)].map((()=>Math.random().toString(36).charAt(2))).join("");return{ice_ufrag:e(8),ice_pwd:e(22)}}static getSessionBoilerplate(){return"v=\r\no=- ".concat(this.generateSessionId()," 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n")}static getNtpSeconds(){return Math.floor((Date.now()+(Date.UTC(1970,0,1)-Date.UTC(1900,0,1)))/1e3)}static findHeaderExtensionByUri(e,t){for(const[i,a]of e.extensionMap)if(a.uri===t)return i;return-1}static addHeaderExtension(e,t){const{id:i}=t;return e.extensionMap.set(i,t),!0}static removeHeaderExtensionByUri(e,t){let i=!1;return e.extensionMap.forEach(((e,a,s)=>{e.uri===t&&(s.delete(a),i=!0)})),i}static removeMidRidHeaderExtensions(e){e.extensionMap.forEach(((e,t,i)=>{/^urn:ietf:params:rtp-hdrext:sdes:(?:mid|rtp-stream-id|repaired-rtp-stream-id)$/.test(e.uri)&&i.delete(t)}))}static updateCodecParameters(e,t,i,a,s,n){e.media.filter((e=>e.type===t&&e.direction===i)).forEach((e=>le.updateMLineCodecParameters(e,a,s,n)))}static updateMLineCodecParameters(e,t,i,a){e.codecs.filter((e=>e.codecName===t)).forEach((e=>{null==i||i.forEach(((t,i)=>{e.codecParams.set(i,t)})),null==a||a.forEach((t=>{e.rtcpFbParams.push(t)}))}))}static updateCodecParametersByMid(e,t,i,a){e.media.filter((e=>e.mid===t)).forEach((e=>le.updateMLineCodecParameters(e,i,a)))}static filterCodecs(e,t){e.media.forEach((e=>{const i=[];e.codecs.forEach((a=>{t&&!t(a,e)||i.push(a.payloadType)})),e.codecs.forEach((e=>{i.includes(e.associatedPayloadType)&&i.push(e.payloadType)})),e.formats=e.formats.filter((e=>i.includes(parseInt(e,10)))),e.codecs=e.codecs.filter((e=>i.includes(e.payloadType)))})),e.media=e.media.filter((e=>e.formats.length))}static filterH264Profiles(e,t,i){e.media.filter((e=>e.direction===t)).forEach((e=>{const t=[];e.codecs.filter((e=>"H264"===e.codecName)).forEach((e=>{var a;const s=parseInt(null===(a=e.codecParams.get("profile-level-id"))||void 0===a?void 0:a.substring(0,2),16);i.includes(s)&&t.push(e.payloadType)})),e.codecs.forEach((e=>{t.includes(e.associatedPayloadType)&&t.push(e.payloadType)})),e.formats=e.formats.filter((e=>t.includes(parseInt(e,10)))),e.codecs=e.codecs.filter((e=>t.includes(e.payloadType)))}))}static getH264ProfileIds(e,t,i){const a=new Set,s=e.media.find((e=>"video"===e.type&&e.direction===t));return null==s||s.codecs.forEach((e=>{if("H264"===e.codecName&&(void 0===i||parseInt(e.codecParams.get("packetization-mode"))===i)){var t;const i=parseInt(null===(t=e.codecParams.get("profile-level-id"))||void 0===t?void 0:t.substring(0,2),16);i&&a.add(i)}})),Array.from(a.values())}static getMediaStartBandwidth(e){var t;const i=null==e||null===(t=e.codecs[0])||void 0===t?void 0:t.codecParams.get("x-google-start-bitrate");return 1e3*parseInt(i,10)||void 0}static mungeEgressLocalOffer(e,t,i){let a,s,n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],r=0;if(e.media.forEach((e=>{const{extensionMap:t,type:i,direction:s}=e;t.forEach(((e,t)=>{t>r&&(r=t)})),"video"!==i||"sendonly"!==s||a||(a=e)})),!a)throw new Error("Failed to find a video media section for send");if(a.msid){a.msid.streamId=i;const{trackId:e}=a.msid;s="".concat(i," ").concat(e)}else s="".concat(i," ").concat(le.generateUuid());if(t>1&&n){a.rids=[],a.simulcast=null,a.ssrcs=[],a.ssrcGroups=[];const e=a.codecs.some((e=>"rtx"===e.codecName)),i=[],n=le.generateUuid();for(let r=0;r<t;r++){const t=le.generateSsrc();if(i.push(t),a.ssrcs.push({ssrc:t,attribute:"cname:"+n}),a.ssrcs.push({ssrc:t,attribute:"msid:"+s}),e){const e=le.generateSsrc();a.ssrcs.push({ssrc:e,attribute:"cname:"+n}),a.ssrcs.push({ssrc:e,attribute:"msid:"+s}),a.ssrcGroups.push({semantics:"FID",ssrcs:[t,e]})}}a.ssrcGroups.push({semantics:"SIM",ssrcs:i})}le.removeMidRidHeaderExtensions(a),(0,de.n_)()&&(0,de.nr)()&&15===(0,de.Cd)()&&1===(0,de.w_)()||le.removeHeaderExtensionByUri(a,"urn:3gpp:video-orientation");const o={uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time"};if(-1===le.findHeaderExtensionByUri(a,o.uri)&&(o.id=++r,le.addHeaderExtension(a,o)),t>1){e.session.extMapAllowMixed=!0;const t={uri:"http://www.webrtc.org/experiments/rtp-hdrext/video-layers-allocation00"};-1===le.findHeaderExtensionByUri(a,t.uri)&&(t.id=++r,le.addHeaderExtension(a,t))}}static mungeEgressOfferToRemote(e){e.session.timing={startTime:le.getNtpSeconds(),stopTime:0};const t=e.media.find((e=>"video"===e.type&&"sendonly"===e.direction));if((0,de.gm)()&&null!=t&&t.simulcast){t.rids=null,t.simulcast=null;const e=[];t.ssrcGroups.forEach((t=>{"FID"===t.semantics&&e.push(t.ssrcs[0])})),t.ssrcGroups.push({semantics:"SIM",ssrcs:e})}(0,de.gm)()&&e.media.forEach((e=>{"video"===e.type&&"recvonly"===e.direction&&e.codecs.forEach((e=>{"H264"===e.codecName&&"42e01f"===e.codecParams.get("profile-level-id")&&e.codecParams.set("profile-level-id","64001f")}))}))}static mungeEgressAnswer(e,t,i){if((0,de.gm)()&&t>1){const i=e.media.find((e=>"video"===e.type&&"recvonly"===e.direction));if(i){const e=[];for(let i=0;i<t;i++)e.push({rid:i.toString(),direction:"recv"});const a={direction:"recv",rids:[]};e.forEach((e=>{a.rids.push({id:e.rid})})),i.rids=e,i.simulcast=a}}(0,de.gm)()&&e.media.forEach((e=>{"video"===e.type&&"sendonly"===e.direction&&e.codecs.forEach((e=>{"H264"===e.codecName&&"64001f"===e.codecParams.get("profile-level-id")&&e.codecParams.set("profile-level-id","42e01f")}))})),i&&le.updateCodecParameters(e,"video","recvonly","H264",i)}static mungeIngressLocalOffer(e,t,i){le.updateCodecParameters(e,"video","recvonly","H264",t,i)}static updateIceCredential(e,t){const{ice_pwd:i,ice_ufrag:a}=t;e.media.forEach((e=>{e&&(e.icePwd=i,e.iceUfrag=a)}))}static getSSRCByMid(e,t){let i;const a=e.media.find((e=>e.mid==t)),{ssrcs:s}=a;return s.length&&(i=s[0].ssrc),i}static getMlineCodecFromLocalOffer(e,t,i){var a;return null===(a=e.media.find((e=>t===e.mid)))||void 0===a?void 0:a.codecs.find((e=>e.codecName===i))}static updateStreamIdByMid(e,t,i){const a=e.media.find((e=>e.mid===t));if(a.msid){const{trackId:e}=a.msid;a.msid.streamId=i,a.ssrcs&&a.ssrcs.forEach((t=>{0===t.attribute.indexOf("msid")&&(t.attribute="msid:".concat(i," ").concat(e))}))}}}const he=[{layerId:4,width:1920,height:1080,maxFramerate:30,minBitrate:25e5,targetBitrate:5e6,maxBitrate:5e6},{layerId:4,width:1600,height:900,maxFramerate:30,minBitrate:15e5,targetBitrate:3e6,maxBitrate:3e6},{layerId:3,width:1280,height:720,maxFramerate:30,minBitrate:8e5,targetBitrate:2e6,maxBitrate:2e6},{layerId:3,width:960,height:540,maxFramerate:30,minBitrate:55e4,targetBitrate:12e5,maxBitrate:12e5},{layerId:2,width:640,height:360,maxFramerate:30,minBitrate:25e4,targetBitrate:5e5,maxBitrate:7e5},{layerId:2,width:480,height:270,maxFramerate:30,minBitrate:18e4,targetBitrate:35e4,maxBitrate:45e4},{layerId:1,width:320,height:180,maxFramerate:30,minBitrate:1e5,targetBitrate:15e4,maxBitrate:2e5},{layerId:1,width:256,height:144,maxFramerate:30,minBitrate:6e4,targetBitrate:1e5,maxBitrate:13e4}];function ue(e){const t=e.map(((e,t)=>Object.assign(Object.assign({},e),{formatIndex:t})));x.setLayersSettings(t)}function me(e){x.setEnabledLayerIds(e)}function pe(){return x.layersSettings}function ge(){return x.enabledLayerIds}function Se(){return ge()[0]}function _e(e){return ge().includes(e)}function ve(){const e=ge();return e[e.length-1]}function fe(e){var t;return null===(t=pe())||void 0===t?void 0:t[e]}function ye(e){const t=pe();if(!t)return;const i=t.findIndex((t=>t.layerId===e));return i>=0?fe(i):void 0}function Me(e){const t=pe();if(t)for(let i=t.length-1;i>=0;i--)if(t[i].layerId===e)return fe(i)}function Ce(e){const t=pe();if(!t)return;const i=t.findIndex((t=>t.layerId<=e));return i>=0?fe(i):void 0}function Ee(e){var t;return(null===(t=ye(e))||void 0===t?void 0:t.targetBitrate)||0}function Ie(e,t){const i=ye(e);if(i){const{width:e,height:a,maxBitrate:s}=i;return Math.floor(t.width*t.height/(e*a)*s)}}function Te(e){const t=e.width*e.height;return t>921600?4:t>307200?3:t>76800?2:t>19200?1:t>0?0:-1}function Ae(e){var t,i;return!!(null===(i=null===(t=x.videoSettings)||void 0===t?void 0:t.preferSoftwareCodec)||void 0===i?void 0:i[e])}class Re{constructor(e){this._array=new Array(e),this._size=e,this._index=0,this._count=0}get size(){return this._size}get count(){return this._count}empty(){return 0===this._count}full(){return this._count===this._size}clear(){this._array=new Array(this._size),this._index=0,this._count=0}fill(e){return this._array.fill(e),this._index=0,this._count=this._size,this}get lastIndex(){return 0===this._index?this._size-1:this._index-1}nextIndex(e){return(e+1)%this._size}push(e){this._array[this._index]=e,this._index=this.nextIndex(this._index),this._count<this._size&&this._count++}pop(){if(this.empty())return;const e=this.lastIndex;return this._index=e,this._count>0&&this._count--,this._array[e]}at(e){if(!(this._count<this._size&&e>=this._count))return this._array[e]}front(){if(!this.empty())return this._array[this._count<this.size?0:this._index]}back(){if(!this.empty())return this._array[this.lastIndex]}unwrap(){return this._count<this._size?this._array.slice(0,this._count):[...this._array.slice(this._index),...this._array.slice(0,this._index)]}findIndex(e){if(this._count<this._size){for(let t=0;t<this._count;t++)if(e(this._array[t]))return t}else{for(let t=this._index;t<this._size;t++)if(e(this._array[t]))return t;for(let t=0;t<this._index;t++)if(e(this._array[t]))return t}return-1}findLastIndex(e){if(this._count<this._size){for(let t=this._count-1;t>=0;t--)if(e(this._array[t]))return t}else{for(let t=this._size-1;t>=this._index;t--)if(e(this._array[t]))return t;for(let t=this._index-1;t>=0;t--)if(e(this._array[t]))return t}return-1}find(e){const t=this.findIndex(e);return-1===t?void 0:this._array[t]}findLast(e){const t=this.findLastIndex(e);return-1===t?void 0:this._array[t]}}function be(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,a)}return i}function we(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?be(Object(i),!0).forEach((function(t){(0,c.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):be(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}te.getTracer("WmscStats");class De{constructor(){this.sendStatsMonitor=new Le({cacheSize:De.sendStatsCacheSize}),this.recvStatsMonitor=new Pe({cacheSize:De.recvStatsCacheSize}),this.sendUsageStatsEnabled=!1,this.recvUsageStatsEnabled=!1,this.maxEncodingFramerate=30,this.resourceUsageStatsReportTimestamp=0,this.resourceUsageStatsIntervalId=null,this.resourceUsageStatsCallback=null}onStats(e){e.forEach((e=>{this.sendStatsMonitor.onStatsReport(e),this.recvStatsMonitor.onStatsReport(e)}))}getSendStatsMonitor(){return this.sendStatsMonitor}getRecvStatsMonitor(){return this.recvStatsMonitor}setOptions(e){const{sendUsageStatsEnabled:t,recvUsageStatsEnabled:i,maxEncodingFramerate:a}=e||{};void 0!==t&&(this.sendUsageStatsEnabled=t),void 0!==i&&(this.recvUsageStatsEnabled=i),void 0!==a&&(this.maxEncodingFramerate=a)}start(e){e&&this.setOptions(e),this.sendUsageStatsEnabled&&this.sendStatsMonitor.setOptions({outboundRtpStatsEnabled:!0}),this.sendStatsMonitor.start(),this.recvUsageStatsEnabled&&this.recvStatsMonitor.setOptions({inboundRtpStatsEnabled:!0}),this.recvStatsMonitor.start(),(this.sendUsageStatsEnabled||this.recvUsageStatsEnabled)&&(this.resourceUsageStatsIntervalId=setInterval((()=>{this._reportResourceUsageStats()}),De.resourceUsageCheckInterval))}stop(){this.sendStatsMonitor.stop(),this.recvStatsMonitor.stop(),clearInterval(this.resourceUsageStatsIntervalId),this.resourceUsageStatsIntervalId=null}reset(){this.sendStatsMonitor.reset(),this.recvStatsMonitor.reset(),this.resourceUsageStatsReportTimestamp=0}registerOutgoingBitrateStatsCallback(e){this.sendStatsMonitor.outgoingBitrateStatsCallback=e}registerResourceUsageStatsCallback(e){this.resourceUsageStatsCallback=e}_reportResourceUsageStats(){var e;const t={};let i=0;if(this.sendUsageStatsEnabled){const e=this._getSendResourceUsageStats();(null==e?void 0:e.duration)>0&&(t.send=we({},e),i=Math.max(i,e.timestamp))}if(this.recvUsageStatsEnabled){const e=this._getRecvResourceUsageStats();(null==e?void 0:e.duration)>0&&(t.recv=we({},e),i=Math.max(i,e.timestamp))}this.resourceUsageStatsReportTimestamp=i,null===(e=this.resourceUsageStatsCallback)||void 0===e||e.call(this,t)}_getSendResourceUsageStats(){const e=this.sendStatsMonitor.getMediaSourceStats();if(!this.sendStatsMonitor.isStarted()||e.empty())return;const t=e.back(),i=Math.max(this.resourceUsageStatsReportTimestamp-500,t.timestamp-De.resourceUsageCheckInterval-500),a=e.find((e=>e.timestamp>i)),s=void 0!==t.frames&&void 0!==(null==a?void 0:a.frames)?t.frames-a.frames:void 0,{NONE:n,UNDERUSING:r,NORMAL:o,OVERUSING:c}=C,d=this.sendStatsMonitor.getOutboundRtpStats(),l=1e3/this.maxEncodingFramerate;let h=0,u=0,m=0,p=0,g=0,S=n,_=-1,v=0,f=null,y=-1;for(const[e,t]of d){const e=t.back();if(p=Math.max(p,e.timestamp),t.count<2)continue;const i=t.unwrap(),a=Math.max(this.resourceUsageStatsReportTimestamp-500,e.timestamp-De.resourceUsageCheckInterval-500);let s=-1;for(let e=1;e<i.length;e++){const t=i[e-1],n=i[e];t.timestamp>a&&(-1===s&&(s=e-1),n.framesEncoded<t.framesEncoded&&(s=e))}if(-1===s)continue;const n=i[s],r=e.framesEncoded-n.framesEncoded,o=e.framesSent-n.framesSent,c=e.timestamp-n.timestamp,d=Te({width:e.frameWidth,height:e.frameHeight});c<De.resourceUsageMinTimeSlice||(r>0&&(d>_&&(_=d,f=i,y=s),g=Math.max(g,e.timestamp)),h+=r,u+=o,m=Math.max(m,c))}if(f&&f.length>0){const e=f[y],t=f[f.length-1],i=t.framesEncoded-e.framesEncoded,a=t.framesSent-e.framesSent,s=t.timestamp-e.timestamp,d=i>0?1e3*(t.totalEncodeTime-e.totalEncodeTime)/i:0,h=i>0&&void 0!==t.qpSum&&void 0!==e.qpSum?Math.round((t.qpSum-e.qpSum)/i):0;v=h;let u,m,p=n,g=n;if(i>=De.encodeTimeMinFrameCount&&(p=d>=l*De.encodeTimeFactorThresholdCritical?c:d<l*De.encodeTimeFactorThresholdNormal?r:o),t.qualityLimitationDurations)if(u=1e3*(t.qualityLimitationDurations.cpu-e.qualityLimitationDurations.cpu)/s,m=1e3*(t.qualityLimitationDurations.other-e.qualityLimitationDurations.other)/s,u>=De.qualityLimitationRatioThresholdCritical||m>=De.qualityLimitationRatioThresholdCritical){g=c;const e="WMSC_Perf_Control: cpuLimitationRatio ".concat(u);te.monitorLog(e),te.globalTrace({logLevel:"log",log:e,tags:["WMSC_Perf_Control"]})}else g=u<De.qualityLimitationRatioThresholdNormal&&m<De.qualityLimitationRatioThresholdNormal?r:o;S=p,K(g,S)>0&&(S=g),"Encoding SSRC ".concat(t.ssrc,", usageState: ").concat(S,", duration: ").concat(Math.round(s)," ms"),", framesEncoded: ".concat(i,", framesSent: ").concat(a,", avgEncodeTime: ").concat(Math.round(d)," ms"),", cpuLimitationRatio: ".concat(u,", otherLimitationRatio: ").concat(m,", avgQp: ").concat(h),", pliCount: ".concat(t.pliCount-e.pliCount,", videoSize: ").concat(_)}return{usageState:S,framesCaptured:s,framesEncoded:h,framesSent:u,duration:m,maxVideoSize:_,maxVideoSizeAvgQp:v,encodeTimestamp:g,timestamp:p}}_getRecvResourceUsageStats(){if(!this.recvStatsMonitor.isStarted())return;const{NONE:e,UNDERUSING:t,NORMAL:i,OVERUSING:a}=C,s=this.recvStatsMonitor.getInboundRtpStats();let n=0,r=0,o=0,c=0,d=0,l=e,h=e,u=-1,m=0,p=0;for(const[M,C]of s){var g,S,_,v,f,y;const s=C.back();if(d=Math.max(d,s.timestamp),C.count<2)continue;const E=C.unwrap(),I=Math.max(this.resourceUsageStatsReportTimestamp-500,s.timestamp-De.resourceUsageCheckInterval-500);let T=-1;for(let e=1;e<E.length;e++){const t=E[e-1],i=E[e];t.timestamp>I&&(-1===T&&(T=e-1),i.framesDecoded<t.framesDecoded&&(T=e))}if(-1===T)continue;const A=E[T],R=s.framesReceived-A.framesReceived,b=(null!==(g=s.framesDropped)&&void 0!==g?g:0)-(null!==(S=A.framesDropped)&&void 0!==S?S:0),w=s.framesDecoded-A.framesDecoded,D=s.timestamp-A.timestamp,L=Te({width:s.frameWidth,height:s.frameHeight});if(n+=R,r+=b,o+=w,c=Math.max(c,D),0===R||D<De.resourceUsageMinTimeSlice||L<u)continue;const P=D/R,O=Math.min(1e3*(s.totalDecodeTime-A.totalDecodeTime),D),V=w?O/w:0,N=R?b/R:0,k=(null!==(_=s.freezeCount)&&void 0!==_?_:0)-(null!==(v=A.freezeCount)&&void 0!==v?v:0),B=1e3*((null!==(f=s.totalFreezesDuration)&&void 0!==f?f:0)-(null!==(y=A.totalFreezesDuration)&&void 0!==y?y:0));let U=e,x=e;L>u?(u=L,m=N,p=B):L===u&&(N>m&&(m=N),B>p&&(p=B)),x=m>=De.decodingFrameDropRateThresholdCritical||p>=D*De.freezesDurationRatioThresholdCritical?a:m<De.decodingFrameDropRateThresholdNormal&&p<D*De.freezesDurationRatioThresholdNormal?t:i,U=w>=De.decodeTimeMinFrameCount&&V>=P*De.decodeTimeFactorThresholdCritical&&R>w?a:w>=De.decodeTimeMinFrameCount&&V<P*De.decodeTimeFactorThresholdNormal?t:i;const F=s.keyFramesDecoded-A.keyFramesDecoded,W=s.pliCount-A.pliCount;"Decoding SSRC ".concat(M,", usageState: ").concat(U,", networkUsageState: ").concat(x,", duration: ").concat(Math.round(D)," ms"),", framesReceived: ".concat(R,", framesDropped: ").concat(b,", framesDecoded: ").concat(w," (").concat(F,")"),", avgDecodeTime: ".concat(Math.round(V)," ms, freezeCount: ").concat(k,", freezesDuration: ").concat(Math.round(B)," ms"),", pliCount: ".concat(W,", videoSize: ").concat(L),K(U,l)>0&&(l=U),K(x,h)>0&&(h=x)}return{usageState:l,networkUsageState:h,framesReceived:n,framesDropped:r,framesDecoded:o,maxVideoSize:u,duration:c,timestamp:d}}}(0,c.A)(De,"sendStatsCacheSize",4),(0,c.A)(De,"recvStatsCacheSize",4),(0,c.A)(De,"resourceUsageMinTimeSlice",1500),(0,c.A)(De,"resourceUsageCheckInterval",3e3),(0,c.A)(De,"encodeTimeMinFrameCount",10),(0,c.A)(De,"encodeTimeFactorThresholdNormal",.9),(0,c.A)(De,"encodeTimeFactorThresholdCritical",1.1),(0,c.A)(De,"qualityLimitationRatioThresholdNormal",.05),(0,c.A)(De,"qualityLimitationRatioThresholdCritical",.95),(0,c.A)(De,"decodeTimeMinFrameCount",10),(0,c.A)(De,"decodeTimeFactorThresholdNormal",.9),(0,c.A)(De,"decodeTimeFactorThresholdCritical",1.1),(0,c.A)(De,"decodingFrameDropRateThresholdNormal",.05),(0,c.A)(De,"decodingFrameDropRateThresholdCritical",.2),(0,c.A)(De,"freezesDurationRatioThresholdNormal",.05),(0,c.A)(De,"freezesDurationRatioThresholdCritical",.25);class Le{constructor(e){this.cacheSize=e.cacheSize||10,this.started=!1,this.selectedCandidatePairId=null,this.roundTripTime=0,this.remoteCandidateId=null,this.networkProtocol=null,this.localCandidateId=null,this.candidateType=null,this.outboundRtpStatsEnabled=!1,this.outboundRtpStatsMap=new Map,this.mediaSourceStats=new Re(this.cacheSize),this.outgoingBitrateStatsCallback=null}reset(){this.resetCandidateStats(),this.resetOutboundRtpStats(),this.resetMediaSourceStats()}resetCandidateStats(){this.selectedCandidatePairId=null,this.roundTripTime=0,this.remoteCandidateId=null,this.networkProtocol=null}resetOutboundRtpStats(){this.outboundRtpStatsMap.clear()}resetMediaSourceStats(){this.mediaSourceStats.clear()}setOptions(e){const{outboundRtpStatsEnabled:t}=e||{};void 0!==t&&(this.outboundRtpStatsEnabled=t)}start(e){e&&this.setOptions(e),this.started=!0}stop(){this.started=!1}isStarted(){return this.started}getNetworkProtocol(){return this.networkProtocol}getCurrentRoundTripTime(){return this.roundTripTime}getOutboundRtpStats(){return this.outboundRtpStatsMap}getMediaSourceStats(){return this.mediaSourceStats}onStatsReport(e){if(this.started)switch(e.type){case"transport":this.onTransportStats(e);break;case"candidate-pair":this.onCandidatePairStats(e);break;case"remote-candidate":this.onRemoteCandidateStats(e);break;case"outbound-rtp":this.onOutboundRtpStats(e);break;case"local-candidate":this.onLocalCandidateStats(e);break;case"media-source":this.onMediaSourceStats(e)}}onTransportStats(e){const{selectedCandidatePairId:t,dtlsState:i}=e;"connected"===i&&(this.selectedCandidatePairId=t)}onCandidatePairStats(e){const{id:t,state:i,nominated:a,availableOutgoingBitrate:s,currentRoundTripTime:n,remoteCandidateId:r,timestamp:o,localCandidateId:c}=e;var d;t===this.selectedCandidatePairId&&"succeeded"===i&&a&&(this.roundTripTime=n,this.remoteCandidateId=r,this.localCandidateId=c,null===(d=this.outgoingBitrateStatsCallback)||void 0===d||d.call(this,{availableOutgoingBitrate:s,timestamp:o}))}onRemoteCandidateStats(e){const{id:t,protocol:i,port:a}=e;if(t===this.remoteCandidateId&&!this.networkProtocol){this.networkProtocol=i;const e="WMSC_Network_Change: send|".concat(i,"|").concat(a);te.globalTrace({logLevel:"log",log:e,tags:["WMSC_Network_Change"]}),te.monitorLog(e)}}onLocalCandidateStats(e){const{id:t,candidateType:i}=e;if(t==this.localCandidateId&&this.candidateType!=i){this.candidateType=i;const e="WMSC_LocalCandidatae_Change:send|".concat(i);te.globalTrace({logLevel:"directReport",log:e,tags:["WMSC_LocalCandidatae_Change"]}),te.monitorLog(e)}}onOutboundRtpStats(e){if(!this.outboundRtpStatsEnabled||"video"!==e.kind)return;const{ssrc:t,framesEncoded:i,framesSent:a,totalEncodeTime:s,qualityLimitationDurations:n,pliCount:r,frameWidth:o,frameHeight:c,qpSum:d,timestamp:l}=e;let h=this.outboundRtpStatsMap.get(t);h||(h=new Re(this.cacheSize),this.outboundRtpStatsMap.set(t,h)),h.push({ssrc:t,framesEncoded:i,framesSent:a,totalEncodeTime:s,qualityLimitationDurations:n,pliCount:r,frameWidth:o,frameHeight:c,qpSum:d,timestamp:l})}onMediaSourceStats(e){if("video"!==e.kind)return;const{frames:t,width:i,height:a,timestamp:s}=e;this.mediaSourceStats.push({frames:t,width:i,height:a,timestamp:s})}}class Pe{constructor(e){this.cacheSize=e.cacheSize||10,this.started=!1,this.selectedCandidatePairId=null,this.roundTripTime=0,this.remoteCandidateId=null,this.networkProtocol=null,this.localCandidateId=null,this.candidateType=null,this.inboundRtpStatsEnabled=!1,this.inboundRtpStatsMap=new Map}reset(){this.resetCandidateStats(),this.resetInboundRtpStats()}resetCandidateStats(){this.selectedCandidatePairId=null,this.roundTripTime=0,this.remoteCandidateId=null,this.networkProtocol=null}resetInboundRtpStats(){this.inboundRtpStatsMap.clear()}setOptions(e){const{inboundRtpStatsEnabled:t}=e||{};void 0!==t&&(this.inboundRtpStatsEnabled=t)}start(e){e&&this.setOptions(e),this.started=!0}stop(){this.started=!1}isStarted(){return this.started}getNetworkProtocol(){return this.networkProtocol}getCurrentRoundTripTime(){return this.roundTripTime}getInboundRtpStats(){return this.inboundRtpStatsMap}onStatsReport(e){if(this.started)switch(e.type){case"transport":this.onTransportStats(e);break;case"candidate-pair":this.onCandidatePairStats(e);break;case"remote-candidate":this.onRemoteCandidateStats(e);break;case"inbound-rtp":this.onInboundRtpStats(e);break;case"local-candidate":this.onLocalCandidateStats(e)}}onTransportStats(e){const{selectedCandidatePairId:t,dtlsState:i}=e;"connected"===i&&(this.selectedCandidatePairId=t)}onCandidatePairStats(e){const{id:t,state:i,nominated:a,currentRoundTripTime:s,remoteCandidateId:n,localCandidateId:r}=e;t===this.selectedCandidatePairId&&"succeeded"===i&&a&&(this.roundTripTime=s,this.remoteCandidateId=n,this.localCandidateId=r)}onRemoteCandidateStats(e){const{id:t,protocol:i,port:a}=e;if(t===this.remoteCandidateId&&!this.networkProtocol){this.networkProtocol=i;const e="WMSC_Network_Change: recv|".concat(i,"|").concat(a);te.globalTrace({logLevel:"log",log:e,tags:["WMSC_Network_Change"]}),te.monitorLog(e)}}onLocalCandidateStats(e){const{id:t,candidateType:i}=e;if(t==this.localCandidateId&&this.candidateType!=i){this.localCandidateId=t,this.candidateType=i;const e="WMSC_LocalCandidatae_Change:recv|".concat(i);te.globalTrace({logLevel:"directReport",log:e,tags:["WMSC_LocalCandidatae_Change"]}),te.monitorLog(e)}}onInboundRtpStats(e){if(!this.inboundRtpStatsEnabled||"video"!==e.kind||!e.framesReceived)return;const{ssrc:t,framesDecoded:i,framesDropped:a,framesReceived:s,keyFramesDecoded:n,totalDecodeTime:r,totalFreezesDuration:o,freezeCount:c,pliCount:d,frameWidth:l,frameHeight:h,timestamp:u}=e;let m=this.inboundRtpStatsMap.get(t);m||(m=new Re(this.cacheSize),this.inboundRtpStatsMap.set(t,m)),m.push({ssrc:t,framesDecoded:i,framesDropped:a,framesReceived:s,keyFramesDecoded:n,totalDecodeTime:r,totalFreezesDuration:o,freezeCount:c,pliCount:d,frameWidth:l,frameHeight:h,timestamp:u})}}const Oe=new De;function Ve(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,a)}return i}function Ne(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Ve(Object(i),!0).forEach((function(t){(0,c.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Ve(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const ke=te.getTracer("WmscQosMgr"),Be=e=>{ke.log(e),te.monitorLog("".concat(e))},Ue=e=>{Be("WMSC_Perf_Control: ".concat(e)),te.globalTrace({logLevel:"log",log:e,tags:["WMSC_Perf_Control"]})},xe=Object.freeze({None:0,Increase:1,Decrease:2}),Fe=Object.freeze({User:0,OutgoingBandwidth:1,ReceiverBandwidth:2,OutgoingBandwidthProbing:3,Other:4}),We=Object.freeze({Low:0,Medium:1,High:2}),ze="NoLayersAllocation";class je{constructor(){this.outgoingBandwidthAdaptationEnabled=!0,this.outgoingBandwidthProbingEnabled=!0,this.outgoingBandwidthFromServer=!1,this.receiverBandwidthAdaptationEnabled=!0,this.additionalSubLayersEnabled=!0,this.reduceTopLayerBitrateEnabled=!0,this.performanceAdaptationEnabled=!0,this.maxEncodingLayers=3,this.sendActive=!1,this.sendActivatedTime=0,this.videoSourceLive=!1,this.videoSourceLiveTime=0,this.pendingLayersUpdate=Promise.resolve(),this.requestedLayerIds=[],this.additionalSubLayerIds=[],this.layersAllocation=[],this.layersAllocationCache=null,this.outgoingBandwidthProbingScheduledTime=0,this.maxSubVideoSize=-1,this.maxFormatIndex=-1,this.feasibleFormatIndex=-1,this.failedEncodings=new Map,this.sendUsageStateHistory=new Re(je.resourceUsageStateHistorySize),this.sendUsageAdjustments=new Re(je.resourceUsageAdjustmentHistorySize),this.sendUsageIncreaseFailedAttempts=0,this.sendUsageIncreaseFailedTime=0,this.maxFeasibleRecvSize=T,this.recvUsageStateHistory=new Re(je.resourceUsageStateHistorySize),this.recvUsageAdjustments=new Re(je.resourceUsageAdjustmentHistorySize),this.recvUsageIncreaseFailedAttempts=0,this.recvUsageIncreaseFailedTime=0,this.recvNetworkUnderuseStartTime=0,this.outgoingBandwidthReport=null,this.receiverBandwidthReport=null,this.receiverL3BandwidthEvaluation=null,this.receiverBandwidthUpdatePending=!1,this.receiverBandwidthUpdateTimeoutId=null,this.isDualCall=!0,this.audioBandwidth=0,this.videoStartBandwidth=0,this.framingDelayStats=new Re(je.maxFramingDelayWindowSize),this.decreaseBitrateWindow=5,this.increaseBitrateWindow=5,this.decreaseBitrateRate=.5,this.increaseBitrateRate=.7,this.maxEncodeBitrate=0,this.currentMaxEncodeBitrate=0,this.messageCallback=null,this.maxRecvVideoSizeUpdateCallback=null,this.sendUsageStateUpdateCallback=null,Oe.registerOutgoingBitrateStatsCallback(this.onOutgoingBandwidthStats.bind(this)),Oe.registerResourceUsageStatsCallback(this.onResourceUsageStats.bind(this))}static areLayersAllocationsEqual(e,t){return e.length===t.length&&e.every(((e,i)=>{const a=t[i];return e.layerId===a.layerId&&e.maxBitrate===a.maxBitrate&&(s=e.format,n=a.format,s.width===n.width&&s.height===n.height);var s,n}))}static isBitrateChangeAboveRatio(e,t,i){return!e||Math.abs(t-e)/e>i}static getLayersChangePriority(e){switch(e){case Fe.User:return We.High;case Fe.ReceiverBandwidth:return We.Medium;default:return We.Low}}static getHighestFormatIndex(e){return e.length?e[e.length-1].format.formatIndex:-1}static isBandwidthReason(e){return e===Fe.OutgoingBandwidth||e===Fe.ReceiverBandwidth||e===Fe.OutgoingBandwidthProbing}_resetSendUsageStats(){Oe.getSendStatsMonitor().resetOutboundRtpStats()}_resetRecvUsageStats(){Oe.getRecvStatsMonitor().resetInboundRtpStats()}_resetLayersAllocation(){this.pendingLayersUpdate=Promise.resolve(),this.requestedLayerIds=[],this.additionalSubLayerIds=[],this.layersAllocation=[],this.layersAllocationCache=null}_resetBandwidthState(){this._stopReceiverBandwidthUpdateWait(),this._resetReceiverBandwidth(),this.outgoingBandwidthReport=null,this.isDualCall=!0}resetSendUsageState(){this.feasibleFormatIndex=-1,this.sendUsageStateHistory.clear(),this.sendUsageAdjustments.clear(),this.sendUsageIncreaseFailedAttempts=0,this.sendUsageIncreaseFailedTime=0,this._resetSendUsageStats()}resetRecvUsageState(){this.maxFeasibleRecvSize=T,this.recvUsageStateHistory.clear(),this.recvUsageAdjustments.clear(),this.recvUsageIncreaseFailedAttempts=0,this.recvUsageIncreaseFailedTime=0,this.recvNetworkUnderuseStartTime=0,this._resetRecvUsageStats()}resetSend(){this.sendActive=!1,this.sendActivatedTime=0,this.videoSourceLive=!1,this.videoSourceLiveTime=0,this._resetLayersAllocation(),this._resetBandwidthState(),this.resetSendUsageState()}resetRecv(){this.maxSubVideoSize=-1,this.resetRecvUsageState()}registerMessageCallback(e){this.messageCallback=e}registerMaxRecvVideoSizeUpdateCallback(e){this.maxRecvVideoSizeUpdateCallback=e}registerSendUsageStateUpdateCallback(e){this.sendUsageStateUpdateCallback=e}setOptions(e){const{outgoingBandwidthAdaptationEnabled:t,outgoingBandwidthProbingEnabled:i,receiverBandwidthAdaptationEnabled:a,performanceAdaptationEnabled:s}=e||{};void 0!==t&&(this.outgoingBandwidthAdaptationEnabled=t),void 0!==i&&(this.outgoingBandwidthProbingEnabled=i),void 0!==a&&(this.receiverBandwidthAdaptationEnabled=a),void 0!==s&&(this.performanceAdaptationEnabled=s)}setVideoSourceLiveState(e){this.videoSourceLive!==e&&(this.videoSourceLive=e,this.videoSourceLiveTime=e?Date.now():0)}setMaxEncodingLayers(e){this.maxEncodingLayers=e}setMaxEncodingFramerate(e){Oe.setOptions({maxEncodingFramerate:e})}setVideoStartBandwidth(e){if(this.videoStartBandwidth=e,this.outgoingBandwidthAdaptationEnabled){const t=e+this.audioBandwidth;Be("WMSC_Set_Start_Bandwidth: ".concat(t))}}getStartBandwidth(){return this.videoStartBandwidth+this.audioBandwidth}setAudioBandwidth(e){this.audioBandwidth!==e&&(Be("WMSC_Set_Audio_Bandwidth: ".concat(e)),this.audioBandwidth=e,this.allocateBitrate(this._getAvailableBitrate(),Fe.OutgoingBandwidth))}start(e){const t=pe();this.maxFormatIndex=t[t.length-1].formatIndex,this.maxEncodeBitrate=ye(ve()).maxBitrate,e&&this.setOptions(e),(0,de.gm)()&&(this.outgoingBandwidthFromServer=!0);const i={};this.performanceAdaptationEnabled&&(i.sendUsageStatsEnabled=!0,i.recvUsageStatsEnabled=!0),Oe.start(i)}stop(){Oe.stop(),this.resetSend(),this.resetRecv()}_queueLayersUpdate(e){return this.pendingLayersUpdate=this.pendingLayersUpdate.then((()=>e())).catch((e=>{e.message!==ze&&te.globalTrace({logLevel:"error",log:e.message,tags:["WMSC_Update_Layers"]})})),this.pendingLayersUpdate}updateLayers(e){ke.log("updateLayers, ".concat(e)),this.requestedLayerIds=this.isDualCall&&e.length>1?e.slice(-1):[...e],this._setSendState(!!e.length),this.allocateBitrate(this._getAvailableBitrate(),Fe.User)}_setSendState(e){this.sendActive!==e&&(this.sendActive=e)}updateMaxSubVideoSize(e){this.maxSubVideoSize=e}getMaxFeasibleRecvVideoSize(){return this.maxFeasibleRecvSize}_resetReceiverBandwidth(){this.receiverBandwidthReport=null,this.receiverL3BandwidthEvaluation=null}_waitBeforeReceiverBandwidthUpdate(){this.receiverBandwidthUpdatePending=!0,clearTimeout(this.receiverBandwidthUpdateTimeoutId),this.receiverBandwidthUpdateTimeoutId=setTimeout((()=>{this.receiverBandwidthUpdatePending=!1}),je.receiverBandwidthUpdateDelay)}_stopReceiverBandwidthUpdateWait(){clearTimeout(this.receiverBandwidthUpdateTimeoutId),this.receiverBandwidthUpdateTimeoutId=null,this.receiverBandwidthUpdatePending=!1}onOutgoingBandwidthStats(e){if(this.outgoingBandwidthFromServer||!this.outgoingBandwidthAdaptationEnabled||!this.sendActive)return;const{availableOutgoingBitrate:t=1/0}=e;this._updateOutgoingBandwidth(t)}onResourceUsageStats(e){e.send&&this.sendActive&&this._handleSendUsageStats(e.send),e.recv&&this._handleRecvUsageStats(e.recv)}_handleSendUsageStats(e){this.performanceAdaptationEnabled&&this._handleSendPerformanceStats(e)}_handleRecvUsageStats(e){this.performanceAdaptationEnabled&&this._handleRecvPerformanceStats(e)}_handleSendPerformanceStats(e){var t,i;const{usageState:a,framesCaptured:s,framesEncoded:n,maxVideoSize:r,encodeTimestamp:o,timestamp:c}=e,d=this.sendUsageStateHistory.back(),l=(null===(t=this.sendUsageAdjustments.back())||void 0===t?void 0:t.time)||0,{UNDERUSING:h,OVERUSING:u}=C,m=je.getHighestFormatIndex(this.layersAllocation);let p=xe.None;null===(i=this.sendUsageStateUpdateCallback)||void 0===i||i.call(this,a,m);const g=c-je.encodingTimeout,S=this.videoSourceLiveTime&&this.videoSourceLiveTime<g&&this.sendActivatedTime&&this.sendActivatedTime<g&&s>0&&(0===n||c-o>=je.encodingTimeout);if(S){const e=(this.failedEncodings.get(m)||0)+1;this.failedEncodings.set(m,e),p=xe.Decrease}else d&&d.timestamp>l&&d.maxVideoSize===r&&d.usageState===a&&(a===u?x.isMacIntel||(p=xe.Decrease):a===h&&(p=xe.Increase));this.sendUsageStateHistory.push({usageState:a,maxVideoSize:r,timestamp:c}),this._maybeAdjustMaxSendSize(m,p)&&(Be("WMSC_VEnc_Cap_Change: ".concat(this.feasibleFormatIndex,"|").concat(a,"|").concat(S)),this.allocateBitrate(this._getAvailableBitrate(),Fe.Other))}_handleRecvPerformanceStats(e){var t;const{usageState:i,networkUsageState:a,maxVideoSize:s,timestamp:n}=e,r=this.recvUsageStateHistory.back(),o=(null===(t=this.recvUsageAdjustments.back())||void 0===t?void 0:t.time)||0,{UNDERUSING:c,OVERUSING:d}=C;let l=xe.None,h=xe.None,u=xe.None;var m;a===c?this.recvNetworkUnderuseStartTime||(this.recvNetworkUnderuseStartTime=n):this.recvNetworkUnderuseStartTime=0,r&&r.timestamp>o&&r.maxVideoSize===s&&(r.networkUsageState===a&&(a===d?h=xe.Decrease:a===c&&n-this.recvNetworkUnderuseStartTime>=je.recvNetworkCoolDownTime&&(h=xe.Increase)),r.usageState===i&&(i===d?u=xe.Decrease:i===c&&(u=xe.Increase)),h===xe.Increase&&u===xe.Increase?l=xe.Increase:h!==xe.Decrease&&u!==xe.Decrease||(l=xe.Decrease)),this.recvUsageStateHistory.push({usageState:i,networkUsageState:a,maxVideoSize:s,timestamp:n}),this._maybeAdjustMaxRecvSize(s,l,l!==u)&&(Be("WMSC_VDec_Cap_Change: ".concat(this.maxFeasibleRecvSize,"|").concat(i,"|").concat(a)),null===(m=this.maxRecvVideoSizeUpdateCallback)||void 0===m||m.call(this,this.maxFeasibleRecvSize))}_maybeAdjustMaxSendSize(e,t){const i=Date.now();let a=-1;if(t===xe.Decrease){if(e<this.maxFormatIndex){const t=this.sendUsageAdjustments.back();t&&t.layerChange!==xe.Increase||(this.sendUsageIncreaseFailedAttempts++,this.sendUsageIncreaseFailedTime=i,Ue("Attempt to increase layer failed ".concat(this.sendUsageIncreaseFailedAttempts," times"))),a=e+1}}else if(t===xe.Increase){const t=Math.min(je.resourceUsageIncreaseMaxAttempts-1,this.sendUsageIncreaseFailedAttempts);if(this.feasibleFormatIndex>=0&&e>0&&i-this.sendUsageIncreaseFailedTime>=je.resourceUsageIncreaseInitialDelay*Math.pow(2,t-1)){const t=Math.min(this.feasibleFormatIndex,e-1);(this.failedEncodings.get(t)||0)<je.encodingFailMaxRetries&&(a=t)}}return a>=0&&this.feasibleFormatIndex!==a&&(this.feasibleFormatIndex=a,this.sendUsageAdjustments.push({layerChange:t,time:i}),!0)}_maybeAdjustMaxRecvSize(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const a=Date.now();let s=-1;if(t===xe.Decrease){if(e>T){const t=this.recvUsageAdjustments.back();i||t&&t.layerChange!==xe.Increase||(this.recvUsageIncreaseFailedAttempts++,this.recvUsageIncreaseFailedTime=a,Ue("Attempt to increase receive size failed ".concat(this.recvUsageIncreaseFailedAttempts," times"))),s=e-1}}else if(t===xe.Increase){const t=Math.min(je.resourceUsageIncreaseMaxAttempts-1,this.recvUsageIncreaseFailedAttempts);e===this.maxFeasibleRecvSize&&(i||a-this.recvUsageIncreaseFailedTime>=je.resourceUsageIncreaseInitialDelay*Math.pow(2,t-1))&&(s=e+1)}return s>=0&&this.maxFeasibleRecvSize!==s&&(this.maxFeasibleRecvSize=s,this.recvUsageAdjustments.push({layerChange:t,time:a}),!0)}onSubInfo(e){const{isDualCall:t}=e;this.onDualCallState(t)}onDualCallState(e){this.isDualCall!==e&&(this.isDualCall=e,Be("WMSC_Dual_Call_State_Changed: ".concat(e)),e?(this._resetReceiverBandwidth(),this._waitBeforeReceiverBandwidthUpdate()):this._stopReceiverBandwidthUpdateWait())}isSingleLayerMode(){return 1===this.maxEncodingLayers||this.isDualCall}_evaluateBandwidthDistribution(e,t,i){const a=i.reduce(((e,t)=>e+t),0),s=je.receiverBandwidthUseRatio,n=Math.floor(t*s),r=function(e){var t;return(null===(t=Me(e))||void 0===t?void 0:t.minBitrate)||0}(e),o=Ee(e),c=this.reduceTopLayerBitrateEnabled?o*(1-je.reduceTopLayerBitrateThreshold):o;let d=0,l=0,h=0;if(n>=c)l=a,h=n;else if(a>0&&this.reduceTopLayerBitrateEnabled){let e=0,n=0,o=0,u=0,m=0,p=0,g=0;for(let d=i.length-1;d>=0;d--){const l=i[d];l&&(g=g?512*d:t,g>=r&&(e=d,n+=l),g*s>=c&&(o=d,u+=l),p||(m/a<.6?m+=l:p=d))}p<o&&(m-u)/a<.2?(d=o,l=u):p>e?(d=p,l=m):(d=e,l=n),h=l?Math.floor(Math.max(t,512*d)*s):0}else h=c;return{minBandwidth:n,selectedBandwidth:h}}onReceiverBandwidthReport(e){if(!this.receiverBandwidthAdaptationEnabled||this.receiverBandwidthUpdatePending)return;const{minBW:t,minL3BW:i}=e;let a=!1;if(this.receiverBandwidthReport){const e=this.receiverBandwidthReport,{targetMinBw:s}=e;e.minBw=t,e.minL3Bw=i,t<s*(1-je.receiverBandwidthJitterTolerance)?e.targetMinBw=t:t>s*(1+je.receiverBandwidthJitterTolerance)&&(e.targetMinBw=Math.min(t,Math.floor(s*(1+je.receiverBandwidthIncreaseStep)))),e.targetMinBw!==s&&(a=!0)}else this.receiverBandwidthReport={minBw:t,targetMinBw:t,minL3Bw:i},a=!0;if(!this.isDualCall&&_e(3)){const{minBandwidth:e,selectedBandwidth:t}=this.receiverL3BandwidthEvaluation||{},s=this._evaluateBandwidthDistribution(3,i,[]);(je.isBitrateChangeAboveRatio(e,s.minBandwidth,je.receiverBandwidthJitterTolerance)||je.isBitrateChangeAboveRatio(t,s.selectedBandwidth,je.receiverBandwidthJitterTolerance))&&(this.receiverL3BandwidthEvaluation=s,a=!0)}this.sendActive&&a&&this.allocateBitrate(this._getAvailableBitrate(),Fe.ReceiverBandwidth)}onReceiverReport(e){this.outgoingBandwidthAdaptationEnabled&&this.sendActive&&e.frameStats&&(this.framingDelayStats.push(e.frameStats),this._maybeUpdateMaxEncodeBitrate())}onQosReport(e){var t;if(this.outgoingBandwidthFromServer&&null!==(t=e.uplink)&&void 0!==t&&t.bw){const t=1e3*e.uplink.bw;this._updateOutgoingBandwidth(t)}}_getDecreaseBitrateWindow(e){return e<=je.maxAllowedFramingDelay?je.maxFramingDelayWindowSize:e>=je.maxFramingDelay?je.minFramingDelayWindowSize:Math.round(je.maxFramingDelayWindowSize-(e-je.maxAllowedFramingDelay)/(je.maxFramingDelay-je.maxAllowedFramingDelay)*(je.maxFramingDelayWindowSize-je.minFramingDelayWindowSize))}_getIncreaseBitrateWindow(e){return e>=je.minAllowedFramingDelay?je.maxFramingDelayWindowSize:e<=je.minFramingDelay?je.minFramingDelayWindowSize:Math.round(je.minFramingDelayWindowSize+(e-je.minFramingDelay)/(je.minAllowedFramingDelay-je.minFramingDelay)*(je.maxFramingDelayWindowSize-je.minFramingDelayWindowSize))}_maybeUpdateMaxEncodeBitrate(){const e=this.framingDelayStats.unwrap(),t=this.framingDelayStats.count;let i=0,a=0;const{avgFrameDelay:s,avgPacketsPerFrameTenth:n}=e[t-1];this.increaseBitrateWindow=this._getIncreaseBitrateWindow(s),this.decreaseBitrateWindow=this._getDecreaseBitrateWindow(s);for(let s=t-1;s>=0;s--){const{avgFrameDelay:n}=e[s];t-s<=this.decreaseBitrateWindow&&n>je.maxAllowedFramingDelay&&i++,n<je.minAllowedFramingDelay&&t-s<=this.increaseBitrateWindow&&a++}const r=this._getMaxEncodeBitrate(i,a,n);return r!==this.maxEncodeBitrate&&(this.maxEncodeBitrate=r,this.allocateBitrate(this._getAvailableBitrate(),Fe.Other),this.framingDelayStats.clear(),Be("WMSC_ENBT-".concat(s,"-").concat(this.increaseBitrateWindow,"-").concat(this.decreaseBitrateWindow,"-").concat(i,"-").concat(a,"-").concat(r,"-").concat(n)),!0)}_getMaxEncodeBitrate(e,t,i){let a=this.maxEncodeBitrate;if(e/this.decreaseBitrateWindow>=this.decreaseBitrateRate&&Math.round(i/10)>1){const e=.3-(this.decreaseBitrateWindow-je.minFramingDelayWindowSize)/(je.maxFramingDelayWindowSize-je.minFramingDelayWindowSize)*.2,{targetBitrate:t}=ye(2);a=Math.max(Math.round((1-e)*(this.currentMaxEncodeBitrate||a)),t)}else if(t/this.increaseBitrateWindow>=this.increaseBitrateRate){const e=.3-(this.increaseBitrateWindow-je.minFramingDelayWindowSize)/(je.maxFramingDelayWindowSize-je.minFramingDelayWindowSize)*.25,{maxBitrate:t}=ye(ve());a=Math.min(Math.round((1+e)*a),t)}return a}_getReceiverMinBandwidth(){return this.receiverBandwidthReport?Math.floor(this.receiverBandwidthReport.targetMinBw*je.receiverBandwidthUseRatio):1/0}_getSelectedL3Bandwidth(){return this.receiverL3BandwidthEvaluation?this.receiverL3BandwidthEvaluation.selectedBandwidth:1/0}_getSubLayersForLayer(e){const t=ge(),i=[];if(e<3)for(const a of t)a<e&&i.push(a);else{const{minBandwidth:e,selectedBandwidth:a}=this.receiverL3BandwidthEvaluation||{};if(e&&a>e)for(let a=2;t.includes(a)&&(i.push(a),!(ye(a).maxBitrate<=e));a--);}return i}_maybeUpdateSubLayers(){if(!this.receiverBandwidthAdaptationEnabled||!this.additionalSubLayersEnabled||this.receiverBandwidthUpdatePending)return!1;const e=[];if(this.isSingleLayerMode()||this.requestedLayerIds.forEach((t=>{this._getSubLayersForLayer(t).forEach((t=>{this.requestedLayerIds.includes(t)||e.includes(t)||e.push(t)}))})),this.requestedLayerIds.length&&!e.length&&(0,de.gm)()&&(0,de.C5)()<147){const t=ge()[0];this.requestedLayerIds.includes(t)||e.push(t)}return!Y(this.additionalSubLayerIds,e)&&(this.additionalSubLayerIds=e,!0)}_getAvailableBitrate(){return this.outgoingBandwidthAdaptationEnabled?this.outgoingBandwidthReport?Math.max(0,this.outgoingBandwidthReport.targetBandwidth-this.audioBandwidth):this.videoStartBandwidth:1/0}_updateOutgoingBandwidth(e){let t=!1;const i=this._shouldProbeBandwidth(e-this.audioBandwidth);if(this.outgoingBandwidthReport){const i=this.outgoingBandwidthReport,{targetBandwidth:a}=i;i.bandwidth=e,e<a*(1-je.outgoingBandwidthJitterTolerance)?i.targetBandwidth=e:e>a*(1+je.outgoingBandwidthJitterTolerance)&&(i.targetBandwidth=Math.min(e,Math.floor(a*(1+je.outgoingBandwidthIncreaseStep)))),i.targetBandwidth!==a&&(t=!0)}else this.outgoingBandwidthReport={bandwidth:e,targetBandwidth:e},t=!0;(t||i)&&this.allocateBitrate(this._getAvailableBitrate(),i?Fe.OutgoingBandwidthProbing:Fe.OutgoingBandwidth)}_updateLayersMaxBitrate(e){e.forEach(((t,i)=>{const{outgoingBitrate:a,receiverBandwidth:s,skipReceiverBandwidthLimit:n,format:r}=t,o=i===e.length-1?a:Math.min(r.maxBitrate,1e3*Math.ceil(a*(4/3)/1e3));t.maxBitrate=n?o:Math.min(o,s)}))}async _updateLayersAllocation(e){try{var t;return await(null===(t=this.messageCallback)||void 0===t?void 0:t.call(this,{type:M.LAYERS_UPDATE,data:e})),!0}catch(e){return ke.error("update layers allocation error: ".concat(e.message)),!1}}async _sendLastLayersAllocation(){if(!this.layersAllocationCache)return Promise.reject(new Error(ze));const{outgoingBandwidthReport:e,receiverBandwidthReport:t,availableBitrate:i,layerIds:a,layersAllocation:s,reason:n,priority:r,timestamp:o}=this.layersAllocationCache;if(r>=We.High||!je.areLayersAllocationsEqual(this.layersAllocation,s)){const{minBw:r,targetMinBw:d,minL3Bw:l}=t,{bandwidth:h,targetBandwidth:u}=e,m="WMSC_Update_Layers_Allocation, reason: ".concat(n)+", bandwidth: S ".concat(h,",").concat(u,",").concat(i,", R ").concat(r,",").concat(d,",").concat(l)+", layers: ".concat(a,", ").concat(s.map((e=>{let{layerId:t,maxBitrate:i,format:a}=e;return"{".concat(t,",").concat(a.width,",").concat(i,"}")})).join(","));var c;Be(X(m)),await this._updateLayersAllocation(s)&&(!this.layersAllocation.length&&s.length?this.sendActivatedTime=Date.now():this.layersAllocation.length&&!s.length&&(this.sendActivatedTime=0),(null===(c=this.layersAllocationCache)||void 0===c?void 0:c.timestamp)===o&&(this.layersAllocationCache=null),this.layersAllocation=s)}}_getReceiverBandwidth(e){let t=1/0;return this.isSingleLayerMode()?t=this._getReceiverMinBandwidth():3===e&&(t=this._getSelectedL3Bandwidth()),t}_getSendLayerIds(){var e;return l()(e=[...this.additionalSubLayerIds,...this.requestedLayerIds]).call(e)}_allocateBitrateToLayers(e,t){var i;const a=ge(),s=a[0],n=Math.max(0,this.feasibleFormatIndex),r=[];let o=e,c=-1;const d=(e,t)=>{if(r.length>=this.maxEncodingLayers)return!1;const i=this._getReceiverBandwidth(e),a=function(e){var t,i;return null!==(i=null===(t=pe())||void 0===t?void 0:t.filter((t=>t.layerId===e)))&&void 0!==i?i:[]}(e);for(const s of a){const{minBitrate:a,targetBitrate:d,maxBitrate:l,formatIndex:h}=s;if(o<a||!t&&i<a||this.maxEncodeBitrate<a||h<n)continue;const u=Math.min(d,this.maxEncodeBitrate);return r.push({layerId:e,outgoingBitrate:u,receiverBandwidth:i,skipReceiverBandwidthLimit:t,format:s}),o-=u,c=e,!0}return!1};for(const e of t){const t=this.additionalSubLayerIds.includes(e);if(!d(e,t)){const i=-1===c?s:c+1;for(let s=e-1;s>=i&&a.includes(s)&&!d(s,t);s--);break}}if(r.length){const e=r[r.length-1];e.outgoingBitrate=Math.min(e.format.maxBitrate,this.maxEncodeBitrate)}else if(t.length){const e=Me(s);r.push({layerId:s,outgoingBitrate:e.minBitrate,receiverBandwidth:this._getReceiverBandwidth(s),skipReceiverBandwidthLimit:!0,format:e})}return this._updateLayersMaxBitrate(r),this.currentMaxEncodeBitrate=null===(i=r[r.length-1])||void 0===i?void 0:i.maxBitrate,r}_reallocateBitrateToLayers(e,t,i){let a=0,s=0,n=0,r=!1;const o=[];return t.forEach(((e,i)=>{var a;n+=i===t.length-1?(null===(a=ye(e))||void 0===a?void 0:a.maxBitrate)||0:Ee(e)})),i.forEach(((e,t)=>{const{layerId:n,outgoingBitrate:c,receiverBandwidth:d,skipReceiverBandwidthLimit:l,format:h}=e,u=t===i.length-1,m=this._getReceiverBandwidth(n);u?((!l&&m<h.minBitrate||d<=h.maxBitrate&&m>h.maxBitrate)&&(r=!0),a+=h.minBitrate,s+=c):(!l&&m<h.minBitrate&&(r=!0),a+=c,s+=c),o.push({layerId:n,outgoingBitrate:c,receiverBandwidth:m,skipReceiverBandwidthLimit:l,format:h})})),!r&&(e>=n||e>=a&&e<=s)?(this._updateLayersMaxBitrate(o),o):this._allocateBitrateToLayers(e,t)}allocateBitrate(e,t){var i;const a=Date.now(),s=je.getLayersChangePriority(t),n=this._maybeUpdateSubLayers(),r=this._getSendLayerIds(),o=(null===(i=this.layersAllocationCache)||void 0===i?void 0:i.layersAllocation)||this.layersAllocation;let c;c=!n&&o.length&&je.isBandwidthReason(t)?this._reallocateBitrateToLayers(e,r,o):this._allocateBitrateToLayers(e,r);const d={outgoingBandwidthReport:Ne({},this.outgoingBandwidthReport),receiverBandwidthReport:Ne({},this.receiverBandwidthReport),availableBitrate:e,layerIds:r,layersAllocation:c,reason:t,priority:s,timestamp:performance.now()};return this.layersAllocationCache&&(d.priority=Math.max(s,this.layersAllocationCache.priority)),t===Fe.OutgoingBandwidthProbing&&this._maybeUpdateLayersForBandwidthProbing(d)&&(this.outgoingBandwidthProbingScheduledTime=a),this.layersAllocationCache=d,this._queueLayersUpdate((async()=>{await this._sendLastLayersAllocation()}))}_shouldProbeBandwidth(e){return this.outgoingBandwidthProbingEnabled&&this.sendActive&&e<je.outgoingBitrateThresholdProbing&&Date.now()-this.outgoingBandwidthProbingScheduledTime>=je.outgoingBandwidthProbingMinInterval}_maybeUpdateLayersForBandwidthProbing(e){const{layersAllocation:t}=e;if(1!==t.length)return!1;const{layerId:i,maxBitrate:a}=t[0],{bandwidth:s}=this.outgoingBandwidthReport,n=Math.floor(s*je.outgoingBandwidthProbingFactor);return!(i!==Se()||a>s||n>this._getReceiverBandwidth(i)||(t[0].maxBitrate=n,0))}}(0,c.A)(je,"resourceUsageStateHistorySize",6),(0,c.A)(je,"resourceUsageAdjustmentHistorySize",6),(0,c.A)(je,"resourceUsageIncreaseInitialDelay",6e4),(0,c.A)(je,"resourceUsageIncreaseMaxAttempts",6),(0,c.A)(je,"encodingTimeout",2e3),(0,c.A)(je,"encodingFailMaxRetries",2),(0,c.A)(je,"recvNetworkCoolDownTime",15e3),(0,c.A)(je,"outgoingBitrateStatsCacheSize",8),(0,c.A)(je,"receiverBandwidthUseRatio",.9),(0,c.A)(je,"receiverBandwidthUpdateDelay",1500),(0,c.A)(je,"reduceTopLayerBitrateThreshold",.4),(0,c.A)(je,"outgoingBitrateThresholdProbing",2e5),(0,c.A)(je,"outgoingBandwidthProbingMinInterval",1e4),(0,c.A)(je,"outgoingBandwidthProbingFactor",1.1),(0,c.A)(je,"outgoingBandwidthJitterTolerance",.05),(0,c.A)(je,"outgoingBandwidthIncreaseStep",.2),(0,c.A)(je,"receiverBandwidthJitterTolerance",.05),(0,c.A)(je,"receiverBandwidthIncreaseStep",.2),(0,c.A)(je,"maxAllowedFramingDelay",250),(0,c.A)(je,"minAllowedFramingDelay",150),(0,c.A)(je,"maxFramingDelay",600),(0,c.A)(je,"minFramingDelay",50),(0,c.A)(je,"maxFramingDelayWindowSize",16),(0,c.A)(je,"minFramingDelayWindowSize",5);const Ge=new je;var He=i(5999);function Qe(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,a)}return i}function qe(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Qe(Object(i),!0).forEach((function(t){(0,c.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Qe(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const Ye=te.getTracer("WmscVideoMgr"),Ke=e=>{Ye.log(e),te.monitorLog("".concat(e))},Je=new class{constructor(){var e,t;this.videoPublished=!1,this.mediaRequested=!1,this.hdVideoEnabled=!1,this.maxEncodingFramerate=30,this.maxSendLayerId=4,this.sourceVideoSize=-1,this.sourceVideoSettings=null,this.pc=null,this.sendTransceiver=null,this.messageCallback=null,this.requestedLayerIds=[],this.sendLayerIds=[],this.encodingMap=new Map,this.recvCodecNum=0,this.sendCodecNum=0,this.senderCodec=null,this.isSupportHi444PP=!1,this.headerExtMap=new Map,this.egressCodecList=null,this.ingressCodecList=null,this.sendCBPPayloadType=0,this.recvHigh444PayloadType=0,this.recvMLineTemp=null,this.numSimulcastLayers=0,this.layerEncodingIndexMap=null,this.ridSimulcastEnabled=(0,de.gm)(),this.recvPreferCodecs=(null===(e=RTCRtpReceiver.getCapabilities("video"))||void 0===e||null===(e=e.codecs)||void 0===e?void 0:e.filter((e=>{let{mimeType:t,sdpFmtpLine:i}=e;if(-1!==t.indexOf("red")||-1!==t.indexOf("fec")||"video/rtx"===t)return!0;const a=i?i.toLowerCase():"";return!("video/H264"!==t||!a||-1===a.indexOf("packetization-mode=1")||(-1!==a.indexOf("profile-level-id=f400")&&(this.isSupportHi444PP=!0),this.recvCodecNum++,0))})))||[],null===(t=RTCRtpSender.getCapabilities("video"))||void 0===t||null===(t=t.codecs)||void 0===t||t.forEach((e=>{const{mimeType:t,sdpFmtpLine:i}=e;"video/H264"===t&&(this.sendCodecNum++,-1!==i.indexOf("profile-level-id=42")&&(!(0,de._J)()&&!(0,de.UP)()||(0,de.D)("124")||(this.senderCodec=e)))})),Ge.registerMessageCallback(this.onQosMessage.bind(this))}getSendEncodings(e){switch(e){case 1:return[{rid:"0",active:!1}];case 2:return[{rid:"0",active:!1,scaleResolutionDownBy:2},{rid:"1",active:!1,scaleResolutionDownBy:1}];default:return[{rid:"0",active:!1,scaleResolutionDownBy:4},{rid:"1",active:!1,scaleResolutionDownBy:2},{rid:"2",active:!1,scaleResolutionDownBy:1}]}}getDefaultEncodingIndex(e){return e<=1?0:2===e?1:2}getDefaultEncodingIndexMap(e){return 1===e?new Map([[1,0],[2,0],[3,0],[4,0]]):2===e?new Map([[1,0],[2,1],[3,1],[4,1]]):new Map([[1,0],[2,1],[3,2],[4,2]])}getEncodingIndex(e){return this.layerEncodingIndexMap.get(e)}_configSimulcastLayers(e,t){this.numSimulcastLayers=e,this.layerEncodingIndexMap=t}setDefaultVideoSettings(e){ue((0,de.zQ)()&&x.isMacIntel||(0,de.GN)()?he.filter((e=>{let{width:t,height:i}=e;return!((a={width:t,height:i}).width*a.height<57600);var a})):he),me([1,2,3]),this._configSimulcastLayers(e,this.getDefaultEncodingIndexMap(e)),this.onMediaRequest(this.requestedLayerIds)}setVideoSettings(e){var t;const{hdVideoEnabled:i,maxEncodingLayers:a,layersSettings:s}=e||{};if(this.enableHdVideo(i),a>0&&Ge.setMaxEncodingLayers(a),null==s||!s.length)return void this.setDefaultVideoSettings(null!=a?a:3);const n=l()(s).call(s,((e,t)=>Math.min(t.width,t.height)-Math.min(e.width,e.height))),r=n.reduce(((e,t)=>Math.min(t.maxFramerate,e)),30);for(let e=0;e<n.length;e++){const{width:t,height:i,minBitrate:a,maxBitrate:s}=n[e],o=Te({width:t,height:i});n[e].layerId=o,n[e].maxFramerate=r,void 0===s&&(n[e].maxBitrate=Ie(o,{width:t,height:i}),n[e].targetBitrate=n[e].maxBitrate),void 0===a&&(n[e].minBitrate=e>0?n[e-1].maxBitrate:6e4)}const o=new Map;n.forEach((e=>{const{layerId:t}=e,i=this.getDefaultEncodingIndex(t);o.get(t)?t.push(t):o.set(i,[t])}));const c=o.size,d=Array.from(o.keys()),h=new Map;for(let e=0;e<c;e++)o.get(d[e]).forEach((t=>{h.set(t,e)}));ue(n),me(l()(t=Array.from(h.keys())).call(t)),this._configSimulcastLayers(c,h),this.onMediaRequest(this.requestedLayerIds)}registerMessageCallback(e){this.messageCallback=e}getPc(){return this.pc}getSender(){var e;return null===(e=this.sendTransceiver)||void 0===e?void 0:e.sender}enableHdVideo(e){Ke("WMSC_Enable_HD_Video: ".concat(e)),this.hdVideoEnabled=e,this.onMediaRequest(this.requestedLayerIds)}setMaxEncodingFramerate(e){this.maxEncodingFramerate=e,Ke("WMSC_Max_Encode_Framerate: ".concat(e)),Ge.setMaxEncodingFramerate(e),this._startVideo()}setMaxSendLayerId(e){this.maxSendLayerId=e,this.sendLayerIds=this._reduceRequestLayerIds(this.requestedLayerIds)}async publishVideoTrack(e,t){e&&Ge.resetSendUsageState(),await this._replaceVideoTrack(e||null),this.updateVideoSourceSettings(t||null),this._onVideoPublished(!!e)}updateVideoSourceSettings(e){const t=(a=e,!(i=this.sourceVideoSettings)&&!a||!(!i||!a)&&(i.width===a.width&&i.height===a.height||i.width===a.height&&i.height===a.width));var i,a;if(this.sourceVideoSettings=e,!t)if(e){const{width:t,height:i,frameRate:a}=e;Ke("WMSC_Original_Video_Track: ".concat(t,"x").concat(i,"@").concat(a,"fps")),a&&Ge.setMaxEncodingFramerate(a),this.sourceVideoSize=Te(e),this.onMediaRequest(this.requestedLayerIds)}else this._stopVideo()}async _replaceVideoTrack(e){const t=this.getSender(),i=e?"{ kind: ".concat(e.kind,", id: ").concat(e.id,", enabled: ").concat(e.enabled,", muted: ").concat(e.muted)+", contentHint: ".concat(e.contentHint," }"):"";if(Ke(X("WMSC_Replace_Video_Track: sender: ".concat(!!t," track: ").concat(i))),t)return t.replaceTrack(e)}_onVideoPublished(e){this.videoPublished=e,this.mediaRequested&&(e?this._startVideo():this._stopVideo())}_startVideo(){Ye.log("_startVideo"),Ge.updateLayers(this.sendLayerIds)}_stopVideo(){Ye.log("_stopVideo"),Ge.updateLayers([])}handlePcClose(){this.videoPublished=!1,this.sendTransceiver=null,this.pc=null}_reduceRequestLayerIds(e){var t;if(!e.length)return[];let i=[...e];1===this.numSimulcastLayers&&i.length>1&&(i=i.some((e=>e>=2))?[2]:[Math.max(...i)]);const a=new Map,s=Se(),n=ve(),r=Math.min(this.maxSendLayerId,this.sourceVideoSize,this.hdVideoEnabled?n:Math.min(2,n));return i.map((e=>{let t=Math.max(s,Math.min(r,e));for(;!_e(t);)--t;return t})).forEach((e=>{const t=this.getEncodingIndex(e),i=a.get(t);(void 0===i||e<i)&&a.set(t,e)})),l()(t=Array.from(a.values())).call(t)}onMediaRequest(e){const t=!!e.length;this.requestedLayerIds=[...e];const i=this._reduceRequestLayerIds(e);Ke(X("WMSC_New_Media_Request: layer ids: ".concat(JSON.stringify(e)," -> ").concat(JSON.stringify(i)))),this.sendLayerIds=i,this.mediaRequested!==t?(this.mediaRequested=t,this.videoPublished&&(t?this._startVideo():this._stopVideo())):this.videoPublished&&t&&Ge.updateLayers(this.sendLayerIds)}async onQosMessage(e){switch(e.type){case M.LAYERS_UPDATE:return this.onLayersAllocationUpdate(e.data);case M.MIN_BITRATE_UPDATE:return this.updateMinOutgoingBitrate(e.data)}}async onLayersAllocationUpdate(e){this.encodingMap.clear(),e.forEach((e=>{const t=this.getEncodingIndex(e.layerId);this.encodingMap.set(t,e)})),await this._updateSendParameters()}async updateMinOutgoingBitrate(e){if(!this.pc)throw new Error("Egress peer connection has not been created");return Ke("WMSC_Update_Min_Bitrate: ".concat(e)),Ge.resetSendStats(),new Promise(((t,i)=>{this.messageCallback({type:y.UPDATE_BITRATE,data:{bitrate:e,resolve:t,reject:i}})}))}updateMinOutgoingBitrateInSDP(e){this.pc&&le.updateCodecParameters(this.pc.answer,"video","recvonly","H264",new Map([["x-google-min-bitrate",Math.floor(e/1e3)]]))}async _updateSendParameters(){const e=this.getSender();if(null==e||!e.track||!this.sourceVideoSettings)return void Ke("WMSC_USPTNP: ".concat(!!e,"|").concat(!!this.sourceVideoSettings));const{width:t,height:i}=this.sourceVideoSettings,a=Math.max(t,i);let s="WMSC_Update_Send_Params:";const n=e.getParameters();n.encodings.forEach(((e,t)=>{const i=this.encodingMap.get(t);if(e.active=!!i,e.active){const{layerId:n,maxBitrate:r,format:o}=i,c=Math.max(1,a/Math.max(o.width,o.height));e.maxBitrate=r,e.scaleResolutionDownBy=c,e.maxFramerate=Math.min(this.sourceVideoSettings.frameRate,this.maxEncodingFramerate,function(e){var t;return(null===(t=ye(e))||void 0===t?void 0:t.maxFramerate)||0}(n)),s+=" index ".concat(t,": ").concat(n,",").concat(e.maxBitrate,",").concat(e.maxFramerate)+",".concat(e.scaleResolutionDownBy)}})),n.degradationPreference="maintain-resolution",Ke(X(s));try{await e.setParameters(n)}catch(e){return te.globalTrace({logLevel:"error",log:"WMSC_SETPARAMSE",errorEvent:e}),Ke("WMSC_SETPARAMSE"),Promise.reject(e)}}_getEgressRemoteCodecParams(){const e=Ge.getStartBandwidth();return new Map([["x-google-per-layer-pli",1],["x-google-start-bitrate",Math.floor(e/1e3)]])}_getIngressLocalCodecParams(){return new Map([["sps-pps-idr-in-keyframe",1]])}_getIngressLocalRtcpFbParams(){return[["rrtr"]]}removeRecvCodecByProfile(e){var t;const i=parseInt(e.substring(0,2),16);this.ingressCodecList=null===(t=this.ingressCodecList)||void 0===t?void 0:t.filter((e=>{let{codecName:t,codecParams:a}=e;return!("H264"===t&&parseInt(a.get("profile-level-id").substring(0,2),16)<=i)}))}init(e,t){this.pc=e,Ge.resetRecv(),Ge.resetSend(),this.addSendTransceiver();for(let e=0;e<t;e++)this.addRecvTransceiver()}addSendTransceiver(){if(!this.pc)throw new Error("Peer connection has not been created");return this.sendTransceiver=this.pc.createSendTransceiver(He.zu.MainVideo,{sendEncodings:this.getSendEncodings(this.numSimulcastLayers)}),this.sendTransceiver}addRecvTransceiver(){if(!this.pc)throw new Error("Peer connection has not been created");const e=this.pc.createRecvTransceiver(He.zu.MainVideo);try{let t=this.recvPreferCodecs;this.senderCodec&&(t=[...this.recvPreferCodecs,this.senderCodec]),this.recvCodecNum>0&&e.transceiver.setCodecPreferences(t)}catch(e){te.globalTrace({logLevel:"error",log:"WMSC_CODECPREFERENCE_ERROR",errorEvent:e}),Ke("WMSC_CPE")}return e}mungeLocalOffer(e){let t=!1;const i=this.headerExtMap.get("send"),a=this.headerExtMap.get("recv"),s=(0,de.zQ)()&&x.isMacIntel||(0,de.gm)();le.filterCodecs(e,((e,n)=>{const{type:r,direction:o}=n;if("video"!==r||"inactive"===o)return!0;t=!0;const{codecName:c,codecParams:d,payloadType:l}=e;if("flexfec-03"===c)return!0;if("H264"===c&&"1"===d.get("packetization-mode")){if("sendonly"===o){if(ee(d.get("profile-level-id")))this.sendCBPPayloadType=l;else if(s)return!1;this.pc&&!this.pc.currentRemoteDescription?this.headerExtMap.set("send",n.extensionMap):i&&(n.extensionMap=i)}else"recvonly"===o&&($(d.get("profile-level-id"))&&(this.recvHigh444PayloadType=l),this.pc&&!this.pc.currentRemoteDescription?this.headerExtMap.set("recv",n.extensionMap):a&&(n.extensionMap=a));return!0}return!1})),t&&this.pc&&(le.mungeEgressLocalOffer(e,this.numSimulcastLayers,this.pc.mainEgressStreamId,!this.ridSimulcastEnabled&&!this.pc.answer),le.mungeIngressLocalOffer(e,this._getIngressLocalCodecParams(),this._getIngressLocalRtcpFbParams()))}mungeAnswer(e){le.mungeEgressAnswer(e,this.numSimulcastLayers,this._getEgressRemoteCodecParams())}updateConfigFromSdp(e){const t=e.media.find((e=>"video"===e.type&&"recvonly"===e.direction));if(t){const e=le.getMediaStartBandwidth(t);e&&Ge.setVideoStartBandwidth(e)}}saveRecvMLineTemp(){var e;const t=null===(e=this.pc)||void 0===e?void 0:e.answer.media.find((e=>{const{type:t,direction:i}=e||{};return"video"===t&&"sendonly"===i}));t&&(this.recvMLineTemp=qe({},t))}updateRecvMLineTemp(e){const{ice_pwd:t,ice_ufrag:i}=e;this.recvMLineTemp&&(this.recvMLineTemp.icePwd=t,this.recvMLineTemp.iceUfrag=i)}addRecvVideoSDP(e){if(!this.recvMLineTemp)throw new Error("No receive video m-line template");const{transceiver:t,msid:i,mediaType:a,ssrcs:s={},user_id:n}=e,{rtp:r,rtx:o,flexfec:c}=s,{mid:d}=t,l=r||le.generateSsrc(),h=o||le.generateSsrc(),u=c||le.generateSsrc(),m=i||le.generateUuid(),p=le.generateUuid();if(a===He.zu.MainVideo){var g;const e=qe({},this.recvMLineTemp);e.mid=d,e.msid={streamId:m,trackId:p},e.ssrcGroups=[{semantics:"FID",ssrcs:[l,h]},{semantics:"FEC-FR",ssrcs:[l,u]}],e.ssrcs=[{ssrc:l,attribute:"cname:".concat(m)},{ssrc:l,attribute:"msid:".concat(m," ").concat(p)},{ssrc:h,attribute:"cname:".concat(m)},{ssrc:h,attribute:"msid:".concat(m," ").concat(p)},{ssrc:u,attribute:"cname:".concat(m)},{ssrc:u,attribute:"msid:".concat(m," ").concat(p)}],null===(g=this.pc)||void 0===g||g.addMLineSDPToAnswer(d,e)}return{mid:d,media_type:a,msid:m,ssrcs:{rtp:l,rtx:h,flexfec:u},user_id:n}}saveCodecList(){var e;let t,i;null===(e=this.pc)||void 0===e||e.answer.media.some((e=>{const{type:a,direction:s}=e||{};return"video"===a&&"recvonly"===s?t=e:"video"===a&&"sendonly"===s&&(i=e),t&&i})),t&&(this.egressCodecList=[...t.codecs]),i&&(this.ingressCodecList=i.codecs.filter((e=>{let{codecName:t}=e;return"H264"===t})))}updateEgressAnswerCodec(e){if(this.egressCodecList&&this.pc){const t=this.pc.answer.media.find((e=>{const{type:t,direction:i}=e||{};return"video"===t&&"recvonly"===i}));let i,a=[];if(this.egressCodecList.forEach((t=>{const{codecName:s,codecParams:n,payloadType:r}=t;if(a.push(r),"H264"===s){const a=n.get("profile-level-id");e?ee(a)&&(i=t):Z(a)&&(i=t)}})),i){t.codecs=[i],t.formats=[i.payloadType];const e=this.egressCodecList.find((e=>{const{codecName:t,codecParams:a}=e;return"rtx"===t&&a.associatedPayloadType===i.payloadType}));e&&(t.codecs.push(e),t.formats.push(e.payloadType))}else t.codecs=this.egressCodecList,t.formats=a}}getRecvCodecPayloads(){const e=[];if(this.ingressCodecList){const t=Ae("recv");this.ingressCodecList.forEach((i=>{const{codecName:a,codecParams:s,payloadType:n}=i;if("H264"===a){const i=s.get("profile-level-id");e.length>0&&(t&&$(i)||!t&&Z(i))?(e.push(e[0]),e[0]=n):e.push(n)}}))}return e}getPreferPayloadTypes(e){const t=Ae(e);return"recv"===e&&t&&this.recvHigh444PayloadType?[this.recvHigh444PayloadType]:"send"===e&&t&&this.sendCBPPayloadType?[this.sendCBPPayloadType]:[]}},Xe=1,Ze=2,$e=3,et=4,tt=6,it=7,at=8,st=9,nt=10,rt=11,ot=110,ct=206,dt=32769,lt=32770,ht=32771,ut=32776,mt=(e,t,i,a,s,n,r,o)=>{const c={type:at,confID:e,last_stream_request_msg_index:r,stream_status_msg_index:o};return null!=t&&t.length&&(c.created=t),null!=i&&i.length&&(c.deleted=i),null!=a&&a.length&&(c.updated=a),s&&(c.codec_preference=s),n&&(c.ice_restart_req=n),c};var pt=i(6603);const gt=te.getTracer("WmscMidMgr"),St=e=>{gt.log(e),te.monitorLog("".concat(e))};class _t{constructor(){this.hasPausedVideo=!1,this.hwDecoderLimit=D,this.mIdResource=new Map,this.userId2Media=new Map,this.midTypeMap={[He.zu.MainAudio]:He.zu.MainVideo,[He.zu.MainVideo]:He.zu.MainAudio,[He.zu.ShareAudio]:He.zu.ShareVideo,[He.zu.ShareVideo]:He.zu.ShareAudio},this.ssrcMidMap=new Map,this.mid2DetectVideo=new Map,this.isActiveSpeakerTimeout=!1}getMainVideoMId(e){const t=this.userId2Media.get(e);return t?t.midMapping.MainVideo:""}getUserId(e){let t;const i=this.mIdResource.get(e);return i&&(t=i.userId),{userId:t,group:null}}getVideoTagsByMId(e){const t=this.mIdResource.get(e);if(t){const{userId:e}=t;if(e){const t=this.userId2Media.get(e);if(null==t?void 0:t.mainVideoDoms)return Array.from(null==t?void 0:t.mainVideoDoms)}}}getVideoTagsByUserId(e){const t=this.userId2Media.get(e);return(null==t?void 0:t.mainVideoDoms)?Array.from(null==t?void 0:t.mainVideoDoms):[]}saveVideoTag(e,t){const i=this._getOrCreateMediaInfo(e);i.mainVideoDoms||(i.mainVideoDoms=new Set),i.mainVideoDoms.add(t),e===E?this.updateActiveSpeakerVideoStream():i.mainVideoStream&&this._setVideoTagStream(t,i.mainVideoStream,e)}removeVideoTag(e,t){var i;const a=this.userId2Media.get(e);a&&(null===(i=a.mainVideoDoms)||void 0===i||i.delete(t))}_setVideoTagStream(e,t,i){((0,de.gm)()||t&&e.srcObject!==t)&&(e.srcObject=t,e.onpause=()=>{St("WMSC_V_Tag_Pause: ".concat(i,"|").concat(document.hidden,"|").concat(document.visibilityState)),this.hasPausedVideo=!0})}setVideoSize(e,t){this._getOrCreateMediaInfo(e).videoSize=t}getVideoSizeByUserId(e){var t;const i=this.userId2Media.get(e);return i&&null!==(t=i.videoSize)&&void 0!==t?t:-1}getHasPausedVideo(){if(this.hasPausedVideo)return!0;let e=!1;for(const[,t]of this.userId2Media){const{midMapping:i,mainVideoDoms:a,videoSize:s}=t;if(-1!==s&&i.MainVideo&&a)for(const t of a)if(t.paused){e=!0;break}if(e)break}return e}playAllUsedVideoTag(){const e=[];if("visible"===document.visibilityState)for(const[e,t]of this.userId2Media){const{midMapping:i,mainVideoDoms:a,videoSize:s}=t;if(-1!==s&&i.MainVideo&&a)for(const t of a)if(t.paused&&t.srcObject&&"active"in t.srcObject){const i=t.srcObject.active;return i?t.play().then((()=>Promise.resolve())).catch((t=>Promise.reject("".concat(e,"|errorName:").concat(null==t?void 0:t.name,"|errorMessage:").concat(null==t?void 0:t.message)))):(St("WMSC_V_Tag_C_P: ".concat(e,"|").concat(!!(null==t?void 0:t.srcObject),"ï½œ").concat(i)),Promise.reject(e))}}return e.length<=0?Promise.resolve():Promise.all(e).then((()=>(this.hasPausedVideo=!1,Promise.resolve()))).catch((e=>(this.hasPausedVideo=!0,Promise.reject(e))))}changeHWDecodeLimit(e){if(Z(e)&&((0,de.UP)()||(0,de._J)())){if((0,de.U0)()||(0,de.uF)())return void(this.hwDecoderLimit=8);if((0,de.Zs)())return void(this.hwDecoderLimit=16)}this.hwDecoderLimit=D}addMidResource(e,t){const i=this._getOrCreateMIdResource(e),{streamId:a,track:s,transceiver:n}=t;if(a&&(i.streamId=a),s&&(i.track=s),n&&(i.transceiver=n),i.userId&&s)St("WMSC_WAFT-".concat(i.userId,"-").concat(e,"-").concat(i.streamId)),te.globalTrace({logLevel:"directReport",log:"WMSC_WAFT-".concat(i.userId,"-").concat(e,"-").concat(i.streamId)}),i.mediaType===He.zu.MainVideo&&this._assignVideoStream(i.userId,s);else if("video"===(null==s?void 0:s.kind)){const t=pt.A.createVideoElement();this.mid2DetectVideo.set(e,t),t.onloadedmetadata=()=>{this.attachMidByCSRC(e)},t.srcObject=new MediaStream([s])}}removeMidResource(e){this.mIdResource.delete(e),this.detachMid(e),this.removeAssociateDetectVideo(e)}attachMid(e,t,i){let a=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];this.removeAssociateDetectVideo(t);const s=this._getOrCreateMIdResource(t);s.userId?s.userId===e?te.globalTrace({logLevel:"directReport",log:"WMSC_CLIASSO-".concat(e,"-").concat(t)}):(St("WMSC_REASSO-".concat(e,"-").concat(t)),te.globalTrace({logLevel:"error",log:"WMSC_REASSO-".concat(e,"-").concat(t)})):(St("WMSC_ASSO-".concat(e,"-").concat(t,"-").concat(s.streamId)),this._getOrCreateMediaInfo(e).midMapping[i]=t,s.userId=e,s.mediaType=i,s.isCurrentSession=a,i===He.zu.MainVideo&&s.track&&this._assignVideoStream(e,s.track))}detachMid(e){const t=this.mIdResource.get(e);if(t&&t.userId){const i=this.userId2Media.get(t.userId);i&&i.midMapping[t.mediaType]===e&&delete i.midMapping[t.mediaType]}}getUserIdByMid(e){var t;return null===(t=this.mIdResource.get(e))||void 0===t?void 0:t.userId}getMactchedMSIDByUserId(e,t){var i,a;const s=null===(i=this.userId2Media.get(e))||void 0===i?void 0:i.midMapping[this.midTypeMap[t]];return s?null===(a=this.mIdResource.get(s))||void 0===a?void 0:a.streamId:""}_getOrCreateMediaInfo(e){let t=this.userId2Media.get(e);return t||(t={midMapping:{}},this.userId2Media.set(e,t)),t}setActiveSpeaker(e){this.activeSpeaker=Q(e),this.updateActiveSpeakerVideoStream()}updateActiveSpeakerVideoStream(){return e=this,t=void 0,a=function*(){var e,t;const i=this.userId2Media.get(E);if(i){const a=this.userId2Media.get(this.activeSpeaker);if(a){const s=a.midMapping.MainVideo;if(s&&s!==i.midMapping.MainVideo){const{track:t,userId:a}=this.mIdResource.get(s)||{};i.midMapping.MainVideo=s;try{if(yield this.detectCanplay(t,s,a),a===this.activeSpeaker){const a=i.mainVideoStream||new MediaStream,s=a.getVideoTracks()[0];s!==t&&(a.addTrack(t),s&&a.removeTrack(s)),i.mainVideoStream=a,null===(e=i.mainVideoDoms)||void 0===e||e.forEach((e=>{this._setVideoTagStream(e,a,E),e.load()}))}}catch(e){te.globalTrace({logLevel:"directReport",log:"WMSC_ACSPCPF"})}}else s&&i.mainVideoStream&&(null===(t=i.mainVideoDoms)||void 0===t||t.forEach((e=>{this._setVideoTagStream(e,i.mainVideoStream,E)})))}}},new((i=void 0)||(i=Promise))((function(s,n){function r(e){try{c(a.next(e))}catch(e){n(e)}}function o(e){try{c(a.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,o)}c((a=a.apply(e,t||[])).next())}));var e,t,i,a}createDetectVideoTag(){this.canplayDetectVideo=document.createElement("video"),this.canplayDetectVideo.autoplay=!0,this.canplayDetectVideo.playsInline=!0,this.canplayDetectVideo.style.position="fixed",this.canplayDetectVideo.style.width="1px",this.canplayDetectVideo.style.height="1px",this.canplayDetectVideo.style.bottom="0px",this.canplayDetectVideo.style.right="0px",this.canplayDetectVideo.style.zIndex="9999",this.canplayDetectVideo.style.pointerEvents="none",this.canplayDetectVideo.muted=!0,this.canplayDetectVideo.id=U,document.body.appendChild(this.canplayDetectVideo)}detectCanplay(e,t,i){return this.canplayDetectVideo||(this.canplayDetectVideo=document.querySelector("#".concat(U)))||this.createDetectVideoTag(),this.isActiveSpeakerTimeout=!1,this.canplayTimer&&clearTimeout(this.canplayTimer),this.canplayDetectVideo.srcObject&&this.canplayReject&&this.canplayReject(),new Promise(((a,s)=>{this.canplayReject=s,this.canplayResolve=a,this.canplayTimer=setTimeout((()=>{St("WMSC_ACSPCP_TIMEOUT-".concat(t,"-").concat(i)),te.globalTrace({logLevel:"error",log:"WMSC_ACSPCP_TIMEOUT-".concat(t,"-").concat(i)}),this.isActiveSpeakerTimeout=!0}),1500),this.canplayDetectVideo.oncanplay=()=>{St("WMSC_ACSPCP-".concat(t,"-").concat(i)),clearTimeout(this.canplayTimer),this.canplayDetectVideo.srcObject=null,this.isActiveSpeakerTimeout=!1,a()},this.canplayDetectVideo.srcObject=new MediaStream([e])}))}getUserIdBySsrc(e){var t;const i=this.ssrcMidMap.get(e);if(i)return null===(t=this.mIdResource.get(i))||void 0===t?void 0:t.userId}getMediaTypeBySsrc(e){var t;const i=this.ssrcMidMap.get(e);if(i)return null===(t=this.mIdResource.get(i))||void 0===t?void 0:t.mediaType}getMidBySsrc(e){return this.ssrcMidMap.get(e)}getMediaTypeByMid(e){var t;if(e)return null===(t=this.mIdResource.get(e))||void 0===t?void 0:t.mediaType}isMlineCurrentSessionByMid(e){var t;return null===(t=this.mIdResource.get(e))||void 0===t?void 0:t.isCurrentSession}attachMidByCSRC(e){var t;this.removeAssociateDetectVideo(e);const i=this.mIdResource.get(e);if(i){const{transceiver:a}=i;if(a){const i=null===(t=a.receiver)||void 0===t?void 0:t.getContributingSources();if(i.length>0){const{source:t}=i[0],a=Q(t);this.attachMid(a,e,He.zu.MainVideo,!0)}}}}removeAssociateDetectVideo(e){const t=this.mid2DetectVideo.get(e);t&&(t.onloadedmetadata=null,t.srcObject=null,this.mid2DetectVideo.delete(e))}getAudioMidByUserId(e){const t=this.userId2Media.get(e);return(null==t?void 0:t.midMapping.MainAudio)||""}getVideoMidByUserId(e){const t=this.userId2Media.get(e);return(null==t?void 0:t.midMapping.MainVideo)||""}_assignVideoStream(e,t){var i;const a=this._getOrCreateMediaInfo(e);a.mainVideoStream=new MediaStream([t]),null===(i=a.mainVideoDoms)||void 0===i||i.forEach((t=>{this._setVideoTagStream(t,a.mainVideoStream,e)})),e===this.activeSpeaker&&this.updateActiveSpeakerVideoStream()}_getOrCreateMIdResource(e){let t=this.mIdResource.get(e);return t||(t={},this.mIdResource.set(e,t)),t}removeAllMIdResource(){for(const[e]of this.mid2DetectVideo)this.removeAssociateDetectVideo(e);this.mid2DetectVideo.clear(),this.mIdResource.clear(),this.canplayDetectVideo&&(this.canplayDetectVideo.oncanplay=null,this.canplayDetectVideo.srcObject=null)}onStatsReport(e){var t,i;if(!this.isActiveSpeakerTimeout)return;const a=this.userId2Media.get(E),s=this.userId2Media.get(this.activeSpeaker);if(a&&s){const{mainVideoStream:n}=a,{mainVideoStream:r}=s;if((null==n?void 0:n.getVideoTracks()[0])!==(null==r?void 0:r.getVideoTracks()[0])){const{ssrc:a}=e.receiverStatisticData[this.activeSpeaker]||{},{framesDecoded:s}=(null===(t=e["prev-video-inbound-rtp"])||void 0===t?void 0:t[a])||{},{framesDecoded:n}=(null===(i=e["video-inbound-rtp"])||void 0===i?void 0:i[a])||{};n-s>0&&this.canplayResolve&&(te.globalTrace({logLevel:"directReport",log:"WMSC_ACSPCP_BY_STATS-".concat(n-s,"-").concat(a,"-").concat(this.activeSpeaker)}),St("WMSC_ACSPCP_BY_STATS-".concat(n-s,"-").concat(a,"-").concat(this.activeSpeaker)),this.isActiveSpeakerTimeout=!1,this.canplayResolve())}}}}const vt=new class{constructor(){this.sendVideoSizeLowerLimit=0,this.sendVideoSizeUpperLimit=4,this.recvVideoSizeLowerLimit=0,this.recvVideoSizeUpperLimit=4,this.recvVideoNumLowerLimit=4,this.recvVideoNumUpperLimit=(0,de.GN)()?L:w,this.sendVideoSizeLowerLimitApp=this.sendVideoSizeLowerLimit,this.sendVideoSizeUpperLimitApp=this.sendVideoSizeUpperLimit,this.recvVideoSizeLowerLimitApp=this.recvVideoSizeLowerLimit,this.recvVideoSizeUpperLimitApp=this.recvVideoSizeUpperLimit,this.recvVideoNumLowerLimitApp=this.recvVideoNumLowerLimit,this.recvVideoNumUpperLimitApp=this.recvVideoNumUpperLimit,this.maxSendVideoSize=0,this.maxRecvVideoSize=0,this.maxRecvVideoNum=0,this._reset()}_reset(){let e=3;!(0,de.Xb)()&&navigator.hardwareConcurrency>=8&&(e=4),this.maxSendVideoSize=Math.max(this.sendVideoSizeLowerLimit,this.sendVideoSizeLowerLimitApp,Math.min(this.sendVideoSizeUpperLimit,this.sendVideoSizeUpperLimitApp,e)),this.maxRecvVideoSize=Math.max(this.recvVideoSizeLowerLimit,this.recvVideoSizeLowerLimitApp,Math.min(this.recvVideoSizeUpperLimit,this.recvVideoSizeUpperLimitApp,4)),this.maxRecvVideoNum=Math.max(this.recvVideoNumLowerLimit,this.recvVideoNumLowerLimitApp,Math.min(this.recvVideoNumUpperLimit,this.recvVideoNumUpperLimitApp))}setLimits(e){const{minSendVideoSize:t,maxSendVideoSize:i,minRecvVideoSize:a,maxRecvVideoSize:s,minRecvVideoNum:n,maxRecvVideoNum:r}=e;void 0!==t&&(this.sendVideoSizeLowerLimitApp=t),void 0!==i&&(this.sendVideoSizeUpperLimitApp=i),void 0!==a&&(this.recvVideoSizeLowerLimitApp=a),void 0!==s&&(this.recvVideoSizeUpperLimitApp=s),void 0!==n&&(this.recvVideoNumLowerLimitApp=n),void 0!==r&&(this.recvVideoNumUpperLimitApp=r),this._reset()}getCapabilities(){return{maxSendVideoSize:this.maxSendVideoSize,maxRecvVideoSize:this.maxRecvVideoSize,maxRecvVideoNum:this.maxRecvVideoNum}}};i(7855);var ft=i(3472),yt=i(2710),Mt=i(3323);const Ct=i(4388).A.getInstance();function Et(e){return null!=e&&e.length?parseInt(e.reduce(((e,t)=>e+t),0)/e.length):0}function It(e){return null!=e&&e.length?Math.max(...e):0}const Tt=class{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._userId=e.userId,this._monitorInfo={subscriber:{},publisher:{}},this._bitrateInfo={subscriber:{},publisher:{}},this._reportCount=0,this._MONITOR_RECORD_INTERVAL=12e3,this._BITRATE_RECORD_INTERVAL=1e3,this._INBOUND_AUDIO_LEVEL_INTERVAL=1e3,this._AUDIO_TAG_COUNT_AND_STATUS_CHECK_INTERVAL=5e3,this._enableBitrateReport=!1,this._lastAudioTagCountAndStatusCheckTime=0,this._uplinkMonitorInfoList=[],this._uplinkMonitorPrevTime=Date.now(),this._downlinkAudioLevelInfo={},this._audioMos=[],this._networkStatistics={publisher:{},subscriber:{}},this._wmscAudio=e.wmscAudio,this._onBadNetwork=e.onBadNetwork,this._onHealthCheck=e.onHealthCheck,this._onAudioPlayerErrorCheck=e.onAudioPlayerErrorCheck,this._onMonitorLog=e.onMonitorLog,this._isMonitoring=!1,this._onEntireStatsReportBind=this._onEntireStatsReport.bind(this)}destroy(e){Ct.reset(),this.stopMonitor(e)}setEnableBitrateReport(e){this._enableBitrateReport=e}setUserId(e){this._userId=e}startMonitor(e){this.stopMonitor(e),e.on(He.f7.StatsReport,this._onEntireStatsReportBind),this._isMonitoring=!0}stopMonitor(e){e.off(He.f7.StatsReport,this._onEntireStatsReportBind),this._resetMonitorCache(),this._isMonitoring=!1}resetWMSCPC(e,t){this.stopMonitor(e),this._isMonitoring&&this.startMonitor(t)}getBitrateInfo(){return this._bitrateInfo}_resetMonitorCache(){var e,t,i,a,s,n;this._monitorInfo={subscriber:{port:null===(e=this._monitorInfo)||void 0===e||null===(e=e.subscriber)||void 0===e?void 0:e.port,protocol:null===(t=this._monitorInfo)||void 0===t||null===(t=t.subscriber)||void 0===t?void 0:t.protocol,candidateType:null===(i=this._monitorInfo)||void 0===i||null===(i=i.subscriber)||void 0===i?void 0:i.candidateType},publisher:{port:null===(a=this._monitorInfo)||void 0===a||null===(a=a.publisher)||void 0===a?void 0:a.port,protocol:null===(s=this._monitorInfo)||void 0===s||null===(s=s.publisher)||void 0===s?void 0:s.protocol,candidateType:null===(n=this._monitorInfo)||void 0===n||null===(n=n.publisher)||void 0===n?void 0:n.candidateType}},this._bitrateInfo={publisher:{},subscriber:{}},this._networkStatistics={publisher:{},subscriber:{}}}_isTimeForMonitorLog(){return this._reportCount&&!(this._reportCount%Math.floor(this._MONITOR_RECORD_INTERVAL/He.Mr))}_isTimeForBitrate(){return!(this._reportCount%Math.floor(this._BITRATE_RECORD_INTERVAL/He.Mr))}_isTimeForInboundAudioLevel(){return!(this._reportCount%Math.floor(this._INBOUND_AUDIO_LEVEL_INTERVAL/He.Mr))}_isTimeForAudioTagCountAndStatus(){const e=performance.now();return!(e-this._lastAudioTagCountAndStatusCheckTime<this._AUDIO_TAG_COUNT_AND_STATUS_CHECK_INTERVAL||(this._lastAudioTagCountAndStatusCheckTime=e,0))}_onEntireStatsReport(e){this._uplinkStatsParse(e),this._downlinkStatsParse(e),this._networkStatsParse(e),this._getRWGNetworkLog(!0),this._getRWGNetworkLog(!1),this.sendAudioMos(),this._reportCount++}_uplinkStatsParse(e){var t,i,a;if(!e)return;const s=this._isTimeForMonitorLog();if(this._isTimeForBitrate()&&ft.Ay.outboundBitrateQosParse(e,this._bitrateInfo.publisher),!s)return;let n={};const{publisher:r}=this._monitorInfo;if(e.forEach((e=>{0!=ft.Ay.isAudioStat(e)&&(this._statRemoteInboundRTP(e,n,r),this._statOutBoundRTP(e,n,r),this._statMediaSource(e,n,r))})),this._checkNetworkQuality(0,null===(t=n[He.zu.MainAudio])||void 0===t?void 0:t.rtt),this._onHealthCheck&&this._onHealthCheck({uplinkPacketsSent:null===(i=n[He.zu.MainAudio])||void 0===i?void 0:i.packetsSent,uplinkTotalAudioEnergy:null===(a=n[He.zu.MainAudio])||void 0===a?void 0:a.totalAudioEnergy,isUplink:!0}),n[He.zu.MainAudio]){const{resLevelR16Log:e,resLevelR16LogDenoise:t}=this._wmscAudio.getLevelR16Log();n[He.zu.MainAudio].audioLevelR16Str=e,n[He.zu.MainAudio].audioLevelR16DenoiseStr=t}ft.Ay.audioSendQualityMonitor(n)}_downlinkStatsParse(e){var t;if(!e)return;const i=this._isTimeForMonitorLog(),a=this._isTimeForBitrate(),s=this._isTimeForInboundAudioLevel(),n=this._isTimeForAudioTagCountAndStatus();let r={ssrcMap:{}};a&&ft.Ay.inboundBitrateQosParse(e,null===(t=this._bitrateInfo)||void 0===t?void 0:t.subscriber);let o=i;const{subscriber:c}=this._monitorInfo;var d;e.forEach((e=>{i&&this._downLinkCandidatePairParse(e,r),0!=ft.Ay.isAudioStat(e)&&(ft.Ay.remoteOutboundRTTParse(e),o=this._statInboundRTPParseReturnShoudSendMonitor(e,r,c,s&&!i)||o)})),i&&this._checkNetworkQuality(1,r.rtt),this._onHealthCheck&&this._onHealthCheck({downlinkStatInfo:r,isUplink:!1}),o&&this._handleDownlinkMonitorLog(r),n&&(null===(d=this._wmscAudio._healthChecker)||void 0===d||d.checkAllPlayersHealth(this._wmscAudio._wmscPC,!1,yt.vr.HEALTH_CHECK_TIMER),this._onAudioPlayerErrorCheck())}async _networkStatsParse(e){e.forEach((t=>{ft.Ay.networkInfoStatisticsParse(e,t,this._monitorInfo.publisher,"publisher"),ft.Ay.networkInfoStatisticsParse(e,t,this._monitorInfo.subscriber,"subscriber")}))}_statRemoteInboundRTP(e,t,i){"remote-inbound-rtp"==e.type&&ft.Ay.remoteInboundRTPStatisticParse(He.zu.MainAudio,e,this._wmscAudio.getAudioMode(),t,i)}_statOutBoundRTP(e,t,i){"outbound-rtp"==e.type&&ft.Ay.outboundRTPStatisticsParse(this._wmscAudio.getUplinkMidOrSSRC2MediaType(e.mid,e.ssrc),e,this._wmscAudio.getAudioMode(),t,i)}_statMediaSource(e,t,i){let a=this._wmscAudio.getAudioStream();"media-source"==e.type&&ft.Ay.mediaSourceStatisticsParse(a,e,this._wmscAudio.getAudioMode(),t,i)}_downLinkCandidatePairParse(e,t){const{subscriber:i}=this._monitorInfo,{totalRoundTripTime:a,responsesReceived:s,type:n,state:r,nominated:o}=e;if("candidate-pair"===n&&"succeeded"===r&&o){i.prevStatInfo||(i.prevStatInfo={responsesReceived:s,totalRoundTripTime:a});const{prevStatInfo:e}=i,n=Math.floor(1e3*(s===e.responsesReceived?0:(a-e.totalRoundTripTime)/(s-e.responsesReceived)));Ct.updateGlobalRTT(n),Object.assign(t,{rtt:n}),Object.assign(i.prevStatInfo,{totalRoundTripTime:a,responsesReceived:s})}}_statInboundRTPParseReturnShoudSendMonitor(e,t,i,a){if("inbound-rtp"!=e.type)return;let s;const{totalAudioEnergy:n,timestamp:r,jitterBufferDelay:o,jitterBufferEmittedCount:c,jitterBufferMinimumDelay:d,jitterBufferTargetDelay:l,ssrc:h,jitter:u,audioLevel:m,packetsLost:p,packetsDiscarded:g,packetsReceived:S,bytesReceived:_,concealedSamples:v,concealmentEvents:f,insertedSamplesForDeceleration:y,removedSamplesForAcceleration:M,silentConcealedSamples:C,totalProcessingDelay:E,nackCount:I}=e;let T=this._wmscAudio.getRemoteAudioPlayerByMid(e.mid);T&&(S>0||n>0)&&T.setStreamValid(),T&&(T.receivedPacketCount=S,T.totalReceivedAudioEnergy=n),this._cacheDownlinkAudioLevel(h,m,T),Ct.collectSample(e),this._wmscAudio._mIdMgr.getMediaTypeBySsrc(h)===He.zu.ShareAudio&&Ct.updateHasFEC(h,!1),i.ssrcMap||(i.ssrcMap={});let A=i.ssrcMap[h];if(a&&A)return!1;let R=this._wmscAudio.getZoomSSRCByWebRTCSSRC(h);if(R){if(A){Ct.calculateMOS(h,e),s=!0;const i=Math.sqrt((n-A.totalAudioEnergy)/(r-A.timestamp)).toFixed(4);let a=-1;"number"==typeof m&&(a=m.toFixed(4));const{aveJitterBufferDelay_ms:o,aveJitterBuffeTargetrDelay_ms:c,totalPacketsReceived_diff:l,packetsDiscarded_diff:p,insertedSamplesForDeceleration_diff:g,packetsLost_diff:S,concealedSamples_diff:_,removedSamplesForAcceleration_diff:y,silentConcealedSamples_diff:E,nackCount_diff:I,totalProcessingDelay_ms:b}=ft.Ay.getDownlinkStatisticsRate(A,e);t.ssrcMap["".concat(R)]=Object.assign(t.ssrcMap["".concat(R)]||{},{aveAudioLevel:i<1e-4?0:i,audioLevel:a<1e-4?0:a,jitter:u,jitterBufferMinimumDelay:d,concealedSamples:v,concealmentEvents:f,removedSamplesForAcceleration:M,silentConcealedSamples:C,audioPausedStatus:T?T.isPaused()?0:1:-1,audioMutedStatus:T?T.isMuted()?0:1:-1,totalAudioEnergy:n,aveJitterBufferDelay_ms:o,aveJitterBuffeTargetrDelay_ms:c,ssrc:h,audioVolume:T?T.getVolume():-1,isInterpreter:T?T.isInterpreter()?1:0:-1,totalPacketsReceived_diff:l,packetsDiscarded_diff:p,insertedSamplesForDeceleration_diff:g,packetsLost_diff:S,concealedSamples_diff:_,removedSamplesForAcceleration_diff:y,silentConcealedSamples_diff:E,nackCount_diff:I,totalProcessingDelay_ms:b})}else A=i.ssrcMap[h]={},s=!1;return this._wmscAudio.isUserMuted(R,h)||!R?i.ssrcMap[h]=null:Object.assign(A,{totalAudioEnergy:n,timestamp:r,jitterBufferDelay:o,jitterBufferEmittedCount:c,packetsLost:p,packetsReceived:S,bytesReceived:_,jitterBufferTargetDelay:l,totalProcessingDelay:E,insertedSamplesForDeceleration:y,packetsDiscarded:g,concealedSamples:v,removedSamplesForAcceleration:M,silentConcealedSamples:C,nackCount:I}),s}}_checkNetworkQuality(e,t){t&&this._onBadNetwork&&(t>5e3?this._onBadNetwork({isUplink:0===e,networkLevel:yt.tT.NET_QUALITY_VERY_BAD,bwLevel:yt.LA.NET_BW_LEVEL_VERY_LOW}):t>2e3&&this._onBadNetwork({isUplink:0===e,networkLevel:yt.tT.NET_QUALITY_BAD,bwLevel:yt.LA.NET_BW_LEVEL_LOW}))}_cacheDownlinkAudioLevel(e,t,i){const a=this._wmscAudio.getZoomSSRCByWebRTCSSRC(e);if(!a)return;let s="".concat(a);this._downlinkAudioLevelInfo[s]||(this._downlinkAudioLevelInfo[s]=[]),null!=i&&i.isPaused()?this._downlinkAudioLevelInfo[s].push("x"):this._downlinkAudioLevelInfo[s].push(Mt.M8(t).toString(16))}_handleDownlinkMonitorLog(e){Object.keys(this._downlinkAudioLevelInfo).forEach((t=>{e.ssrcMap[t]&&(e.ssrcMap[t].zoomAudioLevel=this._downlinkAudioLevelInfo[t])})),this._downlinkAudioLevelInfo={},ft.Ay.audioRecvQualityMonitor(e),this._downlinkAudioLevelInfo={}}setAudioStatisticsFromRWG(e){const t=e.encoding?this._networkStatistics.publisher:this._networkStatistics.subscriber;Object.keys(e).forEach((i=>{"avg_mos"===i?this._audioMos.push(e[i]):(t[i]||(t[i]=[]),void 0!==e[i]&&t[i].push(e[i]))}))}sendAudioMos(){var e,t;if(!(arguments.length>0&&void 0!==arguments[0]&&arguments[0]||this._reportCount&&this._reportCount%10==0))return;const i=null===(e=this._audioMos)||void 0===e?void 0:e.length;if(!i)return;const a=this._audioMos[i-1].toFixed(2),s=(this._audioMos.reduce(((e,t)=>e+t),0)/i).toFixed(2);this._audioMos.length=0;const n="WCL_MCM_AUDIO,".concat(this._userId,",,,{[SPEECH_R16]},,,,,,{[PROCESS]},,,{[NETWORK]},,,,{[AUDIOSCORE]},,,,,,,,,,,,,,{[QUALITY]},").concat(a,",").concat(s,",{[SEND]},,,{[DENOISE]},,,,{[END]}");null===(t=this._onMonitorLog)||void 0===t||t.call(this,n)}_toIntSafe(e){const t=Number(e);return Number.isFinite(t)?Math.round(t):-1}_getRWGNetworkLog(e){var t,i;if(0===this._reportCount||this._reportCount%30!=0)return;const a=e?this._monitorInfo.publisher:this._monitorInfo.subscriber,s=e?this._networkStatistics.publisher:this._networkStatistics.subscriber,n=e?"RWG_UPLINK_NETWORK":"RWG_DOWNLINK_NETWORK",r="udp"===a.protocol?0:1,o=Math.floor(Date.now()/1e3),c=e?(null===(t=this._bitrateInfo)||void 0===t||null===(t=t.publisher)||void 0===t?void 0:t.bitrate)||0:(null===(i=this._bitrateInfo)||void 0===i||null===(i=i.subscriber)||void 0===i?void 0:i.bitrate)||0,d=c,l=this._toIntSafe(Et(s.avg_loss)),h=this._toIntSafe(It(s.max_loss)),u=this._toIntSafe(Et(s.rtt)),m=this._toIntSafe(It(s.rtt)),p=this._toIntSafe(u/2),g=this._toIntSafe(m/2),S=this._toIntSafe(Et(s.jitter)),_=this._toIntSafe(It(s.jitter)),v=this._toIntSafe(d),f=this._toIntSafe(c);e?this._networkStatistics.publisher={}:this._networkStatistics.subscriber={};const y="".concat(n,",").concat(this._userId,",").concat(1,",").concat(r,",").concat(o,",,").concat(v,",").concat(f,",").concat(l,",").concat(h,",,").concat(p,",").concat(g,",").concat(u,",").concat(m,",,,,,,,,,,,").concat(S,",").concat(_);this._onMonitorLog(y)}static getEstimatePlayoutTimestampFromStatsByMid(e,t){var i;let a;for(const[,i]of e)if("inbound-rtp"===i.type&&"audio"===i.kind&&i.mid===t){a=i;break}return null===(i=a)||void 0===i?void 0:i.estimatedPlayoutTimestamp}};var At=i(9559);function Rt(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,a)}return i}function bt(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Rt(Object(i),!0).forEach((function(t){(0,c.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Rt(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const wt=te.getTracer("WmscMonitor"),Dt=e=>{wt.log(e),te.monitorLog("".concat(e))},Lt=e=>e===Number.MIN_SAFE_INTEGER?"":e,Pt=e=>e===Number.MAX_SAFE_INTEGER?"":e,{tT:Ot,LA:Vt,ue:Nt}=a,kt=new class{constructor(){this.bToPrint=!0,this.mIdMgr=null,this.reportTimer=null,this.userId="",this.isMonitoring=!1,this.subInfo={},this.activeSpeaker="",this.isPreActiveSpeaker=!1,this.recordUserId="",this.reportTimer=null,this.lastSendPCsStatRecord=new Map,this.captureCount=0,this.rtpHeaderExt={"http://www.webrtc.org/experiments/rtp-hdrext/playout-delay":0,"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01":1,"urn:ietf:params:rtp-hdrext:sdes:mid":2,"http://www.webrtc.org/experiments/rtp-hdrext/video-layers-allocation00":3},this.sdpDirection={recvonly:0,sendonly:1,sendrecv:2,inactive:3},this.recvStatisticData={},this.reportCount=0,this.maxSubscribedSize=-1,this._telemetry=null,this.uiQosData={},this.isUISubQos=!1,this.UIQosInterval=1,this.candidateLog="",this.candidatePairLog="",this.iceCandidatePairState={frozen:0,waiting:1,"in-progress":2,failed:3,succeeded:4},this.ingressReport={},this.camStream=null,this.recvCodecProfile="",this.shouldReportNullDecoderError=!0,this.shouldReportEncodeFailedError=!0,this.recvRawStats={},this.sendRawStats={},this.ssrcLayerMap={},this.rawLog=[],this.prevUplinkState={},this.prevDownlinkState={},this.networkReportDelay=0,this.isDualCall=!1,this.layerStatus={numOfActive:0,numOfStopSending:0},this.isWebRTCVideoEnabled=!1,this.pcStats={senderStatisticData:{},receiverStatisticData:{},statisticData:{}},this.videoObserverEnabled=!1,this.videoObserverFramerateEnabled=!1,this.recvVideoQuality={},this.avSyncMgr=null,this.rawRTPInboundStats={},this.qosReport=null,this.ssrcProfileMap={}}setTelemetry(e){this._telemetry="function"==typeof e?e:null}updateQosSubscription(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3;this.isUISubQos=e,this.UIQosInterval=Math.round(t/1e3)}enableVideoObserver(e,t){this.videoObserverEnabled=e,this.videoObserverFramerateEnabled=e&&t}setUserId(e){this.userId=parseInt(e,10)}setQoSDataCb(e){this.sendQoSData=e}onQosReport(e){this.qosReport=e}updateSubInfo(e,t){Dt("WMSC_USBI: ".concat(e,"|").concat(t)),t>=0?this.subInfo[e]=t:(delete this.subInfo[e],delete this.recvVideoQuality[e],this.resetRecvStats(e)),wt.log("updateSubInfo:",this.subInfo)}setActiveSpeaker(e,t){this.activeSpeaker=Q(parseInt(e,10)),this.isPreActiveSpeaker=t}updateSubscribedSize(e,t,i){let a=-1;Array.from(new Set([...e,...t,...i])).forEach((e=>{a=Math.max(a,e)})),this.maxSubscribedSize=a}start(){Dt("WMSC_MSTART: ".concat(this.isMonitoring)),this.isMonitoring||(this._startReport(),this.isMonitoring=!0,this.shouldReportNullDecoderError=!0,this.shouldReportEncodeFailedError=!0,this.networkReportDelay=0)}resetRecvStats(e){var t;let i;null!==(t=this.pcStats.receiverStatisticData)&&void 0!==t&&t[e]&&(i=this.pcStats.receiverStatisticData[e].ssrc,delete this.pcStats.receiverStatisticData[e]),i&&(this.pcStats["begin-video-inbound-rtp"]&&delete this.pcStats["begin-video-inbound-rtp"][i],this.pcStats["video-inbound-rtp"]&&delete this.pcStats["video-inbound-rtp"][i],this.pcStats["video-remote-outbound-rtp"]&&delete this.pcStats["video-remote-outbound-rtp"][i],this.ssrcProfileMap[i]&&delete this.ssrcProfileMap[i])}stop(){Dt("WMSC_MSTOP: ".concat(this.isMonitoring)),clearInterval(this.reportTimer),this._getStats(),this._uploadRawRTPInboundStats(),this.pcStats={senderStatisticData:{},receiverStatisticData:{},statisticData:{}},this.rawRTPInboundStats={},this.isMonitoring=!1}_sendQosData(){this.isUISubQos&&this.captureCount%this.UIQosInterval==0&&(this.uiQosData.receiving&&(this._telemetry&&this._telemetry({type:W.VIDEO_QOS_DATA,data:bt({encoding:!1},this.uiQosData.receiving)}),this.uiQosData.receiving=null),this.uiQosData.sending&&(this._telemetry&&this._telemetry({type:W.VIDEO_QOS_DATA,data:bt({encoding:!0},this.uiQosData.sending)}),this.uiQosData.sending=null))}_sendNetworkState(e){const{isUplink:t}=e;let i=!1;i=t?e.networkLevel!==this.prevUplinkState.networkLevel||e.bwLevel!==this.prevUplinkState.bwLevel:e.networkLevel!==this.prevDownlinkState.networkLevel||e.bwLevel!==this.prevDownlinkState.bwLevel,i&&(this._telemetry&&this._telemetry({type:W.NETWORK_QUALITY_CHANGE,data:e}),t?this.prevUplinkState=e:this.prevDownlinkState=e)}_getNetworkState(e,t,i){let a=Ot.NET_QUALITY_UNKNOWN,s=Vt.NET_BW_LEVEL_UNKNOWN;if(e>.5||t/2>5)a=Ot.NET_QUALITY_VERY_BAD;else if(e>.3||t/2>2)a=Ot.NET_QUALITY_BAD;else if(void 0!==i){const n=i/1024;n<320||e>.08&&t>.5?a=Ot.NET_QUALITY_NOT_GOOD:n>450?(a=Ot.NET_QUALITY_GOOD,s=Vt.NET_BW_LEVEL_NORMAL):n>850&&e<.05&&t<.3&&(a=Ot.NET_QUALITY_EXCELLENT,s=Vt.NET_BW_LEVEL_NORMAL)}return{networkLevel:a,bwLevel:s}}onStatsReport(e){this.captureCount++;try{this.handleStatsReport(e),this._sendQosData()}catch(e){wt.error("_startCapture, capture error: ".concat(e)),Dt("WMSC_LOGCE"),te.globalTrace({logLevel:"error",log:"WMSC_LOGCE",errorEvent:e})}}_startReport(){this.reportTimer=setInterval(this._reportStats.bind(this),f)}_reportStats(){try{this.reportCount++,this._getStats(),this._resetStats(),this.ingressReport.begin=null}catch(e){Dt("WMSC_LOGRE"),te.globalTrace({logLevel:"error",log:"WMSC_LOGRE",errorEvent:e})}}_resetSenderStats(){const{senderStatisticData:e}=this.pcStats;e.maxCamCaptureFps=e.maxCaptureFps=0,e.minCamCaptureFps=e.minCaptureFps=Math.MAX_SAFE_INTEGER,e.totalCamCaptureCount=e.totalCaptureCount=0,e.totalCamCaptureFps=e.totalCaptureFps=0;for(const t in this.pcStats["video-outbound-rtp"])e[t]={maxEncodeTime:0,minEncodeTime:Number.MAX_SAFE_INTEGER,avgEncodeTime:0,minSendFrameRate:Number.MAX_SAFE_INTEGER,maxSendFrameRate:0,avgSendFrameRate:0,minSendBitRate:Number.MAX_SAFE_INTEGER,maxSendBitRate:0,avgSendBitRate:0,minPacketSentDelay:Number.MAX_SAFE_INTEGER,maxPacketSentDelay:0,avgPacketSentDelay:0,maxLossRate:"",avgLossRate:"",encodePauseCount:0,count:0,maxQP:0,minQP:Number.MAX_SAFE_INTEGER,avgQP:0};this.pcStats["video-outbound-rtp"]&&(this.pcStats["begin-video-outbound-rtp"]=bt({},this.pcStats["video-outbound-rtp"])),this.pcStats["video-remote-inbound-rtp"]&&(this.pcStats["begin-video-remote-inbound-rtp"]=bt({},this.pcStats["video-remote-inbound-rtp"])),this.pcStats["video-media-source"]&&(this.pcStats["begin-video-media-source"]=this.pcStats["video-media-source"])}_resetReceiverStats(){const{receiverStatisticData:e}=this.pcStats;for(const t in e)e[t]={maxFps:0,minFps:Number.MAX_SAFE_INTEGER,avgFps:0,maxDecodeTime:0,minDecodeTime:Number.MAX_SAFE_INTEGER,avgDecodeTime:0,maxLossRate:0,avgLossRate:0,maxBt:0,minBt:Number.MAX_SAFE_INTEGER,avgBt:0,maxJitter:0,minLastRecvGap:Number.MAX_SAFE_INTEGER,maxLastRecvGap:0,avgLastRecvGap:0,noDataCount:0,count:0,decodePausedCount:0,maxAVSyncDelay:Number.MIN_SAFE_INTEGER,minAVSyncDelay:Number.MAX_SAFE_INTEGER,avgAVSyncDelay:"",avSyncDelayArray:[],audioEstimatedPlayoutTimestamp:"",maxJitterBufferDelay:0,minJitterBufferDelay:Number.MAX_SAFE_INTEGER,avgJitterBufferDelay:0,maxAppAVSyncDelay:Number.MIN_SAFE_INTEGER,minAppAVSyncDelay:Number.MAX_SAFE_INTEGER,avgAppAVSyncDelay:"",appAVSyncDelayArray:[]};this.pcStats["video-inbound-rtp"]&&(this.pcStats["begin-video-inbound-rtp"]=bt({},this.pcStats["video-inbound-rtp"])),this.pcStats["video-remote-outbound-rtp"]&&(this.pcStats["begin-video-remote-outbound-rtp"]=bt({},this.pcStats["video-remote-outbound-rtp"]))}_resetStats(){this._resetSenderStats(),this._resetReceiverStats(),this.pcStats["candidate-pair"]&&(this.pcStats["begin-candidate-pair"]=this.pcStats["candidate-pair"]),delete this.pcStats.statisticData.maxRtt,delete this.pcStats.codec}_generateSenderStatisticData(){const e=this.pcStats.senderStatisticData,t=this.pcStats["video-media-source"]||{},i=this.pcStats["prev-video-media-source"]||{},a=this.pcStats["video-outbound-rtp"]||{},s=this.pcStats["prev-video-outbound-rtp"]||{},n=this.pcStats["begin-video-outbound-rtp"]||{},r=this.pcStats["begin-video-media-source"]||{},o=this.pcStats["video-remote-inbound-rtp"]||{};let c=0,d=0;this.layerStatus.numOfActive=0,this.layerStatus.numOfStopSending=0;const{minCaptureFps:l,maxCaptureFps:h,minCamCaptureFps:u,maxCamCaptureFps:m,totalCaptureFps:p=0,totalCaptureCount:g=0,totalCamCaptureFps:S=0,totalCamCaptureCount:_=0}=e;let v=!1;const f=Je.getSender(),{frames:y}=t,{frames:M}=i;if(f&&f.track){const{frameRate:i=0,width:a,height:s}=f.track.getSettings(),{framesPerSecond:n=i,height:r=a,width:o=s}=t;v=!0,e.minCaptureFps=Math.round(Math.min(n,l||Number.MAX_SAFE_INTEGER)),e.maxCaptureFps=Math.round(Math.max(n,h||0)),e.totalCaptureFps=p+n,e.totalCaptureCount=g+1,e.avgCaptureFps=Math.round(e.totalCaptureFps/e.totalCaptureCount),e.captureWidth=null!=r?r:"",e.captureHeight=null!=o?o:""}if(this.camStream){var C;const{frameRate:t=0}=null===(C=this.camStream.getVideoTracks()[0])||void 0===C?void 0:C.getSettings();e.minCamCaptureFps=Math.round(Math.min(t,u||Number.MAX_SAFE_INTEGER)),e.maxCamCaptureFps=Math.round(Math.max(t,m||0)),e.totalCamCaptureFps=S+t,e.totalCamCaptureCount=_+1,e.avgCamCaptureFps=Math.round(e.totalCamCaptureFps/e.totalCamCaptureCount)}for(const t in a){const{framesPerSecond:i="",bytesSent:l,framesSent:h,timestamp:u,framesEncoded:m,totalEncodeTime:p,packetsSent:g,totalPacketSendDelay:S,frameHeight:_,frameWidth:f,retransmittedPacketsSent:C,active:I,qualityLimitationDurations:T,qpSum:A}=a[t];let R=0;!1!==I&&(this._captureRawSendData(a[t]),this.layerStatus.numOfActive++);const{jitter:b}=o[t]||{};e[t]||(e[t]={});const w=e[t],{minEncodeFrameRate:D,maxEncodeFrameRate:L,minSendFrameRate:P,maxSendFrameRate:O,minSendBitRate:V,maxSendBitRate:N,maxEncodeTime:k,minEncodeTime:B,maxPacketSentDelay:U,minPacketSentDelay:x,maxJitter:F,maxLossRate:W,sendWidth:z,sendHeight:j,maxQP:G,minQP:H}=w;if(w.minEncodeFrameRate=Math.min(i,D||Number.MAX_SAFE_INTEGER),w.maxEncodeFrameRate=Math.max(i,L||0),w.maxJitter=Math.max(b,F||0),s&&s[t]){if(!1===I||!v)continue;w.count++;const{timestamp:i,bytesSent:a,framesSent:o,framesEncoded:c,totalEncodeTime:b,packetsSent:D,totalPacketSendDelay:L,retransmittedPacketsSent:F,qpSum:Q}=s[t],{framesSent:q,bytesSent:Y,timestamp:K,framesEncoded:J,totalEncodeTime:X,packetsSent:Z,totalPacketSendDelay:$,retransmittedPacketsSent:ee,qualityLimitationDurations:ie,qpSum:ae}=n[t];let se,ne,re="",oe="";R=h-o;const ce=Math.round(R/((u-i)/1e3)),de=(8*(l-a)/((u-i)/1e3)).toFixed(2),le=Math.round((h-q)/((u-K)/1e3)),he=parseFloat((8*(l-Y)/((u-K)/1e3)).toFixed(2)),ue=Math.ceil((p-b)/(m-c)*1e3)||0,me=Math.ceil((p-X)/(m-J)*1e3)||0,pe=Math.round((m-J)/((u-K)/1e3)),{current:ge,begin:Se,prev:_e}=this.ingressReport;if(ge&&_e&&Se){const{lostPkts:e,recvPkts:t}=ge,{lostPkts:i,recvPkts:a}=_e,{lostPkts:s,recvPkts:n}=Se,r=e-i,o=e-s;oe=r/(t-a+r)||0,re=o/(t-n+o)||0}else re=(C-ee)/(g-Z)||0,oe=(C-F)/(g-D)||0;if(void 0!==S&&(se=(1e3*(S-L)/(g-D)).toFixed(3),ne=(1e3*(S-$)/(g-Z)).toFixed(3)),I&&m===c&&y&&y>M&&(w.encodePauseCount++,w.encodePauseCount>10&&this.layerStatus.numOfStopSending++,w.encodePauseCount>10&&this.shouldReportEncodeFailedError)){var E;const{frames:e=""}=r;let i="".concat(t,"|").concat(m,"|").concat(J,"|").concat(y,"|").concat(e,"|"),a=!1;if(T&&ie){const{bandwidth:e,cpu:t,other:s}=T,{bandwidth:n,cpu:r,other:o}=ie;a=e>n,i+="".concat(e,"|").concat(n,"|").concat(t,"|").concat(r,"|").concat(s,"|").concat(o)}const s=null===(E=this.camStream)||void 0===E?void 0:E.getVideoTracks()[0];i+=",videoTrack:".concat(!!s,"|").concat(s&&(null==s?void 0:s.muted)),te.globalTrace({logLevel:a?"warn":"error",log:"WMSC_ENCODE_STOP: ".concat(i)}),Dt("WMSC_ENCODE_STOP: ".concat(i)),this.shouldReportEncodeFailedError=!1}let ve="",fe="";void 0!==A&&m&&(void 0!==Q&&m>c&&(fe=Math.round((A-Q)/(m-c))),void 0!==ae&&m>J&&(ve=Math.round((A-ae)/(m-J)))),e[t]=bt(bt({},w),{},{maxEncodeTime:Math.max(k,ue),minEncodeTime:Math.min(ue,B),avgEncodeTime:me,minSendFrameRate:Math.min(ce,P),maxSendFrameRate:Math.max(O,ce),avgSendFrameRate:le,minSendBitRate:Math.min(de,V),maxSendBitRate:Math.max(N,de),avgSendBitRate:he,minPacketSentDelay:Math.min(se,x),maxPacketSentDelay:Math.max(se,U),avgPacketSentDelay:null!=ne?ne:"",avgEncodeFrameRate:pe,avgLossRate:isNaN(re)?"":re,maxLossRate:isNaN(oe)?W:Math.max(oe,W),sendWidth:f||z,sendHeight:_||j,maxQP:Math.max(G,fe),minQP:Math.min(H,fe),avgQP:ve}),d=Math.max(d,e[t].avgLossRate)}else e[t]=bt(bt({},w),{},{maxEncodeTime:0,minEncodeTime:Number.MAX_SAFE_INTEGER,avgEncodeTime:0,minSendFrameRate:Number.MAX_SAFE_INTEGER,maxSendFrameRate:0,avgSendFrameRate:0,minSendBitRate:Number.MAX_SAFE_INTEGER,maxSendBitRate:0,avgSendBitRate:0,minPacketSentDelay:Number.MAX_SAFE_INTEGER,maxPacketSentDelay:0,avgPacketSentDelay:0,maxLossRate:"",avgLossRate:"",encodePauseCount:0,maxQP:0,minQP:Number.MAX_SAFE_INTEGER,avgQP:0,count:0});if(_&&f){const a=_*f;if(a>c&&R>0){const{currentRoundTripTime:s=0,availableOutgoingBitrate:n}=this.pcStats["candidate-pair"]||{};c=a;const{maxLossRate:r,avgLossRate:o}=e[t];this.uiQosData.sending={width:f,height:_,fps:i,rtt:Math.round(1e3*s),max_loss:r>=0?1e3*r:"",avg_loss:o>=0?1e3*o:"",jitter:Math.round(1e3*(b||0)),rate:e[t].avgSendBitRate,bandwidth:n}}}}const{numOfActive:I,numOfStopSending:T}=this.layerStatus;if(I&&I===T&&(te.globalTrace({logLevel:"error",log:"WMSC_ENCODE_FAILED: ".concat(I)}),Dt("WMSC_ENCODE_FAILED"),this._telemetry({type:W.ERROR_MESSAGE,data:{type:"WEBRTC_VIDEO_HEALTH_CHECK_FAILED"}})),v)if(this.networkReportDelay>5){const{currentRoundTripTime:e=0,availableOutgoingBitrate:t}=this.pcStats["candidate-pair"]||{},i=this._getNetworkState(d,e,t);this._sendNetworkState(bt({isUplink:!0},i))}else this.networkReportDelay++;0===c&&(this.uiQosData.sending=bt(bt({},this.uiQosData.sending),{},{fps:0,width:0,height:0}))}_generateReceiverStatisticData(e){const t=this.mIdMgr.mIdResource;let i=0,a=0;for(const u in this.pcStats["video-inbound-rtp"]){const m=this.pcStats["video-inbound-rtp"][u];let{mid:p}=m;p||(p=this.mIdMgr.ssrcMidMap.get(m.ssrc));const{userId:g}=t.get(p)||{};let S=-1;if(g&&(S=this.mIdMgr.getVideoSizeByUserId(g),-1===S&&g===this.activeSpeaker&&(S=this.mIdMgr.getVideoSizeByUserId(E))),p&&S>-1){var s;let t;this._captureRawRecvData(m);let S=0,_=!1,v=!1;const{framesPerSecond:f="",timestamp:y="",framesDecoded:M="",frameWidth:C="",frameHeight:E="",bytesReceived:I="",framesReceived:T="",totalDecodeTime:A="",packetsReceived:R="",packetsLost:b="",jitter:w="",lastPacketReceivedTimestamp:D=0,fecPacketsReceived:L=0,retransmittedPacketsReceived:P=0,jitterBufferEmittedCount:O,decoderImplementation:V,estimatedPlayoutTimestamp:N,jitterBufferDelay:k,codecId:B=""}=m;if(null!==(s=this.ssrcProfileMap[u])&&void 0!==s&&s.isPendding){const{changeTime:e,profileId:t}=this.ssrcProfileMap[u],i=D||(new Date).getTime();(this.getRecvH264ProfileFromStats(B)===t||i-e>5e3)&&(this.ssrcProfileMap[u].isPendding=!1)}const U=this.mIdMgr.getAudioMidByUserId(g),x=Tt.getEstimatePlayoutTimestampFromStatsByMid(e,U);if(this.pcStats.receiverStatisticData[g]){var n;this.pcStats.receiverStatisticData[g].count++;const{maxFps:e,minFps:a,maxDecodeTime:s,minDecodeTime:r,maxLossRate:o,maxBt:c,minBt:d,maxJitter:l,minLastRecvGap:h,maxLastRecvGap:m,avgLastRecvGap:T,count:B,maxAVSyncDelay:U,minAVSyncDelay:F,avSyncDelayArray:W,minJitterBufferDelay:z,maxJitterBufferDelay:j,maxAppAVSyncDelay:G,minAppAVSyncDelay:H,appAVSyncDelayArray:Q}=this.pcStats.receiverStatisticData[g],q=this.pcStats["prev-video-inbound-rtp"][u],Y=this.pcStats["begin-video-inbound-rtp"][u],{timestamp:K,framesDecoded:J,totalDecodeTime:X,packetsLost:Z,packetsReceived:$,bytesReceived:ee,fecPacketsReceived:ie=0,retransmittedPacketsReceived:ae=0,jitterBufferEmittedCount:se=0,pliCount:ne=0,jitterBufferDelay:re=0}=Y||{},{packetsLost:oe,packetsReceived:ce,totalDecodeTime:de,framesDecoded:le,bytesReceived:he,timestamp:ue,lastPacketReceivedTimestamp:me,fecPacketsReceived:pe=0,retransmittedPacketsReceived:ge=0,jitterBufferEmittedCount:Se=0,jitterBufferDelay:_e=0}=q||{};S=M-le,0===S&&O>Se&&this.pcStats.receiverStatisticData[g].decodePausedCount++,"NullVideoDecoder"===V&&this.shouldReportNullDecoderError&&(te.globalTrace({logLevel:"error",log:"WMSC_NULLDECODER: ".concat(p)}),Dt("WMSC_NULLDECODER,".concat(p)),this.shouldReportNullDecoderError=!1);const ve=R-$-(L-ie)-(P-ae),fe=(b-oe)/(R-ce-(L-pe)-(P-ge)+(b-oe))||0,ye=Math.ceil((A-de)/(M-le)*1e3)||0;t=8*(I-he)/((y-ue)/1e3);const Me=8*(I-ee)/((y-K)/1e3);if(me){const e=parseInt(D-me,10);this.pcStats.receiverStatisticData[g].minLastRecvGap=Math.min(h,e),this.pcStats.receiverStatisticData[g].maxLastRecvGap=Math.max(m,e),this.pcStats.receiverStatisticData[g].avgLastRecvGap=parseInt((T*(B-1)+e)/B,10),0===e&&this.pcStats.receiverStatisticData[g].noDataCount++}else this.pcStats.receiverStatisticData[g].minLastRecvGap=0,this.pcStats.receiverStatisticData[g].noDataCount++;if(this.pcStats.receiverStatisticData[g].maxFps=Math.max(e,f),this.pcStats.receiverStatisticData[g].minFps=Math.min(a,f),this.pcStats.receiverStatisticData[g].avgFps=Math.round((M-J)/((y-K)/1e3)),this.pcStats.receiverStatisticData[g].maxDecodeTime=Math.max(s,ye),this.pcStats.receiverStatisticData[g].minDecodeTime=Math.min(ye,r),this.pcStats.receiverStatisticData[g].avgDecodeTime=Math.ceil((A-X)/(M-J)*1e3)||0,this.pcStats.receiverStatisticData[g].prevTotalDecodeTime=A,this.pcStats.receiverStatisticData[g].prevFramesDecoded=M,this.pcStats.receiverStatisticData[g].maxLossRate=Math.max(o,fe),this.pcStats.receiverStatisticData[g].avgLossRate=(b-Z)/(ve+(b-Z))||0,this.pcStats.receiverStatisticData[g].maxJitter=Math.max(l,w),this.pcStats.receiverStatisticData[g].maxBt=Math.max(t,c),this.pcStats.receiverStatisticData[g].minBt=Math.min(t,d),this.pcStats.receiverStatisticData[g].avgBt=Me,i=Math.max(this.pcStats.receiverStatisticData[g].avgLossRate,i),N&&x){let e=x-N;this.pcStats.receiverStatisticData[g].audioEstimatedPlayoutTimestamp=x,W.push(e),this.pcStats.receiverStatisticData[g].maxAVSyncDelay=Math.max(U,e),this.pcStats.receiverStatisticData[g].minAVSyncDelay=Math.min(F,e),this.pcStats.receiverStatisticData[g].avgAVSyncDelay=Math.round(W.reduce(((e,t)=>e+t),0)/W.length)}let Ce=null===(n=this.avSyncMgr)||void 0===n?void 0:n.getAVSyncDiff(g);if(Ce){const{diff:e,audioNtpTimestamp:t,videoNtpTimestamp:i}=Ce;x||(this.pcStats.receiverStatisticData[g].audioEstimatedPlayoutTimestamp=t),this.pcStats.receiverStatisticData[g].videoEstimatedPlayoutTimestamp=i,Q.push(e),this.pcStats.receiverStatisticData[g].maxAppAVSyncDelay=Math.max(G,e),this.pcStats.receiverStatisticData[g].minAppAVSyncDelay=Math.min(H,e),this.pcStats.receiverStatisticData[g].avgAppAVSyncDelay=Math.round(Q.reduce(((e,t)=>e+t),0)/Q.length)}if(O>0&&void 0!==k){let e=(k-_e)/(O-Se),t=(k-re)/(O-se);e=Math.round(1e3*e),t=Math.round(1e3*t),e&&(this.pcStats.receiverStatisticData[g].maxJitterBufferDelay=Math.max(j,e),this.pcStats.receiverStatisticData[g].minJitterBufferDelay=Math.min(z,e)),t&&(this.pcStats.receiverStatisticData[g].avgJitterBufferDelay=t)}this.pcStats.receiverStatisticData[g].ssrc=parseInt(u,10),this.recvVideoQuality[g]?(this.recvVideoQuality[g].width===C&&this.recvVideoQuality[g].height===E||(this.recvVideoQuality[g].width=C,this.recvVideoQuality[g].height=E,_=!0),this.recvVideoQuality[g].fps!==f&&(this.recvVideoQuality[g].fps=f,v=!0)):(this.recvVideoQuality[g]={width:C,height:E,fps:f},_=!0,v=!0)}else t=8*I/T*f||"",this.pcStats.receiverStatisticData[g]={maxFps:f,minFps:f,avgFps:f,maxDecodeTime:0,minDecodeTime:Number.MAX_SAFE_INTEGER,avgDecodeTime:0,maxLossRate:0,avgLossRate:0,maxBt:t,minBt:t,avgBt:t,maxJitter:w,minLastRecvGap:Number.MAX_SAFE_INTEGER,maxLastRecvGap:0,avgLastRecvGap:0,noDataCount:0,count:0,decodePausedCount:0,maxAVSyncDelay:Number.MIN_SAFE_INTEGER,minAVSyncDelay:Number.MAX_SAFE_INTEGER,avgAVSyncDelay:"",avSyncDelayArray:[],maxAppAVSyncDelay:Number.MIN_SAFE_INTEGER,minAppAVSyncDelay:Number.MAX_SAFE_INTEGER,avgAppAVSyncDelay:"",appAVSyncDelayArray:[],maxJitterBufferDelay:0,minJitterBufferDelay:Number.MAX_SAFE_INTEGER,avgJitterBufferDelay:0,ssrc:parseInt(u,10)};if(C&&E){const e=C*E;if(e>a&&S>0){var r,o,c;const t=null===(r=this.mIdMgr)||void 0===r?void 0:r.getVideoTagsByUserId(g),{currentRoundTripTime:i=0,availableIncomingBitrate:s}=this.pcStats["candidate-pair"]||{};this.uiQosData.receiving={avg_loss:Math.max(1e3*this.pcStats.receiverStatisticData[g].avgLossRate,0),max_loss:Math.max(1e3*this.pcStats.receiverStatisticData[g].maxLossRate,0),fps:f||0,height:(null===(o=t[0])||void 0===o?void 0:o.videoHeight)||E,width:(null===(c=t[0])||void 0===c?void 0:c.videoWidth)||C,jitter:Math.round(1e3*(w||0)),rate:this.pcStats.receiverStatisticData[g].avgBt,rtt:Math.round(1e3*i),bandwidth:s},a=e}}if(_&&this.videoObserverEnabled){var d;const{width:e,height:t}=this.recvVideoQuality[g];null===(d=this._telemetry)||void 0===d||d.call(this,{type:W.CURRENT_DECODE_VIDEO_QUALITY,data:{ssrc:g,width:e,height:t,quality:(0,At.jK)(e,t)}})}var l;v&&this.videoObserverFramerateEnabled&&(null===(l=this._telemetry)||void 0===l||l.call(this,{type:W.CURRENT_DECODE_VIDEO_FPS,data:{ssrc:g,fps:this.recvVideoQuality[g].fps}})),this.bToPrint&&this._renderStatsData(p,C,E,f,t);const F=this.detectDecodeFailed(g);if(F){var h;const e=this.getRecvH264Profile(u);e||te.globalTrace({logLevel:"error",log:"WMSC_DECODE_FAILED_NP"});const t=Object.keys(this.subInfo).length,i="".concat(this.userId,"|").concat(p,"|").concat(t,"|").concat(F,"|").concat(e);return void(null!==(h=this.ssrcProfileMap[u])&&void 0!==h&&h.isPendding||(te.globalTrace({logLevel:"error",log:"WMSC_DECODE_FAILED: ".concat(i)}),Dt("WMSC_DECODE_FAILED:".concat(i)),e&&this.onDecodeError&&(this.onDecodeError(e),Je.ingressCodecList.length>0&&(this.ssrcProfileMap[u]={profileId:Je.ingressCodecList[0].codecParams.get("profile-level-id"),isPendding:!0,changeTime:(new Date).getTime()}))))}}}const{currentRoundTripTime:u=0}=this.pcStats["candidate-pair"]||{},m=this._getNetworkState(i,u);this._sendNetworkState(bt({isUplink:!1},m)),0===a&&(this.uiQosData.receiving=bt(bt({},this.uiQosData.receiving),{},{fps:0,width:0,height:0}))}_getVideoSenderLog(){var e;let t="",i="",a={};if(!Je.getPc())return;const s=Je.getSender();s&&null!==(e=s.track)&&void 0!==e&&e.getStats&&(a=s.track.getStats());const{fps:n="",receivingFps:r="",generatedFrames:o="",receivedFrames:c=""}=a,d=this.pcStats,{frames:l=""}=d["video-media-source"]||{};let h=0,u=0;for(const e in d["video-outbound-rtp"]){var m;const a="{[SEND".concat(this.ssrcLayerMap[e],"]}"),s="{[ENCO".concat(this.ssrcLayerMap[e],"]}"),{minEncodeFrameRate:p,maxEncodeFrameRate:g,avgEncodeFrameRate:S,minSendFrameRate:_,maxSendFrameRate:v,avgSendFrameRate:f,minSendBitRate:y,maxSendBitRate:M,avgSendBitRate:C,maxEncodeTime:E,minEncodeTime:I,avgEncodeTime:T,maxPacketSentDelay:A,minPacketSentDelay:R,avgPacketSentDelay:b,sendWidth:w="",sendHeight:D="",encodePauseCount:L,count:P=0,maxQP:O,minQP:V,avgQP:N}=d.senderStatisticData[e]||{};if(0===P)continue;let{minCaptureFps:k,maxCaptureFps:B,avgCaptureFps:U,captureHeight:x,captureWidth:F,minCamCaptureFps:W,maxCamCaptureFps:z,avgCamCaptureFps:j}=d.senderStatisticData;this.camStream||(W=k,z=B,j=U);const{keyFramesEncoded:G="",qualityLimitationReason:H="",pliCount:Q="",nackCount:q="",firCount:Y="",framesSent:K="",retransmittedPacketsSent:J="",powerEfficientEncoder:X,hugeFramesSent:Z="",packetsSent:$="",bytesSent:ee="",qualityLimitationDurations:te={},encoderImplementation:ie="",targetBitrate:ae="",codecId:se,active:ne,qpSum:re="",framesEncoded:oe=""}=d["video-outbound-rtp"][e],{framesSent:ce}=d["begin-video-outbound-rtp"][e],{bandwidth:de="",cpu:le="",none:he="",other:ue=""}=te,{mimeType:me="h264",sdpFmtpLine:pe=""}=(null===(m=d.codec)||void 0===m?void 0:m[se])||{};let ge="";const Se=pe.match(/profile-level-id=([A-Za-z0-9]+);/);Se&&(ge=Se[1]);let _e=-1!==me.toLowerCase().indexOf("h264")?0:2;X&&(_e|=1);const ve=w*D;K-ce>0&&ve>h&&(h=ve,u=this.ssrcLayerMap[e]),t+="".concat(a,",").concat(this.maxSubscribedSize,",").concat(F,",").concat(x,",").concat(B,",").concat(k,",").concat(U,",,,,,,,").concat(g,",").concat(p,",").concat(S,",").concat(M,",").concat(y,",").concat(C,",").concat(v,",").concat(_,",").concat(f,",").concat(w,",").concat(D,",").concat(K,",,,,").concat(z,",").concat(W,",").concat(j,",").concat(isNaN(A)?"":A,",").concat(isNaN(R)?"":R,",").concat(isNaN(b)?"":b,",").concat($,",").concat(ee,",").concat(G,",").concat(Z,",").concat(q,",").concat(Y,",").concat(Q,",").concat(J,",").concat(H,",").concat(de,",").concat(le,",").concat(ue,",").concat(he,",").concat(ae,",").concat(l,",").concat(L,",").concat(void 0===ne?"":ne,",").concat(P,",").concat(n,",").concat(r,",").concat(o,",").concat(c,",").concat(this.ssrcLayerMap[e],",").concat(re,",").concat(N,",").concat(O,",").concat(V,",").concat(oe,",").concat(e,","),i+="".concat(s,",").concat(E,",").concat(Pt(I),",").concat(T,",,").concat(_e,",").concat(ie,",").concat(ge,",")}return t=t.replace("{[SEND".concat(u,"]}"),"{[SEND]}"),i=i.replace("{[ENCO".concat(u,"]}"),"{[ENCO]}"),"".concat(t).concat(i)}_getVideoReceiveLog(){var e;const t=new Array(8).fill(0),i=new Array(8).fill(0);let a,s=-1;const n={};for(const e in this.pcStats.receiverStatisticData){var r,o,c,d,l;const{maxFps:t,minFps:M,avgFps:C,maxBt:I,minBt:T,avgBt:A,minLastRecvGap:R,maxLastRecvGap:b,avgLastRecvGap:w,noDataCount:D,count:L,decodePausedCount:P,maxAVSyncDelay:O,minAVSyncDelay:V,avgAVSyncDelay:N,audioEstimatedPlayoutTimestamp:k="",videoEstimatedPlayoutTimestamp:B="",maxJitterBufferDelay:U,minJitterBufferDelay:x,avgJitterBufferDelay:F,maxAppAVSyncDelay:W,minAppAVSyncDelay:z,avgAppAVSyncDelay:j,appAVSyncDelayArray:G,ssrc:H=""}=(null===(r=this.pcStats.receiverStatisticData)||void 0===r?void 0:r[e])||{},Q=this.pcStats["video-inbound-rtp"][H]||{},q=this.pcStats["begin-video-inbound-rtp"][H]||{};let Y="";null!=G&&G.length&&(Y=Math.round(G.reduce(((e,t)=>e+Math.abs(t)),0)/G.length));const{framesReceived:K="",framesDropped:J="",framesDecoded:X="",totalProcessingDelay:Z=""}=q,{frameHeight:$=0,frameWidth:ee=0,freezeCount:te="",framesReceived:ie="",framesDropped:ae="",keyFramesDecoded:se="",pauseCount:ne="",nackCount:re="",firCount:oe="",pliCount:ce="",totalProcessingDelay:de="",fecPacketsReceived:le="",retransmittedPacketsReceived:he="",framesDecoded:ue="",bytesReceived:me="",packetsReceived:pe="",packetsLost:ge="",jitterBufferEmittedCount:Se="",estimatedPlayoutTimestamp:_e="",jitterBufferTargetDelay:ve,framesAssembledFromMultiplePackets:fe="",totalAssemblyTime:ye,timestamp:Me,mid:Ce,framesPerSecond:Ee="",qpSum:Ie="",totalDecodeTime:Te,jitter:Ae="",totalInterFrameDelay:Re="",totalSquaredInterFrameDelay:be="",totalPausesDuration:we="",totalFreezesDuration:De="",lastPacketReceivedTimestamp:Le="",headerBytesReceived:Pe="",packetsDiscarded:Oe="",fecBytesReceived:Ve="",fecPacketsDiscarded:Ne="",jitterBufferDelay:ke="",jitterBufferMinimumDelay:Be="",powerEfficientDecoder:Ue="",retransmittedBytesReceived:xe="",codecId:Fe}=Q,{payloadType:We=""}=(null===(o=this.pcStats.codec)||void 0===o?void 0:o[Fe])||{},ze=ie-K,je=ae-J,Ge=(je/ze||0).toFixed(2),He=((de-Z)/(ue-X)*1e3||0).toFixed(2),Qe=ue-X;if(void 0!==this.subInfo[e]||void 0!==this.subInfo[E]&&parseInt(e,10)===this.activeSpeaker){const t=ee*$;t>s&&(s=t,a=parseInt(e,10)),t>0&&Qe>0&&i[(0,At.jK)(ee,$)]++}let qe;parseInt(e,10)===this.activeSpeaker&&(qe=this.mIdMgr.getVideoTagsByUserId(E)),0===(null===(c=qe)||void 0===c?void 0:c.length)&&(qe=this.mIdMgr.getVideoTagsByUserId(parseInt(e,10)));let Ye="",Ke="",Je="";if(null!==(d=qe)&&void 0!==d&&d.length){const e=qe[0];Ye=e.currentTime>0&&!e.paused&&!e.ended&&e.readyState>2?1:0;const t=e.getVideoPlaybackQuality();Je=t.droppedVideoFrames,Ke=t.totalVideoFrames-Je}const Xe=void 0===ye?"":Math.round(1e3*ye);var h,u,m,p,g,S,_,v,f,y;n[e]="".concat(t,",").concat(M,",").concat(C,",").concat(ee,",").concat($,",").concat(e,",").concat(L,",").concat(D,",,,,,,,,").concat(_e||B,",").concat(k,",,,,").concat(ze,",").concat(je,",").concat(Ge,",").concat(null!==(l=this.subInfo[e])&&void 0!==l?l:"",",,,,").concat(Qe,",").concat(Ye,",").concat(Ke,",").concat(Je,",").concat((I||0).toFixed(2),",").concat((T||0).toFixed(2),",").concat((A||0).toFixed(2),",").concat(pe,",").concat(ge,",").concat(me,",").concat(se,",").concat(ne,",").concat(te,",").concat(re,",").concat(oe,",").concat(ce,",").concat(le,",").concat(he,",").concat(He,",").concat(Math.round(1e3*ve),",").concat(Se,",").concat(b,",").concat(R,",").concat(w,",").concat(P,",").concat(Lt(O),",").concat(Pt(V),",").concat(N,",").concat(U,",").concat(x,",").concat(F,",").concat(H,",").concat(this.mIdMgr.ssrcMidMap.get(H),",").concat(Xe,",").concat(fe,",").concat(Lt(W),",").concat(Pt(z),",").concat(j,",").concat(Y),this.reportCount%2==0&&H&&Me&&(this.rawRTPInboundStats[H]="".concat(Me,",").concat(H,",").concat(pe,",").concat(ge,",").concat(Ae,",").concat(Ce||this.mIdMgr.ssrcMidMap.get(H),",").concat(ue,",").concat(se,",").concat(Ke,",").concat(ae,",").concat(ee,",").concat($,",").concat(Ee,",").concat(Ie,",").concat(null==Te||null===(h=Te.toFixed)||void 0===h?void 0:h.call(Te,3),",").concat(null==Re||null===(u=Re.toFixed)||void 0===u?void 0:u.call(Re,3),",").concat(null==be||null===(m=be.toFixed)||void 0===m?void 0:m.call(be,3),",").concat(ne,",").concat(null==we||null===(p=we.toFixed)||void 0===p?void 0:p.call(we,3),",").concat(te,",").concat(null==De||null===(g=De.toFixed)||void 0===g?void 0:g.call(De,3),",").concat(Le,",").concat(Pe,",").concat(Oe,",").concat(Ve,",").concat(le,",").concat(Ne,",").concat(me,",").concat(re,",").concat(oe,",").concat(ce,",").concat(null==de||null===(S=de.toFixed)||void 0===S?void 0:S.call(de,3),",").concat(_e,",").concat(null==ke||null===(_=ke.toFixed)||void 0===_?void 0:_.call(ke,3),",").concat(null==ve||null===(v=ve.toFixed)||void 0===v?void 0:v.call(ve,3),",").concat(Se,",").concat(null==Be||null===(f=Be.toFixed)||void 0===f?void 0:f.call(Be,3),",").concat(ie,",").concat(Ue,",").concat(fe,",").concat(null==ye||null===(y=ye.toFixed)||void 0===y?void 0:y.call(ye,3),",").concat(he,",").concat(xe,",").concat(We))}this.activeSpeaker&&null!==(e=this.pcStats.receiverStatisticData)&&void 0!==e&&e[this.activeSpeaker]&&void 0!==this.subInfo[E]?this.recordUserId=this.activeSpeaker:this.recordUserId=a;for(const e in this.subInfo)t[this.subInfo[e]]++;const M="{[RECV]},".concat(t.join(","),",").concat(i.join(","),",");if(this.recvStatisticData[(new Date).toUTCString()]=n,this.reportCount%4==0)try{const e=JSON.stringify(this.recvStatisticData);q(e,I.GZIP_BASE64).then((e=>{te.globalTrace({logLevel:"log",log:"WCL_WB_VIDEO,".concat(e)}),this.recvStatisticData={}})).catch((t=>{te.globalTrace({logLevel:"error",log:"WMSC compress video log failed",errorEvent:t}),te.globalTrace({logLevel:"log",log:"WCL_WB_VIDEO,".concat(e)}),this.recvStatisticData={}}))}catch(e){te.globalTrace({logLevel:"error",log:"WMSC_Video_Log_Parse_Failed",errorEvent:e}),this.recvStatisticData={}}return n[this.recordUserId]?"".concat(M).concat(n[this.recordUserId],","):M}_getVideoDecodeLog(){var e,t;if(null===(e=this.pcStats.receiverStatisticData)||void 0===e||!e[this.recordUserId])return"";const{maxDecodeTime:i,minDecodeTime:a,avgDecodeTime:s,ssrc:n}=this.pcStats.receiverStatisticData[this.recordUserId],{powerEfficientDecoder:r,codecId:o,decoderImplementation:c=""}=this.pcStats["video-inbound-rtp"][n]||{},d=(null===(t=this.pcStats.codec)||void 0===t?void 0:t[o])||{},l=this.getRecvH264Profile(n),{mimeType:h="h264"}=d,u=(-1!==h.toLowerCase().indexOf("h264")?0:2)|(r?1:0);return"{[DECO]},".concat(i,",").concat(Pt(a),",").concat(s,",,").concat(u,",").concat(c,",").concat(l,",")}_getDownLinkLog(){var e,t;const{maxLossRate:i="",avgLossRate:a="",maxJitter:s="",ssrc:n}=(null===(e=this.pcStats.receiverStatisticData)||void 0===e?void 0:e[this.recordUserId])||{},r=(null===(t=this.pcStats["video-inbound-rtp"])||void 0===t?void 0:t[n])||{},{packetsLost:o="",jitter:c=""}=r,d=this.pcStats["remote-candidate"]||{},l=this.pcStats["candidate-pair"]||{},h=this.pcStats["begin-candidate-pair"]||{},{maxRtt:u}=this.pcStats.statisticData||{},{protocol:m}=d,{availableIncomingBitrate:p="",bytesReceived:g="",timestamp:S="",totalRoundTripTime:_="",responsesReceived:v="",packetsReceived:f=""}=l,{bytesReceived:y,timestamp:M}=h,C=(8*(g-y)/((S-M)/1e3)).toFixed(2),E=Math.round(_/v*1e3)||"";return"RWG_WB_DOWNLINK_NETWORK,".concat(this.userId,",3,").concat("udp"===m?0:1,",").concat(Math.round(S/1e3),",,").concat(p,",").concat(C,",").concat(Math.round(1e3*a),",").concat(Math.round(1e3*i),",,,,").concat(E,",").concat(1e3*u,",").concat(f,",").concat(o,",,,,,,,,,").concat(Math.round(1e3*c),",").concat(Math.round(1e3*s))}_getUpLinkLog(){var e;let t="";const i=this.pcStats["candidate-pair"]||{},a=this.pcStats["remote-candidate"]||{},s=this.pcStats["video-remote-inbound-rtp"]||{},{timestamp:n,availableOutgoingBitrate:r="",totalRoundTripTime:o,responsesReceived:c}=i,{protocol:d}=a;let{maxRtt:l=""}=this.pcStats.statisticData;l=l?1e3*l:"";let h="",u="",m="",p="",g="",S="",_="";for(const e in this.pcStats["video-outbound-rtp"]){const{maxJitter:t,avgLossRate:i,maxLossRate:a}=this.pcStats.senderStatisticData[e]||{},{packetsLost:n,jitter:r}=s[e]||{},{packetsSent:o,timestamp:c,bytesSent:d}=this.pcStats["video-outbound-rtp"][e]||{},{bytesSent:l,timestamp:v}=this.pcStats["begin-video-outbound-rtp"][e]||{};t&&!m&&(m=Math.round(1e3*t)),!i&&0!==i||h||(h=Math.round(1e3*i)),!a&&0!==a||u||(u=Math.round(1e3*a)),r&&!g&&(g=Math.round(1e3*r)),void 0!==d&&void 0!==l&&(S=parseInt(S+8e3*(d-l)/(c-v),10)),(o||0===o)&&(_=parseInt(_+o,10)),(n||0===n)&&(p=parseInt(p+n,10))}const v=Math.round(o/c*1e3)||"";let f=null===(e=this.qosReport)||void 0===e||null===(e=e.uplink)||void 0===e?void 0:e.bw_wcl2rwg;return f=void 0!==f?1e3*f:"",t+=",3,".concat("udp"===d?0:1,",").concat(Math.round(n/1e3),",,").concat(f,",").concat(S,",").concat(h,",").concat(u,",,,,").concat(v,",").concat(l,",").concat(_,",").concat(p,",,,,,,,,,").concat(g,",").concat(m,",").concat(r),t?"RWG_WB_UPLINK_NETWORK,".concat(this.userId).concat(t):""}_getStats(){if(this.isWebRTCVideoEnabled){var e;let t=0;null!==(e=x.videoSettings)&&void 0!==e&&e.hdVideoEnabled&&(t|=Nt.HD_VIDEO),this.isDualCall&&(t|=Nt.DUAL_CALL);let i,a,s="WCL_WB_MCM_VIDEO,".concat(this.userId,",,").concat(document.hidden?0:1,",").concat(t,",");const n=this._getVideoSenderLog(),r=this._getVideoReceiveLog(),o=this._getVideoDecodeLog();this.reportCount%2==0&&(i=this._getDownLinkLog(),a=this._getUpLinkLog()),s+=n+r+o+"{[END]}",s&&te.directSendMonitorLog(s),i&&te.directSendMonitorLog(i),a&&te.directSendMonitorLog(a),this.bToPrint&&(s&&wt.log("_getStats, video log: ".concat(s)),i&&wt.log("_getStats, downlink log: ".concat(i)),a&&wt.log("_getStats, uplink log: ".concat(a)))}this.candidatePairLog&&(te.directSendMonitorLog("WMSC_CANDIDATE-PAIR: ".concat(this.candidatePairLog)),this.candidatePairLog="")}_renderStatsData(e){}sendSdpLog(e,t){try{const s=le.parseSdp(t),{media:n=[]}=s;let r,o;var i,a;n.forEach((t=>{const{ssrcGroups:i,mid:a,type:s,direction:n,ssrcs:c,codecs:d=[]}=t;if("sendonly"===n&&"ANSWER"===e&&"video"===s&&!this.recvCodecProfile){const{codecParams:e}=d[0]||{};e&&(this.recvCodecProfile=e.get("profile-level-id"))}i.forEach((e=>{let{semantics:t,ssrcs:i}=e;"SIM"===t&&i.forEach(((e,t)=>{this.ssrcLayerMap[e]=t}))})),c.forEach((e=>{let{ssrc:t}=e;this.mIdMgr.ssrcMidMap.set(t,a)})),"video"===s&&("sendonly"!==n||r||(r=t),"recvonly"!==n||o||(o=t))})),r&&te.directSendMonitorLog(this.generateSdpLog(e,r,null===(i=s.session)||void 0===i?void 0:i.groups)),o&&te.directSendMonitorLog(this.generateSdpLog(e,o,null===(a=s.session)||void 0===a?void 0:a.groups)),q(t,I.GZIP_BASE64).then((t=>{te.globalTrace({logLevel:"log",log:"WCL_WB_SDP-".concat(e,"-").concat(t)})}))}catch(i){te.globalTrace({logLevel:"error",log:"WCL_WB_SDP-".concat(e,"-").concat(t),errorEvent:i}),Dt("WMSC_SDPLE: ".concat(e))}}_getCandidatePairLog(e){const{localCandidateId:t,remoteCandidateId:i,nominated:a,state:s,packetsReceived:n,packetsSent:r,bytesReceived:o,bytesSent:c,currentRoundTripTime:d,requestsSent:l,responsesReceived:h,packetsDiscardedOnSend:u,bytesDiscardedOnSend:m,availableOutgoingBitrate:p="",priority:g=""}=e;return"".concat(g,",").concat(t,",").concat(i,",").concat(this.iceCandidatePairState[s],",").concat(a?1:0,",").concat(n,",").concat(r,",").concat(o,",").concat(c,",").concat(d,",").concat(l,",").concat(h,",").concat(u,",").concat(m,",").concat(p,",")}_getCandidateLog(e){const{id:t,candidateType:i,port:a,priority:s,protocol:n,type:r,usernameFragment:o,url:c="",relayProtocol:d="",networkType:l=""}=e;return"".concat(t,",").concat(s,",").concat(n,",").concat(i,",").concat(a,",").concat(l,",").concat("remote-candidate"===r?1:0,",").concat(o,",").concat(c,",").concat(d,",")}onReceiverReport(e){const{begin:t,current:i}=this.ingressReport;this.ingressReport.prev=i,this.ingressReport.current=e,t||(this.ingressReport.begin=i)}_captureRawRecvData(e){if(!e)return;const{timestamp:t,framesDecoded:i="",totalDecodeTime:a="",jitterBufferEmittedCount:s="",framesReceived:n="",ssrc:r}=e;if(!r)return;const o=this.mIdMgr.ssrcMidMap.get(r),c="mid-".concat(o,"-ssrc-").concat(r);if(this.recvRawStats[c]){const{startTime:e}=this.recvRawStats[c],r=this.recvRawStats[c].framesDecoded.length,o=Math.floor((t-e)/1e3)-r;if(r+o>P)this._generateRecvRawLog(c),this.recvRawStats[c]={startTime:t,framesDecoded:[i],totalDecodeTime:[Math.round(1e3*a)],jitterBufferEmittedCount:[s],framesReceived:[n]};else for(let e=0;e<o;e++){const t=e===o-1;this.recvRawStats[c].framesDecoded.push(t?i:""),this.recvRawStats[c].totalDecodeTime.push(t?Math.round(1e3*a):""),this.recvRawStats[c].jitterBufferEmittedCount.push(t?s:""),this.recvRawStats[c].framesReceived.push(t?n:"")}}else this.recvRawStats[c]={startTime:t,framesDecoded:[i],totalDecodeTime:[Math.round(1e3*a)],jitterBufferEmittedCount:[s],framesReceived:[n]}}_captureRawSendData(e){if(!e)return;const{type:t}=e;if("outbound-rtp"===t){const{timestamp:t,framesSent:i,framesEncoded:a,totalEncodeTime:s,ssrc:n}=e,r="sim-".concat(this.ssrcLayerMap[n],"-ssrc-").concat(n);if(this.sendRawStats[r]){const{startTime:e}=this.sendRawStats[r],n=this.sendRawStats[r].framesSent.length,o=Math.floor((t-e)/1e3)-n;if(n+o>P)this._generateSendRawLog(r),this.sendRawStats[r]={startTime:t,framesSent:[i],framesEncoded:[a],totalEncodeTime:[Math.round(1e3*s)]};else for(let e=0;e<o;e++){const t=e===o-1;this.sendRawStats[r].framesSent.push(t?i:""),this.sendRawStats[r].framesEncoded.push(t?a:""),this.sendRawStats[r].totalEncodeTime.push(t?Math.round(1e3*s):"")}}else this.sendRawStats[r]={startTime:t,framesSent:[i],framesEncoded:[a],totalEncodeTime:[Math.round(1e3*s)]}}else if("media-source"===t){const{frames:t,timestamp:i}=e;if(!t&&0!==t)return;if(this.sendRawStats.capturedFrames){const{startTime:e}=this.sendRawStats.capturedFrames,a=this.sendRawStats.capturedFrames.frames.length,s=Math.floor((i-e)/1e3)-a;if(a+s>P)this._generateSendRawLog("capturedFrames"),this.sendRawStats.capturedFrames={startTime:i,frames:[t]};else for(let e=0;e<s;e++){const i=e===s-1;this.sendRawStats.capturedFrames.frames.push(i?t:"")}}else this.sendRawStats.capturedFrames={startTime:i,frames:[t]}}}reportRawStats(){for(const e in this.sendRawStats)this._generateSendRawLog(e,!1);for(const e in this.recvRawStats)this._generateRecvRawLog(e,!1);this._uploadRawStats()}_generateRecvRawLog(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const{startTime:i,framesDecoded:a,framesReceived:s,jitterBufferEmittedCount:n,totalDecodeTime:r}=this.recvRawStats[e],o="".concat(this.userId,",0,").concat(e,",").concat(Math.round(i/1e3),",framesDecoded=").concat(JSON.stringify(a),",framesReceived=").concat(JSON.stringify(s),",jitterBufferEmittedCount=").concat(JSON.stringify(n),",totalDecodeTime=").concat(JSON.stringify(r));this._sendRawLog(o,t),delete this.recvRawStats[e]}_generateSendRawLog(e){let t,i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if("capturedFrames"===e){const{frames:i,startTime:a}=this.sendRawStats[e];t="".concat(this.userId,",1,").concat(e,",").concat(Math.round(a/1e3),",capturedFrames=").concat(JSON.stringify(i))}else{const{startTime:i,framesEncoded:a,framesSent:s,totalEncodeTime:n}=this.sendRawStats[e];t="".concat(this.userId,",1,").concat(e,",").concat(Math.round(i/1e3),",framesEncoded=").concat(JSON.stringify(a),",framesSent=").concat(JSON.stringify(s),",totalEncodeTime=").concat(JSON.stringify(n))}this._sendRawLog(t,i),delete this.sendRawStats[e]}_sendRawLog(e,t){this.rawLog.push(e),t&&this.rawLog.length>O&&this._uploadRawStats()}_uploadRawStats(){if(this.rawLog.length>0){const e=this.rawLog.join("|");this.rawLog=[],q(e,I.GZIP_BASE64).then((e=>{te.globalTrace({logLevel:"directReport",log:e,tags:["WCL_WB_RAW_STATS"]})})).catch((()=>{te.globalTrace({logLevel:"directReport",log:rawLog,tags:["WCL_WB_RAW_STATS"]})}))}}detectDecodeFailed(e){const{decodePausedCount:t,ssrc:i}=this.pcStats.receiverStatisticData[e],{framesDecoded:a,jitterBufferEmittedCount:s="",pliCount:n,packetsLost:r,framesReceived:o=""}=this.pcStats["begin-video-inbound-rtp"][i],{framesDecoded:c,jitterBufferEmittedCount:d="",pliCount:l,packetsLost:h,decoderImplementation:u,framesReceived:m="",codecId:p}=this.pcStats["video-inbound-rtp"][i],g="".concat(c,"|").concat(a,"|").concat(d,"|").concat(s,"|").concat(h,"|").concat(r,"|").concat(l,"|").concat(n,"|").concat(u,"|").concat(t,"|").concat(m,"|").concat(o);if(c>a)return!1;if("NullVideoDecoder"===u)return g;if(d-s<=5)return!d&&m-o>150&&g;if(0===c&&l>n&&h===r)return g;const S=this.getRecvH264Profile(i),_=Je.ingressCodecList.some((e=>{let{codecParams:t}=e;const i=t.get("profile-level-id");return!!i&&$(i)}));return(Z(S)&&_&&d-s>=15&&c===a&&c>0||t>10)&&g}getRecvH264ProfileFromStats(e){if(this.pcStats.codec){var t;const i=null===(t=this.pcStats.codec)||void 0===t?void 0:t[e];if(i){const{sdpFmtpLine:e=""}=i,t=e.match(/profile-level-id=([A-Za-z0-9]+);/);if(t)return t[1]}}return""}getRecvH264Profile(e){if(this.ssrcProfileMap[e]&&!this.ssrcProfileMap[e].isPendding)return this.ssrcProfileMap[e].profileId;const{codecId:t}=this.pcStats["video-inbound-rtp"][e]||{};return this.getRecvH264ProfileFromStats(t)||this.recvCodecProfile}onDualCallState(e){let{isDualCall:t}=e;this.isDualCall=t}generateSdpLog(e,t){var i;let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];const{direction:s="",codecs:n=[],extensionMap:r,bandwidth:o,candidates:c,ssrcGroups:d=[]}=t,l=new Array(4).fill(-1),h=[],u={};let m="WCL_WB_SDP_".concat(e,",").concat(this.userId,",").concat((null===(i=a[0])||void 0===i?void 0:i.ids.length)||0,",").concat(this.sdpDirection[s],",");if(r)for(const[e,t]of r){const{uri:i}=t,a=this.rtpHeaderExt[i];void 0!==a&&(l[a]=e)}m+=l.join(",")+",",n.forEach((e=>{const{codecName:t,codecParams:i,payloadType:a,associatedPayloadType:s=""}=e;"H264"===t&&i?"1"===i.get("packetization-mode")&&(h.push(a),h.push(i.get("profile-level-id")),h.push(i.get("max-mbps")||""),h.push(i.get("max-fs")||""),h.push(i.get("x-google-start-bitrate")||""),h.push(i.get("x-google-max-bitrate")||""),h.push(i.get("x-google-min-bitrate")||""),h.push(i.get("x-google-per-layer-pli")||"")):"rtx"===t&&(u[s]=a)}));for(let e=0,t=h.length;e<t;e+=8){const t=h[e];m+="".concat(t,",").concat(h[e+1],",").concat(h[e+2],",").concat(h[e+3],",").concat(h[e+4],",").concat(h[e+5],",").concat(h[e+6],",").concat(h[e+7],",").concat(u[t],",")}return d.forEach((e=>{let{semantics:t,ssrcs:i}=e;"FID"===t&&(m+="".concat(i.join(","),","))})),m+="".concat(o||"",","),c&&c.length>0&&c.forEach((e=>{let{transport:t,address:i,port:a,priority:s}=e;m+="".concat(s,",").concat("udp"===t?0:1,",").concat(i,",").concat(a,",")})),m}handleStatsReport(e){var t;const i={},a={};let s,n="",r="";var o,c;if(e.forEach((e=>{Oe.getSendStatsMonitor().onStatsReport(e),Oe.getRecvStatsMonitor().onStatsReport(e);const{kind:t,type:s}=e,o="".concat(t?t+"-":"").concat(s),c="begin-".concat(o),d="prev-".concat(o);if("candidate-pair"===s){const{id:t}=e;i[t]=e,r+=this._getCandidatePairLog(e)}else if("remote-candidate"===s||"local-candidate"===s){const{id:t}=e;a[t]=e,n+=this._getCandidateLog(e)}else if("codec"===s){const{id:t,mimeType:i}=e;"video/H264"===i&&(this.pcStats[o]||(this.pcStats[o]={}),this.pcStats[o][t]=e)}else if("video"!==t||"inbound-rtp"!==s&&"remote-outbound-rtp"!==s&&"outbound-rtp"!==s&&"remote-inbound-rtp"!==s)"video"===t&&"media-source"===s?(this.pcStats[d]=this.pcStats[o],this.pcStats[o]=e,this.pcStats[c]||(this.pcStats[c]=e)):this.pcStats[o]=e;else{const{ssrc:t}=e;this.pcStats[o]||(this.pcStats[o]={}),this.pcStats[d]||(this.pcStats[d]={}),this.pcStats[d][t]=this.pcStats[o][t],this.pcStats[o][t]=e,this.pcStats[c]&&this.pcStats[c][t]||(this.pcStats[c]=bt(bt({},this.pcStats[c]),{},{[t]:e}))}})),"connected"===(null===(t=this.pcStats.transport)||void 0===t?void 0:t.dtlsState)?s=i[this.pcStats.transport.selectedCandidatePairId]:(s=Object.values(i).find((e=>e.selected&&"succeeded"===e.state)),s&&(s.currentRoundTripTime=(null!==(o=null===(c=this.qosReport)||void 0===c||null===(c=c.uplink)||void 0===c?void 0:c.rtt)&&void 0!==o?o:0)/1e3)),s){var d,l,h,u,m,p,g,S;null!==(l=(d=s).availableOutgoingBitrate)&&void 0!==l||(d.availableOutgoingBitrate=1e3*(null!==(h=null===(u=this.qosReport)||void 0===u||null===(u=u.uplink)||void 0===u?void 0:u.bw)&&void 0!==h?h:0)),null!==(p=(m=s).availableIncomingBitrate)&&void 0!==p||(m.availableIncomingBitrate=1e3*(null!==(g=null===(S=this.qosReport)||void 0===S||null===(S=S.downlink)||void 0===S?void 0:S.bw)&&void 0!==g?g:0));const{localCandidateId:e,remoteCandidateId:t}=s;this.pcStats["remote-candidate"]=a[t],this.pcStats["local-candidate"]=a[e],this.pcStats["prev-candidate-pair"]=this.pcStats["candidate-pair"],this.pcStats["candidate-pair"]=s,this.pcStats["begin-candidate-pair"]||(this.pcStats["begin-candidate-pair"]=s)}this.candidateLog!==n&&(te.directSendMonitorLog("WMSC_CANDIDATE: ".concat(n)),this.candidateLog=n),this.candidatePairLog=r;const{currentRoundTripTime:_}=this.pcStats["candidate-pair"]||{},{maxRtt:v=0}=this.pcStats.statisticData;_&&(this.pcStats.statisticData.maxRtt=Math.max(_,v)),this._generateSenderStatisticData(),this._generateReceiverStatisticData(e),this._uploadRawRTPInboundStats(3),this.mIdMgr.onStatsReport(this.pcStats)}_uploadRawRTPInboundStats(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:30,t=1,i="";for(const a in this.rawRTPInboundStats){if(t>e)break;this.rawRTPInboundStats[a]&&(i+=(i?"|":"")+this.rawRTPInboundStats[a]),delete this.rawRTPInboundStats[a],t++,i.length>1500&&(te.directSendMonitorLog("WMSC_RTP_INBOUND,"+i),i="")}i&&te.directSendMonitorLog("WMSC_RTP_INBOUND,"+i)}};var Bt=i(7007);class Ut extends Bt.EventEmitter{constructor(e,t){super(),this.codecs=[],this.type=e,this.rtpTransceiver=t}stop(){this.rtpTransceiver.direction="inactive",this.emit(He.f7.NegotiationNeeded)}get transceiver(){return this.rtpTransceiver}get sender(){return this.rtpTransceiver.sender}getCodecs(){return this.codecs}setCodecs(e){this._setCodecs(e),this.emit(He.f7.CodecsChange,e)}_setCodecs(e){this.codecs=e}publishTrack(e){return t=this,i=void 0,s=function*(){return this.sender.replaceTrack(e||null)},new((a=void 0)||(a=Promise))((function(e,n){function r(e){try{c(s.next(e))}catch(e){n(e)}}function o(e){try{c(s.throw(e))}catch(e){n(e)}}function c(t){var i;t.done?e(t.value):(i=t.value,i instanceof a?i:new a((function(e){e(i)}))).then(r,o)}c((s=s.apply(t,i||[])).next())}));var t,i,a,s}}class xt extends Bt.EventEmitter{constructor(e,t){super(),this.codecs=[],this.type=e,this.rtpTransceiver=t}stop(){this.rtpTransceiver.stop(),this.emit(He.f7.NegotiationNeeded)}get transceiver(){return this.rtpTransceiver}get receiver(){return this.rtpTransceiver.receiver}getCodecs(){return this.codecs}setCodecs(e){this._setCodecs(e),this.emit(He.f7.CodecsChange,e)}_setCodecs(e){this.codecs=e}}var Ft=function(e,t,i,a){return new(i||(i=Promise))((function(s,n){function r(e){try{c(a.next(e))}catch(e){n(e)}}function o(e){try{c(a.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,o)}c((a=a.apply(e,t||[])).next())}))};class Wt extends Bt.EventEmitter{constructor(e){super(),this.sendTransceivers=new Map,this.recvTransceivers=new Map,this.nextMid=0,this.mids=new Map,this.mediaSourceId2Mid=new Map,this.localId2Mid=new Map,this.pendingTransceivers=[],this.mainEgressStreamId=le.generateUuid(),this.shareEgressStreamId=le.generateUuid(),this.config=Object.assign(Object.assign({},e),{bundlePolicy:"max-bundle"}),this.pc=pt.A.createPeerConnection(this.config),this.setupEventListeners(),this.startPollingStats()}createDataChannel(e,t){return this.pc.createDataChannel(e,t)}createSendTransceiver(e,t){const i=(0,He.xv)(e),a=this.pc.addTransceiver(i,Object.assign({direction:"sendonly"},t)),s=new Ut(e,a);return s.on(He.f7.CodecsChange,(e=>this.onCodecsChange(s.mid,e))),s.on(He.f7.NegotiationNeeded,(()=>this.onNegotiationNeeded())),this.pendingTransceivers.push(s),s}createRecvTransceiver(e){const t=(0,He.xv)(e),i=this.pc.addTransceiver(t,{direction:"recvonly"}),a=new xt(e,i);return a.on(He.f7.CodecsChange,(e=>this.onCodecsChange(a.mid,e))),a.on(He.f7.NegotiationNeeded,(()=>this.onNegotiationNeeded())),this.pendingTransceivers.push(a),a}getSendTransceiverByMid(e){return this.sendTransceivers.get(e)}getRecvTransceiverByMid(e){return this.recvTransceivers.get(e)}createOffer(e){return Ft(this,void 0,void 0,(function*(){this.mids.clear();const t=yield this.pc.createOffer(e),i=le.parseSdp(t.sdp);return i.media.forEach(((e,t)=>{const{mid:i}=e;this.mids.set(i,t)})),this.offer=i,this.offer}))}setOffer(e){return Ft(this,void 0,void 0,(function*(){if(!this.offer)throw new Error("Call createOffer() first.");let t;e?(this.offer=le.parseSdp(e),t=e):t=le.writeSdp(this.offer),yield this.pc.setLocalDescription({type:"offer",sdp:t}),this.pendingTransceivers=this.pendingTransceivers.filter((e=>{const{mid:t,direction:i}=e.transceiver;return!t||(e.mid=t,"sendonly"===i?this.sendTransceivers.set(t,e):"recvonly"===i&&this.recvTransceivers.set(t,e),!1)}))}))}setAnswer(e){return Ft(this,void 0,void 0,(function*(){if(!e&&!this.answer)throw new Error("Answer is required for the first time negotiation");let t;return e?(this.answer=le.parseSdp(e),t=e):t=le.writeSdp(this.answer),this.pc.setRemoteDescription({type:"answer",sdp:t})}))}close(){var e;clearTimeout(this.statsTimeoutId),null===(e=this.pc)||void 0===e||e.close(),this.removeAllListeners()}getStats(e){return this.pc.getStats(e)}setupEventListeners(){this.pc.ontrack=e=>{this.emit(He.f7.Track,e);const t=this.recvTransceivers.get(e.transceiver.mid);t&&t.emit(He.f7.Track,e.track)},this.pc.onsignalingstatechange=()=>{this.emit(He.f7.SignalingStateChange,this.pc.signalingState)},this.pc.oniceconnectionstatechange=()=>{this.emit(He.f7.IceConnectionStateChange,this.pc.iceConnectionState)},this.pc.onconnectionstatechange=()=>{const e=this.pc.connectionState;this.emit(He.f7.ConnectionStateChange,e)},this.pc.onicegatheringstatechange=()=>{this.emit(He.f7.IceGatheringStateChange,this.pc.iceGatheringState)},this.pc.onicecandidateerror=e=>{this.emit(He.f7.IceCandidateError,e)}}addMidNum(){return this.nextMid++}startPollingStats(){return Ft(this,void 0,void 0,(function*(){try{const e=yield this.pc.getStats();this.dispatchStats(e)}catch(e){console.error("Dispatch stats error",e)}this.statsTimeoutId=window.setTimeout((()=>{this.startPollingStats()}),He.Mr)}))}dispatchStats(e){this.emit(He.f7.StatsReport,e)}onCodecsChange(e,t){return Ft(this,void 0,void 0,(function*(){this.offer.media.forEach((i=>{i.mid===e&&(i.codecs=t)})),yield this.setLocalOfferAnswer()}))}setLocalOfferAnswer(){return Ft(this,void 0,void 0,(function*(){if(this.offer){const e=le.writeSdp(this.offer);yield this.pc.setLocalDescription({type:"offer",sdp:e})}if(this.answer){const e=le.writeSdp(this.answer);yield this.pc.setLocalDescription({type:"answer",sdp:e})}}))}onNegotiationNeeded(){}removeUnusedTransceiver(){if(this.answer){const e=new Array(this.mids.size);this.answer.media.forEach((t=>{const{mid:i}=t,a=this.mids.get(i);void 0!==a&&(e[a]=t)})),this.answer.media=e,this.answer.session.groups[0].ids=[...this.offer.session.groups[0].ids]}}addMLineSDPToAnswer(e,t){const i=this.mids.get(e);void 0!==i&&(this.answer.media[i]=t)}removeMLineSDPFromAnswer(e){const t=this.mids.get(e);if(void 0!==t){const i=this.answer.media[t],{type:a,connection:s,protocol:n}=i;this.answer.media[t]={type:a,connection:s,protocol:n,mid:e,direction:"inactive",port:0,formats:[0],otherLines:[],extensionMap:new Map,codecs:[]},this.recvTransceivers.get(e)?this.recvTransceivers.delete(e):this.sendTransceivers.get(e)&&this.sendTransceivers.delete(e)}}get connectionState(){return this.pc.connectionState}getOffer(){return this.offer}getAnswer(){return this.answer}updateOfferIceCredential(e){this.offer&&le.updateIceCredential(this.offer,e)}updateAnswerIceCredential(e){this.answer&&le.updateIceCredential(this.answer,e)}get currentRemoteDescription(){return this.pc.currentRemoteDescription}setConfiguration(e){this.config=Object.assign(Object.assign({},this.config),e),this.pc.setConfiguration(this.config)}get signalingState(){return this.pc.signalingState}}var zt=i(4543),jt=i(2689),Gt=i(559),Ht=i(5738),Qt=i(9338),qt=i(242),Yt=i(9482),Kt=(i(9373),i(3656)),Jt=i(5803),Xt=i(5837),Zt=i(3011);function $t(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,a)}return i}function ei(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?$t(Object(i),!0).forEach((function(t){(0,c.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):$t(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class ti{constructor(e){let{mIdMgr:t,signalSendSink:i,messageCallback:a,userId:s}=e;this._mIdMgr=t,this._WMSCsignalSendSink=i,this._messageCallback=a,this._wmscPC=null,this._wmscMainAudioTransceiver=null,this._wmscShareAudioTransceiver=null,this._hasTwccExtension=!1,this._initialized=!1,this._isDestroyed=!1,this._webRTCWorkletManager=null,this._useWebRTCOnDesktop=!1,this._isRecvOnly=!1,this._audioStream=null,this._audioStreamCloning=null,this._shareAudioStream=null,this._recvMLineTemp=null,this._isMutedBySystem=!1,this._cleanUserEventFn=null,this._codecDoAVSync=!1,this._AVsyncTimer=null,this._nodeId2NTPDescriptionMap=new Map,this._shareNodeId2NTPDescriptionMap=new Map,this._audioProfile=yt.yu,this._isMuted=!1,this._audioMode=yt.DY,this._audioPlayerManager=new Xt.A({triggerPlayerHealthCheck:this.triggerPlayerHealthCheck.bind(this),isMlineCurrentSessionByMid:e=>{var t;return(null===(t=this._mIdMgr)||void 0===t?void 0:t.isMlineCurrentSessionByMid(e))||!1},customPauseCallback:()=>{var e;(0,ft.PV)("RTCAudioPlayer on paused, document visibility=".concat(document.visibilityState)),null===(e=this._healthChecker)||void 0===e||e.checkAllPlayersHealth(this._wmscPC,!0,yt.vr.PLAYER_ON_PAUSE)},customStreamValidCallback:()=>{var e;null===(e=this._healthChecker)||void 0===e||e.checkAllPlayersHealth(this._wmscPC,!1,yt.vr.STREAM_VALID)}}),this._recoverPlay1STimeout=null,this._showUplinkQosOnDashboard=!1,this._showDownlinkQosOnDashboard=!1,this._healthChecker=new Jt.A({getAudioMode:()=>this.getAudioMode(),isMuted:()=>this.isMuted,isMutedBySystem:()=>this.isMutedBySystem,getAudioStream:()=>this.getAudioStream(),doingDenoise:()=>this.doingDenoise,isAudioPlayerError:()=>this.isAudioPlayerError,checkAudioPlayerErrorInfo:()=>this.checkAudioPlayerErrorInfo(),checkAllPlayers:(e,t,i,a)=>this.checkAllPlayers(e,t,i,a),onAudioEnergySentCheckResult:this._onAudioEnergySentCheckResult.bind(this),onPacketSentCheckResult:this._onPacketSentCheckResult.bind(this),onAudioEnergyReceivedCheckResult:this._onAudioEnergyReceivedCheckResult.bind(this)}),this._wmscAudioMonitor=new Tt({wmscAudio:this,userId:s,onBadNetwork:this._onBadNetworkDetected.bind(this),onHealthCheck:this._healthChecker.onCheck,onAudioPlayerErrorCheck:this._healthChecker.onAudioPlayerErrorCheck,onMonitorLog:this._onRequestReportMonitorLog.bind(this)}),document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState&&this.triggerPlayerHealthCheck(yt.vr.VISIBILITY_CHANGE)})),this.clearAllRemoteAudioPlayer(),this._interpretationEnable=!1,this._interpretationList=[],this._userLangMap=new Map,this._interpretationMuted=!1,this._interpretationCurrentLang=yt.jw,this._interpreterSpeakingStatus=yt.g3,this._inboundSourceVADBind=this.inboundSourceVAD.bind(this),this.normal_ssrc=null,this.share_ssrc=null,this.nodeId=this._convertUserId2NodeId(s)}get audioPlayerMap(){var e;return(null===(e=this._audioPlayerManager)||void 0===e?void 0:e.getAllRemoteAudioPlayers())||new Map}get isMutedBySystem(){return this._isMutedBySystem}set isMutedBySystem(e){this._webRTCWorkletManager&&(this._webRTCWorkletManager.isMutedBySystem=e),this._isMutedBySystem=e}get isMuted(){return this._isMuted}get isAudioPlayerError(){var e;return(null===(e=this._audioPlayerManager)||void 0===e?void 0:e.isAudioPlayerError)||!1}set isAudioPlayerError(e){this._audioPlayerManager&&(this._audioPlayerManager.isAudioPlayerError=!!e)}get audioSpeakerSetErrorCnt(){var e;return(null===(e=this._audioPlayerManager)||void 0===e?void 0:e.audioSpeakerSetErrorCnt)||0}set audioSpeakerSetErrorCnt(e){this._audioPlayerManager&&(this._audioPlayerManager.audioSpeakerSetErrorCnt=e)}get doingDenoise(){var e;return null===(e=this._webRTCWorkletManager)||void 0===e?void 0:e.doingDenoise}get webRTCWorkletManager(){return this._webRTCWorkletManager}initconfig(e){let{workletPath:t,recvOnly:i,codecDoAVSync:a,useWebRTCOnDesktop:s}=e;this._initialized||(this._initialized=!0,t&&(this._webRTCWorkletManager=new Qt.v(this.setNormalAudioStream.bind(this),t)),this._isRecvOnly=!!i,this._codecDoAVSync=!!a,this._useWebRTCOnDesktop=s)}getUplinkMidOrSSRC2MediaType(e,t){var i;return!e&&t&&(e=null===(i=this._mIdMgr)||void 0===i?void 0:i.getMidBySsrc(t)),e==this._wmscMainAudioTransceiver.mid?He.zu.MainAudio:e==this._wmscShareAudioTransceiver.mid?He.zu.ShareAudio:null}triggerPlayerHealthCheck(e){var t;this._isMutedBySystem||this._audioMode&&(null===(t=this._healthChecker)||void 0===t||t.checkAllPlayersHealth(this._wmscPC,!1,e))}_checkNeedPlayAllPlayerLater(e){this.triggerPlayerHealthCheck(e)}async join(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:yt.DY;if(i===yt.qR)try{var a,s,n;if(!this._cleanUserEventFn){const e=zt.A.on(Gt.gh2.USER_EVENT,(()=>{this.triggerPlayerHealthCheck(yt.vr.USER_CLICK)}));this._cleanUserEventFn=()=>zt.A.unsubscribe(e)}null===(a=this._webRTCWorkletManager)||void 0===a||a.createWebRTCWorklet(),null===(s=this._webRTCWorkletManager)||void 0===s||s.changeAudioStatus(!1,!1),null===(n=this._webRTCWorkletManager)||void 0===n||n.startCheckProcess()}catch(e){(0,ft.py)("Error when creating webRTCWorklet",e)}var r;this._audioMode=this._audioMode|i,i!=yt.DY&&(this.notifyRWGSSRC(this.normal_ssrc,this.share_ssrc),this._startAVSyncTimer(),this._wmscAudioMonitor.startMonitor(this._wmscPC)),i===yt.qR&&(null===(r=this._audioPlayerManager)||void 0===r||r.unmuteAllRemoteAudio())}async onPCCreated(e){(0,ft.U1)("onPCCreated oldWMSCPC=",this._wmscPC,"wmscPc=",e),this._audioMode&&this._startAVSyncTimer(),this._wmscPC&&(this._wmscAudioMonitor.resetWMSCPC(this._wmscPC,e),this._wmscPC=null,(0,ft.U1)("onPCCreated cleared old one")),this._wmscPC=e,this._preserveMlineOnPCCreated(e)}setUserId(e){this.nodeId=this._convertUserId2NodeId(e),this._wmscAudioMonitor.setUserId(e)}addRecvTransceiver(e,t,i,a,s){return(0,ft.U1)("addRecvTransceiver , ".concat(e,", nodeId=").concat(t,", webrtcSSRC=").concat(i,", msid=").concat(a,", isCurrentSession=").concat(s)),this._wmscPC.createRecvTransceiver(e)}saveRecvMLineTemp(){var e;const t=null===(e=this._wmscPC)||void 0===e?void 0:e.answer.media.find((e=>{if(!e)return!1;const{type:t,direction:i}=e;return"audio"===t&&"sendonly"===i}));this._recvMLineTemp=ei({},t)}updateRecvMLineTemp(e){const{ice_pwd:t,ice_ufrag:i}=e;this._recvMLineTemp&&(this._recvMLineTemp.icePwd=t,this._recvMLineTemp.iceUfrag=i)}addRecvAudioSDP(e){const{transceiver:t,msid:i,mediaType:a,ssrcs:s={},user_id:n}=e,{rtp:r}=s,{mid:o}=t,c=r||le.generateSsrc(),d=i||le.generateUuid(),l=le.generateUuid(),h=ei({},this._recvMLineTemp);return h.mid=o,h.msid={streamId:d,trackId:l},h.ssrcs=[{ssrc:c,attribute:"cname:".concat(d)},{ssrc:c,attribute:"msid:".concat(d," ").concat(l)}],this._wmscPC.addMLineSDPToAnswer(o,h),(0,ft.U1)("addRecvAudioSDP mid=",o,"mLine=",h),{mid:o,media_type:a,msid:d,ssrcs:{rtp:c},user_id:n}}onRemoteStream(e,t,i,a){var s;const n=this._convertUserId2NodeId(a);(0,ft.U1)("onRemoteStream, mid=".concat(i,", mediaStream.id=").concat(e.id,", nodeId=").concat(null!=n?n:"",", audioPlayerManager map"),null===(s=this._audioPlayerManager)||void 0===s?void 0:s.getAllRemoteAudioPlayers()),this._audioPlayerManager.updateAudioTrackSet(t.id),t.onunmute=t=>this._onDownlinkTrackUnmute(e,i,n)}handleLocalOffer(e){(0,ft.U1)("handleLocalOffer , parsedOffer=".concat(e)),this.normal_ssrc=le.getSSRCByMid(e,this._wmscMainAudioTransceiver.mid),this.share_ssrc=le.getSSRCByMid(e,this._wmscShareAudioTransceiver.mid),(0,ft.U1)("handleLocalOffer , normal_ssrc=".concat(this.normal_ssrc,", share_ssrc=").concat(this.share_ssrc)),this.notifyRWGSSRC(this.normal_ssrc,this.share_ssrc)}notifyRWGSSRC(e,t){e&&t&&jt.A.sendMessageToRwg(Gt.yJV,{evt:ut,body:{normal_ssrc:e,share_ssrc:t}})}getUpdatedMlineFtmpFromLocalOffer(){var e;const t=le.getMlineCodecFromLocalOffer(this._wmscPC.getOffer(),this._wmscMainAudioTransceiver.mid,"opus");let i="";t.codecParams.forEach(((e,t)=>{null!=e&&(i+="".concat(t,"=").concat(e,";"))}));const a=null===(e=this._wmscPC.getOffer())||void 0===e||null===(e=e.media)||void 0===e||null===(e=e.find((e=>e.mid===this._wmscMainAudioTransceiver.mid)))||void 0===e||null===(e=e.msid)||void 0===e?void 0:e.streamId;return{media_type:He.zu.MainAudio,mid:this._wmscMainAudioTransceiver.mid,msid:a||"-",codec:[{rtp_payload_type:t.payloadType,fmtp:i}]}}mungeLocalOffer(e){this._updateCodec(e),this._hasTwccExtension=e.media.some((e=>"audio"===e.type&&"sendonly"===e.direction&&-1!==le.findHeaderExtensionByUri(e,"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"))),this._updateQosAudioBandwidth()}mungeAnswer(e){this._updateCodec(e,!1)}onRWGCMDQos(e){var t,i;const a=this._wmscAudioMonitor.getBitrateInfo(),s=ei(ei({},e.uplink),{},{sample_rate:48,rate:null===(t=a.publisher)||void 0===t?void 0:t.bitrate,encoding:!0}),n=ei(ei({},e.downlink),{},{sample_rate:48,rate:null===(i=a.subscriber)||void 0===i?void 0:i.bitrate,encoding:!1});this._audioMode!=yt.DY&&(this._wmscAudioMonitor.setAudioStatisticsFromRWG(s),this._wmscAudioMonitor.setAudioStatisticsFromRWG(n)),this._showUplinkQosOnDashboard&&this.notifyUIMessage(Gt.iQY,s),this._showDownlinkQosOnDashboard&&this.notifyUIMessage(Gt.iQY,n)}onRWGCMDRtcpSR(e){let{ntptime:t,rtptime:i,ssrc:a,abssrc:s}=e;512&a?this._shareNodeId2NTPDescriptionMap.set(this._convertUserId2NodeId(a),{ntptime:t,rtptime:i,abssrc:s,ssrc:a}):this._nodeId2NTPDescriptionMap.set(this._convertUserId2NodeId(a),{ntptime:t,rtptime:i,abssrc:s,ssrc:a})}onMlineAssignedNodeId(e,t,i,a,s){if(!this._audioPlayerManager)return;if(!i)return(0,ft.py)("onMlineAssignedNodeId nodeId error, ".concat(e,", mid=").concat(t,", nodeId=").concat(i,", webrtcSSRC=").concat(a,", isCurrentSession=").concat(s));let n;e==He.zu.MainAudio&&(n=this._audioPlayerManager.getSpeechVolume(i));let r="onMlineAssignedNodeId , ".concat(e,", mid=").concat(t,", nodeId=").concat(i,", webrtcSSRC=").concat(a,", isCurrentSession=").concat(s,", volume=").concat(null!=n?n:100);(0,ft.U1)(r),(0,ft.PV)(r),(0,ft.lo)("REVT:".concat(t,"-").concat(i,"-").concat(a,"-").concat(s?1:0,"-").concat(null!=n?n:100));const o=this._audioPlayerManager.getRemoteRTCAudioPlayer(t);o?(o.onAssignedNodeId(e,i,s,a),void 0!==n&&o.setVolume(n),this._audioPlayerManager.stopIncomingAudioFlag&&o.mute(),this._checkNeedPlayAllPlayerLater(yt.vr.ASSIGNED_NODE_ID)):(r+=" cannot find RTCAudioPlayer at present",(0,ft.PV)(r)),e==He.zu.ShareAudio&&this._audioPlayerManager.updateAllShareVolume(),this.updateUserLang(i,this._userLangMap[i>>10]),this.interpretation_set_list(this._interpretationList),this.interpretation_set_lang(this._interpretationCurrentLang)}onMlineRemoved(e){this._audioPlayerManager&&((0,ft.U1)("onMlineRemoved mid=".concat(e)),this._audioPlayerManager.getRemoteRTCAudioPlayer(e)&&((0,ft.lo)("REVTM:".concat(e)),this._audioPlayerManager.removeRemoteRTCAudioPlayer(e),(0,ft.U1)("onMlineRemoved mid=".concat(e," done"))))}_onBadNetworkDetected(e){let{isUplink:t,networkLevel:i,bwLevel:a}=e;this._audioMode==yt.qR&&this._audioStream&&jt.A.Notify_APPUI_SAFE(Gt.Joy,{isUplink:t,networkLevel:i,bwLevel:a})}_onRequestReportMonitorLog(e){jt.A.sendMessageToRwg(Gt.yGo,{evt:Gt.UFw,seq:1,body:{data:e}})}_onDownlinkTrackUnmute(e,t,i){var a;if(!this._audioPlayerManager)return;i||(i=this._convertUserId2NodeId(this._mIdMgr.getUserIdByMid(t)));let s=this._audioPlayerManager.getRemoteRTCAudioPlayer(t);if(s)s.setStream(e);else{let a,n;i&&(a=this._mIdMgr.isMlineCurrentSessionByMid(t),n=this._mIdMgr.getMediaTypeByMid(t),(0,ft.U1)("_onDownlinkTrackUnmute, nodeId known, ".concat(n," mid=").concat(t,", nodeId=").concat(i,", isCurrentSession=").concat(a))),s=this._audioPlayerManager.createRemoteRTCAudioPlayer(t,{mediaStream:e,speakerId:qt.A.pendingSpeakerId||qt.A.speakerId,mediaType:null!=n?n:He.zu.MainAudio,nodeId:i,mid:t,isCurrentSession:a,streamValid:!1,isReceivingPacketFunc:this.isReceivingPacketByMid.bind(this)}),(0,ft.U1)("_onDownlinkTrackUnmute, mid=",t,",audioPlayerManager map =",this._audioPlayerManager.getAllRemoteAudioPlayers())}null===(a=this._healthChecker)||void 0===a||a.checkAllPlayersHealth(this._wmscPC,!0,yt.vr.NEW_STREAM,!0),this._isDestroyed&&s.mute(),(0,ft.lo)("REVTP:".concat(t,"-").concat(null!=i?i:""))}_wmscSignalSend(e){return!!this._WMSCsignalSendSink&&this._WMSCsignalSendSink(e)}notifyUIMessage(e,t){var i;null===(i=jt.A.Notify_APPUI)||void 0===i||i.call(jt.A,e,t)}async enableShareToBO(e){return this.notifyUIMessage(Gt.CcD,{enable:e})}async enableBroadCastToBO(e){return this.notifyUIMessage(Gt.g9q,{enable:e})}leaveAudioWithoutDisconnect(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:yt.DY;var t,i;this._audioMode=this._audioMode&~e,e===yt.qR?(this.setNormalAudioStream(null),this._audioPlayerManager&&(this._audioPlayerManager.muteAllRemoteAudio(),this._audioPlayerManager.reset()),this._cleanUserEventFn&&(this._cleanUserEventFn(),this._cleanUserEventFn=null),this._isMuted=!1,null===(t=this._webRTCWorkletManager)||void 0===t||t.changeAudioStatus(!1,!0),null===(i=this._webRTCWorkletManager)||void 0===i||i.stopCheckProcess(),this._wmscAudioMonitor.sendAudioMos(!0)):e===yt.$t&&this.setShareAudioStream(null),this._audioMode===yt.DY&&(this._wmscAudioMonitor.stopMonitor(this._wmscPC),this._stopAVSyncTimer())}_preserveMlineOnPCCreated(e){this._wmscMainAudioTransceiver=e.createSendTransceiver(He.zu.MainAudio),this._wmscShareAudioTransceiver=e.createSendTransceiver(He.zu.ShareAudio),e.createRecvTransceiver(He.zu.MainAudio),e.createRecvTransceiver(He.zu.MainAudio),e.createRecvTransceiver(He.zu.MainAudio)}_getAudioCodecParams(e){return yt.gC[e]}_updateCodec(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._wmscMainAudioTransceiver.mid,a=this._wmscShareAudioTransceiver.mid;const s=t?"sendonly":"recvonly",n=e.media.filter((e=>"audio"===e.type&&e.direction===s));if(!i){const e=n.reduce(((e,t)=>parseInt(t.mid)<parseInt(e.mid)?t:e));i=e.mid}a||(a=n.filter((e=>e.mid!==i)).reduce(((e,t)=>parseInt(t.mid)<parseInt(e.mid)?t:e)).mid),le.updateCodecParametersByMid(e,i,"opus",this._getAudioCodecParams(this._audioProfile)),le.updateCodecParametersByMid(e,a,"opus",this._getAudioCodecParams(yt.x_)),(0,de.GN)()||le.updateCodecParameters(e,"audio",t?"recvonly":"sendonly","opus",this._getAudioCodecParams(yt.fo)),t&&(le.updateStreamIdByMid(e,i,this._wmscPC.mainEgressStreamId),le.updateStreamIdByMid(e,a,this._wmscPC.shareEgressStreamId))}setRecvOnly(e,t){this._isRecvOnly=!!e,this._isRecvOnly?this.setNormalAudioStream(null):t&&this.setNormalAudioStream(t)}setCodecDoAVSync(e){this._codecDoAVSync=!!e}getFinalSentAudioStream(){return this._webRTCWorkletManager&&this._webRTCWorkletManager.doingDenoise&&this._webRTCWorkletManager.getAudioStream()||this._audioStream}async setNormalAudioStream(e){let t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];arguments.length>1&&void 0!==arguments[1]&&arguments[1]||(this._isRecvOnly?this._audioStream=null:t||(this._audioStream=e)),this.resetAudioTrackState(this._audioStream),t&&(this._audioStream=e),this.setAudioStreamCloning(this._audioStream),this._webRTCWorkletManager&&(this._webRTCWorkletManager.doingDenoise?this._webRTCWorkletManager.setAudioStream(this._audioStream):this._webRTCWorkletManager.setAudioStream(this._audioStreamCloning||this._audioStream));let i=e;i=this.getFinalSentAudioStream(),i&&(this._isMuted?this.mute():this.unmute()),await this.publishAudioStream(i,this._wmscMainAudioTransceiver,"PAT")}async setShareAudioStream(e){this._shareAudioStream=e,await this.publishAudioStream(this._shareAudioStream,this._wmscShareAudioTransceiver,"PAST")}async publishAudioStream(e,t,i){if(!this._isDestroyed)if(t)if(e){let a=[];e.getAudioTracks().forEach((e=>{(0,ft.PV)("publish track label: "+e.label),(0,ft.lo)("".concat(i,"-").concat(e.id)),a.push(t.publishTrack(e).catch((t=>{(0,ft.lo)("".concat(i,"-Failed-").concat(e.id)),(0,ft.py)("error publishing audio stream",t)})))})),await Promise.all(a)}else await t.publishTrack(null),(0,ft.lo)("".concat(i,"-null"));else(0,ft.lo)(i+"SE ")}mute(){this._isMuted=!0;let e=this.getFinalSentAudioStream();var t;e&&((0,ft.lo)("SEVTP"),e.getAudioTracks().forEach((e=>{e.enabled=!1})),null===(t=this._webRTCWorkletManager)||void 0===t||t.changeAudioStatus(!0,!1))}unmute(){this._isMuted=!1;let e=this.getFinalSentAudioStream();var t;e&&((0,ft.lo)("SEVTM"),e.getAudioTracks().forEach((e=>{e.enabled=!0})),null===(t=this._webRTCWorkletManager)||void 0===t||t.changeAudioStatus(!1,!1))}recoverACOnInterruptedOniOS(){this._webRTCWorkletManager&&this._webRTCWorkletManager.resumeAudioCtx(!0)}stopIncomingAudio(e){this._audioPlayerManager&&this._audioPlayerManager.stopIncomingAudio(e)}muteAllRemoteAudio(){this._audioPlayerManager&&this._audioPlayerManager.muteAllRemoteAudio()}unmuteAllRemoteAudio(){this._audioPlayerManager&&this._audioPlayerManager.unmuteAllRemoteAudio()}setAudioStreamCloning(e){this.destroyAudioStream(this._audioStreamCloning),this._audioStreamCloning=null;try{if(!e)return;if(this._webRTCWorkletManager&&!this._webRTCWorkletManager.doingDenoise&&jt.A.enableCloneAudioStream){this._audioStreamCloning=e.clone();let t=this._audioStreamCloning.getAudioTracks()[0];t&&((0,ft.lo)("CATRS:"+t.readyState+":"+t.id),(0,ft.lo)("CATMS:"+t.muted+":"+t.id),(0,ft.lo)("CATES:"+t.enabled+":"+t.id))}}catch(e){(0,ft.py)("Error when cloning audio stream, ",e)}}destroyAudioStream(e){e&&e.getTracks().forEach((e=>{e.stop()}))}setSpeechVolumeLevel(e,t){if(!this._audioPlayerManager)return;const i=this._convertUserId2NodeId(e);(0,ft.U1)("setSpeechVolumeLevel nodeId=".concat(i,", volume=").concat(t)),this._audioPlayerManager.setSpeechVolumeLevel(i,t,!1)}async changeSpeaker(e){this._audioPlayerManager&&await this._audioPlayerManager.changeSpeaker(e)}setShareVolumeLevel(e,t,i){let a=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];if(!this._audioPlayerManager)return;const s=e<<10;(0,ft.U1)("setShareVolumeLevel, userId=".concat(e,", nodeId=").concat(s,", volume=").concat(t,", isFromMainSession=").concat(i)),this._audioPlayerManager.setShareVolumeLevel(s,t,i,a,!1)}set_CC_lang(e){this.nodeId?((0,ft.PV)("set_CC_lang, lang=".concat(e)),jt.A.sendMessageToRwg(Gt.yJV,{evt:Gt.pWm,body:{type:Gt.hEQ.SELECT_TRANSLATION_LANGUAGE,lang:e,nodeid:this.nodeId}}),this.notifyUIMessage(Gt.V5N,e)):(0,ft.py)("Invalid parameters for setting CC lang: nodeId=".concat(this.nodeId))}updateUserMuteUnmuteStatus(e){this._audioPlayerManager&&this._audioPlayerManager.updateUserMuteUnmuteStatus(e)}isUserMuted(e,t){if(!this._audioPlayerManager)return!1;if(this._mIdMgr.getMediaTypeBySsrc(t)!==He.zu.MainAudio)return!1;const i=this._convertUserId2NodeId(e);return this._audioPlayerManager.isNodeIdMuted(i)}async setAudioProfile(e){if(this._audioMode!==yt.qR&&this._audioMode!=yt.$2)return;let t=this._audioProfile;"backgroundNoiseSuppression"===e.currentSelect?(e.highBitrate?this._audioProfile=yt.$A:this._audioProfile=yt.yu,Zt.A.enableDenoise("Zoom"===e.backgroundNoiseSuppression)):(Zt.A.enableDenoise(!1),e.originalSound.highfidelity&&e.originalSound.stereo?this._audioProfile=yt.IA:e.originalSound.highfidelity?this._audioProfile=yt.hc:e.originalSound.stereo?this._audioProfile=yt.Hc:this._audioProfile=yt.ej),t!==this._audioProfile&&(this._messageCallback("requestSelfRenegotiation",He.zu.MainAudio),jt.A.sendMessageToRwg(Gt.yJV,{evt:ht,body:{audioProfile:this._audioProfile}}))}resetAudioTrackState(e){e&&e.getAudioTracks().forEach((e=>{e.enabled=!0}))}getAudioBandwidth(){let e=0;return this._wmscMainAudioTransceiver&&this._hasTwccExtension&&(e+=yt.gC[this._audioProfile].get("maxaveragebitrate")+28800),this._wmscShareAudioTransceiver&&this._hasTwccExtension&&(e+=yt.gC[yt.x_].get("maxaveragebitrate")+28800),e}_updateQosAudioBandwidth(){Ge.setAudioBandwidth(this.getAudioBandwidth())}clearAllRemoteAudioPlayer(){this._audioPlayerManager&&this._audioPlayerManager.clearAllRemoteAudioPlayer()}getRemoteAudioPlayerByMid(e){return this._audioPlayerManager?this._audioPlayerManager.getRemoteRTCAudioPlayer(e):null}checkAudioPlayerErrorInfo(){this._audioPlayerManager&&this._audioPlayerManager.checkAudioPlayerErrorInfo()}checkAllPlayers(e,t,i){let a=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this._audioPlayerManager&&this._audioPlayerManager.checkAllPlayers(e,t,i,a)}destroy(){(0,ft.lo)("DS"),this._isDestroyed=!0,this._cleanUserEventFn&&(this._cleanUserEventFn(),this._cleanUserEventFn=null),this._wmscAudioMonitor.destroy(this._wmscPC),this._stopAVSyncTimer(),this._webRTCWorkletManager&&(this._webRTCWorkletManager.destroy(),this._webRTCWorkletManager=null),this.setNormalAudioStream(null),this.setShareAudioStream(null),this.clearAllRemoteAudioPlayer(),this._healthChecker&&(this._healthChecker.destroy(),this._healthChecker=null),this._audioPlayerManager&&(this._audioPlayerManager.destroy(),this._audioPlayerManager=null),this._isRecvOnly=!1}async setStreamAsync(e){let t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];arguments.length>1&&void 0!==arguments[1]&&arguments[1]?await this.setShareAudioStream(e):await this.setNormalAudioStream(e,!1,t)}_stopAVSyncTimer(){this._AVsyncTimer&&(clearInterval(this._AVsyncTimer),this._AVsyncTimer=null)}syncMultiView(e,t){let i=new ArrayBuffer(16),a=t.toString(2),s=parseInt(a.substring(0,a.length-32),2),n=parseInt(a.substring(a.length-32,a.length),2),r=new DataView(i);r.setUint32(0,e,!0),r.setUint32(4,n,!0),r.setUint32(8,s,!0),r.setUint32(12,Date.now(),!0);let o=new Uint8Array(i);(0,Ht.Notify_Video_Decode_Thread)({command:"audioDecodeTime",status:1,data:o})}syncSingleView(e,t){let i=0;if(t){let e=parseInt(t).toString(2),a=e.substring(0,e.length-32),s=e.substring(e.length-32,e.length);a=parseInt(a,2),s=parseInt(s,2),i=1e3*a+232.8*s/1e9}0==jt.A.mediaSDKHandle.RenderInMain?e?(0,Ht.Notify_Sharing_Decode_Thread)({command:"audioTimestamp",data:i}):(0,Ht.Notify_Video_Decode_Thread)({command:"audioDecodeTime",status:0,data:i}):e?jt.A.mediaSDKHandle.SharingRenderObj&&jt.A.mediaSDKHandle.SharingRenderObj.SetcATimeStamp(i):jt.A.CurrentSSRCTime!=i&&(jt.A.CurrentSSRCTime=i,jt.A.audioPlayTime=Date.now())}_startAVSyncTimer(){this._stopAVSyncTimer(),this._AVsyncTimer=setInterval((()=>{if(!this._wmscPC||!this._audioPlayerManager)return;let e=0;Array.from(this._audioPlayerManager.getAllRemoteAudioPlayers().keys()).forEach((t=>{this._wmscPC.getRecvTransceiverByMid(t).receiver.getSynchronizationSources().forEach((t=>{if(e++,this.isUserMuted(this.getZoomSSRCByWebRTCSSRC(t.source),t.source))return;let i=this.getNodeIdByWebRTCSSRC(t.source);if(!i)return;let a=null;const s=this._mIdMgr.getMediaTypeBySsrc(t.source);if(s==He.zu.MainAudio?a=this._nodeId2NTPDescriptionMap.get(i):s==He.zu.ShareAudio&&(a=this._shareNodeId2NTPDescriptionMap.get(i)),a){let e=a.ntptime,n=a.rtptime,r=jt.A.timeOrigin+performance.now(),o=(r-t.timestamp)/1e3;Math.abs(o)>60&&(this._getSynchronizationSourcesTimestampInvalidDetected||(0,ft.py)("[WMSC Audio] data.timestamp diff too large: ".concat(o,", now:").concat(r,", data.ts:").concat(t.timestamp)),o=0,this._getSynchronizationSourcesTimestampInvalidDetected=!0);let c=t.rtpTimestamp-n&4294967295,d=e+o*Math.pow(2,32)+c*Math.pow(2,32)/48e3;this._codecDoAVSync?this.syncMultiView(a.ssrc,d):i>>10!=jt.A.CurrentSSRC>>10&&s!=He.zu.ShareAudio||t.source===a.abssrc&&this.syncSingleView(s==He.zu.ShareAudio,d)}}))})),0===e&&(this.syncSingleView(!1,0),this.syncSingleView(!0,0))}),500)}getLevelR16Log(){return this._webRTCWorkletManager&&this._webRTCWorkletManager.getLevelR16Log()}getHealthCheckFailedAndReset(){var e;return!(null===(e=this._healthChecker)||void 0===e||!e.isPacketSentBytesZero||(this._healthChecker.resetPacketSentCheck(),0))}_onAudioEnergySentCheckResult(e,t,i,a){let s="HEALTH_CHECK_FAILED:".concat(He.zu.MainAudio,"-energy-").concat(t,"-").concat(i,"-").concat(a);e?(s="HEALTH_CHECK_RECOVERED:".concat(He.zu.MainAudio,"-energy-").concat(t,"-").concat(i,"-").concat(a),(0,ft.lo)(s),(0,ft.py)(s)):a<=3?(At.Ay.isAndroidBrowser()||At.Ay.isIphoneOrIpadBrowser()||0==t)&&((0,ft.lo)("RE-CAPTURE:AUDIO_HEALTH_CHECK_FAILED"),(0,ft.py)("RE-CAPTURE:AUDIO_HEALTH_CHECK_FAILED"),this._doRecapture()):4==a?(0,ft.PV)(s):a%6==0&&((0,ft.lo)(s),(0,ft.py)(s))}_doRecapture(){var e;this._messageCallback("recapture",He.zu.MainAudio),null===(e=this._healthChecker)||void 0===e||e.resetPacketSentCheck()}isReceivingPacketByMid(e){let t=!1;return this._wmscPC.getRecvTransceiverByMid(e).receiver.getSynchronizationSources().forEach((e=>{e.rtpTimestamp&&(t=!0)})),t}_onPacketSentCheckResult(e){e?((0,ft.lo)("HEALTH_CHECK_RESTORED:PACKETS_SENT_ZERO"),jt.A.Notify_APPUI_SAFE(Gt.FjO)):((0,ft.lo)("HEALTH_CHECK_FAILED:PACKETS_SENT_ZERO"),(0,Kt.iK)(Gt.$qV,yt.Mm))}_onAudioEnergyReceivedCheckResult(e){this._audioPlayerManager&&(e?(this._audioPlayerManager.isAudioPlayerError=!1,(0,ft._$)("HEALTH_CHECK_RESTORED:RECEIVE_AUDIO_ENERGY_ZERO"),(0,ft.lo)("HEALTH_CHECK_RESTORED:RECEIVE_AUDIO_ENERGY_ZERO")):(this._audioPlayerManager.isAudioPlayerError=!1,(0,ft._$)("HEALTH_CHECK_FAILED:RECEIVE_AUDIO_ENERGY_ZERO"),(0,ft.lo)("HEALTH_CHECK_FAILED:RECEIVE_AUDIO_ENERGY_ZERO")))}_convertUserId2NodeId(e){return e?parseInt(e)>>10<<10:null}changeDenoiseSwitch(e,t,i,a,s){var n;null===(n=this._webRTCWorkletManager)||void 0===n||n.changeDenoiseSwitch(e,t,i,a,s)}updateQos(e){this._wmscAudioMonitor.setEnableBitrateReport(e.enable),e.workerType===Yt._c.AUDIO_ENCODE&&(this._showUplinkQosOnDashboard=!!e.enable),e.workerType===Yt._c.AUDIO_DECODE&&(this._showDownlinkQosOnDashboard=!!e.enable)}getNodeIdByWebRTCSSRC(e){return this._convertUserId2NodeId(this._mIdMgr.getUserIdBySsrc(e))}getZoomSSRCByWebRTCSSRC(e){const t=this._mIdMgr.getMediaTypeBySsrc(e);let i=this._mIdMgr.getUserIdBySsrc(e);return t===He.zu.ShareAudio&&(i|=512),i}getAudioStream(){return this.getFinalSentAudioStream()}getAudioMode(){return this._audioMode}interpretation_set_mute(e){this._interpretationMuted=!!e,this._interpretationChangeSpeakerVolume()}interpretation_set_enable(e){this._interpretationEnable=!!e,this._audioPlayerManager&&(this._audioPlayerManager.getAllRemoteAudioPlayers().forEach((e=>{e.initInterpretationParams()})),this._wmscPC.off(He.f7.StatsReport,this._inboundSourceVADBind),this._interpretationEnable&&this._wmscPC.on(He.f7.StatsReport,this._inboundSourceVADBind))}interpretation_set_lang(e){this._interpretationCurrentLang=e,this._audioPlayerManager&&(this._audioPlayerManager.getAllRemoteAudioPlayers().forEach((e=>{e.clearInterpreterSpeakingCount(),this._interpreterSpeakingStatus=yt.g3})),this._interpretationChangeSpeakerVolume())}interpretation_set_list(e){this._interpretationList=e,this._audioPlayerManager&&(this._audioPlayerManager.getAllRemoteAudioPlayers().forEach((t=>{e.includes(t.getNodeId()>>10)?t.setInterpreter(!0):t.setInterpreter(!1)})),this._interpretationChangeSpeakerVolume())}updateUserLang(e,t){this._userLangMap[e>>10]=t,this._audioPlayerManager&&(this._audioPlayerManager.getAllRemoteAudioPlayers().forEach((i=>{i.getNodeId()>>10==e>>10&&i.setLang(t)})),this._interpretationChangeSpeakerVolume())}inboundSourceVAD(e){if(!this._audioPlayerManager)return!1;if(!this._interpretationEnable)return!1;e.forEach((e=>{if("inbound-rtp"===e.type&&"audio"===e.kind){const{totalAudioEnergy:t,totalSamplesDuration:i,audioLevel:a,mid:s}=e,n=this._audioPlayerManager.getRemoteRTCAudioPlayer(s);if(!n||!n.isInterpreter())return;if(void 0===t||void 0===i)return;const{totalAudioEnergy:r,totalSamplesDuration:o}=n.getVADStatistics(),c=t-r,d=i-o;if(n.setVADStatistics({totalAudioEnergy:t,totalSamplesDuration:i}),d<=0||!r||!o)return;const l=c/d>.001&&(void 0===a?1:a)>.01;this._changeCurrentLangInterpreterSpeakingStatus(s,l)}}));const t=[...this._audioPlayerManager.getAllRemoteAudioPlayers().values()].reduce(((e,t)=>t.isInterpreter()?Math.max(e,t.isInterpreterSpeaking()):e),yt.g3);t!=this._interpreterSpeakingStatus&&((0,ft.lo)("interpreterSpeakingStatus: ".concat(t)),this._interpreterSpeakingStatus=t,this._interpretationChangeSpeakerVolume())}_interpretationChangeSpeakerVolume(){this._audioPlayerManager&&this._audioPlayerManager.getAllRemoteAudioPlayers().forEach((e=>{e.isInterpreter()?e.getLang()===this._interpretationCurrentLang?e.changeVolumeByInterpreter(100):e.changeVolumeByInterpreter(0):e.getLang()===this._interpretationCurrentLang?this._interpreterSpeakingStatus===yt.sr?e.changeVolumeByInterpreter(30):e.changeVolumeByInterpreter(100):this._interpretationMuted?e.changeVolumeByInterpreter(0):this._interpreterSpeakingStatus===yt.sr?e.changeVolumeByInterpreter(10):e.changeVolumeByInterpreter(100)}))}_changeCurrentLangInterpreterSpeakingStatus(e,t){if(!this._audioPlayerManager)return!1;const i=this._audioPlayerManager.getRemoteRTCAudioPlayer(e);if(!i)return!1;null!=i&&i.isInterpreter()&&(null==i?void 0:i.getLang())===this._interpretationCurrentLang&&(t?i.increaseInterpreterSpeakingCount():i.decreaseInterpreterSpeakingCount())}}class ii{constructor(e,t){this.pc=e,this.midMgr=t,this.audioSsrcToSR=new Map,this.videoSsrcToSR=new Map}setAudioSR(e){const{ntptime:t,rtptime:i,abssrc:a}=e,s=BigInt(t),n=Number(s>>BigInt(32)),r=Number(s&BigInt(4294967295));this.audioSsrcToSR.set(a,{rtpTimestamp:i,ntpTimestamp:n+r/Math.pow(2,32),createdTime:performance.now()})}setVideoSR(e){e.forEach((e=>{let{ssrc:t,ntptime:i,rtptime:a}=e;const s=BigInt(i),n=Number(s>>BigInt(32)),r=Number(s&BigInt(4294967295));this.videoSsrcToSR.set(t,{rtpTimestamp:a,ntpTimestamp:n+r/Math.pow(2,32),createdTime:performance.now()})}))}getAVSyncDiff(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:9e4,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:48e3;var a,s;const n=this.midMgr.getAudioMidByUserId(e),r=this.midMgr.getVideoMidByUserId(e);if(n&&r){const e=null===(a=this.pc.getRecvTransceiverByMid(n))||void 0===a?void 0:a.receiver,o=null===(s=this.pc.getRecvTransceiverByMid(r))||void 0===s?void 0:s.receiver;if(e&&o){const a=o.getSynchronizationSources()[0],s=e.getSynchronizationSources()[0];if(a&&s){const e=this.convertAudioRtpTimeToWallTime(s,i),n=this.convertVideoRtpTimeToWallTime(a,t);if(e&&n)return{audioNtpTimestamp:e,videoNtpTimestamp:n,diff:s.timestamp-e-(a.timestamp-n)}}}}}deleteSRByMid(e){var t;const i=null===(t=this.pc.getRecvTransceiverByMid(e))||void 0===t?void 0:t.receiver;if(i){const{source:e}=i.getSynchronizationSources()[0]||{};e&&(this.audioSsrcToSR.delete(e),this.videoSsrcToSR.delete(e))}}convertAudioRtpTimeToWallTime(e,t){const{source:i,rtpTimestamp:a}=e,s=this.audioSsrcToSR.get(i);if(s)return this.rtpTimeToWallTime(a,s,t)}convertVideoRtpTimeToWallTime(e,t){const{source:i,rtpTimestamp:a}=e,s=this.videoSsrcToSR.get(i);if(s)return this.rtpTimeToWallTime(a,s,t)}rtpTimeToWallTime(e,t,i){const{rtpTimestamp:a,ntpTimestamp:s,createdTime:n}=t,r=e-a;if(Math.abs(r)>Math.pow(2,24)||performance.now()-n>5e3)return;const o=r/i;return Math.round(1e3*(s+o))}}function ai(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,a)}return i}function si(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?ai(Object(i),!0).forEach((function(t){(0,c.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ai(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const ni=te.getTracer("WmscApiImpl"),ri=e=>{ni.log(e),te.monitorLog("".concat(e))},oi=h,{zk:ci}=a;class di{constructor(e,t){ni.log("created, config: ".concat(JSON.stringify(e))),x.setConfig(e||{}),this.messageCallback=t,this.resetRunTimeParams(),this.negotiationMsgId=0,this.negotiationTimeCost=[],this.pc=null,this.mIdMgr=new _t([]),kt.mIdMgr=this.mIdMgr,this._isWMSCAudioEnabled()&&this.createWmscAudioMgr(x.nodeId,this.mIdMgr),this.createPeerConnection(),x.nodeId&&(kt.setUserId(x.nodeId),kt.start()),this._isWMSCVideoEnabled()&&(this.initVideoConfig(),kt.isWebRTCVideoEnabled=!0),this.startNegotiation(),this.renegotiationQueue=[],this.numOfTasks=0,this.createdMLine=[],this.removedMids=[],this.updatedMlineFmtp=[],this.lastStreamReqSeq=0,this.lastStreamStatusSeq=0,this.localIceCredential=null,this.ongoingUpdateBitrateTasks=[],this._handlePageVisibilityChange=this._handlePageVisibilityChange.bind(this),this.isOnline=!0,this._handleOnline=this._handleOnline.bind(this),this._handleOffline=this._handleOffline.bind(this),window.addEventListener("online",this._handleOnline),window.addEventListener("offline",this._handleOffline)}_handleOnline(){ri("WMSC_ONLINE-".concat(this.isOnline)),this.isOnline||this.restartIce(),this.isOnline=!0}_handleOffline(){ri("WMSC_OFFLINE"),this.isOnline=!1}destroy(){var e,t;this.sendBye(),this.closeAllPeerConnections(),this.resetRunTimeParams(),null===(e=this._wmscAudioMgr)||void 0===e||e.destroy(),Ge.stop(),null==kt||kt.stop(),null===(t=this.mIdMgr)||void 0===t||t.destory(),document.removeEventListener("visibilitychange",this._handlePageVisibilityChange),window.removeEventListener("online",this._handleOnline),window.removeEventListener("offline",this._handleOffline)}resetRunTimeParams(){ni.log("reset run time parameters");const{negotiationTimer:e,reconnectTimer:t}=this.pcInfo||{};e&&clearTimeout(e),t&&clearTimeout(t),this.pcInfo={status:u.IDLE,reconnectionCount:0,negotiationTimer:0,reconnectTimer:0,offerMsgId:0,useIceServers:!1,isNegotitating:!1,iceCredentialMsgId:0,iceRestartCount:0,isConnecting:!1},this.camStreams=null,this.bActiveVideo=!1,this.bPrevActiveVideo=!1,this.lastSubList=[],this.sourceVideoSize=-1,this.lastUpdatedSourceVideoSize=-1,this._toSubscribeBuffer=[],this._videoTagMappingBuffer=new Map,this.mIdMgr=null,this.subscriptions=new Map,this.maxSubVideoSize=-1}renewPeerConnection(){this.createPeerConnection(),this._isWMSCVideoEnabled()&&Je.init(this.pc,this.recvMLineNum),this.camStreams&&this._addVideoStreams(this.camStreams),this.startNegotiation()}initVideoConfig(e){ri("WMSC_VCN-".concat(Je.recvCodecNum,"-").concat(Je.sendCodecNum)),x.setConfig(e||{});const t=x.videoSettings;vt.setLimits({maxSendVideoSize:t.maxCaptureVideoSize,maxRecvVideoNum:t.maxRecvVideoNum}),this.videoCapabilities=vt.getCapabilities();const{maxSendVideoSize:i,maxRecvVideoSize:a,maxRecvVideoNum:s}=this.videoCapabilities;ri("WMSC_V_Cap_Updated: ".concat(i,"|").concat(a,"|").concat(s)),this.recvMLineNum=s,this.maxRecvVideoSize=a,Je.registerMessageCallback(this.onMediaMessage.bind(this)),Je.setVideoSettings(t),Je.setMaxSendLayerId(i),kt.onDecodeError=this._handleDecodeError.bind(this),Je.init(this.pc,this.recvMLineNum),this.camStreams&&this._addVideoStreams(this.camStreams),this._mapBufferedVideoTag(),Je.onMediaRequest(this.lastSubList),Ge.registerSendUsageStateUpdateCallback(this.onSendUsageStateUpdate.bind(this)),Ge.registerMaxRecvVideoSizeUpdateCallback(this.onMaxRecvVideoSizeUpdate.bind(this)),Ge.start(x.qosOptions),this.messageCallback({type:W.VIDEO_CAPABILITIES_CHANGE,data:this.videoCapabilities}),ri("WMSC_SW_PRE: ".concat(Ae("send"),"|").concat(Ae("recv")))}_isWMSCAudioEnabled(){return x.webrtcMode&yt.h}_isWMSCVideoEnabled(){return x.webrtcMode&yt.Q9}_handleAudioSessionStatus(e,t){switch(e){case"requestSelfRenegotiation":this.requestSelfRenegotiation(t);break;case"recapture":this.messageCallback({type:W.AUDIO_RECAPTURE})}}createWmscAudioMgr(e,t){this._wmscAudioMgr||(ri("INITWMSCAUDIO"),this._wmscAudioMgr=new ti({userId:e,mIdMgr:t,signalSendSink:this._sendMessageToRwg.bind(this),messageCallback:this._handleAudioSessionStatus.bind(this)}))}getWMSCAudioMgr(){return this._wmscAudioMgr}stopReceiveVideo(){ri("WMSC_Stop_Recv_Video"),this.sendBye(),this.closePeerConnection(),this.mIdMgr=null}createPeerConnection(){var e,t;ri("WMSC_Start_Create_PC");let i=null===(e=this.pcInfo)||void 0===e?void 0:e.useIceServers;this.pc=new Wt({iceServers:i?x.iceServers:[]}),ri("WMSC_PC_Create_Success"),null===(t=this._wmscAudioMgr)||void 0===t||t.onPCCreated(this.pc),this._wmscAVSyncMgr=new ii(this.pc,this.mIdMgr),kt.avSyncMgr=this._wmscAVSyncMgr,this.pc.on(He.f7.ConnectionStateChange,this._handlePcStateChange.bind(this)),this.pc.on(He.f7.Track,this._handleRemoteStream.bind(this)),this.pc.on(He.f7.SignalingStateChange,this._handleSignalingStateChange.bind(this)),this.pc.on(He.f7.IceConnectionStateChange,this._handleIceConnectionStateChange.bind(this)),this.pc.on(He.f7.IceGatheringStateChange,(e=>{ri("WMSC_CANDGA: ".concat(e))})),this.pc.on(He.f7.IceCandidateError,(e=>{const{errorCode:t,errorText:i}=e;ri("WMSC_onicecandidateerror: ".concat(t)),te.globalTrace({logLevel:"error",log:"WMSC_onicecandidateerror: ".concat(t,"|").concat(i)})})),this.pc.on(He.f7.StatsReport,(e=>{kt.onStatsReport(e)}))}async _addVideoStreams(e){var t,i;const a=null===(t=e[0])||void 0===t||null===(t=t.stream)||void 0===t?void 0:t.getVideoTracks()[0],s=null==a?void 0:a.getConstraints(),n=null===(i=e[e.length-1])||void 0===i||null===(i=i.stream)||void 0===i?void 0:i.getVideoTracks()[0],r=a&&!a.muted,o=r?J(n.getSettings(),s):null;Ge.setVideoSourceLiveState(r),await Je.publishVideoTrack(n,o)}async onVideoStreamsAsync(e){var t;if(this.camStreams=e,null!=e&&e.length){var i,a;const t=null===(i=e[0].stream)||void 0===i?void 0:i.getVideoTracks()[0],s=null==t?void 0:t.getConstraints(),n=null===(a=e[e.length-1].stream)||void 0===a?void 0:a.getVideoTracks()[0];this.sourceVideoSize=Te(s),t.addEventListener("unmute",(()=>{Je.updateVideoSourceSettings(J(n.getSettings(),s)),Ge.setVideoSourceLiveState(!0)})),t.addEventListener("mute",(()=>{Ge.setVideoSourceLiveState(!1)})),t.addEventListener("ended",(()=>{Ge.setVideoSourceLiveState(!1)}))}else this.sourceVideoSize=-1;return this.lastUpdatedSourceVideoSize=-1,kt.camStream=null===(t=e[0])||void 0===t?void 0:t.stream,await this._addVideoStreams(e),Promise.resolve(!0)}async startNegotiation(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const i=this.pcInfo;let a;e||(i.status=u.CONNECTING,this.negotiationMsgId++,this.pcInfo.offerMsgId=this.negotiationMsgId),i.isNegotitating=!0,(!e||null!=t&&t.iceRestart)&&this._detectConnectionTimeout();try{var s,n;if(this.negotiationTimeCost=[performance.now()],a=await this.pc.createOffer(t),this.negotiationTimeCost.push(performance.now()),ri("WMSC_CO"),Je.mungeLocalOffer(a),null===(s=this._wmscAudioMgr)||void 0===s||s.mungeLocalOffer(a),null!=t&&t.iceRestart&&this.pc.updateOfferIceCredential(this.localIceCredential),await this.pc.setOffer(),this.negotiationTimeCost.push(performance.now()),ri("WMSC_SLDS"),e)return a;const i=le.cloneSdp(a);le.mungeEgressOfferToRemote(i),null===(n=this._wmscAudioMgr)||void 0===n||n.handleLocalOffer(i);const r=le.writeSdp(i);this._handleSdpOffer(r)}catch(t){let i="";a&&(i=le.writeSdp(a)),q(i,I.GZIP_BASE64).then((i=>{te.globalTrace({logLevel:"error",log:"WMSC_OFSLDF: ".concat(e,"|").concat(t.message,"|").concat(i)})})).catch((()=>{te.globalTrace({logLevel:"error",log:"WMSC_OFSLDF: ".concat(e,"|").concat(t.message,"|").concat(i)})})),ri("WMSC_OFSLDF-".concat(e,"-").concat(t.message)),"closed"!==this.pc.signalingState&&(e?this.messageCallback({type:W.SDP_NEGOTIATION_FAIL}):this.restartNegotiation())}}restartNegotiation(){const e=this.pcInfo;this.closePeerConnection(),e.reconnectionCount<S?(e.reconnectionCount++,ri("WMSC_Restart_Nego: ".concat(e.reconnectionCount)),this._isWMSCAudioEnabled()&&this.messageCallback({type:W.ERROR_MESSAGE,data:{type:"PC_RECONNECT",mediaType:"audio"}}),this._isWMSCVideoEnabled()&&this.messageCallback({type:W.ERROR_MESSAGE,data:{type:"PC_RECONNECT",mediaType:"video"}}),this.renewPeerConnection()):this.messageCallback({type:W.SDP_NEGOTIATION_FAIL})}closePeerConnection(){if(this.pc){var e;const t=this.pcInfo;clearTimeout(t.negotiationTimer),t.status=u.IDLE,this.pc.removeAllListeners(),this.pc.close(),Je.handlePcClose(),null===(e=this.mIdMgr)||void 0===e||e.removeAllMIdResource()}}closeAllPeerConnections(){this.closePeerConnection()}onMediaMessage(e){const{type:t,data:i}=e;switch(ni.log("onMediaMessage, type: ".concat(t)),t){case y.ERROR:ni.error("onMediaMessage, error: ".concat(i));break;case y.UPDATE_BITRATE:this._pushToRenegotiationQueue([si({type:ci.UPDATE_BITRATE},i)]);break;default:ni.error("onMediaMessage, unknown type: ".concat(t))}}onSendUsageStateUpdate(e,t){if(e===C.UNDERUSING){const e=Ce(this.sourceVideoSize);e&&e.formatIndex===t&&this._maybeUpdateVideoSourceConstraints(this.sourceVideoSize+1)}}_maybeUpdateVideoSourceConstraints(e){let{maxCaptureVideoSize:t,hdVideoEnabled:i}=x.videoSettings;if(i||(t=Math.min(2,t)),e<=t&&e!==this.lastUpdatedSourceVideoSize){const t=Ce(e),i={width:t.width,height:t.height,frameRate:t.maxFramerate};return this.messageCallback({type:W.UPDATE_VIDEO_CAPTURE_CONSTRAINTS,data:i}),this.lastUpdatedSourceVideoSize=e,!0}return!1}onMaxRecvVideoSizeUpdate(e){this.maxRecvVideoSize=Math.min(this.videoCapabilities.maxRecvVideoSize,e);const t=[];for(const[i,a]of this.subscriptions){const s=this.mIdMgr.getVideoSizeByUserId(i),n=Math.min(e,a);s!==n&&t.push({id:i,size:n})}t.length&&this._updateSubscriptions(t)}_handleVideoTagMappingBuffer(e,t,i){const a=this._videoTagMappingBuffer.get(e)||[];switch(t){case"add":a.push(i),this._videoTagMappingBuffer.set(e,a);break;case"remove":for(let e=0;e<a.length;)a[e]===i?a.splice(e,1):e++;a.length||this._videoTagMappingBuffer.delete(e);break;default:ri("WMSC_Mapping_Buffer_Action_E: ".concat(e,"|").concat(t))}}onVideoTagMapping(e){const t=parseInt(e.userId),{videodom:i,action:a}=e;if(ri("WMSC_Video_Tag_Mapping: ".concat(t,"|").concat(a,"|").concat(!!this.mIdMgr)),this.mIdMgr)switch(a){case"add":case"buffer":this.mIdMgr.saveVideoTag(t,i),this.messageCallback({type:W.VIDEO_TAG_MAPPED,data:t});break;case"remove":this.mIdMgr.removeVideoTag(t,i);break;default:ri("WMSC_Mapping_Action_E: ".concat(t,"|").concat(a))}else ni.warn("onVideoTagMapping, mIdMgr not ready yet. Will do mapping later."),this._handleVideoTagMappingBuffer(t,a,i)}getUserIdVideo(e){return this.mIdMgr?this.mIdMgr.getVideoTagsByUserId(e):null}_mapBufferedVideoTag(){this._videoTagMappingBuffer.size&&(this._videoTagMappingBuffer.forEach(((e,t)=>{(null==e?void 0:e.length)>0&&e.forEach((e=>{this.onVideoTagMapping({userId:t,videodom:e,action:"buffer"})}))})),this._videoTagMappingBuffer.clear())}subscribeVideo(e){const t=this.pcInfo;if(t.status!==u.CONNECTED)return e.forEach((e=>{this._toSubscribeBuffer.push({params:e,toSub:!0})})),void ri("WMSC_SubV_PC_N_Ready: ".concat(t.status));const i=Math.min(this.maxRecvVideoSize,Ge.getMaxFeasibleRecvVideoSize());let a=-1;e.forEach((e=>{const{id:t,size:s}=e;this.subscriptions.set(t,s),s>a&&(a=s);const n=Math.min(s,i);n!==s&&(e.size=n),this.mIdMgr.setVideoSize(t,n),kt.updateSubInfo(t,n)})),a>this.maxSubVideoSize&&(this.maxSubVideoSize=a,Ge.updateMaxSubVideoSize(a)),this.messageCallback({type:W.UPDATE_VIDEO_SUBSCRIPTION,data:e})}unSubscribeVideo(e){if(this.pcInfo.status!==u.CONNECTED)return e.forEach((e=>{this._toSubscribeBuffer.push({params:e,toSub:!1})})),void ri("WMSC_UnsubV_PC_N_Ready");let t=-1;e.forEach((e=>{this.subscriptions.delete(e.id),kt.updateSubInfo(e.id,-1),this.mIdMgr.setVideoSize(e.id,-1)}));for(const[,e]of this.subscriptions)e>t&&(t=e);this.maxSubVideoSize!==t&&(this.maxSubVideoSize=t,Ge.updateMaxSubVideoSize(t)),this.messageCallback({type:W.UPDATE_VIDEO_UNSUBSCRIPTION,data:e})}_updateSubscriptions(e){const t=[];e.forEach((e=>{var i;const{id:a,size:s}=e;(null===(i=this.mIdMgr)||void 0===i?void 0:i.getMainVideoMId(a))&&(t.push({id:a,size:s,bOn:!1}),this.mIdMgr.setVideoSize(a,s))})),this.messageCallback({type:W.UPDATE_VIDEO_SUBSCRIPTION,data:t})}onRwgMessage(e){var t;const i="string"==typeof e.data?JSON.parse(e.data):e.data;if((null==i?void 0:i.evt)===dt||(null==i?void 0:i.evt)===lt){const e=i.body;switch(e.type){case Ze:return ni.log("on SDP_ANSWER"),this.onSdpAnswer(e),!0;case et:return ni.log("on SDP_BYE"),this.onSdpBye(e),!0;case tt:return ni.log("on ICE_DISCONNECTED"),this.onIceDisconnected(e),!0;case ct:return this.onSubscribeList(e.activeVideo,e.prevActiveVideo,e.privateVideo),!0;case ot:return this.onCommand(e),!0;case it:return this._handleStreamRequest(e),!0;case nt:return null===(t=this._wmscAudioMgr)||void 0===t||t.onRWGCMDQos(e),Ge.onQosReport(e),kt.onQosReport(e),!0;case st:var a,s;return null===(a=this._wmscAVSyncMgr)||void 0===a||a.setAudioSR(e),null===(s=this._wmscAudioMgr)||void 0===s||s.onRWGCMDRtcpSR(e),!0;case rt:var n;return null===(n=this._wmscAVSyncMgr)||void 0===n||n.setVideoSR(e.srInfos),!0;default:return ni.warn("Received unknown RWG message type: ".concat(e.type)),!1}}}async onSdpAnswer(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!t&&!this._checkMsgIdForPC(e))return;let a=e,s=null;try{var n;if(this.negotiationTimeCost.push(performance.now()),!t){ri("WMSC_REAN");const t=this.pc,{sdp:n,sdpEncoding:r}=e;if(a=await function(e,t){return H(this,void 0,void 0,(function*(){switch(t){case I.GZIP_BASE64:{const t=function(e){const t=atob(e),i=new Uint8Array(t.length);for(let e=0;e<i.length;e++)i[e]=t.charCodeAt(e);return i.buffer}(e);return function(e){return H(this,void 0,void 0,(function*(){if(window.DecompressionStream){const t=new DecompressionStream("gzip"),i=t.writable.getWriter();return i.write(e),i.close(),new Response(t.readable).arrayBuffer().then((function(e){return(new TextDecoder).decode(e)}))}{const{ungzip:t}=yield i.e(404).then(i.bind(i,3075));return(new TextDecoder).decode(t(e).buffer)}}))}(t)}case I.PLAIN:return e;default:return null}}))}(n,r),this.pc!==t||!this._checkMsgIdForPC(e))return void ri("WMSC_ODAN");kt.sendSdpLog("ANSWER",a),s=le.parseSdp(a),Je.updateConfigFromSdp(s)}s||(s=this.pc.getAnswer()),null===(n=this._wmscAudioMgr)||void 0===n||n.mungeAnswer(s),Je.mungeAnswer(s);let o=le.writeSdp(s);var r;await this.pc.setAnswer(o),this.negotiationTimeCost.push(performance.now()),this.pcInfo.isNegotitating=!1,ri("WMSC_SRDS"),t?this._handleSelfNegotiationSuccess():(this.sendSdpOk(),Je.saveCodecList(),Je.saveRecvMLineTemp(),null===(r=this._wmscAudioMgr)||void 0===r||r.saveRecvMLineTemp()),this._popRenegotiationQueue()}catch(e){const i=a||le.writeSdp(this.pc.answer);q(i,I.GZIP_BASE64).then((i=>{te.globalTrace({logLevel:"error",log:"WMSC_SRDF: ".concat(t,"|").concat(e.message,"|").concat(i)})})).catch((()=>{te.globalTrace({logLevel:"error",log:"WMSC_SRDF: ".concat(t,"|").concat(e.message,"|").concat(i)})})),ri("WMSC_SRDF-".concat(t,"-").concat(e.message)),"closed"!==this.pc.signalingState&&(t?this.messageCallback({type:W.SDP_NEGOTIATION_FAIL}):this.restartNegotiation())}}onSdpBye(e){this._checkMsgIdForPC(e)&&"have-local-offer"===this.pc.signalingState&&(this.closePeerConnection(),te.globalTrace({logLevel:"error",log:"WMSC_SDP_BYE_REJECT"}),ri("WMSC_BYEREJ"),this.messageCallback({type:W.SDP_NEGOTIATION_FAIL}))}onIceDisconnected(e){this._checkMsgIdForPC(e)&&(ri("WMSC_ICE_DISCON"),te.globalTrace({logLevel:"error",log:"WMSC_RestartIce_F_S"}),this.restartIce())}restartIce(){const e=this.renegotiationQueue.find((e=>{let{type:t}=e;return t===ci.ICE})),{iceRestartCount:t,isConnecting:i}=this.pcInfo;if(!e&&!i)if(t<_){this.pcInfo.iceRestartCount++,this.localIceCredential=le.generateIceCredentials(),this.pcInfo.iceCredentialMsgId++;const e=mt(x.confId,null,null,null,null,si({generation_id:this.pcInfo.iceCredentialMsgId},this.localIceCredential),this.lastStreamReqSeq,this.lastStreamStatusSeq);this._sendMessageToRwg({evt:dt,body:e}),ri("WMSC_ICECREDREQ:".concat(this.pcInfo.iceCredentialMsgId,",").concat(this.lastStreamReqSeq,",").concat(this.lastStreamStatusSeq)),this.lastStreamStatusSeq++}else this.messageCallback({type:W.PC_FAIL})}onSubscribeList(e,t,i){var a;ri(X("WMSC_On_Sub_List: ".concat(JSON.stringify(e),"|").concat(JSON.stringify(t),"|").concat(JSON.stringify(i)))),kt.updateSubscribedSize(e,t,i);const s=l()(a=Array.from(new Set([...e,...t,...i]).values()).filter((e=>e>=0))).call(a);Y(s,this.lastSubList)||(this.lastSubList=[...s],this.pcInfo.status===u.CONNECTED&&Je.onMediaRequest(s))}onCommand(e){if(0===e.cmdId){let t;try{t=JSON.parse(e.cmdParam)}catch(t){ni.warn("Invalid command message: ".concat(JSON.stringify(e)))}void 0!==t.receiverBW?Ge.onReceiverBandwidthReport(t.receiverBW):void 0!==t.subInfo?(Ge.onSubInfo(t.subInfo),kt.onDualCallState(t.subInfo)):void 0!==t.ingressReport&&(Ge.onReceiverReport(t.ingressReport),kt.onReceiverReport(t.ingressReport))}else ni.warn("Unknown command id ".concat(e.cmdId))}onActiveVideoSourceChange(e){const t=parseInt(x.nodeId)===parseInt(e.userId);return this.bPrevActiveVideo=this.bActiveVideo&&!t,this.bActiveVideo=t,kt.setActiveSpeaker(e.userId,this.bPrevActiveVideo),ri("WMSC_OASC: ".concat(e.userId)),this.mIdMgr.setActiveSpeaker(e.userId),!0}updateWmscParams(e){ni.log("updateWmscParams, data: ".concat(JSON.stringify(e))),Object.entries(e).forEach((e=>{let[t,i]=e;switch(t){case"nodeId":var a;x.setConfig({nodeId:i}),kt.setUserId(i),kt.start(),null===(a=this._wmscAudioMgr)||void 0===a||a.setUserId(i);break;case"hdVideoEnabled":{const e=!!i;x.setConfig({videoSettings:si(si({},x.videoSettings),{},{hdVideoEnabled:e})}),Je.enableHdVideo(e)}break;case"maxEncodingFramerate":Je.setMaxEncodingFramerate(i);break;case"preferSoftwareCodec":{const e=Ae("send"),t=Ae("recv");this._updateSoftwareCodecPreference(i),t!==Ae("recv")&&(ri("WMSC_SW_PRE_RECV: ".concat(!t)),this.pcInfo.status!==u.IDLE&&this._sendRecvCodecPreference(He.zu.MainVideo)),e!==Ae("send")&&(ri("WMSC_SW_PRE_SEND: ".concat(!e)),this.pcInfo.status!==u.IDLE&&this._pushToRenegotiationQueue([{type:ci.MEDIA,mediaType:He.zu.MainVideo,preferSoftwareCodec:!e}]));break}default:ni.warn("updateWmscParams, unknown param name: ".concat(t))}}))}updateVideoSourceSettings(e){var t;const i=null===(t=this.camStreams)||void 0===t||null===(t=t[0])||void 0===t||null===(t=t.stream)||void 0===t?void 0:t.getVideoTracks()[0];if(!i)return;if(!e)return void Je.updateVideoSourceSettings(null);let{constraints:a,settings:s}=e;a||(a=i.getConstraints()),s||(s=i.getSettings());const n=J(s,a);this.sourceVideoSize=Te(n),Je.updateVideoSourceSettings(n)}async getStats(){const e=await this.pc.getStats();for(const[t,i]of e)if("outbound-rtp"===i.type||"remote-inbound-rtp"===i.type){const e=this.mIdMgr.getMediaTypeByMid(i.mid);i.nodeId=x.nodeId,i.isSharing=e===He.zu.ShareAudio||e===He.zu.ShareVideo}else if("inbound-rtp"===i.type||"remote-outbound-rtp"===i.type){const e=this.mIdMgr.getUserIdBySsrc(i.ssrc);i.nodeId=Q(e),i.isSharing=!!(512&e)}return e}sendBye(){const e=(t=x.confId,i=r.VIDEO,a=oi,s=this.negotiationMsgId,{type:et,confID:t,sessionID:i,peerID:a,msgID:s,sdp:""});var t,i,a,s;this._sendMessageToRwg({evt:dt,body:e}),ri("WMSC_SDPBYE")}sendSdpOk(){const e=(t=x.confId,i=r.VIDEO,a=oi,s=this.negotiationMsgId,{type:$e,confID:t,sessionID:i,peerID:a,msgID:s});var t,i,a,s;this._sendMessageToRwg({evt:dt,body:e}),ri("WMSC_SDPOK")}_sendMessageToRwg(e){this.messageCallback({type:W.WMSC_MESSAGE_TO_RWG_BY_SDK,data:JSON.stringify(e)})}async _handleRemoteStream(e){var t;const i=new MediaStream,{track:a,transceiver:s,streams:n=[]}=e,{kind:r}=a,o=s.mid,c=(null===(t=n[0])||void 0===t?void 0:t.id)||"";if(ri("WMSC_RSV_M: ".concat(o,"-").concat(r)),"video"===r)this.mIdMgr.addMidResource(o,{streamId:c,track:a,transceiver:s});else if("audio"===r){var d;this.mIdMgr.addMidResource(o,{streamId:c}),i.addTrack(a);const e=this.mIdMgr.getUserIdByMid(o);null===(d=this._wmscAudioMgr)||void 0===d||d.onRemoteStream(i,a,o,e)}}async _handleSdpOffer(e){let t=I.PLAIN,i=e;const a=this.pc;try{i=await q(e,I.GZIP_BASE64),t=I.GZIP_BASE64}catch(e){te.globalTrace({logLevel:"error",log:"WMSC_Compress_SDP_Offer_F",errorEvent:e})}if(this.pc!==a)return;this.sendBye();const s=this.pcInfo.offerMsgId,n=((e,t,i,a,s,n,r,o,c,d)=>{const l=[{key:"webrtc_dynamic_egress_media_streams",value:!0},{key:"webrtc_client_sending_codec_preference",value:r},{key:"webrtc_client_recving_codec_preference",value:o}];return c&&l.push({key:"webrtc_max_total_video_streams",value:c}),d===z.WEBRTC_SYNC&&l.push({key:"webrtc_egress_avsync_enabled",value:!0}),{type:Xe,confID:e,sessionID:t,peerID:i,msgID:a,sdp:s,sdpEncoding:n,featureToggles:l}})(x.confId,r.VIDEO,oi,s,i,t,Je.getPreferPayloadTypes("send"),Je.getPreferPayloadTypes("recv"),(0,de.GN)()?this.recvMLineNum:null,x.avSyncMode);this._sendMessageToRwg({evt:dt,body:n}),kt.sendSdpLog("OFFER",e)}_handlePcStateChange(e){const t=this.pcInfo;if(ri("WMSC_onconnectionstatechange: ".concat(e)),"connected"===e){this.negotiationTimeCost.push(performance.now());const e=this._getNegotiationTime(),i="-".concat(t.iceRestartCount,"-").concat(t.reconnectionCount);for(te.globalTrace({logLevel:"directReport",log:e.join("-")+i,tags:["WMSC Negotiation time"]}),ri("WMSCNT-".concat(e.join("-")).concat(i)),clearTimeout(t.negotiationTimer),clearTimeout(t.reconnectTimer),t.status=u.CONNECTED,t.reconnectionCount=0,t.negotiationTimer=0,t.iceRestartCount=0,t.isConnecting=!1,ni.log("_handlePcStateChange: connected"),Je.onMediaRequest(this.lastSubList);this._toSubscribeBuffer.length;){const e=this._toSubscribeBuffer.shift();e.toSub?this.subscribeVideo([e.params]):this.unSubscribeVideo([e.params])}this.messageCallback({type:W.PC_CONNECTED})}else if("disconnected"===e)this.pcInfo.reconnectTimer=setTimeout((()=>{"disconnected"===this.pc.connectionState&&(ri("WMSC_PC_Disconn"),this.restartIce())}),p);else if("failed"===e){const e="WMSC_PC_State_Failed: ".concat(this._getNegotiationTime().join("-"));te.globalTrace({logLevel:"error",log:e}),ri(e),this._enableTURN(),this.restartIce()}}_handlePageVisibilityChange(){"visible"===document.visibilityState&&(this.messageCallback({type:W.PC_CLOSED}),document.removeEventListener("visibilitychange",this._handlePageVisibilityChange))}_handleSignalingStateChange(e){ri("WMSC_onsignalingstatechange: ".concat(e)),"closed"===e&&setTimeout((()=>{di.PC_CLOSE_CNT++,"hidden"===document.visibilityState?(te.globalTrace({logLevel:"error",log:"WMSC_PC_CLOSE: HIDDEN"}),document.addEventListener("visibilitychange",this._handlePageVisibilityChange)):(di.PC_UNKNOWN_CLOSE_CNT>=v?this.messageCallback({type:W.PC_FAIL}):this.messageCallback({type:W.PC_CLOSED}),di.PC_UNKNOWN_CLOSE_CNT++,te.globalTrace({logLevel:"error",log:"WMSC_PC_CLOSE_UNKNOWN: ".concat(di.PC_UNKNOWN_CLOSE_CNT)}))}),1500)}_handleIceConnectionStateChange(e){ri("WMSC_ICESTATE: ".concat(e)),"failed"===e&&te.globalTrace({logLevel:"error",log:"WMSC_ICE_State_Error: ".concat(e)})}_handleDecodeError(e){Je.removeRecvCodecByProfile(e),0===Je.ingressCodecList.length?(te.globalTrace({logLevel:"error",log:"WMSC_No_Recv_Codec"}),ri("WMSC_ERC"),this.messageCallback({type:W.VIDEO_FAIL,data:oi})):this._sendRecvCodecPreference(He.zu.MainVideo)}_checkMsgIdForPC(e){const{msgID:t}=e,{offerMsgId:i}=this.pcInfo;return t===i||(ni.warn("Message id ".concat(t," doesn't match the offer message id ").concat(i)),!1)}_getNegotiationTime(){const e=this.negotiationTimeCost,t=[];if(e){const i=e.length;for(let a=0;a<i-1;a++)t.push(Math.round(e[a+1]-e[a]));t.push(Math.round(performance.now()-e[0]))}return t}_updateSoftwareCodecPreference(e){var t;let{videoSettings:i}=x.getConfig();var a;null!==(t=i)&&void 0!==t&&t.preferSoftwareCodec?i.preferSoftwareCodec=si(si({},null===(a=i)||void 0===a?void 0:a.preferSoftwareCodec),e):i={preferSoftwareCodec:e},x.setConfig({videoSettings:i})}_handleNewMLine(e){const{mediaType:t}=e;let i;if(t===He.zu.MainVideo)i=Je.addRecvVideoSDP(e),i.rtp_payload_type=Je.getRecvCodecPayloads();else if(t===He.zu.MainAudio){var a;i=null===(a=this._wmscAudioMgr)||void 0===a?void 0:a.addRecvAudioSDP(e)}else if(t===He.zu.ShareAudio){var s;i=null===(s=this._wmscAudioMgr)||void 0===s?void 0:s.addRecvAudioSDP(e)}this.createdMLine.push(i)}async doRenegotiation(){if("closed"===this.pc.signalingState)return;this.numOfTasks=this.renegotiationQueue.length;let e=!1;for(let i=0;i<this.numOfTasks;i++){const a=this.renegotiationQueue[i],{type:s,mediaType:n}=a;if(s===ci.ICE)e=a;else if(s===ci.REMOVE_MLINE){const{mid:e}=a,t=this.pc.getRecvTransceiverByMid(e);t&&t.stop()}else if(s===ci.ADD_MLINE){let e;if(n===He.zu.MainVideo)e=Je.addRecvTransceiver();else if(n===He.zu.MainAudio||n===He.zu.ShareAudio){var t;const{ssrcs:i,msid:s,user_id:r}=a,{rtp:o}=i;e=null===(t=this._wmscAudioMgr)||void 0===t?void 0:t.addRecvTransceiver(n,null==r?void 0:r.node_id,o,s,null==r?void 0:r.is_current)}a.transceiver=e.transceiver}}const i=[];try{await this.startNegotiation(!0,{iceRestart:!!e}),this.pc.removeUnusedTransceiver();for(let t=0;t<this.numOfTasks;t++){const n=this.renegotiationQueue[t],{type:r}=n;if(r===ci.ADD_MLINE)this._handleNewMLine(n),i.push("".concat(ci.ADD_MLINE,"-").concat(n.mediaType,"-").concat(n.transceiver.mid));else if(r===ci.REMOVE_MLINE){const{mid:e}=n;this.pc.removeMLineSDPFromAnswer(e),this.removedMids.push(e),i.push("".concat(ci.REMOVE_MLINE,"-").concat(e))}else if(r===ci.MEDIA){const{mediaType:e,preferSoftwareCodec:t}=n;if(e===He.zu.MainVideo)Je.updateEgressAnswerCodec(t);else if(e===He.zu.MainAudio){var a;this.updatedMlineFmtp.push(null===(a=this._wmscAudioMgr)||void 0===a?void 0:a.getUpdatedMlineFtmpFromLocalOffer())}i.push("".concat(ci.MEDIA,"-").concat(e,"-").concat(t))}else if(r===ci.ICE){var s;const{remoteIceCredential:t,generation_id:a}=e;this.pc.updateAnswerIceCredential(t),Je.updateRecvMLineTemp(t),null===(s=this._wmscAudioMgr)||void 0===s||s.updateRecvMLineTemp(t),i.push("".concat(ci.ICE,"-").concat(a))}else r===ci.UPDATE_BITRATE&&this.ongoingUpdateBitrateTasks.push(n)}if(this.ongoingUpdateBitrateTasks.length){const{bitrate:e}=this.ongoingUpdateBitrateTasks[this.ongoingUpdateBitrateTasks.length-1];Je.updateMinOutgoingBitrateInSDP(e),i.push("".concat(ci.UPDATE_BITRATE,"-").concat(e))}this.onSdpAnswer(null,!0),ri("WMSC_DORN: ".concat(i.join("|")))}catch(e){const{message:t}=e;te.globalTrace({logLevel:"error",log:"WMSC_SRNF: ".concat(t),errorEvent:e}),ri("WMSC_SRNF: ".concat(t))}}requestSelfRenegotiation(e){this._pushToRenegotiationQueue([{type:ci.MEDIA,mediaType:e}])}_pushToRenegotiationQueue(e){e.length&&(this.renegotiationQueue=this.renegotiationQueue.concat(e),this.pcInfo.isNegotitating||this.doRenegotiation())}_popRenegotiationQueue(){this.renegotiationQueue.splice(0,this.numOfTasks),this.renegotiationQueue.length&&!this.pcInfo.isNegotitating&&this.doRenegotiation()}_handleStreamRequest(e){var t,i;const a=[];this.lastStreamReqSeq=e.stream_request_msg_index;let s=[],n=[];if(e.delete&&e.delete.forEach((e=>{var t,i;null===(t=this._wmscAVSyncMgr)||void 0===t||t.deleteSRByMid(e),this.pc.getRecvTransceiverByMid(e)&&a.push({type:ci.REMOVE_MLINE,mid:e});const s=this.mIdMgr.getUserIdByMid(e);s&&kt.resetRecvStats(s),this.mIdMgr.removeMidResource(e),null===(i=this._wmscAudioMgr)||void 0===i||i.onMlineRemoved(e)})),e.create&&e.create.forEach((e=>{let{msid:t,media_type:i,ssrcs:n,user_id:r}=e,o="";r&&(o=this._getUserId(r)),o&&!t&&(t=this.mIdMgr.getMactchedMSIDByUserId(o)),i===He.zu.MainVideo?a.push({type:ci.ADD_MLINE,mediaType:He.zu.MainVideo,msid:t,ssrcs:n,user_id:r}):i!==He.zu.MainAudio&&i!==He.zu.ShareAudio||a.push({type:ci.ADD_MLINE,mediaType:i,msid:t,ssrcs:n,user_id:r}),s.push("".concat(i,"-").concat(o))})),e.associate&&e.associate.forEach((e=>{let{media_type:t,mid:i,user_id:a,ssrcs:s}=e;const{is_current:r}=a,o=this._getUserId(a);if(this.mIdMgr.attachMid(o,i,t,r),t===He.zu.MainAudio||t===He.zu.ShareAudio){var c;const{rtp:e}=s;null===(c=this._wmscAudioMgr)||void 0===c||c.onMlineAssignedNodeId(t,i,a.node_id,e,r)}n.push("".concat(t,"-").concat(i,"-").concat(o))})),e.ice_restart_resp){const{generation_id:t,ice_ufrag:i,ice_pwd:s}=e.ice_restart_resp;t===this.pcInfo.iceCredentialMsgId&&a.push({type:ci.ICE,remoteIceCredential:{ice_ufrag:i,ice_pwd:s},generation_id:t})}this._pushToRenegotiationQueue(a),ri("WMSC_SREQ:".concat(s.join(","),"|").concat((null===(t=e.delete)||void 0===t?void 0:t.join(","))||"","|").concat(n.join(","),"|").concat((null===(i=e.ice_restart_resp)||void 0===i?void 0:i.generation_id)||""))}_getUserId(e){const{node_id:t,is_current:i}=e;return 0==i?1|t:t}_handleSelfNegotiationSuccess(){let e=[];if(this.createdMLine.forEach((t=>{var i;let{mid:a,user_id:s,media_type:n,ssrcs:r}=t;const{rtp:o}=r;let c="";s&&(c=this._getUserId(s),this.mIdMgr.attachMid(c,a,n,s.is_current)),this.mIdMgr.ssrcMidMap.set(o,a),null==s||!s.node_id||n!==He.zu.MainAudio&&n!==He.zu.ShareAudio||null===(i=this._wmscAudioMgr)||void 0===i||i.onMlineAssignedNodeId(n,a,null==s?void 0:s.node_id,o,null==s?void 0:s.is_current),e.push("".concat(n,"-").concat(a,"-").concat(c))})),this.ongoingUpdateBitrateTasks.forEach(((e,t)=>{const{resolve:i,reject:a}=e;t===this.ongoingUpdateBitrateTasks.length-1?i():a()})),this.createdMLine.length||this.removedMids.length||this.updatedMlineFmtp.length){const t=mt(x.confId,this.createdMLine,this.removedMids,this.updatedMlineFmtp,null,null,this.lastStreamReqSeq,this.lastStreamStatusSeq);this._sendMessageToRwg({evt:dt,body:t}),ri("WMSC_SRES:".concat(e.join(","),"|").concat(this.removedMids.join(","),"|").concat(this.updatedMlineFmtp.join(","),"|").concat(this.lastStreamReqSeq,"|").concat(this.lastStreamStatusSeq)),this.lastStreamStatusSeq++}this.createdMLine=[],this.removedMids=[],this.updatedMlineFmtp=[],this.ongoingUpdateBitrateTasks=[],ri("WMSCNTS-".concat(this._getNegotiationTime().join("-")))}_sendRecvCodecPreference(e){if(e===He.zu.MainVideo){const t=Je.getRecvCodecPayloads();if(t.length>0){const i=mt(x.confId,null,null,null,[{media_type:e,rtp_payload_type:t}],null,this.lastStreamReqSeq,this.lastStreamStatusSeq);this._sendMessageToRwg({evt:dt,body:i}),ri("WMSC_SRCP:".concat(t.join(","),",").concat(this.lastStreamReqSeq,",").concat(this.lastStreamStatusSeq)),this.lastStreamStatusSeq++}}}_detectConnectionTimeout(){const{useIceServers:e,negotiationTimer:t}=this.pcInfo;t&&clearTimeout(t),this.pcInfo.isConnecting=!0,this.pcInfo.negotiationTimer=setTimeout((()=>{if(this.pcInfo.isConnecting=!1,"connected"!==this.pc.connectionState){var e,t;const i=this._getNegotiationTime();te.globalTrace({logLevel:"error",log:"WMSC Negotiation timeout: ".concat(this.pcInfo.useIceServers?1:0,"-").concat(i.length,"-").concat(this.pcInfo.offerMsgId,"-").concat(i.join("-"))}),te.globalTrace({logLevel:"error",log:"WMSC_PCCT: ".concat(null===(e=x.iceServers)||void 0===e?void 0:e.length,"|").concat(this.pc.connectionState)}),ri("WMSC_PCCT: ".concat(null===(t=x.iceServers)||void 0===t?void 0:t.length,"|").concat(this.pc.connectionState)),this._enableTURN(),this.pc.currentRemoteDescription?this.restartIce():this.restartNegotiation()}else this.pcInfo.iceRestartCount=0}),e?g:m)}_enableTURN(){const{useIceServers:e}=this.pcInfo;e||(te.globalTrace({logLevel:"directReport",log:"WMSC_USE_TURN"}),this.pcInfo.useIceServers=!0,this.pc.currentRemoteDescription&&this.pc.setConfiguration({iceServers:x.iceServers||[]}))}}(0,c.A)(di,"PC_UNKNOWN_CLOSE_CNT",0);const li=di,hi=te.getTracer("Wmsc"),ui=e=>{hi.log(e),te.monitorLog("".concat(e))};class mi{constructor(e,t){this.messageCallback=t,this.config=e,this.config.probe||(te.setTrace(),te.setTelemetry(t),kt.setTelemetry(t),ui("WMSC_INIT"))}setTrace(e,t){te.setTrace(e,t)}updateQosSubscription(e,t){kt.updateQosSubscription(e,t)}enableVideoObserver(e,t){kt.enableVideoObserver(e,t)}reportWMSCPeerConnectionRawStats(){kt.reportRawStats()}getHasPausedVideo(){var e;return null===(e=this.wmscApiImpl)||void 0===e||null===(e=e.mIdMgr)||void 0===e?void 0:e.getHasPausedVideo()}playAllUsedVideoTag(){var e;return null===(e=this.wmscApiImpl)||void 0===e||null===(e=e.mIdMgr)||void 0===e?void 0:e.playAllUsedVideoTag()}getUserIdVideo(e){var t;return null===(t=this.wmscApiImpl)||void 0===t?void 0:t.getUserIdVideo(e)}destroy(){var e;ui("WMSC_DESTROYED"),null===(e=this.wmscApiImpl)||void 0===e||e.destroy(),this.wmscApiImpl=null}onMessage(e,t){if(e!==F.NOTIFY_SDK_JOIN_RWG_SUCCESS&&!this.wmscApiImpl)return this.sendMessage&&this.sendMessage({type:W.ERROR,data:"WMSC on MediaSDK message, MediaSDK not ready, type = "+e}),hi.error("onMessage, the caller not ready type ".concat(e)),!1;switch(e){case F.NOTIFY_SDK_JOIN_RWG_SUCCESS:return this.messageCallback?(this.wmscApiImpl=new li(this.config,this.sendMessage.bind(this)),!0):(hi.error("onMessage, messageCallback to the caller not set"),!1);case F.NOTIFY_SDK_JOIN_RWG_FAILURE:return!0;case F.WMSC_MESSAGE_FROM_RWG:return this._onRwgMessage(t.data);case F.NOTIFY_WMSC_VIDEO_TAG_MAPPING:return this._onVideoTagMapping(t.data);case F.NOTIFY_SDK_SUBSCRIBE_VIDEO:return this._onSubscribeVideo(t.data);case F.NOTIFY_SDK_UNSUBSCRIBE_VIDEO:return this._onUnSubscribeVideo(t.data);case F.NOTIFY_SDK_ACTIVE_VIDEO_INDICATION:return this._onActiveVideoSourceChange(t.data);case F.UPDATE_WMSC_PARAMS:return this._onUpdateWmscParams(t.data);case F.UPDATE_VIDEO_SOURCE_SETTINGS:return this._updateVideoSourceSettings(t.data);default:return this.sendMessage({type:W.ERROR,data:"WSMC receive not handled event type = "+e}),hi.error("onMessage, unknown type ".concat(e)),ui("WSMC_Rece_U_E: ".concat(e)),!1}}onMessageAsync(e,t){return hi.log("WMSC_Recv_Async_M",e,JSON.stringify(t)),ui("WMSC_Recv_Async_M: ".concat(e)),e===F.VIDEO_STREAMS?this._onVideoStreamsAsync(t.data):(this.sendMessage({type:W.ERROR,data:"WSMC receive not handled event type =".concat(e)}),hi.error("WSMC receive not handled event type =".concat(e)),Promise.reject("Unknown message type"))}sendMessage(e){hi.log("sendMessage",JSON.stringify(e)),this.messageCallback&&this.messageCallback(e)}getWmscAudio(){return this.wmscApiImpl.getWMSCAudioMgr()}_onVideoStreamsAsync(e){return this.wmscApiImpl.onVideoStreamsAsync(e)}_onRwgMessage(e){return this.wmscApiImpl.onRwgMessage(e)}_onVideoTagMapping(e){return this.wmscApiImpl.onVideoTagMapping(e)}_onSubscribeVideo(e){return this.wmscApiImpl.subscribeVideo(e)}_onUnSubscribeVideo(e){return this.wmscApiImpl.unSubscribeVideo(e)}_onActiveVideoSourceChange(e){return this.wmscApiImpl.onActiveVideoSourceChange(e)}_onUpdateWmscParams(e){return this.wmscApiImpl.updateWmscParams(e)}_updateVideoSourceSettings(e){return this.wmscApiImpl.updateVideoSourceSettings(e)}getStats(){return this.wmscApiImpl.getStats()}}class pi{constructor(){this.status="pending",this.promise=new Promise(((e,t)=>{this.reject=e=>(this.status="rejected",t(e)),this.resolve=t=>(this.status="fullfilled",e(t))})),this.then=this.promise.then,this.catch=this.promise.catch}}var gi,Si,_i,vi=i(385),fi=i(7080),yi=i(7350),Mi=i.n(yi),Ci=i(1223),Ei=function(e,t,i,a){return new(i||(i=Promise))((function(s,n){function r(e){try{c(a.next(e))}catch(e){n(e)}}function o(e){try{c(a.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,o)}c((a=a.apply(e,t||[])).next())}))};!function(e){e.visibilitychange="visibilitychange",e.streamCaptureSuccess="streamCaptureSuccess",e.videoTrackUnmute="videoTrackUnmute",e.addRenderVideo="addRenderVideo",e.userClick="userClick",e.fromVBModule="fromVBModule",e.reuseCaptureStream="reuseCaptureStream"}(gi||(gi={})),function(e){e.destroy="destroy"}(Si||(Si={})),function(e){e.WMSC_WSS_OPEN_FAIL="WMSC_WSS_OPEN_FAIL",e.WMSC_WSS_CLOSE="WMSC_WSS_CLOSE",e.WMSC_WSS_ERROR="WMSC_WSS_ERROR",e.WMSC_WSS_RECV_TIMEOUT="WMSC_WSS_RECV_TIMEOUT",e.WMSC_SDP_NEGOTIATION_FAIL="WMSC_SDP_NEGOTIATION_FAIL",e.WMSC_PC_FAIL="WMSC_PC_FAIL",e.WMSC_VIDEO_FAIL="WMSC_VIDEO_FAIL",e.WMSC_PC_CLOSED="WMSC_PC_CLOSED"}(_i||(_i={}));class Ii{constructor(e){if(this._config={webRTCWebSocketUrl:"",confId:"",nodeId:"",hdVideoEnabled:!1,mediaStreamController:void 0,iceServers:[],videoCodecConfig:void 0,webrtcMode:0,probe:!1,requestHandler:null},this._websocket=null,this._wmsc=null,this._isDestroyed=!1,this._qosFlag=new Set,this.isJoinRWGSuccess=!1,this._joinRWGSuccessPromise=new pi,this._initAudioSuccessPromise=new pi,this._wssReconnectAttempts=0,this._wssOpened=!1,this._lastTimeStamp=0,this.selfVideoDomMap=new Map,this.activeSpeakerVideoDom=null,this._selfStream=null,this._activeSpeakerSsrc=-1,this.isMirror=!1,this._vbSettingVideoDom=null,this._notifyAudioSuccess=!1,this._sourceVideoSettings=null,this.meetingEnded=!1,this._recreateWssOrFailover=e=>{var t;if(clearTimeout(this._wssReconnectTimer),null===(t=this._websocket)||void 0===t||t.close(),void 0!==e){let t=!1;if(this._wssOpened){const i=Date.now(),a=jt.A.webrtcFailoverHistory;if(!(a.length>=3&&i-a[a.length-3]<4e4))return a.push(i),void this._triggerFailover(e);vi.Ay.error("WMSC_Failover_Reach_Limit: ".concat(e,",").concat(a.slice(-3).join(","),",").concat(i)),t=!0}else this._wssReconnectAttempts++,this._wssReconnectAttempts>3&&(vi.Ay.error("WMSC_WSS_Reconnect_Reach_Limit: ".concat(e,",").concat(this._wssReconnectAttempts)),t=!0);if(t)return void jt.A.Notify_APPUI(Gt.T0Q,{audio:this._config.webrtcMode&yt.h?1:0,video:this._config.webrtcMode&yt.Q9?1:0})}const{webRTCWebSocketUrl:i}=this._config;this._websocket=(0,At.Gj)(i),this._wssOpened=!1,this._websocket.onopen=this._onOpen,this._websocket.onclose=this._onClose,this._websocket.onmessage=this._onMessage,this._websocket.onerror=this._onError,this.wmscAddMonitorLog("WMSC_Create_WSS:".concat(i.replace(/(\/media\/)\d+/,"$1".concat("meetingNumber")))),this._wssReconnectTimer=setTimeout((()=>{this._recreateWssOrFailover(_i.WMSC_WSS_OPEN_FAIL)}),2e4)},this._onOpen=()=>{if(this._wssOpened=!0,clearTimeout(this._wssReconnectTimer),this._wssReconnectAttempts=0,!this._wmsc){const{confId:e,nodeId:t,hdVideoEnabled:i,iceServers:a,videoCodecConfig:s,webrtcMode:n,probe:r,avSyncMode:o}=this._config,c=(0,de.j4)();if(this.wmscAddMonitorLog("WMSC_Instance_Params: ".concat(e,"|").concat(t,"|").concat(i,"|").concat(c,"}")),!e)return;const d={confId:e,nodeId:t||"",isMacIntel:c,iceServers:a,videoSettings:Object.assign(Object.assign({},s),{maxCaptureVideoSize:3,maxRecvVideoNum:this._config.probe?1:26,hdVideoEnabled:i}),webrtcMode:n,probe:r,avSyncMode:o};this._wmsc=new mi(d,this._wmscCallBack),this.sendMessageToWMSC({type:F.NOTIFY_SDK_JOIN_RWG_SUCCESS,data:""}),this.isJoinRWGSuccess=!0,this._joinRWGSuccessPromise.resolve()}},this._isKeepAliveMessage=e=>{let t=!0;for(let i=0;i<4;i++)if(0!==e[i]){t=!1;break}return t},this._checkReceiveTimeout=()=>{clearTimeout(this._keepAliveTimer),this._keepAliveTimer=setTimeout((()=>{this._triggerFailover(_i.WMSC_WSS_RECV_TIMEOUT)}),3e4)},this._replyActiveAliveMessage=e=>{(null==e?void 0:e.data)instanceof Blob&&At.Ay.readBlobAsBuffer(e.data).then((e=>{var t;const i=new Int8Array(e);this._isKeepAliveMessage(i)&&(null===(t=this._websocket)||void 0===t||t.send(i))})).catch((e=>{vi.Ay.error("WMSC_Read_Alive_F",e)}))},this._onMessage=e=>{var t,i;if((null===(t=this._websocket)||void 0===t?void 0:t.isRlb)||(this._checkReceiveTimeout(),this._replyActiveAliveMessage(e)),!((null==e?void 0:e.data)instanceof Blob)&&this._wmsc){if(e.data&&"string"==typeof e.data){let t,a,s;try{const{evt:i="",body:{reason:n,subReason:r}}=JSON.parse(e.data);t=i,a=n,s=r}catch(e){return void vi.Ay.error("WMSC_Unexpect_Wsss_Message",e)}if(t===Gt.zag&&(!(null===(i=jt.A.shouldKeepAVWhenFailover)||void 0===i?void 0:i.waitingRoom)||5!==a||1!==s)){this.meetingEnded=!0;const e="WMSC_Meeting_Ended_Indicat: ".concat(Date.now());this.wmscAddMonitorLog(e),vi.Ay.error(e)}}this.sendMessageToWMSC({type:F.WMSC_MESSAGE_FROM_RWG,data:e})}},this._onClose=e=>{const t="".concat(e.code,"|").concat(this._isDestroyed,"|").concat(this.meetingEnded);1e3!==e.code?(this.wmscAddMonitorLog("WMSC_WSS_CLOSE: ".concat(t)),this._recreateWssOrFailover(_i.WMSC_WSS_CLOSE)):this.wmscAddMonitorLog("WMSC_WSS_NORMAL_CLOSE: ".concat(t))},this._onError=e=>{this._recreateWssOrFailover(_i.WMSC_WSS_ERROR)},this._triggerFailover=e=>{if(this._config.probe)return;const t=(0,At.Tv)();let i="".concat(t),a=!1,s=!1;switch(e){case _i.WMSC_WSS_OPEN_FAIL:i="WMSC_WSS_OPEN_FAIL:"+i;break;case _i.WMSC_WSS_RECV_TIMEOUT:i="WMSC_WSS_RECV_FAIL:"+i;break;case _i.WMSC_SDP_NEGOTIATION_FAIL:i="WMSC_SDP_NEGO_F:"+i,s=!0,this._config.webrtcMode&yt.Q9||(a=!0);break;case _i.WMSC_PC_FAIL:i="WMSC_PC_F:"+i,a=!!(this._config.webrtcMode&yt.h),s=!!(this._config.webrtcMode&yt.Q9);break;case _i.WMSC_VIDEO_FAIL:i="WMSC_VIDEO_F:"+i,s=!0;break;case _i.WMSC_PC_CLOSED:i="WMSC_PC_CLOSED:"+i;break;default:i="WMSC_FAILOVER_UNEXPECT:"+i}if((this._isDestroyed||this.meetingEnded)&&vi.Ay.log("WMSC destroyed or meeting end, but try failover : ".concat(i,"|").concat(s,"|").concat(a,"|").concat(this._isDestroyed,"|").concat(this.meetingEnded)),!this._isDestroyed&&!this.meetingEnded){this.destroy(),jt.A.supportAVSimultaneousFallback&&(a||s)&&(vi.Ay.directReport("audio and video fallback together, audioFailover: ".concat(a,", videoFailover: ").concat(s)),a=!0,s=!0);const e="".concat(i,"|").concat(s,"|").concat(a);this.wmscAddMonitorLog(i),vi.Ay.error(e),jt.A.Notify_APPUI(Gt.oQY,{audio:a?yt.nm:0,video:s?1:0})}},this._disconnect=e=>{var t;const i="WMSC_WSS_Dissconn: ".concat(e,"|").concat(null===(t=null==this?void 0:this._websocket)||void 0===t?void 0:t.readyState);this.wmscAddMonitorLog(i),vi.Ay.log(i),!this._websocket||this._websocket.readyState!==WebSocket.CONNECTING&&this._websocket.readyState!==WebSocket.OPEN||this._websocket.close()},this.sendMessageToWMSC=e=>{var t;(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.data)instanceof Blob||this._wmsc&&this._wmsc.onMessage(e.type,e)},this.sendMessageToWMSCAsync=e=>this._wmsc?this._wmsc.onMessageAsync(e.type,e):Promise.reject("this._wmsc is undefined"),this._wmscCallBack=e=>{var t,i,a,s,n,r,o,c,d,l,h;if(!e)return;const{type:u,data:m}=e;switch(u){case W.WMSC_MESSAGE_TO_RWG_BY_SDK:this.sendMesssageToRWG(m);break;case W.SDP_NEGOTIATION_FAIL:null===(i=(t=this._config).requestHandler)||void 0===i||i.call(t,"negotiationResult",!1),this._triggerFailover(_i.WMSC_SDP_NEGOTIATION_FAIL);break;case W.PC_FAIL:null===(s=(a=this._config).requestHandler)||void 0===s||s.call(a,"negotiationResult",!1),this._triggerFailover(_i.WMSC_PC_FAIL);break;case W.VIDEO_FAIL:null===(r=(n=this._config).requestHandler)||void 0===r||r.call(n,"negotiationResult",!1),this._triggerFailover(_i.WMSC_VIDEO_FAIL);break;case W.PC_CLOSED:this._triggerFailover(_i.WMSC_PC_CLOSED);break;case W.GLOBAL_TRACE:{const{logLevel:e,log:t,errorEvent:i,tags:a}=m;vi.Ay[e](t,i||a);break}case W.MONITOR:this.wmscAddMonitorLog(m);break;case W.DIRECT_MONITOR:fi.A.send_monitor_directly(m);break;case W.VIDEO_QOS_DATA:jt.A.Notify_APPUI(Gt.PgM,m);break;case W.CURRENT_DECODE_VIDEO_QUALITY:jt.A.Notify_APPUI(Gt.TaW,m);break;case W.CURRENT_DECODE_VIDEO_FPS:jt.A.Notify_APPUI(Gt.$xb,m);break;case W.NETWORK_QUALITY_CHANGE:jt.A.Notify_APPUI(Gt.Ah8,m);break;case W.UPDATE_VIDEO_CAPTURE_CONSTRAINTS:(null===(o=this._config.mediaStreamController)||void 0===o?void 0:o.isUsingFileInputVideoSource())||this._updateVideoConstraints(m);break;case W.VIDEO_CAPABILITIES_CHANGE:this._websocket.send(JSON.stringify({evt:Gt.I6S,body:{fullHDOption:m.maxRecvVideoSize>=4?1:0}}));break;case W.PC_CONNECTED:null===(d=(c=this._config).requestHandler)||void 0===d||d.call(c,"negotiationResult",!0),this._config.webrtcMode&yt.h&&(this._initAudioSuccessPromise.resolve(),jt.A.Notify_APPUI(Gt.LYk,{mediaType:"audio"})),this._config.webrtcMode&yt.Q9&&jt.A.Notify_APPUI(Gt.LYk,{mediaType:"video"});break;case W.UPDATE_VIDEO_SUBSCRIPTION:Ci.A.sendSubscribeVideoMsgToRWG(m);break;case W.UPDATE_VIDEO_UNSUBSCRIPTION:Ci.A.sendUnsubscribeVideoMsgToRWG(m);break;case W.AUDIO_RECAPTURE:null===(h=(l=this._config).requestHandler)||void 0===h||h.call(l,"audioRecapture",!0);break;case W.ERROR_MESSAGE:this.handleWMSCErrorMsg(m)}},this.waitJoinRWGSuccess=()=>this._joinRWGSuccessPromise.promise,this.waitInitAudioSuccess=()=>this._initAudioSuccessPromise.promise,this.getConnectionId=()=>this._config.confId,this.updateQosSubscription=(e,t,i)=>{var a,s;e?(this._qosFlag.add(t),null===(a=this._wmsc)||void 0===a||a.updateQosSubscription(e,i)):(this._qosFlag.delete(t),0===this._qosFlag.size&&(null===(s=this._wmsc)||void 0===s||s.updateQosSubscription(e,i)))},this.playAllVideoTag=e=>{this.selfVideoDomMap.forEach((t=>{t.paused&&this.playSelfVideo(e,t)}))},this.playSelfVideo=(e,t)=>{var i;let a="";"visible"!==document.visibilityState&&(a="WMSC_SV_V_F: ".concat(document.visibilityState,"-").concat(e)),t||(a="WMSC_SV_DOM_F: ".concat(e)),t.srcObject||(a="WMSC_SV_SRC_F: ".concat(e));const s=null===(i=null==t?void 0:t.srcObject)||void 0===i?void 0:i.getVideoTracks();if(Array.isArray(s)&&s[0]&&s[0].muted&&(a="WMSC_SV_TM_F: ".concat(document.visibilityState,"-").concat(e)),t.paused||(a="WMSC_SV_P_F: ".concat(e)),a)return this.wmscAddMonitorLog(a),void vi.Ay.error(a);t.readyState>t.HAVE_CURRENT_DATA||t.play().then((()=>{this.wmscAddMonitorLog("WMSC_SV_SUCCESS: ".concat(e))})).catch((t=>{a="WMSC_SV_P_E: ".concat(e,"|").concat(t.name,":").concat(t.message),this.wmscAddMonitorLog(a),vi.Ay.error(a,t)}))},this.setNodeId=e=>{this._config.nodeId!==e&&(this._config.nodeId=e,this.sendMessageToWMSC({type:F.UPDATE_WMSC_PARAMS,data:{nodeId:e}}))},this.getUserIdVideo=e=>{var t;return 1==e?[this.activeSpeakerVideoDom]:this.isSelfVideo(e)?[Array.from(this.selfVideoDomMap.values()).find((e=>!e.paused))]:null===(t=this._wmsc)||void 0===t?void 0:t.getUserIdVideo(e)},this.mirrorVideoEle=(e,t)=>{const i="rotateY(".concat(t?180:0,"deg)");let a=e.style.transform;const s=-1!==a.indexOf("rotateY");(t||s)&&-1===a.indexOf(i)&&(s?a=a.replace(/rotateY\([0-9]+(deg)?\)/,i):a+=" ".concat(i),e.style.transform=a)},this.mirrorSelfVideo=e=>{if(this.isMirror=e,this.selfVideoDomMap.size>0&&this.selfVideoDomMap.forEach((e=>{this.mirrorVideoEle(e,this.isMirror)})),this.activeSpeakerVideoDom&&this._isSelfActiveSpeaker()&&this.mirrorVideoEle(this.activeSpeakerVideoDom,this.isMirror),this.vbSettingVideoDom&&this.mirrorVideoEle(this.vbSettingVideoDom,this.isMirror),this.selfVideoDomMap.size<=0&&!this.activeSpeakerVideoDom&&!this.vbSettingVideoDom){const t="WMSC_MIRROR_F:".concat(e);this.wmscAddMonitorLog(t),vi.Ay.error(t)}},this.wmscAddMonitorLog=e=>{this._config.probe||fi.A.add_monitor(e)},this.onActiveSpeakerChange=e=>{this.sendMessageToWMSC({type:F.NOTIFY_SDK_ACTIVE_VIDEO_INDICATION,data:{userId:e}}),this._activeSpeakerSsrc=e,this._updateActiveSpeakerStream()},this._updateActiveSpeakerStream=()=>{this.activeSpeakerVideoDom&&(this._isSelfActiveSpeaker()?this._selfStream&&(this.activeSpeakerVideoDom.srcObject=this._selfStream,this.mirrorVideoEle(this.activeSpeakerVideoDom,this.isMirror)):this.mirrorVideoEle(this.activeSpeakerVideoDom,!1))},this.isSelfVideo=e=>{const{nodeId:t}=this._config;return(0,At.XF)(e)===(0,At.XF)(t)},this.handleWMSCErrorMsg=e=>{if(this._config.probe)return;const{type:t}=e;switch(t){case"WEBRTC_VIDEO_HEALTH_CHECK_FAILED":this._triggerFailover(_i.WMSC_VIDEO_FAIL);break;case"PC_RECONNECT":(0,Kt.iK)(Gt.ZSj,e)}},this.destroy=()=>{var e,t;clearTimeout(this._wssReconnectTimer),clearTimeout(this._keepAliveTimer),this._cleanUserEventListener&&this._cleanUserEventListener(),this.selfVideoDomMap.clear(),null===(e=this._wmsc)||void 0===e||e.destroy(),this._wmsc=null,null===(t=this._websocket)||void 0===t||t.close(),this._websocket=null,this.isJoinRWGSuccess=!1,this._isDestroyed=!0},this._isDestroyed=!1,this._config=Object.assign(this._config,e),this._recreateWssOrFailover(),this._config.probe)return;this._throttlePlayAllVideoTag=Mi()(this.playAllVideoTag,500);const t=zt.A.on(Gt.gh2.USER_EVENT,(()=>this._throttlePlayAllVideoTag(gi.userClick)));this._cleanUserEventListener=()=>zt.A.unsubscribe(t),document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState&&this._throttlePlayAllVideoTag(gi.visibilitychange)}))}sendMesssageToRWG(e){var t;this._websocket&&this._websocket.readyState===WebSocket.OPEN?"object"==typeof e?this._websocket.send(JSON.stringify(e)):this._websocket.send(e):vi.Ay.error("WMSC_Wsss_Message_Status_Error: ".concat(null===(t=this._websocket)||void 0===t?void 0:t.readyState,", msg: ").concat(e))}enableVideoObserver(e,t){var i;null===(i=this._wmsc)||void 0===i||i.enableVideoObserver(e,t)}reportWMSCPeerConnectionRawStats(){var e;null===(e=this._wmsc)||void 0===e||e.reportWMSCPeerConnectionRawStats()}addSelfVideoDom(e,t){this.selfVideoDomMap.set(e,t),this.mirrorVideoEle(t,this.isMirror),this.playSelfVideo(gi.addRenderVideo,t)}removeSelfVideoDom(e){this.selfVideoDomMap.delete(e)}updateSelfVideoStream(e,t){this.selfVideoDomMap.forEach((i=>{i.srcObject=t,this.playSelfVideo(e,i)}))}publishVideoStream(e){return Ei(this,arguments,void 0,(function(e){var t=this;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return function*(){const a=[];t.streamId=e.id,t._selfStream=e,t._updateActiveSpeakerStream(),t._monitorSourceVideo(e),i&&i!==e&&a.push({stream:i}),a.push({stream:e}),yield t.sendMessageToWMSCAsync({type:F.VIDEO_STREAMS,data:a})}()}))}unpublishVideoStream(){return Ei(this,void 0,void 0,(function*(){this._selfStream=null,this._sourceVideoDom&&(this._sourceVideoDom.srcObject=null),yield this.sendMessageToWMSCAsync({type:F.VIDEO_STREAMS,data:[]})}))}_monitorSourceVideo(e){if(this._sourceVideoDom)return void(this._sourceVideoDom.srcObject=e||null);const t=pt.A.createVideoElement();t.autoplay=!1,t.muted=!0,t.playsInline=!0,t.style.display="none",t.srcObject=e||null,t.onresize=()=>{const{videoWidth:e,videoHeight:i}=t;this._maybeUpdateVideoSourceSettings(e,i)},this._sourceVideoDom=t}_maybeUpdateVideoSourceSettings(e,t){const{width:i,height:a}=this._sourceVideoSettings||{};i===e&&a===t||i===t&&a===e||(this._sourceVideoSettings=Object.assign(Object.assign({},this._sourceVideoSettings),{width:e,height:t}),this.wmscAddMonitorLog("WMSC_Update_V_Settings: ".concat(e,"|").concat(t)),this.sendMessageToWMSC({type:F.UPDATE_VIDEO_SOURCE_SETTINGS,data:{settings:this._sourceVideoSettings}}))}_updateVideoConstraints(e){return Ei(this,void 0,void 0,(function*(){const{width:t,height:i,frameRate:a}=e,{mediaStreamController:s}=this._config;s&&!this._isDestroyed&&t&&i&&a?s.changeVideoResolution(t,i,a,!0).then((()=>{this.sendMessageToWMSC({type:F.UPDATE_VIDEO_SOURCE_SETTINGS,data:{}}),fi.A.add_monitor("WMSC_Update_V_Constraints_S: ".concat(t,"|").concat(i,"|").concat(a))})).catch((e=>{this.wmscAddMonitorLog("WMSC_Update_V_Constraints_E: ".concat(t,"|").concat(i,"|").concat(a,",").concat(null==e?void 0:e.name,":").concat(null==e?void 0:e.message)),vi.Ay.error("WMSC_Update_V_Constraints_E",e)})):this.wmscAddMonitorLog("WMSC_Update_V_Constraints_F: ".concat(!!s,"|").concat(this._isDestroyed,"|").concat(t,"|").concat(i,"|").concat(a))}))}_isSelfActiveSpeaker(){const{nodeId:e}=this._config;return(0,At.XF)(this._activeSpeakerSsrc)===(0,At.XF)(e)}set vbSettingVideoDom(e){this._vbSettingVideoDom=e,this._vbSettingVideoDom&&(this._vbSettingVideoDom.setAttribute("autoplay","true"),this._vbSettingVideoDom.setAttribute("playsinline","true"),this._vbSettingVideoDom.muted=!0,this.isMirror&&this.mirrorVideoEle(this._vbSettingVideoDom,this.isMirror),this._selfStream&&(this._vbSettingVideoDom.srcObject=this._selfStream))}get vbSettingVideoDom(){return this._vbSettingVideoDom}setActiveSpeakerVideoDom(e){this.activeSpeakerVideoDom=e,this.activeSpeakerVideoDom&&this._updateActiveSpeakerStream()}getWMSCAudio(){var e;return null===(e=this._wmsc)||void 0===e?void 0:e.getWmscAudio()}getStats(){var e;return null===(e=this._wmsc)||void 0===e?void 0:e.getStats()}isDestroyed(){return this._isDestroyed}}},7007:e=>{"use strict";var t,i="object"==typeof Reflect?Reflect:null,a=i&&"function"==typeof i.apply?i.apply:function(e,t,i){return Function.prototype.apply.call(e,t,i)};t=i&&"function"==typeof i.ownKeys?i.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var s=Number.isNaN||function(e){return e!=e};function n(){n.init.call(this)}e.exports=n,e.exports.once=function(e,t){return new Promise((function(i,a){function s(i){e.removeListener(t,n),a(i)}function n(){"function"==typeof e.removeListener&&e.removeListener("error",s),i([].slice.call(arguments))}g(e,t,n,{once:!0}),"error"!==t&&function(e,t){"function"==typeof e.on&&g(e,"error",t,{once:!0})}(e,s)}))},n.EventEmitter=n,n.prototype._events=void 0,n.prototype._eventsCount=0,n.prototype._maxListeners=void 0;var r=10;function o(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function c(e){return void 0===e._maxListeners?n.defaultMaxListeners:e._maxListeners}function d(e,t,i,a){var s,n,r,d;if(o(i),void 0===(n=e._events)?(n=e._events=Object.create(null),e._eventsCount=0):(void 0!==n.newListener&&(e.emit("newListener",t,i.listener?i.listener:i),n=e._events),r=n[t]),void 0===r)r=n[t]=i,++e._eventsCount;else if("function"==typeof r?r=n[t]=a?[i,r]:[r,i]:a?r.unshift(i):r.push(i),(s=c(e))>0&&r.length>s&&!r.warned){r.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+r.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=e,l.type=t,l.count=r.length,d=l,console&&console.warn&&console.warn(d)}return e}function l(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function h(e,t,i){var a={fired:!1,wrapFn:void 0,target:e,type:t,listener:i},s=l.bind(a);return s.listener=i,a.wrapFn=s,s}function u(e,t,i){var a=e._events;if(void 0===a)return[];var s=a[t];return void 0===s?[]:"function"==typeof s?i?[s.listener||s]:[s]:i?function(e){for(var t=new Array(e.length),i=0;i<t.length;++i)t[i]=e[i].listener||e[i];return t}(s):p(s,s.length)}function m(e){var t=this._events;if(void 0!==t){var i=t[e];if("function"==typeof i)return 1;if(void 0!==i)return i.length}return 0}function p(e,t){for(var i=new Array(t),a=0;a<t;++a)i[a]=e[a];return i}function g(e,t,i,a){if("function"==typeof e.on)a.once?e.once(t,i):e.on(t,i);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function s(n){a.once&&e.removeEventListener(t,s),i(n)}))}}Object.defineProperty(n,"defaultMaxListeners",{enumerable:!0,get:function(){return r},set:function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");r=e}}),n.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},n.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},n.prototype.getMaxListeners=function(){return c(this)},n.prototype.emit=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var s="error"===e,n=this._events;if(void 0!==n)s=s&&void 0===n.error;else if(!s)return!1;if(s){var r;if(t.length>0&&(r=t[0]),r instanceof Error)throw r;var o=new Error("Unhandled error."+(r?" ("+r.message+")":""));throw o.context=r,o}var c=n[e];if(void 0===c)return!1;if("function"==typeof c)a(c,this,t);else{var d=c.length,l=p(c,d);for(i=0;i<d;++i)a(l[i],this,t)}return!0},n.prototype.addListener=function(e,t){return d(this,e,t,!1)},n.prototype.on=n.prototype.addListener,n.prototype.prependListener=function(e,t){return d(this,e,t,!0)},n.prototype.once=function(e,t){return o(t),this.on(e,h(this,e,t)),this},n.prototype.prependOnceListener=function(e,t){return o(t),this.prependListener(e,h(this,e,t)),this},n.prototype.removeListener=function(e,t){var i,a,s,n,r;if(o(t),void 0===(a=this._events))return this;if(void 0===(i=a[e]))return this;if(i===t||i.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete a[e],a.removeListener&&this.emit("removeListener",e,i.listener||t));else if("function"!=typeof i){for(s=-1,n=i.length-1;n>=0;n--)if(i[n]===t||i[n].listener===t){r=i[n].listener,s=n;break}if(s<0)return this;0===s?i.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(i,s),1===i.length&&(a[e]=i[0]),void 0!==a.removeListener&&this.emit("removeListener",e,r||t)}return this},n.prototype.off=n.prototype.removeListener,n.prototype.removeAllListeners=function(e){var t,i,a;if(void 0===(i=this._events))return this;if(void 0===i.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==i[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete i[e]),this;if(0===arguments.length){var s,n=Object.keys(i);for(a=0;a<n.length;++a)"removeListener"!==(s=n[a])&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=i[e]))this.removeListener(e,t);else if(void 0!==t)for(a=t.length-1;a>=0;a--)this.removeListener(e,t[a]);return this},n.prototype.listeners=function(e){return u(this,e,!0)},n.prototype.rawListeners=function(e){return u(this,e,!1)},n.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):m.call(e,t)},n.prototype.listenerCount=m,n.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]}},8048:(e,t,i)=>{e.exports=i(6083)},3148:(e,t,i)=>{"use strict";var a=i(8280),s=i(1310),n=String.prototype;e.exports=function(e){var t=e.trimStart;return"string"==typeof e||e===n||a(n,e)&&t===n.trimStart?s:t}},1310:(e,t,i)=>{"use strict";i(1454);var a=i(1747);e.exports=a("String","trimLeft")},9419:(e,t,i)=>{"use strict";var a=i(5993).start,s=i(5819);e.exports=s("trimStart")?function(){return a(this)}:"".trimStart},9793:(e,t,i)=>{"use strict";var a=i(1091),s=i(9419);a({target:"String",proto:!0,name:"trimStart",forced:"".trimLeft!==s},{trimLeft:s})},1454:(e,t,i)=>{"use strict";i(9793);var a=i(1091),s=i(9419);a({target:"String",proto:!0,name:"trimStart",forced:"".trimStart!==s},{trimStart:s})},6083:(e,t,i)=>{"use strict";var a=i(3148);e.exports=a}}]);
//# sourceMappingURL=https://d1cdksi819e9z7.cloudfront.net/sourcemap/wmsc.min.js-bb7852b6fa4fb60b5153.map