(self.webpackChunkJsMediaSDK_Instance=self.webpackChunkJsMediaSDK_Instance||[]).push([[557],{3136:(e,t,i)=>{"use strict";i.r(t),i.d(t,{WMSCManager:()=>mi,eventExt:()=>W});var s={};i.r(s),i.d(s,{TO:()=>I,NS:()=>A,mz:()=>E,GA:()=>b,FK:()=>_,pO:()=>S,fZ:()=>v,Rz:()=>L,r3:()=>w,By:()=>D,ey:()=>M,rF:()=>R,wK:()=>g,LA:()=>B,tT:()=>N,ul:()=>u,j$:()=>m,Y7:()=>p,RJ:()=>h,bl:()=>y,Dz:()=>P,c$:()=>O,lN:()=>C,zk:()=>V,nd:()=>o,ue:()=>k,pg:()=>f,S$:()=>T,tP:()=>a,qe:()=>U});var a,n,o,r,c=i(7857),d=i(129),l=i.n(d);!function(e){e[e.ERROR=0]="ERROR",e[e.WARN=1]="WARN",e[e.INFO=2]="INFO",e[e.DEBUG=3]="DEBUG",e[e.VERBOSE=4]="VERBOSE"}(a||(a={})),function(e){e[e._90P=0]="_90P",e[e._180P=1]="_180P",e[e._360P=2]="_360P",e[e._720P=3]="_720P",e[e._1080P=4]="_1080P",e[e._2160P=5]="_2160P"}(n||(n={})),function(e){e[e.AUDIO=1]="AUDIO",e[e.VIDEO=2]="VIDEO",e[e.SHARE=3]="SHARE"}(o||(o={})),function(e){e[e.VIDEO=1]="VIDEO",e[e.AUDIO=2]="AUDIO",e[e.SHARE=3]="SHARE"}(r||(r={}));const h=0;var u;!function(e){e[e.IDLE=0]="IDLE",e[e.CONNECTING=1]="CONNECTING",e[e.CONNECTED=2]="CONNECTED"}(u||(u={}));const m=6e3,p=2e3,g=1e4,S=3,_=3,v=3,f=15e3;var M,y,C;!function(e){e.STREAM="STREAM",e.SDP="SDP",e.PC_STATE_CHANGE="PC_STATE_CHANGE",e.UPDATE_BITRATE="UPDATE_BITRATE",e.ERROR="ERROR"}(M||(M={})),function(e){e.LAYERS_UPDATE="LAYERS_UPDATE",e.MIN_BITRATE_UPDATE="MIN_BITRATE_UPDATE",e.ENCODER_RESET="ENCODER_RESET"}(y||(y={})),function(e){e[e.NONE=0]="NONE",e[e.UNDERUSING=1]="UNDERUSING",e[e.NORMAL=2]="NORMAL",e[e.OVERUSING=3]="OVERUSING"}(C||(C={}));const I=1;var T;!function(e){e[e.PLAIN=0]="PLAIN",e[e.GZIP_BASE64=1]="GZIP_BASE64"}(T||(T={}));const R=2,b=100,E=62464,A=17120,w=26,L=w+1,D=16,P=299,O=6;var N,B,V,k;!function(e){e[e.NET_QUALITY_UNKNOWN=-1]="NET_QUALITY_UNKNOWN",e[e.NET_QUALITY_VERY_BAD=0]="NET_QUALITY_VERY_BAD",e[e.NET_QUALITY_BAD=1]="NET_QUALITY_BAD",e[e.NET_QUALITY_NOT_GOOD=2]="NET_QUALITY_NOT_GOOD",e[e.NET_QUALITY_NORMAL=3]="NET_QUALITY_NORMAL",e[e.NET_QUALITY_GOOD=4]="NET_QUALITY_GOOD",e[e.NET_QUALITY_EXCELLENT=5]="NET_QUALITY_EXCELLENT"}(N||(N={})),function(e){e[e.NET_BW_LEVEL_UNKNOWN=-1]="NET_BW_LEVEL_UNKNOWN",e[e.NET_BW_LEVEL_VERY_LOW=0]="NET_BW_LEVEL_VERY_LOW",e[e.NET_BW_LEVEL_LOW=1]="NET_BW_LEVEL_LOW",e[e.NET_BW_LEVEL_NORMAL=2]="NET_BW_LEVEL_NORMAL"}(B||(B={})),function(e){e[e.ICE=0]="ICE",e[e.MEDIA=1]="MEDIA",e[e.ADD_MLINE=2]="ADD_MLINE",e[e.REMOVE_MLINE=3]="REMOVE_MLINE",e[e.UPDATE_BITRATE=4]="UPDATE_BITRATE"}(V||(V={})),function(e){e[e.HD_VIDEO=2097152]="HD_VIDEO",e[e.FULL_HD_VIDEO=4096]="FULL_HD_VIDEO",e[e.DUAL_CALL=1]="DUAL_CALL",e[e.AV1_CODEC=262144]="AV1_CODEC"}(k||(k={}));const U="WMSC_DETECT_CANPLAY_VIDEO",x=new class{constructor(){this.confId="",this.nodeId="",this.webrtcMode=0,this.isMacIntel=!1,this.videoSettings={maxCaptureVideoSize:4,maxRecvVideoNum:w,hdVideoEnabled:!1},this._enabledLayerIds=[],this._layersSettings=null,this.iceServers=[]}setConfig(e){const{confId:t,nodeId:i,webrtcMode:s,isMacIntel:a,videoSettings:n,qosOptions:o,iceServers:r}=e;void 0!==t&&(this.confId=t),void 0!==i&&(this.nodeId=i),void 0!==s&&(this.webrtcMode=s),void 0!==a&&(this.isMacIntel=a),void 0!==n&&(this.videoSettings=Object.assign(Object.assign({},this.videoSettings),n)),void 0!==o&&(this.qosOptions=o),null!=r&&(this.iceServers=r||[])}getConfig(){const{confId:e,nodeId:t,webrtcMode:i,isMacIntel:s,videoSettings:a,qosOptions:n,iceServers:o}=this;return{confId:e,nodeId:t,webrtcMode:i,isMacIntel:s,videoSettings:a,qosOptions:n,iceServers:o}}setEnabledLayerIds(e){this._enabledLayerIds=e}get enabledLayerIds(){return this._enabledLayerIds}setLayersSettings(e){this._layersSettings=e}get layersSettings(){return this._layersSettings}};var W,F;!function(e){e.NOTIFY_SDK_JOIN_RWG_SUCCESS="NOTIFY_SDK_JOIN_RWG_SUCCESS",e.NOTIFY_SDK_JOIN_RWG_FAILURE="NOTIFY_SDK_JOIN_RWG_FAILURE",e.VIDEO_STREAMS="VIDEO_STREAMS",e.WMSC_MESSAGE_FROM_RWG="WMSC_MESSAGE_FROM_RWG",e.NOTIFY_WMSC_VIDEO_TAG_MAPPING="NOTIFY_WMSC_VIDEO_TAG_MAPPING",e.NOTIFY_SDK_SUBSCRIBE_VIDEO="NOTIFY_SDK_SUBSCRIBE_VIDEO",e.NOTIFY_SDK_UNSUBSCRIBE_VIDEO="NOTIFY_SDK_UNSUBSCRIBE_VIDEO",e.NOTIFY_SDK_ACTIVE_VIDEO_INDICATION="NOTIFY_SDK_ACTIVE_VIDEO_INDICATION",e.UPDATE_WMSC_PARAMS="UPDATE_WMSC_PARAMS"}(W||(W={})),function(e){e.ERROR="ERROR",e.WMSC_MESSAGE_TO_RWG_BY_SDK="WMSC_MESSAGE_TO_RWG_BY_SDK",e.WMSC_MAPPING_STREAMID_AND_MID="WMSC_MAPPING_STREAMID_AND_MID",e.GLOBAL_TRACE="GLOBAL_TRACE",e.MONITOR="MONITOR",e.DIRECT_MONITOR="DIRECT_MONITOR",e.CREATE_VIDEO_STREAMS_SUCCESS="CREATE_VIDEO_STREAMS_SUCCESS",e.CREATE_VIDEO_STREAMS_FAIL="CREATE_VIDEO_STREAMS_FAIL",e.PC_CONNECTED="PC_CONNECTED",e.VIDEO_SOURCE_UPDATED="VIDEO_SOURCE_UPDATED",e.VIDEO_TAG_MAPPED="VIDEO_TAG_MAPPED",e.VIDEO_QOS_DATA="VIDEO_QOS_DATA",e.UPDATE_VIDEO_CAPTURE_CONSTRAINTS="UPDATE_VIDEO_CAPTURE_CONSTRAINTS",e.ERROR_MESSAGE="ERROR_MESSAGE",e.NETWORK_QUALITY_CHANGE="NETWORK_QUALITY_CHANGE",e.NETWORK_QUALITY_CHANGE_AUDIO="NETWORK_QUALITY_CHANGE_AUDIO",e.VIDEO_CAPABILITIES_CHANGE="VIDEO_CAPABILITIES_CHANGE",e.UPDATE_VIDEO_SUBSCRIPTION="UPDATE_VIDEO_SUBSCRIPTION",e.UPDATE_VIDEO_UNSUBSCRIPTION="UPDATE_VIDEO_UNSUBSCRIPTION",e.SDP_NEGOTIATION_FAIL="SDP_NEGOTIATION_FAIL",e.PC_FAIL="PC_FAIL",e.VIDEO_FAIL="VIDEO_FAIL",e.PC_CLOSED="PC_CLOSED"}(F||(F={}));var z=i(7201),j=i.n(z),G=function(e,t,i,s){return new(i||(i=Promise))((function(a,n){function o(e){try{c(s.next(e))}catch(e){n(e)}}function r(e){try{c(s.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((s=s.apply(e,t||[])).next())}))};function H(e){return 4294966272&e}function Q(e,t){return G(this,void 0,void 0,(function*(){switch(t){case T.GZIP_BASE64:{const t=yield function(e){return G(this,void 0,void 0,(function*(){const t=(new TextEncoder).encode(e);if(window.CompressionStream){const e=new CompressionStream("gzip"),i=e.writable.getWriter();return i.write(t),i.close(),new Response(e.readable).arrayBuffer()}{const{gzip:e}=yield i.e(404).then(i.bind(i,3075));return e(t).buffer}}))}(e);return function(e){let t="";const i=new Uint8Array(e);for(let e=0;e<i.byteLength;e++)t+=String.fromCharCode(i[e]);return btoa(t)}(t)}case T.PLAIN:return e;default:return null}}))}function q(e,t){return e.length===t.length&&e.every(((e,i)=>e===t[i]))}function Y(e,t){return e-t}function J(e){var t;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"|";return e?j()(t=e.toString()).call(t,/[,ï¼Œ]/g,i):""}function K(){return parseInt((arguments.length>0&&void 0!==arguments[0]?arguments[0]:"").substring(0,2),16)===b}function X(){return parseInt((arguments.length>0&&void 0!==arguments[0]?arguments[0]:"").substring(0,4),16)===E}function Z(){return parseInt((arguments.length>0&&void 0!==arguments[0]?arguments[0]:"").substring(0,4),16)===A}const $=new class{constructor(){this.setTrace()}setTrace(e,t){t&&(t.log||t.info)&&t.error&&t.warn?(this.log=t.log||t.info,this.info=t.info||t.log,this.debug=t.debug||t.log,this.verbose=this._verbose,this.error=t.error,this.warn=t.warn):(this.verbose=this._verbose.bind(this),this.log=this._log.bind(this),this.info=this._info.bind(this),this.debug=this._debug.bind(this),this.error=this._error.bind(this),this.warn=this._warn.bind(this)),this.level=e||a.INFO,this.level=this.level<a.ERROR?a.ERROR:this.level,this.level=this.level>a.VERBOSE?a.VERBOSE:this.level,this.getLevel=()=>this.level,this._trace=(e,t)=>{switch(e){case"log":console.log(...t);break;case"debug":console.debug(...t);break;case"info":console.info(...t);break;case"warn":console.warn(...t);break;case"error":console.error(...t)}}}getTracer(e){return{log:()=>{},debug:()=>{},info:()=>{},warn:()=>{},error:()=>{}}}setTelemetry(e){this._telemetry="function"==typeof e?e:null}monitorLog(e){e&&this._telemetry&&this._telemetry({type:F.MONITOR,data:e})}directSendMonitorLog(e){e&&this._telemetry&&this._telemetry({type:F.DIRECT_MONITOR,data:e})}globalTrace(e){e&&this._telemetry&&this._telemetry({type:F.GLOBAL_TRACE,data:e})}_verbose(){if(this.level>=a.VERBOSE){const e=[...arguments];return e.unshift("[VERBOSE]"),this._trace("log",e),!0}return!1}_debug(){return this.level>=a.DEBUG&&(this._trace("debug",arguments),!0)}_log(){return this.level>=a.INFO&&(this._trace("log",arguments),!0)}_info(){return this.level>=a.INFO&&(this._trace("info",arguments),!0)}_warn(){return this.level>=a.WARN&&(this._trace("warn",arguments),!0)}_error(){return this.level>=a.ERROR&&(this._trace("error",arguments),!0)}};var ee=i(1265),te=i.n(ee),ie=i(8048),se=i.n(ie);function ae(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,s)}return i}function ne(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?ae(Object(i),!0).forEach((function(t){(0,c.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ae(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class oe{static splitSections(e){return e.split("\r\nm=").map(((e,t)=>t>0?"m="+e:e))}static splitLines(e){return e.split("\r\n")}static parseVersionLine(e){return parseInt(e.substring(2),10)}static writeVersionLine(e){return"v=".concat(e)}static parseOriginLine(e){const[t,i,s,a,n,o]=e.substring(2).split(" ");return{userName:t,sessionId:i,sessionVersion:parseInt(s,10),netType:a,addressType:n,address:o}}static writeOriginLine(e){const{userName:t,sessionId:i,sessionVersion:s,netType:a,addressType:n,address:o}=e;return"o=".concat(t," ").concat(i," ").concat(s," ").concat(a," ").concat(n," ").concat(o)}static parseSessionNameLine(e){return e.substring(2)}static writeSessionNameLine(e){return"s=".concat(e)}static parseInformationLine(e){return e.substring(2)}static writeInformationLine(e){return"i=".concat(e)}static parseConnectionLine(e){const[t,i,s]=e.substring(2).split(" ");return{netType:t,addressType:i,address:s}}static writeConnectionLine(e){const{netType:t,addressType:i,address:s}=e;return"c=".concat(t," ").concat(i," ").concat(s)}static parseBandwidthLine(e){return parseInt(e.substring(7),10)}static writeBandwidthLine(e){return"b=TIAS:".concat(e)}static parseTimingLine(e){const[t,i]=e.substring(2).split(" ");return{startTime:parseInt(t,10),stopTime:parseInt(i,10)}}static writeTimingLine(e){const{startTime:t,stopTime:i}=e;return"t=".concat(t," ").concat(i)}static parseRtpMapLine(e){const t=e.substring(9).match(/^(\d+) (.*)/),i=t[2].split("/");return{payloadType:parseInt(t[1],10),codecName:i[0],clockRate:parseInt(i[1],10),channels:i.length>=3?parseInt(i[2],10):null}}static writeRtpMapLine(e){const{payloadType:t,codecName:i,clockRate:s,channels:a}=e;let n="a=rtpmap:".concat(t," ").concat(i,"/").concat(s);return null!=a&&(n+="/"+a),n}static parseFmtpLine(e){const t=e.substring(7).match(/^(\d+) (.*)/),i={payloadType:parseInt(t[1],10)};return t[2].includes("=")?i.params=new Map(t[2].split(";").map((e=>te()(e).call(e).split("=")))):i.plain=t[2],i}static writeFmtpLine(e){const{payloadType:t,params:i,plain:s}=e;let a="a=fmtp:".concat(t," ");return i?(i.forEach(((e,t)=>{null!=e&&(a+="".concat(t,"=").concat(e,";"))})),a=a.slice(0,-1)):a+=s,a}static parseRtcpFbLine(e){const t=e.substring(10).match(/^(\d+) (.*)/);return{payloadType:parseInt(t[1],10),params:t[2].split(" ")}}static writeRtcpFbLine(e){const{payloadType:t,params:i}=e;let s="a=rtcp-fb:".concat(t);return i.forEach((e=>{s+=" "+e})),s}static parseRidLine(e){const t=e.substring(6).match(/^(\S+) (send|recv)/);return{rid:t[1],direction:t[2]}}static writeRidLine(e){const{rid:t,direction:i}=e;return"a=rid:".concat(t," ").concat(i)}static parseSimulcastLine(e){const t=e.substring(12).match(/^(send|recv) (.*)/);return{direction:t[1],rids:t[2].split(";").map((e=>"~"===e[0]?{id:e.substring(1),paused:!0}:{id:e,paused:!1}))}}static writeSimulcastLine(e){const{direction:t,rids:i}=e;let s="a=simulcast:".concat(t," ");return i.forEach((e=>{const t=e.paused?"~"+e.id:e.id;s+=t+";"})),s.slice(0,-1)}static parseExtensionMapLine(e){var t;const i=e.substring(9).match(/^(\d+)(\/sendrecv|\/sendonly|\/recvonly|\/inactive)? (\S+)(\s\S+)?/);return{id:parseInt(i[1],10),direction:i[2]?i[2].substring(1):null,uri:i[3],attributes:i[4]?se()(t=i[4]).call(t):null}}static writeExtensionMapLine(e){const{id:t,direction:i,uri:s,attributes:a}=e;let n="a=extmap:".concat(t);return null!=i&&(n+="/"+i),n+=" "+s,null!=a&&(n+=" "+a),n}static parseMidLine(e){return e.substring(6)}static writeMidLine(e){return"a=mid:".concat(e)}static writeDirectionLine(e){return"a=".concat(e)}static parseMsidLine(e){const[t,i]=e.substring(7).split(" ");return{streamId:t,trackId:i}}static writeMsidLine(e){const{streamId:t,trackId:i}=e;return"a=msid:".concat(t," ").concat(i)}static parseSsrcLine(e){const t=e.indexOf(" ");return{ssrc:parseInt(e.substring(7,t),10),attribute:e.substring(t+1)}}static writeSsrcLine(e){const{ssrc:t,attribute:i}=e;return"a=ssrc:".concat(t," ").concat(i)}static parseSsrcGroupLine(e){const t=e.substring(13).split(" ");return{semantics:t.shift(),ssrcs:t}}static writeSsrcGroupLine(e){const{semantics:t,ssrcs:i}=e;let s="a=ssrc-group:".concat(t);return i.forEach((e=>{s+=" "+e})),s}static parseGroupLine(e){const t=e.indexOf(" ");return{semantics:e.substring(8,t),ids:e.substring(t+1).split(" ")}}static writeGroupLine(e){const{semantics:t,ids:i}=e;let s="a=group:".concat(t);return i.forEach((e=>{s+=" "+e})),s}static writeExtMapAllowMixedLine(){return"a=extmap-allow-mixed"}static writeRtcpMuxLine(){return"a=rtcp-mux"}static writeRtcpReducedSizeLine(){return"a=rtcp-rsize"}static parseCandidateLine(e){const t=e.substring(12).split(" "),i={foundation:t[0],componentId:parseInt(t[1],10),transport:t[2],priority:parseInt(t[3],10),address:t[4],port:parseInt(t[5],10),candType:t[6],type:t[7],relAddress:null,relPort:null,candExtensions:[]};return"raddr"===t[8]&&"rport"===t[10]?(i.relAddress=t[9],i.relPort=parseInt(t[11],10),i.candExtensions=t.slice(12)):i.candExtensions=t.slice(8),i}static writeCandidateLine(e){const{foundation:t,componentId:i,transport:s,priority:a,address:n,port:o,candType:r,type:c,relAddress:d,relPort:l,candExtensions:h}=e;let u="a=candidate:".concat(t," ").concat(i," ").concat(s," ").concat(a)+" ".concat(n," ").concat(o," ").concat(r," ").concat(c);return null!=d&&null!=l&&(u+=" raddr ".concat(d," rport ").concat(l)),h.length&&(u+=" "+h.join(" ")),u}static parseSessionSection(e){const t={version:0,origin:null,sessionName:null,information:null,connection:null,bandwidth:null,timing:null,groups:[],extMapAllowMixed:null,otherLines:[]},i=this.splitLines(e);for(let e=0;e<i.length;e++){const s=i[e];s.length&&(s.match(/^v=/)?t.version=this.parseVersionLine(s):s.match(/^o=/)?t.origin=this.parseOriginLine(s):s.match(/^s=/)?t.sessionName=this.parseSessionNameLine(s):s.match(/^i=/)?t.information=this.parseInformationLine(s):s.match(/^c=/)?t.connection=this.parseConnectionLine(s):s.match(/^b=TIAS:/)?t.bandwidth=this.parseBandwidthLine(s):s.match(/^t=/)?t.timing=this.parseTimingLine(s):s.match(/^a=group:/)?t.groups.push(this.parseGroupLine(s)):s.match(/^a=extmap-allow-mixed$/)?t.extMapAllowMixed=!0:t.otherLines.push(s))}return t}static writeSessionSection(e){const t=[];return t.push(this.writeVersionLine(e.version)),null!=e.origin&&t.push(this.writeOriginLine(e.origin)),null!=e.sessionName&&t.push(this.writeSessionNameLine(e.sessionName)),null!=e.information&&t.push(this.writeInformationLine(e.information)),null!=e.connection&&t.push(this.writeConnectionLine(e.connection)),null!=e.bandwidth&&t.push(this.writeBandwidthLine(e.bandwidth)),null!=e.timing&&t.push(this.writeTimingLine(e.timing)),e.groups.forEach((e=>{t.push(this.writeGroupLine(e))})),e.extMapAllowMixed&&t.push(this.writeExtMapAllowMixedLine()),e.otherLines.length&&t.push(...e.otherLines),t.join("\r\n")+"\r\n"}static parseMediaSection(e){const t={type:null,port:null,protocol:null,connection:null,bandwidth:null,mid:null,direction:null,msid:null,rtcpMux:null,rtcpReducedSize:null,icePwd:null,iceUfrag:null,rtcp:null,codecs:[],extensionMap:new Map,rids:[],simulcast:null,ssrcs:[],ssrcGroups:[],candidates:[],otherLines:[]},i=[],s=[],a=this.splitLines(e),n=a[0].split(" ");t.type=n[0].substring(2),t.port=parseInt(n[1],10),t.protocol=n[2],t.payloadTypes=n.slice(3).map((e=>parseInt(e,10)));for(let e=1;e<a.length;e++){let n;const o=a[e];if(o.length)if(o.match(/^c=/))t.connection=this.parseConnectionLine(o);else if(o.match(/^b=TIAS:/))t.bandwidth=this.parseBandwidthLine(o);else if(o.match(/^a=rtpmap:/)){const e=this.parseRtpMapLine(o);t.codecs.push(ne({},e))}else if(o.match(/^a=fmtp:/))i.push(o);else if(o.match(/^a=rtcp-fb:/))s.push(o);else if(o.match(/^a=rid:/))t.rids.push(this.parseRidLine(o));else if(o.match(/^a=simulcast:/))t.simulcast=this.parseSimulcastLine(o);else if(o.match(/^a=ssrc:/))t.ssrcs.push(this.parseSsrcLine(o));else if(o.match(/^a=ssrc-group:/))t.ssrcGroups.push(this.parseSsrcGroupLine(o));else if(o.match(/^a=extmap:/)){const e=this.parseExtensionMapLine(o);t.extensionMap.set(e.id,e)}else o.match(/^a=mid:/)?t.mid=this.parseMidLine(o):(n=o.match(/^a=(sendrecv|sendonly|recvonly|inactive)/))?t.direction=n[1]:o.match(/^a=msid:/)?t.msid=this.parseMsidLine(o):o.match(/^a=rtcp-mux$/)?t.rtcpMux=!0:o.match(/^a=rtcp-rsize$/)?t.rtcpReducedSize=!0:o.match(/^a=candidate:/)?t.candidates.push(this.parseCandidateLine(o)):o.match(/^a=rtcp:/)?t.rtcp=o:o.match(/^a=ice-ufrag:/)?t.iceUfrag=o.substring(12):o.match(/^a=ice-pwd:/)?t.icePwd=o.substring(10):t.otherLines.push(o)}return i.forEach((e=>{const i=this.parseFmtpLine(e),s=t.codecs.find((e=>e.payloadType===i.payloadType));s&&(i.params?(s.codecParams=new Map,i.params.forEach(((e,t)=>{"apt"===t&&(s.associatedPayloadType=parseInt(e,10)),s.codecParams.set(t,e)}))):(s.fmtpLines=[i.plain],"red"===s.codecName&&(s.associatedPayloadType=parseInt(i.plain.split("/")[0],10))))})),s.forEach((e=>{const i=this.parseRtcpFbLine(e),s=t.codecs.find((e=>e.payloadType===i.payloadType));s&&(s.rtcpFbParams=s.rtcpFbParams||[],s.rtcpFbParams.push(i.params))})),t}static writeMediaSection(e){var t,i,s,a;const n=[];let o="m=".concat(e.type," ").concat(e.port," ").concat(e.protocol);return e.payloadTypes.forEach((e=>{o+=" "+e})),n.push(o),e.connection&&n.push(this.writeConnectionLine(e.connection)),e.bandwidth&&n.push(this.writeBandwidthLine(e.bandwidth)),e.rtcp&&n.push(e.rtcp),e.iceUfrag&&n.push("a=ice-ufrag:".concat(e.iceUfrag)),e.icePwd&&n.push("a=ice-pwd:".concat(e.icePwd)),e.otherLines.length&&n.push(...e.otherLines),n.push(this.writeMidLine(e.mid)),e.extensionMap.size&&e.extensionMap.forEach(((e,t)=>{n.push(this.writeExtensionMapLine(e))})),n.push(this.writeDirectionLine(e.direction)),e.msid&&n.push(this.writeMsidLine(e.msid)),e.rtcpMux&&n.push(this.writeRtcpMuxLine()),e.rtcpReducedSize&&n.push(this.writeRtcpReducedSizeLine()),e.codecs.forEach((e=>{const{payloadType:t,codecName:i,clockRate:s,channels:a,codecParams:o,fmtpLines:r,rtcpFbParams:c}=e;n.push(this.writeRtpMapLine({payloadType:t,codecName:i,clockRate:s,channels:a})),null==c||c.forEach((e=>{n.push(this.writeRtcpFbLine({payloadType:t,params:e}))})),null!=o&&o.size&&n.push(this.writeFmtpLine({payloadType:t,params:o})),null==r||r.forEach((e=>{n.push(this.writeFmtpLine({payloadType:t,plain:e}))}))})),null===(t=e.ssrcGroups)||void 0===t||t.forEach((e=>{n.push(this.writeSsrcGroupLine(e))})),null===(i=e.ssrcs)||void 0===i||i.forEach((e=>{n.push(this.writeSsrcLine(e))})),null===(s=e.rids)||void 0===s||s.forEach((e=>{n.push(this.writeRidLine(e))})),null===(a=e.candidates)||void 0===a||a.forEach((e=>{n.push(this.writeCandidateLine(e))})),e.simulcast&&n.push(this.writeSimulcastLine(e.simulcast)),n.join("\r\n")+"\r\n"}static parse(e){const t={session:null,media:[]},i=this.splitSections(e);return t.session=this.parseSessionSection(i.shift()),i.forEach((e=>{const i=this.parseMediaSection(e);t.media.push(i)})),t}static write(e){let t=this.writeSessionSection(e.session);return e.media.forEach((e=>{t+=this.writeMediaSection(e)})),t}}var re=i(8935);class ce{static parseSdp(e){return oe.parse(e)}static writeSdp(e){return oe.write(e)}static generateSsrc(){return Math.floor(4294967294*Math.random())+1}static generateId(){return Math.random().toString(36).substring(2,12)}static generateSessionId(){return Math.random().toString().substring(2,22)}static generateUuid(){const e=Array.from(Array(256).keys()).map((e=>e.toString(16).padStart(2,"0"))),t=crypto.getRandomValues(new Uint8Array(16));return t[6]=15&t[6]|64,t[8]=63&t[8]|128,Array.from(t.entries()).map((t=>{let[i,s]=t;return[4,6,8,10].includes(i)?"-".concat(e[s]):e[s]})).join("")}static generateIceCredentials(){const e=e=>[...Array(e)].map((()=>Math.random().toString(36).charAt(2))).join("");return{ice_ufrag:e(8),ice_pwd:e(22)}}static getSessionBoilerplate(){return"v=\r\no=- ".concat(this.generateSessionId()," 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n")}static getNtpSeconds(){return Math.floor((Date.now()+(Date.UTC(1970,0,1)-Date.UTC(1900,0,1)))/1e3)}static findHeaderExtensionByUri(e,t){for(const[i,s]of e.extensionMap)if(s.uri===t)return i;return-1}static addHeaderExtension(e,t){const{id:i}=t;return e.extensionMap.set(i,t),!0}static removeHeaderExtensionByUri(e,t){let i=!1;return e.extensionMap.forEach(((e,s,a)=>{e.uri===t&&(a.delete(s),i=!0)})),i}static removeMidRidHeaderExtensions(e){e.extensionMap.forEach(((e,t,i)=>{/^urn:ietf:params:rtp-hdrext:sdes:(?:mid|rtp-stream-id|repaired-rtp-stream-id)$/.test(e.uri)&&i.delete(t)}))}static updateCodecParameters(e,t,i,s,a){e.media.filter((e=>e.type===t&&e.direction===i)).forEach((e=>ce.updateMLineCodecParameters(e,s,a)))}static updateMLineCodecParameters(e,t,i){e.codecs.filter((e=>e.codecName===t)).forEach((e=>{i.forEach(((t,i)=>{e.codecParams.set(i,t)}))}))}static updateCodecParametersByMid(e,t,i,s){e.media.filter((e=>e.mid===t)).forEach((e=>ce.updateMLineCodecParameters(e,i,s)))}static filterCodecs(e,t){e.media.forEach((e=>{const i=[];e.codecs.forEach((s=>{t&&!t(s,e)||i.push(s.payloadType)})),e.codecs.forEach((e=>{i.includes(e.associatedPayloadType)&&i.push(e.payloadType)})),e.payloadTypes=e.payloadTypes.filter((e=>i.includes(e))),e.codecs=e.codecs.filter((e=>i.includes(e.payloadType)))})),e.media=e.media.filter((e=>e.payloadTypes.length))}static filterH264Profiles(e,t,i){e.media.filter((e=>e.direction===t)).forEach((e=>{const t=[];e.codecs.filter((e=>"H264"===e.codecName)).forEach((e=>{var s;const a=parseInt(null===(s=e.codecParams.get("profile-level-id"))||void 0===s?void 0:s.substring(0,2),16);i.includes(a)&&t.push(e.payloadType)})),e.codecs.forEach((e=>{t.includes(e.associatedPayloadType)&&t.push(e.payloadType)})),e.payloadTypes=e.payloadTypes.filter((e=>t.includes(e))),e.codecs=e.codecs.filter((e=>t.includes(e.payloadType)))}))}static getH264ProfileIds(e,t,i){const s=new Set,a=e.media.find((e=>"video"===e.type&&e.direction===t));return null==a||a.codecs.forEach((e=>{if("H264"===e.codecName&&(void 0===i||parseInt(e.codecParams.get("packetization-mode"))===i)){var t;const i=parseInt(null===(t=e.codecParams.get("profile-level-id"))||void 0===t?void 0:t.substring(0,2),16);i&&s.add(i)}})),Array.from(s.values())}static getMediaStartBandwidth(e){var t;const i=null==e||null===(t=e.codecs[0])||void 0===t?void 0:t.codecParams.get("x-google-start-bitrate");return 1e3*parseInt(i,10)||void 0}static mungeEgressLocalOffer(e,t,i){let s,a=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],n=0;if(e.media.forEach((e=>{const{extensionMap:t,type:i,direction:a}=e;t.forEach(((e,t)=>{t>n&&(n=t)})),"video"!==i||"sendonly"!==a||s||(s=e)})),!s)throw new Error("Failed to find a video media section for send");if(t>1&&a){s.rids=[],s.simulcast=null,s.ssrcs=[],s.ssrcGroups=[];const e=s.codecs.some((e=>"rtx"===e.codecName)),a=[],n=ce.generateUuid();let o;if(s.msid){s.msid.streamId=i;const{trackId:e}=s.msid;o="".concat(i," ").concat(e)}else o="".concat(i," ").concat(ce.generateUuid());for(let i=0;i<t;i++){const t=ce.generateSsrc();if(a.push(t),s.ssrcs.push({ssrc:t,attribute:"cname:"+n}),s.ssrcs.push({ssrc:t,attribute:"msid:"+o}),e){const e=ce.generateSsrc();s.ssrcs.push({ssrc:e,attribute:"cname:"+n}),s.ssrcs.push({ssrc:e,attribute:"msid:"+o}),s.ssrcGroups.push({semantics:"FID",ssrcs:[t,e]})}}s.ssrcGroups.push({semantics:"SIM",ssrcs:a})}ce.removeMidRidHeaderExtensions(s),(0,re.n_)()&&(0,re.nr)()&&15===(0,re.Cd)()&&1===(0,re.w_)()||ce.removeHeaderExtensionByUri(s,"urn:3gpp:video-orientation");const o={uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time"};if(-1===ce.findHeaderExtensionByUri(s,o.uri)&&(o.id=++n,ce.addHeaderExtension(s,o)),t>1){e.session.extMapAllowMixed=!0;const t={uri:"http://www.webrtc.org/experiments/rtp-hdrext/video-layers-allocation00"};-1===ce.findHeaderExtensionByUri(s,t.uri)&&(t.id=++n,ce.addHeaderExtension(s,t))}}static mungeEgressOfferToRemote(e){e.session.timing={startTime:ce.getNtpSeconds(),stopTime:0}}static mungeEgressAnswer(e,t){t&&ce.updateCodecParameters(e,"video","recvonly","H264",t)}static mungeIngressLocalOffer(e,t){t&&ce.updateCodecParameters(e,"video","recvonly","H264",t)}static updateIceCredential(e,t){const{ice_pwd:i,ice_ufrag:s}=t;e.media.forEach((e=>{e&&(e.icePwd=i,e.iceUfrag=s)}))}static getSSRCByMid(e,t){let i;const s=e.media.find((e=>e.mid==t)),{ssrcs:a}=s;return a.length&&(i=a[0].ssrc),i}static getMlineCodecFromLocalOffer(e,t,i){var s;return null===(s=e.media.find((e=>t===e.mid)))||void 0===s?void 0:s.codecs.find((e=>e.codecName===i))}static updateStreamIdByMid(e,t,i){const s=e.media.find((e=>e.mid===t));if(s.msid){const{trackId:e}=s.msid;s.msid.streamId=i,s.ssrcs&&s.ssrcs.forEach((t=>{0===t.attribute.indexOf("msid")&&(t.attribute="msid:".concat(i," ").concat(e))}))}}}const de=[{layerId:4,width:1920,height:1080,maxFramerate:30,minBitrate:25e5,targetBitrate:4e6,maxBitrate:5e6},{layerId:4,width:1600,height:900,maxFramerate:30,minBitrate:15e5,targetBitrate:3e6,maxBitrate:35e5},{layerId:3,width:1280,height:720,maxFramerate:30,minBitrate:8e5,targetBitrate:2e6,maxBitrate:2e6},{layerId:3,width:960,height:540,maxFramerate:30,minBitrate:5e5,targetBitrate:12e5,maxBitrate:12e5},{layerId:2,width:640,height:360,maxFramerate:30,minBitrate:25e4,targetBitrate:5e5,maxBitrate:7e5},{layerId:2,width:480,height:270,maxFramerate:30,minBitrate:18e4,targetBitrate:35e4,maxBitrate:45e4},{layerId:1,width:320,height:180,maxFramerate:30,minBitrate:1e5,targetBitrate:15e4,maxBitrate:2e5},{layerId:1,width:256,height:144,maxFramerate:30,minBitrate:6e4,targetBitrate:1e5,maxBitrate:13e4}];function le(e){x.setLayersSettings(e)}function he(e){x.setEnabledLayerIds(e)}function ue(){return x.layersSettings}function me(){return x.enabledLayerIds}function pe(){return me()[0]}function ge(e){return me().includes(e)}function Se(){const e=me();return e[e.length-1]}function _e(e){var t;return null===(t=ue())||void 0===t?void 0:t[e]}function ve(e){const t=ue();if(!t)return;const i=t.findIndex((t=>t.layerId===e));return i>=0?_e(i):void 0}function fe(e){const t=ue();if(t)for(let i=t.length-1;i>=0;i--)if(t[i].layerId===e)return _e(i)}function Me(e){var t;return(null===(t=ve(e))||void 0===t?void 0:t.maxBitrate)||0}function ye(e){var t;return(null===(t=ve(e))||void 0===t?void 0:t.targetBitrate)||0}function Ce(e,t){const i=ve(e);if(i){const{width:e,height:s,maxBitrate:a}=i;return Math.floor(t.width*t.height/(e*s)*a)}}function Ie(e){const t=e.width*e.height;return t>921600?4:t>307200?3:t>76800?2:t>19200?1:t>0?0:-1}function Te(e){var t,i;return!!(null===(i=null===(t=x.videoSettings)||void 0===t?void 0:t.preferSoftwareCodec)||void 0===i?void 0:i[e])}class Re{constructor(e){this._array=new Array(e),this._size=e,this._index=0,this._count=0}get size(){return this._size}get count(){return this._count}empty(){return 0===this._count}full(){return this._count===this._size}clear(){this._array=new Array(this._size),this._index=0,this._count=0}fill(e){return this._array.fill(e),this._index=0,this._count=this._size,this}get lastIndex(){return 0===this._index?this._size-1:this._index-1}nextIndex(e){return(e+1)%this._size}push(e){this._array[this._index]=e,this._index=this.nextIndex(this._index),this._count<this._size&&this._count++}pop(){if(this.empty())return;const e=this.lastIndex;return this._index=e,this._count>0&&this._count--,this._array[e]}at(e){if(!(this._count<this._size&&e>=this._count))return this._array[e]}front(){if(!this.empty())return this._array[this._count<this.size?0:this._index]}back(){if(!this.empty())return this._array[this.lastIndex]}unwrap(){return this._count<this._size?this._array.slice(0,this._count):[...this._array.slice(this._index),...this._array.slice(0,this._index)]}findIndex(e){if(this._count<this._size){for(let t=0;t<this._count;t++)if(e(this._array[t]))return t}else{for(let t=this._index;t<this._size;t++)if(e(this._array[t]))return t;for(let t=0;t<this._index;t++)if(e(this._array[t]))return t}return-1}findLastIndex(e){if(this._count<this._size){for(let t=this._count-1;t>=0;t--)if(e(this._array[t]))return t}else{for(let t=this._size-1;t>=this._index;t--)if(e(this._array[t]))return t;for(let t=this._index-1;t>=0;t--)if(e(this._array[t]))return t}return-1}find(e){const t=this.findIndex(e);return-1===t?void 0:this._array[t]}findLast(e){const t=this.findLastIndex(e);return-1===t?void 0:this._array[t]}}function be(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,s)}return i}function Ee(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?be(Object(i),!0).forEach((function(t){(0,c.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):be(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}$.getTracer("WmscStats");class Ae{constructor(){this.sendStatsMonitor=new we({cacheSize:Ae.sendStatsCacheSize}),this.recvStatsMonitor=new Le({cacheSize:Ae.recvStatsCacheSize}),this.sendUsageStatsEnabled=!1,this.recvUsageStatsEnabled=!1,this.maxEncodingFramerate=30,this.resourceUsageStatsReportTimestamp=0,this.resourceUsageStatsIntervalId=null,this.outgoingBitrateStatsCallback=null,this.resourceUsageStatsCallback=null}getSendStatsMonitor(){return this.sendStatsMonitor}getRecvStatsMonitor(){return this.recvStatsMonitor}setOptions(e){const{sendUsageStatsEnabled:t,recvUsageStatsEnabled:i,maxEncodingFramerate:s}=e||{};void 0!==t&&(this.sendUsageStatsEnabled=t),void 0!==i&&(this.recvUsageStatsEnabled=i),void 0!==s&&(this.maxEncodingFramerate=s)}start(e){e&&this.setOptions(e),this.sendUsageStatsEnabled&&this.sendStatsMonitor.setOptions({outboundRtpStatsEnabled:!0}),this.sendStatsMonitor.start(),this.recvUsageStatsEnabled&&this.recvStatsMonitor.setOptions({inboundRtpStatsEnabled:!0}),this.recvStatsMonitor.start(),(this.sendUsageStatsEnabled||this.recvUsageStatsEnabled)&&(this.resourceUsageStatsIntervalId=setInterval((()=>{this._reportResourceUsageStats()}),Ae.resourceUsageCheckInterval))}stop(){this.sendStatsMonitor.stop(),this.recvStatsMonitor.stop(),clearInterval(this.resourceUsageStatsIntervalId),this.resourceUsageStatsIntervalId=null}reset(){this.sendStatsMonitor.reset(),this.recvStatsMonitor.reset(),this.resourceUsageStatsReportTimestamp=0}registerOutgoingBitrateStatsCallback(e){this.sendStatsMonitor.outgoingBitrateStatsCallback=e}registerResourceUsageStatsCallback(e){this.resourceUsageStatsCallback=e}_reportResourceUsageStats(){const e={};let t=0;if(this.sendUsageStatsEnabled){const i=this._getSendResourceUsageStats();i&&(e.send=Ee({},i),t=Math.max(t,i.timestamp))}if(this.recvUsageStatsEnabled){const i=this._getRecvResourceUsageStats();i&&(e.recv=Ee({},i),t=Math.max(t,i.timestamp))}this.resourceUsageStatsReportTimestamp=t,this.resourceUsageStatsCallback(e)}_getSendResourceUsageStats(){if(!this.sendStatsMonitor.isStarted())return;const e=this.sendStatsMonitor.getOutboundRtpStats(),t=1e3/this.maxEncodingFramerate;let i=0,s=0,a=0,n=C.NONE;for(const[o,r]of e){const e=r.back(),o=Math.max(this.resourceUsageStatsReportTimestamp-500,e.timestamp-Ae.resourceUsageCheckInterval-500),c=r.find((e=>e.timestamp>o));if(!c)continue;const d=e.framesEncoded-c.framesEncoded,l=e.timestamp-c.timestamp;if(0===d||l<Ae.resourceUsageMinTimeSlice)continue;const h=e.framesSent-c.framesSent,u=d?1e3*(e.totalEncodeTime-c.totalEncodeTime)/d:0;let m,p,g=C.NONE,S=C.NONE,_=C.NONE;if(S=d>h||d>=Ae.encodeTimeMinFrameCount&&u>=t*Ae.encodeTimeFactorThresholdCritical?C.OVERUSING:d<=h&&d>=Ae.encodeTimeMinFrameCount&&u<t*Ae.encodeTimeFactorThresholdNormal?C.UNDERUSING:C.NORMAL,e.qualityLimitationDurations)if(m=1e3*(e.qualityLimitationDurations.cpu-c.qualityLimitationDurations.cpu)/l,p=1e3*(e.qualityLimitationDurations.other-c.qualityLimitationDurations.other)/l,m>=Ae.qualityLimitationRatioThresholdCritical||p>=Ae.qualityLimitationRatioThresholdCritical){_=C.OVERUSING;const e="WMSC_Perf_Control: cpuLimitationRatio ".concat(m);$.monitorLog(e),$.globalTrace({logLevel:"log",log:e,tags:["WMSC_Perf_Control"]})}else _=m<Ae.qualityLimitationRatioThresholdNormal&&p<Ae.qualityLimitationRatioThresholdNormal?C.UNDERUSING:C.NORMAL;if(g=S,Y(_,g)>0&&(g=_),i+=d,s+=h,a=Math.max(a,e.timestamp),Y(g,n)>0&&(n=g),n===C.OVERUSING)break}return{usageState:n,framesEncoded:i,framesSent:s,timestamp:a}}_getRecvResourceUsageStats(){if(!this.recvStatsMonitor.isStarted())return;const e=this.recvStatsMonitor.getInboundRtpStats();let t=0,i=0,s=0,a=0,n=C.NONE;for(const[o,r]of e){const e=r.back(),o=Math.max(this.resourceUsageStatsReportTimestamp-500,e.timestamp-Ae.resourceUsageCheckInterval-500),c=r.find((e=>e.timestamp>o));if(!c)continue;const d=e.timestamp-c.timestamp,l=e.framesReceived-c.framesReceived;if(0===l||d<Ae.resourceUsageMinTimeSlice)continue;const h=e.framesDropped-c.framesDropped,u=e.framesDecoded-c.framesDecoded,m=d/l;let p=1e3*(e.totalDecodeTime-c.totalDecodeTime);p>=d&&(p=d);const g=u?p/u:0;let S=C.NONE;if(t+=l,i+=h,s+=u,a=Math.max(a,e.timestamp),S=u>=Ae.decodeTimeMinFrameCount&&g>=m*Ae.decodeTimeFactorThresholdCritical&&l>u?C.OVERUSING:u>=Ae.decodeTimeMinFrameCount&&g<m*Ae.decodeTimeFactorThresholdNormal?C.UNDERUSING:C.NORMAL,Y(S,n)>0&&(n=S),n===C.OVERUSING)break}return{usageState:n,framesReceived:t,framesDropped:i,framesDecoded:s,timestamp:a}}}(0,c.A)(Ae,"sendStatsCacheSize",6),(0,c.A)(Ae,"recvStatsCacheSize",6),(0,c.A)(Ae,"resourceUsageMinTimeSlice",4500),(0,c.A)(Ae,"resourceUsageCheckInterval",5e3),(0,c.A)(Ae,"encodeTimeMinFrameCount",20),(0,c.A)(Ae,"encodeTimeFactorThresholdNormal",.9),(0,c.A)(Ae,"encodeTimeFactorThresholdCritical",1.1),(0,c.A)(Ae,"qualityLimitationRatioThresholdNormal",.05),(0,c.A)(Ae,"qualityLimitationRatioThresholdCritical",.95),(0,c.A)(Ae,"decodeTimeMinFrameCount",20),(0,c.A)(Ae,"decodeTimeFactorThresholdNormal",.9),(0,c.A)(Ae,"decodeTimeFactorThresholdCritical",1.1);class we{constructor(e){this.cacheSize=e.cacheSize||10,this.started=!1,this.selectedCandidatePairId=null,this.roundTripTime=0,this.remoteCandidateId=null,this.networkProtocol=null,this.localCandidateId=null,this.candidateType=null,this.outboundRtpStatsEnabled=!1,this.outboundRtpStatsMap=new Map}reset(){this.resetCandidateStats(),this.resetOutboundRtpStats()}resetCandidateStats(){this.selectedCandidatePairId=null,this.roundTripTime=0,this.remoteCandidateId=null,this.networkProtocol=null}resetOutboundRtpStats(){this.outboundRtpStatsMap.clear()}setOptions(e){const{outboundRtpStatsEnabled:t}=e||{};void 0!==t&&(this.outboundRtpStatsEnabled=t)}start(e){e&&this.setOptions(e),this.started=!0}stop(){this.started=!1}isStarted(){return this.started}getNetworkProtocol(){return this.networkProtocol}getCurrentRoundTripTime(){return this.roundTripTime}getOutboundRtpStats(){return this.outboundRtpStatsMap}onStatsReport(e){if(this.started)switch(e.type){case"transport":this.onTransportStats(e);break;case"candidate-pair":this.onCandidatePairStats(e);break;case"remote-candidate":this.onRemoteCandidateStats(e);break;case"outbound-rtp":this.onOutboundRtpStats(e);break;case"local-candidate":this.onLocalCandidateStats(e)}}onTransportStats(e){const{selectedCandidatePairId:t,dtlsState:i}=e;"connected"===i&&(this.selectedCandidatePairId=t)}onCandidatePairStats(e){const{id:t,state:i,nominated:s,availableOutgoingBitrate:a,currentRoundTripTime:n,remoteCandidateId:o,timestamp:r,localCandidateId:c}=e;t===this.selectedCandidatePairId&&"succeeded"===i&&s&&(this.roundTripTime=n,this.remoteCandidateId=o,this.localCandidateId=c,this.outgoingBitrateStatsCallback({availableOutgoingBitrate:a,timestamp:r}))}onRemoteCandidateStats(e){const{id:t,protocol:i,port:s}=e;if(t===this.remoteCandidateId&&!this.networkProtocol){this.networkProtocol=i;const e="WMSC_Network_Change: send|".concat(i,"|").concat(s);$.globalTrace({logLevel:"log",log:e,tags:["WMSC_Network_Change"]}),$.monitorLog(e)}}onLocalCandidateStats(e){const{id:t,candidateType:i}=e;if(t==this.localCandidateId&&this.candidateType!=i){this.candidateType=i;const e="WMSC_LocalCandidatae_Change:send|".concat(i);$.globalTrace({logLevel:"directReport",log:e,tags:["WMSC_LocalCandidatae_Change"]}),$.monitorLog(e)}}onOutboundRtpStats(e){if(!this.outboundRtpStatsEnabled||"video"!==e.kind)return;const{ssrc:t,framesEncoded:i,framesSent:s,totalEncodeTime:a,qualityLimitationDurations:n,timestamp:o}=e;let r=this.outboundRtpStatsMap.get(t);r||(r=new Re(this.cacheSize),this.outboundRtpStatsMap.set(t,r)),r.push({framesEncoded:i,framesSent:s,totalEncodeTime:a,qualityLimitationDurations:n,timestamp:o})}}class Le{constructor(e){this.cacheSize=e.cacheSize||10,this.started=!1,this.selectedCandidatePairId=null,this.roundTripTime=0,this.remoteCandidateId=null,this.networkProtocol=null,this.localCandidateId=null,this.candidateType=null,this.inboundRtpStatsEnabled=!1,this.inboundRtpStatsMap=new Map}reset(){this.resetCandidateStats(),this.resetInboundRtpStats()}resetCandidateStats(){this.selectedCandidatePairId=null,this.roundTripTime=0,this.remoteCandidateId=null,this.networkProtocol=null}resetInboundRtpStats(){this.inboundRtpStatsMap.clear()}setOptions(e){const{inboundRtpStatsEnabled:t}=e||{};void 0!==t&&(this.inboundRtpStatsEnabled=t)}start(e){e&&this.setOptions(e),this.started=!0}stop(){this.started=!1}isStarted(){return this.started}getNetworkProtocol(){return this.networkProtocol}getCurrentRoundTripTime(){return this.roundTripTime}getInboundRtpStats(){return this.inboundRtpStatsMap}onStatsReport(e){if(this.started)switch(e.type){case"transport":this.onTransportStats(e);break;case"candidate-pair":this.onCandidatePairStats(e);break;case"remote-candidate":this.onRemoteCandidateStats(e);break;case"inbound-rtp":this.onInboundRtpStats(e);break;case"local-candidate":this.onLocalCandidateStats(e)}}onTransportStats(e){const{selectedCandidatePairId:t,dtlsState:i}=e;"connected"===i&&(this.selectedCandidatePairId=t)}onCandidatePairStats(e){const{id:t,state:i,nominated:s,currentRoundTripTime:a,remoteCandidateId:n,localCandidateId:o}=e;t===this.selectedCandidatePairId&&"succeeded"===i&&s&&(this.roundTripTime=a,this.remoteCandidateId=n,this.localCandidateId=o)}onRemoteCandidateStats(e){const{id:t,protocol:i,port:s}=e;if(t===this.remoteCandidateId&&!this.networkProtocol){this.networkProtocol=i;const e="WMSC_Network_Change: recv|".concat(i,"|").concat(s);$.globalTrace({logLevel:"log",log:e,tags:["WMSC_Network_Change"]}),$.monitorLog(e)}}onLocalCandidateStats(e){const{id:t,candidateType:i}=e;if(t==this.localCandidateId&&this.candidateType!=i){this.localCandidateId=t,this.candidateType=i;const e="WMSC_LocalCandidatae_Change:recv|".concat(i);$.globalTrace({logLevel:"directReport",log:e,tags:["WMSC_LocalCandidatae_Change"]}),$.monitorLog(e)}}onInboundRtpStats(e){if(!this.inboundRtpStatsEnabled||"video"!==e.kind||!e.framesReceived)return;const{ssrc:t,framesDecoded:i,framesDropped:s,framesReceived:a,keyFramesDecoded:n,totalDecodeTime:o,pliCount:r,timestamp:c}=e;let d=this.inboundRtpStatsMap.get(t);d||(d=new Re(this.cacheSize),this.inboundRtpStatsMap.set(t,d)),d.push({framesDecoded:i,framesDropped:s,framesReceived:a,keyFramesDecoded:n,totalDecodeTime:o,pliCount:r,timestamp:c})}}const De=new Ae;class Pe{static mean(e){if(e.length)return e.reduce(((e,t)=>e+t),0)/e.length}static median(e){if(!e.length)return;l()(e).call(e,((e,t)=>e-t));const t=Math.floor(e.length/2);return e.length%2!=0?e[t]:(e[t-1]+e[t])/2}static variance(e){if(!e.length)return;const t=e.reduce(((e,t)=>e+t),0)/e.length,i=e.map((e=>Math.pow(e-t,2)));return i.reduce(((e,t)=>e+t),0)/i.length}static expMovingAverage(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5;if(!e.length)return[];const i=[e[0]];for(let s=1;s<e.length;s++)i.push(t*e[s]+(1-t)*i[s-1]);return i}static bestFitSlope(e){if(e.length<2)return;const t=e.length;let i=0,s=0,a=0,n=0;for(let o=0;o<t;o++)i+=o,s+=e[o],a+=o*e[o],n+=o*o;return(t*a-i*s)/(t*n-i*i)}}function Oe(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,s)}return i}function Ne(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Oe(Object(i),!0).forEach((function(t){(0,c.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Oe(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const Be=$.getTracer("WmscQosMgr"),Ve=e=>{Be.log(e),$.monitorLog("".concat(e))},ke=8e4,Ue=Object.freeze({Hold:0,Increase:1,Decrease:2}),xe=Object.freeze({None:0,Increase:1,Decrease:2}),We=Object.freeze({User:0,OutgoingBandwidth:1,ReceiverBandwidth:2,Other:3});class Fe{constructor(){this.outgoingBandwidthAdaptationEnabled=!0,this.outgoingBandwidthProbingEnabled=!0,this.receiverBandwidthAdaptationEnabled=!0,this.additionalSubLayersEnabled=!0,this.lossDetectionEnabled=!1,this.performanceAdaptationEnabled=!0,this.maxEncodingLayers=3,this.sendActive=!1,this.requestedLayerIds=[],this.additionalSubLayerIds=[],this.layersAllocation=[],this.layersAllocationCache=null,this.layersAllocationUpdateTimeoutId=null,this.isUpdatingLayers=!1,this.outgoingBandwidthProbingScheduledTime=0,this.maxSubVideoSize=-1,this.maxFeasibleSendSize=4,this.sendUsageAdjustments=new Re(Fe.resourceUsageAdjustmentHistorySize),this.sendUsageIncreaseFailedAttempts=0,this.sendUsageIncreaseFailedTime=0,this.encoderRestartedTime=0,this.maxFeasibleRecvSize=R,this.recvUsageAdjustments=new Re(Fe.resourceUsageAdjustmentHistorySize),this.recvUsageIncreaseFailedAttempts=0,this.recvUsageIncreaseFailedTime=0,this.outgoingBitrateStats=new Re(Fe.outgoingBitrateStatsCacheSize),this.minOutgoingBitrate=ke,this.outgoingBandwidth=1/0,this.receiverBandwidthReport=null,this.receiverL3BandwidthEvaluation=null,this.receiverBandwidthUpdatePending=!1,this.receiverBandwidthUpdateTimeoutId=null,this.isDualCall=!0,this.audioBandwidth=0,this.receiverStats=new Re(Fe.receiverStatsCacheSize),this.minOutgoingBitrateAdjustments=new Re(Fe.minOutgoingBitrateAdjustmentHistorySize),this.receiverReport=null,this.residualLossDetectedTimestamp=0,this.inherentLossDetectedTimestamp=0,this.minOutgoingBitrateUpdatedTime=0,this.messageCallback=null,this.maxRecvVideoSizeUpdateCallback=null,this.sendUsageStateUpdateCallback=null,De.registerOutgoingBitrateStatsCallback(this.onOutgoingBandwidthStats.bind(this)),De.registerResourceUsageStatsCallback(this.onResourceUsageStats.bind(this))}static areLayersAllocationsEqual(e,t){return e.length===t.length&&e.every(((e,i)=>{const s=t[i];return e.layerId===s.layerId&&e.maxBitrate===s.maxBitrate&&(a=e.format,n=s.format,a.width===n.width&&a.height===n.height);var a,n}))}static isBitrateChangeAboveRatio(e,t,i){return!e||Math.abs(t-e)/e>i}resetSendStats(){De.getSendStatsMonitor().reset()}resetRecvStats(){De.getRecvStatsMonitor().reset()}_resetLayersAllocation(){this.requestedLayerIds=[],this.additionalSubLayerIds=[],this.layersAllocation=[],this.layersAllocationCache=null,this.isUpdatingLayers=!1}_resetLossDetection(){this.receiverStats.clear(),this.minOutgoingBitrateAdjustments.clear(),this.receiverReport=null,this.residualLossDetectedTimestamp=0,this.inherentLossDetectedTimestamp=0,this.minOutgoingBitrateUpdatedTime=0}_resetBandwidthState(){this._stopReceiverBandwidthUpdateWait(),this._resetReceiverBandwidth(),this.outgoingBitrateStats.clear(),this.minOutgoingBitrate=ke,this.outgoingBandwidth=1/0,this.isDualCall=!0}_resetResourceUsageState(){this.maxFeasibleSendSize=Se(),this.sendUsageAdjustments.clear(),this.sendUsageIncreaseFailedAttempts=0,this.sendUsageIncreaseFailedTime=0,this.maxFeasibleRecvSize=R,this.recvUsageAdjustments.clear(),this.recvUsageIncreaseFailedAttempts=0,this.recvUsageIncreaseFailedTime=0}resetSend(){this._stopPollingLayersAllocation(),this.sendActive=!1,this._resetLayersAllocation(),this._resetLossDetection(),this._resetBandwidthState(),this.resetSendStats()}resetRecv(){this.maxSubVideoSize=-1,this.resetRecvStats()}registerMessageCallback(e){this.messageCallback=e}registerMaxRecvVideoSizeUpdateCallback(e){this.maxRecvVideoSizeUpdateCallback=e}registerSendUsageStateUpdateCallback(e){this.sendUsageStateUpdateCallback=e}setOptions(e){const{outgoingBandwidthAdaptationEnabled:t,outgoingBandwidthProbingEnabled:i,receiverBandwidthAdaptationEnabled:s,lossDetectionEnabled:a,performanceAdaptationEnabled:n}=e||{};void 0!==t&&(this.outgoingBandwidthAdaptationEnabled=t),void 0!==i&&(this.outgoingBandwidthProbingEnabled=i),void 0!==s&&(this.receiverBandwidthAdaptationEnabled=s),void 0!==a&&(this.lossDetectionEnabled=a),void 0!==n&&(this.performanceAdaptationEnabled=n)}setMaxEncodingLayers(e){this.maxEncodingLayers=e}setMaxEncodingFramerate(e){De.setOptions({maxEncodingFramerate:e})}setStartBandwidth(e){Ve("WMSC_Set_Start_Bandwidth: ".concat(e)),this.outgoingBandwidth=e}setAudioBandwidth(e){this.audioBandwidth!==e&&(Ve("WMSC_Set_Audio_Bandwidth: ".concat(e)),this.audioBandwidth=e,this.allocateBitrate(this._getAvailableBitrate(),We.OutgoingBandwidth))}start(e){e&&this.setOptions(e);const t={};this.performanceAdaptationEnabled&&(t.sendUsageStatsEnabled=!0,t.recvUsageStatsEnabled=!0),De.start(t)}stop(){De.stop(),this.resetSend(),this.resetRecv()}updateLayers(e){Be.log("updateLayers, ".concat(e)),this.requestedLayerIds=[...e],this.allocateBitrate(this._getAvailableBitrate(),We.User),this._setSendState(!!e.length)}_setSendState(e){this.sendActive!==e&&(this.sendActive=e,e?this._startPollingLayersAllocation():this.lossDetectionEnabled&&this._resetLossDetection())}async _startPollingLayersAllocation(){await this._sendLastLayersAllocation(),this.sendActive&&(this.layersAllocationUpdateTimeoutId=setTimeout((()=>{this._startPollingLayersAllocation()}),Fe.layersAllocationUpdateInterval))}_stopPollingLayersAllocation(){clearTimeout(this.layersAllocationUpdateTimeoutId),this.layersAllocationUpdateTimeoutId=null}updateMaxSubVideoSize(e){this.maxSubVideoSize=e}getMaxFeasibleRecvVideoSize(){return this.maxFeasibleRecvSize}_resetReceiverBandwidth(){this.receiverBandwidthReport=null,this.receiverL3BandwidthEvaluation=null}_waitBeforeReceiverBandwidthUpdate(){this.receiverBandwidthUpdatePending=!0,clearTimeout(this.receiverBandwidthUpdateTimeoutId),this.receiverBandwidthUpdateTimeoutId=setTimeout((()=>{this.receiverBandwidthUpdatePending=!1}),Fe.receiverBandwidthUpdateDelay)}_stopReceiverBandwidthUpdateWait(){clearTimeout(this.receiverBandwidthUpdateTimeoutId),this.receiverBandwidthUpdateTimeoutId=null,this.receiverBandwidthUpdatePending=!1}getMinBandwidth(){return this.minOutgoingBitrate}onOutgoingBandwidthStats(e){if(!this.outgoingBandwidthAdaptationEnabled||!this.sendActive)return;const{availableOutgoingBitrate:t=1/0,timestamp:i}=e;this.outgoingBitrateStats.push({availableOutgoingBitrate:t,timestamp:i}),this._updateOutgoingBandwidth(t)}onResourceUsageStats(e){this.performanceAdaptationEnabled&&(e.send&&this.sendActive&&this._handleSendUsageStats(e.send),e.recv&&this._handleRecvUsageStats(e.recv))}_handleSendUsageStats(e){const{framesEncoded:t,usageState:i,timestamp:s}=e,a=this._getFeasibleSendLayerIds();this.sendUsageStateUpdateCallback&&this.sendUsageStateUpdateCallback(i);let n=xe.None;i===C.OVERUSING?n=x.isMacIntel?xe.None:xe.Decrease:i===C.UNDERUSING&&(n=xe.Increase);const o=a[a.length-1];this._maybeAdjustMaxSendSize(o,n)&&(Ve("WMSC_VEnc_Cap_Change: ".concat(this.maxFeasibleSendSize)),this.allocateBitrate(this._getAvailableBitrate(),We.Other))}_handleRecvUsageStats(e){const{usageState:t}=e;let i=xe.None;t===C.OVERUSING?i=xe.Decrease:t===C.UNDERUSING&&(i=xe.Increase),this._maybeAdjustMaxRecvSize(this.maxSubVideoSize,i)&&(Ve("WMSC_VDec_Cap_Change: ".concat(this.maxFeasibleRecvSize)),this.maxRecvVideoSizeUpdateCallback&&this.maxRecvVideoSizeUpdateCallback(this.maxFeasibleRecvSize))}_maybeAdjustMaxSendSize(e,t){const i=Date.now();if(t===xe.Decrease){const a=pe();if(this.maxFeasibleSendSize>a){var s;const n=this.sendUsageAdjustments.back();if(this.sendUsageAdjustments.push({layerChange:t,time:i}),(null==n?void 0:n.layerChange)===xe.Increase){this.sendUsageIncreaseFailedAttempts++,this.sendUsageIncreaseFailedTime=n.time;const e="WMSC_Perf_Control: Attempt to increase layer failed ".concat(this.sendUsageIncreaseFailedAttempts," times");Ve(e),$.globalTrace({logLevel:"log",log:e,tags:["WMSC_Perf_Control"]})}return this.maxFeasibleSendSize=null!==(s=me().findLast((t=>t<e)))&&void 0!==s?s:a,!0}}else if(t===xe.Increase){const s=Se();var a;if(this.maxFeasibleSendSize<s&&this.sendUsageIncreaseFailedAttempts<Fe.resourceUsageIncreaseMaxAttempts&&i-this.sendUsageIncreaseFailedTime>=Fe.resourceUsageIncreaseInitialDelay*Math.pow(2,this.sendUsageIncreaseFailedAttempts-1))return this.sendUsageAdjustments.push({layerChange:t,time:i}),this.maxFeasibleSendSize=null!==(a=me().find((t=>t>e)))&&void 0!==a?a:s,!0}return!1}_maybeAdjustMaxRecvSize(e,t){if(e<=R)return!1;const i=Date.now();if(t===xe.Decrease){const e=this.recvUsageAdjustments.back();if(this.recvUsageAdjustments.push({layerChange:t,time:i}),(null==e?void 0:e.layerChange)===xe.Increase){this.recvUsageIncreaseFailedAttempts++,this.recvUsageIncreaseFailedTime=e.time;const t="WMSC_Perf_Control: Attempt to increase receive size failed ".concat(this.recvUsageIncreaseFailedAttempts," times");Ve(t),$.globalTrace({logLevel:"log",log:t,tags:["WMSC_Perf_Control"]})}if(this.maxFeasibleRecvSize>R)return this.maxFeasibleRecvSize--,!0}else if(t===xe.Increase&&this.maxFeasibleRecvSize<e&&this.recvUsageIncreaseFailedAttempts<Fe.resourceUsageIncreaseMaxAttempts&&i-this.recvUsageIncreaseFailedTime>=Fe.resourceUsageIncreaseInitialDelay*Math.pow(2,this.recvUsageIncreaseFailedAttempts-1))return this.recvUsageAdjustments.push({layerChange:t,time:i}),this.maxFeasibleRecvSize++,!0;return!1}onSubInfo(e){const{isDualCall:t}=e;this.onDualCallState(t)}onDualCallState(e){this.isDualCall!==e&&(this.isDualCall=e,Ve("WMSC_Dual_Call_State_Changed: ".concat(e)),e?(this._resetReceiverBandwidth(),this._waitBeforeReceiverBandwidthUpdate()):this._stopReceiverBandwidthUpdateWait())}isSingleLayerMode(){return 1===this.maxEncodingLayers||this.isDualCall}_evaluateBandwidthDistribution(e,t,i){const s=i.reduce(((e,t)=>e+t),0),a=Fe.receiverBandwidthUseRatio,n=Math.floor(t*a),o=function(e){var t;return(null===(t=fe(e))||void 0===t?void 0:t.minBitrate)||0}(e),r=ye(e)*Fe.adequateQualityBitrateRatio;let c=0,d=0,l=0;if(n>=r)d=s,l=n;else if(s>0){let e=0,n=0,h=0,u=0,m=0,p=0,g=0;for(let c=i.length-1;c>=0;c--){const d=i[c];d&&(g=g?512*c:t,g>=o&&(e=c,n+=d),g*a>=r&&(h=c,u+=d),p||(m/s<.6?m+=d:p=c))}p<h&&(m-u)/s<.2?(c=h,d=u):p>e?(c=p,d=m):(c=e,d=n),l=d?Math.floor(Math.max(t,512*c)*a):0}else l=r;return{selectedBandwidth:l,selectedAll:l<=n}}onReceiverBandwidthReport(e){if(!this.receiverBandwidthAdaptationEnabled||this.receiverBandwidthUpdatePending)return;const{minBW:t,minL3BW:i}=e;let s=!1;if(this.receiverBandwidthReport&&this.receiverBandwidthReport.minBw===t||(s=!0),this.receiverBandwidthReport={minBw:t,minL3Bw:i},!this.isDualCall&&ge(3)){const{selectedBandwidth:e,selectedAll:t}=this.receiverL3BandwidthEvaluation||{};this.receiverL3BandwidthEvaluation=this._evaluateBandwidthDistribution(3,i,[]),this.receiverL3BandwidthEvaluation.selectedAll===t&&this.receiverL3BandwidthEvaluation.selectedBandwidth===e||(s=!0)}this.sendActive&&s&&this.allocateBitrate(this._getAvailableBitrate(),We.ReceiverBandwidth)}onReceiverReport(e){if(!this.outgoingBandwidthAdaptationEnabled||!this.lossDetectionEnabled||!this.sendActive)return;if(!this.receiverReport)return void(this.receiverReport=e);const{recvPkts:t,preMissingPkts:i,postMissingPkts:s,maxJitterMs:a,maxSeqGap:n,timestampMs:o}=e,r=this.receiverReport,c=t-r.recvPkts,d=i-r.preMissingPkts,l=s-r.postMissingPkts,h=d+c,u={loss:h>0?d/h:0,residualLoss:h>0?l/h:0,jitter:a,sequenceGap:n,timestamp:o};this.receiverStats.push(u),this.receiverReport=e,"udp"===De.getSendStatsMonitor().getNetworkProtocol()&&this._updateOutgoingBandwidth(this._adjustOutgoingBandwidthForLoss(this.outgoingBandwidth))}_getReceiverMinBandwidth(){return this.receiverBandwidthReport?Math.floor(this.receiverBandwidthReport.minBw*Fe.receiverBandwidthUseRatio):1/0}_getSelectedL3Bandwidth(){return this.receiverL3BandwidthEvaluation?this.receiverL3BandwidthEvaluation.selectedBandwidth:1/0}_getOutgoingBandwidthHistory(e){if(this.outgoingBitrateStats.empty())return[];const t=this.outgoingBitrateStats.unwrap(),i=t[t.length-1].timestamp-e;let s=0;for(let e=t.length-1;e>=0;e--)if(t[e].timestamp<i){s=e+1;break}return t.slice(s).map((e=>e.availableOutgoingBitrate))}_getSubLayersForLayer(e){const t=me(),i=[];if(3===e){var s;if(null===(s=this.receiverL3BandwidthEvaluation)||void 0===s||!s.selectedAll)for(const s of t)s<e&&i.push(s);return i}if(e<3)for(const s of t)s<e&&i.push(s);return i}_maybeUpdateSubLayers(){if(!this.receiverBandwidthAdaptationEnabled||!this.additionalSubLayersEnabled||this.receiverBandwidthUpdatePending)return!1;const e=[];return this.isSingleLayerMode()||this.requestedLayerIds.forEach((t=>{this._getSubLayersForLayer(t).forEach((t=>{this.requestedLayerIds.includes(t)||e.includes(t)||e.push(t)}))})),!q(this.additionalSubLayerIds,e)&&(this.additionalSubLayerIds=e,!0)}_getAvailableBitrate(){return this.outgoingBandwidthAdaptationEnabled?Math.max(0,this.outgoingBandwidth-this.audioBandwidth):1/0}_updateOutgoingBandwidth(e){this.outgoingBandwidth=e,this.allocateBitrate(this._getAvailableBitrate(),We.OutgoingBandwidth)}_updateLayersMaxBitrate(e){e.forEach(((t,i)=>{const{layerId:s,format:a}=t,n=i===e.length-1,o=this._getReceiverBandwidth(s),r=n?a.maxBitrate:Math.min(a.maxBitrate,1e3*Math.ceil(a.targetBitrate*(4/3)/1e3));t.maxBitrate=Math.min(r,o)}))}_detectInherentLoss(e){const t=e.findIndex((e=>e.timestamp>this.inherentLossDetectedTimestamp&&e.loss));if(e.length-t>=Fe.inherentLossDetectionMinDataPoints){const i=e.slice(t).map((e=>e.loss)),s=i.length?Pe.mean(i):0;if(s>=Fe.lossThresholdLow&&s<Fe.lossThresholdHigh){const e=Pe.variance(i);if(Be.log("loss ratios: ".concat(i,", mean: ").concat(s,", variance: ").concat(e)),e<Fe.inherentLossVarianceThresholdHigh)return t}}return-1}_detectOutOfOrder(e){const t=e.findIndex((e=>e.timestamp>this.inherentLossDetectedTimestamp&&e.sequenceGap));if(e.length-t>=Fe.outOfOrderDetectionMinDataPoints){const i=e.slice(t).map((e=>e.sequenceGap)),s=Pe.mean(i);if(s>=Fe.sequenceGapThresholdLow&&s<Fe.sequenceGapThresholdHigh)return Be.log("sequence gaps: ".concat(i,", mean: ").concat(s)),t}return-1}_isOutgoingBandwidthNormal(e){return e>=Math.max(Fe.minOutgoingBitrateThresholdLow,this.minOutgoingBitrate*Fe.outgoingBitrateFactorThresholdNormalState)}_adjustOutgoingBandwidthForLoss(e){e<this.minOutgoingBitrate&&(e=this.minOutgoingBitrate),this._isOutgoingBandwidthNormal(e)&&this.minOutgoingBitrateAdjustments.clear();const t=this.receiverStats.unwrap(),{residualLoss:i,timestamp:s}=t[t.length-1],a=t.findIndex((e=>e.loss)),n=t.slice(a).map((e=>e.loss)),o=n.length?Pe.mean(n):0;if(i&&Be.log("residual loss: ".concat(i,", mean loss: ").concat(o)),i>=Fe.residualLossThresholdMedium){this.residualLossDetectedTimestamp=s;const t=i>=Fe.residualLossThresholdHigh?Fe.residualLossBitrateFastDecreaseFactor:Fe.residualLossBitrateDecreaseFactor;return this._decreaseOutgoingBitrate(Math.floor(e*t))}if(i>=o*Fe.residualLossRatioThresholdLow){const i=t.findIndex((e=>e.timestamp>this.residualLossDetectedTimestamp));if(t.reduce(((e,t,a)=>a>=i&&t.residualLoss&&s-t.timestamp<=Fe.residualLossMonitorTimeWindow?e+1:e),0)>=Fe.residualLossCountThreshold)return this.residualLossDetectedTimestamp=s,this._decreaseOutgoingBitrate(Math.floor(e*Fe.residualLossBitrateDecreaseFactor))}if(this.residualLossDetectedTimestamp&&s-this.residualLossDetectedTimestamp<Fe.outgoingBitrateIncreaseSuppressionIntervalResidualLoss)return e;const r=this._getOutgoingBitrateDemand();if(e>=r)return e;let c=-1;if(c=this._detectInherentLoss(t),-1===c&&(c=this._detectOutOfOrder(t)),-1!==c&&s-this.inherentLossDetectedTimestamp>=Fe.inherentLossDetectionMinInterval){const i=this._getOutgoingBandwidthHistory(s-t[c].timestamp+1500);if(i.length>=Fe.inherentLossDetectionMinDataPoints){const t=Pe.bestFitSlope(i),a=i[0];if(t<Fe.outgoingBitrateMaxSlopeRestoreBandwidth&&a>=e*Fe.outgoingBitrateMinFactorRestoreBandwidth)return Be.log("bandwidth: ".concat(a," -> ").concat(e,", slope: ").concat(t)),this._maybeIncreaseMinOutgoingBitrate(Math.min(r,a)),this.inherentLossDetectedTimestamp=s,e}if(e<Fe.minOutgoingBitrateThresholdMedium)return this._maybeIncreaseMinOutgoingBitrate(Math.min(Fe.minOutgoingBitrateThresholdMedium,r,Math.floor(e*Fe.minOutgoingBitrateIncreaseFactor))),this.inherentLossDetectedTimestamp=s,e}return e}_decreaseOutgoingBitrate(e){return e=Math.max(ke,e),this._maybeDecreaseMinOutgoingBitrate(e),e}_maybeIncreaseMinOutgoingBitrate(e){return!(this.minOutgoingBitrateAdjustments.unwrap().slice(-3).filter((e=>e===Ue.Decrease)).length>=2)&&(this.minOutgoingBitrateAdjustments.push(Ue.Increase),this._adjustMinOutgoingBitrate(Math.max(Fe.minOutgoingBitrateThresholdLow,Math.min(Fe.minOutgoingBitrateThresholdHigh,e))))}_maybeDecreaseMinOutgoingBitrate(e){if(e<this.minOutgoingBitrate){this.minOutgoingBitrateAdjustments.push(Ue.Decrease);const t=this.minOutgoingBitrate<=Fe.minOutgoingBitrateThresholdLow?ke:Math.max(ke,Math.min(e,Math.floor(this.minOutgoingBitrate*Fe.minOutgoingBitrateLeastDecreaseFactor)));return this._adjustMinOutgoingBitrate(t)}return!1}async _adjustMinOutgoingBitrate(e){Be.log("adjust min bitrate: ".concat(this.minOutgoingBitrate," -> ").concat(e));const t=Date.now();if(t-this.minOutgoingBitrateUpdatedTime<Fe.minOutgoingBitrateUpdateMinInterval)return;const i=1e3*Math.floor(e/1e3);if(i!==this.minOutgoingBitrate){Be.log("update min bitrate: ".concat(this.minOutgoingBitrate," -> ").concat(i)),this.minOutgoingBitrateUpdatedTime=t;try{return await this.messageCallback({type:y.MIN_BITRATE_UPDATE,data:i}),this.minOutgoingBitrate=i,!0}catch(e){return Be.error("update min bitrate error: ".concat(e.message)),!1}}return!1}async _updateLayersAllocation(e){try{return await this.messageCallback({type:y.LAYERS_UPDATE,data:e}),!0}catch(e){return Be.error("update layers allocation error: ".concat(e.message)),!1}}async _sendLastLayersAllocation(){if(!this.layersAllocationCache||this.isUpdatingLayers)return;const{outgoingBandwidth:e,receiverBandwidthReport:t,availableBitrate:i,layerIds:s,layersAllocation:a}=this.layersAllocationCache;if(this.layersAllocationCache=null,!Fe.areLayersAllocationsEqual(this.layersAllocation,a)){this.isUpdatingLayers=!0;const{minBw:n,minL3Bw:o}=t,r="WMSC_Update_Layers_Allocation, bandwidth: S ".concat(e,",").concat(i,", R ").concat(n,",").concat(o)+", layers: ".concat(s,", ").concat(a.map((e=>{let{layerId:t,maxBitrate:i,format:s}=e;return"{".concat(t,",").concat(s.width,",").concat(i,"}")})).join(","));Ve(J(r));const c=await this._updateLayersAllocation(a);this.isUpdatingLayers=!1,c&&(this.layersAllocation=a)}}_getReceiverBandwidth(e){let t=1/0;return this.isSingleLayerMode()?t=this._getReceiverMinBandwidth():3===e&&(t=this._getSelectedL3Bandwidth()),t}_getAdjustedTargetBitrate(e){const t=ye(e),i=this._getReceiverBandwidth(e);return Math.min(t,i)}_getAdjustedMaxBitrate(e){const t=Me(e),i=this._getReceiverBandwidth(e);return Math.min(t,i)}_getSendLayerIds(){var e;return l()(e=[...this.additionalSubLayerIds,...this.requestedLayerIds]).call(e)}_getFeasibleSendLayerIds(){const e=this._getSendLayerIds(),t=[];for(const i of e){if(i>this.maxFeasibleSendSize){t[t.length-1]!==this.maxFeasibleSendSize&&t.push(this.maxFeasibleSendSize);break}t.push(i)}return t}_getTotalMaxBitrate(e){let t=0;for(let i=0;i<e.length;i++)i===e.length-1?t+=this._getAdjustedMaxBitrate(e[i]):t+=this._getAdjustedTargetBitrate(e[i]);return t}_getOutgoingBitrateDemand(){const e=this._getFeasibleSendLayerIds();return this._getTotalMaxBitrate(e)}_allocateBitrateToLayers(e,t){const i=me(),s=i[0],a=[];let n=e,o=-1;const r=e=>{const t=this._getReceiverBandwidth(e),i=function(e){var t,i;return null!==(i=null===(t=ue())||void 0===t?void 0:t.filter((t=>t.layerId===e)))&&void 0!==i?i:[]}(e);for(const s of i)if(n>=s.minBitrate&&t>=s.minBitrate&&a.length<this.maxEncodingLayers){const t=Math.min(n,s.targetBitrate);return a.push({layerId:e,format:s}),n-=t,o=e,!0}return!1};for(const e of t)if(!r(e)){const t=-1===o?s:o+1;for(let s=e-1;s>=t&&i.includes(s)&&!r(s);s--);break}return t.length&&!a.length&&a.push({layerId:s,format:fe(s)}),this._updateLayersMaxBitrate(a),a}_reallocateBitrateToLayers(e,t,i){let s=0,a=0,n=0,o=!1;if(t.forEach(((e,i)=>{n+=i===t.length-1?Me(e):ye(e)})),i.forEach(((e,t)=>{const{layerId:n,format:r}=e,c=t===i.length-1,d=this._getReceiverBandwidth(n);c?((d<r.minBitrate||d>r.maxBitrate)&&(o=!0),s+=r.minBitrate,a+=r.maxBitrate):(d<r.minBitrate&&(o=!0),s+=r.targetBitrate,a+=r.targetBitrate)})),!o&&(e>=n||e>=s&&e<=a)){const e=i.map((e=>{let{layerId:t,maxBitrate:i,format:s}=e;return{layerId:t,maxBitrate:i,format:s}}));return this._updateLayersMaxBitrate(e),e}return this._allocateBitrateToLayers(e,t)}allocateBitrate(e,t){var i;const s=this._maybeUpdateSubLayers(),a=this._getFeasibleSendLayerIds(),n=(null===(i=this.layersAllocationCache)||void 0===i?void 0:i.layersAllocation)||this.layersAllocation;let o;o=s||!n.length||t!==We.OutgoingBandwidth&&t!==We.ReceiverBandwidth?this._allocateBitrateToLayers(e,a):this._reallocateBitrateToLayers(e,a,n);const r={outgoingBandwidth:this.outgoingBandwidth,receiverBandwidthReport:Ne({},this.receiverBandwidthReport),availableBitrate:e,layerIds:a,layersAllocation:o,reason:t};this._updateLayersForBandwidthProbing(r),this.layersAllocationCache=r}_updateLayersForBandwidthProbing(e){const{layersAllocation:t,availableBitrate:i}=e,s=Date.now();if(!this.outgoingBandwidthProbingEnabled||i>=Fe.outgoingBitrateThresholdProbing||s-this.outgoingBandwidthProbingScheduledTime<Fe.outgoingBandwidthProbingMinInterval||1!==t.length)return;const{layerId:a,maxBitrate:n}=t[0],o=Math.floor(1.1*this.outgoingBandwidth);a!==pe()||n>this.outgoingBandwidth||o>this._getReceiverBandwidth(a)||(t[0].maxBitrate=o,this.outgoingBandwidthProbingScheduledTime=s)}}(0,c.A)(Fe,"availableBitrateChangeRatioThresholdLow",.08),(0,c.A)(Fe,"availableBitrateUpdateMinInterval",1e3),(0,c.A)(Fe,"layersAllocationUpdateInterval",300),(0,c.A)(Fe,"resourceUsageAdjustmentHistorySize",6),(0,c.A)(Fe,"resourceUsageIncreaseInitialDelay",6e4),(0,c.A)(Fe,"resourceUsageIncreaseMaxAttempts",6),(0,c.A)(Fe,"encodingTimeout",3e3),(0,c.A)(Fe,"encoderRestartMinInterval",3e4),(0,c.A)(Fe,"outgoingBitrateStatsCacheSize",8),(0,c.A)(Fe,"receiverBandwidthUseRatio",.9),(0,c.A)(Fe,"receiverBandwidthUpdateDelay",1500),(0,c.A)(Fe,"adequateQualityBitrateRatio",.6),(0,c.A)(Fe,"outgoingBitrateThresholdProbing",2e5),(0,c.A)(Fe,"outgoingBandwidthProbingMinInterval",1e4),(0,c.A)(Fe,"lossThresholdLow",.08),(0,c.A)(Fe,"lossThresholdHigh",.6),(0,c.A)(Fe,"receiverStatsCacheSize",6),(0,c.A)(Fe,"minOutgoingBitrateAdjustmentHistorySize",5),(0,c.A)(Fe,"outgoingBitrateFactorThresholdNormalState",1.5),(0,c.A)(Fe,"outgoingBitrateMaxSlopeRestoreBandwidth",-1e5),(0,c.A)(Fe,"outgoingBitrateMinFactorRestoreBandwidth",1.5),(0,c.A)(Fe,"outgoingBitrateIncreaseSuppressionIntervalResidualLoss",15e3),(0,c.A)(Fe,"minOutgoingBitrateUpdateMinInterval",900),(0,c.A)(Fe,"minOutgoingBitrateThresholdLow",25e4),(0,c.A)(Fe,"minOutgoingBitrateThresholdMedium",1e6),(0,c.A)(Fe,"minOutgoingBitrateThresholdHigh",2e6),(0,c.A)(Fe,"minOutgoingBitrateLeastDecreaseFactor",.8),(0,c.A)(Fe,"minOutgoingBitrateIncreaseFactor",1.15),(0,c.A)(Fe,"residualLossRatioThresholdLow",.05),(0,c.A)(Fe,"residualLossThresholdMedium",.05),(0,c.A)(Fe,"residualLossThresholdHigh",.15),(0,c.A)(Fe,"residualLossMonitorTimeWindow",6e3),(0,c.A)(Fe,"residualLossCountThreshold",2),(0,c.A)(Fe,"residualLossBitrateDecreaseFactor",.8),(0,c.A)(Fe,"residualLossBitrateFastDecreaseFactor",.64),(0,c.A)(Fe,"inherentLossDetectionMinDataPoints",3),(0,c.A)(Fe,"inherentLossDetectionMinInterval",3e3),(0,c.A)(Fe,"inherentLossVarianceThresholdHigh",.02),(0,c.A)(Fe,"outOfOrderDetectionMinDataPoints",3),(0,c.A)(Fe,"sequenceGapThresholdLow",10),(0,c.A)(Fe,"sequenceGapThresholdHigh",80);const ze=new Fe;var je=i(2310);function Ge(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,s)}return i}function He(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Ge(Object(i),!0).forEach((function(t){(0,c.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Ge(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const Qe=$.getTracer("WmscVideoMgr"),qe=e=>{Qe.log(e),$.monitorLog("".concat(e))},Ye=new class{constructor(){var e,t;this.videoPublished=!1,this.mediaRequested=!1,this.hdVideoEnabled=!1,this.maxSendLayerId=4,this.sourceVideoSettings={},this.pc=null,this.sendTransceiver=null,this.messageCallback=null,this.requestedLayerIds=[],this.sendLayerIds=[],this.encodingMap=new Map,this.recvCodecNum=0,this.sendCodecNum=0,this.senderCodec=null,this.isSupportHi444PP=!1,this.headerExtMap=new Map,this.egressCodecList=null,this.ingressCodecList=null,this.sendCBPPayloadType=0,this.recvHigh444PayloadType=0,this.recvMLineTemp=null,this.recvPreferCodecs=(null===(e=RTCRtpReceiver.getCapabilities("video"))||void 0===e||null===(e=e.codecs)||void 0===e?void 0:e.filter((e=>{let{mimeType:t,sdpFmtpLine:i}=e;if(-1!==t.indexOf("red")||-1!==t.indexOf("fec")||"video/rtx"===t)return!0;const s=i?i.toLowerCase():"";return!("video/H264"!==t||!s||-1===s.indexOf("packetization-mode=1")||(-1!==s.indexOf("profile-level-id=f400")&&(this.isSupportHi444PP=!0),this.recvCodecNum++,0))})))||[],null===(t=RTCRtpSender.getCapabilities("video"))||void 0===t||null===(t=t.codecs)||void 0===t||t.forEach((e=>{const{mimeType:t,sdpFmtpLine:i}=e;"video/H264"===t&&(this.sendCodecNum++,-1!==i.indexOf("profile-level-id=42")&&(!(0,re._J)()&&!(0,re.UP)()||(0,re.D)("124")||(this.senderCodec=e)))})),ze.registerMessageCallback(this.onQosMessage.bind(this))}getSendEncodings(e){switch(e){case 1:return[{active:!1}];case 2:return[{active:!1,scaleResolutionDownBy:2},{active:!1,scaleResolutionDownBy:1}];default:return[{active:!1,scaleResolutionDownBy:4},{active:!1,scaleResolutionDownBy:2},{active:!1,scaleResolutionDownBy:1}]}}getDefaultEncodingIndex(e){return e<=1?0:2===e?1:2}getEncodingIndex(e){return this.layerEncodingIndexMap.get(e)}_configSimulcastLayers(e,t){this.numSimulcastLayers=e,this.layerEncodingIndexMap=t}setDefaultVideoSettings(){!function(e){const t=e?de.filter((e=>{let{width:t,height:i}=e;return!((s={width:t,height:i}).width*s.height<57600);var s})):de;t.length&&(t[t.length-1].minBitrate=6e4),le(t)}((0,re.zQ)()),he([1,2,3]),this._configSimulcastLayers(3,new Map([[1,0],[2,1],[3,2]])),this.resendVideo()}setVideoSettings(e){var t;const{hdVideoEnabled:i,maxEncodingLayers:s,layersSettings:a}=e||{};if(this.enableHdVideo(i),s>0&&ze.setMaxEncodingLayers(s),null==a||!a.length)return void this.setDefaultVideoSettings();const n=l()(a).call(a,((e,t)=>Math.min(t.width,t.height)-Math.min(e.width,e.height))),o=n.reduce(((e,t)=>Math.min(t.maxFramerate,e)),30);for(let e=0;e<n.length;e++){const{width:t,height:i,minBitrate:s,maxBitrate:a}=n[e],r=Ie({width:t,height:i});n[e].layerId=r,n[e].maxFramerate=o,void 0===a&&(n[e].maxBitrate=Ce(r,{width:t,height:i}),n[e].targetBitrate=n[e].maxBitrate),void 0===s&&(n[e].minBitrate=e>0?n[e-1].maxBitrate:6e4)}const r=new Map;n.forEach((e=>{const{layerId:t}=e,i=this.getDefaultEncodingIndex(t);r.get(t)?t.push(t):r.set(i,[t])}));const c=r.size,d=Array.from(r.keys()),h=new Map;for(let e=0;e<c;e++)r.get(d[e]).forEach((t=>{h.set(t,e)}));le(n),he(l()(t=Array.from(h.keys())).call(t)),this._configSimulcastLayers(c,h),this.resendVideo()}registerMessageCallback(e){this.messageCallback=e}getPc(){return this.pc}getSender(){var e;return null===(e=this.sendTransceiver)||void 0===e?void 0:e.sender}enableHdVideo(e){qe("WMSC_Enable_HD_Video: ".concat(e)),this.hdVideoEnabled=e,this.resendVideo()}setMaxSendLayerId(e){this.maxSendLayerId=e,this.sendLayerIds=this._reduceRequestLayerIds(this.requestedLayerIds)}async publishVideoTrack(e,t){e?(this.sourceVideoSettings=t,null!=t&&t.frameRate&&ze.setMaxEncodingFramerate(t.frameRate),await this._replaceVideoTrack(e)):await this._replaceVideoTrack(null),this._onVideoPublished(!!e)}async _replaceVideoTrack(e){const t=this.getSender(),i=e?"{ kind: ".concat(e.kind,", id: ").concat(e.id,", enabled: ").concat(e.enabled,", muted: ").concat(e.muted)+", contentHint: ".concat(e.contentHint," }"):"";if(qe(J("WMSC_Replace_Video_Track: sender: ".concat(!!t," track: ").concat(i))),t)return t.replaceTrack(e)}_onVideoPublished(e){this.videoPublished=e,this.mediaRequested&&(e?this._onVideoStart():this._onVideoStop())}_onVideoStart(){Qe.log("_onVideoStart"),ze.updateLayers(this.sendLayerIds)}_onVideoStop(){Qe.log("_onVideoStop"),ze.updateLayers([])}handlePcClose(){this.videoPublished=!1,this.sendTransceiver=null}_reduceRequestLayerIds(e){var t;if(!e.length)return e;const i=new Map,s=pe(),a=Se(),n=Math.min(this.maxSendLayerId,this.hdVideoEnabled?a:Math.min(2,a));return e.map((e=>{let t=Math.max(s,Math.min(n,e));for(;!ge(t);)--t;return t})).forEach((e=>{const t=this.getEncodingIndex(e),s=i.get(t);(void 0===s||e<s)&&i.set(t,e)})),l()(t=Array.from(i.values())).call(t)}onMediaRequest(e){const t=!!e.length;this.requestedLayerIds=[...e];const i=this._reduceRequestLayerIds(e);qe(J("WMSC_New_Media_Request: layer ids: ".concat(JSON.stringify(e)," -> ").concat(JSON.stringify(i)))),this.sendLayerIds=i,this.mediaRequested!==t?(this.mediaRequested=t,this.videoPublished&&(t?this._onVideoStart():this._onVideoStop())):this.videoPublished&&t&&ze.updateLayers(this.sendLayerIds)}resendVideo(){this.requestedLayerIds.length&&this.onMediaRequest(this.requestedLayerIds)}async onQosMessage(e){switch(e.type){case y.LAYERS_UPDATE:return this.onLayersAllocationUpdate(e.data);case y.MIN_BITRATE_UPDATE:return this.updateMinOutgoingBitrate(e.data)}}async onLayersAllocationUpdate(e){this.encodingMap.clear(),e.forEach((e=>{const t=this.getEncodingIndex(e.layerId);this.encodingMap.set(t,e)})),await this._updateSendParameters()}async updateMinOutgoingBitrate(e){if(!this.pc)throw new Error("Egress peer connection has not been created");return qe("WMSC_Update_Min_Bitrate: ".concat(e)),ze.resetSendStats(),new Promise(((t,i)=>{this.messageCallback({type:M.UPDATE_BITRATE,data:{bitrate:e,resolve:t,reject:i}})}))}updateMinOutgoingBitrateInSDP(e){ce.updateCodecParameters(this.pc.answer,"video","recvonly","H264",new Map([["x-google-min-bitrate",Math.floor(e/1e3)]]))}async _updateSendParameters(){const e=this.getSender();if(null==e||!e.track)return void qe("WMSC_USPTNP: ".concat(!!e));const{width:t,height:i}=this.sourceVideoSettings,s=Math.max(t,i);let a="WMSC_Update_Send_Params:";const n=e.getParameters();n.encodings.forEach(((e,t)=>{const i=this.encodingMap.get(t);if(e.active=!!i,e.active){const{layerId:n,maxBitrate:o,format:r}=i,c=Math.max(1,s/Math.max(r.width,r.height));e.maxBitrate=o,e.scaleResolutionDownBy=c,e.maxFramerate=Math.min(this.sourceVideoSettings.frameRate,function(e){var t;return(null===(t=ve(e))||void 0===t?void 0:t.maxFramerate)||0}(n)),a+=" index ".concat(t,": ").concat(n,",").concat(e.maxBitrate,",").concat(e.maxFramerate)+",".concat(e.scaleResolutionDownBy)}})),n.degradationPreference="maintain-resolution",qe(J(a));try{await e.setParameters(n)}catch(e){return $.globalTrace({logLevel:"error",log:"WMSC_SETPARAMSE",errorEvent:e}),qe("WMSC_SETPARAMSE"),Promise.reject(e)}}_getEgressRemoteCodecParams(){return new Map([["x-google-per-layer-pli",1]])}_getIngressLocalCodecParams(){return new Map([["sps-pps-idr-in-keyframe",1]])}removeRecvCodecByProfile(e){var t;this.ingressCodecList=null===(t=this.ingressCodecList)||void 0===t?void 0:t.filter((t=>{let{codecName:i,codecParams:s}=t;return"H264"!==i||parseInt(s.get("profile-level-id"),16)!==parseInt(e,16)}))}init(e,t){this.pc=e,ze.resetRecv(),ze.resetSend(),this.addSendTransceiver();for(let e=0;e<t;e++)this.addRecvTransceiver()}addSendTransceiver(){if(!this.pc)throw new Error("Peer connection has not been created");return this.sendTransceiver=this.pc.createSendTransceiver(je.zu.MainVideo,{sendEncodings:this.getSendEncodings(this.numSimulcastLayers)}),this.sendTransceiver}addRecvTransceiver(){if(!this.pc)throw new Error("Peer connection has not been created");const e=this.pc.createRecvTransceiver(je.zu.MainVideo);try{let t=this.recvPreferCodecs;this.senderCodec&&(t=[...this.recvPreferCodecs,this.senderCodec]),this.recvCodecNum>0&&e.transceiver.setCodecPreferences(t)}catch(e){$.globalTrace({logLevel:"error",log:"WMSC_CODECPREFERENCE_ERROR",errorEvent:e}),qe("WMSC_CPE")}return e}mungeLocalOffer(e){let t=!1;const i=this.headerExtMap.get("send"),s=this.headerExtMap.get("recv");ce.filterCodecs(e,((e,a)=>{const{type:n,direction:o}=a;if("video"!==n)return!0;t=!0;const{codecName:r,codecParams:c,payloadType:d}=e;return"flexfec-03"===r||"H264"===r&&"1"===c.get("packetization-mode")&&("sendonly"===o?(Z(c.get("profile-level-id"))&&(this.sendCBPPayloadType=d),this.pc.currentRemoteDescription?i&&(a.extensionMap=i):this.headerExtMap.set("send",a.extensionMap)):"recvonly"===o&&(X(c.get("profile-level-id"))&&(this.recvHigh444PayloadType=d),this.pc.currentRemoteDescription?s&&(a.extensionMap=s):this.headerExtMap.set("recv",a.extensionMap)),!0)})),t&&(ce.mungeEgressLocalOffer(e,this.numSimulcastLayers,this.pc.mainEgressStreamId,!this.pc.answer),ce.mungeIngressLocalOffer(e,this._getIngressLocalCodecParams()))}mungeAnswer(e){ce.updateCodecParameters(e,"video","recvonly","H264",this._getEgressRemoteCodecParams())}updateConfigFromSdp(e){const t=e.media.find((e=>"video"===e.type&&"recvonly"===e.direction));if(t){const e=ce.getMediaStartBandwidth(t);e&&ze.setStartBandwidth(e)}}saveRecvMLineTemp(){var e;const t=null===(e=this.pc)||void 0===e?void 0:e.answer.media.find((e=>{const{type:t,direction:i}=e||{};return"video"===t&&"sendonly"===i}));t&&(this.recvMLineTemp=He({},t))}updateRecvMLineTemp(e){const{ice_pwd:t,ice_ufrag:i}=e;this.recvMLineTemp&&(this.recvMLineTemp.icePwd=t,this.recvMLineTemp.iceUfrag=i)}addRecvVideoSDP(e){if(!this.recvMLineTemp)throw new Error("No receive video m-line template");const{transceiver:t,msid:i,mediaType:s,ssrcs:a={},user_id:n}=e,{rtp:o,rtx:r,flexfec:c}=a,{mid:d}=t,l=o||ce.generateSsrc(),h=r||ce.generateSsrc(),u=c||ce.generateSsrc(),m=i||ce.generateUuid(),p=ce.generateUuid();if(s===je.zu.MainVideo){const e=He({},this.recvMLineTemp);e.mid=d,e.msid={streamId:m,trackId:p},e.ssrcGroups=[{semantics:"FID",ssrcs:[l,h]},{semantics:"FEC-FR",ssrcs:[l,u]}],e.ssrcs=[{ssrc:l,attribute:"cname:".concat(m)},{ssrc:l,attribute:"msid:".concat(m," ").concat(p)},{ssrc:h,attribute:"cname:".concat(m)},{ssrc:h,attribute:"msid:".concat(m," ").concat(p)},{ssrc:u,attribute:"cname:".concat(m)},{ssrc:u,attribute:"msid:".concat(m," ").concat(p)}],this.pc.addMLineSDPToAnswer(d,e)}return{mid:d,media_type:s,msid:m,ssrcs:{rtp:l,rtx:h,flexfec:u},user_id:n}}saveCodecList(){var e;let t,i;null===(e=this.pc)||void 0===e||e.answer.media.some((e=>{const{type:s,direction:a}=e||{};return"video"===s&&"recvonly"===a?t=e:"video"===s&&"sendonly"===a&&(i=e),t&&i})),t&&(this.egressCodecList=[...t.codecs]),i&&(this.ingressCodecList=i.codecs.filter((e=>{let{codecName:t}=e;return"H264"===t})))}updateEgressAnswerCodec(e){if(this.egressCodecList){const t=this.pc.answer.media.find((e=>{const{type:t,direction:i}=e||{};return"video"===t&&"recvonly"===i}));let i,s=[];if(this.egressCodecList.forEach((t=>{const{codecName:a,codecParams:n,payloadType:o}=t;if(s.push(o),"H264"===a){const s=n.get("profile-level-id");e?Z(s)&&(i=t):K(s)&&(i=t)}})),i){t.codecs=[i],t.payloadTypes=[i.payloadType];const e=this.egressCodecList.find((e=>{const{codecName:t,codecParams:s}=e;return"rtx"===t&&s.associatedPayloadType===i.payloadType}));e&&(t.codecs.push(e),t.payloadTypes.push(e.payloadType))}else t.codecs=this.egressCodecList,t.payloadTypes=s}}getRecvCodecPayloads(){const e=[];if(this.ingressCodecList){const t=Te("recv");this.ingressCodecList.forEach((i=>{const{codecName:s,codecParams:a,payloadType:n}=i;if("H264"===s){const i=a.get("profile-level-id");e.length>0&&(t&&X(i)||!t&&K(i))?(e.push(e[0]),e[0]=n):e.push(n)}}))}return e}getPreferPayloadTypes(e){const t=Te(e);return"recv"===e&&t&&this.recvHigh444PayloadType?[this.recvHigh444PayloadType]:"send"===e&&t&&this.sendCBPPayloadType?[this.sendCBPPayloadType]:[]}},Je=1,Ke=2,Xe=3,Ze=4,$e=6,et=7,tt=8,it=9,st=10,at=110,nt=206,ot=32769,rt=32770,ct=32771,dt=32776,lt=(e,t,i,s,a,n,o,r)=>{const c={type:tt,confID:e,last_stream_request_msg_index:o,stream_status_msg_index:r};return null!=t&&t.length&&(c.created=t),null!=i&&i.length&&(c.deleted=i),null!=s&&s.length&&(c.updated=s),a&&(c.codec_preference=a),n&&(c.ice_restart_req=n),c};const ht=$.getTracer("WmscMidMgr"),ut=e=>{ht.log(e),$.monitorLog("".concat(e))};class mt{constructor(){this.hasPausedVideo=!1,this.hwDecoderLimit=L,this.mIdResource=new Map,this.userId2Media=new Map,this.midTypeMap={[je.zu.MainAudio]:je.zu.MainVideo,[je.zu.MainVideo]:je.zu.MainAudio,[je.zu.ShareAudio]:je.zu.ShareVideo,[je.zu.ShareVideo]:je.zu.ShareAudio},this.ssrcMidMap=new Map,this.mid2DetectVideo=new Map}getMainVideoMId(e){const t=this.userId2Media.get(e);return t?t.midMapping.MainVideo:""}getUserId(e){let t;const i=this.mIdResource.get(e);return i&&(t=i.userId),{userId:t,group:null}}getVideoTagsByMId(e){const t=this.mIdResource.get(e);if(t){const{userId:e}=t;if(e){const t=this.userId2Media.get(e);if(null==t?void 0:t.mainVideoDoms)return Array.from(null==t?void 0:t.mainVideoDoms)}}}getVideoTagsByUserId(e){const t=this.userId2Media.get(e);return(null==t?void 0:t.mainVideoDoms)?Array.from(null==t?void 0:t.mainVideoDoms):[]}saveVideoTag(e,t){const i=this._getOrCreateMediaInfo(e);i.mainVideoDoms||(i.mainVideoDoms=new Set),i.mainVideoDoms.add(t),i.mainVideoStream?this._setVideoTagStream(t,i.mainVideoStream,e):e===I&&this.updateActiveSpeakerVideoStream()}removeVideoTag(e,t){var i;const s=this.userId2Media.get(e);s&&(null===(i=s.mainVideoDoms)||void 0===i||i.delete(t))}_setVideoTagStream(e,t,i){(!e.srcObject||e.srcObject&&t&&e.srcObject!==t)&&(e.srcObject=t,e.onpause=()=>{ut("WMSC_V_Tag_Pause: ".concat(i,"|").concat(document.hidden,"|").concat(document.visibilityState)),this.hasPausedVideo=!0})}setVideoSize(e,t){this._getOrCreateMediaInfo(e).videoSize=t}getVideoSizeByUserId(e){var t;const i=this.userId2Media.get(e);return i&&null!==(t=i.videoSize)&&void 0!==t?t:-1}getHasPausedVideo(){if(this.hasPausedVideo)return!0;let e=!1;for(const[,t]of this.userId2Media){const{midMapping:i,mainVideoDoms:s,videoSize:a}=t;if(-1!==a&&i.MainVideo&&s)for(const t of s)if(t.paused){e=!0;break}if(e)break}return e}playAllUsedVideoTag(){const e=[];if("visible"===document.visibilityState)for(const[e,t]of this.userId2Media){const{midMapping:i,mainVideoDoms:s,videoSize:a}=t;if(-1!==a&&i.MainVideo&&s)for(const t of s)if(t.paused&&"active"in t.srcObject){const i=t.srcObject.active;return i?t.play().then((()=>Promise.resolve())).catch((t=>Promise.reject("".concat(e,"|errorName:").concat(null==t?void 0:t.name,"|errorMessage:").concat(null==t?void 0:t.message)))):(ut("WMSC_V_Tag_C_P: ".concat(e,"|").concat(!!(null==t?void 0:t.srcObject),"ï½œ").concat(i)),Promise.reject(e))}}return e.length<=0?Promise.resolve():Promise.all(e).then((()=>(this.hasPausedVideo=!1,Promise.resolve()))).catch((e=>(this.hasPausedVideo=!0,Promise.reject(e))))}changeHWDecodeLimit(e){if(K(e)&&((0,re.UP)()||(0,re._J)())){if((0,re.U0)()||(0,re.uF)())return void(this.hwDecoderLimit=8);if((0,re.Zs)())return void(this.hwDecoderLimit=16)}this.hwDecoderLimit=L}addMidResource(e,t){const i=this._getOrCreateMIdResource(e),{streamId:s,track:a,transceiver:n}=t;if(s&&(i.streamId=s),a&&(i.track=a),n&&(i.transceiver=n),i.userId&&a)ut("WMSC_WAFT-".concat(i.userId,"-").concat(e,"-").concat(i.streamId)),$.globalTrace({logLevel:"directReport",log:"WMSC_WAFT-".concat(i.userId,"-").concat(e,"-").concat(i.streamId)}),i.mediaType===je.zu.MainVideo&&this._assignVideoStream(i.userId,a);else if("video"===(null==a?void 0:a.kind)){const t=document.createElement("video");this.mid2DetectVideo.set(e,t),t.onloadedmetadata=()=>{this.attachMidByCSRC(e)},t.srcObject=new MediaStream([a])}}removeMidResource(e){this.mIdResource.delete(e),this.detachMid(e),this.removeAssociateDetectVideo(e)}attachMid(e,t,i){let s=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];this.removeAssociateDetectVideo(t);const a=this._getOrCreateMIdResource(t);a.userId?a.userId===e?$.globalTrace({logLevel:"directReport",log:"WMSC_CLIASSO-".concat(e,"-").concat(t)}):(ut("WMSC_REASSO-".concat(e,"-").concat(t)),$.globalTrace({logLevel:"error",log:"WMSC_REASSO-".concat(e,"-").concat(t)})):(ut("WMSC_ASSO-".concat(e,"-").concat(t,"-").concat(a.streamId)),this._getOrCreateMediaInfo(e).midMapping[i]=t,a.userId=e,a.mediaType=i,a.isCurrentSession=s,i===je.zu.MainVideo&&a.track&&this._assignVideoStream(e,a.track))}detachMid(e){const t=this.mIdResource.get(e);if(t&&t.userId){const i=this.userId2Media.get(t.userId);i&&i.midMapping[t.mediaType]===e&&delete i.midMapping[t.mediaType]}}getUserIdByMid(e){var t;return null===(t=this.mIdResource.get(e))||void 0===t?void 0:t.userId}getMactchedMSIDByUserId(e,t){var i,s;const a=null===(i=this.userId2Media.get(e))||void 0===i?void 0:i.midMapping[this.midTypeMap[t]];return a?null===(s=this.mIdResource.get(a))||void 0===s?void 0:s.streamId:""}_getOrCreateMediaInfo(e){let t=this.userId2Media.get(e);return t||(t={midMapping:{}},this.userId2Media.set(e,t)),t}setActiveSpeaker(e){this.activeSpeaker=H(e),this.updateActiveSpeakerVideoStream()}updateActiveSpeakerVideoStream(){return e=this,t=void 0,s=function*(){var e;const t=this.userId2Media.get(I);if(t){const i=this.userId2Media.get(this.activeSpeaker);if(i){const s=i.midMapping.MainVideo;if(s&&s!==t.midMapping.MainVideo){const{track:i,userId:a}=this.mIdResource.get(s)||{};t.midMapping.MainVideo=s;try{if(yield this.detectCanplay(i,s,a),a===this.activeSpeaker){const s=t.mainVideoStream||new MediaStream,a=s.getVideoTracks()[0];s.addTrack(i),a&&s.removeTrack(a),t.mainVideoStream||(t.mainVideoStream=s,null===(e=t.mainVideoDoms)||void 0===e||e.forEach((e=>{this._setVideoTagStream(e,s,I)})))}}catch(e){$.globalTrace({logLevel:"directReport",log:"WMSC_ACSPCPF"})}}}}},new((i=void 0)||(i=Promise))((function(a,n){function o(e){try{c(s.next(e))}catch(e){n(e)}}function r(e){try{c(s.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((s=s.apply(e,t||[])).next())}));var e,t,i,s}createDetectVideoTag(){this.canplayDetectVideo=document.createElement("video"),this.canplayDetectVideo.autoplay=!0,this.canplayDetectVideo.playsInline=!0,this.canplayDetectVideo.style.position="fixed",this.canplayDetectVideo.style.width="1px",this.canplayDetectVideo.style.height="1px",this.canplayDetectVideo.style.bottom="0px",this.canplayDetectVideo.style.right="0px",this.canplayDetectVideo.style.zIndex="9999",this.canplayDetectVideo.style.pointerEvents="none",this.canplayDetectVideo.muted=!0,this.canplayDetectVideo.id=U,document.body.appendChild(this.canplayDetectVideo)}detectCanplay(e,t,i){return this.canplayDetectVideo||(this.canplayDetectVideo=document.querySelector("#".concat(U)))||this.createDetectVideoTag(),this.canplayTimer&&clearTimeout(this.canplayTimer),this.canplayDetectVideo.srcObject&&this.canplayReject&&this.canplayReject(),new Promise(((s,a)=>{this.canplayReject=a,this.canplayTimer=setTimeout((()=>{ut("WMSC_ACSPCP_TIMEOUT-".concat(t,"-").concat(i)),$.globalTrace({logLevel:"error",log:"WMSC_ACSPCP_TIMEOUT-".concat(t,"-").concat(i)})}),1500),this.canplayDetectVideo.oncanplay=()=>{clearTimeout(this.canplayTimer),this.canplayDetectVideo.srcObject=null,s()},this.canplayDetectVideo.srcObject=new MediaStream([e])}))}getUserIdBySsrc(e){var t;const i=this.ssrcMidMap.get(e);if(i)return null===(t=this.mIdResource.get(i))||void 0===t?void 0:t.userId}getMediaTypeBySsrc(e){var t;const i=this.ssrcMidMap.get(e);if(i)return null===(t=this.mIdResource.get(i))||void 0===t?void 0:t.mediaType}getMediaTypeByMid(e){var t;if(e)return null===(t=this.mIdResource.get(e))||void 0===t?void 0:t.mediaType}isMlineCurrentSessionByMid(e){var t;return null===(t=this.mIdResource.get(e))||void 0===t?void 0:t.isCurrentSession}attachMidByCSRC(e){var t;this.removeAssociateDetectVideo(e);const i=this.mIdResource.get(e);if(i){const{transceiver:s}=i;if(s){const i=null===(t=s.receiver)||void 0===t?void 0:t.getContributingSources();if(i.length>0){const{source:t}=i[0],s=H(t);this.attachMid(s,e,je.zu.MainVideo,!0)}}}}removeAssociateDetectVideo(e){const t=this.mid2DetectVideo.get(e);t&&(t.onloadedmetadata=null,t.srcObject=null,this.mid2DetectVideo.delete(e))}getAudioMidByUserId(e){const t=this.userId2Media.get(e);return(null==t?void 0:t.midMapping.MainAudio)||""}_assignVideoStream(e,t){var i;const s=this._getOrCreateMediaInfo(e);s.mainVideoStream=new MediaStream([t]),null===(i=s.mainVideoDoms)||void 0===i||i.forEach((t=>{this._setVideoTagStream(t,s.mainVideoStream,e)})),e===this.activeSpeaker&&this.updateActiveSpeakerVideoStream()}_getOrCreateMIdResource(e){let t=this.mIdResource.get(e);return t||(t={},this.mIdResource.set(e,t)),t}removeAllMIdResource(){for(const[e]of this.mid2DetectVideo)this.removeAssociateDetectVideo(e);this.mid2DetectVideo.clear(),this.mIdResource.clear(),this.canplayDetectVideo&&(this.canplayDetectVideo.oncanplay=null,this.canplayDetectVideo.srcObject=null)}}const pt=new class{constructor(){this.sendVideoSizeLowerLimit=0,this.sendVideoSizeUpperLimit=4,this.recvVideoSizeLowerLimit=0,this.recvVideoSizeUpperLimit=4,this.recvVideoNumLowerLimit=4,this.recvVideoNumUpperLimit=(0,re.GN)()?D:w,this.sendVideoSizeLowerLimitApp=this.sendVideoSizeLowerLimit,this.sendVideoSizeUpperLimitApp=this.sendVideoSizeUpperLimit,this.recvVideoSizeLowerLimitApp=this.recvVideoSizeLowerLimit,this.recvVideoSizeUpperLimitApp=this.recvVideoSizeUpperLimit,this.recvVideoNumLowerLimitApp=this.recvVideoNumLowerLimit,this.recvVideoNumUpperLimitApp=this.recvVideoNumUpperLimit,this.maxSendVideoSize=0,this.maxRecvVideoSize=0,this.maxRecvVideoNum=0,this._reset()}_reset(){let e=3;!(0,re.Xb)()&&navigator.hardwareConcurrency>=8&&(e=4),this.maxSendVideoSize=Math.max(this.sendVideoSizeLowerLimit,this.sendVideoSizeLowerLimitApp,Math.min(this.sendVideoSizeUpperLimit,this.sendVideoSizeUpperLimitApp,e)),this.maxRecvVideoSize=Math.max(this.recvVideoSizeLowerLimit,this.recvVideoSizeLowerLimitApp,Math.min(this.recvVideoSizeUpperLimit,this.recvVideoSizeUpperLimitApp,4)),this.maxRecvVideoNum=Math.max(this.recvVideoNumLowerLimit,this.recvVideoNumLowerLimitApp,Math.min(this.recvVideoNumUpperLimit,this.recvVideoNumUpperLimitApp))}setLimits(e){const{minSendVideoSize:t,maxSendVideoSize:i,minRecvVideoSize:s,maxRecvVideoSize:a,minRecvVideoNum:n,maxRecvVideoNum:o}=e;void 0!==t&&(this.sendVideoSizeLowerLimitApp=t),void 0!==i&&(this.sendVideoSizeUpperLimitApp=i),void 0!==s&&(this.recvVideoSizeLowerLimitApp=s),void 0!==a&&(this.recvVideoSizeUpperLimitApp=a),void 0!==n&&(this.recvVideoNumLowerLimitApp=n),void 0!==o&&(this.recvVideoNumUpperLimitApp=o),this._reset()}getCapabilities(){return{maxSendVideoSize:this.maxSendVideoSize,maxRecvVideoSize:this.maxRecvVideoSize,maxRecvVideoNum:this.maxRecvVideoNum}}};i(7855);var gt=i(3472),St=i(2710),_t=i(3082);function vt(e){return null!=e&&e.length?parseInt(e.reduce(((e,t)=>e+t),0)/e.length):0}function ft(e){return null!=e&&e.length?Math.max(...e):0}const Mt=class{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._userId=e.userId,this._monitorInfo={subscriber:{},publisher:{}},this._bitrateInfo={subscriber:{},publisher:{}},this._reportCount=0,this._MONITOR_RECORD_INTERVAL=5e3,this._BITRATE_RECORD_INTERVAL=1e3,this._INBOUND_AUDIO_LEVEL_INTERVAL=1e3,this._enableBitrateReport=!1,this._uplinkMonitorInfoList=[],this._uplinkMonitorPrevTime=Date.now(),this._downlinkMonitorInfoList=[],this._downlinkMonitorPrevTime=Date.now(),this._downlinkAudioLevelInfo={},this._audioMos=[],this._networkStatistics={publisher:{},subscriber:{}},this._wmscAudio=e.wmscAudio,this._onBadNetwork=e.onBadNetwork,this._onPacketSent=e.onPacketSent,this._onMonitorLog=e.onMonitorLog,this._isMonitoring=!1,this._onEntireStatsReportBind=this._onEntireStatsReport.bind(this)}destroy(e){this.stopMonitor(e)}setEnableBitrateReport(e){this._enableBitrateReport=e}setUserId(e){this._userId=e}startMonitor(e){this.stopMonitor(e),e.on(je.f7.StatsReport,this._onEntireStatsReportBind),this._isMonitoring=!0}stopMonitor(e){e.off(je.f7.StatsReport,this._onEntireStatsReportBind),this._resetMonitorCache(),this._isMonitoring=!1}resetWMSCPC(e,t){this.stopMonitor(e),this._isMonitoring&&this.startMonitor(t)}getBitrateInfo(){return this._bitrateInfo}_resetMonitorCache(){var e,t,i,s,a,n;this._monitorInfo={subscriber:{port:null===(e=this._monitorInfo)||void 0===e||null===(e=e.subscriber)||void 0===e?void 0:e.port,protocol:null===(t=this._monitorInfo)||void 0===t||null===(t=t.subscriber)||void 0===t?void 0:t.protocol,candidateType:null===(i=this._monitorInfo)||void 0===i||null===(i=i.subscriber)||void 0===i?void 0:i.candidateType},publisher:{port:null===(s=this._monitorInfo)||void 0===s||null===(s=s.publisher)||void 0===s?void 0:s.port,protocol:null===(a=this._monitorInfo)||void 0===a||null===(a=a.publisher)||void 0===a?void 0:a.protocol,candidateType:null===(n=this._monitorInfo)||void 0===n||null===(n=n.publisher)||void 0===n?void 0:n.candidateType}},this._bitrateInfo={publisher:{},subscriber:{}},this._networkStatistics={publisher:{},subscriber:{}}}_isTimeForMonitorLog(){return!(this._reportCount%Math.floor(this._MONITOR_RECORD_INTERVAL/je.Mr))}_isTimeForBitrate(){return!(this._reportCount%Math.floor(this._BITRATE_RECORD_INTERVAL/je.Mr))}_isTimeForInboundAudioLevel(){return!(this._reportCount%Math.floor(this._INBOUND_AUDIO_LEVEL_INTERVAL/je.Mr))}_onEntireStatsReport(e){this._uplinkStatsParse(e),this._downlinkStatsParse(e),this._networkStatsParse(e),this._getRWGNetworkLog(!0),this._getRWGNetworkLog(!1),this.sendAudioMos(),this._reportCount++}_uplinkStatsParse(e){var t,i;if(!e)return;const s=this._isTimeForMonitorLog();if(this._isTimeForBitrate()&&gt.Ay.outboundBitrateQosParse(e,this._bitrateInfo.publisher),!s)return;let a={};const{publisher:n}=this._monitorInfo;if(e.forEach((e=>{0!=gt.Ay.isAudioStat(e)&&(this._statRemoteInboundRTP(e,a,n),this._statOutBoundRTP(e,a,n),this._statMediaSource(e,a,n))})),this._checkNetworkQuality(0,null===(t=a[je.zu.MainAudio])||void 0===t?void 0:t.rtt),this._onPacketSent&&this._onPacketSent(null===(i=a[je.zu.MainAudio])||void 0===i?void 0:i.packetsSent),a[je.zu.MainAudio]){const{resLevelR16Log:e,resLevelR16LogDenoise:t}=this._wmscAudio.getLevelR16Log();a[je.zu.MainAudio].audioLevelR16Str=e,a[je.zu.MainAudio].audioLevelR16DenoiseStr=t}this._handleUplinkMonitorLog(a)}_downlinkStatsParse(e){var t;if(!e)return;const i=this._isTimeForMonitorLog(),s=this._isTimeForBitrate(),a=this._isTimeForInboundAudioLevel();let n={ssrcMap:{}};s&&gt.Ay.inboundBitrateQosParse(e,null===(t=this._bitrateInfo)||void 0===t?void 0:t.subscriber);let o=i;const{subscriber:r}=this._monitorInfo;e.forEach((e=>{i&&this._downLinkCandidatePairParse(e,n),0!=gt.Ay.isAudioStat(e)&&(o=this._statInboundRTPParseReturnShoudSendMonitor(e,n,r,a&&!i)||o)})),i&&this._checkNetworkQuality(1,n.rtt),o&&this._handleDownlinkMonitorLog(n)}async _networkStatsParse(e){e.forEach((t=>{gt.Ay.networkInfoStatisticsParse(e,t,this._monitorInfo.publisher,"publisher"),gt.Ay.networkInfoStatisticsParse(e,t,this._monitorInfo.subscriber,"subscriber")}))}_statRemoteInboundRTP(e,t,i){"remote-inbound-rtp"==e.type&&gt.Ay.remoteInboundRTPStatisticParse(je.zu.MainAudio,e,this._wmscAudio.getAudioMode(),t,i)}_statOutBoundRTP(e,t,i){"outbound-rtp"==e.type&&gt.Ay.outboundRTPStatisticsParse(this._wmscAudio.getUplinkMid2MediaType(e.mid),e,this._wmscAudio.getAudioMode(),t,i)}_statMediaSource(e,t,i){let s=this._wmscAudio.getAudioStream();"media-source"==e.type&&gt.Ay.mediaSourceStatisticsParse(s,e,this._wmscAudio.getAudioMode(),t,i)}_downLinkCandidatePairParse(e,t){const{subscriber:i}=this._monitorInfo,{totalRoundTripTime:s,responsesReceived:a,type:n,state:o,nominated:r}=e;if("candidate-pair"===n&&"succeeded"===o&&r){i.prevStatInfo||(i.prevStatInfo={responsesReceived:a,totalRoundTripTime:s},i.ssrcMap={});const{prevStatInfo:e}=i;Object.assign(t,{rtt:Math.floor(1e3*(a===e.responsesReceived?0:(s-e.totalRoundTripTime)/(a-e.responsesReceived)))}),Object.assign(i.prevStatInfo,{totalRoundTripTime:s,responsesReceived:a})}}_statInboundRTPParseReturnShoudSendMonitor(e,t,i,s){if("inbound-rtp"!=e.type)return;let a;const{totalAudioEnergy:n,timestamp:o,jitterBufferDelay:r,jitterBufferEmittedCount:c,jitterBufferMinimumDelay:d,jitterBufferTargetDelay:l,ssrc:h,jitter:u,audioLevel:m,packetsLost:p,packetsDiscarded:g,packetsReceived:S,bytesReceived:_,concealedSamples:v,concealmentEvents:f,insertedSamplesForDeceleration:M,removedSamplesForAcceleration:y,silentConcealedSamples:C,totalProcessingDelay:I}=e;if(this._cacheDownlinkAudioLevel(h,m),s)return!1;i.ssrcMap||(i.ssrcMap={});let T=this._wmscAudio.getNodeIdByWebRTCSSRC(h);if(!T)return;let R=i.ssrcMap[h];if(R){a=!0;const i=Math.sqrt((n-R.totalAudioEnergy)/(o-R.timestamp)).toFixed(4);let s=-1;"number"==typeof m&&(s=m.toFixed(4));const{aveJitterBufferDelay_ms:r,aveJitterBuffeTargetrDelay_ms:c,avePacketsReceived_in_s:l,aveBytesReceived_in_s:p,totalProcessingDelay_in_5s:g,packetsDiscarded_in_5s:S,insertedSamplesForDeceleration_in_5s:_,packetsLost_in_5s:M}=this._getDownlinkStaticsRate(e,R);let I=this._wmscAudio.getRemoteAudioPlayerByMid(e.mid);t.ssrcMap["".concat(h,"-").concat(T)]=Object.assign(t.ssrcMap["".concat(h,"-").concat(T)]||{},{aveAudioLevel:i<1e-4?0:i,audioLevel:s<1e-4?0:s,jitter:u,jitterBufferMinimumDelay:d,concealedSamples:v,concealmentEvents:f,insertedSamplesForDeceleration_in_5s:_,removedSamplesForAcceleration:y,silentConcealedSamples:C,audioPlayerStatus:I?I.isPaused()?0:1:-1,totalAudioEnergy:n,aveJitterBufferDelay_ms:r,aveJitterBuffeTargetrDelay_ms:c,avePacketsReceived_in_s:l,aveBytesReceived_in_s:p,totalProcessingDelay_in_5s:g,packetsDiscarded_in_5s:S,packetsLost_in_5s:M})}else R=i.ssrcMap[h]={},a=!1;return this._wmscAudio.isUserMuted(T,h)||!T?i.ssrcMap[h]=null:Object.assign(R,{totalAudioEnergy:n,timestamp:o,jitterBufferDelay:r,jitterBufferEmittedCount:c,packetsLost:p,packetsReceived:S,bytesReceived:_,jitterBufferTargetDelay:l,totalProcessingDelay:I,insertedSamplesForDeceleration:M,packetsDiscarded:g}),a}_checkNetworkQuality(e,t){t&&this._onBadNetwork&&(t>5e3?this._onBadNetwork({isUplink:0===e,networkLevel:St.tT.NET_QUALITY_VERY_BAD,bwLevel:St.LA.NET_BW_LEVEL_VERY_LOW}):t>2e3&&this._onBadNetwork({isUplink:0===e,networkLevel:St.tT.NET_QUALITY_BAD,bwLevel:St.LA.NET_BW_LEVEL_LOW}))}_handleUplinkMonitorLog(e){if(this._uplinkMonitorInfoList.push(e),Date.now()-this._uplinkMonitorPrevTime<=14e3)return;let t="",i="";const s=this._uplinkMonitorInfoList.reduce(((e,s,a)=>{let n="";return Object.keys(s).forEach(((e,a,o)=>{const{rtt:r="",bytesSentPerSecond:c,packetsSent:d,audioLevelR16Str:l="",audioLevelR16DenoiseStr:h="",targetBitrate:u="",nackCount:m="",retransmittedBytesSent:p="",retransmittedPacketsSent:g="",audioLevel:S="",echoReturnLoss:_="",echoReturnLossEnhancement:v="",totalAudioEnergy:f="",totalSamplesDuration:M=""}=s[e];t+=l,i+=h||l;const y=e==je.zu.MainAudio?St.vm:St.FP;n+="{".concat(y,"}").concat(r,"|").concat(c,"|").concat(d,"|").concat(u,"|").concat(m,"|").concat(p,"|").concat(g,"|").concat(S,"|").concat(_,"|").concat(v,"|").concat(f,"|").concat(M)})),a===this._uplinkMonitorInfoList.length-1?n+=",{[SPEECH_R16]},".concat(t,",").concat(i,",{[END]}"):n+="#",e+n}),"WCL_AB,{[UPLINK]},");this._onMonitorLog&&this._onMonitorLog(s),this._uplinkMonitorPrevTime=Date.now(),this._uplinkMonitorInfoList=[]}_cacheDownlinkAudioLevel(e,t){const i=this._wmscAudio.getNodeIdByWebRTCSSRC(e);if(!i)return;let s="".concat(e,"-").concat(i);this._downlinkAudioLevelInfo[s]||(this._downlinkAudioLevelInfo[s]=[]),this._downlinkAudioLevelInfo[s].push(_t.ey(t))}_handleDownlinkMonitorLog(e){if(Object.keys(this._downlinkAudioLevelInfo).forEach((t=>{e.ssrcMap[t]&&(e.ssrcMap[t].zoomAudioLevel=this._downlinkAudioLevelInfo[t])})),this._downlinkAudioLevelInfo={},this._downlinkMonitorInfoList.push(e),Date.now()-this._downlinkMonitorPrevTime<=14e3)return;let t=this._downlinkMonitorInfoList.reduce(((e,t,i)=>{const{rtt:s,ssrcMap:a}=t;let n="";return Object.keys(a).forEach(((e,t,o)=>{const{aveAudioLevel:r,audioLevel:c,jitter:d,zoomAudioLevel:l,jitterBufferMinimumDelay:h,concealedSamples:u,concealmentEvents:m,insertedSamplesForDeceleration_in_5s:p,removedSamplesForAcceleration:g,silentConcealedSamples:S,audioPlayerStatus:_,totalAudioEnergy:v,aveJitterBufferDelay_ms:f,aveJitterBuffeTargetrDelay_ms:M,avePacketsReceived_in_s:y,aveBytesReceived_in_s:C,totalProcessingDelay_in_5s:I,packetsDiscarded_in_5s:T,packetsLost_in_5s:R}=a[e];n+="".concat(void 0===s?"":s,"|{[SSRCLOG]}|{").concat(e,"}|").concat(_,"|").concat(v.toFixed(4),"|").concat(l.join(""),"|").concat(_t.ey(Number(c)),"|").concat(_t.ey(Number(r)),"|").concat(1e3*d,"|").concat(f,"|").concat(M,"|").concat(R,"|").concat(y,"|").concat(C,"|").concat(h,"|").concat(T,"|").concat(u,"|").concat(m,"|").concat(p,"|").concat(g,"|").concat(S,"|").concat(I),i===this._downlinkMonitorInfoList.length-1&&t===o.length-1||(n+="#")})),e+n}),"WCL_AB,{[DOWNLINK]},");t+=",{[END]}",this._onMonitorLog&&this._onMonitorLog(t),this._downlinkMonitorPrevTime=Date.now(),this._downlinkAudioLevelInfo={},this._downlinkMonitorInfoList=[]}_getDownlinkStaticsRate(e,t){const{timestamp:i,jitterBufferDelay:s,jitterBufferEmittedCount:a,jitterBufferTargetDelay:n,packetsLost:o,packetsDiscarded:r,packetsReceived:c,bytesReceived:d,insertedSamplesForDeceleration:l,totalProcessingDelay:h}=e;return{aveJitterBufferDelay_ms:this._calculateRate(t.jitterBufferDelay,t.jitterBufferEmittedCount,s,a,1),aveJitterBuffeTargetrDelay_ms:this._calculateRate(t.jitterBufferTargetDelay,t.jitterBufferEmittedCount,n,a,1),avePacketsReceived_in_s:this._calculateRate(t.packetsReceived,t.timestamp,c,i),aveBytesReceived_in_s:this._calculateRate(t.bytesReceived,t.timestamp,d,i),totalProcessingDelay_in_5s:this._calculateRate(t.totalProcessingDelay,0,h,1,1),packetsDiscarded_in_5s:this._calculateRate(t.packetsDiscarded,0,r,1,1),insertedSamplesForDeceleration_in_5s:this._calculateRate(t.insertedSamplesForDeceleration,0,l,1,1),packetsLost_in_5s:this._calculateRate(t.packetsLost,0,o,1,1)}}_calculateRate(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1e3;return e===i||t===s?0:Math.floor(a*(i-e)/(s-t))}setAudioStatisticsFromRWG(e){const t=e.encoding?this._networkStatistics.publisher:this._networkStatistics.subscriber;Object.keys(e).forEach((i=>{"avg_mos"===i?this._audioMos.push(e[i]):(t[i]||(t[i]=[]),void 0!==e[i]&&t[i].push(e[i]))}))}sendAudioMos(){var e,t;if(!(arguments.length>0&&void 0!==arguments[0]&&arguments[0]||this._reportCount&&this._reportCount%10==0))return;const i=null===(e=this._audioMos)||void 0===e?void 0:e.length;if(!i)return;const s=this._audioMos[i-1].toFixed(2),a=(this._audioMos.reduce(((e,t)=>e+t),0)/i).toFixed(2);this._audioMos.length=0;const n="WCL_MCM_AUDIO,".concat(this._userId,",,,{[SPEECH_R16]},,,,,,{[PROCESS]},,,{[NETWORK]},,,,{[AUDIOSCORE]},,,,,,,,,,,,,,{[QUALITY]},").concat(s,",").concat(a,",{[SEND]},,,{[DENOISE]},,,,{[END]}");null===(t=this._onMonitorLog)||void 0===t||t.call(this,n)}_getRWGNetworkLog(e){var t,i;if(0===this._reportCount||this._reportCount%12!=0)return;const s=e?this._monitorInfo.publisher:this._monitorInfo.subscriber,a=e?this._networkStatistics.publisher:this._networkStatistics.subscriber,n=e?"RWG_UPLINK_NETWORK":"RWG_DOWNLINK_NETWORK",o="udp"===s.protocol?0:1,r=Math.floor(Date.now()/1e3),c=e?(null===(t=this._bitrateInfo)||void 0===t||null===(t=t.publisher)||void 0===t?void 0:t.bitrate)||0:(null===(i=this._bitrateInfo)||void 0===i||null===(i=i.subscriber)||void 0===i?void 0:i.bitrate)||0,d=c,l=vt(a.avg_loss),h=ft(a.max_loss),u=vt(a.rtt),m=ft(a.rtt),p=u/2,g=m/2,S=vt(a.jitter),_=ft(a.jitter);e?this._networkStatistics.publisher={}:this._networkStatistics.subscriber={};const v="".concat(n,",").concat(this._userId,",").concat(1,",").concat(o,",").concat(r,",,").concat(d,",").concat(c,",").concat(l,",").concat(h,",,").concat(p,",").concat(g,",").concat(u,",").concat(m,",,,,,,,,,,,").concat(S,",").concat(_);this._onMonitorLog(v)}static getEstimatePlayoutTimestampFromStatsByMid(e,t){var i;let s;for(const[,i]of e)if("inbound-rtp"===i.type&&"audio"===i.kind&&i.mid===t){s=i;break}return null===(i=s)||void 0===i?void 0:i.estimatedPlayoutTimestamp}};function yt(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,s)}return i}function Ct(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?yt(Object(i),!0).forEach((function(t){(0,c.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):yt(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const It=$.getTracer("WmscMonitor"),Tt=e=>{It.log(e),$.monitorLog("".concat(e))},{tT:Rt,LA:bt,ue:Et}=s,At=new class{constructor(){this.bToPrint=!0,this.mIdMgr=null,this.captureTimer=null,this.reportTimer=null,this.userId="",this.recvStats={},this.sendStats={},this.isMonitoring=!1,this.subInfo={},this.activeSpeaker="",this.isPreActiveSpeaker=!1,this.recordUserId="",this.captureTimer=null,this.reportTimer=null,this.lastSendPCsStatRecord=new Map,this.captureCount=0,this.rtpHeaderExt={"http://www.webrtc.org/experiments/rtp-hdrext/playout-delay":0,"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01":1,"urn:ietf:params:rtp-hdrext:sdes:mid":2,"http://www.webrtc.org/experiments/rtp-hdrext/video-layers-allocation00":3},this.sdpDirection={recvonly:0,sendonly:1,sendrecv:2,inactive:3},this.recvStatisticData={},this.reportCount=0,this.maxSubscribedSize=-1,this._telemetry=null,this.uiQosData={},this.isUISubQos=!1,this.UIQosInterval=1,this.candidateLog={0:"",1:"",2:"",3:"",4:""},this.candidatePairLog={0:"",1:"",2:"",3:"",4:""},this.iceCandidatePairState={frozen:0,waiting:1,"in-progress":2,failed:3,succeeded:4},this.candidatePairMonitorLog=new Array(5).fill(""),this.candidatePairChangeCount=new Array(5).fill(0),this.ingressReport={},this.camStream=null,this.recvCodecProfile="",this.shouldReportNullDecoderError=!0,this.shouldReportEncodeFailedError=!0,this.recvRawStats={},this.sendRawStats={},this.ssrcLayerMap={},this.rawLog=[],this.prevUplinkState={},this.prevDownlinkState={},this.networkReportDelay=0,this.isDualCall=!1,this.layerStatus={numOfActive:0,numOfStopSending:0},this.isWebRTCVideoEnabled=!1}setTelemetry(e){this._telemetry="function"==typeof e?e:null}updateQosSubscription(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3;this.isUISubQos=e,this.UIQosInterval=Math.round(t/1e3)}setUserId(e){this.userId=parseInt(e,10)}setQoSDataCb(e){this.sendQoSData=e}updateSubInfo(e,t){Tt("WMSC_USBI: ".concat(e,"|").concat(t)),t>=0?this.subInfo[e]=t:(delete this.subInfo[e],this.resetRecvStats(e)),It.log("updateSubInfo:",this.subInfo)}setActiveSpeaker(e,t){this.activeSpeaker=H(parseInt(e,10)),this.isPreActiveSpeaker=t}updateSubscribedSize(e,t,i){let s=-1;Array.from(new Set([...e,...t,...i])).forEach((e=>{s=Math.max(s,e)})),this.maxSubscribedSize=s}start(){Tt("WMSC_MSTART: ".concat(this.isMonitoring)),this.isMonitoring||(this._startReport(),this.isMonitoring=!0,this.shouldReportNullDecoderError=!0,this.shouldReportEncodeFailedError=!0,this.networkReportDelay=0)}resetRecvStats(e){this.recvStats.statisticData&&delete this.recvStats.statisticData[e],this.recvStats["begin-video-inbound-rtp"]&&delete this.recvStats["begin-video-inbound-rtp"][e],this.recvStats["video-inbound-rtp"]&&delete this.recvStats["video-inbound-rtp"][e],this.recvStats["video-remote-outbound-rtp"]&&delete this.recvStats["video-remote-outbound-rtp"][e]}stop(){Tt("WMSC_MSTOP: ".concat(this.isMonitoring)),clearInterval(this.reportTimer),clearTimeout(this.captureTimer),this.recvStats={},this.sendStats={},this.isMonitoring=!1}getResolutionId(e){return e<=14400?0:e<=57600?1:e<=230400?2:e<=921600?3:e<=2073600?4:5}_sendQosData(){if(this.isUISubQos&&this.captureCount%this.UIQosInterval==0){if(this.uiQosData.receiving){const e=this.recvStats["candidate-pair"]||{},{currentRoundTripTime:t=0}=e,i=Math.round(1e3*t);this._telemetry&&this._telemetry({type:F.VIDEO_QOS_DATA,data:Ct(Ct({encoding:!1},this.uiQosData.receiving),{},{rtt:i})}),this.uiQosData.receiving=null}this.uiQosData.sending&&(this._telemetry&&this._telemetry({type:F.VIDEO_QOS_DATA,data:Ct({encoding:!0},this.uiQosData.sending)}),this.uiQosData.sending=null)}}_sendNetworkState(e){const{isUplink:t}=e;let i=!1;i=t?e.networkLevel!==this.prevUplinkState.networkLevel||e.bwLevel!==this.prevUplinkState.bwLevel:e.networkLevel!==this.prevDownlinkState.networkLevel||e.bwLevel!==this.prevDownlinkState.bwLevel,i&&(this._telemetry&&this._telemetry({type:F.NETWORK_QUALITY_CHANGE,data:e}),t?this.prevUplinkState=e:this.prevDownlinkState=e)}_getNetworkState(e,t,i){let s=Rt.NET_QUALITY_UNKNOWN,a=bt.NET_BW_LEVEL_UNKNOWN;if(e>.5||t/2>5)s=Rt.NET_QUALITY_VERY_BAD;else if(e>.3||t/2>2)s=Rt.NET_QUALITY_BAD;else if(void 0!==i){const n=i/1024;n<320||e>.08&&t>.5?s=Rt.NET_QUALITY_NOT_GOOD:n>450?(s=Rt.NET_QUALITY_GOOD,a=bt.NET_BW_LEVEL_NORMAL):n>850&&e<.05&&t<.3&&(s=Rt.NET_QUALITY_EXCELLENT,a=bt.NET_BW_LEVEL_NORMAL)}return{networkLevel:s,bwLevel:a}}startCapture(e){this.captureCount++;try{this._captureRecvStats(e),this._captureSenderStats(e),this._sendQosData()}catch(e){It.error("_startCapture, capture error: ".concat(e)),Tt("WMSC_LOGCE"),$.globalTrace({logLevel:"error",log:"WMSC_LOGCE",errorEvent:e})}}_startReport(){this.reportTimer=setInterval(this._reportStats.bind(this),f)}_reportStats(){try{this.reportCount++,this._getStats(),this._resetStats(),this.ingressReport.begin=null}catch(e){Tt("WMSC_LOGRE"),$.globalTrace({logLevel:"error",log:"WMSC_LOGRE",errorEvent:e})}}_resetStats(){for(const e in this.sendStats){const{statisticData:t}=this.sendStats[e];t.maxRtt=0,t.maxCamCaptureFps=t.maxCaptureFps=0,t.minCamCaptureFps=t.minCaptureFps=Math.MAX_SAFE_INTEGER,t.totalCamCaptureCount=t.totalCaptureCount=0,t.totalCamCaptureFps=t.totalCaptureFps=0;for(const i in this.sendStats[e]["video-outbound-rtp"])t[i]={maxEncodeTime:0,minEncodeTime:Number.MAX_SAFE_INTEGER,avgEncodeTime:0,minSendFrameRate:Number.MAX_SAFE_INTEGER,maxSendFrameRate:0,avgSendFrameRate:0,minSendBitRate:Number.MAX_SAFE_INTEGER,maxSendBitRate:0,avgSendBitRate:0,minPacketSentDelay:Number.MAX_SAFE_INTEGER,maxPacketSentDelay:0,avgPacketSentDelay:0,maxLossRate:"",avgLossRate:"",encodePauseCount:0,count:0,maxQP:0,minQP:Number.MAX_SAFE_INTEGER,avgQP:0},this.sendStats[e]["begin-video-outbound-rtp"][i]=this.sendStats[e]["video-outbound-rtp"][i],this.sendStats[e]["video-remote-inbound-rtp"]&&(this.sendStats[e]["begin-video-remote-inbound-rtp"][i]=this.sendStats[e]["video-remote-inbound-rtp"][i]);this.sendStats[e]["begin-candidate-pair"]=this.sendStats[e]["candidate-pair"],this.sendStats[e]["begin-video-media-source"]=this.sendStats[e]["video-media-source"],delete this.sendStats[e].codec}for(const e in this.recvStats["video-inbound-rtp"])this.recvStats.statisticData[e]={maxFps:0,minFps:Number.MAX_SAFE_INTEGER,avgFps:0,maxDecodeTime:0,minDecodeTime:Number.MAX_SAFE_INTEGER,avgDecodeTime:0,maxLossRate:0,avgLossRate:0,maxBt:0,minBt:Number.MAX_SAFE_INTEGER,avgBt:0,maxJitter:0,minLastRecvGap:Number.MAX_SAFE_INTEGER,maxLastRecvGap:0,avgLastRecvGap:0,noDataCount:0,count:0,decodePausedCount:0,maxAVSyncDelay:0,minAVSyncDelay:Number.MAX_SAFE_INTEGER,avgAVSyncDelay:0,avSyncDelayArray:[],audioEstimatedPlayoutTimestamp:"",maxJitterBufferDelay:0,minJitterBufferDelay:Number.MAX_SAFE_INTEGER,avgJitterBufferDelay:0},this.recvStats["begin-video-inbound-rtp"][e]=this.recvStats["video-inbound-rtp"][e],this.recvStats["video-remote-outbound-rtp"]&&(this.recvStats["begin-video-remote-outbound-rtp"][e]=this.recvStats["video-remote-outbound-rtp"][e]);this.recvStats["begin-candidate-pair"]=this.recvStats["candidate-pair"],this.recvStats.statisticData&&(this.recvStats.statisticData.maxRtt=0),delete this.recvStats.codec}_captureSenderStats(e){const t=h;if(!Ye.getPc())return;const i={};this.sendStats[t]||(this.sendStats[t]={});const s={},a={};let n="",o="",r=!1,c=0,d=0;if(this.layerStatus.numOfActive=0,this.layerStatus.numOfStopSending=0,e.forEach((e=>{De.getSendStatsMonitor().onStatsReport(e);const{kind:r,type:c}=e,d="".concat(r?r+"-":"").concat(c),l="begin-".concat(d);if("video"!==r||"outbound-rtp"!==c&&"remote-inbound-rtp"!==c)if("candidate-pair"===c){const{id:t}=e;s[t]=e,o+=this._getCandidatePairLog(e)}else if("local-candidate"===c||"remote-candidate"===c){const{id:t}=e;a[t]=e,n+=this._getCandidateLog(e)}else if("codec"===c){const{id:t,mimeType:s}=e;"video/H264"===s&&(i[d]||(i[d]={}),i[d][t]=e)}else i[d]=e;else{const{ssrc:s}=e;i[d]||(i[d]={}),i[d][s]=e,this.sendStats[t][l]&&this.sendStats[t][l][s]||(this.sendStats[t][l]=Ct(Ct({},this.sendStats[t][l]),{},{[s]:e}))}})),this._captureRawSendData(i["video-media-source"]),i.candidates=a,i.candidatePairs=s,i.transport){const{selectedCandidatePairId:e,dtlsState:n}=i.transport;if("connected"===n){const n=s[e];if(n){const{localCandidateId:e,remoteCandidateId:s}=n;i["remote-candidate"]=a[s],i["local-candidate"]=a[e],i["candidate-pair"]=n,this.sendStats[t]["begin-candidate-pair"]||(this.sendStats[t]["begin-candidate-pair"]=n)}}}this.sendStats[t]["begin-video-media-source"]||(this.sendStats[t]["begin-video-media-source"]=i["video-media-source"]),n!==this.candidateLog[t]&&($.directSendMonitorLog("WMSC_CANDIDATE: ".concat(t,"|").concat(n)),this.candidateLog[t]=n),o!==this.candidatePairLog[t]&&(this.candidatePairChangeCount[t]++,this.candidatePairLog[t]=o);const{currentRoundTripTime:l}=i["candidate-pair"]||{},u=i["video-outbound-rtp"]||{},m=i["video-remote-inbound-rtp"]||{},p=i["video-media-source"]||{};this.sendStats[t].statisticData||(this.sendStats[t].statisticData={});const g=this.sendStats[t]["video-outbound-rtp"]||{},S=this.sendStats[t]["video-media-source"]||{},_=this.sendStats[t].statisticData,{minCaptureFps:v,maxCaptureFps:f,maxRtt:M,minCamCaptureFps:y,maxCamCaptureFps:C,totalCaptureFps:I=0,totalCaptureCount:T=0,totalCamCaptureFps:R=0,totalCamCaptureCount:b=0}=_,E=Ye.getSender(),{frames:A}=p,{frames:w}=S;if(E&&E.track){const{frameRate:e=0,width:t,height:i}=E.track.getSettings(),{framesPerSecond:s=e,height:a=t,width:n=i}=p;r=!0,_.minCaptureFps=Math.round(Math.min(s,v||Number.MAX_SAFE_INTEGER)),_.maxCaptureFps=Math.round(Math.max(s,f||0)),_.totalCaptureFps=I+s,_.totalCaptureCount=T+1,_.avgCaptureFps=Math.round(_.totalCaptureFps/_.totalCaptureCount),_.captureWidth=null!=a?a:"",_.captureHeight=null!=n?n:""}if(this.camStream){var L;const{frameRate:e=0}=null===(L=this.camStream.getVideoTracks()[0])||void 0===L?void 0:L.getSettings();_.minCamCaptureFps=Math.round(Math.min(e,y||Number.MAX_SAFE_INTEGER)),_.maxCamCaptureFps=Math.round(Math.max(e,C||0)),_.totalCamCaptureFps=R+e,_.totalCamCaptureCount=b+1,_.avgCamCaptureFps=Math.round(_.totalCamCaptureFps/_.totalCamCaptureCount)}l&&(_.maxRtt=Math.max(l,M||0));for(const e in u){const{framesPerSecond:s="",bytesSent:a,framesSent:n,timestamp:o,framesEncoded:l,totalEncodeTime:h,packetsSent:p,totalPacketSendDelay:S,frameHeight:v,frameWidth:f,retransmittedPacketsSent:M,active:y,qualityLimitationDurations:C,qpSum:I}=u[e];let T=0;!1!==y&&(this._captureRawSendData(u[e]),this.layerStatus.numOfActive++);const{jitter:R}=m[e]||{};_[e]||(_[e]={});const b=_[e],{minEncodeFrameRate:E,maxEncodeFrameRate:L,minSendFrameRate:O,maxSendFrameRate:N,minSendBitRate:B,maxSendBitRate:V,maxEncodeTime:k,minEncodeTime:U,maxPacketSentDelay:x,minPacketSentDelay:W,maxJitter:z,maxLossRate:j,sendWidth:G,sendHeight:H,maxQP:Q,minQP:q}=b;if(b.minEncodeFrameRate=Math.min(s,E||Number.MAX_SAFE_INTEGER),b.maxEncodeFrameRate=Math.max(s,L||0),b.maxJitter=Math.max(R,z||0),g&&g[e]){var D;if(!1===y||!r)continue;b.count++;const{timestamp:i,bytesSent:s,framesSent:c,framesEncoded:u,totalEncodeTime:m,packetsSent:R,totalPacketSendDelay:E,retransmittedPacketsSent:L,qpSum:F}=g[e],{framesSent:z,bytesSent:Y,timestamp:J,framesEncoded:K,totalEncodeTime:X,packetsSent:Z,totalPacketSendDelay:ee,retransmittedPacketsSent:te,qualityLimitationDurations:ie,qpSum:se}=this.sendStats[t]["begin-video-outbound-rtp"][e];let ae,ne,oe="",re="";T=n-c;const ce=Math.round(T/((o-i)/1e3)),de=(8*(a-s)/((o-i)/1e3)).toFixed(2),le=Math.round((n-z)/((o-J)/1e3)),he=(8*(a-Y)/((o-J)/1e3)).toFixed(2),ue=(h-m)/(l-u)||0,me=(h-X)/(l-K)||0,pe=Math.round((l-K)/((o-J)/1e3)),{current:ge,begin:Se,prev:_e}=this.ingressReport;if(ge&&_e&&Se){const{lostPkts:e,recvPkts:t}=ge,{lostPkts:i,recvPkts:s}=_e,{lostPkts:a,recvPkts:n}=Se,o=e-i,r=e-a;re=o/(t-s+o)||0,oe=r/(t-n+r)||0}else oe=(M-te)/(p-Z)||0,re=(M-L)/(p-R)||0;if(void 0!==S&&(ae=(1e3*(S-E)/(p-R)).toFixed(3),ne=(1e3*(S-ee)/(p-Z)).toFixed(3)),y&&l===u&&A&&A>w&&(b.encodePauseCount++,b.encodePauseCount>10&&this.layerStatus.numOfStopSending++,b.encodePauseCount>10&&this.shouldReportEncodeFailedError)){var P;const{frames:i=""}=this.sendStats[t]["begin-video-media-source"];let s="".concat(e,",").concat(l,",").concat(K,",").concat(A,",").concat(i,",");if(C&&ie){const{bandwidth:e,cpu:t,other:i}=C,{bandwidth:a,cpu:n,other:o}=ie;s+="".concat(e,",").concat(a,",").concat(t,",").concat(n,",").concat(i,",").concat(o)}const a=null===(P=this.camStream)||void 0===P?void 0:P.getVideoTracks()[0];s+=",videoTrack:".concat(!!a,"|").concat(a&&(null==a?void 0:a.muted)),$.globalTrace({logLevel:"error",log:"WMSC_ENCODE_STOP: ".concat(s)}),Tt("WMSC_ENCODE_STOP: ".concat(s)),this.shouldReportEncodeFailedError=!1}let ve="",fe="";void 0!==I&&l&&(void 0!==F&&l>u&&(fe=Math.round((I-F)/(l-u))),void 0!==se&&l>K&&(ve=Math.round((I-se)/(l-K)))),_[e]=Ct(Ct({},b),{},{maxEncodeTime:Math.max(k,ue),minEncodeTime:Math.min(ue,U),avgEncodeTime:me,minSendFrameRate:Math.min(ce,O),maxSendFrameRate:Math.max(N,ce),avgSendFrameRate:le,minSendBitRate:Math.min(de,B),maxSendBitRate:Math.max(V,de),avgSendBitRate:he,minPacketSentDelay:Math.min(ae,W),maxPacketSentDelay:Math.max(ae,x),avgPacketSentDelay:null!==(D=ne)&&void 0!==D?D:"",avgEncodeFrameRate:pe,avgLossRate:isNaN(oe)?"":oe,maxLossRate:isNaN(re)?j:Math.max(re,j),sendWidth:f||G,sendHeight:v||H,maxQP:Math.max(Q,fe),minQP:Math.min(q,fe),avgQP:ve}),d=Math.max(d,_[e].avgLossRate)}else _[e]=Ct(Ct({},b),{},{maxEncodeTime:0,minEncodeTime:Number.MAX_SAFE_INTEGER,avgEncodeTime:0,minSendFrameRate:Number.MAX_SAFE_INTEGER,maxSendFrameRate:0,avgSendFrameRate:0,minSendBitRate:Number.MAX_SAFE_INTEGER,maxSendBitRate:0,avgSendBitRate:0,minPacketSentDelay:Number.MAX_SAFE_INTEGER,maxPacketSentDelay:0,avgPacketSentDelay:0,maxLossRate:"",avgLossRate:"",encodePauseCount:0,maxQP:0,minQP:Number.MAX_SAFE_INTEGER,avgQP:0,count:0});if(v&&f){const t=v*f;if(t>c&&T>0){const{currentRoundTripTime:a=0}=i["candidate-pair"]||{};c=t,this.uiQosData.sending={width:f,height:v,fps:s,rtt:Math.round(1e3*a),max_loss:1e3*_[e].maxLossRate,avg_loss:1e3*_[e].avgLossRate,jitter:Math.round(1e3*(R||0)),bandwidth:_[e].avgSendBitRate}}}const{numOfActive:Y,numOfStopSending:J}=this.layerStatus;Y&&Y===J&&this._telemetry({type:F.ERROR_MESSAGE,data:{type:"WEBRTC_VIDEO_HEALTH_CHECK_FAILED"}})}if(r)if(this.networkReportDelay>5){const{currentRoundTripTime:e=0,availableOutgoingBitrate:t}=i["candidate-pair"]||{},s=this._getNetworkState(d,e,t);this._sendNetworkState(Ct({isUplink:!0},s))}else this.networkReportDelay++;this.sendStats[t]=Ct(Ct({},this.sendStats[t]),i)}_captureRecvStats(e){if(!this.mIdMgr)return;const t=this.mIdMgr.mIdResource;let i=0;const s={},a={};let n="",o="",r=0;this.recvStats.statisticData||(this.recvStats.statisticData={}),e.forEach((c=>{De.getRecvStatsMonitor().onStatsReport(c);const{kind:d,type:l}=c,h="".concat(d?d+"-":"").concat(l),u="begin-".concat(h);if("candidate-pair"===l){const{id:e}=c;s[e]=c,o+=this._getCandidatePairLog(c)}else if("remote-candidate"===l||"local-candidate"===l){const{id:e}=c;a[e]=c,n+=this._getCandidateLog(c)}else if("video"!==d||"inbound-rtp"!==l&&"remote-outbound-rtp"!==l)if("codec"===l){const{id:e,mimeType:t}=c;"video/H264"===t&&(this.recvStats[h]||(this.recvStats[h]={}),this.recvStats[h][e]=c)}else this.recvStats[h]=c;else{let{mid:s,ssrc:a}=c;s||(s=this.mIdMgr.ssrcMidMap.get(a)),this.recvStats[u]||(this.recvStats[u]={}),this.recvStats[h]||(this.recvStats[h]={});const{userId:n}=t.get(s)||{};let o=-1;if(n&&(o=this.mIdMgr.getVideoSizeByUserId(n),-1===o&&n===this.activeSpeaker&&(o=this.mIdMgr.getVideoSizeByUserId(I))),s&&o>-1&&"inbound-rtp"===l){let t;this._captureRawRecvData(c);let a=0;const{framesPerSecond:o="",timestamp:d="",framesDecoded:l="",frameWidth:h="",frameHeight:u="",bytesReceived:S="",framesReceived:_="",totalDecodeTime:v="",packetsReceived:f="",packetsLost:M="",jitter:y="",lastPacketReceivedTimestamp:C=0,fecPacketsReceived:I=0,retransmittedPacketsReceived:T=0,jitterBufferEmittedCount:R,decoderImplementation:b,estimatedPlayoutTimestamp:E,jitterBufferDelay:A}=c,w=this.mIdMgr.getAudioMidByUserId(n),L=Mt.getEstimatePlayoutTimestampFromStatsByMid(e,w);if(this.recvStats.statisticData[n]){this.recvStats.statisticData[n].count++;const{maxFps:e,minFps:i,maxDecodeTime:c,minDecodeTime:h,maxLossRate:u,maxBt:m,minBt:p,maxJitter:g,minLastRecvGap:_,maxLastRecvGap:w,avgLastRecvGap:D,count:P,maxAVSyncDelay:O,minAVSyncDelay:N,avSyncDelayArray:B,minJitterBufferDelay:V,maxJitterBufferDelay:k}=this.recvStats.statisticData[n],U=this.recvStats["video-inbound-rtp"][n],x=this.recvStats["begin-video-inbound-rtp"][n],{timestamp:W,framesDecoded:F,totalDecodeTime:z,packetsLost:j,packetsReceived:G,bytesReceived:H,fecPacketsReceived:Q=0,retransmittedPacketsReceived:q=0,jitterBufferEmittedCount:Y=0,pliCount:J=0,jitterBufferDelay:K=0}=x||{},{packetsLost:X,packetsReceived:Z,totalDecodeTime:ee,framesDecoded:te,bytesReceived:ie,timestamp:se,lastPacketReceivedTimestamp:ae,fecPacketsReceived:ne=0,retransmittedPacketsReceived:oe=0,jitterBufferEmittedCount:re=0,jitterBufferDelay:ce=0}=U||{};a=l-te,0===a&&R>re&&this.recvStats.statisticData[n].decodePausedCount++,"NullVideoDecoder"===b&&this.shouldReportNullDecoderError&&($.globalTrace({logLevel:"error",log:"WMSC_NULLDECODER: ".concat(s)}),Tt("WMSC_NULLDECODER,".concat(s)),this.shouldReportNullDecoderError=!1);const de=f-G-(I-Q)-(T-q),le=(M-X)/(f-Z-(I-ne)-(T-oe)+(M-X))||0,he=(v-ee)/(l-te)||0;t=8*(S-ie)/((d-se)/1e3);const ue=8*(S-H)/((d-W)/1e3);if(ae){const e=parseInt(C-ae,10);this.recvStats.statisticData[n].minLastRecvGap=Math.min(_,e),this.recvStats.statisticData[n].maxLastRecvGap=Math.max(w,e),this.recvStats.statisticData[n].avgLastRecvGap=parseInt((D*(P-1)+e)/P,10),0===e&&this.recvStats.statisticData[n].noDataCount++}else this.recvStats.statisticData[n].minLastRecvGap=0,this.recvStats.statisticData[n].noDataCount++;if(this.recvStats.statisticData[n].maxFps=Math.max(e,o),this.recvStats.statisticData[n].minFps=Math.min(i,o),this.recvStats.statisticData[n].avgFps=Math.round((l-F)/((d-W)/1e3)),this.recvStats.statisticData[n].maxDecodeTime=Math.max(c,he),this.recvStats.statisticData[n].minDecodeTime=Math.min(he,h),this.recvStats.statisticData[n].avgDecodeTime=(v-z)/(l-F)||0,this.recvStats.statisticData[n].prevTotalDecodeTime=v,this.recvStats.statisticData[n].prevFramesDecoded=l,this.recvStats.statisticData[n].maxLossRate=Math.max(u,le),this.recvStats.statisticData[n].avgLossRate=(M-j)/(de+(M-j))||0,this.recvStats.statisticData[n].maxJitter=Math.max(g,y),this.recvStats.statisticData[n].maxBt=Math.max(t,m),this.recvStats.statisticData[n].minBt=Math.min(t,p),this.recvStats.statisticData[n].avgBt=ue,r=Math.max(this.recvStats.statisticData[n].avgLossRate,r),E&&L){const e=L-E;B.push(e),this.recvStats.statisticData[n].maxAVSyncDelay=Math.max(O,e),this.recvStats.statisticData[n].minAVSyncDelay=Math.min(N,e),this.recvStats.statisticData[n].avgAVSyncDelay=Math.round(B.reduce(((e,t)=>e+Math.abs(t)),0)/B.length),this.recvStats.statisticData[n].audioEstimatedPlayoutTimestamp=L}if(R>0&&void 0!==A){let e=(A-ce)/(R-re),t=(A-K)/(R-Y);e=Math.round(1e3*e),t=Math.round(1e3*t),this.recvStats.statisticData[n].maxJitterBufferDelay=Math.max(k,e),this.recvStats.statisticData[n].minJitterBufferDelay=Math.min(V,e),this.recvStats.statisticData[n].avgJitterBufferDelay=t}}else t=8*S/_*o||"",this.recvStats.statisticData[n]={maxFps:o,minFps:o,avgFps:o,maxDecodeTime:0,minDecodeTime:Number.MAX_SAFE_INTEGER,avgDecodeTime:0,maxLossRate:0,avgLossRate:0,maxBt:t,minBt:t,avgBt:t,maxJitter:y,minLastRecvGap:Number.MAX_SAFE_INTEGER,maxLastRecvGap:0,avgLastRecvGap:0,noDataCount:0,count:0,decodePausedCount:0,maxAVSyncDelay:0,minAVSyncDelay:Number.MAX_SAFE_INTEGER,avgAVSyncDelay:0,avSyncDelayArray:[],maxJitterBufferDelay:0,minJitterBufferDelay:Number.MAX_SAFE_INTEGER,avgJitterBufferDelay:0};if(h&&u){const e=h*u;if(e>i&&a>0){var m,p,g;const t=null===(m=this.mIdMgr)||void 0===m?void 0:m.getVideoTagsByUserId(n);this.uiQosData.receiving={avg_loss:Math.max(1e3*this.recvStats.statisticData[n].avgLossRate,0),max_loss:Math.max(1e3*this.recvStats.statisticData[n].maxLossRate,0),fps:o||0,height:(null===(p=t[0])||void 0===p?void 0:p.videoHeight)||u,width:(null===(g=t[0])||void 0===g?void 0:g.videoWidth)||h,jitter:Math.round(1e3*(y||0)),bandwidth:this.recvStats.statisticData[n].avgBt},i=e}}this.bToPrint&&this._renderStatsData(s,h,u,o,t)}if(o>-1&&(this.recvStats[u][n]||(this.recvStats[u][n]=c),this.recvStats[h][n]=c,"inbound-rtp"===l)){const e=this.detectDecodeFailed(n);if(e){const{codecId:t}=c,i=this.getRecvH264Profile(t);i||$.globalTrace({logLevel:"error",log:"WMSC_DECODE_FAILED_NP"});const a=Object.keys(this.subInfo).length,n="".concat(this.userId,",").concat(s,",").concat(a,",").concat(e,",").concat(i);return $.globalTrace({logLevel:"error",log:"WMSC_DECODE_FAILED: ".concat(n)}),$.directSendMonitorLog("WMSC_DECODE_FAILED,".concat(n)),void(i&&this.onDecodeError&&this.onDecodeError(i))}}}})),this.recvStats.candidatePairs=s,this.recvStats.candidates=a;const c=this.recvStats.transport;if(c){const{selectedCandidatePairId:e,dtlsState:t}=c;if("connected"===t){const t=s[e];if(t){const{localCandidateId:e,remoteCandidateId:i,currentRoundTripTime:s=0}=t;if(this.recvStats["remote-candidate"]=a[i],this.recvStats["local-candidate"]=a[e],this.recvStats["candidate-pair"]=t,this.recvStats["begin-candidate-pair"]){const{maxRtt:e}=this.recvStats.statisticData;this.recvStats.statisticData.maxRtt=Math.max(e,s)}else this.recvStats["begin-candidate-pair"]=t,this.recvStats.statisticData.maxRtt=s}}}n!==this.candidateLog[0]&&($.directSendMonitorLog("WMSC_CANDIDATE 0: ".concat(n)),this.candidateLog[0]=n),o!==this.candidatePairLog[0]&&(this.candidatePairChangeCount[0]++,this.candidatePairLog[0]=o);const{currentRoundTripTime:d}=this.recvStats["candidate-pair"]||{},l=this._getNetworkState(r,d);this._sendNetworkState(Ct({isUplink:!1},l))}_getVideoSenderLog(){var e;let t="",i="",s={};if(!Ye.getPc())return;const a=Ye.getSender();a&&null!==(e=a.track)&&void 0!==e&&e.getStats&&(s=a.track.getStats());const{fps:n="",receivingFps:o="",generatedFrames:r="",receivedFrames:c=""}=s;for(const e in this.sendStats){const s=this.sendStats[e];if(!s["video-media-source"])continue;const{frames:a=""}=s["video-media-source"];let l=0,h=0;for(const e in s["video-outbound-rtp"]){var d;const u="{[SEND".concat(this.ssrcLayerMap[e],"]}"),m="{[ENCO".concat(this.ssrcLayerMap[e],"]}"),{minEncodeFrameRate:p,maxEncodeFrameRate:g,avgEncodeFrameRate:S,minSendFrameRate:_,maxSendFrameRate:v,avgSendFrameRate:f,minSendBitRate:M,maxSendBitRate:y,avgSendBitRate:C,maxEncodeTime:I,minEncodeTime:T,avgEncodeTime:R,maxPacketSentDelay:b,minPacketSentDelay:E,avgPacketSentDelay:A,sendWidth:w="",sendHeight:L="",encodePauseCount:D,count:P,maxQP:O,minQP:N,avgQP:B}=s.statisticData[e];if(0===P)continue;let{minCaptureFps:V,maxCaptureFps:k,avgCaptureFps:U,captureHeight:x,captureWidth:W,minCamCaptureFps:F,maxCamCaptureFps:z,avgCamCaptureFps:j}=s.statisticData;this.camStream||(F=V,z=k,j=U);const{keyFramesEncoded:G="",qualityLimitationReason:H="",pliCount:Q="",nackCount:q="",firCount:Y="",framesSent:J="",retransmittedPacketsSent:K="",powerEfficientEncoder:X,hugeFramesSent:Z="",packetsSent:$="",bytesSent:ee="",qualityLimitationDurations:te={},encoderImplementation:ie="",targetBitrate:se="",codecId:ae,active:ne,qpSum:oe="",framesEncoded:re=""}=s["video-outbound-rtp"][e],{framesSent:ce}=s["begin-video-outbound-rtp"][e],{bandwidth:de="",cpu:le="",none:he="",other:ue=""}=te,{mimeType:me="h264",sdpFmtpLine:pe=""}=(null===(d=s.codec)||void 0===d?void 0:d[ae])||{};let ge="";const Se=pe.match(/profile-level-id=([A-Za-z0-9]+);/);Se&&(ge=Se[1]);let _e=-1!==me.toLowerCase().indexOf("h264")?0:2;X&&(_e|=1);const ve=w*L;J-ce>0&&ve>l&&(l=ve,h=this.ssrcLayerMap[e]),t+="".concat(u,",").concat(this.maxSubscribedSize,",").concat(W,",").concat(x,",").concat(k,",").concat(V,",").concat(U,",,,,,,,").concat(g,",").concat(p,",").concat(S,",").concat(y,",").concat(M,",").concat(C,",").concat(v,",").concat(_,",").concat(f,",").concat(w,",").concat(L,",").concat(J,",,,,").concat(z,",").concat(F,",").concat(j,",").concat(isNaN(b)?"":b,",").concat(isNaN(E)?"":E,",").concat(isNaN(A)?"":A,",").concat($,",").concat(ee,",").concat(G,",").concat(Z,",").concat(q,",").concat(Y,",").concat(Q,",").concat(K,",").concat(H,",").concat(de,",").concat(le,",").concat(ue,",").concat(he,",").concat(se,",").concat(a,",").concat(D,",").concat(void 0===ne?"":ne,",").concat(P,",").concat(n,",").concat(o,",").concat(r,",").concat(c,",").concat(this.ssrcLayerMap[e],",").concat(oe,",").concat(B,",").concat(O,",").concat(N,",").concat(re,",").concat(e,","),i+="".concat(m,",").concat((1e3*I).toFixed(2),",").concat((1e3*T).toFixed(2),",").concat((1e3*R).toFixed(2),",,").concat(_e,",").concat(ie,",").concat(ge,",")}t=t.replace("{[SEND".concat(h,"]}"),"{[SEND]}"),i=i.replace("{[ENCO".concat(h,"]}"),"{[ENCO]}")}return"".concat(t).concat(i)}_getVideoReceiveLog(){var e;const t=new Array(8).fill(0),i=new Array(8).fill(0);let s,a=-1;const n={};for(const e in this.recvStats["video-inbound-rtp"]){var o,r,c;const{maxFps:t,minFps:d,avgFps:l,maxBt:h,minBt:u,avgBt:m,minLastRecvGap:p,maxLastRecvGap:g,avgLastRecvGap:S,noDataCount:_,count:v,decodePausedCount:f,maxAVSyncDelay:M,minAVSyncDelay:y,avgAVSyncDelay:C,audioEstimatedPlayoutTimestamp:T="",maxJitterBufferDelay:R,minJitterBufferDelay:b,avgJitterBufferDelay:E}=(null===(o=this.recvStats.statisticData)||void 0===o?void 0:o[e])||{},A=this.recvStats["video-inbound-rtp"][e]||{},w=this.recvStats["begin-video-inbound-rtp"][e]||{},{framesReceived:L="",framesDropped:D="",framesDecoded:P="",totalProcessingDelay:O=""}=w,{frameHeight:N=0,frameWidth:B=0,freezeCount:V="",framesReceived:k="",framesDropped:U="",keyFramesDecoded:x="",pauseCount:W="",nackCount:F="",firCount:z="",pliCount:j="",totalProcessingDelay:G="",fecPacketsReceived:H="",retransmittedPacketsReceived:Q="",framesDecoded:q="",bytesReceived:Y="",packetsReceived:J="",packetsLost:K="",jitterBufferEmittedCount:X="",ssrc:Z="",estimatedPlayoutTimestamp:$="",jitterBufferTargetDelay:ee}=A,te=k-L,ie=U-D,se=(ie/te||0).toFixed(2),ae=((G-O)/(q-P)*1e3||0).toFixed(2),ne=q-P;if(void 0!==this.subInfo[e]||void 0!==this.subInfo[I]&&parseInt(e,10)===this.activeSpeaker){const t=B*N;t>a&&(a=t,s=parseInt(e,10)),t>0&&ne>0&&i[this.getResolutionId(t)]++}const oe=this.mIdMgr.getVideoTagsByUserId(parseInt(e,10));let re="",ce="",de="";if(null!=oe&&oe.length){const e=oe[0];re=e.currentTime>0&&!e.paused&&!e.ended&&e.readyState>2?1:0;const t=e.getVideoPlaybackQuality();de=t.droppedVideoFrames,ce=t.totalVideoFrames-de}n[e]="".concat(t,",").concat(d,",").concat(l,",").concat(B,",").concat(N,",").concat(e,",").concat(v,",").concat(_,",,,,,,,,").concat($,",").concat(T,",,,,").concat(te,",").concat(ie,",").concat(se,",").concat(null!==(r=this.subInfo[e])&&void 0!==r?r:"",",,,,").concat(ne,",").concat(re,",").concat(ce,",").concat(de,",").concat((h||0).toFixed(2),",").concat((u||0).toFixed(2),",").concat((m||0).toFixed(2),",").concat(J,",").concat(K,",").concat(Y,",").concat(x,",").concat(W,",").concat(V,",").concat(F,",").concat(z,",").concat(j,",").concat(H,",").concat(Q,",").concat(ae,",").concat(Math.round(null!==(c=1e3*ee)&&void 0!==c?c:""),",").concat(X,",").concat(g,",").concat(p,",").concat(S,",").concat(f,",").concat(M,",").concat(y===Number.MAX_SAFE_INTEGER?"":y,",").concat(C,",").concat(R,",").concat(b,",").concat(E,",").concat(Z,",").concat(this.mIdMgr.ssrcMidMap.get(Z))}this.activeSpeaker&&null!==(e=this.recvStats.statisticData)&&void 0!==e&&e[this.activeSpeaker]&&void 0!==this.subInfo[I]?this.recordUserId=this.activeSpeaker:this.recordUserId=s;for(const e in this.subInfo)t[this.subInfo[e]]++;const d="{[RECV]},".concat(t.join(","),",").concat(i.join(","),",");if(this.recvStatisticData[(new Date).toUTCString()]=n,this.reportCount%4==0)try{const e=JSON.stringify(this.recvStatisticData);Q(e,T.GZIP_BASE64).then((e=>{$.globalTrace({logLevel:"log",log:"WCL_WB_VIDEO,".concat(e)}),this.recvStatisticData={}})).catch((t=>{$.globalTrace({logLevel:"error",log:"WMSC compress video log failed",errorEvent:t}),$.globalTrace({logLevel:"log",log:"WCL_WB_VIDEO,".concat(e)}),this.recvStatisticData={}}))}catch(e){$.globalTrace({logLevel:"error",log:"WMSC_Video_Log_Parse_Failed",errorEvent:e}),this.recvStatisticData={}}return n[this.recordUserId]?"".concat(d).concat(n[this.recordUserId],","):d}_getVideoDecodeLog(){var e,t;if(null===(e=this.recvStats.statisticData)||void 0===e||!e[this.recordUserId])return"";const{maxDecodeTime:i,minDecodeTime:s,avgDecodeTime:a}=this.recvStats.statisticData[this.recordUserId],{powerEfficientDecoder:n,codecId:o,decoderImplementation:r=""}=this.recvStats["video-inbound-rtp"][this.recordUserId],c=(null===(t=this.recvStats.codec)||void 0===t?void 0:t[o])||{},{mimeType:d="h264"}=c,l=(-1!==d.toLowerCase().indexOf("h264")?0:2)|(n?1:0);return"{[DECO]},".concat((1e3*i).toFixed(2),",").concat((1e3*s).toFixed(2),",").concat((1e3*a).toFixed(3),",,").concat(l,",").concat(r)}_getDownLinkLog(){var e,t;const{maxLossRate:i="",avgLossRate:s="",maxJitter:a=""}=(null===(e=this.recvStats.statisticData)||void 0===e?void 0:e[this.recordUserId])||{},n=(null===(t=this.recvStats["video-inbound-rtp"])||void 0===t?void 0:t[this.recordUserId])||{},{packetsLost:o="",jitter:r=""}=n,c=this.recvStats["remote-candidate"]||{},d=this.recvStats["candidate-pair"]||{},l=this.recvStats["begin-candidate-pair"]||{},{maxRtt:h}=this.recvStats.statisticData||{},{protocol:u}=c,{availableIncomingBitrate:m="",bytesReceived:p="",timestamp:g="",totalRoundTripTime:S="",responsesReceived:_="",packetsReceived:v=""}=d,{bytesReceived:f,timestamp:M}=l,y=(8*(p-f)/((g-M)/1e3)).toFixed(2),C=Math.round(S/_*1e3)||"";return"RWG_WB_DOWNLINK_NETWORK,".concat(this.userId,",3,").concat("udp"===u?0:1,",").concat(Math.round(g/1e3),",,").concat(m,",").concat(y,",").concat(Math.round(1e3*s),",").concat(Math.round(1e3*i),",,,,").concat(C,",").concat(1e3*h,",").concat(v,",").concat(o,",,,,,,,,,").concat(Math.round(1e3*r),",").concat(Math.round(1e3*a))}_getUpLinkLog(){let e="";for(const t in this.sendStats){const i=this.sendStats[t]["candidate-pair"]||{},s=this.sendStats[t]["begin-candidate-pair"]||{},a=this.sendStats[t]["remote-candidate"]||{},n=this.sendStats[t]["video-remote-inbound-rtp"]||{},{timestamp:o,availableOutgoingBitrate:r="",bytesSent:c,totalRoundTripTime:d,responsesReceived:l,packetsSent:h=""}=i,{timestamp:u,bytesSent:m}=s,{protocol:p}=a,{statisticData:g={}}=this.sendStats[t],S=isNaN(g.maxRtt)?"":Math.round(1e3*g.maxRtt);let _="",v="",f="",M="",y="";for(const e in n){const{maxJitter:t,avgLossRate:i,maxLossRate:s}=g[e],{packetsLost:a,jitter:o}=n[e];if(t&&!f&&(f=Math.round(1e3*t)),!i&&0!==i||_||(_=Math.round(1e3*i)),!s&&0!==s||v||(v=Math.round(1e3*s)),!a&&0!==a||M||(M=a),o&&!y&&(y=Math.round(1e3*o)),_&&v&&f&&M&&y)break}const C=(8*(c-m)/((o-u)/1e3)).toFixed(2),I=Math.round(d/l*1e3)||"";e+=",3,".concat("udp"===p?0:1,",").concat(Math.round(o/1e3),",,").concat(r,",").concat(C,",").concat(_,",").concat(v,",,,,").concat(I,",").concat(S,",").concat(h,",").concat(M,",,,,,,,,,").concat(y,",").concat(f)}return e?"RWG_WB_UPLINK_NETWORK,".concat(this.userId).concat(e):""}_getStats(){if(this.isWebRTCVideoEnabled){var e;let t=0;null!==(e=x.videoSettings)&&void 0!==e&&e.hdVideoEnabled&&(t|=Et.HD_VIDEO),this.isDualCall&&(t|=Et.DUAL_CALL);let i,s,a="WCL_WB_MCM_VIDEO,".concat(this.userId,",,").concat(document.hidden?0:1,",").concat(t,",");const n=this._getVideoSenderLog(),o=this._getVideoReceiveLog(),r=this._getVideoDecodeLog();this.reportCount%2==0&&(i=this._getDownLinkLog(),s=this._getUpLinkLog()),a+=n+o+r+"{[END]}",a&&$.directSendMonitorLog(a),i&&$.directSendMonitorLog(i),s&&$.directSendMonitorLog(s),this.bToPrint&&(a&&It.log("_getStats, video log: ".concat(a)),i&&It.log("_getStats, downlink log: ".concat(i)),s&&It.log("_getStats, uplink log: ".concat(s)))}this.candidatePairMonitorLog=this.candidatePairMonitorLog.map(((e,t)=>{const i=this.candidatePairLog[t];return e!==i&&$.directSendMonitorLog("WMSC_CANDIDATE-PAIR: ".concat(t,"|").concat(i,"|").concat(this.candidatePairChangeCount[t])),this.candidatePairChangeCount[t]=0,i}))}_renderStatsData(e){}sendSdpLog(e,t){try{const a=ce.parseSdp(t),{media:n=[]}=a;let o,r;var i,s;n.forEach((t=>{const{ssrcGroups:i,mid:s,type:a,direction:n,ssrcs:c,codecs:d=[]}=t;if("sendonly"===n&&"ANSWER"===e&&"video"===a&&!this.recvCodecProfile){const{codecParams:e}=d[0]||{};e&&(this.recvCodecProfile=e.get("profile-level-id"))}i.forEach((e=>{let{semantics:t,ssrcs:i}=e;"SIM"===t&&i.forEach(((e,t)=>{this.ssrcLayerMap[e]=t}))})),c.forEach((e=>{let{ssrc:t}=e;this.mIdMgr.ssrcMidMap.set(t,s)})),"video"===a&&("sendonly"!==n||o||(o=t),"recvonly"!==n||r||(r=t))})),o&&$.directSendMonitorLog(this.generateSdpLog(e,o,null===(i=a.session)||void 0===i?void 0:i.groups)),r&&$.directSendMonitorLog(this.generateSdpLog(e,r,null===(s=a.session)||void 0===s?void 0:s.groups)),Q(t,T.GZIP_BASE64).then((t=>{$.globalTrace({logLevel:"log",log:"WCL_WB_SDP-".concat(e,"-").concat(t)})}))}catch(i){$.globalTrace({logLevel:"error",log:"WCL_WB_SDP-".concat(e,"-").concat(t),errorEvent:i}),Tt("WMSC_SDPLE: ".concat(e))}}_getCandidatePairLog(e){const{localCandidateId:t,remoteCandidateId:i,nominated:s,state:a,priority:n=""}=e;return"".concat(n,",").concat(t,",").concat(i,",").concat(this.iceCandidatePairState[a],",").concat(s?1:0,",")}_getCandidateLog(e){const{id:t,candidateType:i,port:s,priority:a,protocol:n,type:o,networkType:r=""}=e;return"".concat(t,",").concat(a,",").concat(n,",").concat(i,",").concat(s,",").concat(r,",").concat("remote-candidate"===o?1:0,",")}onReceiverReport(e){const{begin:t,current:i}=this.ingressReport;this.ingressReport.prev=i,this.ingressReport.current=e,t||(this.ingressReport.begin=i)}_captureRawRecvData(e){if(!e)return;const{timestamp:t,framesDecoded:i="",totalDecodeTime:s="",jitterBufferEmittedCount:a="",framesReceived:n="",ssrc:o}=e;if(!o)return;const r=this.mIdMgr.ssrcMidMap.get(o),c="mid-".concat(r,"-ssrc-").concat(o);if(this.recvRawStats[c]){const{startTime:e}=this.recvRawStats[c],o=this.recvRawStats[c].framesDecoded.length,r=Math.floor((t-e)/1e3)-o;if(o+r>P)this._generateRecvRawLog(c),this.recvRawStats[c]={startTime:t,framesDecoded:[i],totalDecodeTime:[Math.round(1e3*s)],jitterBufferEmittedCount:[a],framesReceived:[n]};else for(let e=0;e<r;e++){const t=e===r-1;this.recvRawStats[c].framesDecoded.push(t?i:""),this.recvRawStats[c].totalDecodeTime.push(t?Math.round(1e3*s):""),this.recvRawStats[c].jitterBufferEmittedCount.push(t?a:""),this.recvRawStats[c].framesReceived.push(t?n:"")}}else this.recvRawStats[c]={startTime:t,framesDecoded:[i],totalDecodeTime:[Math.round(1e3*s)],jitterBufferEmittedCount:[a],framesReceived:[n]}}_captureRawSendData(e){if(!e)return;const{type:t}=e;if("outbound-rtp"===t){const{timestamp:t,framesSent:i,framesEncoded:s,totalEncodeTime:a,ssrc:n}=e,o="sim-".concat(this.ssrcLayerMap[n],"-ssrc-").concat(n);if(this.sendRawStats[o]){const{startTime:e}=this.sendRawStats[o],n=this.sendRawStats[o].framesSent.length,r=Math.floor((t-e)/1e3)-n;if(n+r>P)this._generateSendRawLog(o),this.sendRawStats[o]={startTime:t,framesSent:[i],framesEncoded:[s],totalEncodeTime:[Math.round(1e3*a)]};else for(let e=0;e<r;e++){const t=e===r-1;this.sendRawStats[o].framesSent.push(t?i:""),this.sendRawStats[o].framesEncoded.push(t?s:""),this.sendRawStats[o].totalEncodeTime.push(t?Math.round(1e3*a):"")}}else this.sendRawStats[o]={startTime:t,framesSent:[i],framesEncoded:[s],totalEncodeTime:[Math.round(1e3*a)]}}else if("media-source"===t){const{frames:t,timestamp:i}=e;if(!t&&0!==t)return;if(this.sendRawStats.capturedFrames){const{startTime:e}=this.sendRawStats.capturedFrames,s=this.sendRawStats.capturedFrames.frames.length,a=Math.floor((i-e)/1e3)-s;if(s+a>P)this._generateSendRawLog("capturedFrames"),this.sendRawStats.capturedFrames={startTime:i,frames:[t]};else for(let e=0;e<a;e++){const i=e===a-1;this.sendRawStats.capturedFrames.frames.push(i?t:"")}}else this.sendRawStats.capturedFrames={startTime:i,frames:[t]}}}reportRawStats(){for(const e in this.sendRawStats)this._generateSendRawLog(e,!1);for(const e in this.recvRawStats)this._generateRecvRawLog(e,!1);this._uploadRawStats()}_generateRecvRawLog(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const{startTime:i,framesDecoded:s,framesReceived:a,jitterBufferEmittedCount:n,totalDecodeTime:o}=this.recvRawStats[e],r="".concat(this.userId,",0,").concat(e,",").concat(Math.round(i/1e3),",framesDecoded=").concat(JSON.stringify(s),",framesReceived=").concat(JSON.stringify(a),",jitterBufferEmittedCount=").concat(JSON.stringify(n),",totalDecodeTime=").concat(JSON.stringify(o));this._sendRawLog(r,t),delete this.recvRawStats[e]}_generateSendRawLog(e){let t,i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if("capturedFrames"===e){const{frames:i,startTime:s}=this.sendRawStats[e];t="".concat(this.userId,",1,").concat(e,",").concat(Math.round(s/1e3),",capturedFrames=").concat(JSON.stringify(i))}else{const{startTime:i,framesEncoded:s,framesSent:a,totalEncodeTime:n}=this.sendRawStats[e];t="".concat(this.userId,",1,").concat(e,",").concat(Math.round(i/1e3),",framesEncoded=").concat(JSON.stringify(s),",framesSent=").concat(JSON.stringify(a),",totalEncodeTime=").concat(JSON.stringify(n))}this._sendRawLog(t,i),delete this.sendRawStats[e]}_sendRawLog(e,t){this.rawLog.push(e),t&&this.rawLog.length>O&&this._uploadRawStats()}_uploadRawStats(){if(this.rawLog.length>0){const e=this.rawLog.join("|");this.rawLog=[],Q(e,T.GZIP_BASE64).then((e=>{$.globalTrace({logLevel:"directReport",log:e,tags:["WCL_WB_RAW_STATS"]})})).catch((()=>{$.globalTrace({logLevel:"directReport",log:rawLog,tags:["WCL_WB_RAW_STATS"]})}))}}detectDecodeFailed(e){const{framesDecoded:t,jitterBufferEmittedCount:i="",pliCount:s,packetsLost:a,framesReceived:n=""}=this.recvStats["begin-video-inbound-rtp"][e],{framesDecoded:o,jitterBufferEmittedCount:r="",pliCount:c,packetsLost:d,decoderImplementation:l,framesReceived:h=""}=this.recvStats["video-inbound-rtp"][e],{decodePausedCount:u}=this.recvStats.statisticData[e],m="".concat(o,",").concat(t,",").concat(r,",").concat(i,",").concat(d,",").concat(a,",").concat(c,",").concat(s,",").concat(l,",").concat(u,",").concat(h,",").concat(n);return!(o>t)&&("NullVideoDecoder"===l?m:r-i<=5?!r&&h-n>150&&m:(0===o&&c>s&&d===a||u>10)&&m)}getRecvH264Profile(e){if(this.recvStats.codec){var t;const i=null===(t=this.recvStats.codec)||void 0===t?void 0:t[e];if(i){const{sdpFmtpLine:e=""}=i,t=e.match(/profile-level-id=([A-Za-z0-9]+);/);if(t)return t[1]}}return this.recvCodecProfile}onDualCallState(e){let{isDualCall:t}=e;this.isDualCall=t}generateSdpLog(e,t){var i;let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];const{direction:a="",codecs:n=[],extensionMap:o,bandwidth:r,candidates:c,ssrcGroups:d=[]}=t,l=new Array(4).fill(-1),h=[],u={};let m="WCL_WB_SDP_".concat(e,",").concat(this.userId,",").concat((null===(i=s[0])||void 0===i?void 0:i.ids.length)||0,",").concat(this.sdpDirection[a],",");if(o)for(const[e,t]of o){const{uri:i}=t,s=this.rtpHeaderExt[i];void 0!==s&&(l[s]=e)}m+=l.join(",")+",",n.forEach((e=>{const{codecName:t,codecParams:i,payloadType:s,associatedPayloadType:a=""}=e;"H264"===t&&i?"1"===i.get("packetization-mode")&&(h.push(s),h.push(i.get("profile-level-id")),h.push(i.get("max-mbps")||""),h.push(i.get("max-fs")||""),h.push(i.get("x-google-start-bitrate")||""),h.push(i.get("x-google-max-bitrate")||""),h.push(i.get("x-google-min-bitrate")||""),h.push(i.get("x-google-per-layer-pli")||"")):"rtx"===t&&(u[a]=s)}));for(let e=0,t=h.length;e<t;e+=8){const t=h[e];m+="".concat(t,",").concat(h[e+1],",").concat(h[e+2],",").concat(h[e+3],",").concat(h[e+4],",").concat(h[e+5],",").concat(h[e+6],",").concat(h[e+7],",").concat(u[t],",")}return d.forEach((e=>{let{semantics:t,ssrcs:i}=e;"FID"===t&&(m+="".concat(i.join(","),","))})),m+="".concat(r||"",","),c&&c.length>0&&c.forEach((e=>{let{transport:t,address:i,port:s,priority:a}=e;m+="".concat(a,",").concat("udp"===t?0:1,",").concat(i,",").concat(s,",")})),m}};var wt=i(7007);class Lt extends wt.EventEmitter{constructor(e,t){super(),this.codecs=[],this.type=e,this.rtpTransceiver=t}stop(){this.rtpTransceiver.direction="inactive",this.emit(je.f7.NegotiationNeeded)}get transceiver(){return this.rtpTransceiver}get sender(){return this.rtpTransceiver.sender}getCodecs(){return this.codecs}setCodecs(e){this._setCodecs(e),this.emit(je.f7.CodecsChange,e)}_setCodecs(e){this.codecs=e}publishTrack(e){return t=this,i=void 0,a=function*(){return this.sender.replaceTrack(e||null)},new((s=void 0)||(s=Promise))((function(e,n){function o(e){try{c(a.next(e))}catch(e){n(e)}}function r(e){try{c(a.throw(e))}catch(e){n(e)}}function c(t){var i;t.done?e(t.value):(i=t.value,i instanceof s?i:new s((function(e){e(i)}))).then(o,r)}c((a=a.apply(t,i||[])).next())}));var t,i,s,a}}class Dt extends wt.EventEmitter{constructor(e,t){super(),this.codecs=[],this.type=e,this.rtpTransceiver=t}stop(){this.rtpTransceiver.stop(),this.emit(je.f7.NegotiationNeeded)}get transceiver(){return this.rtpTransceiver}get receiver(){return this.rtpTransceiver.receiver}getCodecs(){return this.codecs}setCodecs(e){this._setCodecs(e),this.emit(je.f7.CodecsChange,e)}_setCodecs(e){this.codecs=e}}var Pt=function(e,t,i,s){return new(i||(i=Promise))((function(a,n){function o(e){try{c(s.next(e))}catch(e){n(e)}}function r(e){try{c(s.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((s=s.apply(e,t||[])).next())}))};class Ot extends wt.EventEmitter{constructor(e){super(),this.sendTransceivers=new Map,this.recvTransceivers=new Map,this.nextMid=0,this.mids=new Map,this.mediaSourceId2Mid=new Map,this.localId2Mid=new Map,this.pendingTransceivers=[],this.mainEgressStreamId=ce.generateUuid(),this.shareEgressStreamId=ce.generateUuid(),this.config=Object.assign(Object.assign({},e),{bundlePolicy:"max-bundle"}),this.pc=new RTCPeerConnection(this.config),this.setupEventListeners(),this.startPollingStats()}createSendTransceiver(e,t){const i=(0,je.xv)(e),s=this.pc.addTransceiver(i,Object.assign({direction:"sendonly"},t)),a=new Lt(e,s);return a.on(je.f7.CodecsChange,(e=>this.onCodecsChange(a.mid,e))),a.on(je.f7.NegotiationNeeded,(()=>this.onNegotiationNeeded())),this.pendingTransceivers.push(a),a}createRecvTransceiver(e){const t=(0,je.xv)(e),i=this.pc.addTransceiver(t,{direction:"recvonly"}),s=new Dt(e,i);return s.on(je.f7.CodecsChange,(e=>this.onCodecsChange(s.mid,e))),s.on(je.f7.NegotiationNeeded,(()=>this.onNegotiationNeeded())),this.pendingTransceivers.push(s),s}getSendTransceiverByMid(e){return this.sendTransceivers.get(e)}getRecvTransceiverByMid(e){return this.recvTransceivers.get(e)}createOffer(e){return Pt(this,void 0,void 0,(function*(){this.mids.clear();const t=yield this.pc.createOffer(e),i=ce.parseSdp(t.sdp);return i.media.forEach(((e,t)=>{const{mid:i}=e;this.mids.set(i,t)})),this.offer=i,this.offer}))}setOffer(e){return Pt(this,void 0,void 0,(function*(){if(!this.offer)throw new Error("Call createOffer() first.");let t;e?(this.offer=ce.parseSdp(e),t=e):t=ce.writeSdp(this.offer),yield this.pc.setLocalDescription({type:"offer",sdp:t}),this.pendingTransceivers=this.pendingTransceivers.filter((e=>{const{mid:t,direction:i}=e.transceiver;return!t||(e.mid=t,"sendonly"===i?this.sendTransceivers.set(t,e):"recvonly"===i&&this.recvTransceivers.set(t,e),!1)}))}))}setAnswer(e){return Pt(this,void 0,void 0,(function*(){if(!e&&!this.answer)throw new Error("Answer is required for the first time negotiation");let t;return e?(this.answer=ce.parseSdp(e),t=e):t=ce.writeSdp(this.answer),this.pc.setRemoteDescription({type:"answer",sdp:t})}))}close(){var e;clearTimeout(this.statsTimeoutId),null===(e=this.pc)||void 0===e||e.close(),this.removeAllListeners()}setupEventListeners(){this.pc.ontrack=e=>{this.emit(je.f7.Track,e);const t=this.recvTransceivers.get(e.transceiver.mid);t&&t.emit(je.f7.Track,e.track)},this.pc.onsignalingstatechange=()=>{this.emit(je.f7.SignalingStateChange,this.pc.signalingState)},this.pc.oniceconnectionstatechange=()=>{this.emit(je.f7.IceConnectionStateChange,this.pc.iceConnectionState)},this.pc.onconnectionstatechange=()=>{const e=this.pc.connectionState;this.emit(je.f7.ConnectionStateChange,e)},this.pc.onicegatheringstatechange=()=>{this.emit(je.f7.IceGatheringStateChange,this.pc.iceGatheringState)},this.pc.onicecandidateerror=e=>{this.emit(je.f7.IceCandidateError,e)}}addMidNum(){return this.nextMid++}startPollingStats(){return Pt(this,void 0,void 0,(function*(){try{const e=yield this.pc.getStats();this.dispatchStats(e)}catch(e){console.error("Dispatch stats error",e)}this.statsTimeoutId=window.setTimeout((()=>{this.startPollingStats()}),je.Mr)}))}dispatchStats(e){this.emit(je.f7.StatsReport,e),e.forEach((e=>{var t,i,s,a;switch(e.type){case"local-candidate":this.emit(je.f7.LocalCandidateStats,e);break;case"remote-candidate":this.emit(je.f7.RemoteCandidateStats,e);break;case"candidate-pair":this.emit(je.f7.CandidatePairStats,e);break;case"transport":this.emit(je.f7.TransportStats,e);break;case"outbound-rtp":{const{id:i,mid:s,mediaSourceId:a}=e;this.localId2Mid.set(i,s),this.mediaSourceId2Mid.set(a,s),null===(t=this.sendTransceivers.get(s))||void 0===t||t.emit(je.f7.OutboundRtpStats,e)}break;case"remote-inbound-rtp":{const t=this.localId2Mid.get(e.localId);null===(i=this.sendTransceivers.get(t))||void 0===i||i.emit(je.f7.RemoteInboundRtpStats,e)}break;case"inbound-rtp":null===(s=this.recvTransceivers.get(e.mid))||void 0===s||s.emit(je.f7.InboundRtpStats,e);break;case"remote-outbound-rtp":default:break;case"media-source":{const t=this.mediaSourceId2Mid.get(e.id);null===(a=this.sendTransceivers.get(t))||void 0===a||a.emit(je.f7.MediaSourceStats,e)}}}))}onCodecsChange(e,t){return Pt(this,void 0,void 0,(function*(){this.offer.media.forEach((i=>{i.mid===e&&(i.codecs=t)})),yield this.setLocalOfferAnswer()}))}setLocalOfferAnswer(){return Pt(this,void 0,void 0,(function*(){if(this.offer){const e=ce.writeSdp(this.offer);yield this.pc.setLocalDescription({type:"offer",sdp:e})}if(this.answer){const e=ce.writeSdp(this.answer);yield this.pc.setLocalDescription({type:"answer",sdp:e})}}))}onNegotiationNeeded(){}removeUnusedTransceiver(){if(this.answer){const e=new Array(this.mids.size);this.answer.media.forEach((t=>{const{mid:i}=t,s=this.mids.get(i);void 0!==s&&(e[s]=t)})),this.answer.media=e,this.answer.session.groups[0].ids=[...this.offer.session.groups[0].ids]}}addMLineSDPToAnswer(e,t){const i=this.mids.get(e);void 0!==i&&(this.answer.media[i]=t)}removeMLineSDPFromAnswer(e){const t=this.mids.get(e);if(void 0!==t){const i=this.answer.media[t],{type:s,connection:a,protocol:n}=i;this.answer.media[t]={type:s,connection:a,protocol:n,mid:e,direction:"inactive",port:0,payloadTypes:[0],otherLines:[],extensionMap:new Map,codecs:[]},this.recvTransceivers.get(e)?this.recvTransceivers.delete(e):this.sendTransceivers.get(e)&&this.sendTransceivers.delete(e)}}get connectionState(){return this.pc.connectionState}getOffer(){return this.offer}getAnswer(){return this.answer}updateOfferIceCredential(e){this.offer&&ce.updateIceCredential(this.offer,e)}updateAnswerIceCredential(e){this.answer&&ce.updateIceCredential(this.answer,e)}get currentRemoteDescription(){return this.pc.currentRemoteDescription}setConfiguration(e){this.config=Object.assign(Object.assign({},this.config),e),this.pc.setConfiguration(this.config)}get signalingState(){return this.pc.signalingState}}var Nt=i(7552),Bt=i(9109),Vt=i(1461),kt=i(5738),Ut=i(7548),xt=i(2064),Wt=i(6991),Ft=i(9373),zt=i(701);function jt(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,s)}return i}function Gt(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?jt(Object(i),!0).forEach((function(t){(0,c.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):jt(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class Ht{constructor(e){let{mIdMgr:t,signalSendSink:i,messageCallback:s,userId:a}=e;this._mIdMgr=t,this._WMSCsignalSendSink=i,this._messageCallback=s,this._wmscPC=null,this._wmscMainAudioTransceiver=null,this._wmscShareAudioTransceiver=null,this._initialized=!1,this._isDestroyed=!1,this._webRTCWorkletManager=null,this._useWebRTCOnDesktop=!1,this._isRecvOnly=!1,this._audioStream=null,this._shareAudioStream=null,this._recvMLineTemp=null,this._isMutedBySystem=!1,this._audioSpeakerSetErrorCnt=0,this._cleanUserEventFn=null,this._mid2RemoteRTCAudioPlayer=new Map,this._nodeId2VolumeMap=new Map,this._mainSessionNodeId2VolumeMap=new Map,this._codecDoAVSync=!1,this._AVsyncTimer=null,this._nodeId2NTPDescriptionMap=new Map,this._shareNodeId2NTPDescriptionMap=new Map,this._audioProfile=St.yu,this._isMuted=!1,this._audioMode=St.DY,this._noPacketsCounter=0,this._lastSentPackets=0,this._isAudioSentBytesZero=!1,this._healthCheckFailed=!1,this._recoverPlay1STimeout=null,this._showUplinkQosOnDashboard=!1,this._showDownlinkQosOnDashboard=!1,this._wmscAudioMonitor=new Mt({wmscAudio:this,userId:a,onBadNetwork:this._onBadNetworkDetected.bind(this),onPacketSent:this._checkPacketSent.bind(this),onMonitorLog:this._onRequestReportMonitorLog.bind(this)}),document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState&&this.playAllRemoteAudioPlayer(gt.vr.VISIBILITY_CHANGE)})),this.clearAllRemoteAudioPlayer()}get isMutedBySystem(){return this._isMutedBySystem}set isMutedBySystem(e){this._isMutedBySystem=e}get audioSpeakerSetErrorCnt(){return this._audioSpeakerSetErrorCnt}set audioSpeakerSetErrorCnt(e){this._audioSpeakerSetErrorCnt=e}initconfig(e){let{workletPath:t,recvOnly:i,codecDoAVSync:s,useWebRTCOnDesktop:a}=e;this._initialized||(this._initialized=!0,t&&(this._webRTCWorkletManager=new Ut.v(this.setNormalAudioStream.bind(this),t)),this._isRecvOnly=!!i,this._codecDoAVSync=!!s,this._useWebRTCOnDesktop=a)}getUplinkMid2MediaType(e){return e==this._wmscMainAudioTransceiver.mid?je.zu.MainAudio:e==this._wmscShareAudioTransceiver.mid?je.zu.ShareAudio:null}playAllRemoteAudioPlayer(e){if(this._isMutedBySystem)return;if(!this._audioMode)return;let t=Array.from(this._mid2RemoteRTCAudioPlayer.values()).map((e=>{if(e.isPaused()&&e.getNodeId())return e.play()})).filter(Boolean);t.length&&Promise.all(t).then((()=>{(0,gt.PV)("playAllRemoteAudioPlayer recover success-".concat(e))})).catch((t=>{(0,gt.lo)("REA:",e),this.notifyUIMessage(Vt.uoF),(0,gt.py)("Error when playAllRemoteAudioPlayer-".concat(e," : "),t)}))}_checkNeedPlayAllPlayerLater(e){"visible"===document.visibilityState&&null===this._recoverPlay1STimeout&&(this._recoverPlay1STimeout=setTimeout((()=>{this._recoverPlay1STimeout=null,this.playAllRemoteAudioPlayer(e)}),1e3))}async join(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:St.DY;if(i===St.qR)try{var s,a,n;this._cleanUserEventFn||(this._cleanUserEventFn=(0,Nt.zV)((()=>{this.playAllRemoteAudioPlayer(gt.vr.USER_CLICK)}))),null===(s=this._webRTCWorkletManager)||void 0===s||s.createWebRTCWorklet(),null===(a=this._webRTCWorkletManager)||void 0===a||a.changeAudioStatus(!1,!1),null===(n=this._webRTCWorkletManager)||void 0===n||n.startCheckProcess()}catch(e){(0,gt.py)("Error when creating webRTCWorklet",e)}this._audioMode=this._audioMode|i,i!=St.DY&&(this._startAVSyncTimer(),this._wmscAudioMonitor.startMonitor(this._wmscPC)),i===St.qR&&this.unmuteAllRemoteAudio()}async onPCCreated(e){(0,gt.U1)("onPCCreated oldWMSCPC=",this._wmscPC,"wmscPc=",e),this._audioMode&&this._startAVSyncTimer(),this._wmscPC&&(this._wmscAudioMonitor.resetWMSCPC(this._wmscPC,e),this._wmscPC=null,(0,gt.U1)("onPCCreated cleared old one")),this._wmscPC=e,this._preserveMlineOnPCCreated(e),this._updateQosAudioBandwidth()}setUserId(e){this._wmscAudioMonitor.setUserId(e)}addRecvTransceiver(e,t,i,s,a){return(0,gt.U1)("addRecvTransceiver , ".concat(e,", nodeId=").concat(t,", webrtcSSRC=").concat(i,", msid=").concat(s,", isCurrentSession=").concat(a)),this._wmscPC.createRecvTransceiver(e)}saveRecvMLineTemp(){const e=this._wmscPC.answer.media.find((e=>{if(!e)return!1;const{type:t,direction:i}=e;return"audio"===t&&"sendonly"===i}));this._recvMLineTemp=Gt({},e)}updateRecvMLineTemp(e){const{ice_pwd:t,ice_ufrag:i}=e;this._recvMLineTemp&&(this._recvMLineTemp.icePwd=t,this._recvMLineTemp.iceUfrag=i)}addRecvAudioSDP(e){const{transceiver:t,msid:i,mediaType:s,ssrcs:a={},user_id:n}=e,{rtp:o}=a,{mid:r}=t,c=o||ce.generateSsrc(),d=i||ce.generateUuid(),l=ce.generateUuid(),h=Gt({},this._recvMLineTemp);return h.mid=r,h.msid={streamId:d,trackId:l},h.ssrcs=[{ssrc:c,attribute:"cname:".concat(d)},{ssrc:c,attribute:"msid:".concat(d," ").concat(l)}],this._wmscPC.addMLineSDPToAnswer(r,h),(0,gt.U1)("addRecvAudioSDP mid=",r,"mLine=",h),{mid:r,media_type:s,msid:d,ssrcs:{rtp:c},user_id:n}}onRemoteStream(e,t,i,s){const a=this._convertUserId2NodeId(s);(0,gt.U1)("onRemoteStream, mid=".concat(i,", mediaStream.id=").concat(e.id,", nodeId=").concat(null!=a?a:"",", _mid2RemoteRTCAudioPlayer="),this._mid2RemoteRTCAudioPlayer),t.onunmute=t=>this._onDownlinkTrackUnmute(e,i,a)}handleLocalOffer(e){(0,gt.U1)("handleLocalOffer , parsedOffer=".concat(e));const t=ce.getSSRCByMid(e,this._wmscMainAudioTransceiver.mid),i=ce.getSSRCByMid(e,this._wmscShareAudioTransceiver.mid);(0,gt.U1)("handleLocalOffer , normal_ssrc=".concat(t,", share_ssrc=").concat(i)),Bt.A.sendMessageToRwg(Vt.yJV,{evt:dt,body:{normal_ssrc:t,share_ssrc:i}})}getUpdatedMlineFtmpFromLocalOffer(){var e;const t=ce.getMlineCodecFromLocalOffer(this._wmscPC.getOffer(),this._wmscMainAudioTransceiver.mid,"opus");let i="";t.codecParams.forEach(((e,t)=>{null!=e&&(i+="".concat(t,"=").concat(e,";"))}));const s=null===(e=this._wmscPC.getOffer())||void 0===e||null===(e=e.media)||void 0===e||null===(e=e.find((e=>e.mid===this._wmscMainAudioTransceiver.mid)))||void 0===e||null===(e=e.msid)||void 0===e?void 0:e.streamId;return{media_type:je.zu.MainAudio,mid:this._wmscMainAudioTransceiver.mid,msid:s||"-",codec:[{rtp_payload_type:t.payloadType,fmtp:i}]}}mungeLocalOffer(e){this._updateCodec(e)}mungeAnswer(e){this._updateCodec(e,!1)}onRWGCMDQos(e){var t,i;let s=e;const a=this._wmscAudioMonitor.getBitrateInfo(),n=Gt(Gt({},e.uplink),{},{sample_rate:48,rate:null===(t=a.publisher)||void 0===t?void 0:t.bitrate,encoding:!0}),o=Gt(Gt({},e.downlink),{},{sample_rate:48,rate:null===(i=a.subscriber)||void 0===i?void 0:i.bitrate,encoding:!1});this._audioMode!=St.DY&&(this._wmscAudioMonitor.setAudioStatisticsFromRWG(n),this._wmscAudioMonitor.setAudioStatisticsFromRWG(o)),(0,gt.U1)("onRWGCMDQos , qos=",s),this._showUplinkQosOnDashboard&&this.notifyUIMessage(Vt.iQY,n),this._showDownlinkQosOnDashboard&&this.notifyUIMessage(Vt.iQY,o)}onRWGCMDRtcpSR(e){let{ntptime:t,rtptime:i,ssrc:s,abssrc:a}=e;if(this._useWebRTCOnDesktop&&this._codecDoAVSync){let e=new ArrayBuffer(16),i=t.toString(2),a=parseInt(i.substring(0,i.length-32),2),n=parseInt(i.substring(i.length-32,i.length),2),o=new DataView(e);o.setUint32(0,s,!0),o.setUint32(4,n,!0),o.setUint32(8,a,!0),o.setUint32(12,Date.now(),!0);let r=new Uint8Array(e);(0,kt.Notify_Video_Decode_Thread)({command:"audioDecodeTime",status:1,data:r})}else 512&s?this._shareNodeId2NTPDescriptionMap.set(this._convertUserId2NodeId(s),{ntptime:t,rtptime:i,abssrc:a}):this._nodeId2NTPDescriptionMap.set(this._convertUserId2NodeId(s),{ntptime:t,rtptime:i,abssrc:a})}onMlineAssignedNodeId(e,t,i,s,a){var n,o,r;if(!i)return(0,gt.py)("onMlineAssignedNodeId nodeId error, ".concat(e,", mid=").concat(t,", nodeId=").concat(i,", webrtcSSRC=").concat(s,", isCurrentSession=").concat(a));let c;e==je.zu.MainAudio&&(c=null===(n=this._nodeId2VolumeMap.get(i))||void 0===n?void 0:n.speechVolume);let d="onMlineAssignedNodeId , ".concat(e,", mid=").concat(t,", nodeId=").concat(i,", webrtcSSRC=").concat(s,", isCurrentSession=").concat(a,", volume=").concat(null!==(o=c)&&void 0!==o?o:100);if((0,gt.U1)(d),(0,gt.PV)(d),(0,gt.lo)("REVT:".concat(t,"-").concat(i,"-").concat(s,"-").concat(a?1:0,"-").concat(null!==(r=c)&&void 0!==r?r:100)),this._mid2RemoteRTCAudioPlayer.has(t)){let s=this._mid2RemoteRTCAudioPlayer.get(t);s.onAssignedNodeId(e,i,a),void 0!==c&&s.setVolume(c),this._checkNeedPlayAllPlayerLater(gt.vr.ASSIGNED_NODE_ID)}else d+=" cannot find RTCAudioPlayer at present",(0,gt.py)(d);e==je.zu.ShareAudio&&(this._nodeId2VolumeMap.forEach(((e,t)=>{void 0!==e.shareVolume&&this.setShareVolumeLevel(t>>10,e.shareVolume,!1,!1)})),this._mainSessionNodeId2VolumeMap.forEach(((e,t)=>{void 0!==e.shareVolume&&this.setShareVolumeLevel(t>>10,e.shareVolume,!0,!1)})))}onMlineRemoved(e){if((0,gt.U1)("onMlineRemoved mid=".concat(e)),!this._mid2RemoteRTCAudioPlayer.has(e))return;(0,gt.lo)("REVTM:".concat(e));const t=this._mid2RemoteRTCAudioPlayer.get(e);t&&t.destroy(),this._mid2RemoteRTCAudioPlayer.delete(e),(0,gt.U1)("onMlineRemoved mid=".concat(e," done"))}_onBadNetworkDetected(e){let{isUplink:t,networkLevel:i,bwLevel:s}=e;this._audioMode==St.qR&&this._audioStream&&Bt.A.Notify_APPUI_SAFE(Vt.Joy,{isUplink:t,networkLevel:i,bwLevel:s})}_onRequestReportMonitorLog(e){(0,gt.U1)(e),Bt.A.sendMessageToRwg(Vt.yGo,{evt:Vt.UFw,seq:1,body:{data:e}})}_onDownlinkTrackUnmute(e,t,i){var s;let a;if(i||(i=this._convertUserId2NodeId(this._mIdMgr.getUserIdByMid(t))),this._mid2RemoteRTCAudioPlayer.has(t))a=this._mid2RemoteRTCAudioPlayer.get(t);else{var n;let s,o;i&&(s=this._mIdMgr.isMlineCurrentSessionByMid(t),o=this._mIdMgr.getMediaTypeByMid(t),(0,gt.U1)("_onDownlinkTrackUnmute, nodeId known, ".concat(o," mid=").concat(t,", nodeId=").concat(i,", isCurrentSession=").concat(s))),a=new Ft.A({mediaStream:e,speakerId:xt.A.speakerId,mediaType:null!==(n=o)&&void 0!==n?n:je.zu.MainAudio,nodeId:i,mid:t,isCurrentSession:s,pauseCallback:()=>{(0,gt.PV)("RTCAudioPlayer on paused, document visibility=".concat(document.visibilityState)),this._checkNeedPlayAllPlayerLater(gt.vr.PLAYER_ON_PAUSE)}}),this._mid2RemoteRTCAudioPlayer.set(t,a),(0,gt.U1)("_onDownlinkTrackUnmute, mid=",t,",this._mid2RemoteRTCAudioPlayer=",this._mid2RemoteRTCAudioPlayer)}this._checkNeedPlayAllPlayerLater(gt.vr.NEW_STREAM),this._isDestroyed&&a.mute(),(0,gt.lo)("REVTP:".concat(t,"-").concat(null!==(s=i)&&void 0!==s?s:""))}_wmscSignalSend(e){return!!this._WMSCsignalSendSink&&this._WMSCsignalSendSink(e)}notifyUIMessage(e,t){var i;null===(i=Bt.A.Notify_APPUI)||void 0===i||i.call(Bt.A,e,t)}async enableShareToBO(e){return this.notifyUIMessage(Vt.CcD,{enable:e})}async enableBroadCastToBO(e){return this.notifyUIMessage(Vt.g9q,{enable:e})}leaveAudioWithoutDisconnect(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:St.DY;var t,i;this._audioMode=this._audioMode&~e,e===St.qR?(this.setNormalAudioStream(null,!0),this.muteAllRemoteAudio(),this._cleanUserEventFn&&(this._cleanUserEventFn(),this._cleanUserEventFn=null),this._isMuted=!1,null===(t=this._webRTCWorkletManager)||void 0===t||t.changeAudioStatus(!1,!0),null===(i=this._webRTCWorkletManager)||void 0===i||i.stopCheckProcess(),this._wmscAudioMonitor.sendAudioMos(!0)):e===St.$t&&this.setShareAudioStream(null),this._audioMode===St.DY&&(this._wmscAudioMonitor.stopMonitor(this._wmscPC),this._stopAVSyncTimer())}_preserveMlineOnPCCreated(e){this._wmscMainAudioTransceiver=e.createSendTransceiver(je.zu.MainAudio),this._wmscShareAudioTransceiver=e.createSendTransceiver(je.zu.ShareAudio),e.createRecvTransceiver(je.zu.MainAudio),e.createRecvTransceiver(je.zu.MainAudio),e.createRecvTransceiver(je.zu.MainAudio)}_getAudioCodecParams(e){return St.gC[e]}_updateCodec(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._wmscMainAudioTransceiver.mid,s=this._wmscShareAudioTransceiver.mid;const a=t?"sendonly":"recvonly",n=e.media.filter((e=>"audio"===e.type&&e.direction===a));if(!i){const e=n.reduce(((e,t)=>parseInt(t.mid)<parseInt(e.mid)?t:e));i=e.mid}s||(s=n.filter((e=>e.mid!==i)).reduce(((e,t)=>parseInt(t.mid)<parseInt(e.mid)?t:e)).mid),ce.updateCodecParametersByMid(e,i,"opus",this._getAudioCodecParams(this._audioProfile)),ce.updateCodecParametersByMid(e,s,"opus",this._getAudioCodecParams(St.x_)),ce.updateCodecParameters(e,"audio",t?"recvonly":"sendonly","opus",this._getAudioCodecParams(St.fo)),t&&(ce.updateStreamIdByMid(e,i,this._wmscPC.mainEgressStreamId),ce.updateStreamIdByMid(e,s,this._wmscPC.shareEgressStreamId))}setRecvOnly(e,t){this._isRecvOnly=!!e,this._isRecvOnly?this.setNormalAudioStream(null):t&&this.setNormalAudioStream(t)}setCodecDoAVSync(e){this._codecDoAVSync=e}async setNormalAudioStream(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1]||(this._isRecvOnly?this._audioStream=null:this._audioStream=e,this._webRTCWorkletManager&&this._webRTCWorkletManager.setAudioStream(this._audioStream));let t=e;this._webRTCWorkletManager&&(t=this._webRTCWorkletManager.getAudioStream()),e&&(this._isMuted?this.mute():this.unmute()),await this.publishAudioStream(t,this._wmscMainAudioTransceiver,"PAT")}async setShareAudioStream(e){this._shareAudioStream=e,await this.publishAudioStream(this._shareAudioStream,this._wmscShareAudioTransceiver,"PAST")}async publishAudioStream(e,t,i){if(!this._isDestroyed){if(t)if(e){let s=[];e.getAudioTracks().forEach((e=>{(0,gt.PV)("publish track label: "+e.label),(0,gt.lo)("".concat(i,"-").concat(e.id)),s.push(t.publishTrack(e).catch((t=>{(0,gt.lo)("".concat(i,"-Failed-").concat(e.id)),(0,gt.py)("error publishing audio stream",t)})))})),await Promise.all(s)}else await t.publishTrack(null),(0,gt.lo)("".concat(i,"-null"));else(0,gt.lo)(i+"SE ");this._updateQosAudioBandwidth()}}mute(){var e;this._isMuted=!0,this._audioStream&&((0,gt.lo)("SEVTP"),this._audioStream.getAudioTracks().forEach((e=>{e.enabled=!1})),null===(e=this._webRTCWorkletManager)||void 0===e||e.changeAudioStatus(!0,!1))}unmute(){var e;this._isMuted=!1,this._audioStream&&((0,gt.lo)("SEVTM"),this._audioStream.getAudioTracks().forEach((e=>{e.enabled=!0})),null===(e=this._webRTCWorkletManager)||void 0===e||e.changeAudioStatus(!1,!1))}stopIncomingAudio(e){e?this.muteAllRemoteAudio():this.unmuteAllRemoteAudio()}muteAllRemoteAudio(){for(const[e,t]of this._mid2RemoteRTCAudioPlayer)t.mute()}unmuteAllRemoteAudio(){for(const[e,t]of this._mid2RemoteRTCAudioPlayer)t.unmute();this.playAllRemoteAudioPlayer(gt.vr.UNMUTE_ALL)}setSpeechVolumeLevel(e,t){const i=this._convertUserId2NodeId(e);(0,gt.U1)("setSpeechVolumeLevel nodeId=".concat(i,", volume=").concat(t));let s=this._nodeId2VolumeMap.get(i)||{};s.speechVolume=t,this._nodeId2VolumeMap.set(i,s);for(const[e,s]of this._mid2RemoteRTCAudioPlayer)if(this._mIdMgr.isMlineCurrentSessionByMid(e)&&s.getMediaType()==je.zu.MainAudio&&s.getNodeId()==i){s.setVolume(t),(0,gt.PV)("set speech volume level, nodeId=".concat(i,", volume=").concat(t));break}}async changeSpeaker(e){let t=!0,i="",s=Date.now(),a=[];for(const[s,n]of this._mid2RemoteRTCAudioPlayer){if(!1===n.isSupportSetSpeakerDevice()){t=!1,i="audioplayer.setSinkId is not supported on your device";break}let s=n.setSpeakerDevicePromise(e);a.push(s)}try{await Promise.all(a)}catch(e){t=!1,i="Error when setting sink of audio player: "+e.message}if(t)this._audioSpeakerSetErrorCnt=0,this.notifyUIMessage(Vt.a6z,e||"default");else{this._audioSpeakerSetErrorCnt++;let e=xt.A.getSpeakerId();(0,gt.py)("setSinkId failed ".concat(this._audioSpeakerSetErrorCnt," times, current speaker ").concat(e,", reason = ").concat(i)),this._audioSpeakerSetErrorCnt<=3&&this.notifyUIMessage(Vt.dsK,{reason:i,currentSink:e})}xt.A.updateSelectedSpeakerDevices(e,Date.now()-s,t)}setShareVolumeLevel(e,t,i){let s=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],a=e<<10,n=this._convertUserId2NodeId(a);if((0,gt.U1)("setShareVolumeLevel, nodeId=".concat(n,", volume=").concat(t,", isFromMainSession=").concat(i)),n){if(s)if(i){let e=this._mainSessionNodeId2VolumeMap.get(n)||{};e.shareVolume=t,this._mainSessionNodeId2VolumeMap.set(n,e)}else{let e=this._nodeId2VolumeMap.get(n)||{};e.shareVolume=t,this._nodeId2VolumeMap.set(n,e)}for(const[e,s]of this._mid2RemoteRTCAudioPlayer)s.getNodeId()==n&&this._mIdMgr.isMlineCurrentSessionByMid(e)!=i&&s.getMediaType()==je.zu.ShareAudio&&(t?s.unmute():s.mute(),(0,gt.PV)("setShareVolumeLevel, nodeId=".concat(n,", volume=").concat(t?1:0,", isFromMainSession=").concat(i)))}}set_CC_lang(e){(0,gt.PV)("set_CC_lang, lang=".concat(e)),this.notifyUIMessage(Vt.V5N,e)}updateUserMuteUnmuteStatus(e){const{update:t,remove:i}=e;t&&t.length>0&&t.forEach((e=>{const{userId:t,muted:i}=e;if(t){let e=this._nodeId2VolumeMap.get(this._convertUserId2NodeId(t))||{};e.muted=!!i,this._nodeId2VolumeMap.set(this._convertUserId2NodeId(t),e)}})),i&&i.length>0&&i.forEach((e=>{const{userId:t}=e;if(t){let e=this._nodeId2VolumeMap.get(this._convertUserId2NodeId(t))||{};e.muted=!0,this._nodeId2VolumeMap.set(this._convertUserId2NodeId(t),e)}}))}isUserMuted(e,t){var i;if(this._mIdMgr.getMediaTypeBySsrc(t)!==je.zu.MainAudio)return!1;const s=null===(i=this._nodeId2VolumeMap.get(this._convertUserId2NodeId(e)))||void 0===i?void 0:i.muted;return void 0!==s&&!!s}async setAudioProfile(e){if(this._audioMode!==St.qR&&this._audioMode!=St.$2)return;let t=this._audioProfile;"backgroundNoiseSuppression"===e.currentSelect?(e.highBitrate?this._audioProfile=St.$A:this._audioProfile=St.yu,xt.A.changeDenoiseSwitch("Zoom"===e.backgroundNoiseSuppression)):(xt.A.changeDenoiseSwitch(!1),e.originalSound.highfidelity&&e.originalSound.stereo?this._audioProfile=St.IA:e.originalSound.highfidelity?this._audioProfile=St.hc:e.originalSound.stereo?this._audioProfile=St.Hc:this._audioProfile=St.ej),t!==this._audioProfile&&(this._messageCallback("requestSelfRenegotiation",je.zu.MainAudio),Bt.A.sendMessageToRwg(Vt.yJV,{evt:ct,body:{audioProfile:this._audioProfile}}))}getAudioBandwidth(){let e=0;return this._wmscMainAudioTransceiver&&(e+=St.gC[this._audioProfile].get("maxaveragebitrate")+28800),this._wmscShareAudioTransceiver&&(e+=St.gC[St.x_].get("maxaveragebitrate")+28800),e}_updateQosAudioBandwidth(){ze.setAudioBandwidth(this.getAudioBandwidth())}clearAllRemoteAudioPlayer(){this.muteAllRemoteAudio();for(const[e,t]of this._mid2RemoteRTCAudioPlayer)t.destroy();this._mid2RemoteRTCAudioPlayer.clear()}getRemoteAudioPlayerByMid(e){return this._mid2RemoteRTCAudioPlayer.get(e)}destroy(){(0,gt.lo)("DS"),this._isDestroyed=!0,this._cleanUserEventFn&&(this._cleanUserEventFn(),this._cleanUserEventFn=null),this._wmscAudioMonitor.destroy(this._wmscPC),this._stopAVSyncTimer(),this._webRTCWorkletManager&&(this._webRTCWorkletManager.destroy(),this._webRTCWorkletManager=null),this.setNormalAudioStream(null),this.setShareAudioStream(null),this.clearAllRemoteAudioPlayer(),this._isRecvOnly=!1}async setStreamAsync(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1]?await this.setShareAudioStream(e):await this.setNormalAudioStream(e)}_stopAVSyncTimer(){this._AVsyncTimer&&(clearInterval(this._AVsyncTimer),this._AVsyncTimer=null)}syncSingleView(e,t){let i=0;if(t){let e=parseInt(t).toString(2),s=e.substring(0,e.length-32),a=e.substring(e.length-32,e.length);s=parseInt(s,2),a=parseInt(a,2),i=1e3*s+232.8*a/1e9}0==Bt.A.mediaSDKHandle.RenderInMain?e?(0,kt.Notify_Sharing_Decode_Thread)({command:"audioTimestamp",data:i}):(0,kt.Notify_Video_Decode_Thread)({command:"audioDecodeTime",status:0,data:i}):e?Bt.A.mediaSDKHandle.SharingRenderObj&&Bt.A.mediaSDKHandle.SharingRenderObj.SetcATimeStamp(i):Bt.A.CurrentSSRCTime!=i&&(Bt.A.CurrentSSRCTime=i,Bt.A.audioPlayTime=Date.now())}_startAVSyncTimer(){this._stopAVSyncTimer(),this._AVsyncTimer=setInterval((()=>{if(!this._wmscPC)return;let e=0;Array.from(this._mid2RemoteRTCAudioPlayer.keys()).forEach((t=>{this._wmscPC.getRecvTransceiverByMid(t).receiver.getSynchronizationSources().forEach((t=>{e++;let i=this.getNodeIdByWebRTCSSRC(t.source);if(!i)return;let s=null,a=!1;if(s=this._shareNodeId2NTPDescriptionMap.get(i),s&&s.abssrc===t.source?a=!0:s=this._nodeId2NTPDescriptionMap.get(i),s){let e=s.ntptime,n=s.rtptime,o=e+(t.rtpTimestamp-n)*Math.pow(2,32)/48e3;this._codecDoAVSync||i!=Bt.A.CurrentSSRC>>10&&!a||t.source===s.abssrc&&this.syncSingleView(a,o)}}))})),0===e&&(this.syncSingleView(!1,0),this.syncSingleView(!0,0))}),500)}getLevelR16Log(){return this._webRTCWorkletManager&&this._webRTCWorkletManager.getLevelR16Log()}getHealthCheckFailedAndReset(){return!!this._healthCheckFailed&&(this._healthCheckFailed=!1,!0)}_checkPacketSent(e){this._audioMode!=St.qR||!this._audioStream||this._isMuted||(e||0)-this._lastSentPackets!=0||this._isMutedBySystem?(this._audioMode==St.qR&&this._audioStream&&1==this._isAudioSentBytesZero&&(e||0)-this._lastSentPackets>0&&((0,gt.lo)("HEALTH_CHECK_RESTORED"),Bt.A.Notify_APPUI_SAFE(Vt.FjO)),this._isAudioSentBytesZero=!1,this._noPacketsCounter=0,this._lastSentPackets=e||0):(this._noPacketsCounter++,2===this._noPacketsCounter&&0==this._isAudioSentBytesZero&&((0,gt.lo)("HEALTH_CHECK_FAILED"),(0,zt.iK)(Vt.$qV,St.Mm),this._healthCheckFailed=!0,this._isAudioSentBytesZero=!0,this._noPacketsCounter=0))}_convertUserId2NodeId(e){return e?parseInt(e)>>10<<10:null}changeDenoiseSwitch(e,t){var i;null===(i=this._webRTCWorkletManager)||void 0===i||i.changeDenoiseSwitch(e,t)}updateQos(e){this._wmscAudioMonitor.setEnableBitrateReport(e.enable),e.workerType===Wt._c.AUDIO_ENCODE&&(this._showUplinkQosOnDashboard=!!e.enable),e.workerType===Wt._c.AUDIO_DECODE&&(this._showDownlinkQosOnDashboard=!!e.enable)}getNodeIdByWebRTCSSRC(e){return this._convertUserId2NodeId(this._mIdMgr.getUserIdBySsrc(e))}getAudioStream(){var e;return(null===(e=this._webRTCWorkletManager)||void 0===e?void 0:e.getAudioStream())||this._audioStream}getAudioMode(){return this._audioMode}}function Qt(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,s)}return i}function qt(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Qt(Object(i),!0).forEach((function(t){(0,c.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Qt(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const Yt=$.getTracer("WmscApiImpl"),Jt=e=>{Yt.log(e),$.monitorLog("".concat(e))},Kt=h,{zk:Xt}=s;class Zt{constructor(e,t){Yt.log("created, config: ".concat(JSON.stringify(e))),x.setConfig(e||{}),this.messageCallback=t,this.resetRunTimeParams(),this.negotiationMsgId=0,this.negotiationTimeCost=[],this.pc=null,this.mIdMgr=new mt([]),At.mIdMgr=this.mIdMgr,this._isWMSCAudioEnabled()&&this.createWmscAudioMgr(x.nodeId,this.mIdMgr),this.createPeerConnection(),x.nodeId&&(At.setUserId(x.nodeId),At.start()),this._isWMSCVideoEnabled()&&(this.initVideoConfig(),At.isWebRTCVideoEnabled=!0),this.startNegotiation(),this.renegotiationQueue=[],this.numOfTasks=0,this.createdMLine=[],this.removedMids=[],this.updatedMlineFmtp=[],this.lastStreamReqSeq=0,this.lastStreamStatusSeq=0,this.localIceCredential=null,this.ongoingUpdateBitrateTasks=[],this._handlePageVisibilityChange=this._handlePageVisibilityChange.bind(this)}destroy(){var e,t;this.sendBye(),this.closeAllPeerConnections(),this.resetRunTimeParams(),null===(e=this._wmscAudioMgr)||void 0===e||e.destroy(),ze.stop(),null==At||At.stop(),null===(t=this.mIdMgr)||void 0===t||t.destory(),document.removeEventListener("visibilitychange",this._handlePageVisibilityChange)}resetRunTimeParams(){Yt.log("reset run time parameters");const{negotiationTimer:e,reconnectTimer:t}=this.pcInfo||{};e&&clearTimeout(e),t&&clearTimeout(t),this.pcInfo={status:u.IDLE,reconnectionCount:0,negotiationTimer:0,reconnectTimer:0,offerMsgId:0,useIceServers:!1,isNegotitating:!1,iceCredentialMsgId:0,iceRestartCount:0,isConnecting:!1},this.camStreams=null,this.bActiveVideo=!1,this.bPrevActiveVideo=!1,this.lastSubList=[],this.sourceVideoSize=-1,this.lastUpdatedSourceVideoSize=-1,this._toSubscribeBuffer=[],this._videoTagMappingBuffer=new Map,this.mIdMgr=null,this.subscriptions=new Map,this.maxSubVideoSize=-1}renewPeerConnection(){this.createPeerConnection(),this._isWMSCVideoEnabled()&&Ye.init(this.pc,this.recvMLineNum),this.camStreams&&this._addVideoStreams(this.camStreams),this.startNegotiation()}initVideoConfig(e){Jt("WMSC_VCN-".concat(Ye.recvCodecNum,"-").concat(Ye.sendCodecNum)),x.setConfig(e||{});const t=x.videoSettings;pt.setLimits({maxSendVideoSize:t.maxCaptureVideoSize,maxRecvVideoNum:t.maxRecvVideoNum}),this.videoCapabilities=pt.getCapabilities();const{maxSendVideoSize:i,maxRecvVideoSize:s,maxRecvVideoNum:a}=this.videoCapabilities;Jt("WMSC_V_Cap_Updated: ".concat(i,"|").concat(s,"|").concat(a)),this.recvMLineNum=a,this.maxRecvVideoSize=s,Ye.registerMessageCallback(this.onMediaMessage.bind(this)),Ye.setVideoSettings(t),At.onDecodeError=this._handleDecodeError.bind(this),Ye.init(this.pc,this.recvMLineNum),this.camStreams&&this._addVideoStreams(this.camStreams),this._mapBufferedVideoTag(),Ye.onMediaRequest(this.lastSubList),ze.registerSendUsageStateUpdateCallback(this.onSendUsageStateUpdate.bind(this)),ze.registerMaxRecvVideoSizeUpdateCallback(this.onMaxRecvVideoSizeUpdate.bind(this)),ze.start(x.qosOptions),this.messageCallback({type:F.VIDEO_CAPABILITIES_CHANGE,data:this.videoCapabilities}),Jt("WMSC_SW_PRE: ".concat(Te("send"),"|").concat(Te("recv")))}_isWMSCAudioEnabled(){return x.webrtcMode&St.h}_isWMSCVideoEnabled(){return x.webrtcMode&St.Q9}_handleAudioSessionStatus(e,t){"requestSelfRenegotiation"===e&&this.requestSelfRenegotiation(t)}createWmscAudioMgr(e,t){this._wmscAudioMgr||(Jt("INITWMSCAUDIO"),this._wmscAudioMgr=new Ht({userId:e,mIdMgr:t,signalSendSink:this._sendMessageToRwg.bind(this),messageCallback:this._handleAudioSessionStatus.bind(this)}))}getWMSCAudioMgr(){return this._wmscAudioMgr}stopReceiveVideo(){Jt("WMSC_Stop_Recv_Video"),this.sendBye(),this.closePeerConnection(),this.mIdMgr=null}createPeerConnection(){var e,t;Jt("WMSC_Start_Create_PC");let i=null===(e=this.pcInfo)||void 0===e?void 0:e.useIceServers;this.pc=new Ot({iceServers:i?x.iceServers:[]}),Jt("WMSC_PC_Create_Success"),null===(t=this._wmscAudioMgr)||void 0===t||t.onPCCreated(this.pc),this.pc.on(je.f7.ConnectionStateChange,this._handlePcStateChange.bind(this)),this.pc.on(je.f7.Track,this._handleRemoteStream.bind(this)),this.pc.on(je.f7.SignalingStateChange,this._handleSignalingStateChange.bind(this)),this.pc.on(je.f7.IceConnectionStateChange,this._handleIceConnectionStateChange.bind(this)),this.pc.on(je.f7.IceGatheringStateChange,(e=>{Jt("WMSC_CANDGA: ".concat(e))})),this.pc.on(je.f7.IceCandidateError,(e=>{const{errorCode:t,errorText:i}=e;Jt("WMSC_onicecandidateerror: ".concat(t)),$.globalTrace({logLevel:"error",log:"WMSC_onicecandidateerror: ".concat(t,"|").concat(i)})})),this.pc.on(je.f7.StatsReport,(e=>{At.startCapture(e)}))}async _addVideoStreams(e){var t,i;const s=null===(t=e[0])||void 0===t||null===(t=t.stream)||void 0===t?void 0:t.getVideoTracks()[0],a=null===(i=e[e.length-1])||void 0===i||null===(i=i.stream)||void 0===i?void 0:i.getVideoTracks()[0],n=null==a?void 0:a.getSettings();if(a){const{width:e,height:t,frameRate:i}=n||{};Jt("WMSC_Original_Video_Track: ".concat(e,"x").concat(t,"@").concat(i,"fps")),this.sourceVideoSize=Ie({width:e,height:t}),Ye.setMaxSendLayerId(Math.min(this.videoCapabilities.maxSendVideoSize,this.sourceVideoSize))}else this.sourceVideoSize=-1,this.lastUpdatedSourceVideoSize=-1;await Ye.publishVideoTrack(s,n)}async onVideoStreamsAsync(e){var t;return this.camStreams=e,At.camStream=null===(t=e[1])||void 0===t?void 0:t.stream,await this._addVideoStreams(e),Promise.resolve(!0)}async startNegotiation(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const i=this.pcInfo;let s;e||(i.status=u.CONNECTING),i.isNegotitating=!0,(!e||null!=t&&t.iceRestart)&&this._detectConnectionTimeout();try{var a,n;if(this.negotiationTimeCost=[performance.now()],s=await this.pc.createOffer(t),this.negotiationTimeCost.push(performance.now()),Jt("WMSC_CO"),Ye.mungeLocalOffer(s),null===(a=this._wmscAudioMgr)||void 0===a||a.mungeLocalOffer(s),null!=t&&t.iceRestart&&this.pc.updateOfferIceCredential(this.localIceCredential),await this.pc.setOffer(),this.negotiationTimeCost.push(performance.now()),Jt("WMSC_SLDS"),e)return s;ce.mungeEgressOfferToRemote(s),null===(n=this._wmscAudioMgr)||void 0===n||n.handleLocalOffer(s);const i=ce.writeSdp(s);this._handleSdpOffer(i)}catch(t){let i="";s&&(i=ce.writeSdp(s)),Q(i,T.GZIP_BASE64).then((i=>{$.globalTrace({logLevel:"error",log:"WMSC_OFSLDF: ".concat(e,"|").concat(t.message,"|").concat(i)})})).catch((()=>{$.globalTrace({logLevel:"error",log:"WMSC_OFSLDF: ".concat(e,"|").concat(t.message,"|").concat(i)})})),Jt("WMSC_OFSLDF-".concat(e,"-").concat(t.message)),e?this.messageCallback({type:F.SDP_NEGOTIATION_FAIL}):"closed"!==this.pc.signalingState&&this.restartNegotiation()}}restartNegotiation(){const e=this.pcInfo;this.sendBye(),this.closePeerConnection(),e.reconnectionCount<S?(e.reconnectionCount++,Jt("WMSC_Restart_Nego: ".concat(e.reconnectionCount)),this._isWMSCAudioEnabled()&&this.messageCallback({type:F.ERROR_MESSAGE,data:{type:"PC_RECONNECT",mediaType:"audio"}}),this._isWMSCVideoEnabled()&&this.messageCallback({type:F.ERROR_MESSAGE,data:{type:"PC_RECONNECT",mediaType:"video"}}),this.renewPeerConnection()):this.messageCallback({type:F.SDP_NEGOTIATION_FAIL})}closePeerConnection(){if(this.pc){var e;const t=this.pcInfo;clearTimeout(t.negotiationTimer),t.status=u.IDLE,this.pc.removeAllListeners(),this.pc.close(),Ye.handlePcClose(),null===(e=this.mIdMgr)||void 0===e||e.removeAllMIdResource()}}closeAllPeerConnections(){this.closePeerConnection()}onMediaMessage(e){const{type:t,data:i}=e;switch(Yt.log("onMediaMessage, type: ".concat(t)),t){case M.ERROR:Yt.error("onMediaMessage, error: ".concat(i));break;case M.UPDATE_BITRATE:this._pushToRenegotiationQueue([qt({type:Xt.UPDATE_BITRATE},i)]);break;default:Yt.error("onMediaMessage, unknown type: ".concat(t))}}onSendUsageStateUpdate(e){e===C.UNDERUSING&&this.sourceVideoSize>=0&&this._maybeUpdateVideoSourceConstraints(this.sourceVideoSize+1)}_maybeUpdateVideoSourceConstraints(e){let{maxCaptureVideoSize:t,hdVideoEnabled:i}=x.videoSettings;if(i||(t=Math.min(2,t)),e<=t&&e!==this.lastUpdatedSourceVideoSize){const t=ve(e),i={width:t.width,height:t.height,frameRate:t.maxFramerate};return this.messageCallback({type:F.UPDATE_VIDEO_CAPTURE_CONSTRAINTS,data:i}),this.lastUpdatedSourceVideoSize=e,!0}return!1}onMaxRecvVideoSizeUpdate(e){this.maxRecvVideoSize=Math.min(this.videoCapabilities.maxRecvVideoSize,e);const t=[];for(const[i,s]of this.subscriptions){const a=this.mIdMgr.getVideoSizeByUserId(i),n=Math.min(e,s);a!==n&&t.push({id:i,size:n})}t.length&&this._updateSubscriptions(t)}_handleVideoTagMappingBuffer(e,t,i){const s=this._videoTagMappingBuffer.get(e)||[];switch(t){case"add":s.push(i),this._videoTagMappingBuffer.set(e,s);break;case"remove":for(let e=0;e<s.length;)s[e]===i?s.splice(e,1):e++;s.length||this._videoTagMappingBuffer.delete(e);break;default:Jt("WMSC_Mapping_Buffer_Action_E: ".concat(e,"|").concat(t))}}onVideoTagMapping(e){const t=parseInt(e.userId),{videodom:i,action:s}=e;if(Jt("WMSC_Video_Tag_Mapping: ".concat(t,"|").concat(s,"|").concat(!!this.mIdMgr)),this.mIdMgr)switch(s){case"add":case"buffer":this.mIdMgr.saveVideoTag(t,i),this.messageCallback({type:F.VIDEO_TAG_MAPPED,data:t});break;case"remove":this.mIdMgr.removeVideoTag(t,i);break;default:Jt("WMSC_Mapping_Action_E: ".concat(t,"|").concat(s))}else Yt.warn("onVideoTagMapping, mIdMgr not ready yet. Will do mapping later."),this._handleVideoTagMappingBuffer(t,s,i)}getUserIdVideo(e){return this.mIdMgr?this.mIdMgr.getVideoTagsByUserId(e):null}_mapBufferedVideoTag(){this._videoTagMappingBuffer.size&&(this._videoTagMappingBuffer.forEach(((e,t)=>{(null==e?void 0:e.length)>0&&e.forEach((e=>{this.onVideoTagMapping({userId:t,videodom:e,action:"buffer"})}))})),this._videoTagMappingBuffer.clear())}subscribeVideo(e){const t=this.pcInfo;if(t.status!==u.CONNECTED)return e.forEach((e=>{this._toSubscribeBuffer.push({params:e,toSub:!0})})),void Jt("WMSC_SubV_PC_N_Ready: ".concat(t.status));const i=Math.min(this.maxRecvVideoSize,ze.getMaxFeasibleRecvVideoSize());let s=-1;e.forEach((e=>{const{id:t,size:a}=e;this.subscriptions.set(t,a),a>s&&(s=a);const n=Math.min(a,i);n!==a&&(e.size=n),this.mIdMgr.setVideoSize(t,n),At.updateSubInfo(t,n)})),s>this.maxSubVideoSize&&(this.maxSubVideoSize=s,ze.updateMaxSubVideoSize(s)),this.messageCallback({type:F.UPDATE_VIDEO_SUBSCRIPTION,data:e})}unSubscribeVideo(e){if(this.pcInfo.status!==u.CONNECTED)return e.forEach((e=>{this._toSubscribeBuffer.push({params:e,toSub:!1})})),void Jt("WMSC_UnsubV_PC_N_Ready");let t=-1;e.forEach((e=>{this.subscriptions.delete(e.id),At.updateSubInfo(e.id,-1),this.mIdMgr.setVideoSize(e.id,-1)}));for(const[,e]of this.subscriptions)e>t&&(t=e);this.maxSubVideoSize!==t&&(this.maxSubVideoSize=t,ze.updateMaxSubVideoSize(t)),this.messageCallback({type:F.UPDATE_VIDEO_UNSUBSCRIPTION,data:e})}_updateSubscriptions(e){const t=[];e.forEach((e=>{var i;const{id:s,size:a}=e;(null===(i=this.mIdMgr)||void 0===i?void 0:i.getMainVideoMId(s))&&(t.push({id:s,size:a,bOn:!1}),this.mIdMgr.setVideoSize(s,a))})),this.messageCallback({type:F.UPDATE_VIDEO_SUBSCRIPTION,data:t})}onRwgMessage(e){var t,i;const s="string"==typeof e.data?JSON.parse(e.data):e.data;if((null==s?void 0:s.evt)===ot||(null==s?void 0:s.evt)===rt){const e=s.body;switch(e.type){case Ke:return Yt.log("on SDP_ANSWER"),this.onSdpAnswer(e),!0;case Ze:return Yt.log("on SDP_BYE"),this.onSdpBye(e),!0;case $e:return Yt.log("on ICE_DISCONNECTED"),this.onIceDisconnected(e),!0;case nt:return this.onSubscribeList(e.activeVideo,e.prevActiveVideo,e.privateVideo),!0;case at:return this.onCommand(e),!0;case et:return this._handleStreamRequest(e),!0;case st:return null===(t=this._wmscAudioMgr)||void 0===t||t.onRWGCMDQos(e),!0;case it:return null===(i=this._wmscAudioMgr)||void 0===i||i.onRWGCMDRtcpSR(e),!0;default:return Yt.warn("Received unknown RWG message type: ".concat(e.type)),!1}}}async onSdpAnswer(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!t&&!this._checkMsgIdForPC(e))return;let s=e,a=null;try{var n;if(this.negotiationTimeCost.push(performance.now()),!t){Jt("WMSC_REAN");const t=this.pc,{sdp:n,sdpEncoding:o}=e;if(s=await function(e,t){return G(this,void 0,void 0,(function*(){switch(t){case T.GZIP_BASE64:{const t=function(e){const t=atob(e),i=new Uint8Array(t.length);for(let e=0;e<i.length;e++)i[e]=t.charCodeAt(e);return i.buffer}(e);return function(e){return G(this,void 0,void 0,(function*(){if(window.DecompressionStream){const t=new DecompressionStream("gzip"),i=t.writable.getWriter();return i.write(e),i.close(),new Response(t.readable).arrayBuffer().then((function(e){return(new TextDecoder).decode(e)}))}{const{ungzip:t}=yield i.e(404).then(i.bind(i,3075));return(new TextDecoder).decode(t(e).buffer)}}))}(t)}case T.PLAIN:return e;default:return null}}))}(n,o),this.pc!==t)return;At.sendSdpLog("ANSWER",s),a=ce.parseSdp(s)}a||(a=this.pc.getAnswer()),null===(n=this._wmscAudioMgr)||void 0===n||n.mungeAnswer(a),Ye.mungeAnswer(a);let r=ce.writeSdp(a);var o;await this.pc.setAnswer(r),this.negotiationTimeCost.push(performance.now()),this.pcInfo.isNegotitating=!1,Jt("WMSC_SRDS"),t?this._handleSelfNegotiationSuccess():(this.sendSdpOk(),Ye.saveCodecList(),Ye.saveRecvMLineTemp(),Ye.updateConfigFromSdp(a),null===(o=this._wmscAudioMgr)||void 0===o||o.saveRecvMLineTemp()),this._popRenegotiationQueue()}catch(e){const i=s||ce.writeSdp(this.pc.answer);Q(i,T.GZIP_BASE64).then((i=>{$.globalTrace({logLevel:"error",log:"WMSC_SRDF: ".concat(t,"|").concat(e.message,"|").concat(i)})})).catch((()=>{$.globalTrace({logLevel:"error",log:"WMSC_SRDF: ".concat(t,"|").concat(e.message,"|").concat(i)})})),Jt("WMSC_SRDF-".concat(t,"-").concat(e.message)),t?this.messageCallback({type:F.SDP_NEGOTIATION_FAIL}):"closed"!==this.pc.signalingState&&this.restartNegotiation()}}onSdpBye(e){this._checkMsgIdForPC(e)&&"have-local-offer"===this.pc.signalingState&&(this.closePeerConnection(),$.globalTrace({logLevel:"error",log:"WMSC_SDP_BYE_REJECT"}),Jt("WMSC_BYEREJ"),this.messageCallback({type:F.SDP_NEGOTIATION_FAIL}))}onIceDisconnected(e){this._checkMsgIdForPC(e)&&(Jt("WMSC_ICE_DISCON"),$.globalTrace({logLevel:"error",log:"WMSC_RestartIce_F_S"}),this.restartIce())}restartIce(){const e=this.renegotiationQueue.find((e=>{let{type:t}=e;return t===Xt.ICE})),{iceRestartCount:t,isConnecting:i}=this.pcInfo;if(!e&&!i)if(t<_){this.pcInfo.iceRestartCount++,this.localIceCredential=ce.generateIceCredentials(),this.pcInfo.iceCredentialMsgId++;const e=lt(x.confId,null,null,null,null,qt({generation_id:this.pcInfo.iceCredentialMsgId},this.localIceCredential),this.lastStreamReqSeq,this.lastStreamStatusSeq);this._sendMessageToRwg({evt:ot,body:e}),Jt("WMSC_ICECREDREQ:".concat(this.pcInfo.iceCredentialMsgId,",").concat(this.lastStreamReqSeq,",").concat(this.lastStreamStatusSeq)),this.lastStreamStatusSeq++}else this.messageCallback({type:F.PC_FAIL})}onSubscribeList(e,t,i){var s;Jt(J("WMSC_On_Sub_List: ".concat(JSON.stringify(e),"|").concat(JSON.stringify(t),"|").concat(JSON.stringify(i)))),At.updateSubscribedSize(e,t,i);const a=l()(s=Array.from(new Set([...e,...t,...i]).values()).filter((e=>e>=0))).call(s);q(a,this.lastSubList)||(this.lastSubList=[...a],this.pcInfo.status===u.CONNECTED&&Ye.onMediaRequest(a))}onCommand(e){if(0===e.cmdId){let t;try{t=JSON.parse(e.cmdParam)}catch(t){Yt.warn("Invalid command message: ".concat(JSON.stringify(e)))}void 0!==t.receiverBW?ze.onReceiverBandwidthReport(t.receiverBW):void 0!==t.subInfo?(ze.onSubInfo(t.subInfo),At.onDualCallState(t.subInfo)):void 0!==t.ingressReport&&(ze.onReceiverReport(t.ingressReport),At.onReceiverReport(t.ingressReport))}else Yt.warn("Unknown command id ".concat(e.cmdId))}onActiveVideoSourceChange(e){const t=parseInt(x.nodeId)===parseInt(e.userId);return this.bPrevActiveVideo=this.bActiveVideo&&!t,this.bActiveVideo=t,At.setActiveSpeaker(e.userId,this.bPrevActiveVideo),Jt("WMSC_OASC: ".concat(e.userId)),this.mIdMgr.setActiveSpeaker(e.userId),!0}updateWmscParams(e){Yt.log("updateWmscParams, data: ".concat(JSON.stringify(e))),Object.entries(e).forEach((e=>{let[t,i]=e;switch(t){case"nodeId":var s;x.setConfig({nodeId:i}),At.setUserId(i),At.start(),null===(s=this._wmscAudioMgr)||void 0===s||s.setUserId(i);break;case"hdVideoEnabled":{const e=!!i;x.setConfig({videoSettings:qt(qt({},x.videoSettings),{},{hdVideoEnabled:e})}),Ye.enableHdVideo(e)}break;case"preferSoftwareCodec":{const e=Te("send"),t=Te("recv");this._updateSoftwareCodecPreference(i),t!==Te("recv")&&(Jt("WMSC_SW_PRE_RECV: ".concat(!t)),this.pcInfo.status!==u.IDLE&&this._sendRecvCodecPreference(je.zu.MainVideo)),e!==Te("send")&&(Jt("WMSC_SW_PRE_SEND: ".concat(!e)),this.pcInfo.status!==u.IDLE&&this._pushToRenegotiationQueue([{type:Xt.MEDIA,mediaType:je.zu.MainVideo,preferSoftwareCodec:!e}]));break}default:Yt.warn("updateWmscParams, unknown param name: ".concat(t))}}))}sendBye(){const e=(t=x.confId,i=o.VIDEO,s=Kt,a=this.negotiationMsgId,{type:Ze,confID:t,sessionID:i,peerID:s,msgID:a,sdp:""});var t,i,s,a;this._sendMessageToRwg({evt:ot,body:e}),Jt("WMSC_SDPBYE")}sendSdpOk(){const e=(t=x.confId,i=o.VIDEO,s=Kt,a=this.negotiationMsgId,{type:Xe,confID:t,sessionID:i,peerID:s,msgID:a});var t,i,s,a;this._sendMessageToRwg({evt:ot,body:e}),Jt("WMSC_SDPOK")}_sendMessageToRwg(e){this.messageCallback({type:F.WMSC_MESSAGE_TO_RWG_BY_SDK,data:JSON.stringify(e)})}async _handleRemoteStream(e){var t;const i=new MediaStream,{track:s,transceiver:a,streams:n=[]}=e,{kind:o}=s,r=a.mid,c=(null===(t=n[0])||void 0===t?void 0:t.id)||"";if(Jt("WMSC_RSV_M: ".concat(r,"-").concat(o)),"video"===o)this.mIdMgr.addMidResource(r,{streamId:c,track:s,transceiver:a});else if("audio"===o){var d;this.mIdMgr.addMidResource(r,{streamId:c}),i.addTrack(s);const e=this.mIdMgr.getUserIdByMid(r);null===(d=this._wmscAudioMgr)||void 0===d||d.onRemoteStream(i,s,r,e)}}async _handleSdpOffer(e){let t=T.PLAIN,i=e;const s=this.pc;try{i=await Q(e,T.GZIP_BASE64),t=T.GZIP_BASE64}catch(e){$.globalTrace({logLevel:"error",log:"WMSC_Compress_SDP_Offer_F",errorEvent:e})}if(this.pc!==s)return;const a=++this.negotiationMsgId,n=((e,t,i,s,a,n,o,r)=>({type:Je,confID:e,sessionID:t,peerID:i,msgID:s,sdp:a,sdpEncoding:n,featureToggles:[{key:"webrtc_dynamic_egress_media_streams",value:!0},{key:"webrtc_client_sending_codec_preference",value:o},{key:"webrtc_client_recving_codec_preference",value:r}]}))(x.confId,o.VIDEO,Kt,a,i,t,Ye.getPreferPayloadTypes("send"),Ye.getPreferPayloadTypes("recv"));this.pcInfo.offerMsgId=a,this._sendMessageToRwg({evt:ot,body:n}),At.sendSdpLog("OFFER",e)}_handlePcStateChange(e){const t=this.pcInfo;if(Jt("WMSC_onconnectionstatechange: ".concat(e)),"connected"===e){this.negotiationTimeCost.push(performance.now());const e=this._getNegotiationTime();for($.globalTrace({logLevel:"directReport",log:e.join("-"),tags:["WMSC Negotiation time"]}),Jt("WMSCNT-".concat(e.join("-"))),clearTimeout(t.negotiationTimer),clearTimeout(t.reconnectTimer),t.status=u.CONNECTED,t.reconnectionCount=0,t.negotiationTimer=0,t.iceRestartCount=0,t.isConnecting=!1,Yt.log("_handlePcStateChange: connected"),Ye.onMediaRequest(this.lastSubList);this._toSubscribeBuffer.length;){const e=this._toSubscribeBuffer.shift();e.toSub?this.subscribeVideo([e.params]):this.unSubscribeVideo([e.params])}this.messageCallback({type:F.PC_CONNECTED})}else if("disconnected"===e)this.pcInfo.reconnectTimer=setTimeout((()=>{"disconnected"===this.pc.connectionState&&(Jt("WMSC_PC_Disconn"),this.restartIce())}),p);else if("failed"===e){const e="WMSC_PC_State_Failed: ".concat(this._getNegotiationTime().join("-"));$.globalTrace({logLevel:"error",log:e}),Jt(e),this._enableTURN(),this.restartIce()}}_handlePageVisibilityChange(){"visible"===document.visibilityState&&(this.messageCallback({type:F.PC_CLOSED}),document.removeEventListener("visibilitychange",this._handlePageVisibilityChange))}_handleSignalingStateChange(e){Jt("WMSC_onsignalingstatechange: ".concat(e)),"closed"===e&&setTimeout((()=>{Zt.PC_CLOSE_CNT++,"hidden"===document.visibilityState?($.globalTrace({logLevel:"error",log:"WMSC_PC_CLOSE: HIDDEN"}),document.addEventListener("visibilitychange",this._handlePageVisibilityChange)):(Zt.PC_UNKNOWN_CLOSE_CNT>=v?this.messageCallback({type:F.PC_FAIL}):this.messageCallback({type:F.PC_CLOSED}),Zt.PC_UNKNOWN_CLOSE_CNT++,$.globalTrace({logLevel:"error",log:"WMSC_PC_CLOSE_UNKNOWN: ".concat(Zt.PC_UNKNOWN_CLOSE_CNT)}))}),1500)}_handleIceConnectionStateChange(e){Jt("WMSC_ICESTATE: ".concat(e)),"failed"===e&&$.globalTrace({logLevel:"error",log:"WMSC_ICE_State_Error: ".concat(e)})}_handleDecodeError(e){Ye.removeRecvCodecByProfile(e),0===Ye.ingressCodecList.length?($.globalTrace({logLevel:"error",log:"WMSC_No_Recv_Codec"}),Jt("WMSC_ERC"),this.messageCallback({type:F.VIDEO_FAIL,data:Kt})):this._sendRecvCodecPreference(je.zu.MainVideo)}_checkMsgIdForPC(e){const{msgID:t}=e,{offerMsgId:i}=this.pcInfo;return t===i||(Yt.warn("Message id ".concat(t," doesn't match the offer message id ").concat(i)),!1)}_getNegotiationTime(){const e=this.negotiationTimeCost,t=[];if(e){const i=e.length;for(let s=0;s<i-1;s++)t.push(Math.round(e[s+1]-e[s]));t.push(Math.round(performance.now()-e[0]))}return t}_updateSoftwareCodecPreference(e){var t;let{videoSettings:i}=x.getConfig();var s;null!==(t=i)&&void 0!==t&&t.preferSoftwareCodec?i.preferSoftwareCodec=qt(qt({},null===(s=i)||void 0===s?void 0:s.preferSoftwareCodec),e):i={preferSoftwareCodec:e},x.setConfig({videoSettings:i})}_handleNewMLine(e){const{mediaType:t}=e;let i;if(t===je.zu.MainVideo)i=Ye.addRecvVideoSDP(e),i.rtp_payload_type=Ye.getRecvCodecPayloads();else if(t===je.zu.MainAudio){var s;i=null===(s=this._wmscAudioMgr)||void 0===s?void 0:s.addRecvAudioSDP(e)}else if(t===je.zu.ShareAudio){var a;i=null===(a=this._wmscAudioMgr)||void 0===a?void 0:a.addRecvAudioSDP(e)}this.createdMLine.push(i)}async doRenegotiation(){this.numOfTasks=this.renegotiationQueue.length;const e=this.renegotiationQueue.find((e=>{let{type:t}=e;return t===Xt.ICE})),t=[];try{await this.startNegotiation(!0,{iceRestart:!!e}),this.pc.removeUnusedTransceiver();for(let a=0;a<this.numOfTasks;a++){const n=this.renegotiationQueue[a],{type:o}=n;if(o===Xt.ADD_MLINE)this._handleNewMLine(n),t.push("".concat(Xt.ADD_MLINE,"-").concat(n.mediaType,"-").concat(n.transceiver.mid));else if(o===Xt.REMOVE_MLINE){const{mid:e}=n;this.pc.removeMLineSDPFromAnswer(e),this.removedMids.push(e),t.push("".concat(Xt.REMOVE_MLINE,"-").concat(e))}else if(o===Xt.MEDIA){const{mediaType:e,preferSoftwareCodec:s}=n;if(e===je.zu.MainVideo)Ye.updateEgressAnswerCodec(s);else if(e===je.zu.MainAudio){var i;this.updatedMlineFmtp.push(null===(i=this._wmscAudioMgr)||void 0===i?void 0:i.getUpdatedMlineFtmpFromLocalOffer())}t.push("".concat(Xt.MEDIA,"-").concat(e,"-").concat(s))}else if(o===Xt.ICE){var s;const{remoteIceCredential:i,generation_id:a}=e;this.pc.updateAnswerIceCredential(i),Ye.updateRecvMLineTemp(i),null===(s=this._wmscAudioMgr)||void 0===s||s.updateRecvMLineTemp(i),t.push("".concat(Xt.ICE,"-").concat(a))}else o===Xt.UPDATE_BITRATE&&this.ongoingUpdateBitrateTasks.push(n)}if(this.ongoingUpdateBitrateTasks.length){const{bitrate:e}=this.ongoingUpdateBitrateTasks[this.ongoingUpdateBitrateTasks.length-1];Ye.updateMinOutgoingBitrateInSDP(e),t.push("".concat(Xt.UPDATE_BITRATE,"-").concat(e))}this.onSdpAnswer(null,!0),Jt("WMSC_DORN: ".concat(t.join("|")))}catch(e){const{message:t}=e;$.globalTrace({logLevel:"error",log:"WMSC_SRNF: ".concat(t),errorEvent:e}),Jt("WMSC_SRNF: ".concat(t))}}requestSelfRenegotiation(e){this._pushToRenegotiationQueue([{type:Xt.MEDIA,mediaType:e}])}_pushToRenegotiationQueue(e){e.length&&(this.renegotiationQueue=this.renegotiationQueue.concat(e),this.pcInfo.isNegotitating||this.doRenegotiation())}_popRenegotiationQueue(){this.renegotiationQueue.splice(0,this.numOfTasks),this.renegotiationQueue.length&&!this.pcInfo.isNegotitating&&this.doRenegotiation()}_handleStreamRequest(e){var t,i;const s=[];this.lastStreamReqSeq=e.stream_request_msg_index;let a=[],n=[];if(e.delete&&e.delete.forEach((e=>{var t;const i=this.pc.getRecvTransceiverByMid(e);i&&(i.stop(),s.push({type:Xt.REMOVE_MLINE,mid:e}));const a=this.mIdMgr.getUserIdByMid(e);a&&At.resetRecvStats(a),this.mIdMgr.removeMidResource(e),null===(t=this._wmscAudioMgr)||void 0===t||t.onMlineRemoved(e)})),e.create&&e.create.forEach((e=>{let{msid:t,media_type:i,ssrcs:n,user_id:o}=e,r="";if(o&&(r=this._getUserId(o)),r&&!t&&(t=this.mIdMgr.getMactchedMSIDByUserId(r)),i===je.zu.MainVideo){const e=Ye.addRecvTransceiver();s.push({type:Xt.ADD_MLINE,transceiver:e.transceiver,mediaType:je.zu.MainVideo,msid:t,ssrcs:n,user_id:o})}else if(i===je.zu.MainAudio||i===je.zu.ShareAudio){var c;const{rtp:e}=n,a=null===(c=this._wmscAudioMgr)||void 0===c?void 0:c.addRecvTransceiver(i,null==o?void 0:o.node_id,e,t,null==o?void 0:o.is_current);s.push({transceiver:a.transceiver,type:Xt.ADD_MLINE,mediaType:i,msid:t,ssrcs:n,user_id:o})}a.push("".concat(i,"-").concat(r))})),e.associate&&e.associate.forEach((e=>{let{media_type:t,mid:i,user_id:s,ssrcs:a}=e;const{is_current:o}=s,r=this._getUserId(s);if(this.mIdMgr.attachMid(r,i,t,o),t===je.zu.MainAudio||t===je.zu.ShareAudio){var c;const{rtp:e}=a;null===(c=this._wmscAudioMgr)||void 0===c||c.onMlineAssignedNodeId(t,i,s.node_id,e,o)}n.push("".concat(t,"-").concat(i,"-").concat(r))})),e.ice_restart_resp){const{generation_id:t,ice_ufrag:i,ice_pwd:a}=e.ice_restart_resp;t===this.pcInfo.iceCredentialMsgId&&s.push({type:Xt.ICE,remoteIceCredential:{ice_ufrag:i,ice_pwd:a},generation_id:t})}this._pushToRenegotiationQueue(s),Jt("WMSC_SREQ:".concat(a.join(","),"|").concat((null===(t=e.delete)||void 0===t?void 0:t.join(","))||"","|").concat(n.join(","),"|").concat((null===(i=e.ice_restart_resp)||void 0===i?void 0:i.generation_id)||""))}_getUserId(e){const{node_id:t,is_current:i}=e;return 0==i?1|t:t}_handleSelfNegotiationSuccess(){let e=[];if(this.createdMLine.forEach((t=>{var i;let{mid:s,user_id:a,media_type:n,ssrcs:o}=t;const{rtp:r}=o;let c="";a&&(c=this._getUserId(a),this.mIdMgr.attachMid(c,s,n,a.is_current)),this.mIdMgr.ssrcMidMap.set(r,s),null==a||!a.node_id||n!==je.zu.MainAudio&&n!==je.zu.ShareAudio||null===(i=this._wmscAudioMgr)||void 0===i||i.onMlineAssignedNodeId(n,s,null==a?void 0:a.node_id,r,null==a?void 0:a.is_current),e.push("".concat(n,"-").concat(s,"-").concat(c))})),this.ongoingUpdateBitrateTasks.forEach(((e,t)=>{const{resolve:i,reject:s}=e;t===this.ongoingUpdateBitrateTasks.length-1?i():s()})),this.createdMLine.length||this.removedMids.length||this.updatedMlineFmtp.length){const t=lt(x.confId,this.createdMLine,this.removedMids,this.updatedMlineFmtp,null,null,this.lastStreamReqSeq,this.lastStreamStatusSeq);this._sendMessageToRwg({evt:ot,body:t}),Jt("WMSC_SRES:".concat(e.join(","),"|").concat(this.removedMids.join(","),"|").concat(this.updatedMlineFmtp.join(","),"|").concat(this.lastStreamReqSeq,"|").concat(this.lastStreamStatusSeq)),this.lastStreamStatusSeq++}this.createdMLine=[],this.removedMids=[],this.updatedMlineFmtp=[],this.ongoingUpdateBitrateTasks=[],Jt("WMSCNTS-".concat(this._getNegotiationTime().join("-")))}_sendRecvCodecPreference(e){if(e===je.zu.MainVideo){const t=Ye.getRecvCodecPayloads();if(t.length>0){const i=lt(x.confId,null,null,null,[{media_type:e,rtp_payload_type:t}],null,this.lastStreamReqSeq,this.lastStreamStatusSeq);this._sendMessageToRwg({evt:ot,body:i}),Jt("WMSC_SRCP:".concat(t.join(","),",").concat(this.lastStreamReqSeq,",").concat(this.lastStreamStatusSeq)),this.lastStreamStatusSeq++}}}_detectConnectionTimeout(){const{useIceServers:e,negotiationTimer:t}=this.pcInfo;t&&clearTimeout(t),this.pcInfo.isConnecting=!0,this.pcInfo.negotiationTimer=setTimeout((()=>{var e,t;this.pcInfo.isConnecting=!1,"connected"!==this.pc.connectionState?($.globalTrace({logLevel:"error",log:"WMSC Negotiation timeout: ".concat(this.pcInfo.offerMsgId,"-").concat(this._getNegotiationTime().join("-"))}),$.globalTrace({logLevel:"error",log:"WMSC_PCCT: ".concat(null===(e=x.iceServers)||void 0===e?void 0:e.length,"|").concat(this.pc.connectionState)}),Jt("WMSC_PCCT: ".concat(null===(t=x.iceServers)||void 0===t?void 0:t.length,"|").concat(this.pc.connectionState)),this._enableTURN(),this.pc.currentRemoteDescription?this.restartIce():this.restartNegotiation()):this.pcInfo.iceRestartCount=0}),e?g:m)}_enableTURN(){const{useIceServers:e}=this.pcInfo;e||($.globalTrace({logLevel:"directReport",log:"WMSC_USE_TURN"}),this.pcInfo.useIceServers=!0,this.pc.currentRemoteDescription&&this.pc.setConfiguration({iceServers:x.iceServers||[]}))}}(0,c.A)(Zt,"PC_UNKNOWN_CLOSE_CNT",0);const $t=Zt,ei=$.getTracer("Wmsc"),ti=e=>{ei.log(e),$.monitorLog("".concat(e))};class ii{constructor(e,t){return $.setTrace(),$.setTelemetry(t),At.setTelemetry(t),this.messageCallback=t,this.config=e,ti("WMSC_INIT"),!0}setTrace(e,t){$.setTrace(e,t)}updateQosSubscription(e,t){At.updateQosSubscription(e,t)}reportWMSCPeerConnectionRawStats(){At.reportRawStats()}getHasPausedVideo(){var e;return null===(e=this.wmscApiImpl)||void 0===e||null===(e=e.mIdMgr)||void 0===e?void 0:e.getHasPausedVideo()}playAllUsedVideoTag(){var e;return null===(e=this.wmscApiImpl)||void 0===e||null===(e=e.mIdMgr)||void 0===e?void 0:e.playAllUsedVideoTag()}getUserIdVideo(e){var t;return null===(t=this.wmscApiImpl)||void 0===t?void 0:t.getUserIdVideo(e)}destroy(){var e;ti("WMSC_DESTROYED"),null===(e=this.wmscApiImpl)||void 0===e||e.destroy(),this.wmscApiImpl=null}onMessage(e,t){if(e!==W.NOTIFY_SDK_JOIN_RWG_SUCCESS&&!this.wmscApiImpl)return this.sendMessage&&this.sendMessage({type:F.ERROR,data:"WMSC on MediaSDK message, MediaSDK not ready, type = "+e}),ei.error("onMessage, the caller not ready type ".concat(e)),!1;switch(e){case W.NOTIFY_SDK_JOIN_RWG_SUCCESS:return this.messageCallback?(this.wmscApiImpl=new $t(this.config,this.sendMessage.bind(this)),!0):(ei.error("onMessage, messageCallback to the caller not set"),!1);case W.NOTIFY_SDK_JOIN_RWG_FAILURE:return!0;case W.WMSC_MESSAGE_FROM_RWG:return this._onRwgMessage(t.data);case W.NOTIFY_WMSC_VIDEO_TAG_MAPPING:return this._onVideoTagMapping(t.data);case W.NOTIFY_SDK_SUBSCRIBE_VIDEO:return this._onSubscribeVideo(t.data);case W.NOTIFY_SDK_UNSUBSCRIBE_VIDEO:return this._onUnSubscribeVideo(t.data);case W.NOTIFY_SDK_ACTIVE_VIDEO_INDICATION:return this._onActiveVideoSourceChange(t.data);case W.UPDATE_WMSC_PARAMS:return this._onUpdateWmscParams(t.data);default:return this.sendMessage({type:F.ERROR,data:"WSMC receive not handled event type = "+e}),ei.error("onMessage, unknown type ".concat(e)),ti("WSMC_Rece_U_E: ".concat(e)),!1}}onMessageAsync(e,t){return ei.log("WMSC_Recv_Async_M",e,JSON.stringify(t)),ti("WMSC_Recv_Async_M: ".concat(e)),e===W.VIDEO_STREAMS?this._onVideoStreamsAsync(t.streams):(this.sendMessage({type:F.ERROR,data:"WSMC receive not handled event type =".concat(e)}),ei.error("WSMC receive not handled event type =".concat(e)),Promise.reject("Unknown message type"))}sendMessage(e){ei.log("sendMessage",JSON.stringify(e)),this.messageCallback&&this.messageCallback(e)}getWmscAudio(){return this.wmscApiImpl.getWMSCAudioMgr()}_onVideoStreamsAsync(e){return this.wmscApiImpl.onVideoStreamsAsync(e)}_onRwgMessage(e){return this.wmscApiImpl.onRwgMessage(e)}_onVideoTagMapping(e){return this.wmscApiImpl.onVideoTagMapping(e)}_onSubscribeVideo(e){return this.wmscApiImpl.subscribeVideo(e)}_onUnSubscribeVideo(e){return this.wmscApiImpl.unSubscribeVideo(e)}_onActiveVideoSourceChange(e){return this.wmscApiImpl.onActiveVideoSourceChange(e)}_onUpdateWmscParams(e){return this.wmscApiImpl.updateWmscParams(e)}}class si{constructor(){this.status="pending",this.promise=new Promise(((e,t)=>{this.reject=e=>(this.status="rejected",t(e)),this.resolve=t=>(this.status="fullfilled",e(t))})),this.then=this.promise.then,this.catch=this.promise.catch}}var ai,ni,oi,ri=i(5408),ci=i(7080),di=i(7350),li=i.n(di),hi=i(9407),ui=function(e,t,i,s){return new(i||(i=Promise))((function(a,n){function o(e){try{c(s.next(e))}catch(e){n(e)}}function r(e){try{c(s.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((s=s.apply(e,t||[])).next())}))};!function(e){e.visibilitychange="visibilitychange",e.streamCaptureSuccess="streamCaptureSuccess",e.videoTrackUnmute="videoTrackUnmute",e.addRenderVideo="addRenderVideo",e.userClick="userClick",e.fromVBModule="fromVBModule",e.reuseCaptureStream="reuseCaptureStream"}(ai||(ai={})),function(e){e.destroy="destroy"}(ni||(ni={})),function(e){e.WMSC_WSS_OPEN_FAIL_IN_30s="WMSC_WSS_OPEN_FAIL_IN_30s",e.WMSC_WSS_NOT_RECEIVE_MSG_IN_30s="WMSC_WSS_NOT_RECEIVE_MSG_IN_30s",e.WMSC_WSS_CLOSE="WMSC_WSS_CLOSE",e.WMSC_WSS_ERROR="WMSC_WSS_ERROR",e.WMSC_SDP_NEGOTIATION_FAIL="WMSC_SDP_NEGOTIATION_FAIL",e.WMSC_PC_FAIL="WMSC_PC_FAIL",e.WMSC_VIDEO_FAIL="WMSC_VIDEO_FAIL",e.WMSC_PC_CLOSED="WMSC_PC_CLOSED"}(oi||(oi={}));class mi{constructor(e){this._config={webRTCWebSocketUrl:"",confId:"",nodeId:"",hdVideoEnabled:!1,mediaStreamController:void 0,iceServers:[],videoCodecConfig:void 0,webrtcMode:0,negotiationResultHandler:null},this._websocket=null,this._wmsc=null,this._isDestroyed=!1,this._qosFlag=new Set,this.isJoinRWGSuccess=!1,this._joinRWGSuccessPromise=new si,this._initAudioSuccessPromise=new si,this._lastTimeStamp=0,this.selfVideoDomMap=new Map,this.activeSpeakerVideoDom=null,this._activeSpeakerRemoteStream=null,this._selfStream=null,this._activeSpeakerSsrc=-1,this.isMirror=!1,this._vbSettingVideoDom=null,this._notifyAudioSuccess=!1,this.meetingEnded=!1,this.captureFramerate=void 0,this._createWSS=()=>{this._onWSSOpenTimer=setTimeout((()=>{this._tryFailover(oi.WMSC_WSS_OPEN_FAIL_IN_30s)}),3e4);const{webRTCWebSocketUrl:e}=this._config;this._websocket=(0,Nt.Gj)(e),this._websocket.onopen=this._onOpen,this._websocket.onclose=this._onClose,this._websocket.onmessage=this._onMessage,this._websocket.onerror=this._onError,ci.A.add_monitor("WMSC_Create_WSS: ".concat(e,"}"))},this._onOpen=()=>{if(clearTimeout(this._onWSSOpenTimer),!this._wmsc){const{confId:e,nodeId:t,hdVideoEnabled:i,iceServers:s,videoCodecConfig:a,webrtcMode:n}=this._config,o=(0,re.j4)();if(ci.A.add_monitor("WMSC_Instance_Params: ".concat(e,"|").concat(t,"|").concat(i,"|").concat(o,"}")),!e)return;const r={confId:e,nodeId:t||"",isMacIntel:o,iceServers:s,videoSettings:Object.assign(Object.assign({},a),{maxCaptureVideoSize:3,maxRecvVideoNum:26,hdVideoEnabled:i}),webrtcMode:n};this._wmsc=new ii(r,this._wmscCallBack),this.sendMessageToWMSC({type:W.NOTIFY_SDK_JOIN_RWG_SUCCESS,data:""}),this.isJoinRWGSuccess=!0,this._joinRWGSuccessPromise.resolve()}},this._isKeepAliveMessage=e=>{let t=!0;for(let i=0;i<4;i++)if(0!==e[i]){t=!1;break}return t},this._checkReceiveTimeout=()=>{clearTimeout(this._keepAliveTimer),this._keepAliveTimer=setTimeout((()=>{Date.now(),this._tryFailover(oi.WMSC_WSS_NOT_RECEIVE_MSG_IN_30s)}),3e4)},this._replyActiveAliveMessage=e=>{(null==e?void 0:e.data)instanceof Blob&&Nt.Ay.readBlobAsBuffer(e.data).then((e=>{var t;const i=new Int8Array(e);this._isKeepAliveMessage(i)&&(null===(t=this._websocket)||void 0===t||t.send(i))})).catch((e=>{ri.Ay.error("WMSC_Read_Alive_F",e)}))},this._onMessage=e=>{if(this._websocket.isRlb||(this._checkReceiveTimeout(),this._replyActiveAliveMessage(e)),!((null==e?void 0:e.data)instanceof Blob)&&this._wmsc){if(e.data&&"string"==typeof e.data){let t;try{const{evt:i=""}=JSON.parse(e.data);t=i}catch(e){return void ri.Ay.error("WMSC_Unexpect_Wsss_Message",e)}if(t===Vt.zag){this.meetingEnded=!0;const e="WMSC_Meeting_Ended_Indicat: ".concat(Date.now());ci.A.add_monitor(e),ri.Ay.error(e)}}this.sendMessageToWMSC({type:W.WMSC_MESSAGE_FROM_RWG,data:e})}},this._onClose=e=>{1e3!==e.code?this._tryFailover(oi.WMSC_WSS_CLOSE,e.code):ci.A.add_monitor("WMSC_WSS_NORMAL_CLOSE: ".concat(e.code,"|").concat(this._isDestroyed,"|").concat(this.meetingEnded))},this._onError=e=>{this._tryFailover(oi.WMSC_WSS_ERROR)},this._tryFailover=(e,t)=>{const i=(0,Nt.Tv)();let s="".concat(i),a=!1,n=!1;switch(e){case oi.WMSC_WSS_OPEN_FAIL_IN_30s:s="WMSC_WSS_OPEN_FAIL:"+s;break;case oi.WMSC_WSS_NOT_RECEIVE_MSG_IN_30s:s="WMSC_WSS_RECV_FAIL:"+s;break;case oi.WMSC_WSS_CLOSE:s="WMSC_WSS_CLOSE: ".concat(t,"|")+s;break;case oi.WMSC_WSS_ERROR:s="WMSC_WSS_ERROR:"+s;break;case oi.WMSC_SDP_NEGOTIATION_FAIL:s="WMSC_SDP_NEGO_F:"+s,n=!0;break;case oi.WMSC_PC_FAIL:s="WMSC_PC_F:"+s,a=!!(this._config.webrtcMode&St.h),n=!!(this._config.webrtcMode&St.Q9);break;case oi.WMSC_VIDEO_FAIL:s="WMSC_VIDEO_F:"+s,n=!0;break;case oi.WMSC_PC_CLOSED:s="WMSC_PC_CLOSED:"+s;break;default:s="WMSC_FAILOVER_UNEXPECT:"+s}this._isDestroyed||this.meetingEnded||(this.destroy(),ci.A.add_monitor(s),ri.Ay.error(s),Bt.A.Notify_APPUI(Vt.oQY,{audio:a?St.nm:0,video:n?1:0}))},this._disconnect=e=>{var t;const i="WMSC_WSS_Dissconn: ".concat(e,"|").concat(null===(t=null==this?void 0:this._websocket)||void 0===t?void 0:t.readyState);ci.A.add_monitor(i),ri.Ay.log(i),!this._websocket||this._websocket.readyState!==WebSocket.CONNECTING&&this._websocket.readyState!==WebSocket.OPEN||this._websocket.close()},this.sendMessageToWMSC=e=>{var t;(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.data)instanceof Blob||this._wmsc&&this._wmsc.onMessage(e.type,e)},this.sendMessageToWMSCAsync=e=>{var t,i;if(!this._wmsc)return Promise.reject("this._wmsc is undefined");const{type:s}=e;if(s===W.VIDEO_STREAMS){const{streams:s=[]}=e;return(null===(i=null===(t=s[0])||void 0===t?void 0:t.stream)||void 0===i?void 0:i.id)&&(this.streamId=s[0].stream.id),0===s.length?this._selfStream=null:this._selfStream=s[0].stream,this._updateActiveSpeakerStream(),this._wmsc.onMessageAsync(e.type,e)}return Promise.reject("Not found event type ".concat(e.type))},this._wmscCallBack=e=>{var t,i,s,a,n,o,r,c,d,l;if(!e)return;const{type:h,data:u}=e;switch(h){case F.WMSC_MESSAGE_TO_RWG_BY_SDK:this.sendMesssageToRWG(u);break;case F.WMSC_MAPPING_STREAMID_AND_MID:const e=JSON.parse(u);if(!(null===(t=null==e?void 0:e.body)||void 0===t?void 0:t.length))return;const h=[],m=[];e.body.forEach((e=>{e.videoSize>=0?h.push({id:e.userID,size:e.videoSize,bOn:!1}):m.push({id:e.userID})})),h.length?(ci.A.add_monitor("WMSC_Sub_List: ".concat((0,Nt.iD)(JSON.stringify(h)))),e.body.forEach((t=>{Bt.A.sendMessageToRwg(Vt.yJV,{evt:e.evt,body:t})})),Bt.A.sendMessageToRwg(Vt.yJV,{evt:Vt.xQc,body:{subInfoList:h}})):m.length&&(ci.A.add_monitor("WMSC_Unsub_List: ".concat((0,Nt.iD)(JSON.stringify(m)))),Bt.A.sendMessageToRwg(Vt.yJV,{evt:Vt.WCu,body:{subIDList:m}}),e.body.forEach((t=>{Bt.A.sendMessageToRwg(Vt.yJV,{evt:e.evt,body:t})})));break;case F.SDP_NEGOTIATION_FAIL:null===(s=(i=this._config).negotiationResultHandler)||void 0===s||s.call(i,!1),this._tryFailover(oi.WMSC_SDP_NEGOTIATION_FAIL);break;case F.PC_FAIL:null===(n=(a=this._config).negotiationResultHandler)||void 0===n||n.call(a,!1),this._tryFailover(oi.WMSC_PC_FAIL);break;case F.VIDEO_FAIL:null===(r=(o=this._config).negotiationResultHandler)||void 0===r||r.call(o,!1),this._tryFailover(oi.WMSC_VIDEO_FAIL);break;case F.PC_CLOSED:this._tryFailover(oi.WMSC_PC_CLOSED);break;case F.GLOBAL_TRACE:{const{logLevel:e,log:t,errorEvent:i,tags:s}=u;ri.Ay[e](t,i||s);break}case F.MONITOR:ci.A.add_monitor(u);break;case F.DIRECT_MONITOR:ci.A.send_monitor_directly(u);break;case F.VIDEO_QOS_DATA:Bt.A.Notify_APPUI(Vt.PgM,u);break;case F.NETWORK_QUALITY_CHANGE:Bt.A.Notify_APPUI(Vt.Ah8,u);break;case F.UPDATE_VIDEO_CAPTURE_CONSTRAINTS:if(!(null===(c=this._config.mediaStreamController)||void 0===c?void 0:c.isUsingFileInputVideoSource())){const{width:e,height:t,frameRate:i}=u;this._updateVideoConstraints(e,t,i)}break;case F.VIDEO_CAPABILITIES_CHANGE:this._websocket.send(JSON.stringify({evt:Vt.I6S,body:{fullHDOption:u.maxRecvVideoSize>=4?1:0}}));break;case F.PC_CONNECTED:null===(l=(d=this._config).negotiationResultHandler)||void 0===l||l.call(d,!0),this._config.webrtcMode&St.h&&(this._initAudioSuccessPromise.resolve(),Bt.A.Notify_APPUI(Vt.LYk,{mediaType:"audio"})),this._config.webrtcMode&St.Q9&&Bt.A.Notify_APPUI(Vt.LYk,{mediaType:"video"});break;case F.UPDATE_VIDEO_SUBSCRIPTION:Bt.A.sendMessageToRwg(Vt.yJV,{evt:Vt.xQc,body:{subInfoList:u}});break;case F.UPDATE_VIDEO_UNSUBSCRIPTION:Bt.A.sendMessageToRwg(Vt.yJV,{evt:Vt.WCu,body:{subIDList:u}});break;case F.ERROR_MESSAGE:this.handleWMSCErrorMsg(u)}},this.waitJoinRWGSuccess=()=>this._joinRWGSuccessPromise.promise,this.waitInitAudioSuccess=()=>this._initAudioSuccessPromise.promise,this.getConnectionId=()=>this._config.confId,this.updateQosSubscription=(e,t,i)=>{var s,a;e?(this._qosFlag.add(t),null===(s=this._wmsc)||void 0===s||s.updateQosSubscription(e,i)):(this._qosFlag.delete(t),0===this._qosFlag.size&&(null===(a=this._wmsc)||void 0===a||a.updateQosSubscription(e,i)))},this.playAllVideoTag=e=>{var t;if(this.selfVideoDomMap.forEach((t=>{t.paused&&this.playSelfVideo(e,t)})),null===(t=null==this?void 0:this._wmsc)||void 0===t?void 0:t.playAllUsedVideoTag){if(!this._wmsc.getHasPausedVideo())return;this._wmsc.playAllUsedVideoTag().then((()=>{})).catch((t=>{const i="WMSC_RV_P_F: ".concat(e,"|").concat(t);ci.A.add_monitor(i),ri.Ay.error(i)}))}},this.playSelfVideo=(e,t)=>{var i;let s="";"visible"!==document.visibilityState&&(s="WMSC_SV_V_F: ".concat(document.visibilityState,"-").concat(e)),t||(s="WMSC_SV_DOM_F: ".concat(e)),t.srcObject||(s="WMSC_SV_SRC_F: ".concat(e));const a=null===(i=null==t?void 0:t.srcObject)||void 0===i?void 0:i.getVideoTracks();if(Array.isArray(a)&&a[0]&&a[0].muted&&(s="WMSC_SV_TM_F: ".concat(document.visibilityState,"-").concat(e)),t.paused||(s="WMSC_SV_P_F: ".concat(e)),s)return ci.A.add_monitor(s),void ri.Ay.error(s);t.readyState>t.HAVE_CURRENT_DATA||t.play().then((()=>{ci.A.add_monitor("WMSC_SV_SUCCESS: ".concat(e))})).catch((t=>{s="WMSC_SV_P_E: ".concat(e,"|").concat(t.name,":").concat(t.message),ci.A.add_monitor(s),ri.Ay.error(s,t)}))},this.setNodeId=e=>{this._config.nodeId!==e&&(this._config.nodeId=e,this.sendMessageToWMSC({type:W.UPDATE_WMSC_PARAMS,data:{nodeId:e}}))},this.getUserIdVideo=e=>{var t;return 1==e?[this.activeSpeakerVideoDom]:this.isSelfVideo(e)?[Array.from(this.selfVideoDomMap.values()).find((e=>!e.paused))]:null===(t=this._wmsc)||void 0===t?void 0:t.getUserIdVideo(e)},this.mirrorVideoEle=(e,t)=>{const i="rotateY(".concat(t?180:0,"deg)");let s=e.style.transform;-1!==s.indexOf("rotateY")?s=s.replace(/rotateY\([0-9]+(deg)?\)/,i):s+=" ".concat(i),e.style.transform=s},this.mirrorSelfVideo=e=>{if(this.isMirror=e,this.selfVideoDomMap.size>0&&this.selfVideoDomMap.forEach((e=>{this.mirrorVideoEle(e,this.isMirror)})),this.activeSpeakerVideoDom&&this._activeSpeakerRemoteStream&&this.mirrorVideoEle(this.activeSpeakerVideoDom,this.isMirror),this.vbSettingVideoDom&&this.mirrorVideoEle(this.vbSettingVideoDom,this.isMirror),this.selfVideoDomMap.size<=0&&!this.activeSpeakerVideoDom&&!this.vbSettingVideoDom){const t="WMSC_MIRROR_F:".concat(e);ci.A.add_monitor(t),ri.Ay.error(t)}},this.sendStreamToWMSC=(e,t,i,s)=>ui(this,void 0,void 0,(function*(){var a,n;const{mediaStreamController:o}=this._config,r=null===(n=null===(a=null==o?void 0:o.videoStream)||void 0===a?void 0:a.getVideoTracks()[0])||void 0===n?void 0:n.getSettings(),c=(null==r?void 0:r.width)||640,d=(null==r?void 0:r.height)||360;ci.A.add_monitor("WMSC_Update_V_Constraints_S: ".concat(s,"|").concat(e,"|").concat(t,"|").concat(i,"|").concat(c,"|").concat(d));const l=[{stream:o.getVideoStream(),width:c,height:d}];o.isVideoStreamProcessed()&&l.push({stream:o.videoStream}),yield this.sendMessageToWMSCAsync({type:W.VIDEO_STREAMS,streams:l})})),this.onActiveSpeakerChange=e=>{this.sendMessageToWMSC({type:W.NOTIFY_SDK_ACTIVE_VIDEO_INDICATION,data:{userId:e}}),this._activeSpeakerSsrc=e,this._updateActiveSpeakerStream()},this._updateActiveSpeakerStream=()=>{if(this.activeSpeakerVideoDom){const{nodeId:e}=this._config;(0,Nt.XF)(this._activeSpeakerSsrc)===(0,Nt.XF)(e)?this._selfStream&&(this._activeSpeakerRemoteStream||(this._activeSpeakerRemoteStream=this.activeSpeakerVideoDom.srcObject),this.activeSpeakerVideoDom.srcObject=this._selfStream,this.isMirror&&this.mirrorVideoEle(this.activeSpeakerVideoDom,this.isMirror)):this._activeSpeakerRemoteStream&&(this.activeSpeakerVideoDom.srcObject=this._activeSpeakerRemoteStream,this._activeSpeakerRemoteStream=null,this.isMirror&&this.mirrorVideoEle(this.activeSpeakerVideoDom,!1))}},this.isSelfVideo=e=>{const{nodeId:t}=this._config;return(0,Nt.XF)(e)===(0,Nt.XF)(t)},this.handleWMSCErrorMsg=e=>{const{type:t}=e;switch(t){case"WEBRTC_VIDEO_HEALTH_CHECK_FAILED":(0,zt.iK)(Vt.bes,hi.Qt);break;case"PC_RECONNECT":(0,zt.iK)(Vt.ZSj,e)}},this.destroy=()=>{var e;clearTimeout(this._onWSSOpenTimer),clearTimeout(this._keepAliveTimer),this._cleanUserEventListener&&this._cleanUserEventListener(),this.selfVideoDomMap.clear(),null===(e=this._wmsc)||void 0===e||e.destroy(),this.isJoinRWGSuccess=!1,this._isDestroyed=!0,this._disconnect(ni.destroy)},this._isDestroyed=!1,this._config=Object.assign(this._config,e),this._createWSS(),this._throttlePlayAllVideoTag=li()(this.playAllVideoTag,500),this._cleanUserEventListener=(0,Nt.zV)((()=>this._throttlePlayAllVideoTag(ai.userClick))),document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState&&this._throttlePlayAllVideoTag(ai.visibilitychange)}))}sendMesssageToRWG(e){var t;this._websocket&&this._websocket.readyState===WebSocket.OPEN?"object"==typeof e?this._websocket.send(JSON.stringify(e)):this._websocket.send(e):ri.Ay.error("WMSC_Wsss_Message_Status_Error: ".concat(null===(t=this._websocket)||void 0===t?void 0:t.readyState,", msg: ").concat(e))}reportWMSCPeerConnectionRawStats(){var e;null===(e=this._wmsc)||void 0===e||e.reportWMSCPeerConnectionRawStats()}_updateVideoConstraints(e,t,i){return ui(this,void 0,void 0,(function*(){const{mediaStreamController:s}=this._config;i=this.captureFramerate&&this.captureFramerate>=St.UW&&this.captureFramerate<=St.O8?this.captureFramerate:St.O8,s&&!this._isDestroyed&&e&&t&&i?(yield this.sendMessageToWMSCAsync({type:W.VIDEO_STREAMS,streams:[]}),s.changeVideoResolution(e,t,i,!0).then((()=>{this.sendStreamToWMSC(e,t,i,!0)})).catch((s=>{this.sendStreamToWMSC(e,t,i,!1),ci.A.add_monitor("WMSC_Update_V_Constraints_E: ".concat(e,"|").concat(t,"|").concat(i,",").concat(null==s?void 0:s.name,":").concat(null==s?void 0:s.message)),ri.Ay.error("WMSC_Update_V_Constraints_E",s)}))):ci.A.add_monitor("WMSC_Update_V_Constraints_F: ".concat(!!s,"|").concat(this._isDestroyed,"|").concat(e,"|").concat(t,"|").concat(i))}))}set vbSettingVideoDom(e){this._vbSettingVideoDom=e,this._vbSettingVideoDom&&(this._vbSettingVideoDom.setAttribute("autoplay","true"),this._vbSettingVideoDom.setAttribute("playsinline","true"),this._vbSettingVideoDom.muted=!0,this.isMirror&&this.mirrorVideoEle(this._vbSettingVideoDom,this.isMirror),this._selfStream&&(this._vbSettingVideoDom.srcObject=this._selfStream))}get vbSettingVideoDom(){return this._vbSettingVideoDom}getWMSCAudio(){var e;return null===(e=this._wmsc)||void 0===e?void 0:e.getWmscAudio()}isDestroyed(){return this._isDestroyed}}},7007:e=>{"use strict";var t,i="object"==typeof Reflect?Reflect:null,s=i&&"function"==typeof i.apply?i.apply:function(e,t,i){return Function.prototype.apply.call(e,t,i)};t=i&&"function"==typeof i.ownKeys?i.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var a=Number.isNaN||function(e){return e!=e};function n(){n.init.call(this)}e.exports=n,e.exports.once=function(e,t){return new Promise((function(i,s){function a(i){e.removeListener(t,n),s(i)}function n(){"function"==typeof e.removeListener&&e.removeListener("error",a),i([].slice.call(arguments))}g(e,t,n,{once:!0}),"error"!==t&&function(e,t){"function"==typeof e.on&&g(e,"error",t,{once:!0})}(e,a)}))},n.EventEmitter=n,n.prototype._events=void 0,n.prototype._eventsCount=0,n.prototype._maxListeners=void 0;var o=10;function r(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function c(e){return void 0===e._maxListeners?n.defaultMaxListeners:e._maxListeners}function d(e,t,i,s){var a,n,o,d;if(r(i),void 0===(n=e._events)?(n=e._events=Object.create(null),e._eventsCount=0):(void 0!==n.newListener&&(e.emit("newListener",t,i.listener?i.listener:i),n=e._events),o=n[t]),void 0===o)o=n[t]=i,++e._eventsCount;else if("function"==typeof o?o=n[t]=s?[i,o]:[o,i]:s?o.unshift(i):o.push(i),(a=c(e))>0&&o.length>a&&!o.warned){o.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=e,l.type=t,l.count=o.length,d=l,console&&console.warn&&console.warn(d)}return e}function l(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function h(e,t,i){var s={fired:!1,wrapFn:void 0,target:e,type:t,listener:i},a=l.bind(s);return a.listener=i,s.wrapFn=a,a}function u(e,t,i){var s=e._events;if(void 0===s)return[];var a=s[t];return void 0===a?[]:"function"==typeof a?i?[a.listener||a]:[a]:i?function(e){for(var t=new Array(e.length),i=0;i<t.length;++i)t[i]=e[i].listener||e[i];return t}(a):p(a,a.length)}function m(e){var t=this._events;if(void 0!==t){var i=t[e];if("function"==typeof i)return 1;if(void 0!==i)return i.length}return 0}function p(e,t){for(var i=new Array(t),s=0;s<t;++s)i[s]=e[s];return i}function g(e,t,i,s){if("function"==typeof e.on)s.once?e.once(t,i):e.on(t,i);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function a(n){s.once&&e.removeEventListener(t,a),i(n)}))}}Object.defineProperty(n,"defaultMaxListeners",{enumerable:!0,get:function(){return o},set:function(e){if("number"!=typeof e||e<0||a(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");o=e}}),n.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},n.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||a(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},n.prototype.getMaxListeners=function(){return c(this)},n.prototype.emit=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var a="error"===e,n=this._events;if(void 0!==n)a=a&&void 0===n.error;else if(!a)return!1;if(a){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var r=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw r.context=o,r}var c=n[e];if(void 0===c)return!1;if("function"==typeof c)s(c,this,t);else{var d=c.length,l=p(c,d);for(i=0;i<d;++i)s(l[i],this,t)}return!0},n.prototype.addListener=function(e,t){return d(this,e,t,!1)},n.prototype.on=n.prototype.addListener,n.prototype.prependListener=function(e,t){return d(this,e,t,!0)},n.prototype.once=function(e,t){return r(t),this.on(e,h(this,e,t)),this},n.prototype.prependOnceListener=function(e,t){return r(t),this.prependListener(e,h(this,e,t)),this},n.prototype.removeListener=function(e,t){var i,s,a,n,o;if(r(t),void 0===(s=this._events))return this;if(void 0===(i=s[e]))return this;if(i===t||i.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete s[e],s.removeListener&&this.emit("removeListener",e,i.listener||t));else if("function"!=typeof i){for(a=-1,n=i.length-1;n>=0;n--)if(i[n]===t||i[n].listener===t){o=i[n].listener,a=n;break}if(a<0)return this;0===a?i.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(i,a),1===i.length&&(s[e]=i[0]),void 0!==s.removeListener&&this.emit("removeListener",e,o||t)}return this},n.prototype.off=n.prototype.removeListener,n.prototype.removeAllListeners=function(e){var t,i,s;if(void 0===(i=this._events))return this;if(void 0===i.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==i[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete i[e]),this;if(0===arguments.length){var a,n=Object.keys(i);for(s=0;s<n.length;++s)"removeListener"!==(a=n[s])&&this.removeAllListeners(a);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=i[e]))this.removeListener(e,t);else if(void 0!==t)for(s=t.length-1;s>=0;s--)this.removeListener(e,t[s]);return this},n.prototype.listeners=function(e){return u(this,e,!0)},n.prototype.rawListeners=function(e){return u(this,e,!1)},n.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):m.call(e,t)},n.prototype.listenerCount=m,n.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]}},8048:(e,t,i)=>{e.exports=i(6083)},3148:(e,t,i)=>{"use strict";var s=i(8280),a=i(1310),n=String.prototype;e.exports=function(e){var t=e.trimStart;return"string"==typeof e||e===n||s(n,e)&&t===n.trimStart?a:t}},1310:(e,t,i)=>{"use strict";i(1454);var s=i(1747);e.exports=s("String","trimLeft")},9419:(e,t,i)=>{"use strict";var s=i(5993).start,a=i(5819);e.exports=a("trimStart")?function(){return s(this)}:"".trimStart},9793:(e,t,i)=>{"use strict";var s=i(1091),a=i(9419);s({target:"String",proto:!0,name:"trimStart",forced:"".trimLeft!==a},{trimLeft:a})},1454:(e,t,i)=>{"use strict";i(9793);var s=i(1091),a=i(9419);s({target:"String",proto:!0,name:"trimStart",forced:"".trimStart!==a},{trimStart:a})},6083:(e,t,i)=>{"use strict";var s=i(3148);e.exports=s}}]);
//# sourceMappingURL=https://d1cdksi819e9z7.cloudfront.net/sourcemap/wmsc.min.js-031f9585df620a579779.map