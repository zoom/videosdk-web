(window.webpackJsonpWebSipClient=window.webpackJsonpWebSipClient||[]).push([[2],{77:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=class{constructor(){this.status="pending",this.promise=new Promise((e,t)=>{this.reject=e=>(this.status="rejected",t(e)),this.resolve=t=>(this.status="fullfilled",e(t))}),this.then=this.promise.then,this.catch=this.promise.catch}}},78:function(e,t,i){"use strict";i.r(t);var s=i(21),o=i(2),n=i(4),r={AEWF:"Audio encode WASM failed to download/compile",ADWF:"Audio decode WASM failed to download/compile",VDWF:"Video decode WASM failed to download/compile",VEWF:"Video encode WASM failed to download/compile",SEWF:"Sharing encode WASM failed to download/compile",SDWF:"Sharing decode WASM failed to download/compile",MWCGLF:"WebGL context failed to be restored",VCFF:"Captured video format is not supported",SHHF:"Initialization of sharing decode WASM failed",SDSF:"Sharing decode WebSocket failed to connect after 10 attempts",SEHF:"Initialization of sharing encode WASM failed",SESF:"Sharing encode WebSocket failed to connect after 10 attempts",ADHF:"Initialization of audio decode WASM failed",ADSF:"Audio decode WebSocket failed to connect after 10 attempts",AEHF:"Initialization of audio encode WASM failed",AESF:"Audio encode WebSocket failed to connect after 10 attempts",VDHF:"Initialization of video decode WASM failed",VDSF:"Video decode WebSocket failed to connect after 10 attempts",VEHF:"Initialization of video encode WASM failed",VESF:"Video encode WebSocket failed to connect after 10 attempts",INITVDCERR:"An error occurred when initializing video WebRTC DataChannel",INITADCERR:"An error occurred when initializing audio WebRTC DataChannel"},a=function(){function e(){this.base_time=null,this.monitor="",this.last_get_monitor_time=0,this.checkIsNecessaryLogMap=new Map,this.highfrequencyerror=new Map}return e.prototype={init:function(){this.base_time||(this.base_time=(new Date).getTime(),this.checkIsNecessaryLogMap=new Map,this.add_monitor("STARTMONITOR"+this.base_time))},add_monitor:function(e,t){if(this.base_time||this.init(),e)try{if(r[e]){var i=r[e];t&&(i="".concat(i,". Additional information: ").concat(t)),n.default.error(i)}var s=!1;"F"!=e[e.length-1]&&"f"!=e[e.length-1]||(s=!0);var o=(new Date).getTime()-this.base_time;this.monitor?this.monitor=this.monitor+e+"("+Math.ceil(o)+")":this.monitor=e+"("+Math.ceil(o)+")",this.monitor.length>2e3&&(s=!0),s&&this.send_instant_monitor()}catch(e){n.default.error("Error when adding data to the monitor log",e)}},get_monitor:function(){var e=this.monitor,t=(new Date).getTime();return null!=e&&(e.length>80||t-this.last_get_monitor_time>180)?(this.last_get_monitor_time=t,this.monitor=null,"WCL_M, "+e):""},get_instant_monitor:function(){var e=this.monitor;return this.monitor=null,"WCL_M, "+e},send_instant_monitor:function(){var e=this.get_instant_monitor();e&&o.default.sendMessageToRwg(s.MONITOR_LOG,{evt:s.RWG_MONITOR_LOG_EVENT,seq:1,body:{data:e}})},add_monitor2:function(e){if(this.base_time||this.init(),e){var t=(new Date).getTime()-this.base_time;this.monitor?this.monitor=this.monitor+e+"("+t+")":this.monitor=e+"("+t+")"}},add_monitor3:function(e){(this.base_time||this.init(),e)&&(this.highfrequencyerror[e]?this.highfrequencyerror[e]+=1:this.highfrequencyerror[e]=1,Object(n.isPowerOf2)(this.highfrequencyerror[e])&&this.add_monitor(e,"Occurred ".concat(this.highfrequencyerror[e]," times")))},checkIsNecessaryExceptionLogAndReturnRepeatTimes:function(e){var t=this,i=!0,s=0;try{return this.checkIsNecessaryLogMap.get(e)&&this.checkIsNecessaryLogMap.get(e)%100!=0&&(i=!1),{isNecessary:i,repeatNumber:void 0===(s=this.checkIsNecessaryLogMap.get(e))?0:s}}catch(e){return{isNecessary:!0,repeatNumber:0}}finally{var o=this.checkIsNecessaryLogMap.get(e)||0;if(this.checkIsNecessaryLogMap.set(e,o+1),this.checkIsNecessaryLogMap.size>200){var n=Array.from(this.checkIsNecessaryLogMap.keys()).slice(0,20);console.log("delete log cache keys",n),n.forEach((function(e){return t.checkIsNecessaryLogMap.delete(e)}))}}},reset:function(){this.base_time=null,this.last_get_monitor_time=0,this.monitor="",this.highfrequencyerror.clear()}},new e}();t.default=a},90:function(e,t,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var o=Object.getOwnPropertyDescriptor(t,i);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,o)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return o(t,e),t},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.WMSCManager=t.eventExt=void 0;const a=i(76);Object.defineProperty(t,"eventExt",{enumerable:!0,get:function(){return a.eventExt}});const c=r(i(77)),d=r(i(2)),l=i(21),h=r(i(4)),u=r(i(78)),_=n(i(19)),f=r(i(79));var m;!function(e){e.visibilitychange="visibilitychange",e.streamCaptureSuccess="streamCaptureSuccess",e.videoTrackUnmute="videoTrackUnmute",e.addRenderVideo="addRenderVideo",e.userClick="userClick"}(m||(m={}));t.WMSCManager=class{constructor(e){this._config={webRTCWebSocketUrl:"",confId:"",nodeId:"",useSimulcast:!0,HDVideo:!1},this._websocket=null,this._wmsc=null,this._isDestroyed=!1,this._qosFlag=new Set,this.isJoinRWGSuccess=!1,this._joinRWGSuccessPromise=new c.default,this._lastTimeStamp=0,this.selfVideoDom=null,this._createWSS=()=>{this._onWSSOpenTimer=setTimeout(()=>{this.sendMonitorLog("webrtc wss not open in 30s, should failover"),this._tryFailover(l.NOTIFY_UI_WMSC_WSS_DISCONNECTED)},3e4);const{webRTCWebSocketUrl:e}=this._config;this._websocket=new WebSocket(e),this._websocket.onopen=this._onOpen,this._websocket.onclose=this._onClose,this._websocket.onmessage=this._onMessage,this._websocket.onerror=this._onError,this.sendMonitorLog("Create WSS to: "+e)},this._onOpen=e=>{if(clearTimeout(this._onWSSOpenTimer),!this._wmsc){const{confId:e,nodeId:t,HDVideo:i,useSimulcast:s}=this._config;if(!e||!t)return;const o={maxCaptureResolution:3,maxVideoReceiveNum:25,confId:e,nodeId:t,HDVideo:i,simulcastEnabled:s};this._wmsc=new a.Wmsc(o,this._wmscCallBack),this.sendMonitorLog("Create WMSC instance with: "+JSON.stringify(o))}},this._isKeepAliveMessage=e=>{let t=!0;for(let i=0;i<4;i++)if(0!==e[i]){t=!1;break}return t},this._checkReceiveTimeout=()=>{clearTimeout(this._keepAliveTimer),this._keepAliveTimer=setTimeout(()=>{const e=Date.now();this.sendMonitorLog(`webrtc wss not receive message in 30s, should failover, last timestamp: ${this._lastTimeStamp}, current timestamp: ${e}`),this._tryFailover(l.NOTIFY_UI_WMSC_WSS_DISCONNECTED)},3e4)},this._replyActiveAliveMessage=e=>{(null==e?void 0:e.data)instanceof Blob&&_.default.readBlobAsBuffer(e.data).then(e=>{var t;const i=new Int8Array(e);this._isKeepAliveMessage(i)&&(null===(t=this._websocket)||void 0===t||t.send(i))}).catch(e=>{console.log("error: ",e)})},this._onMessage=e=>{if(this._lastTimeStamp=Date.now(),this._checkReceiveTimeout(),this._replyActiveAliveMessage(e),!((null==e?void 0:e.data)instanceof Blob)&&this._wmsc){if(e.data){const{evt:t}=JSON.parse(e.data);if(0===t)return this.sendMessageToWMSC({type:a.eventExt.NOTIFY_SDK_JOIN_RWG_SUCCESS,data:""}),this.isJoinRWGSuccess=!0,this._joinRWGSuccessPromise.resolve()}this.sendMessageToWMSC({type:a.eventExt.WMSC_MESSAGE_FROM_RWG,data:e})}},this._onClose=e=>{1e3!==e.code&&h.default.error("WMSC WSS close",e),this.sendMonitorLog("webrtc WSS onClose, expected: "+this._isDestroyed),this._tryFailover(l.NOTIFY_UI_WMSC_WSS_DISCONNECTED)},this._onError=e=>{h.default.error("WMSC WSS error",e),this.sendMonitorLog("webrtc WSS onError, destroyed: "+this._isDestroyed),this._tryFailover(l.NOTIFY_UI_WMSC_WSS_DISCONNECTED)},this._tryFailover=e=>{this._isDestroyed||d.default.Notify_APPUI&&(this.destroy(),d.default.Notify_APPUI(e))},this._disconnect=()=>{this._websocket&&(this._websocket.readyState!==WebSocket.CONNECTING&&this._websocket.readyState!==WebSocket.OPEN||(this._websocket.close(),this.sendMonitorLog("Close WSS")))},this.sendMessageToWMSC=e=>{var t;(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.data)instanceof Blob||this._wmsc&&this._wmsc.onMessage(e.type,e)},this.sendMessageToWMSCAsync=e=>{if(!this._wmsc)return Promise.reject("this._wmsc is undefined");const{type:t}=e;switch(t){case a.eventExt.VIDEO_STREAMS:return this._wmsc.onMessageAsync(e.type,e);default:return Promise.reject("Not found event type "+e.type)}},this._wmscCallBack=e=>{var t;if(!e)return;const{type:i,data:s}=e;switch(i){case a.eventOut.WMSC_MESSAGE_TO_RWG_BY_SDK:this.sendMesssageToRWG(s);break;case a.eventOut.WMSC_MAPPING_STREAMID_AND_MID:const e=JSON.parse(s);if(!(null==e?void 0:e.body))return;d.default.sendMessageToRwg(l.SEND_MESSAGE_TO_RWG,e),0!==e.body.userID&&"videoSize"in e.body&&d.default.sendMessageToRwg(l.SEND_MESSAGE_TO_RWG,{evt:l.WS_VIDEO_MULTI_SUBSCRIBE_REQ,body:{subInfoList:[{id:e.body.userID,size:e.body.videoSize,bOn:!1}]}});break;case a.eventOut.SDP_NEGOTIATION_FAIL:(null===(t=this._websocket)||void 0===t?void 0:t.readyState)===WebSocket.OPEN&&(this.sendMonitorLog("webrtc sdp negotiation fail, should failover"),this._tryFailover(l.NOTIFY_UI_WMSC_FAILOVER));break;case a.eventOut.GLOBAL_TRACE:{const{logLevel:e,log:t,errorEvent:i}=s;h.default[e](t,i);break}case a.eventOut.MONITOR:this.sendMonitorLog(s,!0);break;case a.eventOut.ADD_MONITOR:u.default.add_monitor(s);break;case a.eventOut.VIDEO_QOS_DATA:d.default.Notify_APPUI(l.VIDEO_QOS_DATA,s)}},this.waitJoinRWGSuccess=()=>this._joinRWGSuccessPromise.promise,this.updateQosSubscription=(e,t,i)=>{var s,o;e?(this._qosFlag.add(t),null===(s=this._wmsc)||void 0===s||s.updateQosSubscription(e,i)):(this._qosFlag.delete(t),0===this._qosFlag.size&&(null===(o=this._wmsc)||void 0===o||o.updateQosSubscription(e,i)))},this.sendMonitorLog=(e,t=!1)=>{if(!e)return;let i=t?e:"WCL_WMSC_EVENT, "+e;d.default.sendMessageToRwg(l.MONITOR_LOG,{evt:l.RWG_MONITOR_LOG_EVENT,seq:1,body:{data:i}})},this.playAllVideoTag=e=>{var t,i;if((null===(t=null==this?void 0:this.selfVideoDom)||void 0===t?void 0:t.paused)&&this.playSelfVideo(e),null===(i=null==this?void 0:this._wmsc)||void 0===i?void 0:i.playAllUsedVideoTag){if(!this._wmsc.getHasPausedVideo())return;this._wmsc.playAllUsedVideoTag().then(()=>{}).catch(t=>{this.sendMonitorLog(`some receive video tag play faile, source: ${e}, useId: ${t}`)})}},this.playSelfVideo=e=>{var t,i;if("visible"!==document.visibilityState)return void this.sendMonitorLog(`play self video, but visibilityState: ${document.visibilityState}, source: ${e}`);if(!this.selfVideoDom)return void this.sendMonitorLog("play self video, but video tag not exist, source: "+e);if(!this.selfVideoDom.paused)return void this.sendMonitorLog("play self video, but video tag not paused, source: "+e);if(!this.selfVideoDom.srcObject)return void this.sendMonitorLog("play self video, but video tag not contain srcObject, source: "+e);const s=null===(i=null===(t=this.selfVideoDom)||void 0===t?void 0:t.srcObject)||void 0===i?void 0:i.getVideoTracks();Array.isArray(s)&&s[0]&&s[0].muted?this.sendMonitorLog("play self video, but video track muted, source: "+e):this.selfVideoDom.play().then(()=>{this.sendMonitorLog("play self video success, source: "+e)}).catch(e=>{this.sendMonitorLog(`play self video failed, error name: ${e.name}, error message: ${e.message}`)})},this.mirrorSelfVideo=e=>{if(this.selfVideoDom){const t=`rotateY(${e?180:0}deg)`;let i=this.selfVideoDom.style.transform;-1!==i.indexOf("rotateY")?i=i.replace(/rotateY\([0-9]+(deg)?\)/,t):i+=" "+t,this.selfVideoDom.style.transform=i}else this.sendMonitorLog("try mirror self video, but not selfVideoDom, isMirror:"+e)},this.destroy=()=>{var e;clearTimeout(this._onWSSOpenTimer),clearTimeout(this._keepAliveTimer),this._cleanUserEventListener&&this._cleanUserEventListener(),this.selfVideoDom=null,this.isJoinRWGSuccess=!1,this._isDestroyed=!0,this._disconnect(),this._wmsc&&(null===(e=this._wmsc)||void 0===e||e.destroy())},this._isDestroyed=!1,this._config=Object.assign(this._config,e),this._createWSS(),this._throttlePlayAllVideoTag=(0,f.default)(this.playAllVideoTag,500),this._cleanUserEventListener=(0,_.addUserEventListener)(()=>this._throttlePlayAllVideoTag(m.userClick)),document.addEventListener("visibilitychange",()=>{"visible"===document.visibilityState&&this._throttlePlayAllVideoTag(m.visibilitychange)})}sendMesssageToRWG(e){this._websocket&&this._websocket.readyState===WebSocket.OPEN&&("object"==typeof e?this._websocket.send(JSON.stringify(e)):this._websocket.send(e))}}}}]);