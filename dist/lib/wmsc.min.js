(self.webpackChunkJsMediaSDK_Instance=self.webpackChunkJsMediaSDK_Instance||[]).push([[557],{8920:(e,t,i)=>{"use strict";i.r(t),i.d(t,{WMSCManager:()=>Vt,eventExt:()=>U});var s={};i.r(s),i.d(s,{TO:()=>R,u7:()=>b,GA:()=>y,Qx:()=>_,pO:()=>g,Rz:()=>w,r3:()=>L,By:()=>D,ey:()=>I,rF:()=>T,wK:()=>S,LA:()=>N,tT:()=>P,ul:()=>d,j$:()=>m,Y7:()=>p,RJ:()=>c,bl:()=>C,Dz:()=>A,c$:()=>O,lN:()=>E,zk:()=>V,nd:()=>n,ue:()=>B,V$:()=>v,pg:()=>f,gj:()=>o,S$:()=>M,tP:()=>a});var a,r,n,o,c,d,h=i(7857),l=i(129),u=i.n(l);!function(e){e[e.ERROR=0]="ERROR",e[e.WARN=1]="WARN",e[e.INFO=2]="INFO",e[e.DEBUG=3]="DEBUG",e[e.VERBOSE=4]="VERBOSE"}(a||(a={})),function(e){e[e._90P=0]="_90P",e[e._180P=1]="_180P",e[e._360P=2]="_360P",e[e._720P=3]="_720P",e[e._1080P=4]="_1080P",e[e._2160P=5]="_2160P"}(r||(r={})),function(e){e[e.AUDIO=1]="AUDIO",e[e.VIDEO=2]="VIDEO",e[e.SHARE=3]="SHARE"}(n||(n={})),function(e){e[e.VIDEO=1]="VIDEO",e[e.AUDIO=2]="AUDIO",e[e.SHARE=3]="SHARE"}(o||(o={})),function(e){e[e.INGRESS=0]="INGRESS",e[e.EGRESS=1]="EGRESS"}(c||(c={})),function(e){e[e.IDLE=0]="IDLE",e[e.CONNECTING=1]="CONNECTING",e[e.CONNECTED=2]="CONNECTED"}(d||(d={}));const m=6e3,p=5e3,S=1e4,g=3,_=5e3,v=1e3,f=15e3;var I,C,E;!function(e){e.STREAM="STREAM",e.SDP="SDP",e.PC_STATE_CHANGE="PC_STATE_CHANGE",e.NO_H264_CODEC="NO_H264_CODEC",e.ERROR="ERROR"}(I||(I={})),function(e){e.LAYERS_UPDATE="LAYERS_UPDATE",e.MIN_BITRATE_UPDATE="MIN_BITRATE_UPDATE",e.ENCODER_RESET="ENCODER_RESET"}(C||(C={})),function(e){e[e.NONE=0]="NONE",e[e.UNDERUSING=1]="UNDERUSING",e[e.NORMAL=2]="NORMAL",e[e.OVERUSING=3]="OVERUSING"}(E||(E={}));const R=1,b="0";var M;!function(e){e[e.PLAIN=0]="PLAIN",e[e.GZIP_BASE64=1]="GZIP_BASE64"}(M||(M={}));const T=2,y="64",L=26,w=L+1,D=16,A=299,O=6;var P,N,V,B;!function(e){e[e.NET_QUALITY_UNKNOWN=-1]="NET_QUALITY_UNKNOWN",e[e.NET_QUALITY_VERY_BAD=0]="NET_QUALITY_VERY_BAD",e[e.NET_QUALITY_BAD=1]="NET_QUALITY_BAD",e[e.NET_QUALITY_NOT_GOOD=2]="NET_QUALITY_NOT_GOOD",e[e.NET_QUALITY_NORMAL=3]="NET_QUALITY_NORMAL",e[e.NET_QUALITY_GOOD=4]="NET_QUALITY_GOOD",e[e.NET_QUALITY_EXCELLENT=5]="NET_QUALITY_EXCELLENT"}(P||(P={})),function(e){e[e.NET_BW_LEVEL_UNKNOWN=-1]="NET_BW_LEVEL_UNKNOWN",e[e.NET_BW_LEVEL_VERY_LOW=0]="NET_BW_LEVEL_VERY_LOW",e[e.NET_BW_LEVEL_LOW=1]="NET_BW_LEVEL_LOW",e[e.NET_BW_LEVEL_NORMAL=2]="NET_BW_LEVEL_NORMAL"}(N||(N={})),function(e){e[e.ICE=0]="ICE",e[e.MEDIA=1]="MEDIA"}(V||(V={})),function(e){e[e.HD_VIDEO=2097152]="HD_VIDEO",e[e.FULL_HD_VIDEO=4096]="FULL_HD_VIDEO",e[e.DUAL_CALL=1]="DUAL_CALL",e[e.AV1_CODEC=262144]="AV1_CODEC"}(B||(B={}));const x=new class{constructor(){this.confId="",this.nodeId="",this.maxCaptureVideoSize=4,this.maxRecvVideoNum=L,this.hdVideoEnabled=!1,this.isMacIntel=!1,this.videoSettings=null,this._enabledLayerIds=[],this._layersSettings=null,this.iceServers=[]}setConfig(e){const{confId:t,nodeId:i,maxCaptureResolution:s,maxVideoReceiveNum:a,HDVideo:r,isMacIntel:n,videoSettings:o,qosOptions:c,iceServers:d}=e;void 0!==t&&(this.confId=t),void 0!==i&&(this.nodeId=i),void 0!==s&&(this.maxCaptureVideoSize=s),void 0!==a&&(this.maxRecvVideoNum=a),void 0!==r&&(this.hdVideoEnabled=r),void 0!==n&&(this.isMacIntel=n),void 0!==o&&(this.videoSettings=o),void 0!==c&&(this.qosOptions=c),null!=d&&(this.iceServers=d||[])}getConfig(){const{confId:e,nodeId:t,maxRecvVideoNum:i,hdVideoEnabled:s,isMacIntel:a,videoSettings:r,qosOptions:n,iceServers:o}=this;return{confId:e,nodeId:t,maxRecvVideoNum:i,hdVideoEnabled:s,isMacIntel:a,videoSettings:r,qosOptions:n,iceServers:o}}setEnabledLayerIds(e){this._enabledLayerIds=e}get enabledLayerIds(){return this._enabledLayerIds}setLayersSettings(e){this._layersSettings=e}get layersSettings(){return this._layersSettings}};var U,k;!function(e){e.NOTIFY_SDK_JOIN_RWG_SUCCESS="NOTIFY_SDK_JOIN_RWG_SUCCESS",e.NOTIFY_SDK_JOIN_RWG_FAILURE="NOTIFY_SDK_JOIN_RWG_FAILURE",e.VIDEO_STREAMS="VIDEO_STREAMS",e.WMSC_MESSAGE_FROM_RWG="WMSC_MESSAGE_FROM_RWG",e.NOTIFY_WMSC_VIDEO_TAG_MAPPING="NOTIFY_WMSC_VIDEO_TAG_MAPPING",e.NOTIFY_SDK_SUBSCRIBE_VIDEO="NOTIFY_SDK_SUBSCRIBE_VIDEO",e.NOTIFY_SDK_UNSUBSCRIBE_VIDEO="NOTIFY_SDK_UNSUBSCRIBE_VIDEO",e.NOTIFY_SDK_ACTIVE_VIDEO_INDICATION="NOTIFY_SDK_ACTIVE_VIDEO_INDICATION",e.UPDATE_WMSC_PARAMS="UPDATE_WMSC_PARAMS"}(U||(U={})),function(e){e.ERROR="ERROR",e.WMSC_MESSAGE_TO_RWG_BY_SDK="WMSC_MESSAGE_TO_RWG_BY_SDK",e.WMSC_MAPPING_STREAMID_AND_MID="WMSC_MAPPING_STREAMID_AND_MID",e.GLOBAL_TRACE="GLOBAL_TRACE",e.MONITOR="MONITOR",e.DIRECT_MONITOR="DIRECT_MONITOR",e.SDP_NEGOTIATION_FAIL="SDP_NEGOTIATION_FAIL",e.CREATE_VIDEO_STREAMS_SUCCESS="CREATE_VIDEO_STREAMS_SUCCESS",e.CREATE_VIDEO_STREAMS_FAIL="CREATE_VIDEO_STREAMS_FAIL",e.V_RECEV_PC_CONNECTED="V_RECEV_PC_CONNECTED",e.V_SEND_PC_CONNECTED="V_SEND_PC_CONNECTED",e.VIDEO_SOURCE_UPDATED="VIDEO_SOURCE_UPDATED",e.VIDEO_TAG_MAPPED="VIDEO_TAG_MAPPED",e.VIDEO_QOS_DATA="VIDEO_QOS_DATA",e.UPDATE_VIDEO_CAPTURE_CONSTRAINTS="UPDATE_VIDEO_CAPTURE_CONSTRAINTS",e.ERROR_MESSAGE="ERROR_MESSAGE",e.NETWORK_QUALITY_CHANGE="NETWORK_QUALITY_CHANGE",e.VIDEO_CAPABILITIES_CHANGE="VIDEO_CAPABILITIES_CHANGE"}(k||(k={}));var W=i(7201),F=i.n(W),G=function(e,t,i,s){return new(i||(i=Promise))((function(a,r){function n(e){try{c(s.next(e))}catch(e){r(e)}}function o(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}c((s=s.apply(e,t||[])).next())}))};function z(e,t){return G(this,void 0,void 0,(function*(){switch(t){case M.GZIP_BASE64:{const t=yield function(e){return G(this,void 0,void 0,(function*(){const t=(new TextEncoder).encode(e);if(window.CompressionStream){const e=new CompressionStream("gzip"),i=e.writable.getWriter();return i.write(t),i.close(),new Response(e.readable).arrayBuffer()}{const{gzip:e}=yield i.e(404).then(i.bind(i,3075));return e(t).buffer}}))}(e);return function(e){let t="";const i=new Uint8Array(e);for(let e=0;e<i.byteLength;e++)t+=String.fromCharCode(i[e]);return btoa(t)}(t)}case M.PLAIN:return e;default:return null}}))}function j(e,t){return e.length===t.length&&e.every(((e,i)=>e===t[i]))}function H(e,t){return e-t}function Q(e){var t;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"|";return e?F()(t=e.toString()).call(t,/[,ï¼Œ]/g,i):""}const q=new class{constructor(){this.setTrace()}setTrace(e,t){t&&(t.log||t.info)&&t.error&&t.warn?(this.log=t.log||t.info,this.info=t.info||t.log,this.debug=t.debug||t.log,this.verbose=this._verbose,this.error=t.error,this.warn=t.warn):(this.verbose=this._verbose.bind(this),this.log=this._log.bind(this),this.info=this._info.bind(this),this.debug=this._debug.bind(this),this.error=this._error.bind(this),this.warn=this._warn.bind(this)),this.level=e||a.INFO,this.level=this.level<a.ERROR?a.ERROR:this.level,this.level=this.level>a.VERBOSE?a.VERBOSE:this.level,this.getLevel=()=>this.level,this._trace=(e,t)=>{switch(e){case"log":console.log(...t);break;case"debug":console.debug(...t);break;case"info":console.info(...t);break;case"warn":console.warn(...t);break;case"error":console.error(...t)}}}getTracer(e){return{log:()=>{},debug:()=>{},info:()=>{},warn:()=>{},error:()=>{}}}setTelemetry(e){this._telemetry="function"==typeof e?e:null}monitorLog(e){e&&this._telemetry&&this._telemetry({type:k.MONITOR,data:e})}directSendMonitorLog(e){e&&this._telemetry&&this._telemetry({type:k.DIRECT_MONITOR,data:e})}globalTrace(e){e&&this._telemetry&&this._telemetry({type:k.GLOBAL_TRACE,data:e})}_verbose(){if(this.level>=a.VERBOSE){const e=[...arguments];return e.unshift("[VERBOSE]"),this._trace("log",e),!0}return!1}_debug(){return this.level>=a.DEBUG&&(this._trace("debug",arguments),!0)}_log(){return this.level>=a.INFO&&(this._trace("log",arguments),!0)}_info(){return this.level>=a.INFO&&(this._trace("info",arguments),!0)}_warn(){return this.level>=a.WARN&&(this._trace("warn",arguments),!0)}_error(){return this.level>=a.ERROR&&(this._trace("error",arguments),!0)}};var Y=i(1265),J=i.n(Y),K=i(8048),X=i.n(K);function Z(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,s)}return i}function $(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Z(Object(i),!0).forEach((function(t){(0,h.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Z(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class ee{static splitSections(e){return e.split("\r\nm=").map(((e,t)=>t>0?"m="+e:e))}static splitLines(e){return e.split("\r\n")}static parseVersionLine(e){return parseInt(e.substring(2),10)}static writeVersionLine(e){return"v=".concat(e)}static parseOriginLine(e){const[t,i,s,a,r,n]=e.substring(2).split(" ");return{userName:t,sessionId:i,sessionVersion:parseInt(s,10),netType:a,addressType:r,address:n}}static writeOriginLine(e){const{userName:t,sessionId:i,sessionVersion:s,netType:a,addressType:r,address:n}=e;return"o=".concat(t," ").concat(i," ").concat(s," ").concat(a," ").concat(r," ").concat(n)}static parseSessionNameLine(e){return e.substring(2)}static writeSessionNameLine(e){return"s=".concat(e)}static parseInformationLine(e){return e.substring(2)}static writeInformationLine(e){return"i=".concat(e)}static parseConnectionLine(e){const[t,i,s]=e.substring(2).split(" ");return{netType:t,addressType:i,address:s}}static writeConnectionLine(e){const{netType:t,addressType:i,address:s}=e;return"c=".concat(t," ").concat(i," ").concat(s)}static parseBandwidthLine(e){return parseInt(e.substring(7),10)}static writeBandwidthLine(e){return"b=TIAS:".concat(e)}static parseTimingLine(e){const[t,i]=e.substring(2).split(" ");return{startTime:parseInt(t,10),stopTime:parseInt(i,10)}}static writeTimingLine(e){const{startTime:t,stopTime:i}=e;return"t=".concat(t," ").concat(i)}static parseRtpMapLine(e){const t=e.substring(9).match(/^(\d+) (.*)/),i=t[2].split("/");return{payloadType:parseInt(t[1],10),codecName:i[0],clockRate:parseInt(i[1],10),channels:i.length>=3?parseInt(i[2],10):null}}static writeRtpMapLine(e){const{payloadType:t,codecName:i,clockRate:s,channels:a}=e;let r="a=rtpmap:".concat(t," ").concat(i,"/").concat(s);return null!=a&&(r+="/"+a),r}static parseFmtpLine(e){const t=e.substring(7).match(/^(\d+) (.*)/),i={payloadType:parseInt(t[1],10)};return t[2].includes("=")?i.params=new Map(t[2].split(";").map((e=>J()(e).call(e).split("=")))):i.plain=t[2],i}static writeFmtpLine(e){const{payloadType:t,params:i,plain:s}=e;let a="a=fmtp:".concat(t," ");return i?(i.forEach(((e,t)=>{null!=e&&(a+="".concat(t,"=").concat(e,";"))})),a=a.slice(0,-1)):a+=s,a}static parseRtcpFbLine(e){const t=e.substring(10).match(/^(\d+) (.*)/);return{payloadType:parseInt(t[1],10),params:t[2].split(" ")}}static writeRtcpFbLine(e){const{payloadType:t,params:i}=e;let s="a=rtcp-fb:".concat(t);return i.forEach((e=>{s+=" "+e})),s}static parseRidLine(e){const t=e.substring(6).match(/^(\S+) (send|recv)/);return{rid:t[1],direction:t[2]}}static writeRidLine(e){const{rid:t,direction:i}=e;return"a=rid:".concat(t," ").concat(i)}static parseSimulcastLine(e){const t=e.substring(12).match(/^(send|recv) (.*)/);return{direction:t[1],rids:t[2].split(";").map((e=>"~"===e[0]?{id:e.substring(1),paused:!0}:{id:e,paused:!1}))}}static writeSimulcastLine(e){const{direction:t,rids:i}=e;let s="a=simulcast:".concat(t," ");return i.forEach((e=>{const t=e.paused?"~"+e.id:e.id;s+=t+";"})),s.slice(0,-1)}static parseExtensionMapLine(e){var t;const i=e.substring(9).match(/^(\d+)(\/sendrecv|\/sendonly|\/recvonly|\/inactive)? (\S+)(\s\S+)?/);return{id:parseInt(i[1],10),direction:i[2]?i[2].substring(1):null,uri:i[3],attributes:i[4]?X()(t=i[4]).call(t):null}}static writeExtensionMapLine(e){const{id:t,direction:i,uri:s,attributes:a}=e;let r="a=extmap:".concat(t);return null!=i&&(r+="/"+i),r+=" "+s,null!=a&&(r+=" "+a),r}static parseMidLine(e){return e.substring(6)}static writeMidLine(e){return"a=mid:".concat(e)}static writeDirectionLine(e){return"a=".concat(e)}static parseMsidLine(e){const[t,i]=e.substring(7).split(" ");return{streamId:t,trackId:i}}static writeMsidLine(e){const{streamId:t,trackId:i}=e;return"a=msid:".concat(t," ").concat(i)}static parseSsrcLine(e){const t=e.indexOf(" ");return{ssrc:parseInt(e.substring(7,t),10),attribute:e.substring(t+1)}}static writeSsrcLine(e){const{ssrc:t,attribute:i}=e;return"a=ssrc:".concat(t," ").concat(i)}static parseSsrcGroupLine(e){const t=e.substring(13).split(" ");return{semantics:t.shift(),ssrcs:t}}static writeSsrcGroupLine(e){const{semantics:t,ssrcs:i}=e;let s="a=ssrc-group:".concat(t);return i.forEach((e=>{s+=" "+e})),s}static parseGroupLine(e){const t=e.indexOf(" ");return{semantics:e.substring(8,t),ids:e.substring(t+1).split(" ")}}static writeGroupLine(e){const{semantics:t,ids:i}=e;let s="a=group:".concat(t);return i.forEach((e=>{s+=" "+e})),s}static writeExtMapAllowMixedLine(){return"a=extmap-allow-mixed"}static writeRtcpMuxLine(){return"a=rtcp-mux"}static writeRtcpReducedSizeLine(){return"a=rtcp-rsize"}static parseCandidateLine(e){const t=e.substring(12).split(" "),i={foundation:t[0],componentId:parseInt(t[1],10),transport:t[2],priority:parseInt(t[3],10),address:t[4],port:parseInt(t[5],10),candType:t[6],type:t[7],relAddress:null,relPort:null,candExtensions:[]};return"raddr"===t[8]&&"rport"===t[10]?(i.relAddress=t[9],i.relPort=parseInt(t[11],10),i.candExtensions=t.slice(12)):i.candExtensions=t.slice(8),i}static writeCandidateLine(e){const{foundation:t,componentId:i,transport:s,priority:a,address:r,port:n,candType:o,type:c,relAddress:d,relPort:h,candExtensions:l}=e;let u="a=candidate:".concat(t," ").concat(i," ").concat(s," ").concat(a)+" ".concat(r," ").concat(n," ").concat(o," ").concat(c);return null!=d&&null!=h&&(u+=" raddr ".concat(d," rport ").concat(h)),l.length&&(u+=" "+l.join(" ")),u}static parseSessionSection(e){const t={version:0,origin:null,sessionName:null,information:null,connection:null,bandwidth:null,timing:null,groups:[],extMapAllowMixed:null,otherLines:[]},i=this.splitLines(e);for(let e=0;e<i.length;e++){const s=i[e];s.length&&(s.match(/^v=/)?t.version=this.parseVersionLine(s):s.match(/^o=/)?t.origin=this.parseOriginLine(s):s.match(/^s=/)?t.sessionName=this.parseSessionNameLine(s):s.match(/^i=/)?t.information=this.parseInformationLine(s):s.match(/^c=/)?t.connection=this.parseConnectionLine(s):s.match(/^b=TIAS:/)?t.bandwidth=this.parseBandwidthLine(s):s.match(/^t=/)?t.timing=this.parseTimingLine(s):s.match(/^a=group:/)?t.groups.push(this.parseGroupLine(s)):s.match(/^a=extmap-allow-mixed$/)?t.extMapAllowMixed=!0:t.otherLines.push(s))}return t}static writeSessionSection(e){const t=[];return t.push(this.writeVersionLine(e.version)),null!=e.origin&&t.push(this.writeOriginLine(e.origin)),null!=e.sessionName&&t.push(this.writeSessionNameLine(e.sessionName)),null!=e.information&&t.push(this.writeInformationLine(e.information)),null!=e.connection&&t.push(this.writeConnectionLine(e.connection)),null!=e.bandwidth&&t.push(this.writeBandwidthLine(e.bandwidth)),null!=e.timing&&t.push(this.writeTimingLine(e.timing)),e.groups.forEach((e=>{t.push(this.writeGroupLine(e))})),e.extMapAllowMixed&&t.push(this.writeExtMapAllowMixedLine()),e.otherLines.length&&t.push(...e.otherLines),t.join("\r\n")+"\r\n"}static parseMediaSection(e){const t={type:null,port:null,protocol:null,connection:null,bandwidth:null,mid:null,direction:null,msid:null,rtcpMux:null,rtcpReducedSize:null,codecs:[],extensionMap:new Map,rids:[],simulcast:null,ssrcs:[],ssrcGroups:[],candidates:[],otherLines:[]},i=[],s=[],a=this.splitLines(e),r=a[0].split(" ");t.type=r[0].substring(2),t.port=parseInt(r[1],10),t.protocol=r[2],t.payloadTypes=r.slice(3).map((e=>parseInt(e,10)));for(let e=1;e<a.length;e++){let r;const n=a[e];if(n.length)if(n.match(/^c=/))t.connection=this.parseConnectionLine(n);else if(n.match(/^b=TIAS:/))t.bandwidth=this.parseBandwidthLine(n);else if(n.match(/^a=rtpmap:/)){const e=this.parseRtpMapLine(n);t.codecs.push($($({},e),{},{codecParams:new Map,fmtpLines:[],rtcpFbParams:[]}))}else if(n.match(/^a=fmtp:/))i.push(n);else if(n.match(/^a=rtcp-fb:/))s.push(n);else if(n.match(/^a=rid:/))t.rids.push(this.parseRidLine(n));else if(n.match(/^a=simulcast:/))t.simulcast=this.parseSimulcastLine(n);else if(n.match(/^a=ssrc:/))t.ssrcs.push(this.parseSsrcLine(n));else if(n.match(/^a=ssrc-group:/))t.ssrcGroups.push(this.parseSsrcGroupLine(n));else if(n.match(/^a=extmap:/)){const e=this.parseExtensionMapLine(n);t.extensionMap.set(e.id,e)}else n.match(/^a=mid:/)?t.mid=this.parseMidLine(n):(r=n.match(/^a=(sendrecv|sendonly|recvonly|inactive)/))?t.direction=r[1]:n.match(/^a=msid:/)?t.msid=this.parseMsidLine(n):n.match(/^a=rtcp-mux$/)?t.rtcpMux=!0:n.match(/^a=rtcp-rsize$/)?t.rtcpReducedSize=!0:n.match(/^a=candidate:/)?t.candidates.push(this.parseCandidateLine(n)):t.otherLines.push(n)}return i.forEach((e=>{const i=this.parseFmtpLine(e),s=t.codecs.find((e=>e.payloadType===i.payloadType));s&&(i.params?i.params.forEach(((e,t)=>{"apt"===t&&(s.associatedPayloadType=parseInt(e,10)),s.codecParams.set(t,e)})):(s.fmtpLines.push(i.plain),"red"===s.codecName&&(s.associatedPayloadType=parseInt(i.plain.split("/")[0],10))))})),s.forEach((e=>{const i=this.parseRtcpFbLine(e),s=t.codecs.find((e=>e.payloadType===i.payloadType));s&&s.rtcpFbParams.push(i.params)})),t}static writeMediaSection(e){const t=[];let i="m=".concat(e.type," ").concat(e.port," ").concat(e.protocol);return e.payloadTypes.forEach((e=>{i+=" "+e})),t.push(i),e.connection&&t.push(this.writeConnectionLine(e.connection)),e.bandwidth&&t.push(this.writeBandwidthLine(e.bandwidth)),e.otherLines.length&&t.push(...e.otherLines),t.push(this.writeMidLine(e.mid)),e.extensionMap.size&&e.extensionMap.forEach(((e,i)=>{t.push(this.writeExtensionMapLine(e))})),t.push(this.writeDirectionLine(e.direction)),e.msid&&t.push(this.writeMsidLine(e.msid)),e.rtcpMux&&t.push(this.writeRtcpMuxLine()),e.rtcpReducedSize&&t.push(this.writeRtcpReducedSizeLine()),e.codecs.forEach((e=>{const{payloadType:i,codecName:s,clockRate:a,channels:r,codecParams:n,fmtpLines:o,rtcpFbParams:c}=e;t.push(this.writeRtpMapLine({payloadType:i,codecName:s,clockRate:a,channels:r})),c.forEach((e=>{t.push(this.writeRtcpFbLine({payloadType:i,params:e}))})),n.size&&t.push(this.writeFmtpLine({payloadType:i,params:n})),o.forEach((e=>{t.push(this.writeFmtpLine({payloadType:i,plain:e}))}))})),e.ssrcGroups.forEach((e=>{t.push(this.writeSsrcGroupLine(e))})),e.ssrcs.forEach((e=>{t.push(this.writeSsrcLine(e))})),e.rids.forEach((e=>{t.push(this.writeRidLine(e))})),e.candidates.forEach((e=>{t.push(this.writeCandidateLine(e))})),e.simulcast&&t.push(this.writeSimulcastLine(e.simulcast)),t.join("\r\n")+"\r\n"}static parse(e){const t={session:null,media:[],application:[]},i=this.splitSections(e);return t.session=this.parseSessionSection(i.shift()),i.forEach((e=>{const i=this.parseMediaSection(e);"audio"!==i.type&&"video"!==i.type||t.media.push(i),"application"===i.type&&t.application.push(i)})),t}static write(e){let t=this.writeSessionSection(e.session);return e.media.forEach((e=>{t+=this.writeMediaSection(e)})),e.application.forEach((e=>{t+=this.writeMediaSection(e)})),t}}class te{constructor(){this.browser=void 0,this.browserVersion=void 0,this.os=void 0,this.osVersion=void 0,this.hardwareConcurrency=navigator.hardwareConcurrency||1,this.isMobile=this._isMobile(navigator.userAgent),this._getBrowserAndOSVersions(navigator.userAgent)}_getBrowserAndOSVersions(e){for(const[t,i]of Object.entries(te.regex)){const s=e.match(i);if(s)switch(t){case"iOS":this.os=t,this.osVersion=s[1].replace(/_/g,".");break;case"macOS":this.os=t;break;case"Windows":case"Android":case"ChromeOS":this.os=t,this.osVersion=s[1];break;case"Linux":e.match(te.regex.Android)||(this.os=t);break;case"SafariIOS":this.browser||(this.browser="Safari",this.browserVersion=s[1].split("/")[1]),this.os="iOS",this.osVersion=s[2];break;default:this.browser||(this.browser=t,this.browserVersion=s[1])}}}_isMobile(e){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(e)}getMajorBrowserVersion(){var e;const t=parseInt(null===(e=this.browserVersion)||void 0===e?void 0:e.split(".")[0],10);return isNaN(t)?void 0:t}getMinorBrowserVersion(){var e;const t=parseInt(null===(e=this.browserVersion)||void 0===e?void 0:e.split(".")[1],10);return isNaN(t)?void 0:t}isBrowserVersionGreaterEqualThan(e,t){const i=this.getMajorBrowserVersion(),s=this.getMinorBrowserVersion();return i>e||i===e&&s>=t}getMajorOsVersion(){var e;const t=parseInt(null===(e=this.osVersion)||void 0===e?void 0:e.split(".")[0],10);return isNaN(t)?void 0:t}getMinorOsVersion(){var e;const t=parseInt(null===(e=this.osVersion)||void 0===e?void 0:e.split(".")[1],10);return isNaN(t)?void 0:t}isOsVersionGreaterEqualThan(e,t){const i=this.getMajorOsVersion(),s=this.getMinorOsVersion();return i>e||i===e&&s>=t}}(0,h.A)(te,"regex",{Chrome:/(?:Chrome|Chromium|CriOS)\/([\d.]+)/,Firefox:/(?:Firefox|FxiOS)\/([\d.]+)/,Safari:/Version\/([\d.]+)\sSafari/,SafariIOS:/(Version\/[\d.]+).*Mobile\/([\w]+)/,IE:/MSIE\s([\d.]+)/,Edge:/Edg\/([\d.]+)/,Opera:/(?:Opera|OPR)\/([\d.]+)/,Android:/Android\s([\d.]+)/,iOS:/(?:iPhone|iPad|iPod).*OS\s([\d_]+)/,Windows:/Windows NT\s([\d.]+)/,macOS:/Mac OS X\s([\d_.]+)/,Linux:/Linux/,ChromeOS:/CrOS/});const ie=new te;function se(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,s)}return i}class ae{static parseSdp(e){return ee.parse(e)}static writeSdp(e){return ee.write(e)}static generateSsrc(){return Math.floor(4294967294*Math.random())+1}static generateId(){return Math.random().toString(36).substring(2,12)}static generateSessionId(){return Math.random().toString().substring(2,22)}static generateUuid(){const e=Array.from(Array(256).keys()).map((e=>e.toString(16).padStart(2,"0"))),t=crypto.getRandomValues(new Uint8Array(16));return t[6]=15&t[6]|64,t[8]=63&t[8]|128,Array.from(t.entries()).map((t=>{let[i,s]=t;return[4,6,8,10].includes(i)?"-".concat(e[s]):e[s]})).join("")}static getSessionBoilerplate(){return"v=\r\no=- ".concat(this.generateSessionId()," 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n")}static getNtpSeconds(){return Math.floor((Date.now()+(Date.UTC(1970,0,1)-Date.UTC(1900,0,1)))/1e3)}static findHeaderExtensionByUri(e,t){for(const[i,s]of e.extensionMap)if(s.uri===t)return i;return-1}static addHeaderExtension(e,t){if(-1!==this.findHeaderExtensionByUri(e,t.uri))return!1;let i=0;e.extensionMap.forEach(((e,t)=>{t>i&&(i=t)}));const s=i+1;return e.extensionMap.set(s,function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?se(Object(i),!0).forEach((function(t){(0,h.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):se(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({id:s},t)),!0}static removeHeaderExtensionByUri(e,t){let i=!1;return e.extensionMap.forEach(((e,s,a)=>{e.uri===t&&(a.delete(s),i=!0)})),i}static removeMidRidHeaderExtensions(e){e.extensionMap.forEach(((e,t,i)=>{/^urn:ietf:params:rtp-hdrext:sdes:(?:mid|rtp-stream-id|repaired-rtp-stream-id)$/.test(e.uri)&&i.delete(t)}))}static updateCodecParameters(e,t,i,s,a){e.media.filter((e=>e.type===t&&e.direction===i)).forEach((e=>{e.codecs.filter((e=>e.codecName===s)).forEach((e=>{a.forEach(((t,i)=>{e.codecParams.set(i,t)}))}))}))}static filterCodecs(e,t){e.media.forEach((e=>{const i=[];e.codecs.forEach((e=>{t&&!t(e)||i.push(e.payloadType)})),e.codecs.forEach((e=>{i.includes(e.associatedPayloadType)&&i.push(e.payloadType)})),e.payloadTypes=e.payloadTypes.filter((e=>i.includes(e))),e.codecs=e.codecs.filter((e=>i.includes(e.payloadType)))})),e.media=e.media.filter((e=>e.payloadTypes.length))}static filterH264Profiles(e,t,i){e.media.filter((e=>e.direction===t)).forEach((e=>{const t=[];e.codecs.filter((e=>"H264"===e.codecName)).forEach((e=>{var s;const a=parseInt(null===(s=e.codecParams.get("profile-level-id"))||void 0===s?void 0:s.substring(0,2),16);i.includes(a)&&t.push(e.payloadType)})),e.codecs.forEach((e=>{t.includes(e.associatedPayloadType)&&t.push(e.payloadType)})),e.payloadTypes=e.payloadTypes.filter((e=>t.includes(e))),e.codecs=e.codecs.filter((e=>t.includes(e.payloadType)))}))}static getH264ProfileIds(e,t,i){const s=new Set,a=e.media.find((e=>"video"===e.type&&e.direction===t));return null==a||a.codecs.forEach((e=>{if("H264"===e.codecName&&(void 0===i||parseInt(e.codecParams.get("packetization-mode"))===i)){var t;const i=parseInt(null===(t=e.codecParams.get("profile-level-id"))||void 0===t?void 0:t.substring(0,2),16);i&&s.add(i)}})),Array.from(s.values())}static getMediaStartBandwidth(e){var t;const i=null==e||null===(t=e.codecs[0])||void 0===t?void 0:t.codecParams.get("x-google-start-bitrate");return 1e3*parseInt(i,10)||void 0}static mungeEgressLocalOffer(e,t){let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const s=e.media.find((e=>"video"===e.type&&"sendonly"===e.direction));if(!s)throw new Error("Failed to find a video media section for send");if(t>1&&i){s.rids=[],s.simulcast=null,s.ssrcs=[],s.ssrcGroups=[];const e=s.codecs.some((e=>"rtx"===e.codecName)),i=[],a=ae.generateUuid(),r="- ".concat(ae.generateUuid());for(let n=0;n<t;n++){const t=ae.generateSsrc();if(i.push(t),s.ssrcs.push({ssrc:t,attribute:"cname:"+a}),s.ssrcs.push({ssrc:t,attribute:"msid:"+r}),e){const e=ae.generateSsrc();s.ssrcs.push({ssrc:e,attribute:"cname:"+a}),s.ssrcs.push({ssrc:e,attribute:"msid:"+r}),s.ssrcGroups.push({semantics:"FID",ssrcs:[t,e]})}}s.ssrcGroups.push({semantics:"SIM",ssrcs:i})}ae.removeMidRidHeaderExtensions(s),"iOS"===ie.os&&15===ie.getMajorOsVersion()&&1===ie.getMinorOsVersion()||ae.removeHeaderExtensionByUri(s,"urn:3gpp:video-orientation"),ae.addHeaderExtension(s,{uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time"}),t>1&&(e.session.extMapAllowMixed=!0,ae.addHeaderExtension(s,{uri:"http://www.webrtc.org/experiments/rtp-hdrext/video-layers-allocation00"}))}static mungeEgressOfferToRemote(e){e.session.timing={startTime:ae.getNtpSeconds(),stopTime:0}}static mungeEgressAnswer(e,t){t&&ae.updateCodecParameters(e,"video","recvonly","H264",t)}static mungeIngressLocalOffer(e,t){t&&ae.updateCodecParameters(e,"video","recvonly","H264",t)}}const re=[{layerId:4,width:1920,height:1080,maxFramerate:30,minBitrate:25e5,targetBitrate:4e6,maxBitrate:5e6},{layerId:4,width:1600,height:900,maxFramerate:30,minBitrate:15e5,targetBitrate:3e6,maxBitrate:35e5},{layerId:3,width:1280,height:720,maxFramerate:30,minBitrate:8e5,targetBitrate:2e6,maxBitrate:2e6},{layerId:3,width:960,height:540,maxFramerate:30,minBitrate:5e5,targetBitrate:12e5,maxBitrate:12e5},{layerId:2,width:640,height:360,maxFramerate:30,minBitrate:25e4,targetBitrate:5e5,maxBitrate:7e5},{layerId:2,width:480,height:270,maxFramerate:30,minBitrate:18e4,targetBitrate:35e4,maxBitrate:45e4},{layerId:1,width:320,height:180,maxFramerate:30,minBitrate:1e5,targetBitrate:15e4,maxBitrate:2e5},{layerId:1,width:256,height:144,maxFramerate:30,minBitrate:6e4,targetBitrate:1e5,maxBitrate:13e4}];function ne(e){x.setLayersSettings(e)}function oe(e){x.setEnabledLayerIds(e)}function ce(){return x.layersSettings}function de(){return x.enabledLayerIds}function he(){return de()[0]}function le(e){return de().includes(e)}function ue(){const e=de();return e[e.length-1]}function me(e){var t;return null===(t=ce())||void 0===t?void 0:t[e]}function pe(e){const t=ce();if(!t)return;const i=t.findIndex((t=>t.layerId===e));return i>=0?me(i):void 0}function Se(e){const t=ce();if(t)for(let i=t.length-1;i>=0;i--)if(t[i].layerId===e)return me(i)}function ge(e){var t;return(null===(t=pe(e))||void 0===t?void 0:t.maxBitrate)||0}function _e(e){var t;return(null===(t=pe(e))||void 0===t?void 0:t.targetBitrate)||0}function ve(e,t){const i=pe(e);if(i){const{width:e,height:s,maxBitrate:a}=i;return Math.floor(t.width*t.height/(e*s)*a)}}function fe(e){const t=e.width*e.height;return t>921600?4:t>307200?3:t>76800?2:t>19200?1:t>0?0:-1}function Ie(e){var t,i;return!!(null===(i=null===(t=x.videoSettings)||void 0===t?void 0:t.preferSoftwareCodec)||void 0===i?void 0:i[e])}class Ce{constructor(e){this._array=new Array(e),this._size=e,this._index=0,this._count=0}get size(){return this._size}get count(){return this._count}empty(){return 0===this._count}full(){return this._count===this._size}clear(){this._array=new Array(this._size),this._index=0,this._count=0}fill(e){return this._array.fill(e),this._index=0,this._count=this._size,this}get lastIndex(){return 0===this._index?this._size-1:this._index-1}nextIndex(e){return(e+1)%this._size}push(e){this._array[this._index]=e,this._index=this.nextIndex(this._index),this._count<this._size&&this._count++}pop(){if(this.empty())return;const e=this.lastIndex;return this._index=e,this._size>0&&this._size--,this._array[e]}at(e){if(!(this._count<this._size&&e>=this._count))return this._array[e]}front(){if(!this.empty())return this._array[this._count<this.size?0:this._index]}back(){if(!this.empty())return this._array[this.lastIndex]}unwrap(){return this._count<this._size?this._array.slice(0,this._count):[...this._array.slice(this._index),...this._array.slice(0,this._index)]}findIndex(e){if(this._count<this._size){for(let t=0;t<this._count;t++)if(e(this._array[t]))return t}else{for(let t=this._index;t<this._size;t++)if(e(this._array[t]))return t;for(let t=0;t<this._index;t++)if(e(this._array[t]))return t}return-1}findLastIndex(e){if(this._count<this._size){for(let t=this._count-1;t>=0;t--)if(e(this._array[t]))return t}else{for(let t=this._size-1;t>=this._index;t--)if(e(this._array[t]))return t;for(let t=this._index-1;t>=0;t--)if(e(this._array[t]))return t}return-1}find(e){const t=this.findIndex(e);return-1===t?void 0:this._array[t]}findLast(e){const t=this.findLastIndex(e);return-1===t?void 0:this._array[t]}}function Ee(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,s)}return i}function Re(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Ee(Object(i),!0).forEach((function(t){(0,h.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Ee(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}q.getTracer("WmscStats");class be{constructor(){this.sendStatsMonitor=new Me({cacheSize:be.sendStatsCacheSize}),this.recvStatsMonitor=new Te({cacheSize:be.recvStatsCacheSize}),this.sendUsageStatsEnabled=!1,this.recvUsageStatsEnabled=!1,this.resourceUsageStatsReportTimestamp=0,this.resourceUsageStatsIntervalId=null,this.outgoingBitrateStatsCallback=null,this.resourceUsageStatsCallback=null}getSendStatsMonitor(){return this.sendStatsMonitor}getRecvStatsMonitor(){return this.recvStatsMonitor}setOptions(e){const{sendUsageStatsEnabled:t,recvUsageStatsEnabled:i}=e||{};void 0!==t&&(this.sendUsageStatsEnabled=t),void 0!==i&&(this.recvUsageStatsEnabled=i)}start(e){e&&this.setOptions(e),this.sendUsageStatsEnabled&&this.sendStatsMonitor.setOptions({outboundRtpStatsEnabled:!0}),this.sendStatsMonitor.start(),this.recvUsageStatsEnabled&&this.recvStatsMonitor.setOptions({inboundRtpStatsEnabled:!0}),this.recvStatsMonitor.start(),(this.sendUsageStatsEnabled||this.recvUsageStatsEnabled)&&(this.resourceUsageStatsIntervalId=setInterval((()=>{this._reportResourceUsageStats()}),be.resourceUsageCheckInterval))}stop(){this.sendStatsMonitor.stop(),this.recvStatsMonitor.stop(),clearInterval(this.resourceUsageStatsIntervalId),this.resourceUsageStatsIntervalId=null}reset(){this.sendStatsMonitor.reset(),this.recvStatsMonitor.reset(),this.resourceUsageStatsReportTimestamp=0}registerOutgoingBitrateStatsCallback(e){this.sendStatsMonitor.outgoingBitrateStatsCallback=e}registerResourceUsageStatsCallback(e){this.resourceUsageStatsCallback=e}_reportResourceUsageStats(){const e={};let t=0;if(this.sendUsageStatsEnabled){const i=this._getSendResourceUsageStats();i&&(e.send=Re({},i),t=Math.max(t,i.timestamp))}if(this.recvUsageStatsEnabled){const i=this._getRecvResourceUsageStats();i&&(e.recv=Re({},i),t=Math.max(t,i.timestamp))}this.resourceUsageStatsReportTimestamp=t,this.resourceUsageStatsCallback(e)}_getSendResourceUsageStats(){if(!this.sendStatsMonitor.isStarted())return;const e=this.sendStatsMonitor.getOutboundRtpStats(),t=1e3/me(0).maxFramerate;let i=0,s=0,a=0,r=E.NONE;for(const[n,o]of e){const e=o.back(),n=Math.max(this.resourceUsageStatsReportTimestamp-500,e.timestamp-be.resourceUsageCheckInterval-500),c=o.find((e=>e.timestamp>n));if(!c)continue;const d=e.framesEncoded-c.framesEncoded,h=e.timestamp-c.timestamp;if(0===d||h<be.resourceUsageMinTimeSlice)continue;const l=e.framesSent-c.framesSent,u=d?1e3*(e.totalEncodeTime-c.totalEncodeTime)/d:0;let m,p,S=E.NONE,g=E.NONE,_=E.NONE;if(g=d>l||d>=be.encodeTimeMinFrameCount&&u>=t*be.encodeTimeFactorThresholdCritical?E.OVERUSING:d<=l&&d>=be.encodeTimeMinFrameCount&&u<t*be.encodeTimeFactorThresholdNormal?E.UNDERUSING:E.NORMAL,e.qualityLimitationDurations&&(m=1e3*(e.qualityLimitationDurations.cpu-c.qualityLimitationDurations.cpu)/h,p=1e3*(e.qualityLimitationDurations.other-c.qualityLimitationDurations.other)/h,_=m>=be.qualityLimitationRatioThresholdCritical||p>=be.qualityLimitationRatioThresholdCritical?E.OVERUSING:m<be.qualityLimitationRatioThresholdNormal&&p<be.qualityLimitationRatioThresholdNormal?E.UNDERUSING:E.NORMAL),S=g,H(_,S)>0&&(S=_),i+=d,s+=l,a=Math.max(a,e.timestamp),H(S,r)>0&&(r=S),r===E.OVERUSING)break}return{usageState:r,framesEncoded:i,framesSent:s,timestamp:a}}_getRecvResourceUsageStats(){if(!this.recvStatsMonitor.isStarted())return;const e=this.recvStatsMonitor.getInboundRtpStats();let t=0,i=0,s=0,a=0,r=E.NONE;for(const[n,o]of e){const e=o.back(),n=Math.max(this.resourceUsageStatsReportTimestamp-500,e.timestamp-be.resourceUsageCheckInterval-500),c=o.find((e=>e.timestamp>n));if(!c)continue;const d=e.timestamp-c.timestamp,h=e.framesReceived-c.framesReceived;if(0===h||d<be.resourceUsageMinTimeSlice)continue;const l=e.framesDropped-c.framesDropped,u=e.framesDecoded-c.framesDecoded,m=d/h;let p=1e3*(e.totalDecodeTime-c.totalDecodeTime);p>=d&&(p=d);const S=u?p/u:0;let g=E.NONE;if(t+=h,i+=l,s+=u,a=Math.max(a,e.timestamp),g=u>=be.decodeTimeMinFrameCount&&S>=m*be.decodeTimeFactorThresholdCritical&&h>u?E.OVERUSING:u>=be.decodeTimeMinFrameCount&&S<m*be.decodeTimeFactorThresholdNormal?E.UNDERUSING:E.NORMAL,H(g,r)>0&&(r=g),r===E.OVERUSING)break}return{usageState:r,framesReceived:t,framesDropped:i,framesDecoded:s,timestamp:a}}}(0,h.A)(be,"sendStatsCacheSize",6),(0,h.A)(be,"recvStatsCacheSize",6),(0,h.A)(be,"resourceUsageMinTimeSlice",4500),(0,h.A)(be,"resourceUsageCheckInterval",5e3),(0,h.A)(be,"encodeTimeMinFrameCount",20),(0,h.A)(be,"encodeTimeFactorThresholdNormal",.9),(0,h.A)(be,"encodeTimeFactorThresholdCritical",1.1),(0,h.A)(be,"qualityLimitationRatioThresholdNormal",.05),(0,h.A)(be,"qualityLimitationRatioThresholdCritical",.95),(0,h.A)(be,"decodeTimeMinFrameCount",20),(0,h.A)(be,"decodeTimeFactorThresholdNormal",.9),(0,h.A)(be,"decodeTimeFactorThresholdCritical",1.1);class Me{constructor(e){this.cacheSize=e.cacheSize||10,this.started=!1,this.selectedCandidatePairId=null,this.roundTripTime=0,this.remoteCandidateId=null,this.networkProtocol=null,this.localCandidateId=null,this.candidateType=null,this.outboundRtpStatsEnabled=!1,this.outboundRtpStatsMap=new Map}reset(){this.resetCandidateStats(),this.resetOutboundRtpStats()}resetCandidateStats(){this.selectedCandidatePairId=null,this.roundTripTime=0,this.remoteCandidateId=null,this.networkProtocol=null}resetOutboundRtpStats(){this.outboundRtpStatsMap.clear()}setOptions(e){const{outboundRtpStatsEnabled:t}=e||{};void 0!==t&&(this.outboundRtpStatsEnabled=t)}start(e){e&&this.setOptions(e),this.started=!0}stop(){this.started=!1}isStarted(){return this.started}getNetworkProtocol(){return this.networkProtocol}getCurrentRoundTripTime(){return this.roundTripTime}getOutboundRtpStats(){return this.outboundRtpStatsMap}onStatsReport(e){if(this.started)switch(e.type){case"transport":this.onTransportStats(e);break;case"candidate-pair":this.onCandidatePairStats(e);break;case"remote-candidate":this.onRemoteCandidateStats(e);break;case"outbound-rtp":this.onOutboundRtpStats(e);break;case"local-candidate":this.onLocalCandidateStats(e)}}onTransportStats(e){const{selectedCandidatePairId:t,dtlsState:i}=e;"connected"===i&&(this.selectedCandidatePairId=t)}onCandidatePairStats(e){const{id:t,state:i,nominated:s,availableOutgoingBitrate:a,currentRoundTripTime:r,remoteCandidateId:n,timestamp:o,localCandidateId:c}=e;t===this.selectedCandidatePairId&&"succeeded"===i&&s&&(this.roundTripTime=r,this.remoteCandidateId=n,this.localCandidateId=c,this.outgoingBitrateStatsCallback({availableOutgoingBitrate:a,timestamp:o}))}onRemoteCandidateStats(e){const{id:t,protocol:i,port:s}=e;if(t===this.remoteCandidateId&&!this.networkProtocol){this.networkProtocol=i;const e="WMSC_Network_Change: send|".concat(i,"|").concat(s);q.globalTrace({logLevel:"log",log:e,tags:["WMSC_Network_Change"]}),q.monitorLog(e)}}onLocalCandidateStats(e){const{id:t,candidateType:i}=e;if(t==this.localCandidateId&&this.candidateType!=i){this.candidateType=i;const e="WMSC_LocalCandidatae_Change:send|".concat(i);q.globalTrace({logLevel:"directReport",log:e,tags:["WMSC_LocalCandidatae_Change"]}),q.monitorLog(e)}}onOutboundRtpStats(e){if(!this.outboundRtpStatsEnabled)return;const{ssrc:t,framesEncoded:i,framesSent:s,totalEncodeTime:a,qualityLimitationDurations:r,timestamp:n}=e;let o=this.outboundRtpStatsMap.get(t);o||(o=new Ce(this.cacheSize),this.outboundRtpStatsMap.set(t,o)),o.push({framesEncoded:i,framesSent:s,totalEncodeTime:a,qualityLimitationDurations:r,timestamp:n})}}class Te{constructor(e){this.cacheSize=e.cacheSize||10,this.started=!1,this.selectedCandidatePairId=null,this.roundTripTime=0,this.remoteCandidateId=null,this.networkProtocol=null,this.localCandidateId=null,this.candidateType=null,this.inboundRtpStatsEnabled=!1,this.inboundRtpStatsMap=new Map}reset(){this.resetCandidateStats(),this.resetInboundRtpStats()}resetCandidateStats(){this.selectedCandidatePairId=null,this.roundTripTime=0,this.remoteCandidateId=null,this.networkProtocol=null}resetInboundRtpStats(){this.inboundRtpStatsMap.clear()}setOptions(e){const{inboundRtpStatsEnabled:t}=e||{};void 0!==t&&(this.inboundRtpStatsEnabled=t)}start(e){e&&this.setOptions(e),this.started=!0}stop(){this.started=!1}isStarted(){return this.started}getNetworkProtocol(){return this.networkProtocol}getCurrentRoundTripTime(){return this.roundTripTime}getInboundRtpStats(){return this.inboundRtpStatsMap}onStatsReport(e){if(this.started)switch(e.type){case"transport":this.onTransportStats(e);break;case"candidate-pair":this.onCandidatePairStats(e);break;case"remote-candidate":this.onRemoteCandidateStats(e);break;case"inbound-rtp":this.onInboundRtpStats(e);break;case"local-candidate":this.onLocalCandidateStats(e)}}onTransportStats(e){const{selectedCandidatePairId:t,dtlsState:i}=e;"connected"===i&&(this.selectedCandidatePairId=t)}onCandidatePairStats(e){const{id:t,state:i,nominated:s,currentRoundTripTime:a,remoteCandidateId:r,localCandidateId:n}=e;t===this.selectedCandidatePairId&&"succeeded"===i&&s&&(this.roundTripTime=a,this.remoteCandidateId=r,this.localCandidateId=n)}onRemoteCandidateStats(e){const{id:t,protocol:i,port:s}=e;if(t===this.remoteCandidateId&&!this.networkProtocol){this.networkProtocol=i;const e="WMSC_Network_Change: recv|".concat(i,"|").concat(s);q.globalTrace({logLevel:"log",log:e,tags:["WMSC_Network_Change"]}),q.monitorLog(e)}}onLocalCandidateStats(e){const{id:t,candidateType:i}=e;if(t==this.localCandidateId&&this.candidateType!=i){this.localCandidateId=t,this.candidateType=i;const e="WMSC_LocalCandidatae_Change:recv|".concat(i);q.globalTrace({logLevel:"directReport",log:e,tags:["WMSC_LocalCandidatae_Change"]}),q.monitorLog(e)}}onInboundRtpStats(e){if(!this.inboundRtpStatsEnabled)return;const{ssrc:t,framesDecoded:i,framesDropped:s,framesReceived:a,keyFramesDecoded:r,totalDecodeTime:n,pliCount:o,timestamp:c}=e;let d=this.inboundRtpStatsMap.get(t);d||(d=new Ce(this.cacheSize),this.inboundRtpStatsMap.set(t,d)),d.push({framesDecoded:i,framesDropped:s,framesReceived:a,keyFramesDecoded:r,totalDecodeTime:n,pliCount:o,timestamp:c})}}const ye=new be;class Le{static mean(e){if(e.length)return e.reduce(((e,t)=>e+t),0)/e.length}static median(e){if(!e.length)return;u()(e).call(e,((e,t)=>e-t));const t=Math.floor(e.length/2);return e.length%2!=0?e[t]:(e[t-1]+e[t])/2}static variance(e){if(!e.length)return;const t=e.reduce(((e,t)=>e+t),0)/e.length,i=e.map((e=>Math.pow(e-t,2)));return i.reduce(((e,t)=>e+t),0)/i.length}static expMovingAverage(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5;if(!e.length)return[];const i=[e[0]];for(let s=1;s<e.length;s++)i.push(t*e[s]+(1-t)*i[s-1]);return i}static bestFitSlope(e){if(e.length<2)return;const t=e.length;let i=0,s=0,a=0,r=0;for(let n=0;n<t;n++)i+=n,s+=e[n],a+=n*e[n],r+=n*n;return(t*a-i*s)/(t*r-i*i)}}function we(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,s)}return i}function De(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?we(Object(i),!0).forEach((function(t){(0,h.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):we(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const Ae=q.getTracer("WmscQosMgr"),Oe=e=>{Ae.log(e),q.monitorLog("".concat(e))},Pe=8e4,Ne=Object.freeze({Hold:0,Increase:1,Decrease:2}),Ve=Object.freeze({None:0,Increase:1,Decrease:2}),Be=Object.freeze({User:0,OutgoingBandwidth:1,ReceiverBandwidth:2,Other:3});class xe{constructor(){this.outgoingBandwidthAdaptationEnabled=!0,this.receiverBandwidthAdaptationEnabled=!0,this.additionalSubLayersEnabled=!0,this.lossDetectionEnabled=!1,this.performanceAdaptationEnabled=!0,this.maxEncodingLayers=3,this.sendActive=!1,this.requestedLayerIds=[],this.additionalSubLayerIds=[],this.layersAllocation=[],this.layersAllocationCache=null,this.layersAllocationUpdateTimeoutId=null,this.isUpdatingLayers=!1,this.maxSubVideoSize=-1,this.maxFeasibleSendSize=4,this.sendUsageAdjustments=new Ce(xe.resourceUsageAdjustmentHistorySize),this.sendUsageIncreaseFailedAttempts=0,this.sendUsageIncreaseFailedTime=0,this.encoderRestartedTime=0,this.maxFeasibleRecvSize=T,this.recvUsageAdjustments=new Ce(xe.resourceUsageAdjustmentHistorySize),this.recvUsageIncreaseFailedAttempts=0,this.recvUsageIncreaseFailedTime=0,this.outgoingBitrateStats=new Ce(xe.outgoingBitrateStatsCacheSize),this.minOutgoingBitrate=Pe,this.outgoingBandwidth=1/0,this.receiverBandwidthReport=null,this.receiverL3BandwidthEvaluation=null,this.receiverBandwidthUpdatePending=!1,this.receiverBandwidthUpdateTimeoutId=null,this.isDualCall=!0,this.receiverStats=new Ce(xe.receiverStatsCacheSize),this.minOutgoingBitrateAdjustments=new Ce(xe.minOutgoingBitrateAdjustmentHistorySize),this.receiverReport=null,this.residualLossDetectedTimestamp=0,this.inherentLossDetectedTimestamp=0,this.minOutgoingBitrateUpdatedTime=0,this.messageCallback=null,this.maxRecvVideoSizeUpdateCallback=null,this.sendUsageStateUpdateCallback=null,ye.registerOutgoingBitrateStatsCallback(this.onOutgoingBandwidthStats.bind(this)),ye.registerResourceUsageStatsCallback(this.onResourceUsageStats.bind(this))}static areLayersAllocationsEqual(e,t){return e.length===t.length&&e.every(((e,i)=>{const s=t[i];return e.layerId===s.layerId&&e.maxBitrate===s.maxBitrate&&(a=e.format,r=s.format,a.width===r.width&&a.height===r.height);var a,r}))}static isBitrateChangeAboveRatio(e,t,i){return!e||Math.abs(t-e)/e>i}resetSendStats(){ye.getSendStatsMonitor().reset()}resetRecvStats(){ye.getRecvStatsMonitor().reset()}_resetLayersAllocation(){this.requestedLayerIds=[],this.additionalSubLayerIds=[],this.layersAllocation=[],this.layersAllocationCache=null,this.isUpdatingLayers=!1}_resetLossDetection(){this.receiverStats.clear(),this.minOutgoingBitrateAdjustments.clear(),this.receiverReport=null,this.residualLossDetectedTimestamp=0,this.inherentLossDetectedTimestamp=0,this.minOutgoingBitrateUpdatedTime=0}_resetBandwidthState(){this._stopReceiverBandwidthUpdateWait(),this.outgoingBitrateStats.clear(),this.minOutgoingBitrate=Pe,this.outgoingBandwidth=1/0,this.receiverBandwidthReport=null,this.receiverL3BandwidthEvaluation=null,this.isDualCall=!0}_resetResourceUsageState(){this.maxFeasibleSendSize=ue(),this.sendUsageAdjustments.clear(),this.sendUsageIncreaseFailedAttempts=0,this.sendUsageIncreaseFailedTime=0,this.maxFeasibleRecvSize=T,this.recvUsageAdjustments.clear(),this.recvUsageIncreaseFailedAttempts=0,this.recvUsageIncreaseFailedTime=0}resetSend(){this._stopReceiverBandwidthUpdateWait(),this._stopPollingLayersAllocation(),this.sendActive=!1,this._resetLayersAllocation(),this._resetLossDetection(),this._resetBandwidthState(),this.resetSendStats()}resetRecv(){this.maxSubVideoSize=-1,this.resetRecvStats()}registerMessageCallback(e){this.messageCallback=e}registerMaxRecvVideoSizeUpdateCallback(e){this.maxRecvVideoSizeUpdateCallback=e}registerSendUsageStateUpdateCallback(e){this.sendUsageStateUpdateCallback=e}setOptions(e){const{outgoingBandwidthAdaptationEnabled:t,receiverBandwidthAdaptationEnabled:i,lossDetectionEnabled:s,performanceAdaptationEnabled:a}=e||{};void 0!==t&&(this.outgoingBandwidthAdaptationEnabled=t),void 0!==i&&(this.receiverBandwidthAdaptationEnabled=i),void 0!==s&&(this.lossDetectionEnabled=s),void 0!==a&&(this.performanceAdaptationEnabled=a)}setMaxEncodingLayers(e){this.maxEncodingLayers=e}setStartBandwidth(e){Ae.log("setStartBandwidth, ".concat(e)),this.outgoingBandwidth=e}start(e){e&&this.setOptions(e);const t={};this.performanceAdaptationEnabled&&(t.sendUsageStatsEnabled=!0,t.recvUsageStatsEnabled=!0),ye.start(t)}stop(){ye.stop(),this.resetSend(),this.resetRecv()}updateLayers(e){Ae.log("updateLayers, ".concat(e)),this.requestedLayerIds=[...e],this.allocateBitrate(this._getAvailableBitrate(),Be.User),this._setSendState(!!e.length)}_setSendState(e){this.sendActive!==e&&(this.sendActive=e,e?this._startPollingLayersAllocation():this.lossDetectionEnabled&&this._resetLossDetection())}async _startPollingLayersAllocation(){await this._sendLastLayersAllocation(),this.sendActive&&(this.layersAllocationUpdateTimeoutId=setTimeout((()=>{this._startPollingLayersAllocation()}),xe.layersAllocationUpdateInterval))}_stopPollingLayersAllocation(){clearTimeout(this.layersAllocationUpdateTimeoutId),this.layersAllocationUpdateTimeoutId=null}updateMaxSubVideoSize(e){this.maxSubVideoSize=e}getMaxFeasibleRecvVideoSize(){return this.maxFeasibleRecvSize}_waitBeforeReceiverBandwidthUpdate(){this.receiverBandwidthUpdatePending=!0,clearTimeout(this.receiverBandwidthUpdateTimeoutId),this.receiverBandwidthUpdateTimeoutId=setTimeout((()=>{this.receiverBandwidthUpdatePending=!1}),xe.receiverBandwidthUpdateDelay)}_stopReceiverBandwidthUpdateWait(){clearTimeout(this.receiverBandwidthUpdateTimeoutId),this.receiverBandwidthUpdateTimeoutId=null,this.receiverBandwidthUpdatePending=!1}getMinBandwidth(){return Pe}onOutgoingBandwidthStats(e){if(!this.outgoingBandwidthAdaptationEnabled||!this.sendActive)return;const{availableOutgoingBitrate:t=1/0,timestamp:i}=e;this.outgoingBitrateStats.push({availableOutgoingBitrate:t,timestamp:i}),this._onOutgoingBandwidth(t)}onResourceUsageStats(e){this.performanceAdaptationEnabled&&(e.send&&this.sendActive&&this._handleSendUsageStats(e.send),e.recv&&this._handleRecvUsageStats(e.recv))}_handleSendUsageStats(e){const{framesEncoded:t,usageState:i,timestamp:s}=e,a=this._getFeasibleSendLayerIds();this.sendUsageStateUpdateCallback&&this.sendUsageStateUpdateCallback(i);let r=Ve.None;i===E.OVERUSING?r=x.isMacIntel?Ve.None:Ve.Decrease:i===E.UNDERUSING&&(r=Ve.Increase);const n=a[a.length-1];this._maybeAdjustMaxSendSize(n,r)&&(Oe("WMSC_VEnc_Cap_Change: ".concat(this.maxFeasibleSendSize)),this.allocateBitrate(this._getAvailableBitrate(),Be.Other))}_handleRecvUsageStats(e){const{usageState:t}=e;let i=Ve.None;t===E.OVERUSING?i=Ve.Decrease:t===E.UNDERUSING&&(i=Ve.Increase),this._maybeAdjustMaxRecvSize(this.maxSubVideoSize,i)&&(Oe("WMSC_VDec_Cap_Change: ".concat(this.maxFeasibleRecvSize)),this.maxRecvVideoSizeUpdateCallback&&this.maxRecvVideoSizeUpdateCallback(this.maxFeasibleRecvSize))}_maybeAdjustMaxSendSize(e,t){const i=Date.now();if(t===Ve.Decrease){const a=he();if(this.maxFeasibleSendSize>a){var s;const r=this.sendUsageAdjustments.back();return this.sendUsageAdjustments.push({layerChange:t,time:i}),(null==r?void 0:r.layerChange)===Ve.Increase&&(this.sendUsageIncreaseFailedAttempts++,this.sendUsageIncreaseFailedTime=r.time,Ae.log("Attempt to increase layer failed ".concat(this.sendUsageIncreaseFailedAttempts," times"))),this.maxFeasibleSendSize=null!==(s=de().findLast((t=>t<e)))&&void 0!==s?s:a,!0}}else if(t===Ve.Increase){const s=ue();var a;if(this.maxFeasibleSendSize<s&&this.sendUsageIncreaseFailedAttempts<xe.resourceUsageIncreaseMaxAttempts&&i-this.sendUsageIncreaseFailedTime>=xe.resourceUsageIncreaseInitialDelay*Math.pow(2,this.sendUsageIncreaseFailedAttempts-1))return this.sendUsageAdjustments.push({layerChange:t,time:i}),this.maxFeasibleSendSize=null!==(a=de().find((t=>t>e)))&&void 0!==a?a:s,!0}return!1}_maybeAdjustMaxRecvSize(e,t){if(e<=T)return!1;const i=Date.now();if(t===Ve.Decrease){const e=this.recvUsageAdjustments.back();if(this.recvUsageAdjustments.push({layerChange:t,time:i}),(null==e?void 0:e.layerChange)===Ve.Increase&&(this.recvUsageIncreaseFailedAttempts++,this.recvUsageIncreaseFailedTime=e.time,Ae.log("Attempt to increase receive size failed ".concat(this.recvUsageIncreaseFailedAttempts," times"))),this.maxFeasibleRecvSize>T)return this.maxFeasibleRecvSize--,!0}else if(t===Ve.Increase&&this.maxFeasibleRecvSize<e&&this.recvUsageIncreaseFailedAttempts<xe.resourceUsageIncreaseMaxAttempts&&i-this.recvUsageIncreaseFailedTime>=xe.resourceUsageIncreaseInitialDelay*Math.pow(2,this.recvUsageIncreaseFailedAttempts-1))return this.recvUsageAdjustments.push({layerChange:t,time:i}),this.maxFeasibleRecvSize++,!0;return!1}onSubInfo(e){const{isDualCall:t}=e;this.onDualCallState(t)}onDualCallState(e){this.isDualCall!==e&&(this.isDualCall=e,Oe("WMSC_Dual_Call_State_Changed: ".concat(e)),e?this._waitBeforeReceiverBandwidthUpdate():this._stopReceiverBandwidthUpdateWait())}isSingleLayerMode(){return 1===this.maxEncodingLayers||this.isDualCall}_evaluateBandwidthDistribution(e,t,i){const s=i.reduce(((e,t)=>e+t),0),a=xe.receiverBandwidthUseRatio,r=Math.floor(t*a),n=function(e){var t;return(null===(t=Se(e))||void 0===t?void 0:t.minBitrate)||0}(e),o=_e(e)*xe.adequateQualityBitrateRatio;let c=0,d=0,h=0;if(r>=o)d=s,h=r;else if(s>0){let e=0,r=0,l=0,u=0,m=0,p=0,S=0;for(let c=i.length-1;c>=0;c--){const d=i[c];d&&(S=S?512*c:t,S>=n&&(e=c,r+=d),S*a>=o&&(l=c,u+=d),p||(m/s<.6?m+=d:p=c))}p<l&&(m-u)/s<.2?(c=l,d=u):p>e?(c=p,d=m):(c=e,d=r),h=d?Math.floor(Math.max(t,512*c)*a):0}else h=o;return{selectedBandwidth:h,selectedAll:h<=r}}onReceiverBandwidthReport(e){if(!this.receiverBandwidthAdaptationEnabled||this.receiverBandwidthUpdatePending)return;const{minBW:t,minL3BW:i}=e;let s=!1;if(this.receiverBandwidthReport&&this.receiverBandwidthReport.minBw===t||(s=!0),this.receiverBandwidthReport={minBw:t,minL3Bw:i},!this.isDualCall&&le(3)){const{selectedBandwidth:e,selectedAll:t}=this.receiverL3BandwidthEvaluation||{};this.receiverL3BandwidthEvaluation=this._evaluateBandwidthDistribution(3,i,[]),this.receiverL3BandwidthEvaluation.selectedAll===t&&this.receiverL3BandwidthEvaluation.selectedBandwidth===e||(s=!0)}this.sendActive&&s&&this.allocateBitrate(this._getAvailableBitrate(),Be.ReceiverBandwidth)}onReceiverReport(e){if(!this.outgoingBandwidthAdaptationEnabled||!this.lossDetectionEnabled||!this.sendActive)return;if(!this.receiverReport)return void(this.receiverReport=e);const{recvPkts:t,preMissingPkts:i,postMissingPkts:s,maxJitterMs:a,maxSeqGap:r,timestampMs:n}=e,o=this.receiverReport,c=t-o.recvPkts,d=i-o.preMissingPkts,h=s-o.postMissingPkts,l=d+c,u={loss:l>0?d/l:0,residualLoss:l>0?h/l:0,jitter:a,sequenceGap:r,timestamp:n};this.receiverStats.push(u),this.receiverReport=e,"udp"===ye.getSendStatsMonitor().getNetworkProtocol()&&this._updateOutgoingBandwidth(this._adjustOutgoingBandwidthForLoss(this.outgoingBandwidth))}_getReceiverMinBandwidth(){return this.receiverBandwidthReport?Math.floor(this.receiverBandwidthReport.minBw*xe.receiverBandwidthUseRatio):1/0}_getSelectedL3Bandwidth(){return this.receiverL3BandwidthEvaluation?this.receiverL3BandwidthEvaluation.selectedBandwidth:1/0}_getOutgoingBandwidthHistory(e){if(this.outgoingBitrateStats.empty())return[];const t=this.outgoingBitrateStats.unwrap(),i=t[t.length-1].timestamp-e;let s=0;for(let e=t.length-1;e>=0;e--)if(t[e].timestamp<i){s=e+1;break}return t.slice(s).map((e=>e.availableOutgoingBitrate))}_getSubLayersForLayer(e){const t=de(),i=[];if(3===e){if(!this.receiverL3BandwidthEvaluation)return i;if(!this.receiverL3BandwidthEvaluation.selectedAll)for(const s of t)s<e&&i.push(s);return i}if(e<3)for(const s of t)s<e&&i.push(s);return i}_maybeUpdateSubLayers(){if(!this.receiverBandwidthAdaptationEnabled||!this.additionalSubLayersEnabled)return!1;const e=[];return this.isSingleLayerMode()||this.requestedLayerIds.forEach((t=>{this._getSubLayersForLayer(t).forEach((t=>{this.requestedLayerIds.includes(t)||e.includes(t)||e.push(t)}))})),!j(this.additionalSubLayerIds,e)&&(this.additionalSubLayerIds=e,!0)}_getAvailableBitrate(){return this.outgoingBandwidthAdaptationEnabled?this.outgoingBandwidth:1/0}_onOutgoingBandwidth(e){this._updateOutgoingBandwidth(e)}_updateOutgoingBandwidth(e){this.outgoingBandwidth!==e&&(this.outgoingBandwidth=e,this.allocateBitrate(this._getAvailableBitrate(),Be.OutgoingBandwidth))}_updateLayersMaxBitrate(e){e.forEach(((t,i)=>{const{layerId:s,format:a}=t,r=i===e.length-1,n=this._getReceiverBandwidth(s),o=r?a.maxBitrate:Math.min(a.maxBitrate,1e3*Math.ceil(a.targetBitrate*(4/3)/1e3));t.maxBitrate=Math.min(o,n),t.receiverLimited=n<o}))}_detectInherentLoss(e){const t=e.findIndex((e=>e.timestamp>this.inherentLossDetectedTimestamp&&e.loss));if(e.length-t>=xe.inherentLossDetectionMinDataPoints){const i=e.slice(t).map((e=>e.loss)),s=i.length?Le.mean(i):0;if(s>=xe.lossThresholdLow&&s<xe.lossThresholdHigh){const e=Le.variance(i);if(Ae.log("loss ratios: ".concat(i,", mean: ").concat(s,", variance: ").concat(e)),e<xe.inherentLossVarianceThresholdHigh)return t}}return-1}_detectOutOfOrder(e){const t=e.findIndex((e=>e.timestamp>this.inherentLossDetectedTimestamp&&e.sequenceGap));if(e.length-t>=xe.outOfOrderDetectionMinDataPoints){const i=e.slice(t).map((e=>e.sequenceGap)),s=Le.mean(i);if(s>=xe.sequenceGapThresholdLow&&s<xe.sequenceGapThresholdHigh)return Ae.log("sequence gaps: ".concat(i,", mean: ").concat(s)),t}return-1}_isOutgoingBandwidthNormal(e){return e>=Math.max(xe.minOutgoingBitrateThresholdLow,this.minOutgoingBitrate*xe.outgoingBitrateFactorThresholdNormalState)}_adjustOutgoingBandwidthForLoss(e){e<this.minOutgoingBitrate&&(e=this.minOutgoingBitrate),this._isOutgoingBandwidthNormal(e)&&this.minOutgoingBitrateAdjustments.clear();const t=this.receiverStats.unwrap(),{residualLoss:i,timestamp:s}=t[t.length-1],a=t.findIndex((e=>e.loss)),r=t.slice(a).map((e=>e.loss)),n=r.length?Le.mean(r):0;if(i&&Ae.log("residual loss: ".concat(i,", mean loss: ").concat(n)),i>=xe.residualLossThresholdMedium){this.residualLossDetectedTimestamp=s;const t=i>=xe.residualLossThresholdHigh?xe.residualLossBitrateFastDecreaseFactor:xe.residualLossBitrateDecreaseFactor;return this._decreaseOutgoingBitrate(Math.floor(e*t))}if(i>=n*xe.residualLossRatioThresholdLow){const i=t.findIndex((e=>e.timestamp>this.residualLossDetectedTimestamp));if(t.reduce(((e,t,a)=>a>=i&&t.residualLoss&&s-t.timestamp<=xe.residualLossMonitorTimeWindow?e+1:e),0)>=xe.residualLossCountThreshold)return this.residualLossDetectedTimestamp=s,this._decreaseOutgoingBitrate(Math.floor(e*xe.residualLossBitrateDecreaseFactor))}if(this.residualLossDetectedTimestamp&&s-this.residualLossDetectedTimestamp<xe.outgoingBitrateIncreaseSuppressionIntervalResidualLoss)return e;const o=this._getOutgoingBitrateDemand();if(e>=o)return e;let c=-1;if(c=this._detectInherentLoss(t),-1===c&&(c=this._detectOutOfOrder(t)),-1!==c&&s-this.inherentLossDetectedTimestamp>=xe.inherentLossDetectionMinInterval){const i=this._getOutgoingBandwidthHistory(s-t[c].timestamp+1500);if(i.length>=xe.inherentLossDetectionMinDataPoints){const t=Le.bestFitSlope(i),a=i[0];if(t<xe.outgoingBitrateMaxSlopeRestoreBandwidth&&a>=e*xe.outgoingBitrateMinFactorRestoreBandwidth)return Ae.log("bandwidth: ".concat(a," -> ").concat(e,", slope: ").concat(t)),this._maybeIncreaseMinOutgoingBitrate(Math.min(o,a)),this.inherentLossDetectedTimestamp=s,e}if(e<xe.minOutgoingBitrateThresholdMedium)return this._maybeIncreaseMinOutgoingBitrate(Math.min(xe.minOutgoingBitrateThresholdMedium,o,Math.floor(e*xe.minOutgoingBitrateIncreaseFactor))),this.inherentLossDetectedTimestamp=s,e}return e}_decreaseOutgoingBitrate(e){return e=Math.max(Pe,e),this._maybeDecreaseMinOutgoingBitrate(e),e}_maybeIncreaseMinOutgoingBitrate(e){return!(this.minOutgoingBitrateAdjustments.unwrap().slice(-3).filter((e=>e===Ne.Decrease)).length>=2)&&(this.minOutgoingBitrateAdjustments.push(Ne.Increase),this._adjustMinOutgoingBitrate(Math.max(xe.minOutgoingBitrateThresholdLow,Math.min(xe.minOutgoingBitrateThresholdHigh,e))))}_maybeDecreaseMinOutgoingBitrate(e){if(e<this.minOutgoingBitrate){this.minOutgoingBitrateAdjustments.push(Ne.Decrease);const t=this.minOutgoingBitrate<=xe.minOutgoingBitrateThresholdLow?Pe:Math.max(Pe,Math.min(e,Math.floor(this.minOutgoingBitrate*xe.minOutgoingBitrateLeastDecreaseFactor)));return this._adjustMinOutgoingBitrate(t)}return!1}async _adjustMinOutgoingBitrate(e){Ae.log("adjust min bitrate: ".concat(this.minOutgoingBitrate," -> ").concat(e));const t=Date.now();if(t-this.minOutgoingBitrateUpdatedTime<xe.minOutgoingBitrateUpdateMinInterval)return;const i=1e3*Math.floor(e/1e3);if(i!==this.minOutgoingBitrate){Ae.log("update min bitrate: ".concat(this.minOutgoingBitrate," -> ").concat(i)),this.minOutgoingBitrateUpdatedTime=t;try{return await this.messageCallback({type:C.MIN_BITRATE_UPDATE,data:i}),this.minOutgoingBitrate=i,!0}catch(e){return Ae.error("update min bitrate error: ".concat(e.message)),!1}}return!1}async _updateLayersAllocation(e){try{return await this.messageCallback({type:C.LAYERS_UPDATE,data:e}),!0}catch(e){return Ae.error("update layers allocation error: ".concat(e.message)),!1}}async _sendLastLayersAllocation(){if(!this.layersAllocationCache||this.isUpdatingLayers)return;const{outgoingBandwidth:e,receiverBandwidthReport:t,layerIds:i,layersAllocation:s}=this.layersAllocationCache;if(this.layersAllocationCache=null,!xe.areLayersAllocationsEqual(this.layersAllocation,s)){this.isUpdatingLayers=!0;const{minBw:a,minL3Bw:r}=t,n="WMSC_Update_Layers_Allocation, bandwidth: S ".concat(e,", R ").concat(a,",").concat(r)+", layers: ".concat(i,", ").concat(s.map((e=>{let{layerId:t,maxBitrate:i,format:s}=e;return"{".concat(t,",").concat(s.width,",").concat(i,"}")})).join(","));Oe(Q(n));const o=await this._updateLayersAllocation(s);this.isUpdatingLayers=!1,o&&(this.layersAllocation=s)}}_getReceiverBandwidth(e){let t=1/0;return this.isSingleLayerMode()?t=this._getReceiverMinBandwidth():3===e&&(t=this._getSelectedL3Bandwidth()),t}_getAdjustedTargetBitrate(e){const t=_e(e),i=this._getReceiverBandwidth(e);return Math.min(t,i)}_getAdjustedMaxBitrate(e){const t=ge(e),i=this._getReceiverBandwidth(e);return Math.min(t,i)}_getSendLayerIds(){var e;return u()(e=[...this.additionalSubLayerIds,...this.requestedLayerIds]).call(e)}_getFeasibleSendLayerIds(){const e=this._getSendLayerIds(),t=[];for(const i of e){if(i>this.maxFeasibleSendSize){t[t.length-1]!==this.maxFeasibleSendSize&&t.push(this.maxFeasibleSendSize);break}t.push(i)}return t}_getTotalMaxBitrate(e){let t=0;for(let i=0;i<e.length;i++)i===e.length-1?t+=this._getAdjustedMaxBitrate(e[i]):t+=this._getAdjustedTargetBitrate(e[i]);return t}_getOutgoingBitrateDemand(){const e=this._getFeasibleSendLayerIds();return this._getTotalMaxBitrate(e)}_allocateBitrateToLayers(e,t){const i=de(),s=i[0],a=[];let r=e,n=-1;const o=e=>{const t=this._getReceiverBandwidth(e),i=function(e){var t,i;return null!==(i=null===(t=ce())||void 0===t?void 0:t.filter((t=>t.layerId===e)))&&void 0!==i?i:[]}(e);for(const s of i)if(r>=s.minBitrate&&t>=s.minBitrate&&a.length<this.maxEncodingLayers)return a.push({layerId:e,format:s}),r-=s.targetBitrate,n=e,!0;return!1};for(const e of t)if(!o(e)){const t=-1===n?s:n+1;for(let s=e-1;s>=t&&i.includes(s)&&!o(s);s--);break}return r>0&&t.length&&!a.length&&a.push({layerId:s,format:Se(s)}),this._updateLayersMaxBitrate(a),a}_reallocateBitrateToLayers(e,t,i){let s=0,a=0,r=0,n=!1,o=!1;if(t.forEach(((e,i)=>{r+=i===t.length-1?ge(e):_e(e)})),i.forEach(((e,t)=>{const{layerId:r,format:c,receiverLimited:d}=e,h=t===i.length-1,l=this._getReceiverBandwidth(r);d&&(n=!0),h?((l<c.minBitrate||l>c.maxBitrate)&&(o=!0),s+=c.minBitrate,a+=c.maxBitrate):(l<c.minBitrate&&(o=!0),s+=c.targetBitrate,a+=c.targetBitrate)})),(!n||!o)&&(e>=r||e>=s&&e<=a)){const e=[...i];return this._updateLayersMaxBitrate(e),e}return this._allocateBitrateToLayers(e,t)}allocateBitrate(e,t){var i;const s=this._maybeUpdateSubLayers(),a=this._getFeasibleSendLayerIds(),r=(null===(i=this.layersAllocationCache)||void 0===i?void 0:i.layersAllocation)||this.layersAllocation;let n;n=s||!r.length||t!==Be.OutgoingBandwidth&&t!==Be.ReceiverBandwidth?this._allocateBitrateToLayers(e,a):this._reallocateBitrateToLayers(e,a,r),n&&(this.layersAllocationCache={outgoingBandwidth:this.outgoingBandwidth,receiverBandwidthReport:De({},this.receiverBandwidthReport),layerIds:a,layersAllocation:n,reason:t})}}(0,h.A)(xe,"availableBitrateChangeRatioThresholdLow",.08),(0,h.A)(xe,"availableBitrateUpdateMinInterval",1e3),(0,h.A)(xe,"layersAllocationUpdateInterval",300),(0,h.A)(xe,"resourceUsageAdjustmentHistorySize",6),(0,h.A)(xe,"resourceUsageIncreaseInitialDelay",6e4),(0,h.A)(xe,"resourceUsageIncreaseMaxAttempts",6),(0,h.A)(xe,"encodingTimeout",3e3),(0,h.A)(xe,"encoderRestartMinInterval",3e4),(0,h.A)(xe,"outgoingBitrateStatsCacheSize",8),(0,h.A)(xe,"receiverBandwidthUseRatio",.9),(0,h.A)(xe,"receiverBandwidthUpdateDelay",1500),(0,h.A)(xe,"adequateQualityBitrateRatio",.6),(0,h.A)(xe,"lossThresholdLow",.08),(0,h.A)(xe,"lossThresholdHigh",.6),(0,h.A)(xe,"receiverStatsCacheSize",6),(0,h.A)(xe,"minOutgoingBitrateAdjustmentHistorySize",5),(0,h.A)(xe,"outgoingBitrateFactorThresholdNormalState",1.5),(0,h.A)(xe,"outgoingBitrateMaxSlopeRestoreBandwidth",-1e5),(0,h.A)(xe,"outgoingBitrateMinFactorRestoreBandwidth",1.5),(0,h.A)(xe,"outgoingBitrateIncreaseSuppressionIntervalResidualLoss",15e3),(0,h.A)(xe,"minOutgoingBitrateUpdateMinInterval",900),(0,h.A)(xe,"minOutgoingBitrateThresholdLow",25e4),(0,h.A)(xe,"minOutgoingBitrateThresholdMedium",1e6),(0,h.A)(xe,"minOutgoingBitrateThresholdHigh",2e6),(0,h.A)(xe,"minOutgoingBitrateLeastDecreaseFactor",.8),(0,h.A)(xe,"minOutgoingBitrateIncreaseFactor",1.15),(0,h.A)(xe,"residualLossRatioThresholdLow",.05),(0,h.A)(xe,"residualLossThresholdMedium",.05),(0,h.A)(xe,"residualLossThresholdHigh",.15),(0,h.A)(xe,"residualLossMonitorTimeWindow",6e3),(0,h.A)(xe,"residualLossCountThreshold",2),(0,h.A)(xe,"residualLossBitrateDecreaseFactor",.8),(0,h.A)(xe,"residualLossBitrateFastDecreaseFactor",.64),(0,h.A)(xe,"inherentLossDetectionMinDataPoints",3),(0,h.A)(xe,"inherentLossDetectionMinInterval",3e3),(0,h.A)(xe,"inherentLossVarianceThresholdHigh",.02),(0,h.A)(xe,"outOfOrderDetectionMinDataPoints",3),(0,h.A)(xe,"sequenceGapThresholdLow",10),(0,h.A)(xe,"sequenceGapThresholdHigh",80);const Ue=new xe,ke=q.getTracer("WmscMediaMgr"),We=e=>{ke.log(e),q.monitorLog("".concat(e))},Fe=new class{constructor(){var e,t;this.videoPublished=!1,this.mediaRequested=!1,this.hdVideoEnabled=!1,this.maxSendLayerId=4,this.sourceVideoSettings={},this.pcs=new Map,this.videoMid=null,this.sendTransceivers=new Map,this.recvTransceivers=new Map,this.messageCallback=null,this.requestedLayerIds=[],this.sendLayerIds=[],this.encodingMap=new Map,this.timeCostMap=new Map,this.recvCodecNum=0,this.senderCodec=null,this.isSupportHi444PP=!1,this.headerExtMap=new Map,this.recvPreferCodecs=(null===(e=RTCRtpReceiver.getCapabilities("video"))||void 0===e||null===(e=e.codecs)||void 0===e?void 0:e.filter((e=>{let{mimeType:t,sdpFmtpLine:i}=e;if(-1!==t.indexOf("red")||-1!==t.indexOf("fec")||"video/rtx"===t)return!0;const s=i?i.toLowerCase():"";return!("video/H264"!==t||!s||-1===s.indexOf("packetization-mode=1")||(-1!==s.indexOf("profile-level-id=f400")&&(this.isSupportHi444PP=!0),this.recvCodecNum++,0))})))||[],"Chrome"!==ie.browser||ie.isBrowserVersionGreaterEqualThan(124,0)||null===(t=RTCRtpSender.getCapabilities("video"))||void 0===t||null===(t=t.codecs)||void 0===t||t.some((e=>{const{mimeType:t,sdpFmtpLine:i}=e;return"video/H264"===t&&-1!==i.indexOf("profile-level-id=42")&&(this.senderCodec=e,!0)})),Ue.registerMessageCallback(this.onQosMessage.bind(this))}getSendEncodings(e){switch(e){case 1:return[{active:!1}];case 2:return[{active:!1,scaleResolutionDownBy:2},{active:!1,scaleResolutionDownBy:1}];default:return[{active:!1,scaleResolutionDownBy:4},{active:!1,scaleResolutionDownBy:2},{active:!1,scaleResolutionDownBy:1}]}}getDefaultEncodingIndex(e){return e<=1?0:2===e?1:2}getEncodingIndex(e){return this.layerEncodingIndexMap.get(e)}_configSimulcastLayers(e,t){this.numSimulcastLayers=e,this.layerEncodingIndexMap=t}setDefaultVideoSettings(){!function(e){const t=e?re.filter((e=>{let{width:t,height:i}=e;return!((s={width:t,height:i}).width*s.height<57600);var s})):re;t.length&&(t[t.length-1].minBitrate=6e4),ne(t)}("Safari"===ie.browser&&"macOS"===ie.os),oe([1,2,3]),this._configSimulcastLayers(3,new Map([[1,0],[2,1],[3,2]])),this.resendVideo()}setVideoSettings(e){var t;const{maxEncodingLayers:i,layersSettings:s}=e||{};if(i>0&&Ue.setMaxEncodingLayers(i),null==s||!s.length)return void this.setDefaultVideoSettings();const a=u()(s).call(s,((e,t)=>Math.min(t.width,t.height)-Math.min(e.width,e.height))),r=a.reduce(((e,t)=>Math.min(t.maxFramerate,e)),30);for(let e=0;e<a.length;e++){const{width:t,height:i,minBitrate:s,maxBitrate:n}=a[e],o=fe({width:t,height:i});a[e].layerId=o,a[e].maxFramerate=r,void 0===n&&(a[e].maxBitrate=ve(o,{width:t,height:i}),a[e].targetBitrate=a[e].maxBitrate),void 0===s&&(a[e].minBitrate=e>0?a[e-1].maxBitrate:6e4)}const n=new Map;a.forEach((e=>{const{layerId:t}=e,i=this.getDefaultEncodingIndex(t);n.get(t)?t.push(t):n.set(i,[t])}));const o=n.size,c=Array.from(n.keys()),d=new Map;for(let e=0;e<o;e++)n.get(c[e]).forEach((t=>{d.set(t,e)}));ne(a),oe(u()(t=Array.from(d.keys())).call(t)),this._configSimulcastLayers(o,d),this.resendVideo()}registerMessageCallback(e){this.messageCallback=e}getPc(e){return this.pcs.get(e)}getIngressPc(){return this.pcs.get(c.INGRESS)}getEgressPc(){return this.pcs.get(c.EGRESS)}getSendTransceivers(){return this.sendTransceivers}getSender(e){var t;return null===(t=this.sendTransceivers.get(e))||void 0===t?void 0:t.sender}getRecvTransceivers(){return this.recvTransceivers}getReceiver(e){var t;return null===(t=this.recvTransceivers.get(e))||void 0===t?void 0:t.receiver}getRemoteSourceId(e){var t;const i=this.getReceiver(e).getContributingSources(),s=parseInt(null===(t=i[0])||void 0===t?void 0:t.source,10);return isNaN(s)?void 0:s}enableHdVideo(e){We("WMSC_Enable_HD_Video: ".concat(e)),this.hdVideoEnabled=e,this.resendVideo()}setMaxSendLayerId(e){this.maxSendLayerId=e,this.sendLayerIds=this._reduceRequestLayerIds(this.requestedLayerIds)}async publishVideoTrack(e,t){e?(this.sourceVideoSettings=t,await this._replaceVideoTrack(e)):await this._replaceVideoTrack(null),this._onVideoPublished(!!e)}async _replaceVideoTrack(e){const t=this.getSender(this.videoMid),i=e?"{ kind: ".concat(e.kind,", id: ").concat(e.id,", enabled: ").concat(e.enabled,", muted: ").concat(e.muted)+", contentHint: ".concat(e.contentHint," }"):"";if(We(Q("WMSC_Replace_Video_Track: sender: ".concat(!!t," track: ").concat(i))),t)return t.replaceTrack(e)}_onVideoPublished(e){this.videoPublished=e,this.mediaRequested&&(e?this._onVideoStart():this._onVideoStop())}_onVideoStart(){ke.log("_onVideoStart"),Ue.updateLayers(this.sendLayerIds)}_onVideoStop(){ke.log("_onVideoStop"),Ue.updateLayers([])}_onEgressPcClose(){ke.log("_onEgressPcClose"),this.sendTransceivers.clear(),this.videoPublished=!1}_onIngressPcClose(){ke.log("_onIngressPcClose"),this.recvTransceivers.clear()}_reduceRequestLayerIds(e){var t;if(!e.length)return e;const i=new Map,s=he(),a=ue(),r=Math.min(this.maxSendLayerId,this.hdVideoEnabled?a:Math.min(2,a));return e.map((e=>{let t=Math.max(s,Math.min(r,e));for(;!le(t);)--t;return t})).forEach((e=>{const t=this.getEncodingIndex(e),s=i.get(t);(void 0===s||e<s)&&i.set(t,e)})),u()(t=Array.from(i.values())).call(t)}onMediaRequest(e){const t=!!e.length;this.requestedLayerIds=[...e];const i=this._reduceRequestLayerIds(e);We(Q("WMSC_New_Media_Request: layer ids: ".concat(JSON.stringify(e)," -> ").concat(JSON.stringify(i)))),this.sendLayerIds=i,this.mediaRequested!==t?(this.mediaRequested=t,this.videoPublished&&(t?this._onVideoStart():this._onVideoStop())):this.videoPublished&&t&&Ue.updateLayers(this.sendLayerIds)}resendVideo(){this.requestedLayerIds.length&&this.onMediaRequest(this.requestedLayerIds)}async onQosMessage(e){switch(e.type){case C.LAYERS_UPDATE:return this.onLayersAllocationUpdate(e.data);case C.MIN_BITRATE_UPDATE:return this.updateMinOutgoingBitrate(e.data)}}async onLayersAllocationUpdate(e){this.encodingMap.clear(),e.forEach((e=>{const t=this.getEncodingIndex(e.layerId);this.encodingMap.set(t,e)})),await this._updateSendParameters()}async updateMinOutgoingBitrate(e){const t=this.getEgressPc();if(!t)throw new Error("Egress peer connection has not been created");We("WMSC_Update_Min_Bitrate: ".concat(e)),Ue.resetSendStats();const i=ae.parseSdp(t.remoteDescription.sdp);ae.updateCodecParameters(i,"video","recvonly","H264",new Map([["x-google-min-bitrate",Math.floor(e/1e3)]]));const s=ae.writeSdp(i);try{await t.setLocalDescription(t.localDescription),await t.setRemoteDescription({type:"answer",sdp:s})}catch(e){return q.globalTrace({logLevel:"error",log:"WMSC_UMOBF: ".concat(e.message)}),We("WMSC_UMOBF"),Promise.reject(e)}}async _updateSendParameters(){const e=this.getSender(this.videoMid);if(null==e||!e.track)return void We("WMSC_USPTNP: ".concat(!!e));const{width:t,height:i}=this.sourceVideoSettings,s=Math.max(t,i);let a="WMSC_Update_Send_Params:";const r=e.getParameters();r.encodings.forEach(((e,t)=>{const i=this.encodingMap.get(t);if(e.active=!!i,e.active){const{layerId:r,maxBitrate:n,format:o}=i,c=Math.max(1,s/Math.max(o.width,o.height));e.maxBitrate=n,e.scaleResolutionDownBy=c,e.maxFramerate=Math.min(this.sourceVideoSettings.frameRate,function(e){var t;return(null===(t=pe(e))||void 0===t?void 0:t.maxFramerate)||0}(r)),a+=" index ".concat(t,": ").concat(r,",").concat(e.maxBitrate,",").concat(e.maxFramerate)+",".concat(e.scaleResolutionDownBy)}})),r.degradationPreference="maintain-resolution",We(Q(a));try{await e.setParameters(r)}catch(e){return q.globalTrace({logLevel:"error",log:"WMSC_SETPARAMSE",errorEvent:e}),We("WMSC_SETPARAMSE"),Promise.reject(e)}}_getEgressRemoteCodecParams(){const e=Ue.getMinBandwidth();return new Map([["x-google-min-bitrate",Math.floor(e/1e3)],["x-google-per-layer-pli",1]])}_getIngressLocalCodecParams(){return new Map([["sps-pps-idr-in-keyframe",1]])}createPeerConnection(e,t,i,s,a){if(We("WMSC_Start_Create_PC: ".concat(e)),this.getPc(e))return ke.error("WMSC_PC_Existed, PC ".concat(e," has been created, cannot create new one")),We("WMSC_PC_Existed: ".concat(e)),!1;const r=new RTCPeerConnection({bundlePolicy:"max-bundle",iceServers:a});if(We("WMSC_PC_Create_Success: ".concat(e)),e===c.INGRESS){for(let e=0;e<s;e++){const s=r.addTransceiver(t,{direction:i}),a=e.toString();this.recvTransceivers.set(a,s);try{let e=this.recvPreferCodecs;this.senderCodec&&(e=[...this.recvPreferCodecs,this.senderCodec]),this.recvCodecNum>0&&s.setCodecPreferences(e)}catch(e){q.globalTrace({logLevel:"error",log:"WMSC_CODECPREFERENCE_ERROR",errorEvent:e}),We("WMSC_CPE")}}Ue.resetRecv()}else{const e=r.addTransceiver(t,{direction:i,sendEncodings:this.getSendEncodings(this.numSimulcastLayers)}),s="0";this.sendTransceivers.set(s,e),this.videoMid=s,Ue.resetSend()}return this.pcs.set(e,r),r.onicecandidate=e=>{},r.ontrack=this.onRemoteStream.bind(this,e),r.onconnectionstatechange=this.onconnectionstatechange.bind(this,e),r.onsignalingstatechange=this.onsignalingstatechange.bind(this,e),r.oniceconnectionstatechange=t=>{const i=t.target.iceConnectionState;ke.log("oniceconnectionstatechange, peerId: ".concat(e," state: ").concat(i)),We("WMSC_ICESTATE: ".concat(e,"|").concat(i)),"failed"===i&&q.globalTrace({logLevel:"error",log:"WMSC_ICE_State_Error: ".concat(e,"|").concat(i)})},r.onnegotiationneeded=t=>{ke.log("onnegotiationneeded, peerId: ".concat(e)),We("WMSC_onnegotiationneeded: ".concat(e))},r.onicegatheringstatechange=t=>{const{iceGatheringState:i}=t.target;We("WMSC_CANDGA: ".concat(e,"|").concat(i))},r.onicecandidateerror=t=>{const{errorCode:i,errorText:s,url:a}=t;We("WMSC_onicecandidateerror: ".concat(e,"|").concat(i)),q.globalTrace({logLevel:"error",log:"WMSC_onicecandidateerror: ".concat(i,"|").concat(s,"|").concat(a)})},r}onconnectionstatechange(e,t){const i=t.target.connectionState;ke.log("WMSC_onconnectionstatechange, peerId: ".concat(e," state: ").concat(i)),We("WMSC_onconnectionstatechange: ".concat(e,"|").concat(i)),this._handlePcStateChange(e,i)}_handlePcStateChange(e,t){let i="";switch(t){case"connecting":setTimeout((()=>{const i=this.getPc(e);"connecting"===(null==i?void 0:i.connectionState)&&this.messageCallback({type:I.PC_STATE_CHANGE,data:t,peerId:e})}),m);break;case"connected":{this.messageCallback({type:I.PC_STATE_CHANGE,data:t,peerId:e});const i=this.timeCostMap.get(e);if(i){const t=performance.now();i.push(t);const s=this.getNegotiationTime(e);q.globalTrace({logLevel:"directReport",log:"peerId: ".concat(e,"|result: ").concat(s),tags:["WMSC Negotiation time"]}),We("WMSCNT-".concat(e,"-").concat(s.join("-"))),this.timeCostMap.delete(e)}break}case"disconnected":setTimeout((()=>{const i=this.getPc(e);"disconnected"===(null==i?void 0:i.connectionState)&&this.messageCallback({type:I.PC_STATE_CHANGE,data:t,peerId:e})}),p);break;case"failed":this.messageCallback({type:I.PC_STATE_CHANGE,data:t,peerId:e}),i="WMSC_PC_State_Failed: ".concat(e,"-").concat(this.getNegotiationTime().join("-")),We(i),q.globalTrace({logLevel:"error",log:i}),this.timeCostMap.delete(e)}}onsignalingstatechange(e,t){const{signalingState:i}=t.target;ke.log("WMSC_onsignalingstatechange: peerId; ".concat(e," state: ").concat(i)),We("WMSC_onsignalingstatechange: ".concat(e,"|").concat(i))}onRemoteStream(e,t){this.messageCallback&&this.messageCallback({type:I.STREAM,data:t,peerId:e})}async createOffer(e,t){const i=this.getPc(e);if(!i)throw new Error("Peer connection has not been created, peerId: ".concat(e));let s="";try{var a;const n=[performance.now()];this.timeCostMap.set(e,n);const o=await i.createOffer(t);n.push(performance.now()),We("WMSC_CO: ".concat(e));const d=ae.parseSdp(o.sdp);if(e===c.INGRESS){const e=Ie("recv");ae.filterCodecs(d,(t=>{const{codecName:i,codecParams:s}=t;if("flexfec-03"===i)return!0;if("H264"===i){if(e&&this.isSupportHi444PP){const e=s.get("profile-level-id");return parseInt(null==e?void 0:e.substring(0,2),16)!==parseInt("64",16)}return!0}return!1})),ae.mungeIngressLocalOffer(d,this._getIngressLocalCodecParams())}else{const e=Ie("send");ae.filterCodecs(d,(t=>{const{codecName:i,codecParams:s}=t;if("H264"===i){if(e){const e=s.get("profile-level-id");return parseInt(null==e?void 0:e.substring(0,4),16)===parseInt("42e0",16)}return!0}return!1})),ae.mungeEgressLocalOffer(d,this.numSimulcastLayers,!i.currentRemoteDescription)}(null===(a=d.media[0])||void 0===a||null===(a=a.codecs)||void 0===a?void 0:a.some((e=>{let{codecName:t}=e;return"H264"===t})))||this.messageCallback({type:I.NO_H264_CODEC,peerId:e});const h=this.headerExtMap.get(e);var r;return h&&d.media.forEach((e=>{e.extensionMap=h})),s=o.sdp=ae.writeSdp(d),await i.setLocalDescription(o),n.push(performance.now()),We("WMSC_SLDS: ".concat(e)),ke.log("createOffer, peerId: ".concat(e,", local offer sdp: ").concat(i.localDescription.sdp)),e!==c.INGRESS&&ae.mungeEgressOfferToRemote(d),h||this.headerExtMap.set(e,null===(r=d.media[0])||void 0===r?void 0:r.extensionMap),ae.writeSdp(d)}catch(t){return ke.error(t),z(s,M.GZIP_BASE64).then((i=>{q.globalTrace({logLevel:"error",log:"WMSC_OFSLDF: peerId: ".concat(e,"|error: ").concat(t.message,"|sdp: ").concat(i)})})).catch((()=>{q.globalTrace({logLevel:"error",log:"WMSC_OFSLDF: peerId: ".concat(e,"|error: ").concat(t.message,"|sdp: ").concat(s)})})),We("WMSC_OFSLDF: ".concat(e)),Promise.reject(t)}}async setAnswer(e,t){const i=this.timeCostMap.get(e);null==i||i.push(performance.now());const s=this.getPc(e);if(!s)throw new Error("Peer connection has not been created, peerId: ".concat(e));const a=ae.parseSdp(t);if(e===c.EGRESS){ae.mungeEgressAnswer(a,this._getEgressRemoteCodecParams());const e=a.media.find((e=>e.mid===this.videoMid));if(e){const t=ae.getMediaStartBandwidth(e);t&&Ue.setStartBandwidth(t)}}const r=ae.writeSdp(a);ke.log("setAnswer, peerId: ".concat(e,", answer sdp: ").concat(r));try{await s.setRemoteDescription({type:"answer",sdp:r}),null==i||i.push(performance.now()),We("WMSC_SRDS: ".concat(e))}catch(t){return ke.error(t),z(r,M.GZIP_BASE64).then((i=>{q.globalTrace({logLevel:"error",log:"WMSCSRDF: peerId: ".concat(e,", errorMsg:").concat(t.message,", sdp: ").concat(i)})})).catch((()=>{q.globalTrace({logLevel:"error",log:"WMSCSRDF: peerId: ".concat(e,", errorMsg:").concat(t.message,", sdp: ").concat(r)})})),We("WMSC_SRDF: ".concat(e)),Promise.reject(t)}}closePeerConnection(e){var t;We("WMSC_Close_PC: ".concat(e)),null===(t=this.pcs.get(e))||void 0===t||t.close(),this.pcs.delete(e),this.headerExtMap.delete(e),e===c.EGRESS?this._onEgressPcClose():this._onIngressPcClose()}getNegotiationTime(e){const t=this.timeCostMap.get(e),i=[];if(t){const e=t.length;for(let s=0;s<e-1;s++)i.push(Math.round(t[s+1]-t[s]));i.push(Math.round(performance.now()-t[0]))}return i}removeRecvCodecByProfile(e){this.recvCodecNum=0,this.recvPreferCodecs=this.recvPreferCodecs.filter((t=>{let{mimeType:i,sdpFmtpLine:s}=t;return"video/H264"!==i||-1===s.toLowerCase().indexOf("profile-level-id=".concat(e))&&(this.recvCodecNum++,!0)})),this.recvCodecNum>0&&this.getPc(c.INGRESS).getTransceivers().forEach((e=>{e.setCodecPreferences(this.recvPreferCodecs)}))}},Ge=1,ze=2,je=4,He=5,Qe=6,qe=110,Ye=206,Je=32769,Ke=32770;var Xe=i(4258),Ze=i.n(Xe);const $e=q.getTracer("WmscMidMgr"),et=e=>{$e.log(e),q.monitorLog("".concat(e))};class tt{constructor(e){this.mIdUsedStatus={},null==e||e.forEach((e=>{this.mIdUsedStatus[e]={userId:0,group:null,used:!1,videoStream:null,videoSize:-1,released:!0}})),this.user2VideoDom=new Map,this.hasPausedVideo=!1,this.activeSpeakerMId=b,this.userId2mId=new Map,this.userId2mId.set(1,"0"),this.hwDecoderLimit=w}getNewMId(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=this.userId2mId.get(e);if(void 0===i){let e="",t="";for(const s in this.mIdUsedStatus){const{used:a,released:r,preUserId:n}=this.mIdUsedStatus[s];if("0"!==s){if(!a){if(!n){i=s;break}r&&!e?e=s:t||(t=s)}if(parseInt(s,10)===this.hwDecoderLimit-1&&(e||t))break}}i||(i=e||t)}return i&&!this.mIdUsedStatus[i].used&&this._assignMid(i,e,t),i}_assignMid(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this.mIdUsedStatus[e].userId=t,this.mIdUsedStatus[e].group=i,this.mIdUsedStatus[e].used=!0,t===R&&(this.activeSpeakerMId=e);const{preUserId:s}=this.mIdUsedStatus[e];return s&&this.userId2mId.delete(s),this.userId2mId.set(t,e),e}releaseMId(e){const t=this.mIdUsedStatus[e];t&&(t.group=null,t.preUserId=t.userId,t.userId=0,t.used=!1,t.videoSize=-1)}getMId(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const i=this.userId2mId.get(e);return void 0===i||this.mIdUsedStatus[i].userId!==e||this.mIdUsedStatus[i].group!==t?"":i}getUserId(e){return{userId:this.mIdUsedStatus[e].userId,group:this.mIdUsedStatus[e].group}}getVideoTags(e){const t=this.mIdUsedStatus[e].userId;if(t)return this.user2VideoDom.get(t)}saveVideoTag(e,t){const i=this.user2VideoDom.get(e)||[];i.push(t),this.user2VideoDom.set(e,i);for(const i in this.mIdUsedStatus)if(this.mIdUsedStatus[i].userId===e){this._setVideoTagStream(t,this.mIdUsedStatus[i].videoStream,e);break}}removeVideoTag(e,t){const i=this.user2VideoDom.get(e);if(i){for(let e=0;e<i.length;)i[e]===t?i.splice(e,1):e++;i.length||this.user2VideoDom.delete(e)}}updateUserId(e,t){const i=this.mIdUsedStatus[e];i&&(i.userId=t)}_setVideoTagStream(e,t,i){(!e.srcObject||e.srcObject&&t&&e.srcObject!==t)&&(e.srcObject=t,e.onpause=()=>{et("WMSC_V_Tag_Pause: ".concat(i,"|").concat(document.hidden,"|").concat(document.visibilityState)),this.hasPausedVideo=!0})}updateVideoElement(e){if(this.mIdUsedStatus[e]){const t=this.mIdUsedStatus[e].userId,i=this.mIdUsedStatus[e].videoStream;(this.user2VideoDom.get(t)||[]).forEach((e=>{this._setVideoTagStream(e,i,t)}))}}updateStream(e,t){this.mIdUsedStatus[e]&&(this.mIdUsedStatus[e].videoStream=t)}setVideoSize(e,t){this.mIdUsedStatus[e].videoSize=t}getVideoSizeByUserId(e){const t=this.userId2mId.get(e);return t?this.mIdUsedStatus[t].videoSize:-1}getVideoByUserId(e){if(e)return this.user2VideoDom.get(e)}getUserIdByElem(e){let t=-1;return this.user2VideoDom.forEach(((i,s)=>{for(let a=0;a<i.length;a++)if(e===i[a]){t=s;break}})),t}getHasPausedVideo(){var e;return this.hasPausedVideo||Ze()(e=Array.from(this.user2VideoDom.values())).call(e).some((e=>e.paused))}playAllUsedVideoTag(){var e;const t=Ze()(e=Array.from(this.user2VideoDom.values())).call(e).map((e=>{var t;if("visible"===document.visibilityState&&e.paused){const i=(null===(t=null==e?void 0:e.srcObject)||void 0===t?void 0:t.active)||!1;if(!(null==e?void 0:e.srcObject)||!i){const t=this.getUserIdByElem(e);return et("WMSC_V_Tag_C_P: ".concat(t,"|").concat(!!(null==e?void 0:e.srcObject),"ï½œ").concat(i)),Promise.reject(t)}return e.play().then((()=>Promise.resolve())).catch((t=>{const i=this.getUserIdByElem(e);return Promise.reject("".concat(i,"|errorName:").concat(null==t?void 0:t.name,"|errorMessage:").concat(null==t?void 0:t.message))}))}return null})).filter((e=>!!e));return t.length<=0?Promise.resolve():Promise.all(t).then((()=>(this.hasPausedVideo=!1,Promise.resolve()))).catch((e=>(this.hasPausedVideo=!0,Promise.reject(e))))}setMidReleasedStatus(e,t){this.mIdUsedStatus[e]&&(this.mIdUsedStatus[e].released=t)}getMidReleasedStatus(e){var t;return null===(t=this.mIdUsedStatus[e])||void 0===t?void 0:t.released}changeHWDecodeLimit(e){if(e===y&&("Edge"===ie.browser||"Chrome"===ie.browser)){if("macOS"===ie.os||"Windows"===ie.os)return void(this.hwDecoderLimit=8);if("ChromeOS"===ie.os)return void(this.hwDecoderLimit=16)}this.hwDecoderLimit=w}}const it=new class{constructor(){this.sendVideoSizeLowerLimit=0,this.sendVideoSizeUpperLimit=4,this.recvVideoSizeLowerLimit=0,this.recvVideoSizeUpperLimit=4,this.recvVideoNumLowerLimit=4,this.recvVideoNumUpperLimit="Android"===ie.os?D:L,this.sendVideoSizeLowerLimitApp=this.sendVideoSizeLowerLimit,this.sendVideoSizeUpperLimitApp=this.sendVideoSizeUpperLimit,this.recvVideoSizeLowerLimitApp=this.recvVideoSizeLowerLimit,this.recvVideoSizeUpperLimitApp=this.recvVideoSizeUpperLimit,this.recvVideoNumLowerLimitApp=this.recvVideoNumLowerLimit,this.recvVideoNumUpperLimitApp=this.recvVideoNumUpperLimit,this.maxSendVideoSize=0,this.maxRecvVideoSize=0,this.maxRecvVideoNum=0,this._reset()}_reset(){let e=3;!ie.isMobile&&ie.hardwareConcurrency>=8&&(e=4),this.maxSendVideoSize=Math.max(this.sendVideoSizeLowerLimit,this.sendVideoSizeLowerLimitApp,Math.min(this.sendVideoSizeUpperLimit,this.sendVideoSizeUpperLimitApp,e)),this.maxRecvVideoSize=Math.max(this.recvVideoSizeLowerLimit,this.recvVideoSizeLowerLimitApp,Math.min(this.recvVideoSizeUpperLimit,this.recvVideoSizeUpperLimitApp,4)),this.maxRecvVideoNum=Math.max(this.recvVideoNumLowerLimit,this.recvVideoNumLowerLimitApp,Math.min(this.recvVideoNumUpperLimit,this.recvVideoNumUpperLimitApp))}setLimits(e){const{minSendVideoSize:t,maxSendVideoSize:i,minRecvVideoSize:s,maxRecvVideoSize:a,minRecvVideoNum:r,maxRecvVideoNum:n}=e;void 0!==t&&(this.sendVideoSizeLowerLimitApp=t),void 0!==i&&(this.sendVideoSizeUpperLimitApp=i),void 0!==s&&(this.recvVideoSizeLowerLimitApp=s),void 0!==a&&(this.recvVideoSizeUpperLimitApp=a),void 0!==r&&(this.recvVideoNumLowerLimitApp=r),void 0!==n&&(this.recvVideoNumUpperLimitApp=n),this._reset()}getCapabilities(){return{maxSendVideoSize:this.maxSendVideoSize,maxRecvVideoSize:this.maxRecvVideoSize,maxRecvVideoNum:this.maxRecvVideoNum}}};function st(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,s)}return i}function at(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?st(Object(i),!0).forEach((function(t){(0,h.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):st(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}i(7855);const rt=q.getTracer("WmscMonitor"),nt=e=>{rt.log(e),q.monitorLog("".concat(e))},{tT:ot,LA:ct,ue:dt}=s,ht=new class{constructor(){this.bToPrint=!0,this.mIdMgr=null,this.captureTimer=null,this.reportTimer=null,this.userId="",this.recvStats={},this.sendStats={},this.isMonitoring=!1,this.subInfo={},this.activeSpeaker="",this.isPreActiveSpeaker=!1,this.recordUserId="",this.captureTimer=null,this.reportTimer=null,this.lastSendPCsStatRecord=new Map,this.captureCount=0,this._startCapture=this._startCapture.bind(this),this.rtpHeaderExt={"http://www.webrtc.org/experiments/rtp-hdrext/playout-delay":0,"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01":1,"urn:ietf:params:rtp-hdrext:sdes:mid":2,"http://www.webrtc.org/experiments/rtp-hdrext/video-layers-allocation00":3},this.sdpDirection={recvonly:0,sendonly:1,sendrecv:2,inactive:3},this.recvStatisticData={},this.reportCount=0,this.maxSubscribedSize=-1,this._telemetry=null,this.uiQosData={},this.isUISubQos=!1,this.UIQosInterval=1,this.candidateLog={0:"",1:"",2:"",3:"",4:""},this.candidatePairLog={0:"",1:"",2:"",3:"",4:""},this.iceCandidatePairState={frozen:0,waiting:1,"in-progress":2,failed:3,succeeded:4},this.ssrcMidMap={},this.candidatePairMonitorLog=new Array(5).fill(""),this.candidatePairChangeCount=new Array(5).fill(0),this.ingressReport={},this.camStream=null,this.recvCodecProfile="",this.shouldReportNullDecoderError=!0,this.shouldReportEncodeFailedError=!0,this.recvRawStats={},this.sendRawStats={},this.ssrcLayerMap={},this.rawLog=[],this.prevUplinkState={},this.prevDownlinkState={},this.networkReportDelay=0,this.isDualCall=!1}setTelemetry(e){this._telemetry="function"==typeof e?e:null}updateQosSubscription(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3;this.isUISubQos=e,this.UIQosInterval=Math.round(t/1e3)}setUserId(e){this.userId=parseInt(e,10)}setQoSDataCb(e){this.sendQoSData=e}updateSubInfo(e,t){nt("WMSC_USBI: ".concat(e,"|").concat(t)),t>=0?this.subInfo[e]=t:(delete this.subInfo[e],this.resetRecvStats(e)),rt.log("updateSubInfo:",this.subInfo)}setActiveSpeaker(e,t){this.activeSpeaker=4294966272&parseInt(e,10),this.isPreActiveSpeaker=t}updateSubscribedSize(e,t,i){let s=-1;Array.from(new Set([...e,...t,...i])).forEach((e=>{s=Math.max(s,e)})),this.maxSubscribedSize=s}start(){nt("WMSC_MSTART: ".concat(this.isMonitoring)),this.isMonitoring||(this._startCapture(),this._startReport(),this.isMonitoring=!0,this.shouldReportNullDecoderError=!0,this.shouldReportEncodeFailedError=!0,this.networkReportDelay=0)}resetRecvStats(e){this.recvStats.statisticData&&delete this.recvStats.statisticData[e],this.recvStats["begin-video-inbound-rtp"]&&delete this.recvStats["begin-video-inbound-rtp"][e],this.recvStats["video-inbound-rtp"]&&delete this.recvStats["video-inbound-rtp"][e],this.recvStats["video-remote-outbound-rtp"]&&delete this.recvStats["video-remote-outbound-rtp"][e]}stop(){nt("WMSC_MSTOP: ".concat(this.isMonitoring)),clearInterval(this.reportTimer),clearTimeout(this.captureTimer),this.recvStats={},this.sendStats={},this.isMonitoring=!1}getResolutionId(e){return e<=14400?0:e<=57600?1:e<=230400?2:e<=921600?3:e<=2073600?4:5}_sendQosData(){if(this.isUISubQos&&this.captureCount%this.UIQosInterval==0){if(this.uiQosData.receiving){const e=this.recvStats["candidate-pair"]||{},{currentRoundTripTime:t=0}=e,i=Math.round(1e3*t);this._telemetry&&this._telemetry({type:k.VIDEO_QOS_DATA,data:at(at({encoding:!1},this.uiQosData.receiving),{},{rtt:i})}),this.uiQosData.receiving=null}this.uiQosData.sending&&(this._telemetry&&this._telemetry({type:k.VIDEO_QOS_DATA,data:at({encoding:!0},this.uiQosData.sending)}),this.uiQosData.sending=null)}}_sendNetworkState(e){const{isUplink:t}=e;let i=!1;i=t?e.networkLevel!==this.prevUplinkState.networkLevel||e.bwLevel!==this.prevUplinkState.bwLevel:e.networkLevel!==this.prevDownlinkState.networkLevel||e.bwLevel!==this.prevDownlinkState.bwLevel,i&&(this._telemetry&&this._telemetry({type:k.NETWORK_QUALITY_CHANGE,data:e}),t?this.prevUplinkState=e:this.prevDownlinkState=e)}_getNetworkState(e,t,i){let s=ot.NET_QUALITY_UNKNOWN,a=ct.NET_BW_LEVEL_UNKNOWN;if(e>.5||t/2>5)s=ot.NET_QUALITY_VERY_BAD;else if(e>.3||t/2>2)s=ot.NET_QUALITY_BAD;else if(void 0!==i){const r=i/1024;r<320||e>.08&&t>.5?s=ot.NET_QUALITY_NOT_GOOD:r>450?(s=ot.NET_QUALITY_GOOD,a=ct.NET_BW_LEVEL_NORMAL):r>850&&e<.05&&t<.3&&(s=ot.NET_QUALITY_EXCELLENT,a=ct.NET_BW_LEVEL_NORMAL)}return{networkLevel:s,bwLevel:a}}async _startCapture(){this.captureCount++;try{await Promise.all([this._captureRecvStats(),this._captureSenderStats()]),this._sendQosData()}catch(e){rt.error("_startCapture, capture error: ".concat(e)),nt("WMSC_LOGCE"),q.globalTrace({logLevel:"error",log:"WMSC_LOGCE",errorEvent:e})}finally{this.captureTimer=setTimeout(this._startCapture,v)}}_startReport(){this.reportTimer=setInterval(this._reportStats.bind(this),f)}_reportStats(){try{this.reportCount++,this._getStats(),this._resetStats(),this.ingressReport.begin=null}catch(e){nt("WMSC_LOGRE"),q.globalTrace({logLevel:"error",log:"WMSC_LOGRE",errorEvent:e})}}_resetStats(){for(const e in this.sendStats){const{statisticData:t}=this.sendStats[e];t.maxRtt=0,t.maxCamCaptureFps=t.maxCaptureFps=0,t.minCamCaptureFps=t.minCaptureFps=Math.MAX_SAFE_INTEGER,t.totalCamCaptureCount=t.totalCaptureCount=0,t.totalCamCaptureFps=t.totalCaptureFps=0;for(const i in this.sendStats[e]["video-outbound-rtp"])t[i]={maxEncodeTime:0,minEncodeTime:Number.MAX_SAFE_INTEGER,avgEncodeTime:0,minSendFrameRate:Number.MAX_SAFE_INTEGER,maxSendFrameRate:0,avgSendFrameRate:0,minSendBitRate:Number.MAX_SAFE_INTEGER,maxSendBitRate:0,avgSendBitRate:0,minPacketSentDelay:Number.MAX_SAFE_INTEGER,maxPacketSentDelay:0,avgPacketSentDelay:0,maxLossRate:"",avgLossRate:"",encodePauseCount:0,count:0,maxQP:0,minQP:Number.MAX_SAFE_INTEGER,avgQP:0},this.sendStats[e]["begin-video-outbound-rtp"][i]=this.sendStats[e]["video-outbound-rtp"][i],this.sendStats[e]["video-remote-inbound-rtp"]&&(this.sendStats[e]["begin-video-remote-inbound-rtp"][i]=this.sendStats[e]["video-remote-inbound-rtp"][i]);this.sendStats[e]["begin-candidate-pair"]=this.sendStats[e]["candidate-pair"],this.sendStats[e]["begin-video-media-source"]=this.sendStats[e]["video-media-source"],delete this.sendStats[e].codec}for(const e in this.recvStats["video-inbound-rtp"])this.recvStats.statisticData[e]={maxFps:0,minFps:Number.MAX_SAFE_INTEGER,avgFps:0,maxDecodeTime:0,minDecodeTime:Number.MAX_SAFE_INTEGER,avgDecodeTime:0,maxLossRate:0,avgLossRate:0,maxBt:0,minBt:Number.MAX_SAFE_INTEGER,avgBt:0,maxJitter:0,minLastRecvGap:Number.MAX_SAFE_INTEGER,maxLastRecvGap:0,avgLastRecvGap:0,noDataCount:0,count:0,decodePausedCount:0},this.recvStats["begin-video-inbound-rtp"][e]=this.recvStats["video-inbound-rtp"][e],this.recvStats["video-remote-outbound-rtp"]&&(this.recvStats["begin-video-remote-outbound-rtp"][e]=this.recvStats["video-remote-outbound-rtp"][e]);this.recvStats["begin-candidate-pair"]=this.recvStats["candidate-pair"],this.recvStats.statisticData&&(this.recvStats.statisticData.maxRtt=0),delete this.recvStats.codec}async _captureSenderStats(){const e=c.EGRESS,t=Fe.getPc(e);if(!t)return;const i=await t.getStats(),s={};this.sendStats[e]||(this.sendStats[e]={});const a={},r={};let n="",o="",d=!1,h=0,l=0;if(i.forEach((t=>{ye.getSendStatsMonitor().onStatsReport(t);const{kind:i,type:c}=t,d="".concat(i?i+"-":"").concat(c),h="begin-".concat(d);if("video"!==i||"outbound-rtp"!==c&&"remote-inbound-rtp"!==c)if("candidate-pair"===c){const{id:e}=t;a[e]=t,o+=this._getCandidatePairLog(t)}else if("local-candidate"===c||"remote-candidate"===c){const{id:e}=t;r[e]=t,n+=this._getCandidateLog(t)}else if("codec"===c){const{id:e}=t;s[d]||(s[d]={}),s[d][e]=t}else s[d]=t;else{const{ssrc:i}=t;s[d]||(s[d]={}),s[d][i]=t,this.sendStats[e][h]&&this.sendStats[e][h][i]||(this.sendStats[e][h]=at(at({},this.sendStats[e][h]),{},{[i]:t}))}})),this._captureRawSendData(s["video-media-source"]),s.candidates=r,s.candidatePairs=a,s.transport){const{selectedCandidatePairId:t,dtlsState:i}=s.transport;if("connected"===i){const i=a[t];if(i){const{localCandidateId:t,remoteCandidateId:a}=i;s["remote-candidate"]=r[a],s["local-candidate"]=r[t],s["candidate-pair"]=i,this.sendStats[e]["begin-candidate-pair"]||(this.sendStats[e]["begin-candidate-pair"]=i)}}}this.sendStats[e]["begin-video-media-source"]||(this.sendStats[e]["begin-video-media-source"]=s["video-media-source"]),n!==this.candidateLog[e]&&(q.directSendMonitorLog("WMSC_CANDIDATE: ".concat(e,"|").concat(n)),this.candidateLog[e]=n),o!==this.candidatePairLog[e]&&(this.candidatePairChangeCount[e]++,this.candidatePairLog[e]=o);const{currentRoundTripTime:u}=s["candidate-pair"]||{},m=s["video-outbound-rtp"]||{},p=s["video-remote-inbound-rtp"]||{},S=s["video-media-source"]||{};this.sendStats[e].statisticData||(this.sendStats[e].statisticData={});const g=this.sendStats[e]["video-outbound-rtp"]||{},_=this.sendStats[e]["video-media-source"]||{},v=this.sendStats[e].statisticData,{minCaptureFps:f,maxCaptureFps:I,maxRtt:C,minCamCaptureFps:E,maxCamCaptureFps:R,totalCaptureFps:b=0,totalCaptureCount:M=0,totalCamCaptureFps:T=0,totalCamCaptureCount:y=0}=v,L=t.getSenders(),{frames:w}=S,{frames:D}=_;if(L[0]&&L[0].track){const{frameRate:e=0,width:t,height:i}=L[0].track.getSettings(),{framesPerSecond:s=e,height:a=t,width:r=i}=S;d=!0,v.minCaptureFps=Math.round(Math.min(s,f||Number.MAX_SAFE_INTEGER)),v.maxCaptureFps=Math.round(Math.max(s,I||0)),v.totalCaptureFps=b+s,v.totalCaptureCount=M+1,v.avgCaptureFps=Math.round(v.totalCaptureFps/v.totalCaptureCount),v.captureWidth=null!=a?a:"",v.captureHeight=null!=r?r:""}if(this.camStream){var A;const{frameRate:e=0}=null===(A=this.camStream.getVideoTracks()[0])||void 0===A?void 0:A.getSettings();v.minCamCaptureFps=Math.round(Math.min(e,E||Number.MAX_SAFE_INTEGER)),v.maxCamCaptureFps=Math.round(Math.max(e,R||0)),v.totalCamCaptureFps=T+e,v.totalCamCaptureCount=y+1,v.avgCamCaptureFps=Math.round(v.totalCamCaptureFps/v.totalCamCaptureCount)}u&&(v.maxRtt=Math.max(u,C||0));for(const t in m){const{framesPerSecond:i="",bytesSent:a,framesSent:r,timestamp:n,framesEncoded:o,totalEncodeTime:c,packetsSent:u,totalPacketSendDelay:S,frameHeight:_,frameWidth:f,retransmittedPacketsSent:I,active:C,qualityLimitationDurations:E,qpSum:R}=m[t];let b=0;!1!==C&&this._captureRawSendData(m[t]);const{jitter:M}=p[t]||{};v[t]||(v[t]={});const T=v[t],{minEncodeFrameRate:y,maxEncodeFrameRate:L,minSendFrameRate:A,maxSendFrameRate:N,minSendBitRate:V,maxSendBitRate:B,maxEncodeTime:x,minEncodeTime:U,maxPacketSentDelay:W,minPacketSentDelay:F,maxJitter:G,maxLossRate:z,sendWidth:j,sendHeight:H,maxQP:Q,minQP:Y}=T;if(T.minEncodeFrameRate=Math.min(i,y||Number.MAX_SAFE_INTEGER),T.maxEncodeFrameRate=Math.max(i,L||0),T.maxJitter=Math.max(M,G||0),g&&g[t]){var O;if(!1===C||!d)continue;T.count++;const{timestamp:i,bytesSent:s,framesSent:h,framesEncoded:m,totalEncodeTime:p,packetsSent:M,totalPacketSendDelay:y,retransmittedPacketsSent:L,qpSum:G}=g[t],{framesSent:J,bytesSent:K,timestamp:X,framesEncoded:Z,totalEncodeTime:$,packetsSent:ee,totalPacketSendDelay:te,retransmittedPacketsSent:ie,qualityLimitationDurations:se,qpSum:ae}=this.sendStats[e]["begin-video-outbound-rtp"][t];let re,ne,oe="",ce="";b=r-h;const de=Math.round(b/((n-i)/1e3)),he=(8*(a-s)/((n-i)/1e3)).toFixed(2),le=Math.round((r-J)/((n-X)/1e3)),ue=(8*(a-K)/((n-X)/1e3)).toFixed(2),me=(c-p)/(o-m)||0,pe=(c-$)/(o-Z)||0,Se=Math.round((o-Z)/((n-X)/1e3)),{current:ge,begin:_e,prev:ve}=this.ingressReport;if(ge&&ve&&_e){const{lostPkts:e,recvPkts:t}=ge,{lostPkts:i,recvPkts:s}=ve,{lostPkts:a,recvPkts:r}=_e,n=e-i,o=e-a;ce=n/(t-s+n)||0,oe=o/(t-r+o)||0}else oe=(I-ie)/(u-ee)||0,ce=(I-L)/(u-M)||0;if(void 0!==S&&(re=(1e3*(S-y)/(u-M)).toFixed(3),ne=(1e3*(S-te)/(u-ee)).toFixed(3)),C&&o===m&&w&&w>D&&(T.encodePauseCount++,T.encodePauseCount>10&&this.shouldReportEncodeFailedError)){var P;const{frames:i=""}=this.sendStats[e]["begin-video-media-source"];let s="".concat(t,",").concat(o,",").concat(Z,",").concat(w,",").concat(i,",");if(E&&se){const{bandwidth:e,cpu:t,other:i}=E,{bandwidth:a,cpu:r,other:n}=se;s+="".concat(e,",").concat(a,",").concat(t,",").concat(r,",").concat(i,",").concat(n)}const a=null===(P=this.camStream)||void 0===P?void 0:P.getVideoTracks()[0];a&&!a.muted&&this._telemetry({type:k.ERROR_MESSAGE,data:{type:"WEBRTC_VIDEO_HEALTH_CHECK_FAILED"}}),s+="videoTrack:".concat(!!a,"|").concat(a&&(null==a?void 0:a.muted)),q.globalTrace({logLevel:"error",log:"WMSC_ENCODE_STOP: ".concat(s)}),nt("WMSC_ENCODE_STOP: ".concat(s)),this.shouldReportEncodeFailedError=!1}let fe="",Ie="";void 0!==R&&o&&(void 0!==G&&o>m&&(Ie=Math.round((R-G)/(o-m))),void 0!==ae&&o>Z&&(fe=Math.round((R-ae)/(o-Z)))),v[t]=at(at({},T),{},{maxEncodeTime:Math.max(x,me),minEncodeTime:Math.min(me,U),avgEncodeTime:pe,minSendFrameRate:Math.min(de,A),maxSendFrameRate:Math.max(N,de),avgSendFrameRate:le,minSendBitRate:Math.min(he,V),maxSendBitRate:Math.max(B,he),avgSendBitRate:ue,minPacketSentDelay:Math.min(re,F),maxPacketSentDelay:Math.max(re,W),avgPacketSentDelay:null!==(O=ne)&&void 0!==O?O:"",avgEncodeFrameRate:Se,avgLossRate:isNaN(oe)?"":oe,maxLossRate:isNaN(ce)?z:Math.max(ce,z),sendWidth:f||j,sendHeight:_||H,maxQP:Math.max(Q,Ie),minQP:Math.min(Y,Ie),avgQP:fe}),l=Math.max(l,v[t].avgLossRate)}else v[t]=at(at({},T),{},{maxEncodeTime:0,minEncodeTime:Number.MAX_SAFE_INTEGER,avgEncodeTime:0,minSendFrameRate:Number.MAX_SAFE_INTEGER,maxSendFrameRate:0,avgSendFrameRate:0,minSendBitRate:Number.MAX_SAFE_INTEGER,maxSendBitRate:0,avgSendBitRate:0,minPacketSentDelay:Number.MAX_SAFE_INTEGER,maxPacketSentDelay:0,avgPacketSentDelay:0,maxLossRate:"",avgLossRate:"",encodePauseCount:0,maxQP:0,minQP:Number.MAX_SAFE_INTEGER,avgQP:0,count:0});if(_&&f){const e=_*f;if(e>h&&b>0){const{currentRoundTripTime:a=0}=s["candidate-pair"]||{};h=e,this.uiQosData.sending={width:f,height:_,fps:i,rtt:Math.round(1e3*a),max_loss:1e3*v[t].maxLossRate,avg_loss:1e3*v[t].avgLossRate,jitter:Math.round(1e3*(M||0)),bandwidth:v[t].avgSendBitRate}}}}if(d)if(this.networkReportDelay>5){const{currentRoundTripTime:e=0,availableOutgoingBitrate:t}=s["candidate-pair"]||{},i=this._getNetworkState(l,e,t);this._sendNetworkState(at({isUplink:!0},i))}else this.networkReportDelay++;this.sendStats[e]=at(at({},this.sendStats[e]),s),this.captureCount%2==0&&d&&this.sendQoSData&&this.checkSendPCsStat()}async _captureRecvStats(){const e=Fe.getPc(c.INGRESS);if(!e||!this.mIdMgr)return;const t=this.mIdMgr.mIdUsedStatus,i=await e.getStats();let s=0;const a={},r={};let n="",o="",d=0;this.recvStats.statisticData||(this.recvStats.statisticData={}),i.forEach((e=>{if(!this.recvCodecProfile)return;ye.getRecvStatsMonitor().onStatsReport(e);const{kind:i,type:c}=e,h="".concat(i?i+"-":"").concat(c),l="begin-".concat(h);if("candidate-pair"===c){const{id:t}=e;a[t]=e,o+=this._getCandidatePairLog(e)}else if("remote-candidate"===c||"local-candidate"===c){const{id:t}=e;r[t]=e,n+=this._getCandidateLog(e)}else if("video"!==i||"inbound-rtp"!==c&&"remote-outbound-rtp"!==c)if("codec"===c){const{id:t}=e;this.recvStats[h]||(this.recvStats[h]={}),this.recvStats[h][t]=e}else this.recvStats[h]=e;else{let{mid:i,ssrc:a}=e;i||(i=this.ssrcMidMap[a]),this.recvStats[l]||(this.recvStats[l]={}),this.recvStats[h]||(this.recvStats[h]={});const{userId:r,used:n}=t[i]||{};if(i&&n&&"inbound-rtp"===c){let t;this._captureRawRecvData(e);let a=0;const{framesPerSecond:n="",timestamp:o="",framesDecoded:c="",frameWidth:h="",frameHeight:l="",bytesReceived:p="",framesReceived:S="",totalDecodeTime:g="",packetsReceived:_="",packetsLost:v="",jitter:f="",lastPacketReceivedTimestamp:I=0,fecPacketsReceived:C=0,retransmittedPacketsReceived:E=0,jitterBufferEmittedCount:R,decoderImplementation:b,pliCount:M}=e;if(this.recvStats.statisticData[r]){this.recvStats.statisticData[r].count++;const{maxFps:e,minFps:s,maxDecodeTime:h,minDecodeTime:l,maxLossRate:u,maxBt:m,minBt:S,maxJitter:M,minLastRecvGap:T,maxLastRecvGap:y,avgLastRecvGap:L,count:w}=this.recvStats.statisticData[r],D=this.recvStats["video-inbound-rtp"][r],A=this.recvStats["begin-video-inbound-rtp"][r],{timestamp:O,framesDecoded:P,totalDecodeTime:N,packetsLost:V,packetsReceived:B,bytesReceived:x,fecPacketsReceived:U=0,retransmittedPacketsReceived:k=0,jitterBufferEmittedCount:W=0,pliCount:F=0}=A||{},{packetsLost:G,packetsReceived:z,totalDecodeTime:j,framesDecoded:H,bytesReceived:Q,timestamp:Y,lastPacketReceivedTimestamp:J,fecPacketsReceived:K=0,retransmittedPacketsReceived:X=0,jitterBufferEmittedCount:Z=0}=D||{};a=c-H,0===a&&R>Z&&this.recvStats.statisticData[r].decodePausedCount++,"NullVideoDecoder"===b&&this.shouldReportNullDecoderError&&(q.globalTrace({logLevel:"error",log:"WMSC_NULLDECODER: ".concat(i)}),nt("WMSC_NULLDECODER,".concat(i)),this.shouldReportNullDecoderError=!1);const $=_-B-(C-U)-(E-k),ee=(v-G)/(_-z-(C-K)-(E-X)+(v-G))||0,te=(g-j)/(c-H)||0;t=8*(p-Q)/((o-Y)/1e3);const ie=8*(p-x)/((o-O)/1e3);if(J){const e=parseInt(I-J,10);this.recvStats.statisticData[r].minLastRecvGap=Math.min(T,e),this.recvStats.statisticData[r].maxLastRecvGap=Math.max(y,e),this.recvStats.statisticData[r].avgLastRecvGap=parseInt((L*(w-1)+e)/w,10),0===e&&this.recvStats.statisticData[r].noDataCount++}else this.recvStats.statisticData[r].minLastRecvGap=0,this.recvStats.statisticData[r].noDataCount++;this.recvStats.statisticData[r].maxFps=Math.max(e,n),this.recvStats.statisticData[r].minFps=Math.min(s,n),this.recvStats.statisticData[r].avgFps=Math.round((c-P)/((o-O)/1e3)),this.recvStats.statisticData[r].maxDecodeTime=Math.max(h,te),this.recvStats.statisticData[r].minDecodeTime=Math.min(te,l),this.recvStats.statisticData[r].avgDecodeTime=(g-N)/(c-P)||0,this.recvStats.statisticData[r].prevTotalDecodeTime=g,this.recvStats.statisticData[r].prevFramesDecoded=c,this.recvStats.statisticData[r].maxLossRate=Math.max(u,ee),this.recvStats.statisticData[r].avgLossRate=(v-V)/($+(v-V))||0,this.recvStats.statisticData[r].maxJitter=Math.max(M,f),this.recvStats.statisticData[r].maxBt=Math.max(t,m),this.recvStats.statisticData[r].minBt=Math.min(t,S),this.recvStats.statisticData[r].avgBt=ie,d=Math.max(this.recvStats.statisticData[r].avgLossRate,d)}else t=8*p/S*n||"",this.recvStats.statisticData[r]={maxFps:n,minFps:n,avgFps:n,maxDecodeTime:0,minDecodeTime:Number.MAX_SAFE_INTEGER,avgDecodeTime:0,maxLossRate:0,avgLossRate:0,maxBt:t,minBt:t,avgBt:t,maxJitter:f,minLastRecvGap:Number.MAX_SAFE_INTEGER,maxLastRecvGap:0,avgLastRecvGap:0,noDataCount:0,count:0,decodePausedCount:0};if(h&&l){const e=h*l;if(e>s&&a>0){var u,m;const t=this.mIdMgr.user2VideoDom.get(parseInt(r,10))||[];this.uiQosData.receiving={avg_loss:Math.max(1e3*this.recvStats.statisticData[r].avgLossRate,0),max_loss:Math.max(1e3*this.recvStats.statisticData[r].maxLossRate,0),fps:n||0,height:(null===(u=t[0])||void 0===u?void 0:u.videoHeight)||l,width:(null===(m=t[0])||void 0===m?void 0:m.videoWidth)||h,jitter:Math.round(1e3*(f||0)),bandwidth:this.recvStats.statisticData[r].avgBt},s=e}}this.bToPrint&&this._renderStatsData(i,h,l,n,t)}else if(i&&"inbound-rtp"===c&&!this.mIdMgr.getMidReleasedStatus(i)){const{lastPacketReceivedTimestamp:t}=e;t&&(new Date).getTime()-t>5e3&&this.mIdMgr.setMidReleasedStatus(i,!0)}if(r&&(this.recvStats[l][r]||(this.recvStats[l][r]=e),this.recvStats[h][r]=e,"inbound-rtp"===c)){const t=this.detectDecodeFailed(r);if(this.recvCodecProfile&&t){const{codecId:s}=e,a=this.getRecvH264Profile(s),r=Object.keys(this.subInfo).length,n="".concat(this.userId,",").concat(i,",").concat(r,",").concat(t,",").concat(a);return q.globalTrace({logLevel:"error",log:"WMSC_DECODE_FAILED: ".concat(n)}),q.directSendMonitorLog("WMSC_DECODE_FAILED,".concat(n)),this.recvStats={},this.onDecodeError&&this.onDecodeError(a),void(this.recvCodecProfile="")}}}})),this.recvStats.candidatePairs=a,this.recvStats.candidates=r;const h=this.recvStats.transport;if(h){const{selectedCandidatePairId:e,dtlsState:t}=h;if("connected"===t){const t=a[e];if(t){const{localCandidateId:e,remoteCandidateId:i,currentRoundTripTime:s=0}=t;if(this.recvStats["remote-candidate"]=r[i],this.recvStats["local-candidate"]=r[e],this.recvStats["candidate-pair"]=t,this.recvStats["begin-candidate-pair"]){const{maxRtt:e}=this.recvStats.statisticData;this.recvStats.statisticData.maxRtt=Math.max(e,s)}else this.recvStats["begin-candidate-pair"]=t,this.recvStats.statisticData.maxRtt=s}}}n!==this.candidateLog[0]&&(q.directSendMonitorLog("WMSC_CANDIDATE 0: ".concat(n)),this.candidateLog[0]=n),o!==this.candidatePairLog[0]&&(this.candidatePairChangeCount[0]++,this.candidatePairLog[0]=o);const{currentRoundTripTime:l}=this.recvStats["candidate-pair"]||{},u=this._getNetworkState(d,l);this._sendNetworkState(at({isUplink:!1},u))}_getVideoSenderLog(){var e;let t="",i="",s="",a={};const r=Fe.getPc(c.EGRESS);if(!r)return;const n=r.getSenders()[0];n&&null!==(e=n.track)&&void 0!==e&&e.getStats&&(a=n.track.getStats());const{fps:o="",receivingFps:d="",generatedFrames:h="",receivedFrames:l=""}=a;for(const e in this.sendStats){const a=this.sendStats[e];if(!a["video-media-source"])continue;const{frames:r=""}=a["video-media-source"];let n=0,c=0;for(const e in a["video-outbound-rtp"]){var u;const m="{[SEND".concat(this.ssrcLayerMap[e],"]}"),p="{[ENCO".concat(this.ssrcLayerMap[e],"]}"),S="{[VQ".concat(this.ssrcLayerMap[e],"]}"),{minEncodeFrameRate:g,maxEncodeFrameRate:_,avgEncodeFrameRate:v,minSendFrameRate:f,maxSendFrameRate:I,avgSendFrameRate:C,minSendBitRate:E,maxSendBitRate:R,avgSendBitRate:b,maxEncodeTime:M,minEncodeTime:T,avgEncodeTime:y,maxPacketSentDelay:L,minPacketSentDelay:w,avgPacketSentDelay:D,sendWidth:A="",sendHeight:O="",encodePauseCount:P,count:N,maxQP:V,minQP:B,avgQP:x}=a.statisticData[e];if(0===N)continue;let{minCaptureFps:U,maxCaptureFps:k,avgCaptureFps:W,captureHeight:F,captureWidth:G,minCamCaptureFps:z,maxCamCaptureFps:j,avgCamCaptureFps:H}=a.statisticData;this.camStream||(z=U,j=k,H=W);const{keyFramesEncoded:Q="",qualityLimitationReason:q="",pliCount:Y="",nackCount:J="",firCount:K="",framesSent:X="",retransmittedPacketsSent:Z="",powerEfficientEncoder:$,hugeFramesSent:ee="",packetsSent:te="",bytesSent:ie="",qualityLimitationDurations:se={},encoderImplementation:ae="",targetBitrate:re="",codecId:ne,active:oe,qpSum:ce=""}=a["video-outbound-rtp"][e],{framesSent:de}=a["begin-video-outbound-rtp"][e],{bandwidth:he="",cpu:le="",none:ue="",other:me=""}=se,{mimeType:pe="h264",sdpFmtpLine:Se=""}=(null===(u=a.codec)||void 0===u?void 0:u[ne])||{};let ge="";const _e=Se.match(/profile-level-id=([A-Za-z0-9]+);/);_e&&(ge=_e[1]);let ve=-1!==pe.toLowerCase().indexOf("h264")?0:2;$&&(ve|=1);const fe=A*O;X-de>0&&fe>n&&(n=fe,c=this.ssrcLayerMap[e]),t+="".concat(m,",").concat(this.maxSubscribedSize,",").concat(G,",").concat(F,",").concat(k,",").concat(U,",").concat(W,",,,,,,,").concat(_,",").concat(g,",").concat(v,",").concat(R,",").concat(E,",").concat(b,",").concat(I,",").concat(f,",").concat(C,",").concat(A,",").concat(O,",").concat(X,",,,,").concat(j,",").concat(z,",").concat(H,",").concat(isNaN(L)?"":L,",").concat(isNaN(w)?"":w,",").concat(isNaN(D)?"":D,",").concat(te,",").concat(ie,",").concat(Q,",").concat(ee,",").concat(J,",").concat(K,",").concat(Y,",").concat(Z,",").concat(q,",").concat(he,",").concat(le,",").concat(me,",").concat(ue,",").concat(re,",").concat(r,",").concat(P,",").concat(void 0===oe?"":oe,",").concat(N,",").concat(o,",").concat(d,",").concat(h,",").concat(l,",").concat(this.ssrcLayerMap[e],",").concat(ce,",").concat(e,","),i+="".concat(p,",").concat((1e3*M).toFixed(2),",").concat((1e3*T).toFixed(2),",").concat((1e3*y).toFixed(2),",,").concat(ve,",").concat(ae,",").concat(ge,","),s+="".concat(S,",,,").concat(x,",").concat(V,",").concat(B,",,,,,,,,,")}t=t.replace("{[SEND".concat(c,"]}"),"{[SEND]}"),i=i.replace("{[ENCO".concat(c,"]}"),"{[ENCO]}"),s=s.replace("{[VQ".concat(c,"]}"),"{[VQ]}")}return"".concat(t).concat(i).concat(s)}_getVideoReceiveLog(){var e;const t=new Array(8).fill(0),i=new Array(8).fill(0);let s,a=-1;const r=new Set,n={};for(const e in this.recvStats["video-inbound-rtp"]){var o;const{maxFps:t,minFps:c,avgFps:d,maxBt:h,minBt:l,avgBt:u,minLastRecvGap:m,maxLastRecvGap:p,avgLastRecvGap:S,noDataCount:g,count:_,decodePausedCount:v}=(null===(o=this.recvStats.statisticData)||void 0===o?void 0:o[e])||{},f=this.recvStats["video-inbound-rtp"][e]||{},I=this.recvStats["begin-video-inbound-rtp"][e]||{},{framesReceived:C="",framesDropped:E="",framesDecoded:R="",totalProcessingDelay:b=""}=I,{frameHeight:M=0,frameWidth:T=0,freezeCount:y="",framesReceived:L="",framesDropped:w="",keyFramesDecoded:D="",pauseCount:A="",nackCount:O="",firCount:P="",pliCount:N="",totalProcessingDelay:V="",fecPacketsReceived:B="",retransmittedPacketsReceived:x="",framesDecoded:U="",bytesReceived:k="",packetsReceived:W="",packetsLost:F="",jitterBufferDelay:G=0,jitterBufferEmittedCount:z="",ssrc:j=""}=f,H=L-C,Q=w-E,q=(Q/H||0).toFixed(2),Y=((V-b)/(U-R)*1e3||0).toFixed(2),J=U-R;if(void 0!==this.subInfo[e]){const t=T*M;t>a&&(a=t,s=parseInt(e,10)),t>0&&J>0&&i[this.getResolutionId(t)]++}else r.add(parseInt(e,10));const K=this.mIdMgr.user2VideoDom.get(parseInt(e,10));let X="",Z="",$="";if(null!=K&&K.length){const e=K[0];X=e.currentTime>0&&!e.paused&&!e.ended&&e.readyState>2?1:0;const t=e.getVideoPlaybackQuality();$=t.droppedVideoFrames,Z=t.totalVideoFrames-$}n[e]="".concat(t,",").concat(c,",").concat(d,",").concat(T,",").concat(M,",").concat(e,",").concat(_,",").concat(g,",,,,,,,,,,,,,").concat(H,",").concat(Q,",").concat(q,",").concat(this.subInfo[e]||"",",,,,").concat(J,",").concat(X,",").concat(Z,",").concat($,",").concat((h||0).toFixed(2),",").concat((l||0).toFixed(2),",").concat((u||0).toFixed(2),",").concat(W,",").concat(F,",").concat(k,",").concat(D,",").concat(A,",").concat(y,",").concat(O,",").concat(P,",").concat(N,",").concat(B,",").concat(x,",").concat(Y,",").concat(Math.round(1e3*G),",").concat(z,",").concat(p,",").concat(m,",").concat(S,",").concat(v,",").concat(j,",").concat(this.ssrcMidMap[j])}this.activeSpeaker&&!r.has(this.activeSpeaker)&&null!==(e=this.recvStats.statisticData)&&void 0!==e&&e[this.activeSpeaker]?this.recordUserId=this.activeSpeaker:this.recordUserId=s;for(const e in this.subInfo)t[this.subInfo[e]]++;const c="{[RECV]},".concat(t.join(","),",").concat(i.join(","),",");if(this.recvStatisticData[(new Date).toUTCString()]=n,this.reportCount%4==0)try{const e=JSON.stringify(this.recvStatisticData);z(e,M.GZIP_BASE64).then((e=>{q.globalTrace({logLevel:"log",log:"WCL_WB_VIDEO,".concat(e)}),this.recvStatisticData={}})).catch((t=>{q.globalTrace({logLevel:"error",log:"WMSC compress video log failed",errorEvent:t}),q.globalTrace({logLevel:"log",log:"WCL_WB_VIDEO,".concat(e)}),this.recvStatisticData={}}))}catch(e){q.globalTrace({logLevel:"error",log:"WMSC_Video_Log_Parse_Failed",errorEvent:e}),this.recvStatisticData={}}return n[this.recordUserId]?"".concat(c).concat(n[this.recordUserId],","):c}_getVideoDecodeLog(){var e,t;if(null===(e=this.recvStats.statisticData)||void 0===e||!e[this.recordUserId])return"";const{maxDecodeTime:i,minDecodeTime:s,avgDecodeTime:a}=this.recvStats.statisticData[this.recordUserId],{powerEfficientDecoder:r,codecId:n,decoderImplementation:o=""}=this.recvStats["video-inbound-rtp"][this.recordUserId],c=(null===(t=this.recvStats.codec)||void 0===t?void 0:t[n])||{},{mimeType:d="h264"}=c,h=(-1!==d.toLowerCase().indexOf("h264")?0:2)|(r?1:0);return"{[DECO]},".concat((1e3*i).toFixed(2),",").concat((1e3*s).toFixed(2),",").concat((1e3*a).toFixed(3),",,").concat(h,",").concat(o)}_getDownLinkLog(){var e,t;const{maxLossRate:i="",avgLossRate:s="",maxJitter:a=""}=(null===(e=this.recvStats.statisticData)||void 0===e?void 0:e[this.recordUserId])||{},r=(null===(t=this.recvStats["video-inbound-rtp"])||void 0===t?void 0:t[this.recordUserId])||{},{packetsLost:n="",jitter:o=""}=r,c=this.recvStats["remote-candidate"]||{},d=this.recvStats["candidate-pair"]||{},h=this.recvStats["begin-candidate-pair"]||{},{maxRtt:l}=this.recvStats.statisticData||{},{protocol:u}=c,{availableIncomingBitrate:m="",bytesReceived:p="",timestamp:S="",totalRoundTripTime:g="",responsesReceived:_="",packetsReceived:v=""}=d,{bytesReceived:f,timestamp:I}=h,C=(8*(p-f)/((S-I)/1e3)).toFixed(2),E=Math.round(g/_*1e3)||"";return"RWG_WB_DOWNLINK_NETWORK,".concat(this.userId,",3,").concat("udp"===u?0:1,",").concat(Math.round(S/1e3),",,").concat(m,",").concat(C,",").concat((100*s).toFixed(2),",").concat((100*i).toFixed(2),",,,,").concat(E,",").concat(1e3*l,",").concat(v,",").concat(n,",,,,,,,,,").concat(Math.round(1e3*o),",").concat(Math.round(1e3*a))}_getUpLinkLog(){let e="";for(const t in this.sendStats){const i=this.sendStats[t]["candidate-pair"]||{},s=this.sendStats[t]["begin-candidate-pair"]||{},a=this.sendStats[t]["remote-candidate"]||{},r=this.sendStats[t]["video-remote-inbound-rtp"]||{},{timestamp:n,availableOutgoingBitrate:o="",bytesSent:c,totalRoundTripTime:d,responsesReceived:h,packetsSent:l=""}=i,{timestamp:u,bytesSent:m}=s,{protocol:p}=a,{statisticData:S={}}=this.sendStats[t],g=isNaN(S.maxRtt)?"":Math.round(1e3*S.maxRtt);let _="",v="",f="",I="",C="";for(const e in r){const{maxJitter:t,avgLossRate:i,maxLossRate:s}=S[e],{packetsLost:a,jitter:n}=r[e];if(t&&!f&&(f=Math.round(1e3*t)),!i&&0!==i||_||(_=(100*i).toFixed(2)),!s&&0!==s||v||(v=(100*s).toFixed(2)),!a&&0!==a||I||(I=a),n&&!C&&(C=Math.round(1e3*n)),_&&v&&f&&I&&C)break}const E=(8*(c-m)/((n-u)/1e3)).toFixed(2),R=Math.round(d/h*1e3)||"";e+=",3,".concat("udp"===p?0:1,",").concat(Math.round(n/1e3),",,").concat(o,",").concat(E,",").concat(_,",").concat(v,",,,,").concat(R,",").concat(g,",").concat(l,",").concat(I,",,,,,,,,,").concat(C,",").concat(f)}return e?"RWG_WB_UPLINK_NETWORK,".concat(this.userId).concat(e):""}_getStats(){let e=0;x.hdVideoEnabled&&(e|=dt.HD_VIDEO),this.isDualCall&&(e|=dt.DUAL_CALL);let t,i,s="WCL_WB_MCM_VIDEO,".concat(this.userId,",,").concat(document.hidden?0:1,",").concat(e,",");const a=this._getVideoSenderLog(),r=this._getVideoReceiveLog(),n=this._getVideoDecodeLog();this.reportCount%2==0&&(t=this._getDownLinkLog(),i=this._getUpLinkLog()),s+=a+r+n+"{[END]}",s&&q.directSendMonitorLog(s),t&&q.directSendMonitorLog(t),i&&q.directSendMonitorLog(i),this.candidatePairMonitorLog=this.candidatePairMonitorLog.map(((e,t)=>{const i=this.candidatePairLog[t];return e!==i&&q.directSendMonitorLog("WMSC_CANDIDATE-PAIR: ".concat(t,"|").concat(i,"|").concat(this.candidatePairChangeCount[t])),this.candidatePairChangeCount[t]=0,i})),this.bToPrint&&(s&&rt.log("_getStats, video log: ".concat(s)),t&&rt.log("_getStats, downlink log: ".concat(t)),i&&rt.log("_getStats, uplink log: ".concat(i)))}_renderStatsData(e){}checkSendPCsStat(){var e,t,i,s,a,r,n,o,d;const h=[],l=c.EGRESS,u=Fe.getPc(l);if(!u||"connected"!==u.connectionState||!this.sendStats[l])return;const m=this.sendStats[l]["candidate-pair"]||{},p=this.sendStats[l]["video-outbound-rtp"]||{},S=p[Object.keys(p)[0]]||{},g={peerId:+l};g.bytesSent=m.bytesSent,g.availableOutgoingBitrate=m.availableOutgoingBitrate;const _=parseInt(1e3*(null!==(e=m.currentRoundTripTime)&&void 0!==e?e:0));g.rtt=_>1e4?1e4:_<0?0:_,g.timestamp=parseInt(null!==(t=S.timestamp)&&void 0!==t?t:0),g.framerate=S.framesPerSecond,g.frameHeight=S.frameHeight,g.frameWidth=S.frameWidth,g.rtpPacketsSent=S.packetsSent,g.rtpBytesSent=S.bytesSent,g.rtxBytesSent=S.retransmittedBytesSent,g.rtxPacketsSent=S.retransmittedPacketsSent,g.qualityLimitationDurationsBW=parseInt(null!==(i=null===(s=S.qualityLimitationDurations)||void 0===s?void 0:s.bandwidth)&&void 0!==i?i:0),g.qualityLimitationDurationsCPU=parseInt(null!==(a=null===(r=S.qualityLimitationDurations)||void 0===r?void 0:r.cpu)&&void 0!==a?a:0),g.qualityLimitationReason=null!==(n=S.qualityLimitationReason)&&void 0!==n?n:"none";const f=this.lastSendPCsStatRecord.get(l),I=f&&f.bytesSent||0,C=f&&f.timestamp||0;null!==(o=g.bytesSent)&&void 0!==o||(g.bytesSent=0),null!==(d=g.timestamp)&&void 0!==d||(g.timestamp=0);const E=g.timestamp-C||2*v;g.bitrate=g.bytesSent&&parseInt(8e3*(g.bytesSent-I)/E)||0,h.push(g),this.lastSendPCsStatRecord.set(l,g),this.sendQoSData(h)}sendSdpLog(e,t,i){try{var s;const a=ae.parseSdp(i),{session:r,media:n=[]}=a,{groups:o=[]}=r,{direction:d="",codecs:h=[],extensionMap:l,bandwidth:u,candidates:m}=n[0]||{},p=new Array(4).fill(-1),S=[],g={};let _="WCL_WB_SDP_".concat(t,",").concat(this.userId,",").concat(e,",").concat((null===(s=o[0])||void 0===s?void 0:s.ids.length)||0,",").concat(this.sdpDirection[d],",");if(l)for(const[e,t]of l){const{uri:i}=t,s=this.rtpHeaderExt[i];void 0!==s&&(p[s]=e)}_+=p.join(",")+",",h.forEach(((i,s)=>{const{codecName:a,codecParams:r,payloadType:n,associatedPayloadType:o=""}=i;"H264"===a&&r?"1"===r.get("packetization-mode")&&(S.push(n),S.push(r.get("profile-level-id")),S.push(r.get("max-mbps")||""),S.push(r.get("max-fs")||""),S.push(r.get("x-google-start-bitrate")||""),S.push(r.get("x-google-max-bitrate")||""),S.push(r.get("x-google-min-bitrate")||""),S.push(r.get("x-google-per-layer-pli")||""),e===c.INGRESS&&"ANSWER"===t&&0===s&&(this.recvCodecProfile=r.get("profile-level-id").substring(0,2).toLowerCase(),this.mIdMgr.changeHWDecodeLimit(this.recvCodecProfile))):"rtx"===a&&(g[o]=n)}));for(let e=0,t=S.length;e<t;e+=7){const t=S[e];_+="".concat(t,",").concat(S[e+1],",").concat(S[e+2],",").concat(S[e+3],",").concat(S[e+4],",").concat(S[e+5],",").concat(S[e+6],",").concat(g[t],",")}n.forEach((e=>{let{ssrcGroups:t,mid:i}=e;t.forEach((e=>{let{semantics:t,ssrcs:s}=e;"FID"===t?(this.ssrcMidMap[s[0]]=i,_+="".concat(s.join(","),",")):"SIM"===t&&s.forEach(((e,t)=>{this.ssrcLayerMap[e]=t}))}))})),_+="".concat(u||"",","),m&&m.length>0&&m.forEach((e=>{let{transport:t,address:i,port:s,priority:a}=e;_+="".concat(a,",").concat("udp"===t?0:1,",").concat(i,",").concat(s,",")})),q.directSendMonitorLog(_),z(i,M.GZIP_BASE64).then((i=>{q.globalTrace({logLevel:"log",log:"WCL_WB_SDP-".concat(e,"-").concat(t,"-").concat(i)})}))}catch(s){q.globalTrace({logLevel:"error",log:"WMSCMonitor sendSdpLog error",errorEvent:s}),q.globalTrace({logLevel:"log",log:"WCL_WB_SDP: ".concat(e,"|").concat(t,"|").concat(i)}),nt("WMSC_SDPLE: ".concat(e,"|").concat(t))}}_getCandidatePairLog(e){const{localCandidateId:t,remoteCandidateId:i,nominated:s,state:a,priority:r=""}=e;return"".concat(r,",").concat(t,",").concat(i,",").concat(this.iceCandidatePairState[a],",").concat(s?1:0,",")}_getCandidateLog(e){const{id:t,candidateType:i,port:s,priority:a,protocol:r,type:n,networkType:o=""}=e;return"".concat(t,",").concat(a,",").concat(r,",").concat(i,",").concat(s,",").concat(o,",").concat("remote-candidate"===n?1:0,",")}onReceiverReport(e){const{begin:t,current:i}=this.ingressReport;this.ingressReport.prev=i,this.ingressReport.current=e,t||(this.ingressReport.begin=i)}_captureRawRecvData(e){if(!e)return;const{timestamp:t,framesDecoded:i="",totalDecodeTime:s="",jitterBufferEmittedCount:a="",framesReceived:r="",ssrc:n}=e;if(!n)return;const o=this.ssrcMidMap[n],c="mid-".concat(o,"-ssrc-").concat(n);if(this.recvRawStats[c]){const{startTime:e}=this.recvRawStats[c],n=this.recvRawStats[c].framesDecoded.length,o=Math.floor((t-e)/1e3)-n;if(n+o>A)this._generateRecvRawLog(c),this.recvRawStats[c]={startTime:t,framesDecoded:[i],totalDecodeTime:[Math.round(1e3*s)],jitterBufferEmittedCount:[a],framesReceived:[r]};else for(let e=0;e<o;e++){const t=e===o-1;this.recvRawStats[c].framesDecoded.push(t?i:""),this.recvRawStats[c].totalDecodeTime.push(t?Math.round(1e3*s):""),this.recvRawStats[c].jitterBufferEmittedCount.push(t?a:""),this.recvRawStats[c].framesReceived.push(t?r:"")}}else this.recvRawStats[c]={startTime:t,framesDecoded:[i],totalDecodeTime:[Math.round(1e3*s)],jitterBufferEmittedCount:[a],framesReceived:[r]}}_captureRawSendData(e){if(!e)return;const{type:t}=e;if("outbound-rtp"===t){const{timestamp:t,framesSent:i,framesEncoded:s,totalEncodeTime:a,ssrc:r}=e,n="sim-".concat(this.ssrcLayerMap[r],"-ssrc-").concat(r);if(this.sendRawStats[n]){const{startTime:e}=this.sendRawStats[n],r=this.sendRawStats[n].framesSent.length,o=Math.floor((t-e)/1e3)-r;if(r+o>A)this._generateSendRawLog(n),this.sendRawStats[n]={startTime:t,framesSent:[i],framesEncoded:[s],totalEncodeTime:[Math.round(1e3*a)]};else for(let e=0;e<o;e++){const t=e===o-1;this.sendRawStats[n].framesSent.push(t?i:""),this.sendRawStats[n].framesEncoded.push(t?s:""),this.sendRawStats[n].totalEncodeTime.push(t?Math.round(1e3*a):"")}}else this.sendRawStats[n]={startTime:t,framesSent:[i],framesEncoded:[s],totalEncodeTime:[Math.round(1e3*a)]}}else if("media-source"===t){const{frames:t,timestamp:i}=e;if(!t&&0!==t)return;if(this.sendRawStats.capturedFrames){const{startTime:e}=this.sendRawStats.capturedFrames,s=this.sendRawStats.capturedFrames.frames.length,a=Math.floor((i-e)/1e3)-s;if(s+a>A)this._generateSendRawLog("capturedFrames"),this.sendRawStats.capturedFrames={startTime:i,frames:[t]};else for(let e=0;e<a;e++){const i=e===a-1;this.sendRawStats.capturedFrames.frames.push(i?t:"")}}else this.sendRawStats.capturedFrames={startTime:i,frames:[t]}}}reportRawStats(){for(const e in this.sendRawStats)this._generateSendRawLog(e,!1);for(const e in this.recvRawStats)this._generateRecvRawLog(e,!1);this._uploadRawStats()}_generateRecvRawLog(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const{startTime:i,framesDecoded:s,framesReceived:a,jitterBufferEmittedCount:r,totalDecodeTime:n}=this.recvRawStats[e],o="".concat(this.userId,",0,").concat(e,",").concat(Math.round(i/1e3),",framesDecoded=").concat(JSON.stringify(s),",framesReceived=").concat(JSON.stringify(a),",jitterBufferEmittedCount=").concat(JSON.stringify(r),",totalDecodeTime=").concat(JSON.stringify(n));this._sendRawLog(o,t),delete this.recvRawStats[e]}_generateSendRawLog(e){let t,i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if("capturedFrames"===e){const{frames:i,startTime:s}=this.sendRawStats[e];t="".concat(this.userId,",1,").concat(e,",").concat(Math.round(s/1e3),",capturedFrames=").concat(JSON.stringify(i))}else{const{startTime:i,framesEncoded:s,framesSent:a,totalEncodeTime:r}=this.sendRawStats[e];t="".concat(this.userId,",1,").concat(e,",").concat(Math.round(i/1e3),",framesEncoded=").concat(JSON.stringify(s),",framesSent=").concat(JSON.stringify(a),",totalEncodeTime=").concat(JSON.stringify(r))}this._sendRawLog(t,i),delete this.sendRawStats[e]}_sendRawLog(e,t){this.rawLog.push(e),t&&this.rawLog.length>O&&this._uploadRawStats()}_uploadRawStats(){if(this.rawLog.length>0){const e=this.rawLog.join("|");this.rawLog=[],z(e,M.GZIP_BASE64).then((e=>{q.globalTrace({logLevel:"directReport",log:e,tags:["WCL_WB_RAW_STATS"]})})).catch((()=>{q.globalTrace({logLevel:"directReport",log:rawLog,tags:["WCL_WB_RAW_STATS"]})}))}}detectDecodeFailed(e){const{framesDecoded:t,jitterBufferEmittedCount:i="",pliCount:s,packetsLost:a,framesReceived:r=""}=this.recvStats["begin-video-inbound-rtp"][e],{framesDecoded:n,jitterBufferEmittedCount:o="",pliCount:c,packetsLost:d,decoderImplementation:h,framesReceived:l=""}=this.recvStats["video-inbound-rtp"][e],{decodePausedCount:u}=this.recvStats.statisticData[e],m="".concat(n,",").concat(t,",").concat(o,",").concat(i,",").concat(d,",").concat(a,",").concat(c,",").concat(s,",").concat(h,",").concat(u,",").concat(l,",").concat(r);return!(n>t)&&("NullVideoDecoder"===h?m:o-i<=5?!o&&l-r>150&&u>10&&m:(0===n&&c>s&&d===a||u>10)&&m)}getRecvH264Profile(e){if(this.recvStats.codec){var t;const i=null===(t=this.recvStats.codec)||void 0===t?void 0:t[e];if(i){const{sdpFmtpLine:e=""}=i,t=e.match(/profile-level-id=([A-Za-z0-9]+);/);if(t)return t[1].substring(0,2)}}return this.recvCodecProfile}onDualCallState(e){let{isDualCall:t}=e;this.isDualCall=t}};function lt(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,s)}return i}function ut(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?lt(Object(i),!0).forEach((function(t){(0,h.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):lt(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const mt=q.getTracer("WmscApiImpl"),pt=e=>{mt.log(e),q.monitorLog("".concat(e))},St=c.INGRESS,gt=c.EGRESS,_t=class{constructor(e,t){mt.log("created, config: ".concat(JSON.stringify(e))),x.setConfig(e||{}),this.messageCallback=t,this.resetRunTimeParams(),it.setLimits({maxSendVideoSize:x.maxCaptureVideoSize,maxRecvVideoNum:x.maxRecvVideoNum}),this.videoCapabilities=it.getCapabilities();const{maxSendVideoSize:i,maxRecvVideoSize:s,maxRecvVideoNum:a}=this.videoCapabilities;pt("WMSC_V_Cap_Updated: ".concat(i,"|").concat(s,"|").concat(a)),this.recvMLineNum=a+1,this.maxRecvVideoSize=s,Fe.registerMessageCallback(this.onMediaMessage.bind(this)),Fe.enableHdVideo(x.hdVideoEnabled),Fe.setVideoSettings(x.videoSettings),this.renewEgressPeerConnection(),this.renewIngressPeerConnection(),ht.setUserId(x.nodeId),ht.onDecodeError=this._handleDecodeError.bind(this),ht.start(),Ue.registerSendUsageStateUpdateCallback(this.onSendUsageStateUpdate.bind(this)),Ue.registerMaxRecvVideoSizeUpdateCallback(this.onMaxRecvVideoSizeUpdate.bind(this)),Ue.start(x.qosOptions),this.recevCSRCRecord=new Map,this._checkCSRCTimer=null,this.negotiationMsgId=0,this.messageCallback({type:k.VIDEO_CAPABILITIES_CHANGE,data:this.videoCapabilities}),pt("WMSC_RCN-".concat(Fe.recvCodecNum)),pt("WMSC_SW_PRE: ".concat(Ie("send"),"|").concat(Ie("recv"))),this.renegotiationQueue=[[],[]]}destroy(){this.closeAllPeerConnections(),this.resetRunTimeParams(),this.recevCSRCRecord.clear(),clearInterval(this._checkCSRCTimer),Ue.stop(),null==ht||ht.stop()}resetRunTimeParams(){mt.log("reset run time parameters"),this.pcInfos=new Map([[St,{status:d.IDLE,reconnectionCount:0,negotiationTimer:0,offerMsgId:0,useIceServers:!1,iceRestartCount:0,iceRestartCountOrg:0,iceRestartTimer:0}],[gt,{status:d.IDLE,reconnectionCount:0,negotiationTimer:0,offerMsgId:0,useIceServers:!1,iceRestartCount:0,iceRestartCountOrg:0,iceRestartTimer:0}]]),this.camStreams=null,this.bSendEnabled=!1,this.bActiveVideo=!1,this.bPrevActiveVideo=!1,this.lastSubList=[],this.sourceVideoSize=-1,this.lastUpdatedSourceVideoSize=-1,this.bReceiveEnabled=!1,this._toSubscribeBuffer=[],this._videoTagMappingBuffer=new Map,this.mIdMgr=null,this.subscriptions=new Map,this.maxSubVideoSize=-1}async renewEgressPeerConnection(){const e=this._getPcInfo(gt);let t=null==e?void 0:e.useIceServers;this.createPeerConnection(gt,"video","sendonly",t?x.iceServers:[]),t&&q.globalTrace({logLevel:"directReport",log:"WMSC_USE_TURN:Send"}),this.camStreams&&this._addVideoStreams(this.camStreams),this.bSendEnabled=!0,await this.startNegotiation(gt),Fe.onMediaRequest(this.lastSubList)}async renewIngressPeerConnection(){pt("WMSC_Start_Recv_Video");const e=this._getPcInfo(St);let t=null==e?void 0:e.useIceServers;this.createPeerConnection(St,"video","recvonly",t?x.iceServers:[]),t&&q.globalTrace({logLevel:"directReport",log:"WMSC_USE_TURN:Recv"}),this.bReceiveEnabled=!0,await this.startNegotiation(St);const i=Array.from(Fe.getRecvTransceivers().keys());null!=i&&i.length?(this.mIdMgr=this.mIdMgr||new tt(i),this._mapBufferedVideoTag()):(pt("WMSC_Get_Recv_Mid_Fail: ".concat(St)),this.mIdMgr=new tt([])),ht.mIdMgr=this.mIdMgr}stopReceiveVideo(){pt("WMSC_Stop_Recv_Video"),this.sendBye(St),this.closePeerConnection(St),this.mIdMgr=null,this.bReceiveEnabled=!1}createPeerConnection(e,t,i,s){mt.log("createPeerConnection, peerId: ".concat(e,", type: ").concat(t," direction: ").concat(i));const a=e===St?this.recvMLineNum:1;return Fe.createPeerConnection(e,t,i,a,s)}async _addVideoStreams(e){var t,i;const s=null===(t=e[0])||void 0===t||null===(t=t.stream)||void 0===t?void 0:t.getVideoTracks()[0],a=null===(i=e[e.length-1])||void 0===i||null===(i=i.stream)||void 0===i?void 0:i.getVideoTracks()[0],r=null==a?void 0:a.getSettings();if(a){const{width:e,height:t,frameRate:i}=r||{};pt("WMSC_Original_Video_Track: ".concat(e,"x").concat(t,"@").concat(i,"fps")),this.sourceVideoSize=fe({width:e,height:t}),Fe.setMaxSendLayerId(Math.min(this.videoCapabilities.maxSendVideoSize,this.sourceVideoSize))}else this.sourceVideoSize=-1,this.lastUpdatedSourceVideoSize=-1;await Fe.publishVideoTrack(s,r)}async onVideoStreamsAsync(e){var t;return this.camStreams=e,ht.camStream=null===(t=e[1])||void 0===t?void 0:t.stream,await this._addVideoStreams(e),Promise.resolve(!0)}async startNegotiation(e){const t=this._getPcInfo(e);t.status=d.CONNECTING,t.negotiationTimer=setTimeout((()=>{const i=Fe.getNegotiationTime(e);q.globalTrace({logLevel:"error",log:"WMSC Negotiation timeout: ".concat(e,"-").concat(t.offerMsgId,"-").concat(i.join("-"))}),t.reconnectionCount<g?this.restartNegotiation(e):this.messageCallback({type:k.SDP_NEGOTIATION_FAIL,data:e})}),S);const i=await Fe.createOffer(e);this._handleSdpOffer(e,i)}restartNegotiation(e){const t=this._getPcInfo(e);t.reconnectionCount++,t.offerMsgId=0,pt("WMSC_Restart_Nego: ".concat(e,"|").concat(t.reconnectionCount)),this.sendBye(e),this.closePeerConnection(e),this.messageCallback({type:k.ERROR_MESSAGE,data:{type:"PC_RECONNECT",mediaType:"video"}}),e===St?this.bReceiveEnabled&&this.renewIngressPeerConnection():this.renewEgressPeerConnection()}closePeerConnection(e){const t=this._getPcInfo(e);return clearTimeout(t.negotiationTimer),clearTimeout(t.iceRestartTimer),t.status=d.IDLE,this.renegotiationQueue[e]=[],Fe.closePeerConnection(e)}closeAllPeerConnections(){for(const e of this.pcInfos.keys())this.closePeerConnection(e)}onMediaMessage(e){const{type:t,data:i,peerId:s}=e;switch(mt.log("onMediaMessage, peerId: ".concat(s," type: ").concat(t)),t){case I.STREAM:this._handleRemoteStream(s,i);break;case I.PC_STATE_CHANGE:this._handlePcStateChange(s,i);break;case I.ERROR:mt.error("onMediaMessage, error: ".concat(i));break;case I.NO_H264_CODEC:pt("WMSC_NO_CODEC_".concat(s)),q.globalTrace({logLevel:"error",log:"WMSC_NO_CODEC_".concat(s)}),this.messageCallback({type:k.SDP_NEGOTIATION_FAIL,data:s});break;default:mt.error("onMediaMessage, unknown type: ".concat(t))}}onSendUsageStateUpdate(e){e===E.UNDERUSING&&this.sourceVideoSize>=0&&this._maybeUpdateVideoSourceConstraints(this.sourceVideoSize+1)}_maybeUpdateVideoSourceConstraints(e){let t=x.maxCaptureVideoSize;if(x.hdVideoEnabled||(t=Math.min(2,t)),e<=t&&e!==this.lastUpdatedSourceVideoSize){const t=pe(e),i={width:t.width,height:t.height,frameRate:t.maxFramerate};return this.messageCallback({type:k.UPDATE_VIDEO_CAPTURE_CONSTRAINTS,data:i}),this.lastUpdatedSourceVideoSize=e,!0}return!1}onMaxRecvVideoSizeUpdate(e){this.maxRecvVideoSize=Math.min(this.videoCapabilities.maxRecvVideoSize,e);const t=[];for(const[i,s]of this.subscriptions){const a=this.mIdMgr.getVideoSizeByUserId(i),r=Math.min(e,s);a!==r&&t.push({id:i,size:r})}t.length&&this._updateSubscriptions(t)}_handleVideoTagMappingBuffer(e,t,i){const s=this._videoTagMappingBuffer.get(e)||[];switch(t){case"add":s.push(i),this._videoTagMappingBuffer.set(e,s);break;case"remove":for(let e=0;e<s.length;)s[e]===i?s.splice(e,1):e++;s.length||this._videoTagMappingBuffer.delete(e);break;default:pt("WMSC_Mapping_Buffer_Action_E: ".concat(e,"|").concat(t))}}onVideoTagMapping(e){const t=parseInt(e.userId),{videodom:i,action:s}=e;if(pt("WMSC_Video_Tag_Mapping: ".concat(t,"|").concat(s,"|").concat(!!this.mIdMgr)),this.mIdMgr)switch(s){case"add":case"buffer":this.mIdMgr.saveVideoTag(t,i),this.messageCallback({type:k.VIDEO_TAG_MAPPED,data:t});break;case"remove":this.mIdMgr.removeVideoTag(t,i);break;default:pt("WMSC_Mapping_Action_E: ".concat(t,"|").concat(s))}else mt.warn("onVideoTagMapping, mIdMgr not ready yet. Will do mapping later."),this._handleVideoTagMappingBuffer(t,s,i)}getUserIdVideo(e){return this.mIdMgr?this.mIdMgr.getVideoByUserId(e):null}_mapBufferedVideoTag(){this._videoTagMappingBuffer.size&&(this._videoTagMappingBuffer.forEach(((e,t)=>{(null==e?void 0:e.length)>0&&e.forEach((e=>{this.onVideoTagMapping({userId:t,videodom:e,action:"buffer"})}))})),this._videoTagMappingBuffer.clear())}subscribeVideo(e){const t=this._getPcInfo(St);if(t.status!==d.CONNECTED)return e.forEach((e=>{this._toSubscribeBuffer.push({params:e,toSub:!0})})),void pt("WMSC_SubV_PC_N_Ready: ".concat(t.status));const i=Math.min(this.maxRecvVideoSize,Ue.getMaxFeasibleRecvVideoSize());let s=-1;const a=[];e.forEach((e=>{const{id:t,size:r}=e;this.subscriptions.set(t,r),r>s&&(s=r);const n=Math.min(r,i),o=this._addSubscription({id:t,size:n});if(o){a.push(o);const{userId:e,mId:t,videoSize:i}=o;this._updateVideoElement(e,t),this.mIdMgr.setMidReleasedStatus(t,!1),pt("WMSC_Send_Stream_Mapping: ".concat(e,"ï½œ").concat(i,"ï½œ").concat(t)),ht.updateSubInfo(e,i)}})),s>this.maxSubVideoSize&&(this.maxSubVideoSize=s,Ue.updateMaxSubVideoSize(s)),a.length&&this._sendStreamMappings(a)}unSubscribeVideo(e){if(this._getPcInfo(St).status!==d.CONNECTED)return e.forEach((e=>{this._toSubscribeBuffer.push({params:e,toSub:!1})})),void pt("WMSC_UnsubV_PC_N_Ready");let t=-1;const i=[];e.forEach((e=>{this.subscriptions.delete(e.id);const t=this._removeSubscription(e);if(t){const{userId:e,videoSize:s}=t;i.push(t),ht.updateSubInfo(e,s)}}));for(const[,e]of this.subscriptions)e>t&&(t=e);this.maxSubVideoSize!==t&&(this.maxSubVideoSize=t,Ue.updateMaxSubVideoSize(t)),i.length&&this._sendStreamMappings(i)}_addSubscription(e){var t,i;const s=parseInt(e.id),a=e.size;pt("WMSC_SubV_Params: ".concat(s,"|").concat(a));const r=(null===(t=this.mIdMgr)||void 0===t?void 0:t.getMId(s))||(null===(i=this.mIdMgr)||void 0===i?void 0:i.getNewMId(s));if(r)return this.mIdMgr.setVideoSize(r,a),mt.log("_addSubscription, userId: ".concat(s,", mId: ").concat(r,", videoSize: ").concat(a)),{userId:s,mId:r,videoSize:a};pt("WMSC_SubV_No_Mid:".concat(s))}_removeSubscription(e){var t;const i=parseInt(e.id);this._videoTagMappingBuffer.delete(i),clearInterval(this.recevCSRCRecord.get(i));const s=null===(t=this.mIdMgr)||void 0===t?void 0:t.getMId(i);if(pt("WMSC_UnsubV_Params: ".concat(i,"|").concat(s)),s)return this.mIdMgr.releaseMId(s),this.recevCSRCRecord.delete(i),{userId:i,mId:s,videoSize:-1}}_updateSubscriptions(e){const t=[],i=[];e.forEach((e=>{var s;const{id:a,size:r}=e,n=null===(s=this.mIdMgr)||void 0===s?void 0:s.getMId(a);n&&(t.push({userId:a,mId:n,videoSize:-1}),i.push({userId:a,mId:n,videoSize:r}),this.mIdMgr.setVideoSize(n,r))})),this._sendStreamMappings(t),this._sendStreamMappings(i)}onRwgMessage(e){const t="string"==typeof e.data?JSON.parse(e.data):e.data;if((null==t?void 0:t.evt)===Je||(null==t?void 0:t.evt)===Ke){const e=t.body;switch(e.type){case ze:return mt.log("on SDP_ANSWER"),this.onSdpAnswer(e),!0;case je:return mt.log("on SDP_BYE"),this.onSdpBye(e),!0;case Qe:return mt.log("on ICE_DISCONNECTED"),this.onIceDisconnected(e),!0;case Ye:return this.onSubscribeList(e.activeVideo,e.prevActiveVideo,e.privateVideo),!0;case qe:return this.onCommand(e),!0;default:return mt.warn("Received unknown RWG message type: ".concat(e.type)),!1}}}async onSdpAnswer(e){if(!this._checkMsgIdForPC(e))return;const{peerID:t,sdp:s,sdpEncoding:a}=e;try{const e=await function(e,t){return G(this,void 0,void 0,(function*(){switch(t){case M.GZIP_BASE64:{const t=function(e){const t=atob(e),i=new Uint8Array(t.length);for(let e=0;e<i.length;e++)i[e]=t.charCodeAt(e);return i.buffer}(e);return function(e){return G(this,void 0,void 0,(function*(){if(window.DecompressionStream){const t=new DecompressionStream("gzip"),i=t.writable.getWriter();return i.write(e),i.close(),new Response(t.readable).arrayBuffer().then((function(e){return(new TextDecoder).decode(e)}))}{const{ungzip:t}=yield i.e(404).then(i.bind(i,3075));return(new TextDecoder).decode(t(e).buffer)}}))}(t)}case M.PLAIN:return e;default:return null}}))}(s,a);ht.sendSdpLog(t,"ANSWER",e),await Fe.setAnswer(t,e);const r=this._getPcInfo(t);clearTimeout(r.iceRestartTimer),r.iceRestartCount=0,setTimeout((()=>{const e=Fe.getPc(t),i=this._getPcInfo(t);"connected"!==e.connectionState?i.iceRestartCount=i.iceRestartCountOrg:i.iceRestartCountOrg=0}),_),this._popRenegotiationQueue(t)}catch(e){q.globalTrace({logLevel:"error",log:"WMSC_Decompress_SDP_Anwser_F",error:e})}}onSdpBye(e){if(!this._checkMsgIdForPC(e))return;const{peerID:t}=e;"have-local-offer"===Fe.getPc(t).signalingState?(this.closePeerConnection(t),q.globalTrace({logLevel:"error",log:"WMSC_SDP_BYE_REJECT"}),pt("WMSC_BYEREJ"),this.messageCallback({type:k.SDP_NEGOTIATION_FAIL,data:t})):(pt("WMSC_BYERET"),this.restartNegotiation(t))}onIceDisconnected(e){this._checkMsgIdForPC(e)&&(pt("WMSC_ICE_DISCON"),q.globalTrace({logLevel:"error",log:"WMSC_RestartIce_F_S"}),this.restartIce(e.peerID))}restartIce(e){this._pushToRenegotiationQueue(e,V.ICE)}async doRenegotiation(e,t){const i=this._getPcInfo(e);if(i.iceRestartCountOrg++,i.iceRestartCount++>=g)return i.reconnectionCount=g,this.sendBye(e),this.closePeerConnection(e),void this.messageCallback({type:k.SDP_NEGOTIATION_FAIL,data:e});pt("WMSC_Renegotiation: ".concat(e,"|").concat(i.iceRestartCount,"|").concat(t)),t&&(clearTimeout(i.iceRestartTimer),i.iceRestartTimer=setTimeout((()=>{if("connected"!==Fe.getPc(e).iceConnectionState){const i=Fe.getNegotiationTime(e);q.globalTrace({logLevel:"error",log:"WMSC restartIce timeout: ".concat(e,"-").concat(i.join("-"))}),this.doRenegotiation(e,t)}}),_));const s=await Fe.createOffer(e,{iceRestart:t});this._handleSdpOffer(e,s)}onSubscribeList(e,t,i){var s;pt(Q("WMSC_On_Sub_List: ".concat(JSON.stringify(e),"|").concat(JSON.stringify(t),"|").concat(JSON.stringify(i)))),ht.updateSubscribedSize(e,t,i);const a=u()(s=Array.from(new Set([...e,...t,...i]).values()).filter((e=>e>=0))).call(s);j(a,this.lastSubList)||(this.lastSubList=[...a],this.bSendEnabled||this.renewEgressPeerConnection(),Fe.onMediaRequest(a))}onCommand(e){if(0===e.cmdId){let t;try{t=JSON.parse(e.cmdParam)}catch(t){mt.warn("Invalid command message: ".concat(JSON.stringify(e)))}void 0!==t.receiverBW?Ue.onReceiverBandwidthReport(t.receiverBW):void 0!==t.subInfo?(Ue.onSubInfo(t.subInfo),ht.onDualCallState(t.subInfo)):void 0!==t.ingressReport&&(Ue.onReceiverReport(t.ingressReport),ht.onReceiverReport(t.ingressReport))}else mt.warn("Unknown command id ".concat(e.cmdId))}onActiveVideoSourceChange(e){const t=parseInt(x.nodeId)===parseInt(e.userId);return this.bPrevActiveVideo=this.bActiveVideo&&!t,this.bActiveVideo=t,ht.setActiveSpeaker(e.userId,this.bPrevActiveVideo),pt("WMSC_OASC: ".concat(e.userId)),!0}updateWmscParams(e){mt.log("updateWmscParams, data: ".concat(JSON.stringify(e))),Object.keys(e).forEach((t=>{switch(t){case"HDVideo":x.setConfig({[t]:e[t]}),Fe.enableHdVideo(!!e[t]);break;case"preferSoftwareCodec":{const i=Ie("send"),s=Ie("recv");this._updateSoftwareCodecPreference(e[t]),i!==Ie("send")&&(pt("WMSC_SW_PRE_SEND: ".concat(!i)),this._getPcInfo(c.EGRESS).status!==d.IDLE&&this._pushToRenegotiationQueue(c.EGRESS,V.MEDIA)),s!==Ie("recv")&&(pt("WMSC_SW_PRE_RECV: ".concat(!i)),this._getPcInfo(c.EGRESS).status!==d.IDLE&&this._pushToRenegotiationQueue(c.INGRESS,V.MEDIA));break}default:mt.warn("updateWmscParams, unknown param name: ".concat(t))}}))}sendBye(e){const t=(i=x.confId,s=n.VIDEO,a=x.nodeId,r=e,o=this.negotiationMsgId,{type:je,confID:i,sessionID:s,userID:a,peerID:r,msgID:o,sdp:""});var i,s,a,r,o;pt("WMSC_SDPBYE: ".concat(x.confId,"|").concat(e)),this._sendMessageToRwg({evt:Je,body:t})}stopSendingVideo(){this._getPcInfo(gt).status=d.IDLE,this.sendBye(gt),Fe.stopSendingVideo()}_sendStreamMappings(e){const t=e.map((e=>{let{userId:t,mId:i,videoSize:s}=e;return((e,t,i,s,a,r,n)=>({type:He,confID:e,sessionID:t,userID:i,peerID:s,mID:a,streamID:r,videoSize:n}))(x.confId,n.VIDEO,t,St,i,s>=0?function(e,t){let i=0;switch(t){case n.VIDEO:i=o.VIDEO;break;case n.AUDIO:i=o.AUDIO;break;case n.SHARE:i=o.SHARE}return-4&e|i}(t,n.VIDEO):0,s)}));this.messageCallback({type:k.WMSC_MAPPING_STREAMID_AND_MID,data:JSON.stringify({evt:Ke,body:t})})}_sendMessageToRwg(e){this.messageCallback({type:k.WMSC_MESSAGE_TO_RWG_BY_SDK,data:JSON.stringify(e)})}_handleRemoteStream(e,t){var i,s;if(e!==St){const t="WMSC_RSP_N_M: ".concat(e);return mt.warn(t),void pt(t)}const a=new MediaStream;a.addTrack(t.track);const r=t.transceiver.mid;null===(i=this.mIdMgr)||void 0===i||i.updateStream(r,a);const n=null===(s=this.mIdMgr)||void 0===s?void 0:s.getVideoTags(r);n&&n.length?(pt("WMSC_RSV_M: ".concat(r)),n.forEach((e=>{e.srcObject=a}))):mt.log("_handleRemoteStream, video element is not mapped yet, mid= ".concat(r))}async _handleSdpOffer(e,t){let i=M.PLAIN,s=t;const a=Fe.getPc(e);try{s=await z(t,M.GZIP_BASE64),i=M.GZIP_BASE64}catch(e){q.globalTrace({logLevel:"error",log:"WMSC_Compress_SDP_Offer_F",errorEvent:e})}if(Fe.getPc(e)!==a)return;const r=++this.negotiationMsgId,o=((e,t,i,s,a,r,n)=>({type:Ge,confID:e,sessionID:t,userID:i,peerID:s,msgID:a,sdp:r,sdpEncoding:n}))(x.confId,n.VIDEO,x.nodeId,e,r,s,i);this._getPcInfo(e).offerMsgId=r,this._sendMessageToRwg({evt:Je,body:o}),ht.sendSdpLog(e,"OFFER",t)}_handlePcStateChange(e,t){const i=this._getPcInfo(e);if("connected"===t)if(clearTimeout(i.negotiationTimer),clearTimeout(i.iceRestartTimer),i.status=d.CONNECTED,i.reconnectionCount=0,i.negotiationTimer=0,mt.log("_handlePcStateChange: peerId= ".concat(e," connected")),e===St){for(this._reSubVideo();this._toSubscribeBuffer.length;){const e=this._toSubscribeBuffer.shift();e.toSub?this.subscribeVideo([e.params]):this.unSubscribeVideo([e.params])}this.messageCallback({type:k.V_RECEV_PC_CONNECTED,data:e})}else this.messageCallback({type:k.V_SEND_PC_CONNECTED,data:e});else if("disconnected"===t)pt("WMSC_PC_Disconn: ".concat(e)),q.globalTrace({logLevel:"error",log:"WMSC_RestartIce_F_C"}),this.restartIce(e);else if("failed"===t)pt("WMSC_PC_Failed: ".concat(e)),q.globalTrace({logLevel:"error",log:"WMSC_RestartIce_F_C"}),this.restartIce(e);else if("connecting"===t){var s,a;pt("WMSC_PC_ConnectTimeout: ".concat(e,",iceserver: ").concat(null===(s=x.iceServers)||void 0===s?void 0:s.length));const t=this._getPcInfo(e);!t.useIceServers&&(null===(a=x.iceServers)||void 0===a?void 0:a.length)>0&&(t.useIceServers=!0,this.restartNegotiation(e))}}_getPcInfo(e){return this.pcInfos.get(e)}_reSubVideo(){const e=this.mIdMgr.mIdUsedStatus,t=[];for(const i in e)if(e[i].used&&e[i].userId){const{userId:s,videoSize:a}=e[i];t.push({userId:s,mId:i,videoSize:a}),this._updateVideoElement(s,i),this.mIdMgr.setMidReleasedStatus(i,!1)}pt("WMSC_ReSub_Video"),q.globalTrace({logLevel:"log",log:"WMSC_ReSub_Video"}),this._sendStreamMappings(t)}_updateVideoElement(e,t){const i=Fe.getPc(St);if(pt("WMSC_UpdateV_Ele: ".concat(e,"|").concat(t,"|").concat(!!i)),!i)return;const{preUserId:s,released:a}=this.mIdMgr.mIdUsedStatus[t];if(!s||s===e||a)return void this.mIdMgr.updateVideoElement(t);const r=Date.now();this.recevCSRCRecord.set(e,{mId:t,startToWait:r}),this._checkCSRCTimer||(this._checkCSRCTimer=setInterval(this._checkCSRC.bind(this),100))}_checkCSRC(){if(0===this.recevCSRCRecord.size)return clearInterval(this._checkCSRCTimer),void(this._checkCSRCTimer=null);this.recevCSRCRecord.forEach(((e,t)=>{const{mId:i,startToWait:s}=e,a=Date.now()-s;if(a>1e4)return pt("WMSC_CSRC_Timeout: ".concat(t,"|").concat(i,"|").concat(s,"|").concat(a)),void this.recevCSRCRecord.delete(t);const r=Fe.getRemoteSourceId(i);r&&r>>2==t>>2&&(mt.log("Receive subscribe video, userId: ".concat(t," in ").concat(a,"ms")),this.mIdMgr.updateVideoElement(i),this.messageCallback({type:k.VIDEO_SOURCE_UPDATED,userId:t}),this.recevCSRCRecord.delete(t))}))}_handleDecodeError(e){Fe.removeRecvCodecByProfile(e),0===Fe.recvCodecNum?(q.globalTrace({logLevel:"error",log:"WMSC_No_Recv_Codec"}),pt("WMSC_ERC"),this.messageCallback({type:k.SDP_NEGOTIATION_FAIL,data:c.INGRESS})):this._pushToRenegotiationQueue(c.INGRESS,V.MEDIA)}_checkMsgIdForPC(e){const{peerID:t,msgID:i}=e,{offerMsgId:s}=this._getPcInfo(e.peerID);return i===s||(mt.warn("Message id ".concat(i," doesn't match the offer message id ").concat(s," for peer id ").concat(t)),!1)}_pushToRenegotiationQueue(e,t){const i=this.renegotiationQueue[e];i.length<2?i.push({iceRestart:t===V.ICE}):i[1].iceRestart||(i[1].iceRestart=t===V.ICE),1===i.length&&this.doRenegotiation(e,i[0].iceRestart)}_popRenegotiationQueue(e){const t=this.renegotiationQueue[e];t.shift(),t.length&&this.doRenegotiation(e,t[0].iceRestart)}_updateSoftwareCodecPreference(e){var t;let{videoSettings:i}=x.getConfig();var s;null!==(t=i)&&void 0!==t&&t.preferSoftwareCodec?i.preferSoftwareCodec=ut(ut({},null===(s=i)||void 0===s?void 0:s.preferSoftwareCodec),e):i={preferSoftwareCodec:e},x.setConfig({videoSettings:i})}},vt=q.getTracer("Wmsc"),ft=e=>{vt.log(e),q.monitorLog("".concat(e))};class It{constructor(e,t){return q.setTrace(),q.setTelemetry(t),ht.setTelemetry(t),this.messageCallback=t,this.config=e,ft("WMSC_INIT"),!0}setTrace(e,t){q.setTrace(e,t)}updateQosSubscription(e,t){ht.updateQosSubscription(e,t)}reportWMSCPeerConnectionRawStats(){ht.reportRawStats()}getHasPausedVideo(){var e;return null===(e=this.wmscApiImpl)||void 0===e||null===(e=e.mIdMgr)||void 0===e?void 0:e.getHasPausedVideo()}playAllUsedVideoTag(){var e;return null===(e=this.wmscApiImpl)||void 0===e||null===(e=e.mIdMgr)||void 0===e?void 0:e.playAllUsedVideoTag()}getUserIdVideo(e){var t;return null===(t=this.wmscApiImpl)||void 0===t?void 0:t.getUserIdVideo(e)}destroy(){var e;ft("WMSC_DESTROYED"),null===(e=this.wmscApiImpl)||void 0===e||e.destroy(),this.wmscApiImpl=null}onMessage(e,t){if(e!==U.NOTIFY_SDK_JOIN_RWG_SUCCESS&&!this.wmscApiImpl)return this.sendMessage&&this.sendMessage({type:k.ERROR,data:"WMSC on MediaSDK message, MediaSDK not ready, type = "+e}),vt.error("onMessage, the caller not ready type ".concat(e)),!1;switch(e){case U.NOTIFY_SDK_JOIN_RWG_SUCCESS:return this.messageCallback?(this.wmscApiImpl=new _t(this.config,this.sendMessage.bind(this)),!0):(vt.error("onMessage, messageCallback to the caller not set"),!1);case U.NOTIFY_SDK_JOIN_RWG_FAILURE:return!0;case U.WMSC_MESSAGE_FROM_RWG:return this._onRwgMessage(t.data);case U.NOTIFY_WMSC_VIDEO_TAG_MAPPING:return this._onVideoTagMapping(t.data);case U.NOTIFY_SDK_SUBSCRIBE_VIDEO:return this._onSubscribeVideo(t.data);case U.NOTIFY_SDK_UNSUBSCRIBE_VIDEO:return this._onUnSubscribeVideo(t.data);case U.NOTIFY_SDK_ACTIVE_VIDEO_INDICATION:return this._onActiveVideoSourceChange(t.data);case U.UPDATE_WMSC_PARAMS:return this._onUpdateWmscParams(t.data);default:return this.sendMessage({type:k.ERROR,data:"WSMC receive not handled event type = "+e}),vt.error("onMessage, unknown type ".concat(e)),ft("WSMC_Rece_U_E: ".concat(e)),!1}}onMessageAsync(e,t){return vt.log("WMSC_Recv_Async_M",e,JSON.stringify(t)),ft("WMSC_Recv_Async_M: ".concat(e)),e===U.VIDEO_STREAMS?this._onVideoStreamsAsync(t.streams):(this.sendMessage({type:k.ERROR,data:"WSMC receive not handled event type =".concat(e)}),vt.error("WSMC receive not handled event type =".concat(e)),Promise.reject("Unknown message type"))}sendMessage(e){vt.log("sendMessage",JSON.stringify(e)),this.messageCallback&&this.messageCallback(e)}_onVideoStreamsAsync(e){return this.wmscApiImpl.onVideoStreamsAsync(e)}_onRwgMessage(e){return this.wmscApiImpl.onRwgMessage(e)}_onVideoTagMapping(e){return this.wmscApiImpl.onVideoTagMapping(e)}_onSubscribeVideo(e){return this.wmscApiImpl.subscribeVideo(e)}_onUnSubscribeVideo(e){return this.wmscApiImpl.unSubscribeVideo(e)}_onActiveVideoSourceChange(e){return this.wmscApiImpl.onActiveVideoSourceChange(e)}_onUpdateWmscParams(e){return this.wmscApiImpl.updateWmscParams(e)}}class Ct{constructor(){this.status="pending",this.promise=new Promise(((e,t)=>{this.reject=e=>(this.status="rejected",t(e)),this.resolve=t=>(this.status="fullfilled",e(t))})),this.then=this.promise.then,this.catch=this.promise.catch}}var Et,Rt,bt,Mt=i(9109),Tt=i(1461),yt=i(701),Lt=i(5408),wt=i(7080),Dt=i(5932),At=i(7350),Ot=i.n(At),Pt=i(9407),Nt=function(e,t,i,s){return new(i||(i=Promise))((function(a,r){function n(e){try{c(s.next(e))}catch(e){r(e)}}function o(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}c((s=s.apply(e,t||[])).next())}))};!function(e){e.visibilitychange="visibilitychange",e.streamCaptureSuccess="streamCaptureSuccess",e.videoTrackUnmute="videoTrackUnmute",e.addRenderVideo="addRenderVideo",e.userClick="userClick",e.fromVBModule="fromVBModule",e.reuseCaptureStream="reuseCaptureStream"}(Et||(Et={})),function(e){e.destroy="destroy"}(Rt||(Rt={})),function(e){e.WMSC_WSS_OPEN_FAIL_IN_30s="WMSC_WSS_OPEN_FAIL_IN_30s",e.WMSC_WSS_NOT_RECEIVE_MSG_IN_30s="WMSC_WSS_NOT_RECEIVE_MSG_IN_30s",e.WMSC_WSS_CLOSE="WMSC_WSS_CLOSE",e.WMSC_WSS_ERROR="WMSC_WSS_ERROR",e.WMSC_SDP_NEGOTIATION_FAIL="WMSC_SDP_NEGOTIATION_FAIL"}(bt||(bt={}));class Vt{constructor(e){this._config={webRTCWebSocketUrl:"",confId:"",nodeId:"",HDVideo:!1,mediaStreamController:void 0,iceServers:[],videoCodecConfig:void 0},this._websocket=null,this._wmsc=null,this._isDestroyed=!1,this._qosFlag=new Set,this.isJoinRWGSuccess=!1,this._joinRWGSuccessPromise=new Ct,this._lastTimeStamp=0,this.selfVideoDomMap=new Map,this.activeSpeakerVideoDom=null,this._activeSpeakerRemoteStream=null,this._selfStream=null,this._activeSpeakerSsrc=-1,this.isMirror=!1,this._vbSettingVideoDom=null,this.meetingEnded=!1,this.captureFramerate=void 0,this.resolutionUpgraded=!1,this._createWSS=()=>{this._onWSSOpenTimer=setTimeout((()=>{this._tryFailover(Tt.EPZ,bt.WMSC_WSS_OPEN_FAIL_IN_30s)}),3e4);const{webRTCWebSocketUrl:e}=this._config;this._websocket=(0,Dt.Gj)(e),this._websocket.onopen=this._onOpen,this._websocket.onclose=this._onClose,this._websocket.onmessage=this._onMessage,this._websocket.onerror=this._onError,wt.A.add_monitor("WMSC_Create_WSS: ".concat(e,"}"))},this._onOpen=()=>{if(clearTimeout(this._onWSSOpenTimer),!this._wmsc){const{confId:e,nodeId:t,HDVideo:i,iceServers:s,videoCodecConfig:a}=this._config,r=(0,Dt.Q9)();if(wt.A.add_monitor("WMSC_Instance_Params: ".concat(e,"|").concat(t,"|").concat(i,"|").concat(r,"}")),!e||!t)return;const n={maxCaptureResolution:3,maxVideoReceiveNum:26,confId:e,nodeId:t,HDVideo:i,isMacIntel:r,iceServers:s,videoSettings:a};this._wmsc=new It(n,this._wmscCallBack),this.sendMessageToWMSC({type:U.NOTIFY_SDK_JOIN_RWG_SUCCESS,data:""}),this.isJoinRWGSuccess=!0,this._joinRWGSuccessPromise.resolve()}},this._isKeepAliveMessage=e=>{let t=!0;for(let i=0;i<4;i++)if(0!==e[i]){t=!1;break}return t},this._checkReceiveTimeout=()=>{clearTimeout(this._keepAliveTimer),this._keepAliveTimer=setTimeout((()=>{Date.now(),this._tryFailover(Tt.EPZ,bt.WMSC_WSS_NOT_RECEIVE_MSG_IN_30s)}),3e4)},this._replyActiveAliveMessage=e=>{(null==e?void 0:e.data)instanceof Blob&&Dt.Ay.readBlobAsBuffer(e.data).then((e=>{var t;const i=new Int8Array(e);this._isKeepAliveMessage(i)&&(null===(t=this._websocket)||void 0===t||t.send(i))})).catch((e=>{Lt.Ay.error("WMSC_Read_Alive_F",e)}))},this._onMessage=e=>{if(this._websocket.isRlb||(this._checkReceiveTimeout(),this._replyActiveAliveMessage(e)),!((null==e?void 0:e.data)instanceof Blob)&&this._wmsc){if(e.data&&"string"==typeof e.data){let t;try{const{evt:i=""}=JSON.parse(e.data);t=i}catch(e){return void Lt.Ay.error("WMSC_Unexpect_Wsss_Message",e)}if(t===Tt.zag){this.meetingEnded=!0;const e="WMSC_Meeting_Ended_Indicat: ".concat(Date.now());wt.A.add_monitor(e),Lt.Ay.error(e)}}this.sendMessageToWMSC({type:U.WMSC_MESSAGE_FROM_RWG,data:e})}},this._onClose=e=>{1e3!==e.code?this._tryFailover(Tt.EPZ,bt.WMSC_WSS_CLOSE,e.code):wt.A.add_monitor("WMSC_WSS_NORMAL_CLOSE: ".concat(e.code,"|").concat(this._isDestroyed,"|").concat(this.meetingEnded))},this._onError=e=>{this._tryFailover(Tt.EPZ,bt.WMSC_WSS_ERROR)},this._tryFailover=(e,t,i)=>{const s=(0,Dt.Tv)();let a="".concat(s);switch(t){case bt.WMSC_WSS_OPEN_FAIL_IN_30s:a="WMSC_WSS_OPEN_FAIL:"+a;break;case bt.WMSC_WSS_NOT_RECEIVE_MSG_IN_30s:a="WMSC_WSS_RECV_FAIL:"+a;break;case bt.WMSC_WSS_CLOSE:a="WMSC_WSS_CLOSE: ".concat(i,"|")+a;break;case bt.WMSC_WSS_ERROR:a="WMSC_WSS_ERROR:"+a;break;case bt.WMSC_SDP_NEGOTIATION_FAIL:a="WMSC_SDP_NEGO_F:"+a;break;default:a="WMSC_FAILOVER_UNEXPECT:"+a}this._isDestroyed||this.meetingEnded||(this.destroy(),wt.A.add_monitor(a),Lt.Ay.error(a),Mt.A.Notify_APPUI(e))},this._disconnect=e=>{var t;const i="WMSC_WSS_Dissconn: ".concat(e,"|").concat(null===(t=null==this?void 0:this._websocket)||void 0===t?void 0:t.readyState);wt.A.add_monitor(i),Lt.Ay.log(i),!this._websocket||this._websocket.readyState!==WebSocket.CONNECTING&&this._websocket.readyState!==WebSocket.OPEN||this._websocket.close()},this.sendMessageToWMSC=e=>{var t;(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.data)instanceof Blob||this._wmsc&&this._wmsc.onMessage(e.type,e)},this.sendMessageToWMSCAsync=e=>{var t,i;if(!this._wmsc)return Promise.reject("this._wmsc is undefined");const{type:s}=e;if(s===U.VIDEO_STREAMS){const{streams:s=[]}=e;return(null===(i=null===(t=s[0])||void 0===t?void 0:t.stream)||void 0===i?void 0:i.id)&&(this.streamId=s[0].stream.id),0===s.length?this._selfStream=null:this._selfStream=s[0].stream,this._updateActiveSpeakerStream(),this._wmsc.onMessageAsync(e.type,e)}return Promise.reject("Not found event type ".concat(e.type))},this._wmscCallBack=e=>{var t,i;if(!e)return;const{type:s,data:a}=e;switch(s){case k.WMSC_MESSAGE_TO_RWG_BY_SDK:this.sendMesssageToRWG(a);break;case k.WMSC_MAPPING_STREAMID_AND_MID:const e=JSON.parse(a);if(!(null===(t=null==e?void 0:e.body)||void 0===t?void 0:t.length))return;const s=[],r=[];e.body.forEach((e=>{e.videoSize>=0?s.push({id:e.userID,size:e.videoSize,bOn:!1}):r.push({id:e.userID})})),s.length?(wt.A.add_monitor("WMSC_Sub_List: ".concat((0,Dt.iD)(JSON.stringify(s)))),e.body.forEach((t=>{Mt.A.sendMessageToRwg(Tt.yJV,{evt:e.evt,body:t})})),Mt.A.sendMessageToRwg(Tt.yJV,{evt:Tt.xQc,body:{subInfoList:s}})):r.length&&(wt.A.add_monitor("WMSC_Unsub_List: ".concat((0,Dt.iD)(JSON.stringify(r)))),Mt.A.sendMessageToRwg(Tt.yJV,{evt:Tt.WCu,body:{subIDList:r}}),e.body.forEach((t=>{Mt.A.sendMessageToRwg(Tt.yJV,{evt:e.evt,body:t})})));break;case k.SDP_NEGOTIATION_FAIL:this._tryFailover(Tt.Nmx,bt.WMSC_SDP_NEGOTIATION_FAIL);break;case k.GLOBAL_TRACE:{const{logLevel:e,log:t,errorEvent:i,tags:s}=a;Lt.Ay[e](t,i||s);break}case k.MONITOR:wt.A.add_monitor(a);break;case k.DIRECT_MONITOR:wt.A.send_monitor_directly(a);break;case k.VIDEO_QOS_DATA:Mt.A.Notify_APPUI(Tt.PgM,a);break;case k.NETWORK_QUALITY_CHANGE:Mt.A.Notify_APPUI(Tt.Ah8,a);break;case k.UPDATE_VIDEO_CAPTURE_CONSTRAINTS:if(!(null===(i=this._config.mediaStreamController)||void 0===i?void 0:i.isUsingFileInputVideoSource())){const{width:e,height:t,frameRate:i}=a;this._updateVideoConstraints(e,t,i)}break;case k.VIDEO_CAPABILITIES_CHANGE:this._websocket.send(JSON.stringify({evt:Tt.I6S,body:{fullHDOption:a.maxRecvVideoSize>=4?1:0}}));break;case k.V_RECEV_PC_CONNECTED:case k.V_SEND_PC_CONNECTED:Mt.A.Notify_APPUI(Tt.LYk,{mediaType:"video"});break;case k.ERROR_MESSAGE:this.handleWMSCErrorMsg(a)}},this.waitJoinRWGSuccess=()=>this._joinRWGSuccessPromise.promise,this.updateQosSubscription=(e,t,i)=>{var s,a;e?(this._qosFlag.add(t),null===(s=this._wmsc)||void 0===s||s.updateQosSubscription(e,i)):(this._qosFlag.delete(t),0===this._qosFlag.size&&(null===(a=this._wmsc)||void 0===a||a.updateQosSubscription(e,i)))},this.playAllVideoTag=e=>{var t;if(this.selfVideoDomMap.forEach((t=>{t.paused&&this.playSelfVideo(e,t)})),null===(t=null==this?void 0:this._wmsc)||void 0===t?void 0:t.playAllUsedVideoTag){if(!this._wmsc.getHasPausedVideo())return;this._wmsc.playAllUsedVideoTag().then((()=>{})).catch((t=>{const i="WMSC_RV_P_F: ".concat(e,"|").concat(t);wt.A.add_monitor(i),Lt.Ay.error(i)}))}},this.playSelfVideo=(e,t)=>{var i;let s="";"visible"!==document.visibilityState&&(s="WMSC_SV_V_F: ".concat(document.visibilityState,"-").concat(e)),t||(s="WMSC_SV_DOM_F: ".concat(e)),t.srcObject||(s="WMSC_SV_SRC_F: ".concat(e));const a=null===(i=null==t?void 0:t.srcObject)||void 0===i?void 0:i.getVideoTracks();if(Array.isArray(a)&&a[0]&&a[0].muted&&(s="WMSC_SV_TM_F: ".concat(document.visibilityState,"-").concat(e)),t.paused||(s="WMSC_SV_P_F: ".concat(e)),s)return wt.A.add_monitor(s),void Lt.Ay.error(s);t.readyState>t.HAVE_CURRENT_DATA||t.play().then((()=>{wt.A.add_monitor("WMSC_SV_SUCCESS: ".concat(e))})).catch((t=>{s="WMSC_SV_P_E: ".concat(e,"|").concat(t.name,":").concat(t.message),wt.A.add_monitor(s),Lt.Ay.error(s,t)}))},this.getUserIdVideo=e=>{var t;return 1==e?[this.activeSpeakerVideoDom]:this.isSelfVideo(e)?[Array.from(this.selfVideoDomMap.values()).find((e=>!e.paused))]:null===(t=this._wmsc)||void 0===t?void 0:t.getUserIdVideo(e)},this.mirrorVideoEle=(e,t)=>{const i="rotateY(".concat(t?180:0,"deg)");let s=e.style.transform;-1!==s.indexOf("rotateY")?s=s.replace(/rotateY\([0-9]+(deg)?\)/,i):s+=" ".concat(i),e.style.transform=s},this.mirrorSelfVideo=e=>{if(this.isMirror=e,this.selfVideoDomMap.size>0&&this.selfVideoDomMap.forEach((e=>{this.mirrorVideoEle(e,this.isMirror)})),this.activeSpeakerVideoDom&&this._activeSpeakerRemoteStream&&this.mirrorVideoEle(this.activeSpeakerVideoDom,this.isMirror),this.vbSettingVideoDom&&this.mirrorVideoEle(this.vbSettingVideoDom,this.isMirror),this.selfVideoDomMap.size<=0&&!this.activeSpeakerVideoDom&&!this.vbSettingVideoDom){const t="WMSC_MIRROR_F:".concat(e);wt.A.add_monitor(t),Lt.Ay.error(t)}},this.sendStreamToWMSC=(e,t,i,s)=>Nt(this,void 0,void 0,(function*(){var a,r;const{mediaStreamController:n}=this._config,o=null===(r=null===(a=null==n?void 0:n.videoStream)||void 0===a?void 0:a.getVideoTracks()[0])||void 0===r?void 0:r.getSettings(),c=(null==o?void 0:o.width)||640,d=(null==o?void 0:o.height)||360;wt.A.add_monitor("WMSC_Update_V_Constraints_S: ".concat(s,"|").concat(e,"|").concat(t,"|").concat(i,"|").concat(c,"|").concat(d));const h=[{stream:n.getVideoStream(),width:c,height:d}];n.isVideoStreamProcessed()&&h.push({stream:n.videoStream}),yield this.sendMessageToWMSCAsync({type:U.VIDEO_STREAMS,streams:h})})),this.onActiveSpeakerChange=e=>{this.sendMessageToWMSC({type:U.NOTIFY_SDK_ACTIVE_VIDEO_INDICATION,data:{userId:e}}),this._activeSpeakerSsrc=e,this._updateActiveSpeakerStream()},this._updateActiveSpeakerStream=()=>{if(this.activeSpeakerVideoDom){const{nodeId:e}=this._config;(0,Dt.XF)(this._activeSpeakerSsrc)===(0,Dt.XF)(e)?this._selfStream&&(this._activeSpeakerRemoteStream||(this._activeSpeakerRemoteStream=this.activeSpeakerVideoDom.srcObject),this.activeSpeakerVideoDom.srcObject=this._selfStream,this.isMirror&&this.mirrorVideoEle(this.activeSpeakerVideoDom,this.isMirror)):this._activeSpeakerRemoteStream&&(this.activeSpeakerVideoDom.srcObject=this._activeSpeakerRemoteStream,this._activeSpeakerRemoteStream=null,this.isMirror&&this.mirrorVideoEle(this.activeSpeakerVideoDom,!1))}},this.isSelfVideo=e=>{const{nodeId:t}=this._config;return(0,Dt.XF)(e)===(0,Dt.XF)(t)},this.handleWMSCErrorMsg=e=>{const{type:t}=e;switch(t){case"WEBRTC_VIDEO_HEALTH_CHECK_FAILED":(0,yt.iK)(Tt.bes,Pt.Qt);break;case"PC_RECONNECT":(0,yt.iK)(Tt.ZSj,e)}},this.destroy=()=>{var e;clearTimeout(this._onWSSOpenTimer),clearTimeout(this._keepAliveTimer),this._cleanUserEventListener&&this._cleanUserEventListener(),this.selfVideoDomMap.clear(),this.isJoinRWGSuccess=!1,this._isDestroyed=!0,this._disconnect(Rt.destroy),null===(e=this._wmsc)||void 0===e||e.destroy()},this._isDestroyed=!1,this._config=Object.assign(this._config,e),this._createWSS(),this._throttlePlayAllVideoTag=Ot()(this.playAllVideoTag,500),this._cleanUserEventListener=(0,Dt.zV)((()=>this._throttlePlayAllVideoTag(Et.userClick))),document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState&&this._throttlePlayAllVideoTag(Et.visibilitychange)}))}sendMesssageToRWG(e){this._websocket&&this._websocket.readyState===WebSocket.OPEN&&("object"==typeof e?this._websocket.send(JSON.stringify(e)):this._websocket.send(e))}reportWMSCPeerConnectionRawStats(){var e;null===(e=this._wmsc)||void 0===e||e.reportWMSCPeerConnectionRawStats()}_updateVideoConstraints(e,t,i){return Nt(this,void 0,void 0,(function*(){const{mediaStreamController:s}=this._config;i=this.captureFramerate?Math.min(this.captureFramerate,i):i,s&&!this._isDestroyed&&e&&t&&i?(yield this.sendMessageToWMSCAsync({type:U.VIDEO_STREAMS,streams:[]}),s.changeVideoResolution(e,t,i).then((()=>{this.sendStreamToWMSC(e,t,i,!0)})).catch((s=>{this.sendStreamToWMSC(e,t,i,!1),wt.A.add_monitor("WMSC_Update_V_Constraints_E: ".concat(e,"|").concat(t,"|").concat(i)),Lt.Ay.error("WMSC_Update_V_Constraints_E",s)}))):wt.A.add_monitor("WMSC_Update_V_Constraints_F: ".concat(!!s,"|").concat(this._isDestroyed,"|").concat(e,"|").concat(t,"|").concat(i))}))}set vbSettingVideoDom(e){this._vbSettingVideoDom=e,this._vbSettingVideoDom&&(this._vbSettingVideoDom.setAttribute("autoplay","true"),this._vbSettingVideoDom.setAttribute("playsinline","true"),this._vbSettingVideoDom.muted=!0,this.isMirror&&this.mirrorVideoEle(this._vbSettingVideoDom,this.isMirror),this._selfStream&&(this._vbSettingVideoDom.srcObject=this._selfStream))}get vbSettingVideoDom(){return this._vbSettingVideoDom}}},4258:(e,t,i)=>{e.exports=i(2113)},8048:(e,t,i)=>{e.exports=i(6083)},7160:(e,t,i)=>{"use strict";i(5298),i(8897);var s=i(1747);e.exports=s("Array","flat")},2190:(e,t,i)=>{"use strict";var s=i(8280),a=i(7160),r=Array.prototype;e.exports=function(e){var t=e.flat;return e===r||s(r,e)&&t===r.flat?a:t}},3148:(e,t,i)=>{"use strict";var s=i(8280),a=i(1310),r=String.prototype;e.exports=function(e){var t=e.trimStart;return"string"==typeof e||e===r||s(r,e)&&t===r.trimStart?a:t}},1310:(e,t,i)=>{"use strict";i(1454);var s=i(1747);e.exports=s("String","trimLeft")},6198:(e,t,i)=>{"use strict";var s=i(1793),a=i(575),r=i(8024),n=i(8311),o=function(e,t,i,c,d,h,l,u){for(var m,p,S=d,g=0,_=!!l&&n(l,u);g<c;)g in i&&(m=_?_(i[g],g,t):i[g],h>0&&s(m)?(p=a(m),S=o(e,t,m,p,S,h-1)-1):(r(S+1),e[S]=m),S++),g++;return S};e.exports=o},9419:(e,t,i)=>{"use strict";var s=i(5993).start,a=i(5819);e.exports=a("trimStart")?function(){return s(this)}:"".trimStart},5298:(e,t,i)=>{"use strict";var s=i(1091),a=i(6198),r=i(9298),n=i(575),o=i(5482),c=i(6968);s({target:"Array",proto:!0},{flat:function(){var e=arguments.length?arguments[0]:void 0,t=r(this),i=n(t),s=c(t,0);return s.length=a(s,t,t,i,0,void 0===e?1:o(e)),s}})},8897:(e,t,i)=>{"use strict";i(2156)("flat")},9793:(e,t,i)=>{"use strict";var s=i(1091),a=i(9419);s({target:"String",proto:!0,name:"trimStart",forced:"".trimLeft!==a},{trimLeft:a})},1454:(e,t,i)=>{"use strict";i(9793);var s=i(1091),a=i(9419);s({target:"String",proto:!0,name:"trimStart",forced:"".trimStart!==a},{trimStart:a})},2113:(e,t,i)=>{"use strict";var s=i(2190);e.exports=s},6083:(e,t,i)=>{"use strict";var s=i(3148);e.exports=s}}]);
//# sourceMappingURL=https://d1cdksi819e9z7.cloudfront.net/sourcemap/wmsc.min.js-08ecfca1a31669235cc2.map