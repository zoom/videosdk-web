(window.webpackJsonpJsMediaSDK_Instance=window.webpackJsonpJsMediaSDK_Instance||[]).push([[5],{87:function(e,t,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var o=Object.getOwnPropertyDescriptor(t,i);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,o)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),_=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return o(t,e),t},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.WMSCManager=t.eventExt=void 0;const a=i(95);Object.defineProperty(t,"eventExt",{enumerable:!0,get:function(){return a.eventExt}});const n=r(i(96)),d=r(i(0)),S=i(2),l=r(i(7)),c=r(i(4)),h=_(i(3)),u=r(i(27));var m,v,f;!function(e){e.visibilitychange="visibilitychange",e.streamCaptureSuccess="streamCaptureSuccess",e.videoTrackUnmute="videoTrackUnmute",e.addRenderVideo="addRenderVideo",e.userClick="userClick"}(m||(m={})),function(e){e.destroy="destroy"}(v||(v={})),function(e){e.WMSC_WSS_OPEN_FAIL_IN_30s="WMSC_WSS_OPEN_FAIL_IN_30s",e.WMSC_WSS_NOT_RECEIVE_MSG_IN_30s="WMSC_WSS_NOT_RECEIVE_MSG_IN_30s",e.WMSC_WSS_CLOSE="WMSC_WSS_CLOSE",e.WMSC_WSS_ERROR="WMSC_WSS_ERROR",e.WMSC_SDP_NEGOTIATION_FAIL="WMSC_SDP_NEGOTIATION_FAIL"}(f||(f={}));t.WMSCManager=class{constructor(e){this._config={webRTCWebSocketUrl:"",confId:"",nodeId:"",HDVideo:!1,mediaStreamController:null},this._websocket=null,this._wmsc=null,this._isDestroyed=!1,this._qosFlag=new Set,this.isJoinRWGSuccess=!1,this._joinRWGSuccessPromise=new n.default,this._lastTimeStamp=0,this._selfVideoDom=null,this.activeSpeakerVideoDom=null,this._activeSpeakerRemoteStream=null,this._selfStream=null,this._activeSpeakerSsrc=-1,this._isMirror=!1,this._vbSettingVideoDom=null,this.meetingEnded=!1,this._createWSS=()=>{this._onWSSOpenTimer=setTimeout(()=>{this._tryFailover(S.NOTIFY_UI_WMSC_WSS_DISCONNECTED,f.WMSC_WSS_OPEN_FAIL_IN_30s)},3e4);const{webRTCWebSocketUrl:e}=this._config;this._websocket=new WebSocket(e),this._websocket.onopen=this._onOpen,this._websocket.onclose=this._onClose,this._websocket.onmessage=this._onMessage,this._websocket.onerror=this._onError,c.default.add_monitor(`WMSC_Create_WSS: ${e}}`)},this._onOpen=()=>{if(clearTimeout(this._onWSSOpenTimer),this._websocket.send(JSON.stringify({evt:S.WS_CONF_WCL_SET_FULL_HD_REQ,body:{fullHDOption:0}})),!this._wmsc){const{confId:e,nodeId:t,HDVideo:i}=this._config;if(c.default.add_monitor(`WMSC_Instance_Params: ${e}|${t}|${i}}`),!e||!t)return;const s={maxCaptureResolution:3,maxVideoReceiveNum:25,confId:e,nodeId:t,HDVideo:i};this._wmsc=new a.Wmsc(s,this._wmscCallBack),this.sendMessageToWMSC({type:a.eventExt.NOTIFY_SDK_JOIN_RWG_SUCCESS,data:""}),this.isJoinRWGSuccess=!0,this._joinRWGSuccessPromise.resolve()}},this._isKeepAliveMessage=e=>{let t=!0;for(let i=0;i<4;i++)if(0!==e[i]){t=!1;break}return t},this._checkReceiveTimeout=()=>{clearTimeout(this._keepAliveTimer),this._keepAliveTimer=setTimeout(()=>{Date.now();this._tryFailover(S.NOTIFY_UI_WMSC_WSS_DISCONNECTED,f.WMSC_WSS_NOT_RECEIVE_MSG_IN_30s)},3e4)},this._replyActiveAliveMessage=e=>{(null==e?void 0:e.data)instanceof Blob&&h.default.readBlobAsBuffer(e.data).then(e=>{var t;const i=new Int8Array(e);this._isKeepAliveMessage(i)&&(null===(t=this._websocket)||void 0===t||t.send(i))}).catch(e=>{l.default.error("WMSC_Read_Alive_F",e)})},this._onMessage=e=>{if(this._checkReceiveTimeout(),this._replyActiveAliveMessage(e),!((null==e?void 0:e.data)instanceof Blob)&&this._wmsc){if(e.data){const{evt:t}=JSON.parse(e.data);t===S.WS_CONF_END_INDICATION&&(c.default.add_monitor("WMSC_Meeting_Ended_Indicat: "+Date.now()),this.meetingEnded=!0)}this.sendMessageToWMSC({type:a.eventExt.WMSC_MESSAGE_FROM_RWG,data:e})}},this._onClose=e=>{1e3!==e.code?this._tryFailover(S.NOTIFY_UI_WMSC_WSS_DISCONNECTED,f.WMSC_WSS_CLOSE,e):c.default.add_monitor(`WMSC_WSS_NORMAL_CLOSE: ${e.code}|${this._isDestroyed}|${this.meetingEnded}`)},this._onError=e=>{this._tryFailover(S.NOTIFY_UI_WMSC_WSS_DISCONNECTED,f.WMSC_WSS_ERROR,e)},this._tryFailover=(e,t,i)=>{let s=`${this._isDestroyed}|${this.meetingEnded}`;switch(t){case f.WMSC_WSS_OPEN_FAIL_IN_30s:s="WMSC_WSS_OPEN_FAIL:"+s;break;case f.WMSC_WSS_NOT_RECEIVE_MSG_IN_30s:s="WMSC_WSS_RECV_FAIL:"+s;break;case f.WMSC_WSS_CLOSE:s=`WMSC_WSS_CLOSE: ${null==i?void 0:i.code}|`+s;break;case f.WMSC_WSS_ERROR:s="WMSC_WSS_ERROR:"+s;break;case f.WMSC_SDP_NEGOTIATION_FAIL:s="WMSC_SDP_NEGO_F:"+s;break;default:s="WMSC_FAILOVER_UNEXPECT:"+s}c.default.add_monitor(s),l.default.error(s,i),this._isDestroyed||this.meetingEnded||d.default.Notify_APPUI&&(this.destroy(),d.default.Notify_APPUI(e))},this._disconnect=e=>{var t;const i=`WMSC_WSS_Dissconn: ${e}|${null===(t=null==this?void 0:this._websocket)||void 0===t?void 0:t.readyState}`;c.default.add_monitor(i),l.default.log(i),!this._websocket||this._websocket.readyState!==WebSocket.CONNECTING&&this._websocket.readyState!==WebSocket.OPEN||this._websocket.close()},this.sendMessageToWMSC=e=>{var t;(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.data)instanceof Blob||this._wmsc&&this._wmsc.onMessage(e.type,e)},this.sendMessageToWMSCAsync=e=>{var t;if(!this._wmsc)return Promise.reject("this._wmsc is undefined");const{type:i}=e;switch(i){case a.eventExt.VIDEO_STREAMS:{const{streams:i=[]}=e;return i&&(this.streamId=null===(t=i[0])||void 0===t?void 0:t.stream.id),0===i.length?this._selfStream=null:this._selfStream=i[0].stream,this._updateActiveSpeakerStream(),this._wmsc.onMessageAsync(e.type,e)}default:return Promise.reject("Not found event type "+e.type)}},this._wmscCallBack=e=>{var t;if(!e)return;const{type:i,data:s}=e;switch(i){case a.eventOut.WMSC_MESSAGE_TO_RWG_BY_SDK:this.sendMesssageToRWG(s);break;case a.eventOut.WMSC_MAPPING_STREAMID_AND_MID:const e=JSON.parse(s);if(!(null===(t=null==e?void 0:e.body)||void 0===t?void 0:t.length))return;const i=[],o=[];e.body.forEach(e=>{e.videoSize>=0?i.push({id:e.userID,size:e.videoSize,bOn:!1}):o.push({id:e.userID})}),i.length?(c.default.add_monitor("WMSC_Sub_List: "+(0,h.replaceComma)(JSON.stringify(i))),e.body.forEach(t=>{d.default.sendMessageToRwg(S.SEND_MESSAGE_TO_RWG,{evt:e.evt,body:t})}),d.default.sendMessageToRwg(S.SEND_MESSAGE_TO_RWG,{evt:S.WS_VIDEO_MULTI_SUBSCRIBE_REQ,body:{subInfoList:i}})):o.length&&(c.default.add_monitor("WMSC_Unsub_List: "+(0,h.replaceComma)(JSON.stringify(o))),d.default.sendMessageToRwg(S.SEND_MESSAGE_TO_RWG,{evt:S.WS_VIDEO_MULTI_UNSUBSCRIBE_REQ,body:{subIDList:o}}),e.body.forEach(t=>{d.default.sendMessageToRwg(S.SEND_MESSAGE_TO_RWG,{evt:e.evt,body:t})}));break;case a.eventOut.SDP_NEGOTIATION_FAIL:this._tryFailover(S.NOTIFY_UI_WMSC_FAILOVER,f.WMSC_SDP_NEGOTIATION_FAIL);break;case a.eventOut.GLOBAL_TRACE:{const{logLevel:e,log:t,errorEvent:i,tags:o}=s;l.default[e](t,i||o);break}case a.eventOut.MONITOR:c.default.add_monitor(s);break;case a.eventOut.DIRECT_MONITOR:c.default.send_monitor_directly(s);break;case a.eventOut.VIDEO_QOS_DATA:d.default.Notify_APPUI(S.VIDEO_QOS_DATA,s);break;case a.eventOut.UPDATE_VIDEO_CAPTURE_CONSTRAINTS:{const{width:e,height:t,frameRate:i}=s;this.updateVideoConstraints(e,t,i);break}}},this.waitJoinRWGSuccess=()=>this._joinRWGSuccessPromise.promise,this.updateQosSubscription=(e,t,i)=>{var s,o;e?(this._qosFlag.add(t),null===(s=this._wmsc)||void 0===s||s.updateQosSubscription(e,i)):(this._qosFlag.delete(t),0===this._qosFlag.size&&(null===(o=this._wmsc)||void 0===o||o.updateQosSubscription(e,i)))},this.playAllVideoTag=e=>{var t,i;if((null===(t=null==this?void 0:this.selfVideoDom)||void 0===t?void 0:t.paused)&&this.playSelfVideo(e),null===(i=null==this?void 0:this._wmsc)||void 0===i?void 0:i.playAllUsedVideoTag){if(!this._wmsc.getHasPausedVideo())return;this._wmsc.playAllUsedVideoTag().then(()=>{}).catch(t=>{const i=`WMSC_RV_P_F: ${e}-${t}`;c.default.add_monitor(i),l.default.error(i)})}},this.playSelfVideo=e=>{var t,i;let s="";"visible"!==document.visibilityState&&(s=`WMSC_SV_V_F: ${document.visibilityState}-${e}`),this.selfVideoDom||(s="WMSC_SV_DOM_F: "+e),this.selfVideoDom.srcObject||(s="WMSC_SV_SRC_F: "+e);const o=null===(i=null===(t=this.selfVideoDom)||void 0===t?void 0:t.srcObject)||void 0===i?void 0:i.getVideoTracks();if(Array.isArray(o)&&o[0]&&o[0].muted&&(s="WMSC_SV_TM_F: "+e),this.selfVideoDom.paused||(s="WMSC_SV_P_F: "+e),s)return c.default.add_monitor(s),void l.default.error(s);this.selfVideoDom.play().then(()=>{c.default.add_monitor("WMSC_SV_SUCCESS: "+e)}).catch(t=>{s=`WMSC_SV_P_E: ${e}-${t.name}`,c.default.add_monitor(s),l.default.error(s,t)})},this._mirrorVideoEle=(e,t)=>{const i=`rotateY(${t?180:0}deg)`;let s=e.style.transform;-1!==s.indexOf("rotateY")?s=s.replace(/rotateY\([0-9]+(deg)?\)/,i):s+=" "+i,e.style.transform=s},this.mirrorSelfVideo=e=>{if(this._isMirror=e,this.selfVideoDom||this.activeSpeakerVideoDom||this.vbSettingVideoDom)this.selfVideoDom&&this._mirrorVideoEle(this.selfVideoDom,this._isMirror),this.activeSpeakerVideoDom&&this._activeSpeakerRemoteStream&&this._mirrorVideoEle(this.activeSpeakerVideoDom,this._isMirror),this.vbSettingVideoDom&&this._mirrorVideoEle(this.vbSettingVideoDom,this._isMirror);else{const t="WMSC_MIRROR_F:"+e;c.default.add_monitor(t),l.default.error(t)}},this.onActiveSpeakerChange=e=>{this.sendMessageToWMSC({type:a.eventExt.NOTIFY_SDK_ACTIVE_VIDEO_INDICATION,data:{userId:e}}),this._activeSpeakerSsrc=e,this._updateActiveSpeakerStream()},this._updateActiveSpeakerStream=()=>{if(this.activeSpeakerVideoDom){const{nodeId:e}=this._config;(0,h.Get_Logical_SSrc)(this._activeSpeakerSsrc)===(0,h.Get_Logical_SSrc)(e)?this._selfStream&&(this._activeSpeakerRemoteStream||(this._activeSpeakerRemoteStream=this.activeSpeakerVideoDom.srcObject),this.activeSpeakerVideoDom.srcObject=this._selfStream,this._isMirror&&this._mirrorVideoEle(this.activeSpeakerVideoDom,this._isMirror)):this._activeSpeakerRemoteStream&&(this.activeSpeakerVideoDom.srcObject=this._activeSpeakerRemoteStream,this._activeSpeakerRemoteStream=null,this._isMirror&&this._mirrorVideoEle(this.activeSpeakerVideoDom,!1))}},this.isSelfVideo=e=>{const{nodeId:t}=this._config;return(0,h.Get_Logical_SSrc)(e)===(0,h.Get_Logical_SSrc)(t)},this.destroy=()=>{var e;clearTimeout(this._onWSSOpenTimer),clearTimeout(this._keepAliveTimer),this._cleanUserEventListener&&this._cleanUserEventListener(),this.selfVideoDom=null,this.isJoinRWGSuccess=!1,this._isDestroyed=!0,this._disconnect(v.destroy),this._wmsc&&(null===(e=this._wmsc)||void 0===e||e.destroy())},this._isDestroyed=!1,this._config=Object.assign(this._config,e),this._createWSS(),this._throttlePlayAllVideoTag=(0,u.default)(this.playAllVideoTag,500),this._cleanUserEventListener=(0,h.addUserEventListener)(()=>this._throttlePlayAllVideoTag(m.userClick)),document.addEventListener("visibilitychange",()=>{"visible"===document.visibilityState&&this._throttlePlayAllVideoTag(m.visibilitychange)})}sendMesssageToRWG(e){this._websocket&&this._websocket.readyState===WebSocket.OPEN&&("object"==typeof e?this._websocket.send(JSON.stringify(e)):this._websocket.send(e))}updateVideoConstraints(e,t,i){const{mediaStreamController:s}=this._config;s&&!this._isDestroyed&&e&&t&&i?s.changeVideoResolution(e,t,i).then(()=>{var o,_;const r=null===(_=null===(o=null==s?void 0:s.videoStream)||void 0===o?void 0:o.getVideoTracks()[0])||void 0===_?void 0:_.getSettings(),n=(null==r?void 0:r.width)||640,d=Math.floor(9*n/16)||360;c.default.add_monitor(`WMSC_Update_V_Constraints_S: ${e}|${t}|${i}|${n}|${d}`),this.sendMessageToWMSCAsync({type:a.eventExt.VIDEO_STREAMS,streams:[{stream:s.videoStream,width:n,height:d}]})}).catch(e=>{l.default.error("WMSC_Update_V_Constraints_E",e)}):c.default.add_monitor(`WMSC_Update_V_Constraints_F: ${!!s}|${this._isDestroyed}|${e}|${t}|${i}`)}set selfVideoDom(e){this._selfVideoDom=e,this._isMirror&&e&&this._mirrorVideoEle(this.selfVideoDom,this._isMirror)}get selfVideoDom(){return this._selfVideoDom}set vbSettingVideoDom(e){this._vbSettingVideoDom=e,this._vbSettingVideoDom&&(this._vbSettingVideoDom.setAttribute("autoplay","true"),this._vbSettingVideoDom.setAttribute("playsinline","true"),this._vbSettingVideoDom.muted=!0,this._isMirror&&this._mirrorVideoEle(this._vbSettingVideoDom,this._isMirror),this._selfStream&&(this._vbSettingVideoDom.srcObject=this._selfStream))}get vbSettingVideoDom(){return this._vbSettingVideoDom}}},96:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=class{constructor(){this.status="pending",this.promise=new Promise((e,t)=>{this.reject=e=>(this.status="rejected",t(e)),this.resolve=t=>(this.status="fullfilled",e(t))}),this.then=this.promise.then,this.catch=this.promise.catch}}}}]);
//# sourceMappingURL=https://d1cdksi819e9z7.cloudfront.net/sourcemap/wmsc.min.js-72c38d9d0cf2c5722dcd.map